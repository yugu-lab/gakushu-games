<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>æ•°å­¦ã‚¯ã‚¤ã‚ºã‚²ãƒ¼ãƒ  - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¯¾æˆ¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');
        
        :root { 
            --safe-top: env(safe-area-inset-top); 
            --safe-bottom: env(safe-area-inset-bottom); 
        }
        
        html, body { 
            height: 100svh; 
            padding: max(8px, var(--safe-top)) 8px max(8px, var(--safe-bottom)); 
            overscroll-behavior: none; 
            touch-action: manipulation; 
        }
        
        body {
            font-family: 'Nunito', sans-serif;
            touch-action: manipulation;
        }
        
        .bounce-in {
            animation: bounceIn 0.6s ease-out;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        .pulse-glow {
            animation: pulseGlow 2s infinite;
        }
        
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        
        .celebrate {
            animation: celebrate 1s ease-out;
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 107, 107, 0.4); }
            50% { box-shadow: 0 0 40px rgba(255, 107, 107, 0.8); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        @keyframes celebrate {
            0% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(5deg); }
            50% { transform: scale(1.2) rotate(-5deg); }
            75% { transform: scale(1.1) rotate(3deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        
        .timer-circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 1s linear;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ff6b6b;
            animation: confetti-fall 3s linear infinite;
        }
        
        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .answered {
            opacity: 0.6;
            transform: scale(0.95);
            transition: all 0.3s ease;
        }

        .first-correct {
            animation: firstCorrect 1s ease-out;
        }

        @keyframes firstCorrect {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); box-shadow: 0 0 30px gold; }
            100% { transform: scale(1); }
        }

        /* iPadæ¨ªç”»é¢æœ€é©åŒ– */
        @media (orientation: landscape) and (min-width: 768px) {
            .game-container {
                max-height: 100vh;
                overflow-y: auto;
            }
            
            .touch-button {
                min-height: 60px;
                font-size: 1.25rem;
            }
            
            .answer-input {
                font-size: 2rem;
                padding: 1rem;
                min-height: 60px;
            }
        }

        /* ã‚¿ãƒƒãƒ—æœ€é©åŒ– */
        button, input {
            -webkit-tap-highlight-color: transparent;
        }
        
        button {
            min-height: 56px;
        }
        
        button:active {
            transform: scale(0.95);
        }
        
        @media (orientation: landscape) {
            .max-screen { 
                max-width: min(1200px, 92vw); 
                margin: 0 auto; 
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-400 via-pink-400 to-red-400 min-h-screen overflow-hidden">
    <!-- æ¥ç¶šçŠ¶æ…‹è¡¨ç¤º -->
    <div id="connectionStatus" class="fixed top-4 right-4 z-50 px-4 py-2 rounded-full text-white font-semibold hidden">
        ğŸ”´ æ¥ç¶šä¸­...
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
    <div id="mainScreen" class="flex items-center justify-center min-h-screen p-4 md:p-8 max-screen">
        <div class="bg-white rounded-3xl shadow-2xl p-8 md:p-12 max-w-2xl w-full bounce-in">
            <div class="text-center mb-8">
                <h1 class="text-4xl md:text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 mb-4">
                    ğŸ§® æ•°å­¦ã‚¯ã‚¤ã‚º ğŸ¯
                </h1>
                <p class="text-lg md:text-xl text-gray-600">æœ€å¤§å…¬ç´„æ•°ãƒ»æœ€å°å…¬å€æ•°ã®å•é¡Œã«æŒ‘æˆ¦ï¼</p>
                <p class="text-base md:text-lg text-purple-600 font-semibold mt-2">ğŸ”¥ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰</p>
            </div>
            
            <div class="space-y-4 md:space-y-6">
                <button onclick="showRoomCreate()" class="w-full bg-gradient-to-r from-green-400 to-blue-500 text-white text-xl md:text-2xl font-bold py-4 md:py-6 px-6 md:px-8 rounded-2xl hover:from-green-500 hover:to-blue-600 transform hover:scale-105 transition-all duration-200 shadow-lg touch-button">
                    ğŸ  éƒ¨å±‹ã‚’ä½œã‚‹
                </button>
                
                <button onclick="showRoomJoin()" class="w-full bg-gradient-to-r from-orange-400 to-pink-500 text-white text-xl md:text-2xl font-bold py-4 md:py-6 px-6 md:px-8 rounded-2xl hover:from-orange-500 hover:to-pink-600 transform hover:scale-105 transition-all duration-200 shadow-lg touch-button">
                    ğŸšª éƒ¨å±‹ã«å…¥ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- éƒ¨å±‹ä½œæˆç”»é¢ -->
    <div id="roomCreateScreen" class="hidden flex items-center justify-center min-h-screen p-4 md:p-8 max-screen">
        <div class="bg-white rounded-3xl shadow-2xl p-8 md:p-12 max-w-2xl w-full">
            <h2 class="text-3xl md:text-4xl font-bold text-center text-purple-600 mb-6 md:mb-8">ğŸ  éƒ¨å±‹ã‚’ä½œã‚‹</h2>
            
            <div class="space-y-4 md:space-y-6">
                <div>
                    <div class="flex items-center mb-3">
                        <input id="usePasswordToggle" type="checkbox" class="mr-3 w-5 h-5 text-purple-600 rounded focus:ring-purple-500">
                        <label for="usePasswordToggle" class="text-lg md:text-xl font-semibold text-gray-700">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ã†ï¼ˆä»»æ„ï¼‰</label>
                    </div>
                    <input id="createPassword" type="password" class="w-full text-xl md:text-2xl p-3 md:p-4 border-4 border-purple-300 rounded-xl focus:border-purple-500 focus:outline-none touch-button opacity-50" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" disabled>
                </div>
                
                <div>
                    <label class="block text-lg md:text-xl font-semibold text-gray-700 mb-3">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</label>
                    <input id="createPlayerName" type="text" class="w-full text-xl md:text-2xl p-3 md:p-4 border-4 border-purple-300 rounded-xl focus:border-purple-500 focus:outline-none touch-button" placeholder="ã‚ãªãŸã®åå‰">
                </div>
                
                <div class="flex space-x-4">
                    <button onclick="createRoom(this)" class="flex-1 bg-gradient-to-r from-green-400 to-blue-500 text-white text-lg md:text-xl font-bold py-3 md:py-4 px-4 md:px-6 rounded-xl hover:from-green-500 hover:to-blue-600 transform hover:scale-105 transition-all duration-200 touch-button">
                        ä½œæˆ
                    </button>
                    <button onclick="showMainScreen()" class="flex-1 bg-gray-400 text-white text-lg md:text-xl font-bold py-3 md:py-4 px-4 md:px-6 rounded-xl hover:bg-gray-500 transform hover:scale-105 transition-all duration-200 touch-button">
                        æˆ»ã‚‹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- éƒ¨å±‹å‚åŠ ç”»é¢ -->
    <div id="roomJoinScreen" class="hidden flex items-center justify-center min-h-screen p-4 md:p-8 max-screen">
        <div class="bg-white rounded-3xl shadow-2xl p-8 md:p-12 max-w-2xl w-full">
            <h2 class="text-3xl md:text-4xl font-bold text-center text-orange-600 mb-6 md:mb-8">ğŸšª éƒ¨å±‹ã«å…¥ã‚‹</h2>
            
            <div class="space-y-4 md:space-y-6">
                <div>
                    <label class="block text-lg md:text-xl font-semibold text-gray-700 mb-3">éƒ¨å±‹ID</label>
                    <input id="joinRoomId" type="text" inputmode="text" pattern="[0-9A-Za-z]*" class="w-full text-xl md:text-2xl p-3 md:p-4 border-4 border-orange-300 rounded-xl focus:border-orange-500 focus:outline-none touch-button" placeholder="8æ¡ã®ID">
                </div>
                
                <div id="joinPasswordSection">
                    <div class="flex items-center mb-3">
                        <input id="joinUsePasswordToggle" type="checkbox" class="mr-3 w-5 h-5 text-orange-600 rounded focus:ring-orange-500">
                        <label for="joinUsePasswordToggle" class="text-lg md:text-xl font-semibold text-gray-700">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹</label>
                    </div>
                    <input id="joinPassword" type="password" class="w-full text-xl md:text-2xl p-3 md:p-4 border-4 border-orange-300 rounded-xl focus:border-orange-500 focus:outline-none touch-button opacity-50" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" disabled>
                </div>
                
                <div>
                    <label class="block text-lg md:text-xl font-semibold text-gray-700 mb-3">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</label>
                    <input id="joinPlayerName" type="text" class="w-full text-xl md:text-2xl p-3 md:p-4 border-4 border-orange-300 rounded-xl focus:border-orange-500 focus:outline-none touch-button" placeholder="ã‚ãªãŸã®åå‰">
                </div>
                
                <div class="flex space-x-4">
                    <button onclick="joinRoom(this)" class="flex-1 bg-gradient-to-r from-orange-400 to-pink-500 text-white text-lg md:text-xl font-bold py-3 md:py-4 px-4 md:px-6 rounded-xl hover:from-orange-500 hover:to-pink-600 transform hover:scale-105 transition-all duration-200 touch-button">
                        å‚åŠ 
                    </button>
                    <button onclick="showMainScreen()" class="flex-1 bg-gray-400 text-white text-lg md:text-xl font-bold py-3 md:py-4 px-4 md:px-6 rounded-xl hover:bg-gray-500 transform hover:scale-105 transition-all duration-200 touch-button">
                        æˆ»ã‚‹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¾…æ©Ÿç”»é¢ -->
    <div id="waitingScreen" class="hidden flex items-center justify-center min-h-screen p-4 md:p-8 max-screen">
        <div class="bg-white rounded-3xl shadow-2xl p-8 md:p-12 max-w-4xl w-full game-container">
            <h2 class="text-3xl md:text-4xl font-bold text-center text-blue-600 mb-6 md:mb-8">ğŸ® ã‚²ãƒ¼ãƒ å¾…æ©Ÿä¸­</h2>
            
            <div class="text-center mb-6">
                <div class="text-lg md:text-xl text-gray-600">
                    éƒ¨å±‹ID: <span id="currentRoomId" class="font-bold text-blue-600 text-2xl"></span>
                </div>
                <div class="flex justify-center space-x-3 mt-3">
                    <button onclick="copyRoomId()" class="px-4 py-2 rounded-lg bg-blue-100 text-blue-700 text-sm font-semibold hover:bg-blue-200 transition-colors">
                        ğŸ“‹ IDã‚³ãƒ”ãƒ¼
                    </button>
                    <button onclick="copyInviteLink()" class="px-4 py-2 rounded-lg bg-green-100 text-green-700 text-sm font-semibold hover:bg-green-200 transition-colors">
                        ğŸ”— æ‹›å¾…ãƒªãƒ³ã‚¯
                    </button>
                </div>
                <div class="text-sm text-gray-500 mt-2">å‹é”ã«æ‹›å¾…ãƒªãƒ³ã‚¯ã‚’é€ã£ã¦ç°¡å˜å‚åŠ ï¼</div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 mb-6 md:mb-8">
                <div class="bg-gradient-to-r from-blue-100 to-purple-100 rounded-2xl p-4 md:p-6">
                    <h3 class="text-xl md:text-2xl font-bold text-blue-600 mb-4">ğŸ‘¥ å‚åŠ è€…</h3>
                    <div id="playerList" class="space-y-2"></div>
                </div>
                
                <div class="bg-gradient-to-r from-green-100 to-blue-100 rounded-2xl p-4 md:p-6">
                    <h3 class="text-xl md:text-2xl font-bold text-green-600 mb-4">ğŸ“‹ ã‚²ãƒ¼ãƒ æƒ…å ±</h3>
                    <p class="text-base md:text-lg text-gray-700">å•é¡Œæ•°: 5å•</p>
                    <p class="text-base md:text-lg text-gray-700">åˆ¶é™æ™‚é–“: 20ç§’/å•</p>
                    <p class="text-base md:text-lg text-gray-700">å†…å®¹: æœ€å¤§å…¬ç´„æ•°ãƒ»æœ€å°å…¬å€æ•°</p>
                    <p class="text-base md:text-lg text-purple-700 font-semibold">ğŸ”¥ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¯¾æˆ¦</p>
                </div>
            </div>
            
            <div class="text-center">
                <button id="startButton" onclick="startGame(this)" class="bg-gradient-to-r from-red-400 to-pink-500 text-white text-xl md:text-2xl font-bold py-4 md:py-6 px-8 md:px-12 rounded-2xl hover:from-red-500 hover:to-pink-600 transform hover:scale-105 transition-all duration-200 shadow-lg pulse-glow touch-button">
                    ğŸš€ ã‚²ãƒ¼ãƒ é–‹å§‹ï¼
                </button>
                <div class="text-sm text-gray-500 mt-2">â€»ãƒ›ã‚¹ãƒˆã®ã¿é–‹å§‹ã§ãã¾ã™</div>
            </div>
        </div>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
    <div id="gameScreen" class="hidden min-h-screen p-4 md:p-8 game-container max-screen">
        <div class="max-w-6xl mx-auto">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="bg-white rounded-2xl shadow-lg p-4 md:p-6 mb-4 md:mb-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
                <div class="flex items-center space-x-4 md:space-x-6">
                    <div class="text-xl md:text-2xl font-bold text-purple-600">
                        å•é¡Œ <span id="questionNumber">1</span>/5
                    </div>
                    <div class="text-lg md:text-xl text-gray-600">
                        ã‚ãªãŸã®ã‚¹ã‚³ã‚¢: <span id="currentScore" class="font-bold text-green-600">0</span>ç‚¹
                    </div>
                </div>
                
                <!-- ã‚¿ã‚¤ãƒãƒ¼ -->
                <div class="relative">
                    <svg class="w-16 h-16 md:w-20 md:h-20 transform -rotate-90">
                        <circle cx="32" cy="32" r="28" stroke="#e5e7eb" stroke-width="4" fill="transparent" class="md:hidden"/>
                        <circle cx="40" cy="40" r="35" stroke="#e5e7eb" stroke-width="6" fill="transparent" class="hidden md:block"/>
                        <circle id="timerCircle" cx="32" cy="32" r="28" stroke="#ff6b6b" stroke-width="4" fill="transparent" class="timer-circle md:hidden"/>
                        <circle id="timerCircleLarge" cx="40" cy="40" r="35" stroke="#ff6b6b" stroke-width="6" fill="transparent" class="timer-circle hidden md:block"/>
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <span id="timeLeft" class="text-xl md:text-2xl font-bold text-red-500">20</span>
                    </div>
                </div>
            </div>
            
            <!-- å•é¡Œã‚¨ãƒªã‚¢ -->
            <div class="bg-white rounded-3xl shadow-2xl p-6 md:p-12 mb-4 md:mb-6 bounce-in">
                <div class="text-center">
                    <h3 class="text-2xl md:text-4xl font-bold text-gray-800 mb-6 md:mb-8" id="questionText">
                        12ã¨18ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚
                    </h3>
                    
                    <div class="flex flex-col md:flex-row justify-center items-center space-y-4 md:space-y-0 md:space-x-4 mb-6 md:mb-8">
                        <span class="text-xl md:text-2xl font-semibold text-gray-600">ç­”ãˆ:</span>
                        <input id="answerInput" type="text" inputmode="numeric" pattern="[0-9ï¼-ï¼™]*" aria-label="æ•°å­¦å•é¡Œã®ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" class="text-2xl md:text-3xl font-bold p-3 md:p-4 border-4 border-blue-300 rounded-xl focus:border-blue-500 focus:outline-none w-32 md:w-32 text-center answer-input touch-button" placeholder="?">
                        <button id="submitBtn" onclick="submitAnswer()" class="bg-gradient-to-r from-green-400 to-blue-500 text-white text-lg md:text-xl font-bold py-3 md:py-4 px-6 md:px-8 rounded-xl hover:from-green-500 hover:to-blue-600 transform hover:scale-105 transition-all duration-200 touch-button">
                            å›ç­”
                        </button>
                    </div>

                    <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å›ç­”çŠ¶æ³ -->
                    <div id="answerStatus" class="mt-4 md:mt-6 p-3 md:p-4 bg-gray-100 rounded-xl">
                        <h4 class="text-base md:text-lg font-bold text-gray-700 mb-3">ğŸ“Š å›ç­”çŠ¶æ³</h4>
                        <div id="playerAnswerStatus" class="grid grid-cols-1 md:grid-cols-2 gap-2 md:gap-3"></div>
                    </div>
                </div>
            </div>
            
            <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰ -->
            <div class="bg-white rounded-2xl shadow-lg p-4 md:p-6">
                <h4 class="text-xl md:text-2xl font-bold text-center text-gray-700 mb-4">ğŸ† ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¹ã‚³ã‚¢</h4>
                <div id="scoreBoard" class="grid grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-3 md:gap-4 overflow-x-auto"></div>
            </div>
        </div>
    </div>

    <!-- å•é¡Œé–“ã®å¾…æ©Ÿç”»é¢ -->
    <div id="betweenQuestionsScreen" class="hidden flex items-center justify-center min-h-screen p-4 md:p-8 max-screen">
        <div class="bg-white rounded-3xl shadow-2xl p-8 md:p-12 max-w-4xl w-full text-center game-container">
            <h2 class="text-3xl md:text-4xl font-bold text-purple-600 mb-6">ğŸ“Š å•é¡Œçµæœ</h2>
            
            <div id="questionResult" class="mb-6 md:mb-8"></div>
            
            <div class="text-xl md:text-2xl font-semibold text-gray-600 mb-4">
                æ¬¡ã®å•é¡Œã¾ã§ <span id="nextQuestionCountdown" class="text-red-500 font-bold">3</span> ç§’
            </div>
            
            <div id="currentRanking" class="bg-gradient-to-r from-yellow-100 to-orange-100 rounded-2xl p-4 md:p-6">
                <h3 class="text-xl md:text-2xl font-bold text-orange-600 mb-4">ğŸ¥‡ ç¾åœ¨ã®é †ä½</h3>
                <div id="rankingList"></div>
            </div>
        </div>
    </div>

    <!-- çµæœç”»é¢ -->
    <div id="resultScreen" class="hidden flex items-center justify-center min-h-screen p-4 md:p-8 max-screen">
        <div class="bg-white rounded-3xl shadow-2xl p-8 md:p-12 max-w-4xl w-full game-container">
            <div class="text-center mb-6 md:mb-8">
                <h2 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500 mb-4">
                    ğŸ‰ æœ€çµ‚çµæœ ğŸ‰
                </h2>
            </div>
            
            <div id="finalResults" class="space-y-4 mb-6 md:mb-8"></div>
            
            <div class="text-center">
                <button onclick="showMainScreen()" class="bg-gradient-to-r from-purple-400 to-pink-500 text-white text-xl md:text-2xl font-bold py-4 md:py-6 px-8 md:px-12 rounded-2xl hover:from-purple-500 hover:to-pink-600 transform hover:scale-105 transition-all duration-200 shadow-lg touch-button">
                    ğŸ  ãƒ¡ã‚¤ãƒ³ã«æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <!-- ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒ»åˆ©ç”¨è¦ç´„ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <div class="fixed bottom-2 left-2 right-2 text-center text-xs text-white opacity-75 pointer-events-none z-10">
        åŒ¿åã§ãƒ—ãƒ¬ã‚¤ãƒ»éƒ¨å±‹IDã‚’çŸ¥ã‚‹äººã¯è¦³æˆ¦å¯èƒ½ | ãƒ‡ãƒ¼ã‚¿ã¯24æ™‚é–“å¾Œè‡ªå‹•å‰Šé™¤
    </div>

    <!-- è¦³æˆ¦ãƒ¢ãƒ¼ãƒ‰ç”»é¢ -->
    <div id="observerScreen" class="hidden min-h-screen p-4 md:p-8 bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900">
        <div class="max-w-7xl mx-auto">
            <div class="text-center mb-8">
                <h1 class="text-4xl md:text-6xl font-bold text-white mb-4">
                    ğŸ† ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰
                </h1>
                <div class="text-xl md:text-2xl text-blue-200">
                    éƒ¨å±‹ID: <span id="observerRoomId" class="font-bold text-yellow-300"></span>
                </div>
            </div>
            
            <div class="bg-white rounded-3xl shadow-2xl p-6 md:p-12">
                <div id="observerScoreBoard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
            </div>
            
            <div class="text-center mt-8">
                <div class="text-lg text-white opacity-75">
                    å•é¡Œ <span id="observerQuestionNumber">-</span>/5 | 
                    æ®‹ã‚Šæ™‚é–“: <span id="observerTimeLeft">-</span>ç§’
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            updateDoc, 
            onSnapshot, 
            collection, 
            addDoc, 
            serverTimestamp, 
            increment, 
            query, 
            where,
            orderBy,
            deleteDoc,
            getDocs,
            writeBatch,
            runTransaction,
            enableIndexedDbPersistence,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

        // Firebaseæœ¬ç•ªè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyBqJVJKvwxJ8F5rZGxQHvKjL2mN3oP4qR5s",
            authDomain: "math-quiz-realtime.firebaseapp.com",
            projectId: "math-quiz-realtime",
            storageBucket: "math-quiz-realtime.appspot.com",
            messagingSenderId: "987654321098",
            appId: "1:987654321098:web:abcdef123456789"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ°¸ç¶šåŒ–ï¼ˆå¯¾å¿œç«¯æœ«ã®ã¿ï¼‰
        enableIndexedDbPersistence(db).catch((err) => {
            // å¤±æ•—ã—ã¦ã‚‚è‡´å‘½ã§ã¯ãªã„ã®ã§ãƒ­ã‚°ã ã‘
            console.warn('IndexedDB persistence disabled:', err?.code || err);
        });

        // FirebaseåˆæœŸåŒ–å®Œäº†

        // è¦³æˆ¦ãƒ¢ãƒ¼ãƒ‰ç”¨ã‚¿ã‚¤ãƒãƒ¼
        let observerTimer = null;

        // åŒ¿åèªè¨¼ã®åˆæœŸåŒ–
        let authInitialized = false;
        onAuthStateChanged(auth, (user) => {
            if (!user && !authInitialized) {
                signInAnonymously(auth).catch(console.error);
            }
            authInitialized = true;
        });

        // URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å‡¦ç†
        const urlParams = new URLSearchParams(window.location.search);
        const isObserverMode = urlParams.get('view') === 'board';
        const inviteRoomId = urlParams.get('room');

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let gameState = {
            roomId: null,
            playerId: null,
            playerName: null,
            isHost: false,
            currentQuestion: 0,
            timeLeft: 20,
            durationSec: 20,
            timer: null,
            questionStartAtMs: null,
            roomUnsubscribe: null,
            playersUnsubscribe: null,
            answersUnsubscribe: null,
            playersCache: [],
            isObserver: isObserverMode,
            questions: [
                // æœ€å¤§å…¬ç´„æ•°å•é¡Œ
                { question: "12ã¨18ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "6" },
                { question: "24ã¨36ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "12" },
                { question: "21ã¨28ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "7" },
                { question: "18ã¨24ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "6" },
                { question: "16ã¨24ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "8" },
                { question: "20ã¨30ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "10" },
                { question: "14ã¨35ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "7" },
                { question: "27ã¨36ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "9" },
                { question: "32ã¨48ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "16" },
                { question: "45ã¨60ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "15" },
                { question: "25ã¨40ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "5" },
                { question: "28ã¨42ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "14" },
                { question: "30ã¨45ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "15" },
                { question: "12ã¨20ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "4" },
                { question: "36ã¨54ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "18" },
                { question: "40ã¨56ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "8" },
                { question: "9ã¨15ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "3" },
                { question: "48ã¨60ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "12" },
                { question: "33ã¨44ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "11" },
                { question: "35ã¨49ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "7" },
                { question: "24ã¨40ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "8" },
                { question: "42ã¨63ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "21" },
                { question: "18ã¨27ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "9" },
                { question: "50ã¨65ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "5" },
                { question: "12ã¨15ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "3" },
                { question: "8ã€12ã€20ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "4" },
                { question: "18ã€30ã€42ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "6" },
                { question: "16ã€20ã€24ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "4" },
                { question: "6ã€9ã€15ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "3" },
                { question: "14ã€21ã€28ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "7" },
                
                // æœ€å°å…¬å€æ•°å•é¡Œ
                { question: "2ã¨3ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "6" },
                { question: "3ã¨5ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "15" },
                { question: "4ã¨6ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "12" },
                { question: "6ã¨8ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "24" },
                { question: "7ã¨9ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "63" },
                { question: "8ã¨9ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "72" },
                { question: "4ã¨9ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "36" },
                { question: "5ã¨6ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "30" },
                { question: "6ã¨7ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "42" },
                { question: "5ã¨8ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "40" },
                { question: "3ã¨6ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "6" },
                { question: "2ã¨8ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "8" },
                { question: "3ã¨9ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "9" },
                { question: "4ã¨8ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "8" },
                { question: "2ã¨4ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "4" },
                { question: "5ã¨7ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "35" },
                { question: "2ã¨5ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "10" },
                { question: "6ã¨9ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "18" },
                { question: "7ã¨8ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "56" },
                { question: "2ã¨7ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "14" },
                { question: "3ã¨7ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "21" },
                { question: "4ã¨7ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "28" },
                { question: "5ã¨9ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "45" },
                { question: "3ã¨4ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "12" },
                { question: "12ã¨18ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "36" },
                { question: "8ã¨20ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "40" },
                { question: "14ã¨35ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "70" },
                { question: "2ã€3ã€4ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "12" },
                { question: "2ã€3ã€5ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "30" },
                { question: "3ã€4ã€6ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "12" },
                { question: "4ã€6ã€8ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "24" },
                { question: "3ã€5ã€9ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "45" },
                { question: "4ã€5ã€8ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "40" },
                { question: "6ã€8ã€12ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "24" },
                { question: "15ã€20ã€30ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "60" }
            ]
        };

        // SHA256ãƒãƒƒã‚·ãƒ¥é–¢æ•°
        async function sha256(text) {
            const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(text));
            return [...new Uint8Array(buf)].map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // å…¨è§’æ•°å­—ã‚’åŠè§’æ•°å­—ã«æ­£è¦åŒ–
        function normalizeNum(s) { 
            return s.replace(/[ï¼-ï¼™]/g, c => String.fromCharCode(c.charCodeAt(0) - 0xFEE0)); 
        }

        // XSSå¯¾ç­–ç”¨ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
        function safe(s) {
            return String(s).replace(/[&<>"']/g, m => ({
                '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'
            }[m]));
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åæ­£è¦åŒ–ï¼ˆé•·ã•åˆ¶é™ï¼‰
        function normalizeName(s){
            return String(s || '').trim().slice(0, 20);
        }

        // éƒ¨å±‹IDã‚³ãƒ”ãƒ¼
        window.copyRoomId = async function(){
            try {
                const id = gameState.roomId || '';
                await navigator.clipboard.writeText(id);
                showConnectionStatus('ğŸ“‹ éƒ¨å±‹IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            } catch(e){
                showConnectionStatus('âŒ ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
            }
        }

        // æ‹›å¾…ãƒªãƒ³ã‚¯ã‚³ãƒ”ãƒ¼
        window.copyInviteLink = async function(){
            try {
                const url = `${location.origin}${location.pathname}?room=${gameState.roomId}`;
                await navigator.clipboard.writeText(url);
                showConnectionStatus('ğŸ”— æ‹›å¾…ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            } catch(e){
                showConnectionStatus('âŒ ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
            }
        }

        // æ¥ç¶šçŠ¶æ…‹è¡¨ç¤º
        function showConnectionStatus(message, isError = false) {
            const status = document.getElementById('connectionStatus');
            status.textContent = message;
            status.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-full text-white font-semibold ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            status.classList.remove('hidden');
            
            if (!isError) {
                setTimeout(() => {
                    status.classList.add('hidden');
                }, 3000);
            }
        }

        // è¦³æˆ¦ãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ–
        if (isObserverMode) {
            document.addEventListener('DOMContentLoaded', () => {
                const roomId = urlParams.get('room');
                if (roomId) {
                    gameState.roomId = roomId;
                    showObserverScreen();
                } else {
                    alert('è¦³æˆ¦ãƒ¢ãƒ¼ãƒ‰ã«ã¯ ?view=board&room=ROOMID ãŒå¿…è¦ã§ã™');
                }
            });
        }

        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
        function showScreen(screenId) {
            const screens = ['mainScreen', 'roomCreateScreen', 'roomJoinScreen', 'waitingScreen', 'gameScreen', 'resultScreen', 'betweenQuestionsScreen', 'observerScreen'];
            screens.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        window.showMainScreen = function() {
            showScreen('mainScreen');
            resetGame();
        }

        window.showRoomCreate = function() {
            showScreen('roomCreateScreen');
        }

        window.showRoomJoin = function() {
            showScreen('roomJoinScreen');
        }

        // è¦³æˆ¦ãƒ¢ãƒ¼ãƒ‰ç”»é¢è¡¨ç¤º
        function showObserverScreen() {
            showScreen('observerScreen');
            document.getElementById('observerRoomId').textContent = gameState.roomId;
            
            // éƒ¨å±‹ã¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è³¼èª­é–‹å§‹
            subscribeToRoom();
            subscribeToPlayers();
        }

        // è¦³æˆ¦ã‚¿ã‚¤ãƒãƒ¼
        function startObserverTimer() {
            if (observerTimer) clearInterval(observerTimer);
            observerTimer = setInterval(() => {
                if (!gameState.questionStartAtMs) return;
                const elapsed = Math.floor((Date.now() - gameState.questionStartAtMs) / 1000);
                const timeLeft = Math.max(0, gameState.durationSec - elapsed);
                const el = document.getElementById('observerTimeLeft');
                if (el) el.textContent = timeLeft;
            }, 250);
        }

        // å¼·åŒ–ã•ã‚ŒãŸãƒ«ãƒ¼ãƒ IDç”Ÿæˆï¼ˆ8-10æ¡ã€æš—å·å­¦çš„ã«å®‰å…¨ï¼‰
        function randomId(len = 8) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            const buf = new Uint8Array(len);
            crypto.getRandomValues(buf);
            return Array.from(buf, b => chars[b % chars.length]).join('');
        }

        async function generateRoomId() {
            for (let i = 0; i < 5; i++) {
                const id = randomId(8); // 8æ¡æ¨å¥¨
                const snap = await getDoc(doc(db, 'rooms', id));
                if (!snap.exists()) return id;
            }
            return randomId(10); // è¡çªæ™‚ã¯10æ¡ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        }

        // éƒ¨å±‹ä½œæˆ
        window.createRoom = async function(btn) {
            if (!auth.currentUser) { 
                showConnectionStatus('ğŸ” æ¥ç¶šæº–å‚™ä¸­â€¦ æ•°ç§’å¾Œã«å†è©¦è¡Œã—ã¦ãã ã•ã„', true); 
                return; 
            }
            
            btn?.setAttribute('disabled', true);
            
            const usePassword = document.getElementById('usePasswordToggle').checked;
            const password = usePassword ? document.getElementById('createPassword').value.trim() : '';
            const playerName = normalizeName(document.getElementById('createPlayerName').value);
            
            if (!playerName) {
                showConnectionStatus('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼', true);
                btn?.removeAttribute('disabled');
                return;
            }

            if (usePassword && !password) {
                showConnectionStatus('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼', true);
                btn?.removeAttribute('disabled');
                return;
            }

            try {
                showConnectionStatus('ğŸ”„ éƒ¨å±‹ã‚’ä½œæˆä¸­...');
                
                // 8æ¡ã®ãƒ©ãƒ³ãƒ€ãƒ IDç”Ÿæˆï¼ˆè¡çªå›é¿ï¼‰
                const roomId = await generateRoomId();
                const passwordHash = password ? await sha256(password) : null;
                
                // å•é¡Œã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
                const shuffledQuestions = [...gameState.questions].sort(() => Math.random() - 0.5).slice(0, 5);
                
                // éƒ¨å±‹ä½œæˆï¼ˆ24æ™‚é–“å¾Œã«è‡ªå‹•å‰Šé™¤ï¼‰
                const expiresAt = Timestamp.fromMillis(Date.now() + 24*60*60*1000);
                
                await setDoc(doc(db, 'rooms', roomId), {
                    passwordHash: passwordHash,
                    requirePassword: !!password,
                    locked: false,
                    status: 'waiting',
                    questionIndex: 0,
                    questions: shuffledQuestions,
                    hostUid: auth.currentUser?.uid,
                    durationSec: 20,
                    createdAt: serverTimestamp(),
                    expiresAt: expiresAt
                });

                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ ï¼ˆuidã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã«ä½¿ç”¨ï¼‰
                const playerId = auth.currentUser?.uid;
                await setDoc(doc(db, 'rooms', roomId, 'players', playerId), {
                    name: playerName,
                    score: 0,
                    joinedAt: serverTimestamp(),
                    role: 'host',
                    expiresAt: expiresAt
                });

                gameState.roomId = roomId;
                gameState.playerId = playerId;
                gameState.playerName = playerName;
                gameState.isHost = true;

                showConnectionStatus('âœ… éƒ¨å±‹ã‚’ä½œæˆã—ã¾ã—ãŸï¼');
                showWaitingScreen();
                
            } catch (error) {
                console.error('éƒ¨å±‹ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                showConnectionStatus('âŒ éƒ¨å±‹ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ', true);
            } finally {
                btn?.removeAttribute('disabled');
            }
        }

        // éƒ¨å±‹å‚åŠ 
        window.joinRoom = async function(btn) {
            if (!auth.currentUser) { 
                showConnectionStatus('ğŸ” æ¥ç¶šæº–å‚™ä¸­â€¦ æ•°ç§’å¾Œã«å†è©¦è¡Œã—ã¦ãã ã•ã„', true); 
                return; 
            }
            
            btn?.setAttribute('disabled', true);
            
            const roomId = document.getElementById('joinRoomId').value.trim().toUpperCase();
            const usePassword = document.getElementById('joinUsePasswordToggle').checked;
            const password = usePassword ? document.getElementById('joinPassword').value.trim() : '';
            const playerName = normalizeName(document.getElementById('joinPlayerName').value);
            
            if (!roomId || !playerName) {
                showConnectionStatus('éƒ¨å±‹IDã¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼', true);
                btn?.removeAttribute('disabled');
                return;
            }

            if (usePassword && !password) {
                showConnectionStatus('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼', true);
                btn?.removeAttribute('disabled');
                return;
            }

            try {
                showConnectionStatus('ğŸ”„ éƒ¨å±‹ã«å‚åŠ ä¸­...');
                
                // éƒ¨å±‹ã®å­˜åœ¨ç¢ºèªã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç…§åˆ
                const roomDoc = await getDoc(doc(db, 'rooms', roomId));
                if (!roomDoc.exists()) {
                    showConnectionStatus('éƒ¨å±‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼', true);
                    return;
                }

                const roomData = roomDoc.data();
                
                // ãƒ­ãƒƒã‚¯ç¢ºèª
                if (roomData.locked) {
                    showConnectionStatus('ã“ã®éƒ¨å±‹ã¯ãƒ­ãƒƒã‚¯ä¸­ã§ã™ï¼', true);
                    return;
                }

                // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª
                if (roomData.requirePassword) {
                    if (!password) {
                        showConnectionStatus('ã“ã®éƒ¨å±‹ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¿…è¦ã§ã™ï¼', true);
                        return;
                    }
                    const passwordHash = await sha256(password);
                    if (roomData.passwordHash !== passwordHash) {
                        showConnectionStatus('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ï¼', true);
                        return;
                    }
                }

                if (roomData.status !== 'waiting') {
                    showConnectionStatus('ã“ã®éƒ¨å±‹ã¯ã™ã§ã«ã‚²ãƒ¼ãƒ ä¸­ã§ã™ï¼', true);
                    return;
                }

                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ ï¼ˆuidã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã«ä½¿ç”¨ï¼‰
                const playerId = auth.currentUser?.uid;
                const expiresAt = Timestamp.fromMillis(Date.now() + 24*60*60*1000);
                await setDoc(doc(db, 'rooms', roomId, 'players', playerId), {
                    name: playerName,
                    score: 0,
                    joinedAt: serverTimestamp(),
                    role: 'player',
                    expiresAt: expiresAt
                });

                gameState.roomId = roomId;
                gameState.playerId = playerId;
                gameState.playerName = playerName;
                gameState.isHost = false;

                showConnectionStatus('âœ… éƒ¨å±‹ã«å‚åŠ ã—ã¾ã—ãŸï¼');
                showWaitingScreen();
                
            } catch (error) {
                console.error('éƒ¨å±‹å‚åŠ ã‚¨ãƒ©ãƒ¼:', error);
                showConnectionStatus('âŒ éƒ¨å±‹å‚åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
            } finally {
                btn?.removeAttribute('disabled');
            }
        }

        // å¾…æ©Ÿç”»é¢è¡¨ç¤º
        function showWaitingScreen() {
            showScreen('waitingScreen');
            document.getElementById('currentRoomId').textContent = gameState.roomId;
            
            // ãƒ›ã‚¹ãƒˆã®ã¿é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            const startButton = document.getElementById('startButton');
            if (gameState.isHost) {
                startButton.disabled = false;
                startButton.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                startButton.disabled = true;
                startButton.classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã®è³¼èª­é–‹å§‹
            subscribeToRoom();
            subscribeToPlayers();
        }

        // éƒ¨å±‹çŠ¶æ…‹ã®è³¼èª­
        function subscribeToRoom() {
            if (gameState.roomUnsubscribe) {
                gameState.roomUnsubscribe();
            }
            
            gameState.roomUnsubscribe = onSnapshot(doc(db, 'rooms', gameState.roomId), (doc) => {
                if (doc.exists()) {
                    const roomData = doc.data();
                    
                    // æŒç¶šæ™‚é–“ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
                    gameState.durationSec = roomData.durationSec || 20;
                    
                    // inGameãªã‚‰æœ€åˆã«é–‹å§‹æ™‚åˆ»ã‚’åæ˜ ï¼ˆé·ç§»å‰ã«æƒãˆã‚‹ï¼‰
                    if (roomData.status === 'inGame' && roomData.questionStartAt) {
                        gameState.questionStartAtMs = roomData.questionStartAt.toMillis();
                    }
                    
                    // çµ‚äº†æ™‚ã¯å³ãƒªã‚¶ãƒ«ãƒˆã¸
                    if (roomData.status === 'ended') {
                        if (observerTimer) { clearInterval(observerTimer); observerTimer = null; }
                        if (gameState.isObserver) {
                            const el = document.getElementById('observerTimeLeft');
                            if (el) el.textContent = 0;
                            // è¦³æˆ¦UIã®ã¾ã¾å›ºå®šè¡¨ç¤º
                        } else {
                            showResults();
                        }
                        if (gameState.playersUnsubscribe) { gameState.playersUnsubscribe(); gameState.playersUnsubscribe = null; }
                        if (gameState.answersUnsubscribe) { gameState.answersUnsubscribe(); gameState.answersUnsubscribe = null; }
                        return;
                    }
                    
                    // è¦³æˆ¦ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
                    if (gameState.isObserver) {
                        document.getElementById('observerQuestionNumber').textContent = (roomData.questionIndex || 0) + 1;
                        
                        // ã‚¿ã‚¤ãƒãƒ¼åŒæœŸï¼ˆè¦³æˆ¦ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰
                        if (roomData.questionStartAt && roomData.status === 'inGame') {
                            gameState.questionStartAtMs = roomData.questionStartAt.toMillis();
                            startObserverTimer();
                        }
                        return;
                    }
                    
                    if (roomData.status === 'inGame' && document.getElementById('waitingScreen').classList.contains('hidden') === false) {
                        // ã‚²ãƒ¼ãƒ é–‹å§‹
                        gameState.questions = roomData.questions;
                        showScreen('gameScreen');
                        showQuestion();
                    } else if (roomData.status === 'inGame') {
                        // å•é¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ›´æ–°
                        if (roomData.questionIndex !== gameState.currentQuestion) {
                            gameState.currentQuestion = roomData.questionIndex;
                            if (gameState.currentQuestion >= 5) {
                                showResults();
                            } else {
                                showQuestion();
                            }
                        }
                        
                        // ã‚¿ã‚¤ãƒãƒ¼åŒæœŸ
                        if (roomData.questionStartAt) {
                            gameState.questionStartAtMs = roomData.questionStartAt.toMillis();
                        }
                    }
                }
            });
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸€è¦§ã®è³¼èª­
        function subscribeToPlayers() {
            if (gameState.playersUnsubscribe) {
                gameState.playersUnsubscribe();
            }
            
            gameState.playersUnsubscribe = onSnapshot(
                query(collection(db, 'rooms', gameState.roomId, 'players'), orderBy('joinedAt')),
                (snapshot) => {
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
                    gameState.playersCache = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    if (gameState.isObserver) {
                        updateObserverScoreBoard(snapshot.docs);
                    } else {
                        updatePlayerList(snapshot.docs);
                        updateScoreBoard(snapshot.docs);
                    }
                }
            );
        }

        // å›ç­”ã®è³¼èª­
        function subscribeToAnswers() {
            if (gameState.answersUnsubscribe) {
                gameState.answersUnsubscribe();
            }
            
            const answersQuery = query(
                collection(db, 'rooms', gameState.roomId, 'answers'),
                where('questionIndex', '==', gameState.currentQuestion)
            );
            
            gameState.answersUnsubscribe = onSnapshot(answersQuery, (snapshot) => {
                updateAnswerStatus(snapshot.docs);
            });
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆæ›´æ–°
        function updatePlayerList(playerDocs) {
            const playerList = document.getElementById('playerList');
            if (!playerList) return;
            
            playerList.innerHTML = '';
            
            playerDocs.forEach((doc, index) => {
                const player = doc.data();
                const playerDiv = document.createElement('div');
                playerDiv.className = 'bg-white rounded-lg p-3 flex items-center space-x-3';
                playerDiv.innerHTML = `
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white font-bold text-sm">
                        ${index + 1}
                    </div>
                    <span class="text-base md:text-lg font-semibold">${safe(player.name)}</span>
                    ${doc.id === gameState.playerId ? '<span class="text-xs md:text-sm text-blue-500">ï¼ˆã‚ãªãŸï¼‰</span>' : ''}
                    ${player.role === 'host' ? '<span class="text-xs md:text-sm text-purple-500">ğŸ‘‘</span>' : ''}
                `;
                playerList.appendChild(playerDiv);
            });
        }

        // è¦³æˆ¦ãƒ¢ãƒ¼ãƒ‰ç”¨ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰æ›´æ–°
        function updateObserverScoreBoard(playerDocs) {
            const scoreBoard = document.getElementById('observerScoreBoard');
            if (!scoreBoard) return;
            
            scoreBoard.innerHTML = '';
            
            // ã‚¹ã‚³ã‚¢é †ã«ã‚½ãƒ¼ãƒˆ
            const sortedPlayers = playerDocs
                .map(doc => ({ id: doc.id, ...doc.data() }))
                .sort((a, b) => b.score - a.score);
            
            sortedPlayers.forEach((player, index) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = `rounded-2xl p-6 text-center transition-all duration-300 transform hover:scale-105`;
                
                if (index === 0) {
                    playerDiv.className += ' bg-gradient-to-r from-yellow-300 to-yellow-500 shadow-2xl';
                } else if (index === 1) {
                    playerDiv.className += ' bg-gradient-to-r from-gray-300 to-gray-500 shadow-xl';
                } else if (index === 2) {
                    playerDiv.className += ' bg-gradient-to-r from-orange-300 to-orange-500 shadow-xl';
                } else {
                    playerDiv.className += ' bg-gradient-to-r from-blue-200 to-purple-300 shadow-lg';
                }
                
                const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : 'ğŸ…';
                
                playerDiv.innerHTML = `
                    <div class="text-4xl mb-3">${medal}</div>
                    <div class="text-2xl font-bold text-gray-800 mb-2">${safe(player.name)}</div>
                    <div class="text-3xl font-bold text-blue-700">${player.score}ç‚¹</div>
                    <div class="text-lg text-gray-600 mt-2">${index + 1}ä½</div>
                `;
                scoreBoard.appendChild(playerDiv);
            });
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        window.startGame = async function(btn) {
            if (!gameState.isHost) return;
            
            btn?.setAttribute('disabled', true);
            
            try {
                showConnectionStatus('ğŸš€ ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã™...');
                
                await updateDoc(doc(db, 'rooms', gameState.roomId), {
                    status: 'inGame',
                    locked: true,
                    questionIndex: 0,
                    questionStartAt: serverTimestamp()
                });
                
            } catch (error) {
                console.error('ã‚²ãƒ¼ãƒ é–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
                showConnectionStatus('âŒ ã‚²ãƒ¼ãƒ é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
            } finally {
                btn?.removeAttribute('disabled');
            }
        }

        // å•é¡Œè¡¨ç¤º
        function showQuestion() {
            if (gameState.currentQuestion >= 5) {
                showResults();
                return;
            }
            
            const question = gameState.questions[gameState.currentQuestion];
            document.getElementById('questionNumber').textContent = gameState.currentQuestion + 1;
            document.getElementById('questionText').textContent = question.question;
            document.getElementById('answerInput').value = '';
            
            // UIè¦ç´ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('answerInput').disabled = false;
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('answerInput').classList.remove('answered');
            
            // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
            startTimer();
            
            // å›ç­”çŠ¶æ³ã®è³¼èª­é–‹å§‹
            subscribeToAnswers();
            
            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            setTimeout(() => {
                document.getElementById('answerInput').focus();
            }, 100);
        }

        // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
        function startTimer() {
            if (gameState.timer) {
                clearInterval(gameState.timer);
            }
            
            gameState.timer = setInterval(() => {
                if (!gameState.questionStartAtMs) return;
                
                const elapsed = Math.floor((Date.now() - gameState.questionStartAtMs) / 1000);
                gameState.timeLeft = Math.max(0, gameState.durationSec - elapsed);
                updateTimerDisplay();
                
                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.timer);
                    // æ™‚é–“åˆ‡ã‚Œã®å ´åˆã‚‚å›ç­”ã¨ã—ã¦è¨˜éŒ²
                    if (document.getElementById('answerInput').disabled === false) {
                        submitAnswer();
                    }
                }
            }, 250); // ç´°ã‹ãæ›´æ–°ã—ã¦è¦‹ãŸç›®ãªã‚ã‚‰ã‹ã«
        }

        // ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºæ›´æ–°
        function updateTimerDisplay() {
            const timeLeftElement = document.getElementById('timeLeft');
            if (timeLeftElement) {
                timeLeftElement.textContent = gameState.timeLeft;
            }
            
            const circles = [document.getElementById('timerCircle'), document.getElementById('timerCircleLarge')];
            circles.forEach((circle) => {
                if (circle) {
                    const durationSec = gameState.durationSec;
                    
                    const radius = parseFloat(circle.getAttribute('r') || '0');
                    const circumference = 2 * Math.PI * radius;
                    const offset = circumference - (circumference * gameState.timeLeft / durationSec);
                    circle.style.strokeDasharray = circumference;
                    circle.style.strokeDashoffset = offset;
                    
                    // æ™‚é–“ãŒå°‘ãªããªã£ãŸã‚‰è‰²ã‚’å¤‰æ›´
                    const halfTime = durationSec / 2;
                    const quarterTime = durationSec / 4;
                    
                    if (gameState.timeLeft <= quarterTime) {
                        circle.style.stroke = '#ef4444';
                    } else if (gameState.timeLeft <= halfTime) {
                        circle.style.stroke = '#f59e0b';
                    } else {
                        circle.style.stroke = '#10b981';
                    }
                }
            });
        }

        // å›ç­”é€ä¿¡
        window.submitAnswer = async function() {
            if (window._submittingAnswer) return;
            const ai = document.getElementById('answerInput');
            const sb = document.getElementById('submitBtn');
            if (ai.disabled) return;
            window._submittingAnswer = true;
            ai.disabled = true; sb.disabled = true; ai.classList.add('answered');
            
            const raw = ai.value.trim();
            const userAnswer = normalizeNum(raw).replace(/[()ï¼ˆï¼‰]/g, '');
            const correctAnswer = normalizeNum(gameState.questions[gameState.currentQuestion].answer).replace(/[()ï¼ˆï¼‰]/g, '');
            
            const isCorrect = userAnswer === correctAnswer;
            
            try {
                const answerRef = doc(db, 'rooms', gameState.roomId, 'answers',
                    `${gameState.currentQuestion}_${gameState.playerId}`);
                await runTransaction(db, async (tx) => {
                    const snap = await tx.get(answerRef);
                    if (snap.exists()) return; // å…ˆç€ã®ã¿
                    const expiresAt = Timestamp.fromMillis(Date.now() + 24*60*60*1000);
                    tx.set(answerRef, {
                        playerId: gameState.playerId,
                        playerName: gameState.playerName,
                        questionIndex: gameState.currentQuestion,
                        answer: userAnswer,
                        isCorrect: isCorrect,
                        timeLeft: gameState.timeLeft,
                        submittedAt: serverTimestamp(),
                        expiresAt: expiresAt
                    });
                });

                // UIã¯ã™ã§ã«ç„¡åŠ¹åŒ–æ¸ˆã¿
                
                // ãƒ›ã‚¹ãƒˆã®å ´åˆã€æ™‚é–“åˆ‡ã‚Œã§æ¡ç‚¹ï¼†æ¬¡ã®å•é¡Œã¸
                if (gameState.isHost) {
                    if (_hostWaitInterval) clearInterval(_hostWaitInterval);
                    _hostWaitInterval = setInterval(() => {
                        const elapsed = Math.floor((Date.now() - (gameState.questionStartAtMs || 0)) / 1000);
                        if (elapsed >= (gameState.durationSec || 20)) {
                            clearInterval(_hostWaitInterval);
                            _hostWaitInterval = null;
                            gradeAndAdvance();
                        }
                    }, 200);
                }
                
            } catch (error) {
                console.error('å›ç­”é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
                showConnectionStatus('âŒ å›ç­”é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å†å›ç­”ã§ãã‚‹ã‚ˆã†å¾©å¸°
                ai.disabled = false; sb.disabled = false; ai.classList.remove('answered');
            } finally { 
                window._submittingAnswer = false; 
            }
        }

        // æ¡ç‚¹ä¸­ãƒ•ãƒ©ã‚°
        let gradingInFlight = false;
        
        // ãƒ›ã‚¹ãƒˆç”¨æ™‚é–“åˆ‡ã‚Œå¾…ã¡ã‚¿ã‚¤ãƒãƒ¼ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
        let _hostWaitInterval = null;

        // ã‚µãƒ¼ãƒãƒ¼æ™‚åˆ»ãƒ™ãƒ¼ã‚¹æ¡ç‚¹ã¨æ¬¡å•é¡Œã¸ã®é€²è¡Œï¼ˆãƒ›ã‚¹ãƒˆå°‚ç”¨ï¼‰
        async function gradeAndAdvance() {
            if (gradingInFlight) return;
            // ãƒ›ã‚¹ãƒˆãŒä¸åœ¨ or é›¢è„± or æ™‚é–“è¶…éãªã‚‰ä»£è¡Œæ¡ç‚¹ã‚’è¨±å¯
            const hostAlive = gameState.playersCache.some(p => p.role === 'host' && !p.leftAt);
            const elapsedMs = Date.now() - (gameState.questionStartAtMs || 0);
            const timeExpired = elapsedMs > ((gameState.durationSec || 20) + 2) * 1000; // 2ç§’çŒ¶äºˆ
            const canGrade = gameState.isHost || !hostAlive || timeExpired;
            if (!canGrade) return;
            gradingInFlight = true;
            
            try {
                await runTransaction(db, async (transaction) => {
                    const roomRef = doc(db, 'rooms', gameState.roomId);
                    const roomSnap = await transaction.get(roomRef);
                    const roomData = roomSnap.data();
                    const QIDX = roomData.questionIndex ?? 0;
                    
                    // æ¡ç‚¹ã‚ªãƒ¼ãƒŠãƒ¼åˆ¶ã«ã‚ˆã‚‹äºŒé‡å®Ÿè¡Œé˜²æ­¢
                    if (roomData.grading?.inProgress === true) return;
                    
                    transaction.update(roomRef, {
                        grading: { 
                            inProgress: true, 
                            owner: gameState.playerId, 
                            q: QIDX, 
                            at: serverTimestamp() 
                        }
                    });
                    
                    // æ¡ç‚¹å‡¦ç†ï¼ˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¤–ã§å®Ÿè¡Œï¼‰
                    setTimeout(async () => {
                        try {
                            // ã‚ªãƒ¼ãƒŠãƒ¼ç¢ºèª - è‡ªåˆ†ãŒæ¡ç‚¹æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                            const latest = await getDoc(roomRef);
                            const g = latest.data()?.grading;
                            if (!g || !g.inProgress || g.owner !== gameState.playerId || g.q !== QIDX) {
                                return; // è‡ªåˆ†ã®æ¡ç‚¹æ¨©é™ã§ã¯ãªã„
                            }
                            
                            // å›ç­”ãƒ‡ãƒ¼ã‚¿å–å¾—
                            const answersQuery = query(
                                collection(db, 'rooms', gameState.roomId, 'answers'),
                                where('questionIndex', '==', QIDX)
                            );
                            const answersSnap = await getDocs(answersQuery);
                            
                            // ã‚µãƒ¼ãƒãƒ¼æ™‚åˆ»ãƒ™ãƒ¼ã‚¹ã§æ®‹ã‚Šæ™‚é–“ã‚’å†è¨ˆç®—
                            const questionStartMs = roomData.questionStartAt?.toMillis?.() ?? Date.now();
                            const DURATION = roomData.durationSec || 20;
                            
                            const batch = writeBatch(db);
                            answersSnap.forEach(answerDoc => {
                                const answerData = answerDoc.data();
                                const submittedMs = answerData.submittedAt?.toMillis?.() ?? questionStartMs;
                                const elapsed = Math.max(0, Math.floor((submittedMs - questionStartMs) / 1000));
                                const earned = answerData.isCorrect ? Math.max(0, DURATION - elapsed) : 0;
                                
                                if (earned > 0) {
                                    const playerRef = doc(db, 'rooms', gameState.roomId, 'players', answerData.playerId);
                                    batch.update(playerRef, { score: increment(earned) });
                                }
                            });
                            await batch.commit();
                            
                            // æ¬¡ã®å•é¡Œã¸é€²è¡Œï¼†ãƒ­ãƒƒã‚¯è§£é™¤
                            if (QIDX + 1 >= 5) {
                                await updateDoc(roomRef, { 
                                    status: 'ended',
                                    grading: null 
                                });
                            } else {
                                await updateDoc(roomRef, {
                                    questionIndex: QIDX + 1,
                                    questionStartAt: serverTimestamp(),
                                    grading: null
                                });
                            }
                        } catch (error) {
                            console.error('æ¡ç‚¹ã‚¨ãƒ©ãƒ¼:', error);
                            // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ­ãƒƒã‚¯è§£é™¤
                            await updateDoc(roomRef, { grading: null });
                        }
                    }, 100);
                });
            } catch (error) {
                console.error('æ¡ç‚¹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
            } finally {
                gradingInFlight = false;
            }
        }

        // å›ç­”çŠ¶æ³æ›´æ–°
        function updateAnswerStatus(answerDocs) {
            const statusDiv = document.getElementById('playerAnswerStatus');
            if (!statusDiv) return;
            
            statusDiv.innerHTML = '';
            
            // å›ç­”ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼IDã§ãƒãƒƒãƒ—åŒ–
            const answersMap = {};
            answerDocs.forEach(doc => {
                const answerData = doc.data();
                answersMap[answerData.playerId] = answerData;
            });
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã—ã¦IDåŸºæº–ã§å‡¦ç†
            gameState.playersCache.forEach(player => {
                const statusItem = document.createElement('div');
                statusItem.className = 'flex items-center justify-between p-2 rounded-lg text-sm md:text-base';
                
                const answerData = answersMap[player.id];
                
                if (answerData) {
                    statusItem.className += answerData.isCorrect ? ' bg-green-100 border-l-4 border-green-500' : ' bg-red-100 border-l-4 border-red-500';
                    const serverTimeLeft = Math.max(0,
                        (gameState.durationSec || 20)
                        - Math.max(0, Math.floor(
                            ((answerData.submittedAt?.toMillis?.() ?? gameState.questionStartAtMs)
                             - gameState.questionStartAtMs) / 1000
                          ))
                    );
                    
                    statusItem.innerHTML = `
                        <span class="font-semibold">${safe(player.name)}</span>
                        <span class="${answerData.isCorrect ? 'text-green-600' : 'text-red-600'} font-semibold">
                            ${answerData.isCorrect ? 'âœ… æ­£è§£ CORRECT' : 'âŒ ä¸æ­£è§£ WRONG'} (${serverTimeLeft}ç§’)
                        </span>
                    `;
                } else {
                    statusItem.className += ' bg-gray-100 border-l-4 border-gray-400';
                    statusItem.innerHTML = `
                        <span class="font-semibold">${safe(player.name)}</span>
                        <span class="text-gray-500">â³ å›ç­”ä¸­... ANSWERING</span>
                    `;
                }
                
                statusDiv.appendChild(statusItem);
            });
            
            // æ—©æœŸçµ‚äº†ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ›ã‚¹ãƒˆã®ã¿ï¼‰
            if (gameState.isHost) {
                const answeredIds = new Set(answerDocs.map(d => d.data().playerId));
                const activePlayers = gameState.playersCache
                    .filter(p => !p.leftAt) // é€€å‡ºè€…é™¤å¤–
                    .map(p => p.id);
                const allAnswered = activePlayers.length > 0 && activePlayers.every(id => answeredIds.has(id));
                
                if (allAnswered) {
                    // å…¨å“¡å›ç­”æ¸ˆã¿ãªã‚‰å³åº§ã«æ¡ç‚¹
                    setTimeout(() => gradeAndAdvance(), 500);
                }
            }
        }

        // ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰æ›´æ–°
        function updateScoreBoard(playerDocs) {
            const scoreBoard = document.getElementById('scoreBoard');
            if (!scoreBoard) return;
            
            scoreBoard.innerHTML = '';
            
            // ã‚¹ã‚³ã‚¢é †ã«ã‚½ãƒ¼ãƒˆ
            const sortedPlayers = playerDocs
                .map(doc => ({ id: doc.id, ...doc.data() }))
                .sort((a, b) => b.score - a.score);
            
            // ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¹ã‚³ã‚¢ã‚’æ›´æ–°
            const currentPlayer = sortedPlayers.find(p => p.id === gameState.playerId);
            if (currentPlayer) {
                const scoreElement = document.getElementById('currentScore');
                if (scoreElement) {
                    scoreElement.textContent = currentPlayer.score;
                }
            }
            
            sortedPlayers.forEach((player, index) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = `rounded-lg p-3 md:p-4 text-center transition-all duration-300`;
                
                if (index === 0) {
                    playerDiv.className += ' bg-gradient-to-r from-yellow-200 to-yellow-400';
                } else if (index === 1) {
                    playerDiv.className += ' bg-gradient-to-r from-gray-200 to-gray-400';
                } else if (index === 2) {
                    playerDiv.className += ' bg-gradient-to-r from-orange-200 to-orange-400';
                } else {
                    playerDiv.className += ' bg-gradient-to-r from-blue-100 to-purple-100';
                }
                
                playerDiv.innerHTML = `
                    <div class="text-sm md:text-lg font-bold text-gray-800">${safe(player.name)}</div>
                    <div class="text-lg md:text-2xl font-bold text-blue-600">${player.score}ç‚¹</div>
                    <div class="text-xs md:text-sm text-gray-600">${index + 1}ä½</div>
                    ${player.id === gameState.playerId ? '<div class="text-xs text-blue-500">ã‚ãªãŸ</div>' : ''}
                `;
                scoreBoard.appendChild(playerDiv);
            });
        }

        // çµæœè¡¨ç¤º
        function showResults() {
            showScreen('resultScreen');
            
            // æœ€çµ‚çµæœã‚’å–å¾—ã—ã¦è¡¨ç¤º
            const unsubscribe = onSnapshot(
                query(collection(db, 'rooms', gameState.roomId, 'players'), orderBy('score', 'desc')),
                (snapshot) => {
                    const sortedPlayers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    displayFinalResults(sortedPlayers);
                    unsubscribe(); // ä¸€åº¦ã ã‘å®Ÿè¡Œ
                }
            );
        }

        // æœ€çµ‚çµæœè¡¨ç¤º
        function displayFinalResults(sortedPlayers) {
            const resultsDiv = document.getElementById('finalResults');
            resultsDiv.innerHTML = '';
            
            sortedPlayers.forEach((player, index) => {
                const resultDiv = document.createElement('div');
                resultDiv.className = `bg-gradient-to-r rounded-2xl p-4 md:p-6 text-center fade-in`;
                
                let bgClass, medal;
                if (index === 0) {
                    bgClass = 'from-yellow-200 to-yellow-400';
                    medal = 'ğŸ¥‡';
                } else if (index === 1) {
                    bgClass = 'from-gray-200 to-gray-400';
                    medal = 'ğŸ¥ˆ';
                } else if (index === 2) {
                    bgClass = 'from-orange-200 to-orange-400';
                    medal = 'ğŸ¥‰';
                } else {
                    bgClass = 'from-blue-100 to-blue-200';
                    medal = 'ğŸ…';
                }
                
                resultDiv.className += ` ${bgClass}`;
                resultDiv.innerHTML = `
                    <div class="text-3xl md:text-4xl mb-2">${medal}</div>
                    <div class="text-xl md:text-2xl font-bold text-gray-800">${index + 1}ä½: ${safe(player.name)}</div>
                    <div class="text-2xl md:text-3xl font-bold text-blue-600">${player.score}ç‚¹</div>
                    ${player.id === gameState.playerId ? '<div class="text-base md:text-lg text-purple-600 font-semibold">ã‚ãªãŸã®çµæœ</div>' : ''}
                `;
                
                resultsDiv.appendChild(resultDiv);
            });
            
            // 1ä½ã®å ´åˆã¯ç‰¹åˆ¥ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            if (sortedPlayers[0] && sortedPlayers[0].id === gameState.playerId) {
                createConfetti();
            }
        }

        // ç´™å¹é›ªã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        function createConfetti() {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#dda0dd'];
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 3 + 's';
                confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                document.body.appendChild(confetti);
                
                setTimeout(() => {
                    confetti.remove();
                }, 5000);
            }
        }

        // ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        function resetGame() {
            const keepObserver = gameState.isObserver; // é€€é¿
            
            // ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            if (gameState.timer) {
                clearInterval(gameState.timer);
            }
            if (observerTimer) {
                clearInterval(observerTimer);
                observerTimer = null;
            }
            if (_hostWaitInterval) {
                clearInterval(_hostWaitInterval);
                _hostWaitInterval = null;
            }
            
            // Firebaseè³¼èª­ã‚’è§£é™¤
            if (gameState.roomUnsubscribe) {
                gameState.roomUnsubscribe();
                gameState.roomUnsubscribe = null;
            }
            if (gameState.playersUnsubscribe) {
                gameState.playersUnsubscribe();
                gameState.playersUnsubscribe = null;
            }
            if (gameState.answersUnsubscribe) {
                gameState.answersUnsubscribe();
                gameState.answersUnsubscribe = null;
            }
            
            // çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            gameState = {
                roomId: null,
                playerId: null,
                playerName: null,
                isHost: false,
                currentQuestion: 0,
                timeLeft: 20,
                durationSec: 20,
                timer: null,
                questionStartAtMs: null,
                roomUnsubscribe: null,
                playersUnsubscribe: null,
                answersUnsubscribe: null,
                playersCache: [],
                isObserver: keepObserver, // å¾©å…ƒ
                questions: [
                    // æœ€å¤§å…¬ç´„æ•°å•é¡Œ
                    { question: "12ã¨18ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "6" },
                    { question: "24ã¨36ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "12" },
                    { question: "21ã¨28ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "7" },
                    { question: "18ã¨24ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "6" },
                    { question: "16ã¨24ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "8" },
                    { question: "20ã¨30ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "10" },
                    { question: "14ã¨35ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "7" },
                    { question: "27ã¨36ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "9" },
                    { question: "32ã¨48ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "16" },
                    { question: "45ã¨60ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "15" },
                    { question: "25ã¨40ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "5" },
                    { question: "28ã¨42ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "14" },
                    { question: "30ã¨45ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "15" },
                    { question: "12ã¨20ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "4" },
                    { question: "36ã¨54ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "18" },
                    { question: "40ã¨56ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "8" },
                    { question: "9ã¨15ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "3" },
                    { question: "48ã¨60ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "12" },
                    { question: "33ã¨44ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "11" },
                    { question: "35ã¨49ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "7" },
                    { question: "24ã¨40ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "8" },
                    { question: "42ã¨63ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "21" },
                    { question: "18ã¨27ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "9" },
                    { question: "50ã¨65ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "5" },
                    { question: "12ã¨15ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "3" },
                    { question: "8ã€12ã€20ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "4" },
                    { question: "18ã€30ã€42ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "6" },
                    { question: "16ã€20ã€24ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "4" },
                    { question: "6ã€9ã€15ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "3" },
                    { question: "14ã€21ã€28ã®æœ€å¤§å…¬ç´„æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "7" },
                    
                    // æœ€å°å…¬å€æ•°å•é¡Œ
                    { question: "2ã¨3ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "6" },
                    { question: "3ã¨5ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "15" },
                    { question: "4ã¨6ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "12" },
                    { question: "6ã¨8ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "24" },
                    { question: "7ã¨9ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "63" },
                    { question: "8ã¨9ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "72" },
                    { question: "4ã¨9ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "36" },
                    { question: "5ã¨6ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "30" },
                    { question: "6ã¨7ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "42" },
                    { question: "5ã¨8ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "40" },
                    { question: "3ã¨6ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "6" },
                    { question: "2ã¨8ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "8" },
                    { question: "3ã¨9ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "9" },
                    { question: "4ã¨8ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "8" },
                    { question: "2ã¨4ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "4" },
                    { question: "5ã¨7ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "35" },
                    { question: "2ã¨5ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "10" },
                    { question: "6ã¨9ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "18" },
                    { question: "7ã¨8ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "56" },
                    { question: "2ã¨7ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "14" },
                    { question: "3ã¨7ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "21" },
                    { question: "4ã¨7ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "28" },
                    { question: "5ã¨9ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "45" },
                    { question: "3ã¨4ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "12" },
                    { question: "12ã¨18ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "36" },
                    { question: "8ã¨20ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "40" },
                    { question: "14ã¨35ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "70" },
                    { question: "2ã€3ã€4ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "12" },
                    { question: "2ã€3ã€5ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "30" },
                    { question: "3ã€4ã€6ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "12" },
                    { question: "4ã€6ã€8ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "24" },
                    { question: "3ã€5ã€9ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "45" },
                    { question: "4ã€5ã€8ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "40" },
                    { question: "6ã€8ã€12ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "24" },
                    { question: "15ã€20ã€30ã®æœ€å°å…¬å€æ•°ã‚’æ±‚ã‚ãªã•ã„ã€‚", answer: "60" }
                ]
            };
        }

        // IMEç¢ºå®šå‰Enterèª¤é€ä¿¡é˜²æ­¢ã¨ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆ
        document.addEventListener('DOMContentLoaded', function() {
            const answerInput = document.getElementById('answerInput');
            if (answerInput) {
                let composing = false;
                
                answerInput.addEventListener('compositionstart', () => composing = true);
                answerInput.addEventListener('compositionend', () => composing = false);
                answerInput.addEventListener('keydown', e => { 
                    if (e.key === 'Enter' && !composing) {
                        window.submitAnswer();
                    }
                });
                answerInput.addEventListener('input', () => {
                    // å…¨è§’â†’åŠè§’ã®ã†ãˆã§æ•°å­—ä»¥å¤–ã¯å‰Šé™¤
                    const normalized = normalizeNum(answerInput.value).replace(/[^0-9]/g, '');
                    if (answerInput.value !== normalized) answerInput.value = normalized;
                });
            }

            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒˆã‚°ãƒ«æ©Ÿèƒ½ï¼ˆä½œæˆç”»é¢ï¼‰
            const usePasswordToggle = document.getElementById('usePasswordToggle');
            const createPassword = document.getElementById('createPassword');
            if (usePasswordToggle && createPassword) {
                usePasswordToggle.addEventListener('change', function() {
                    if (this.checked) {
                        createPassword.disabled = false;
                        createPassword.classList.remove('opacity-50');
                        createPassword.focus();
                    } else {
                        createPassword.disabled = true;
                        createPassword.classList.add('opacity-50');
                        createPassword.value = '';
                    }
                });
            }

            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒˆã‚°ãƒ«æ©Ÿèƒ½ï¼ˆå‚åŠ ç”»é¢ï¼‰
            const joinUsePasswordToggle = document.getElementById('joinUsePasswordToggle');
            const joinPassword = document.getElementById('joinPassword');
            if (joinUsePasswordToggle && joinPassword) {
                joinUsePasswordToggle.addEventListener('change', function() {
                    if (this.checked) {
                        joinPassword.disabled = false;
                        joinPassword.classList.remove('opacity-50');
                        joinPassword.focus();
                    } else {
                        joinPassword.disabled = true;
                        joinPassword.classList.add('opacity-50');
                        joinPassword.value = '';
                    }
                });
            }

            // æ‹›å¾…ãƒªãƒ³ã‚¯ã‹ã‚‰ã®è‡ªå‹•å…¥åŠ›
            if (inviteRoomId && !isObserverMode) {
                const joinRoomIdInput = document.getElementById('joinRoomId');
                if (joinRoomIdInput) {
                    joinRoomIdInput.value = inviteRoomId.toUpperCase();
                    // å‚åŠ ç”»é¢ã‚’è¡¨ç¤º
                    setTimeout(() => {
                        showScreen('roomJoinScreen');
                        showConnectionStatus('ğŸ”— æ‹›å¾…ãƒªãƒ³ã‚¯ã‹ã‚‰éƒ¨å±‹IDã‚’è¨­å®šã—ã¾ã—ãŸ');
                    }, 100);
                }
            }

            // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³/ã‚ªãƒ•ãƒ©ã‚¤ãƒ³é€šçŸ¥
            window.addEventListener('offline', () => showConnectionStatus('âš ï¸ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã«ãªã‚Šã¾ã—ãŸ', true));
            window.addEventListener('online',  () => showConnectionStatus('âœ… ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«å¾©å¸°ã—ã¾ã—ãŸ'));
        });

        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', async () => {
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é€€å‡ºè¨˜éŒ²
            if (gameState.roomId && gameState.playerId) {
                try {
                    await updateDoc(doc(db, 'rooms', gameState.roomId, 'players', gameState.playerId), {
                        leftAt: serverTimestamp()
                    });
                } catch (error) {
                    console.error('é€€å‡ºè¨˜éŒ²ã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            resetGame();
        });

    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'978ff54f15d88d21',t:'MTc1Njg0NzA1MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

