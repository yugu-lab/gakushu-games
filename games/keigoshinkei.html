<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç¥çµŒè¡°å¼±ã§æ•¬èªã‚’è¦šãˆã‚ˆã†ï¼ï¼</title>
  <style>
    :root{ --accent:#38bdf8; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:'Hiragino Sans','Yu Gothic','Segoe UI',sans-serif; background:linear-gradient(135deg,#0f172a,#1e293b); color:#e5e7eb; display:flex; flex-direction:column; align-items:center; min-height:100svh; padding:20px; overflow-x:hidden; }
    h1{ font-size:2rem; color:var(--accent); margin:0 0 16px; text-shadow:0 0 10px rgba(56,189,248,.5);}    

    /* å…±é€šãƒœã‚¿ãƒ³ */
    .btn{ appearance:none; border:none; cursor:pointer; border-radius:999px; padding:12px 20px; font-weight:800; }
    .btn-primary{ background:#38bdf8; color:#0b1220; }
    .btn-ghost{ background:transparent; color:#e5e7eb; border:2px solid rgba(229,231,235,.25); }
    .btn-row{ display:flex; gap:12px; justify-content:center; align-items:center; margin-top:14px; }

    /* ã‚¹ã‚¿ãƒ¼ãƒˆ & ã‚²ãƒ¼ãƒ ç”»é¢ */
    #start, #game{ width:100%; max-width:1600px; }
    #game{ display:none; }

    /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ï¼ˆã‚ãã‚ããƒãƒƒãƒ—ï¼‰ */
    .panel{ background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.12); border-radius:18px; padding:18px; position:relative; overflow:hidden; }
    .rules{ line-height:1.7; color:#cbd5e1; }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    label{ font-size:.98rem; font-weight:900; color:#e2e8f0; }
    input, select{ padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.2); background:#0b1220; color:#e5e7eb; font-size:1rem; }

    .blob{ position:absolute; border-radius:50%; filter:blur(8px); opacity:.45; pointer-events:none; }
    .blob.yellow{ width:280px; height:280px; right:-60px; top:-40px; background:radial-gradient(closest-side,#fde68a,transparent 70%);} 
    .blob.blue{ width:320px; height:320px; left:-40px; bottom:-60px; background:radial-gradient(closest-side,#93c5fd,transparent 70%);} 

    .lead{ display:flex; align-items:center; gap:12px; margin-bottom:10px; }
    .lead-emoji{ font-size:28px; }
    .lead-title{ font-size:1.2rem; font-weight:900; letter-spacing:.5px; }
    small.note{ color:#cbd5e1; opacity:.9; margin-top:6px; display:block; }

    /* ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ï¼ˆåºƒãä½¿ã†ï¼‰ */
    .mode-field{ grid-column:1/-1; }
    .mode-select{ display:flex; gap:16px; flex-wrap:wrap; width:100%; }
    .mode-btn{ padding:14px 24px; border-radius:999px; border:2px solid rgba(229,231,235,.25); background:transparent; color:#e5e7eb; font-weight:900; cursor:pointer; display:inline-flex; align-items:center; gap:8px; font-size:1.06rem; }
    .mode-btn small{ opacity:.85; font-weight:700; }
    .mode-btn.active{ background:#38bdf8; color:#0b1220; border-color:transparent; }

    /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ± */
    .players{ width:100%; display:flex; gap:10px; justify-content:center; align-items:stretch; margin:10px 0 6px; }
    .player{ flex:1; min-width:0; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:10px; display:flex; align-items:center; gap:10px; }
    .player.active{ outline:3px solid var(--accent); box-shadow:0 0 0 4px rgba(56,189,248,.18) inset; }
    .avatar{ width:32px; height:32px; border-radius:50%; background:linear-gradient(135deg,#64748b,#334155); display:grid; place-items:center; font-weight:800; }
    .pname{ font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .pscore{ margin-left:auto; font-weight:900; color:#f8fafc; }

    /* ã‚¿ã‚¤ãƒãƒ¼ï¼ˆä¸€äººãƒ¢ãƒ¼ãƒ‰ã®ã¿è¡¨ç¤ºï¼‰ */
    .timerbar{ display:none; width:100%; justify-content:center; align-items:center; gap:10px; margin:4px 0 10px; }
    .timerbar span{ opacity:.9; font-weight:900; }
    .timer{ background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:6px 12px; font-weight:900; color:#e5e7eb; font-variant-numeric:tabular-nums; letter-spacing:.5px; }

    /* ç›¤é¢ï¼ˆå·¦å³3x4, ä»•åˆ‡ã‚Šï¼‰ */
    .board-wrapper{ display:grid; grid-template-columns:1fr 4px 1fr; gap:20px; width:100%; align-items:start; }
    .divider{ width:4px; height:100%; background:var(--accent); border-radius:2px; }
    .column{ display:grid; grid-template-rows:repeat(3,1fr); grid-template-columns:repeat(4,1fr); gap:16px; }

    /* ================= ã‚«ãƒ¼ãƒ‰ï¼ˆæ–°ã—ã„è¦‹ãŸç›® & ä¸­å¤®é…ç½®ï¼‰ ================= */
    .card{ width:100%; aspect-ratio:3/4; border-radius:16px; cursor:pointer; perspective:1000px; overflow:visible; box-shadow:0 8px 20px rgba(0,0,0,.28);} 
    .card.cleared{ visibility:hidden; pointer-events:none; }

    .card-inner{ position:relative; width:100%; height:100%; transform-style:preserve-3d; transition:transform .6s; }
    .flipped .card-inner{ transform:rotateY(180deg); }

    .card-front, .card-back{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      text-align:center; padding:10px 12px;
      background:#ffffff; color:#0f172a;
      border-radius:16px; border:3px solid rgba(15,23,42,.25);
      box-shadow: 0 8px 20px rgba(0,0,0,.12), 0 0 0 1px rgba(255,255,255,.06) inset;
      font-weight:900; font-size:clamp(12px,1.25vw,20px); line-height:1.2;
      backface-visibility:hidden;
      white-space:pre-line; word-break:keep-all;
    }

    /* é¢ã®å‘ã */
    .card-front{ transform:none; }
    .card-back { transform:rotateY(180deg); }

    /* å·¦åˆ—/å³åˆ—ã®ã‚¢ã‚¯ã‚»ãƒ³ãƒˆæ ï¼ˆfrontã«è‰²ã‚¯ãƒ©ã‚¹ãŒä»˜ãï¼‰ */
    .front-normal{ box-shadow: 0 8px 20px rgba(0,0,0,.12), 0 0 0 6px #f43f5e inset; }
    .front-keigo { box-shadow: 0 8px 20px rgba(0,0,0,.12), 0 0 0 6px #22c55e inset; }

    .labels{ display:flex; justify-content:space-between; width:100%; margin-top:10px; font-size:14px; font-weight:700; color:#cbd5e1; }

    /* ä¾‹æ–‡ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
    .popup{ position:fixed; inset:50% auto auto 50%; transform:translate(-50%,-50%) scale(.8); background:#fff0f6; color:#111827; padding:18px 24px; border-radius:18px; border:3px solid #fb7185; box-shadow:0 16px 40px rgba(0,0,0,.4); font-size:15px; font-weight:800; text-align:center; white-space:pre-line; z-index:1000; opacity:0; transition:transform .28s ease, opacity .28s ease; pointer-events:none; }
    .popup.show{ transform:translate(-50%,-50%) scale(1); opacity:1; pointer-events:auto; }

    /* ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° / çµ‚äº†ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
    .overlay{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); z-index:1200; }
    .overlay.show{ display:grid; }
    .dialog{ background:#0b1220; color:#e5e7eb; padding:20px; border-radius:16px; border:1px solid rgba(255,255,255,.12); min-width:300px; max-width:90vw; text-align:center; }
    .dialog h3{ margin:0 0 10px; font-size:1.1rem; color:#e2e8f0; }
    .rank-list{ list-style:none; padding:0; margin:8px 0 0; text-align:left; }
    .rank-list li{ padding:6px 10px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:10px; margin:6px 0; font-weight:800; display:flex; justify-content:space-between; }

    /* ãƒ•ãƒƒã‚¿ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
    .footer-actions{ width:100%; display:flex; justify-content:center; gap:10px; margin-top:16px; }
  </style>
</head>
<body>
  <h1>ç¥çµŒè¡°å¼±ã§æ•¬èªã‚’è¦šãˆã‚ˆã†ï¼ï¼</h1>

  <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
  <section id="start" class="panel">
    <div class="blob yellow" aria-hidden="true"></div>
    <div class="blob blue"   aria-hidden="true"></div>

    <div class="lead">
      <div class="lead-emoji">ğŸ´âœ¨</div>
      <div>
        <div class="lead-title">æ¥½ã—ã¿ãªãŒã‚‰æ•¬èªã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã‚ˆã†</div>
        <div class="rules">å·¦ã¯ <b>å¸¸ä½“</b>ã€å³ã¯ <b>æ•¬èªè¡¨ç¾</b>ã€‚åŒã˜ãƒšã‚¢ã‚’è¦‹ã¤ã‘ã¦ãƒã‚¤ãƒ³ãƒˆã‚²ãƒƒãƒˆï¼</div>
      </div>
    </div>

    <div class="grid2" style="align-items:start;">
      <div class="field">
        <label>ãƒ—ãƒ¬ã‚¤äººæ•°ï¼ˆ1ã€œ4äººï¼‰</label>
        <select id="count">
          <option value="1">1äºº</option>
          <option value="2">2äºº</option>
          <option value="3">3äºº</option>
          <option value="4">4äºº</option>
        </select>
        <small class="note">äººæ•°ã‚’é¸ã¶ã¨ä¸‹ã®åå‰æ¬„ãŒè‡ªå‹•ã§å‡ºã¾ã™ã€‚</small>
      </div>

      <div class="field">
        <label>åå‰ã‚’ã„ã‚Œã‚ˆã†</label>
        <div class="grid2" id="nameFields" style="grid-template-columns:1fr 1fr; gap:8px;"></div>
        <small class="note">ãã®ã¾ã¾ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆã§ã‚‚OK</small>
      </div>
    </div>

    <div class="grid2" style="margin-top:12px;">
      <div class="field mode-field">
        <label>ãƒ¢ãƒ¼ãƒ‰</label>
        <div class="mode-select" id="modeSelect">
          <button class="mode-btn active" data-mode="normal">Normal</button>
          <button class="mode-btn" data-mode="easy">Easy <small>ï¼ˆã‚«ãƒ¼ãƒ‰ãŒæœ€åˆã‹ã‚‰å…¨éƒ¨ã‚ªãƒ¼ãƒ—ãƒ³ï¼‰</small></button>
        </div>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-primary" id="startBtn" style="display:inline-flex; align-items:center; gap:8px;">
        <span>ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆï¼</span><span>â–¶ï¸</span>
      </button>
    </div>
  </section>

  <!-- ã‚²ãƒ¼ãƒ ç”»é¢ï¼ˆåŒä¸€HTMLå†…ã§åˆ‡æ›¿ï¼‰ -->
  <section id="game">
    <div class="players" id="players"></div>
    <div class="timerbar" id="timerBar"><span>TIME</span><div class="timer" id="timer">00:00.0</div></div>
    <div class="board-wrapper">
      <div class="column" id="left"></div>
      <div class="divider"></div>
      <div class="column" id="right"></div>
    </div>
    <div class="labels">
      <div>å¸¸ä½“</div>
      <div>æ•¬èªè¡¨ç¾</div>
    </div>
    <div class="footer-actions">
      <button class="btn btn-ghost" id="backBtn">æœ€åˆã«æˆ»ã‚‹</button>
      <button class="btn btn-primary" id="replayBtn" style="display:none;">ã‚‚ã†ä¸€åº¦éŠã¶</button>
    </div>
  </section>

  <!-- ä¾‹æ–‡ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
  <div class="popup" id="popup"></div>

  <!-- ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° / çµ‚äº†ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
  <div class="overlay" id="confirmOverlay">
    <div class="dialog">
      <h3>æœ¬å½“ã«ã‚„ã‚ã¾ã™ã‹ï¼Ÿ</h3>
      <div class="btn-row" style="margin-top:8px;">
        <button class="btn btn-primary" id="confirmYes">ã¯ã„</button>
        <button class="btn btn-ghost" id="confirmNo">ã„ã„ãˆ</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="rankOverlay">
    <div class="dialog" id="rankDialog">
      <h3>é †ä½ç™ºè¡¨</h3>
      <ol class="rank-list" id="rankList"></ol>
      <div class="btn-row" style="margin-top:10px;">
        <button class="btn btn-primary" id="rankReplay">ã‚‚ã†ä¸€åº¦éŠã¶</button>
        <button class="btn btn-ghost" id="rankBack">æœ€åˆã«æˆ»ã‚‹</button>
      </div>
    </div>
  </div>

  <script>
    // ====== ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ï¼šäººæ•°ã«å¿œã˜ã¦åå‰æ¬„ã‚’ç”Ÿæˆ ======
    const countSel = document.getElementById('count');
    const nameWrap = document.getElementById('nameFields');
    const startSec = document.getElementById('start');
    const gameSec  = document.getElementById('game');
    const startBtn = document.getElementById('startBtn');
    const modeSelect = document.getElementById('modeSelect');
    let gameMode = 'normal';

    function renderNameInputs(){
      const n = parseInt(countSel.value, 10);
      nameWrap.innerHTML = '';
      for(let i=1; i<=n; i++){
        const input = document.createElement('input');
        input.id = `n${i}`;
        input.value = `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i}`;
        input.addEventListener('focus', e => e.target.select());
        input.addEventListener('mouseup', e => e.preventDefault());
        nameWrap.appendChild(input);
      }
    }
    countSel.addEventListener('change', renderNameInputs);
    renderNameInputs();

    // ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®åˆ‡æ›¿
    modeSelect.addEventListener('click', (e)=>{
      const btn = e.target.closest('.mode-btn');
      if(!btn) return;
      document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      gameMode = btn.dataset.mode; // 'normal' | 'easy'
    });

    startBtn.addEventListener('click', ()=>{
      const n = parseInt(countSel.value,10);
      const names = [];
      for(let i=1;i<=n;i++){
        const v = (document.getElementById(`n${i}`).value || '').trim();
        names.push(v || `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i}`);
      }
      sessionStorage.setItem('keigo_memory_playerCount', String(n));
      sessionStorage.setItem('keigo_memory_playerNames', JSON.stringify(names));
      sessionStorage.setItem('keigo_memory_mode', gameMode);
      startGame(n, names);
      startSec.style.display='none';
      gameSec.style.display='block';
    });

    // ====== ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ ======
    const pairs = [
      {front:`è¨€ã†
(å°Šæ•¬èª)`, back:`ãŠã£ã—ã‚ƒã‚‹`, example:`å…ˆç”Ÿã®ãŠã£ã—ã‚ƒã‚‹é€šã‚Šã§ã™ã€‚`},
      {front:`è¡Œã
(å°Šæ•¬èª)`, back:`ã„ã‚‰ã£ã—ã‚ƒã‚‹
ãŠã„ã§ã«ãªã‚‹
ãŠè¶Šã—ã«ãªã‚‹`, example:`å…ˆç”ŸãŒæ±äº¬ã«ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã™ã€‚`},
      {front:`ã™ã‚‹
(å°Šæ•¬èª)`, back:`ãªã•ã‚‹`, example:`å…ˆç”Ÿã¯ç ”ç©¶ã‚’ãªã•ã£ã¦ã„ã¾ã™ã€‚`},
      {front:`è¦‹ã‚‹
(å°Šæ•¬èª)`, back:`ã”è¦§ã«ãªã‚‹`, example:`å…ˆç”ŸãŒä½œå“ã‚’ã”è¦§ã«ãªã‚Šã¾ã™ã€‚`},
      {front:`èã
(å°Šæ•¬èª)`, back:`ãŠèãã«ãªã‚‹`, example:`å…ˆç”ŸãŒè¬›ç¾©ã‚’ãŠèãã«ãªã‚Šã¾ã™ã€‚`},
      {front:`é£Ÿã¹ã‚‹
(å°Šæ•¬èª)`, back:`å¬ã—ä¸ŠãŒã‚‹`, example:`å…ˆç”ŸãŒã‚±ãƒ¼ã‚­ã‚’å¬ã—ä¸ŠãŒã‚Šã¾ã™ã€‚`},

      {front:`è¨€ã†
(è¬™è­²èª)`, back:`ç”³ã™
ç”³ã—ä¸Šã’ã‚‹`, example:`ç§ã¯å±±ç”°ã¨ç”³ã—ã¾ã™ã€‚
ã”æˆåŠŸã‚’ãŠç¥ˆã‚Šç”³ã—ä¸Šã’ã¾ã™ã€‚`},
      {front:`è¡Œã
(è¬™è­²èª)`, back:`å‚ã‚‹
ä¼ºã†`, example:`æ˜æ—¥ã€ã”è‡ªå®…ã«ä¼ºã„ã¾ã™ã€‚`},
      {front:`ã™ã‚‹
(è¬™è­²èª)`, back:`ã„ãŸã™`, example:`æº–å‚™ã‚’ã„ãŸã—ã¾ã—ãŸã€‚`},
      {front:`è¦‹ã‚‹
(è¬™è­²èª)`, back:`æ‹è¦‹ã™ã‚‹`, example:`ãƒ¬ãƒãƒ¼ãƒˆã‚’æ‹è¦‹ã—ã¾ã™ã€‚`},
      {front:`èã
(è¬™è­²èª)`, back:`ä¼ºã†
æ‹è´ã™ã‚‹`, example:`ãŠè©±ã‚’ä¼ºã„ã¾ã™ã€‚
è¬›æ¼”ã‚’æ‹è´ã—ã¾ã—ãŸã€‚`},
      {front:`é£Ÿã¹ã‚‹
(è¬™è­²èª)`, back:`ã„ãŸã ã`, example:`ãŠè“å­ã‚’ã„ãŸã ãã¾ã™ã€‚`}
    ];

    // ====== ã‚²ãƒ¼ãƒ æœ¬ä½“ ======
    const playersEl = document.getElementById('players');
    const leftEl = document.getElementById('left');
    const rightEl = document.getElementById('right');
    const popup = document.getElementById('popup');
    const backBtn = document.getElementById('backBtn');
    const replayBtn = document.getElementById('replayBtn');
    const confirmOverlay = document.getElementById('confirmOverlay');
    const rankOverlay = document.getElementById('rankOverlay');
    const rankList = document.getElementById('rankList');
    const rankReplay = document.getElementById('rankReplay');
    const rankBack = document.getElementById('rankBack');
    const timerBar = document.getElementById('timerBar');
    const timerEl = document.getElementById('timer');

    let playerCount=1; let players=[]; let turn=0; let flipped=[];
    let timerInt=null, timerStart=0, timerRunning=false, elapsedMs=0;

    function renderPlayers(){
      playersEl.innerHTML = '';
      players.forEach((p,i)=>{
        const wrap = document.createElement('div');
        wrap.className = 'player' + (i===turn? ' active':'');
        wrap.dataset.id = String(p.id);
        wrap.innerHTML = `
          <div class="avatar">${i+1}</div>
          <div class="pname">${p.name}</div>
          <div class="pscore">${p.score}æš</div>
        `;
        playersEl.appendChild(wrap);
      })
    }

    function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }

    function mountCards(){
      leftEl.innerHTML=''; rightEl.innerHTML='';
      const all=[]; pairs.forEach(p=>{ all.push({text:p.front, side:'front', pair:p, colorClass:'front-normal'}); all.push({text:p.back, side:'back', pair:p, colorClass:'front-keigo'}); });
      const leftCards = shuffle(all.filter(c=>c.side==='front'));
      const rightCards= shuffle(all.filter(c=>c.side==='back'));
      const makeCard=(c)=>{
        const el=document.createElement('div'); el.className='card';
        const frontContent = (gameMode==='easy') ? c.text : '?';
        el.innerHTML=`<div class="card-inner">
          <div class="card-front ${c.colorClass}">${frontContent}</div>
          <div class="card-back"><div class="ans">${c.text}</div></div>
        </div>`;
        el.addEventListener('click',()=>flipCard(el,c));
        return el;
      };
      leftCards.forEach(c=> leftEl.appendChild(makeCard(c)));
      rightCards.forEach(c=> rightEl.appendChild(makeCard(c)));
    }

    function startGame(count, names){
      playerCount = count; turn=0; flipped=[];
      players = names.map((n,i)=>({ id:i, name:n, score:0 }));
      renderPlayers();
      mountCards();
      replayBtn.style.display='none';
      if(playerCount===1){ timerBar.style.display='flex'; resetTimer(); } else { timerBar.style.display='none'; stopTimer(); }
    }

    function flipCard(el,c){
      if(el.classList.contains('flipped') || el.classList.contains('cleared') || flipped.length===2) return;
      if(playerCount===1 && !timerRunning){ startTimer(); }
      el.classList.add('flipped');
      flipped.push({el,c});
      if(flipped.length===2){ setTimeout(checkMatch, 650); }
    }

    function nextTurn(){ if(playerCount>1){ turn=(turn+1)%playerCount; renderPlayers(); } }

    function checkGameEnd(){
      const total = document.querySelectorAll('.card').length;
      const cleared = document.querySelectorAll('.card.cleared').length;
      if(cleared===total){
        if(playerCount===1) stopTimer();
        const ranking = players.map(p=>({name:p.name,score:p.score}))
                               .sort((a,b)=> b.score - a.score);
        rankList.innerHTML='';
        if(playerCount===1){
          const liT=document.createElement('li');
          liT.innerHTML = `<span>â±ï¸ ã‚¿ã‚¤ãƒ </span><span>${formatTime(elapsedMs)}</span>`;
          rankList.appendChild(liT);
        }
        ranking.forEach((r,idx)=>{
          const li=document.createElement('li');
          li.innerHTML = `<span>${(playerCount>1? ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','ğŸ–ï¸'][idx]||'ãƒ»':'ğŸ‘¤')} ${r.name}</span><span>${r.score} ãƒšã‚¢</span>`;
          rankList.appendChild(li);
        });
        rankOverlay.classList.add('show');
        replayBtn.style.display='inline-flex';
      }
    }

    function checkMatch(){
      const [a,b]=flipped; if(!a||!b) return;
      if(a.c.pair===b.c.pair && a.c.side!==b.c.side){
        showPopup(a.c.pair.example);
        players[turn].score += 1; renderPlayers();
        a.el.classList.add('cleared'); b.el.classList.add('cleared');
        checkGameEnd();
      }else{
        a.el.classList.remove('flipped'); b.el.classList.remove('flipped'); nextTurn();
      }
      flipped=[];
    }

    // ä¾‹æ–‡ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
    function showPopup(text){ popup.textContent=text; popup.classList.add('show'); setTimeout(()=>popup.classList.remove('show'), 2000); }

    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ï¼šã‚¿ã‚¤ãƒãƒ¼
    function resetTimer(){ elapsedMs=0; timerEl.textContent='00:00.0'; timerRunning=false; if(timerInt){clearInterval(timerInt); timerInt=null;} }
    function startTimer(){ if(timerRunning) return; timerRunning=true; timerStart=Date.now(); timerInt=setInterval(()=>{ elapsedMs=Date.now()-timerStart; timerEl.textContent = formatTime(elapsedMs); }, 100); }
    function stopTimer(){ if(timerInt){ clearInterval(timerInt); timerInt=null; } timerRunning=false; }
    function formatTime(ms){ const t=Math.floor(ms/100); const ds=t%10; const s=Math.floor(t/10)%60; const m=Math.floor(t/600); const pad=n=>String(n).padStart(2,'0'); return `${pad(m)}:${pad(s)}.${ds}`; }

    // ã€Œæœ€åˆã«æˆ»ã‚‹ã€ç¢ºèª
    backBtn.addEventListener('click',()=> confirmOverlay.classList.add('show'));
    document.getElementById('confirmYes').addEventListener('click',()=>{
      confirmOverlay.classList.remove('show');
      gameSec.style.display='none'; startSec.style.display='block';
    });
    document.getElementById('confirmNo').addEventListener('click',()=> confirmOverlay.classList.remove('show'));

    // ãƒªãƒ—ãƒ¬ã‚¤ï¼ˆã‚²ãƒ¼ãƒ å†…ãƒœã‚¿ãƒ³ï¼‰
    replayBtn.addEventListener('click',()=>{
      mountCards(); flipped=[]; turn=0; players.forEach(p=>p.score=0); renderPlayers(); rankOverlay.classList.remove('show'); replayBtn.style.display='none'; resetTimer(); if(playerCount===1){ timerBar.style.display='flex'; }
    });

    // çµ‚äº†ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ãƒœã‚¿ãƒ³
    rankReplay.addEventListener('click',()=>{ replayBtn.click(); });
    rankBack.addEventListener('click',()=>{
      rankOverlay.classList.remove('show');
      gameSec.style.display='none'; startSec.style.display='block';
    });

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ã®è‡ªå‹•å¾©å…ƒï¼ˆä»»æ„ï¼‰
    (function autoLoad(){
      const countSS = parseInt(sessionStorage.getItem('keigo_memory_playerCount')||'');
      const namesSS = JSON.parse(sessionStorage.getItem('keigo_memory_playerNames')||'[]');
      const modeSS = sessionStorage.getItem('keigo_memory_mode')||'normal';
      if(countSS){ countSel.value = String(countSS); renderNameInputs(); }
      if(namesSS.length){ namesSS.forEach((name,i)=>{ const el=document.getElementById(`n${i+1}`); if(el) el.value=name; }); }
      if(modeSS){
        gameMode = modeSS;
        document.querySelectorAll('.mode-btn').forEach(b=>{
          b.classList.toggle('active', b.dataset.mode===gameMode);
        });
      }
    })();
  </script>
</body>
</html>
