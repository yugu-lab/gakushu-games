<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>æœ€å¤§å…¬ç´„æ•°ãƒãƒˆãƒ«ï¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');
        
        :root {
            --safe-top: env(safe-area-inset-top);
            --safe-right: env(safe-area-inset-right);
            --safe-bottom: env(safe-area-inset-bottom);
            --safe-left: env(safe-area-inset-left);
        }
        
        html, body { 
            height: 100%; 
            font-family: 'Nunito', sans-serif;
        }
        
        body {
            padding: max(10px, var(--safe-top)) max(10px, var(--safe-right))
                     max(10px, var(--safe-bottom)) max(10px, var(--safe-left));
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        
        .card {
            transition: all 0.3s ease;
            transform-style: preserve-3d;
        }
        
        .card:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        .card.selected {
            transform: translateY(-12px) scale(1.1);
            box-shadow: 0 25px 50px rgba(59, 130, 246, 0.4);
        }
        
        .popup {
            animation: popupBounce 0.6s ease-out;
        }
        
        @keyframes popupBounce {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(-10deg); opacity: 0.8; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        
        .damage-animation {
            animation: damageShake 0.5s ease-in-out;
        }
        
        @keyframes damageShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .hp-bar {
            transition: width 0.8s ease-out;
        }
        
        .number-button {
            transition: all 0.2s ease;
        }
        
        .number-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        
        .number-button:active {
            transform: scale(0.95);
        }
        
        .celebration {
            animation: celebrate 1s ease-out;
        }
        
        @keyframes celebrate {
            0% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.2) rotate(5deg); }
            50% { transform: scale(1.1) rotate(-5deg); }
            75% { transform: scale(1.15) rotate(3deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        
        .wrong-answer {
            animation: wrongShake 0.6s ease-in-out;
        }
        
        @keyframes wrongShake {
            0%, 100% { transform: translateX(0) scale(1); }
            20% { transform: translateX(-15px) scale(1.05); }
            40% { transform: translateX(15px) scale(0.95); }
            60% { transform: translateX(-10px) scale(1.05); }
            80% { transform: translateX(10px) scale(0.95); }
        }
        
        .sparkle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: gold;
            border-radius: 50%;
            animation: sparkleAnim 1s ease-out forwards;
        }
        
        @keyframes sparkleAnim {
            0% { transform: scale(0) rotate(0deg); opacity: 1; }
            50% { transform: scale(1) rotate(180deg); opacity: 0.8; }
            100% { transform: scale(0) rotate(360deg); opacity: 0; }
        }
        
        .big-damage {
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            z-index: 1000 !important;
            font-size: 4rem !important;
            color: #dc2626 !important;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            animation: bigDamageText 2s ease-out;
            pointer-events: none;
            text-align: center;
            line-height: 1.2;
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem 3rem;
            border-radius: 2rem;
            border: 4px solid #dc2626;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        @keyframes bigDamageText {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-180deg); opacity: 0; }
            30% { transform: translate(-50%, -50%) scale(1.5) rotate(10deg); opacity: 1; }
            60% { transform: translate(-50%, -50%) scale(1.2) rotate(-5deg); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 1; }
        }
        
        .input-display-base {
            font-size: 4rem !important;
            font-weight: 900 !important;
            color: #7c3aed !important;
            text-shadow: 4px 4px 8px rgba(0,0,0,0.4);
        }
        
        .input-pulse {
            animation: inputPulse 0.3s ease-out;
        }
        
        @keyframes inputPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }
        
        .fullscreen-celebration {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 999 !important;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 215, 0, 0.1);
            animation: fullscreenCelebrate 2s ease-out;
        }
        
        @keyframes fullscreenCelebrate {
            0% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 0; transform: scale(1); }
        }
        
        .mega-sparkle {
            position: absolute;
            width: 20px;
            height: 20px;
            background: linear-gradient(45deg, gold, orange);
            border-radius: 50%;
            animation: megaSparkleAnim 2s ease-out forwards;
        }
        
        @keyframes megaSparkleAnim {
            0% { transform: scale(0) rotate(0deg); opacity: 1; }
            50% { transform: scale(2) rotate(180deg); opacity: 0.8; }
            100% { transform: scale(0) rotate(360deg); opacity: 0; }
        }
        
        /* ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼å°‚ç”¨ï¼ˆè¦–è¦šçš„ã«éš ã™ï¼‰ */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* å‹•ããŒè‹¦æ‰‹ãªå­å‘ã‘ï¼çœé›»åŠ› */
        @media (prefers-reduced-motion: reduce){
            * { animation: none !important; transition: none !important; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-400 via-pink-400 to-blue-400 min-h-[100dvh]">
    <!-- ç¸¦å‘ãæ™‚ã®èª˜å°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="rotateOverlay" class="fixed inset-0 bg-black/70 text-white hidden items-center justify-center text-center p-8 z-[1000]">
        <div>
            <div class="text-4xl font-extrabold mb-4">ğŸ“± ç”»é¢ã‚’æ¨ªå‘ãã«ã—ã¦ã­</div>
            <div class="text-lg opacity-80">iPadã‚’æ¨ªã«å›è»¢ã™ã‚‹ã¨éŠã³ã‚„ã™ã„ã‚ˆ</div>
        </div>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ -->
    <div id="modeSelect" class="flex items-center justify-center h-[100dvh] max-h-[100dvh] overflow-hidden p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 text-center w-full max-w-2xl">
            <h1 class="text-5xl font-bold text-purple-600 mb-6 leading-tight">ğŸ¯ æœ€å¤§å…¬ç´„æ•°ãƒãƒˆãƒ«ï¼</h1>
            <p class="text-xl text-gray-600 mb-8 leading-relaxed">ã‚«ãƒ¼ãƒ‰ã‚’å‡ºã—ã¦æœ€å¤§å…¬ç´„æ•°ã‚’è¨ˆç®—ã—ã‚ˆã†ï¼</p>
            <div class="space-y-6">
                <button onclick="selectMode('cpu')" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-6 px-8 rounded-2xl text-2xl font-bold hover:from-blue-600 hover:to-purple-700 transform hover:scale-105 transition-all duration-200 shadow-lg">
                    ğŸ¤– CPUå¯¾æˆ¦
                </button>
                <button onclick="selectMode('pvp')" class="w-full bg-gradient-to-r from-green-500 to-teal-600 text-white py-6 px-8 rounded-2xl text-2xl font-bold hover:from-green-600 hover:to-teal-700 transform hover:scale-105 transition-all duration-200 shadow-lg">
                    ğŸ‘¥ 2äººå¯¾æˆ¦
                </button>
                <div class="mt-6 text-left">
                    <label class="block text-sm font-semibold mb-2">é›£æ˜“åº¦</label>
                    <select id="difficulty" class="w-full border-2 border-purple-300 rounded-xl p-3">
                        <option value="easy">ã‚„ã•ã—ã„</option>
                        <option value="normal" selected>ãµã¤ã†</option>
                        <option value="hard">ã‚€ãšã‹ã—ã„</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- åå‰å…¥åŠ›ç”»é¢ -->
    <div id="nameInput" class="hidden flex items-center justify-center h-[100dvh] max-h-[100dvh] overflow-hidden p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-8 text-center w-full max-w-2xl">
            <h2 class="text-4xl font-bold text-purple-600 mb-8 leading-tight">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å…¥åŠ›ã—ã¦ã­ï¼</h2>
            <div id="nameInputFields" class="space-y-6">
                <!-- JavaScript ã§å‹•çš„ã«ç”Ÿæˆ -->
            </div>
            <button onclick="startGameWithNames()" class="w-full bg-gradient-to-r from-purple-500 to-pink-600 text-white py-6 px-8 rounded-2xl text-2xl font-bold hover:from-purple-600 hover:to-pink-700 transform hover:scale-105 transition-all duration-200 shadow-lg mt-8">
                ã‚²ãƒ¼ãƒ é–‹å§‹ï¼
            </button>
        </div>
    </div>

    <!-- èª­ã¿ä¸Šã’ç”¨ï¼ˆã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼å¯¾å¿œï¼‰ -->
    <div id="live" class="sr-only" aria-live="polite" aria-atomic="true" role="status"></div>

    <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
    <div id="gameScreen" class="hidden min-h-[100dvh] p-4">
        <!-- ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
        <div id="turnPopup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="popup bg-white rounded-3xl p-8 text-center shadow-2xl">
                <div id="turnText" class="text-4xl font-bold text-purple-600 mb-3"></div>
                <div class="text-xl text-gray-600">æº–å‚™ã¯ã„ã„ã‹ãªï¼Ÿ</div>
            </div>
        </div>

        <!-- iPadæ¨ªç”»é¢æœ€é©åŒ–ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
        <div class="grid grid-cols-3 gap-3 h-[100dvh] max-h-[100dvh] overflow-hidden">
            <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ï¼ˆå·¦å´ï¼‰ -->
            <div id="player1-panel" class="bg-white rounded-xl p-3 shadow-lg flex flex-col h-full">
                <div class="mb-2 flex-shrink-0">
                    <h2 id="player1-name" class="text-lg font-bold text-blue-600 mb-1">ğŸ® ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1</h2>
                    <div class="flex items-center space-x-2">
                        <span class="text-xs font-semibold">HP:</span>
                        <div class="w-20 bg-gray-200 rounded-full h-3">
                            <div id="player1-hp-bar" class="hp-bar bg-green-500 h-3 rounded-full" style="width: 100%"></div>
                        </div>
                        <span id="player1-hp" class="text-sm font-bold">30/30</span>
                    </div>
                </div>
                <div class="flex-1 flex flex-col min-h-0">
                    <div class="text-xs text-gray-500 mb-1 text-center">æ‰‹æœ­</div>
                    <div id="player1-cards" class="flex flex-col items-center space-y-1 overflow-y-auto">
                        <!-- ã‚«ãƒ¼ãƒ‰ã¯JavaScriptã§ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- ä¸­å¤®ã‚¨ãƒªã‚¢ï¼ˆå ´ã®ã‚«ãƒ¼ãƒ‰ãƒ»ã‚²ãƒ¼ãƒ æƒ…å ±ãƒ»è¨ˆç®—ã‚¨ãƒªã‚¢ï¼‰ -->
            <div class="flex flex-col justify-center space-y-2 h-full overflow-y-auto">
                <!-- å ´ã®ã‚«ãƒ¼ãƒ‰ -->
                <div class="text-center flex-shrink-0">
                    <div class="bg-white rounded-xl p-3 shadow-lg inline-block">
                        <div class="text-sm font-semibold text-gray-600 mb-1">å ´ã®ã‚«ãƒ¼ãƒ‰</div>
                        <div id="field-card" class="w-20 h-24 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-lg flex items-center justify-center text-2xl font-bold text-white shadow-xl mx-auto border-[3px] border-yellow-300 transform hover:scale-105 transition-all duration-200">
                            30
                        </div>
                    </div>
                </div>

                <!-- ã‚²ãƒ¼ãƒ æƒ…å ± -->
                <div class="text-center flex-shrink-0">
                    <div class="bg-white rounded-xl p-2 shadow-lg inline-block">
                        <div id="game-status" class="text-sm font-semibold text-purple-600">ã‚«ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ã­ï¼</div>
                        <div id="selected-card-info" class="text-gray-600 mt-1 hidden text-xs">
                            é¸æŠä¸­: <span id="selected-number" class="font-bold"></span>
                        </div>
                        <div id="timer-display" class="text-lg font-bold text-red-500 mt-1 hidden">
                            â° <span id="timer-seconds">20</span>ç§’
                        </div>
                    </div>
                </div>

                <!-- è¨ˆç®—ã‚¨ãƒªã‚¢ -->
                <div id="calculation-area" class="text-center hidden flex-1 min-h-0">
                    <div class="bg-white rounded-xl p-3 shadow-lg inline-block max-w-full">
                        <div class="text-sm font-semibold mb-2">æœ€å¤§å…¬ç´„æ•°ã‚’å…¥åŠ›ã—ã¦ã­ï¼</div>
                        <div class="mb-2">
                            <div id="calc-question" class="text-sm font-bold text-purple-600 mb-1"></div>
                            <div id="user-input-display" class="text-4xl font-black text-purple-600 min-h-[60px] flex items-center justify-center bg-gradient-to-r from-purple-100 to-blue-100 rounded-lg border-[3px] border-purple-300 mb-2">
                                ?
                            </div>
                        </div>
                        <div class="grid grid-cols-5 gap-1 max-w-xs mx-auto">
                            <button aria-label="æ•°å­— 1" onclick="inputNumber(1)" class="number-button bg-gradient-to-br from-blue-500 to-blue-600 text-white text-sm font-bold py-2 rounded-lg shadow-lg border-2 border-blue-400 min-w-[48px] min-h-[48px]">1</button>
                            <button aria-label="æ•°å­— 2" onclick="inputNumber(2)" class="number-button bg-gradient-to-br from-blue-500 to-blue-600 text-white text-sm font-bold py-2 rounded-lg shadow-lg border-2 border-blue-400 min-w-[48px] min-h-[48px]">2</button>
                            <button aria-label="æ•°å­— 3" onclick="inputNumber(3)" class="number-button bg-gradient-to-br from-blue-500 to-blue-600 text-white text-sm font-bold py-2 rounded-lg shadow-lg border-2 border-blue-400 min-w-[48px] min-h-[48px]">3</button>
                            <button aria-label="æ•°å­— 4" onclick="inputNumber(4)" class="number-button bg-gradient-to-br from-blue-500 to-blue-600 text-white text-sm font-bold py-2 rounded-lg shadow-lg border-2 border-blue-400 min-w-[48px] min-h-[48px]">4</button>
                            <button aria-label="æ•°å­— 5" onclick="inputNumber(5)" class="number-button bg-gradient-to-br from-blue-500 to-blue-600 text-white text-sm font-bold py-2 rounded-lg shadow-lg border-2 border-blue-400 min-w-[48px] min-h-[48px]">5</button>
                            <button aria-label="æ•°å­— 6" onclick="inputNumber(6)" class="number-button bg-gradient-to-br from-blue-500 to-blue-600 text-white text-sm font-bold py-2 rounded-lg shadow-lg border-2 border-blue-400 min-w-[48px] min-h-[48px]">6</button>
                            <button aria-label="æ•°å­— 7" onclick="inputNumber(7)" class="number-button bg-gradient-to-br from-blue-500 to-blue-600 text-white text-sm font-bold py-2 rounded-lg shadow-lg border-2 border-blue-400 min-w-[48px] min-h-[48px]">7</button>
                            <button aria-label="æ•°å­— 8" onclick="inputNumber(8)" class="number-button bg-gradient-to-br from-blue-500 to-blue-600 text-white text-sm font-bold py-2 rounded-lg shadow-lg border-2 border-blue-400 min-w-[48px] min-h-[48px]">8</button>
                            <button aria-label="æ•°å­— 9" onclick="inputNumber(9)" class="number-button bg-gradient-to-br from-blue-500 to-blue-600 text-white text-sm font-bold py-2 rounded-lg shadow-lg border-2 border-blue-400 min-w-[48px] min-h-[48px]">9</button>
                            <button aria-label="æ•°å­— 0" onclick="inputNumber(0)" class="number-button bg-gradient-to-br from-blue-500 to-blue-600 text-white text-sm font-bold py-2 rounded-lg shadow-lg border-2 border-blue-400 min-w-[48px] min-h-[48px]">0</button>
                            <button aria-label="å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢" onclick="clearInput()" class="number-button bg-gradient-to-br from-red-500 to-red-600 text-white text-xs font-bold py-2 rounded-lg shadow-lg col-span-2 border-2 border-red-400 min-w-[48px] min-h-[48px]">ã‚¯ãƒªã‚¢</button>
                            <button aria-label="OK æ±ºå®š" onclick="submitAnswer()" class="number-button bg-gradient-to-br from-green-500 to-green-600 text-white text-xs font-bold py-2 rounded-lg shadow-lg col-span-3 border-2 border-green-400 min-w-[48px] min-h-[48px]">OK</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ï¼ˆå³å´ï¼‰ -->
            <div id="player2-panel" class="bg-white rounded-xl p-3 shadow-lg flex flex-col h-full">
                <div class="mb-2 flex-shrink-0">
                    <h2 id="player2-name" class="text-lg font-bold text-red-600 mb-1">ğŸ¤– CPU</h2>
                    <div class="flex items-center space-x-2">
                        <span class="text-xs font-semibold">HP:</span>
                        <div class="w-20 bg-gray-200 rounded-full h-3">
                            <div id="player2-hp-bar" class="hp-bar bg-red-500 h-3 rounded-full" style="width: 100%"></div>
                        </div>
                        <span id="player2-hp" class="text-sm font-bold">30/30</span>
                    </div>
                </div>
                <div class="flex-1 flex flex-col min-h-0">
                    <div class="text-xs text-gray-500 mb-1 text-center">æ‰‹æœ­</div>
                    <div id="player2-cards" class="flex flex-col items-center space-y-1 overflow-y-auto">
                        <!-- CPU/ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã®æ‰‹æœ­ï¼ˆè£é¢è¡¨ç¤ºï¼‰ -->
                        <div class="w-16 h-16 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-lg shadow-lg border-2 border-blue-400 flex items-center justify-center text-white text-sm">ğŸ´</div>
                        <div class="w-16 h-16 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-lg shadow-lg border-2 border-blue-400 flex items-center justify-center text-white text-sm">ğŸ´</div>
                        <div class="w-16 h-16 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-lg shadow-lg border-2 border-blue-400 flex items-center justify-center text-white text-sm">ğŸ´</div>
                        <div class="w-16 h-16 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-lg shadow-lg border-2 border-blue-400 flex items-center justify-center text-white text-sm">ğŸ´</div>
                        <div class="w-16 h-16 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-lg shadow-lg border-2 border-blue-400 flex items-center justify-center text-white text-sm">ğŸ´</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let gameState = {
            mode: null, // 'cpu' or 'pvp'
            currentPlayer: 1, // 1 or 2
            player1: { hp: 30, maxHp: 30, cards: [], name: '' },
            player2: { hp: 30, maxHp: 30, cards: [], name: '' },
            fieldCard: 30,
            selectedCard: null,
            inputValue: '',
            isCalculating: false,
            timer: null,
            timeLeft: 0,
            difficulty: 'normal' // 'easy'|'normal'|'hard'
        };

        // æœ€å¤§å…¬ç´„æ•°ã‚’è¨ˆç®—
        function gcd(a, b) {
            while (b !== 0) {
                let temp = b;
                b = a % b;
                a = temp;
            }
            return a;
        }

        // å¿…ãšè§£ã‘ã‚‹å ´ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆgcd>1ãŒ1æšä»¥ä¸Šï¼‰
        function ensureSolvable(field, hand) {
            return hand.some(c => gcd(c, field) > 1);
        }

        // èª­ã¿ä¸Šã’æ©Ÿèƒ½ï¼ˆã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œï¼‰
        function announce(msg) {
            const live = document.getElementById('live');
            live.textContent = ''; // å†èª­ä¸Šã’ç”¨
            setTimeout(() => live.textContent = msg, 10);
        }

        // ç´ æ•°ã§ã¯ãªã„æ•°ã‚’ç”Ÿæˆï¼ˆ20-50ï¼‰
        function generateFieldCard() {
            const nonPrimes = [];
            for (let i = 20; i <= 50; i++) {
                if (!isPrime(i)) {
                    nonPrimes.push(i);
                }
            }
            return nonPrimes[Math.floor(Math.random() * nonPrimes.length)];
        }

        // ç´ æ•°åˆ¤å®š
        function isPrime(n) {
            if (n < 2) return false;
            for (let i = 2; i <= Math.sqrt(n); i++) {
                if (n % i === 0) return false;
            }
            return true;
        }

        // ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆï¼ˆ5-20ï¼‰
        function generateCard() {
            return Math.floor(Math.random() * 16) + 5;
        }

        // æ‰‹æœ­ã‚’è£œå……
        function refillHand(player) {
            while (player.cards.length < 5) {
                player.cards.push(generateCard());
            }
        }

        // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
        function startTimer(seconds, onTimeout) {
            clearTimer();
            gameState.timeLeft = seconds;
            document.getElementById('timer-seconds').textContent = seconds;
            document.getElementById('timer-display').classList.remove('hidden');
            
            gameState.timer = setInterval(() => {
                gameState.timeLeft--;
                document.getElementById('timer-seconds').textContent = gameState.timeLeft;
                
                // æ®‹ã‚Š5ç§’ä»¥ä¸‹ã§è‰²ã‚’å¤‰æ›´
                const timerElement = document.getElementById('timer-display');
                if (gameState.timeLeft <= 5) {
                    timerElement.classList.add('animate-pulse');
                    timerElement.style.color = '#dc2626'; // red-600
                } else {
                    timerElement.classList.remove('animate-pulse');
                    timerElement.style.color = '#ef4444'; // red-500
                }
                
                if (gameState.timeLeft <= 0) {
                    clearTimer();
                    onTimeout();
                }
            }, 1000);
        }

        // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
        function clearTimer() {
            if (gameState.timer) {
                clearInterval(gameState.timer);
                gameState.timer = null;
            }
            document.getElementById('timer-display').classList.add('hidden');
        }

        // ç”»é¢å…¨ä½“ã‚­ãƒ©ã‚­ãƒ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        function createMegaSparkles() {
            const container = document.createElement('div');
            container.className = 'fullscreen-celebration';
            document.body.appendChild(container);
            
            for (let i = 0; i < 20; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'mega-sparkle';
                sparkle.style.left = Math.random() * window.innerWidth + 'px';
                sparkle.style.top = Math.random() * window.innerHeight + 'px';
                sparkle.style.animationDelay = Math.random() * 0.5 + 's';
                container.appendChild(sparkle);
            }
            
            setTimeout(() => {
                if (container.parentNode) {
                    container.parentNode.removeChild(container);
                }
            }, 2000);
        }

        // å°ã•ãªã‚­ãƒ©ã‚­ãƒ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        function createSparkles(element) {
            const rect = element.getBoundingClientRect();
            for (let i = 0; i < 8; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                sparkle.style.left = Math.random() * rect.width + 'px';
                sparkle.style.top = Math.random() * rect.height + 'px';
                element.style.position = 'relative';
                element.appendChild(sparkle);
                
                setTimeout(() => {
                    if (sparkle.parentNode) {
                        sparkle.parentNode.removeChild(sparkle);
                    }
                }, 1000);
            }
        }

        // å¤§ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        function showBigDamage(damage, isCorrect) {
            if (isCorrect && damage > 0) {
                // ç”»é¢å…¨ä½“ã«å·¨å¤§ãƒ€ãƒ¡ãƒ¼ã‚¸è¡¨ç¤º
                const damageElement = document.createElement('div');
                damageElement.className = 'big-damage';
                damageElement.innerHTML = `
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">ğŸ’¥</div>
                    <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 0.3rem;">${damage}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼</div>
                    <div style="font-size: 1.5rem; color: #059669;">æ­£è§£ã§ã™ï¼</div>
                `;
                document.body.appendChild(damageElement);
                
                // ç”»é¢å…¨ä½“ã‚­ãƒ©ã‚­ãƒ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                createMegaSparkles();
                
                setTimeout(() => {
                    if (damageElement.parentNode) {
                        damageElement.parentNode.removeChild(damageElement);
                    }
                }, 2000);
            } else if (!isCorrect) {
                // ä¸æ­£è§£æ™‚ã®ç”»é¢å…¨ä½“æŒ¯å‹•
                document.body.classList.add('wrong-answer');
                
                // ä¸æ­£è§£ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
                const wrongElement = document.createElement('div');
                wrongElement.className = 'big-damage';
                wrongElement.style.color = '#dc2626';
                wrongElement.style.borderColor = '#dc2626';
                wrongElement.innerHTML = `
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">âŒ</div>
                    <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.3rem;">ä¸æ­£è§£...</div>
                    <div style="font-size: 1.3rem; color: #6b7280;">ãƒ€ãƒ¡ãƒ¼ã‚¸ãªã—</div>
                `;
                document.body.appendChild(wrongElement);
                
                setTimeout(() => {
                    document.body.classList.remove('wrong-answer');
                    if (wrongElement.parentNode) {
                        wrongElement.parentNode.removeChild(wrongElement);
                    }
                }, 1500);
            }
        }

        // ãƒ¢ãƒ¼ãƒ‰é¸æŠ
        function selectMode(mode) {
            gameState.mode = mode;
            document.getElementById('modeSelect').classList.add('hidden');
            document.getElementById('nameInput').classList.remove('hidden');
            
            const nameInputFields = document.getElementById('nameInputFields');
            nameInputFields.innerHTML = '';
            
            if (mode === 'cpu') {
                nameInputFields.innerHTML = `
                    <div class="mb-4">
                        <label class="block text-lg font-semibold text-gray-700 mb-2">ã‚ãªãŸã®åå‰</label>
                        <input type="text" id="player1Name" class="w-full px-4 py-3 border-2 border-purple-300 rounded-xl text-lg focus:border-purple-500 focus:outline-none" placeholder="åå‰ã‚’å…¥åŠ›ã—ã¦ã­" maxlength="10" value="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1" onfocus="this.select()" onclick="this.select()">
                    </div>
                `;
                // å…¥åŠ›æ¬„ã‚’å…¨é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
                setTimeout(() => {
                    const input = document.getElementById('player1Name');
                    input.focus();
                    input.select();
                }, 100);
            } else {
                nameInputFields.innerHTML = `
                    <div class="mb-4">
                        <label class="block text-lg font-semibold text-gray-700 mb-2">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®åå‰</label>
                        <input type="text" id="player1Name" class="w-full px-4 py-3 border-2 border-purple-300 rounded-xl text-lg focus:border-purple-500 focus:outline-none" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®åå‰" maxlength="10" value="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1" onfocus="this.select()" onclick="this.select()">
                    </div>
                    <div class="mb-4">
                        <label class="block text-lg font-semibold text-gray-700 mb-2">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã®åå‰</label>
                        <input type="text" id="player2Name" class="w-full px-4 py-3 border-2 border-purple-300 rounded-xl text-lg focus:border-purple-500 focus:outline-none" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã®åå‰" maxlength="10" value="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2" onfocus="this.select()" onclick="this.select()">
                    </div>
                `;
                // æœ€åˆã®å…¥åŠ›æ¬„ã‚’å…¨é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
                setTimeout(() => {
                    const input = document.getElementById('player1Name');
                    input.focus();
                    input.select();
                }, 100);
            }
        }

        // åå‰å…¥åŠ›å¾Œã®ã‚²ãƒ¼ãƒ é–‹å§‹
        function startGameWithNames() {
            const player1Name = document.getElementById('player1Name').value.trim();
            const player2Name = document.getElementById('player2Name')?.value.trim();
            
            if (!player1Name) {
                alert('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼');
                return;
            }
            
            if (gameState.mode === 'pvp' && !player2Name) {
                alert('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼');
                return;
            }
            
            gameState.player1.name = player1Name;
            gameState.player2.name = gameState.mode === 'cpu' ? 'CPU' : player2Name;
            gameState.difficulty = document.getElementById('difficulty')?.value || 'normal';
            
            startGame();
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        function startGame() {
            gameState.currentPlayer = 1;
            gameState.player1.hp = 30;
            gameState.player1.maxHp = 30;
            gameState.player1.cards = [];
            gameState.player2.hp = 30;
            gameState.player2.maxHp = 30;
            gameState.player2.cards = [];
            gameState.selectedCard = null;
            gameState.inputValue = '';
            gameState.isCalculating = false;

            refillHand(gameState.player1);
            refillHand(gameState.player2);

            // åˆæ‰‹ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ãŒå¿…ãšè§£ã‘ã‚‹ã‚ˆã†ã«å ´ã®ã‚«ãƒ¼ãƒ‰ã‚’è¨­å®š
            let f;
            do { 
                f = generateFieldCard(); 
            } while(!ensureSolvable(f, gameState.player1.cards));
            gameState.fieldCard = f;

            document.getElementById('nameInput').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’è¡¨ç¤º
            document.getElementById('player1-name').textContent = `ğŸ® ${gameState.player1.name}`;
            if (gameState.mode === 'cpu') {
                document.getElementById('player2-name').textContent = 'ğŸ¤– CPU';
            } else {
                document.getElementById('player2-name').textContent = `ğŸ‘¤ ${gameState.player2.name}`;
            }

            updateDisplay();
            showTurnPopup();
        }

        // ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
        function showTurnPopup() {
            const popup = document.getElementById('turnPopup');
            const turnText = document.getElementById('turnText');
            
            const currentPlayerData = gameState.currentPlayer === 1 ? gameState.player1 : gameState.player2;
            turnText.textContent = `ğŸ¯ ${currentPlayerData.name}ã®ã‚¿ãƒ¼ãƒ³ï¼`;
            
            popup.classList.remove('hidden');
            
            setTimeout(() => {
                popup.classList.add('hidden');
                if (gameState.currentPlayer === 2 && gameState.mode === 'cpu') {
                    setTimeout(cpuTurn, 1000);
                } else {
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ã®å ´åˆã€ã‚«ãƒ¼ãƒ‰é¸æŠã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹
                    startTimer(pickSecondsByDifficulty(), () => {
                        // æ™‚é–“åˆ‡ã‚Œã®å ´åˆã€ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠ
                        const currentPlayerData = gameState.currentPlayer === 1 ? gameState.player1 : gameState.player2;
                        if (currentPlayerData.cards.length > 0) {
                            const randomIndex = Math.floor(Math.random() * currentPlayerData.cards.length);
                            selectCard(randomIndex);
                        }
                    });
                }
            }, 2000);
        }

        // ç”»é¢æ›´æ–°
        function updateDisplay() {
            // å ´ã®ã‚«ãƒ¼ãƒ‰
            document.getElementById('field-card').textContent = gameState.fieldCard;
            
            // HPè¡¨ç¤º
            document.getElementById('player1-hp').textContent = `${gameState.player1.hp}/${gameState.player1.maxHp}`;
            document.getElementById('player2-hp').textContent = `${gameState.player2.hp}/${gameState.player2.maxHp}`;
            
            document.getElementById('player1-hp-bar').style.width = `${(gameState.player1.hp / gameState.player1.maxHp) * 100}%`;
            document.getElementById('player2-hp-bar').style.width = `${(gameState.player2.hp / gameState.player2.maxHp) * 100}%`;
            
            // æ‰‹æœ­è¡¨ç¤º
            updatePlayerCards();
            
            // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
            if (!gameState.isCalculating) {
                document.getElementById('game-status').textContent = 'ã‚«ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ã­ï¼';
            }
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºæ›´æ–°
        function updatePlayerCards() {
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
            const player1Container = document.getElementById('player1-cards');
            player1Container.innerHTML = '';
            
            if (gameState.currentPlayer === 1) {
                // ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹æœ­ã‚’è¡¨ç¤ºï¼ˆã‚¯ãƒªãƒƒã‚¯å¯èƒ½ï¼‰
                gameState.player1.cards.forEach((card, index) => {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'card w-16 h-16 bg-gradient-to-br from-green-400 to-blue-500 rounded-lg flex items-center justify-center text-lg font-bold text-white shadow-lg cursor-pointer border-2 border-green-300';
                    cardElement.textContent = card;
                    cardElement.onclick = () => selectCard(index);
                    player1Container.appendChild(cardElement);
                });
            } else {
                // ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³ã®æ™‚ã¯è£é¢è¡¨ç¤º
                for (let i = 0; i < gameState.player1.cards.length; i++) {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'w-16 h-16 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-lg shadow-lg border-2 border-blue-400 flex items-center justify-center text-white text-sm';
                    cardElement.innerHTML = 'ğŸ´';
                    player1Container.appendChild(cardElement);
                }
            }

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã®ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
            const player2Container = document.getElementById('player2-cards');
            player2Container.innerHTML = '';
            
            if (gameState.currentPlayer === 2 && gameState.mode === 'pvp') {
                // 2äººå¯¾æˆ¦ã§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã®ã‚¿ãƒ¼ãƒ³ã®æ™‚ã¯æ‰‹æœ­ã‚’è¡¨ç¤º
                gameState.player2.cards.forEach((card, index) => {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'card w-16 h-16 bg-gradient-to-br from-red-400 to-purple-500 rounded-lg flex items-center justify-center text-lg font-bold text-white shadow-lg cursor-pointer border-2 border-red-300';
                    cardElement.textContent = card;
                    cardElement.onclick = () => selectCard(index);
                    player2Container.appendChild(cardElement);
                });
            } else {
                // CPUã¾ãŸã¯ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³ã®æ™‚ã¯è£é¢è¡¨ç¤º
                for (let i = 0; i < gameState.player2.cards.length; i++) {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'w-16 h-16 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-lg shadow-lg border-2 border-blue-400 flex items-center justify-center text-white text-sm';
                    cardElement.innerHTML = 'ğŸ´';
                    player2Container.appendChild(cardElement);
                }
            }
        }

        // ã‚«ãƒ¼ãƒ‰é¸æŠ
        function selectCard(index) {
            if (gameState.isCalculating) return;
            
            const currentPlayerData = gameState.currentPlayer === 1 ? gameState.player1 : gameState.player2;
            gameState.selectedCard = currentPlayerData.cards[index];
            
            // ã‚«ãƒ¼ãƒ‰ã‚’æ‰‹æœ­ã‹ã‚‰å‰Šé™¤
            currentPlayerData.cards.splice(index, 1);
            
            // è¨ˆç®—ãƒ•ã‚§ãƒ¼ã‚ºã«ç§»è¡Œ
            gameState.isCalculating = true;
            gameState.inputValue = '';
            document.getElementById('game-status').textContent = 'æœ€å¤§å…¬ç´„æ•°ã‚’è¨ˆç®—ã—ã¦ã­ï¼';
            document.getElementById('selected-card-info').classList.remove('hidden');
            document.getElementById('selected-number').textContent = gameState.selectedCard;
            document.getElementById('calculation-area').classList.remove('hidden');
            document.getElementById('calc-question').textContent = `${gameState.selectedCard} ã¨ ${gameState.fieldCard} ã®æœ€å¤§å…¬ç´„æ•°ã¯ï¼Ÿ`;
            document.getElementById('user-input-display').textContent = '?';
            
            // è¨ˆç®—ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹ï¼ˆ15ç§’ï¼‰
            startTimer(15, () => {
                // æ™‚é–“åˆ‡ã‚Œã®å ´åˆã€å°‚ç”¨ã®è¡¨ç¤º
                document.getElementById('game-status').textContent = 'â° æ™‚é–“åˆ‡ã‚Œï¼ãƒ€ãƒ¡ãƒ¼ã‚¸ãªã—';
                
                // æ™‚é–“åˆ‡ã‚Œãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
                const timeoutElement = document.createElement('div');
                timeoutElement.className = 'big-damage';
                timeoutElement.style.color = '#f59e0b';
                timeoutElement.style.borderColor = '#f59e0b';
                timeoutElement.innerHTML = `
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">â°</div>
                    <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.3rem;">æ™‚é–“åˆ‡ã‚Œï¼</div>
                    <div style="font-size: 1.3rem; color: #6b7280;">ãƒ€ãƒ¡ãƒ¼ã‚¸ãªã—</div>
                `;
                document.body.appendChild(timeoutElement);
                
                setTimeout(() => {
                    if (timeoutElement.parentNode) {
                        timeoutElement.parentNode.removeChild(timeoutElement);
                    }
                    nextTurn();
                }, 2000);
            });
            
            updatePlayerCards();
        }

        // æ•°å­—å…¥åŠ›
        function inputNumber(num) {
            if (gameState.inputValue.length < 2) {
                gameState.inputValue += num.toString();
                const displayElement = document.getElementById('user-input-display');
                displayElement.textContent = gameState.inputValue;
                displayElement.classList.add('input-pulse');
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã«ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
                setTimeout(() => {
                    displayElement.classList.remove('input-pulse');
                }, 300);
            }
        }

        // å…¥åŠ›ã‚¯ãƒªã‚¢
        function clearInput() {
            gameState.inputValue = '';
            document.getElementById('user-input-display').textContent = '?';
        }

        // ç­”ãˆé€ä¿¡
        function submitAnswer() {
            if (gameState.inputValue === '' || hasAnswered) return;
            hasAnswered = true;
            
            // ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢
            clearTimer();
            
            const correctAnswer = gcd(gameState.selectedCard, gameState.fieldCard);
            const userAnswer = parseInt(gameState.inputValue);
            
            if (userAnswer === correctAnswer) {
                // æ­£è§£
                const opponentData = gameState.currentPlayer === 1 ? gameState.player2 : gameState.player1;
                opponentData.hp = Math.max(0, opponentData.hp - correctAnswer);
                updateDisplay(); // HPè¡¨ç¤ºã‚’å³åº§ã«æ›´æ–°
                
                document.getElementById('game-status').textContent = `ğŸ‰ æ­£è§£ï¼ ${correctAnswer}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`;
                announce(`æ­£è§£ã€‚${correctAnswer}ãƒ€ãƒ¡ãƒ¼ã‚¸`);
                showBigDamage(correctAnswer, true);
                
                // ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                const targetPanel = gameState.currentPlayer === 1
                    ? document.getElementById('player2-panel')
                    : document.getElementById('player1-panel');
                targetPanel.classList.add('damage-animation');
                setTimeout(() => targetPanel.classList.remove('damage-animation'), 500);
                
            } else {
                document.getElementById('game-status').textContent = `âŒ ä¸æ­£è§£... æ­£è§£ã¯ ${correctAnswer} ã§ã—ãŸ`;
                announce(`ä¸æ­£è§£ã€‚æ­£è§£ã¯${correctAnswer}ã§ã—ãŸ`);
                showBigDamage(0, false);
            }
            
            // ã‚²ãƒ¼ãƒ çµ‚äº†ãƒã‚§ãƒƒã‚¯
            if (gameState.player1.hp <= 0 || gameState.player2.hp <= 0) {
                setTimeout(endGame, 3000);
                return;
            }
            
            // æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸
            setTimeout(() => {
                nextTurn();
                hasAnswered = false;
            }, 3000);
        }

        // CPUæˆ¦ç•¥çš„ã‚«ãƒ¼ãƒ‰é¸æŠ
        function cpuChooseCard() {
            const cards = gameState.player2.cards.slice();
            const scores = cards.map(c => ({c, g: gcd(c, gameState.fieldCard)}));
            
            if (gameState.difficulty === 'easy') {
                // ãŸã¾ã«å¼±ã„æ‰‹ or ãƒŸã‚¹
                if (Math.random() < 0.25) return cards[Math.floor(Math.random() * cards.length)];
                return scores.sort((a,b) => a.g - b.g)[0].c; // ã‚ã–ã¨å¼±æ‰‹
            }
            if (gameState.difficulty === 'hard') {
                return scores.sort((a,b) => b.g - a.g)[0].c; // å¸¸ã«æœ€å–„
            }
            // normal: 6å‰²ã¯æœ€å–„ã€4å‰²ã¯ãƒ©ãƒ³ãƒ€ãƒ 
            return (Math.random() < 0.6)
                ? scores.sort((a,b) => b.g - a.g)[0].c
                : cards[Math.floor(Math.random() * cards.length)];
        }

        // CPUã®ã‚¿ãƒ¼ãƒ³
        function cpuTurn() {
            // CPUãŒã‚«ãƒ¼ãƒ‰ã‚’é¸æŠ
            const cpuCard = cpuChooseCard();
            const cardIndex = gameState.player2.cards.indexOf(cpuCard);
            gameState.player2.cards.splice(cardIndex, 1);
            
            // CPUãŒæ­£è§£ã‚’è¨ˆç®—
            const correctAnswer = gcd(cpuCard, gameState.fieldCard);
            
            // ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹
            gameState.player1.hp = Math.max(0, gameState.player1.hp - correctAnswer);
            updateDisplay(); // HPè¡¨ç¤ºã‚’å³åº§ã«æ›´æ–°
            
            document.getElementById('game-status').textContent = `ğŸ¤– CPUãŒ ${cpuCard} ã‚’å‡ºã—ã¦ ${correctAnswer}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`;
            announce(`CPUãŒ${cpuCard}ã‚’å‡ºã—ã¦${correctAnswer}ãƒ€ãƒ¡ãƒ¼ã‚¸`);
            
            // CPUãƒ€ãƒ¡ãƒ¼ã‚¸è¡¨ç¤º
            const cpuDamageElement = document.createElement('div');
            cpuDamageElement.className = 'big-damage';
            cpuDamageElement.style.color = '#dc2626';
            cpuDamageElement.style.borderColor = '#dc2626';
            cpuDamageElement.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 0.5rem;">ğŸ¤–</div>
                <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.3rem;">CPUã®æ”»æ’ƒï¼</div>
                <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 0.3rem; color: #dc2626;">${correctAnswer}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼</div>
                <div style="font-size: 1.3rem; color: #6b7280;">ã‚«ãƒ¼ãƒ‰: ${cpuCard}</div>
            `;
            document.body.appendChild(cpuDamageElement);
            
            // ã‚­ãƒ©ã‚­ãƒ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            createMegaSparkles();
            
            setTimeout(() => {
                if (cpuDamageElement.parentNode) {
                    cpuDamageElement.parentNode.removeChild(cpuDamageElement);
                }
            }, 2000);
            
            // ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            const p1Panel = document.getElementById('player1-panel');
            p1Panel.classList.add('damage-animation');
            setTimeout(() => p1Panel.classList.remove('damage-animation'), 500);
            
            // ã‚²ãƒ¼ãƒ çµ‚äº†ãƒã‚§ãƒƒã‚¯
            if (gameState.player1.hp <= 0) {
                setTimeout(endGame, 3000);
                return;
            }
            
            // æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸
            setTimeout(() => {
                nextTurn();
                hasAnswered = false;
            }, 3000);
        }

        // æ¬¡ã®ã‚¿ãƒ¼ãƒ³
        function nextTurn() {
            // ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢
            clearTimer();
            
            // æ‰‹æœ­ã‚’è£œå……
            refillHand(gameState.player1);
            refillHand(gameState.player2);
            
            // ã‚¿ãƒ¼ãƒ³äº¤ä»£
            gameState.currentPlayer = gameState.currentPlayer === 1 ? 2 : 1;
            
            // å ´ã®ã‚«ãƒ¼ãƒ‰ã‚’å†æŠ½é¸ã—ã¦è§£ã‘ã‚‹å ´ã‚’ä¿è¨¼
            let f;
            const nextPlayerData = gameState.currentPlayer === 1 ? gameState.player1 : gameState.player2;
            do { 
                f = generateFieldCard(); 
            } while(!ensureSolvable(f, nextPlayerData.cards));
            gameState.fieldCard = f;
            
            // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
            gameState.selectedCard = null;
            gameState.inputValue = '';
            gameState.isCalculating = false;
            
            // UIæ›´æ–°
            document.getElementById('calculation-area').classList.add('hidden');
            document.getElementById('selected-card-info').classList.add('hidden');
            
            updateDisplay();
            showTurnPopup();
        }

        // ã‚²ãƒ¼ãƒ çµ‚äº†
        function endGame() {
            let winner;
            if (gameState.player1.hp <= 0) {
                winner = gameState.player2.name;
            } else {
                winner = gameState.player1.name;
            }
            
            document.getElementById('game-status').textContent = `ğŸ‰ ${winner}ã®å‹åˆ©ï¼`;
            announce(`${winner}ã®å‹åˆ©`);
            
            setTimeout(() => {
                if (confirm('ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                    document.getElementById('gameScreen').classList.add('hidden');
                    document.getElementById('modeSelect').classList.remove('hidden');
                }
            }, 3000);
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œå¯¾å¿œ
        document.addEventListener('keydown', (e) => {
            if (!gameState.isCalculating) return;
            if (e.key >= '0' && e.key <= '9') {
                inputNumber(parseInt(e.key));
            }
            if (e.key === 'Backspace') {
                gameState.inputValue = gameState.inputValue.slice(0, -1);
                document.getElementById('user-input-display').textContent = gameState.inputValue || '?';
            }
            if (e.key === 'Enter') {
                submitAnswer();
            }
        });

        // ç”»é¢å›è»¢æ¤œçŸ¥
        function checkOrientation() {
            const isPortrait = window.matchMedia("(orientation: portrait)").matches;
            document.getElementById('rotateOverlay').classList.toggle('hidden', !isPortrait);
            document.getElementById('rotateOverlay').classList.toggle('flex', isPortrait);
        }
        
        window.addEventListener('resize', checkOrientation);
        window.addEventListener('orientationchange', checkOrientation);
        document.addEventListener('DOMContentLoaded', checkOrientation);

        // é€£æ‰“é˜²æ­¢ãƒ•ãƒ©ã‚°
        let hasAnswered = false;

        // é›£æ˜“åº¦ã«å¿œã˜ãŸã‚¿ã‚¤ãƒãƒ¼æ™‚é–“
        function pickSecondsByDifficulty(){
            switch (gameState.difficulty){
                case 'easy': return 20;
                case 'hard': return 10;
                default: return 15;
            }
        }

        // åˆæœŸåŒ–
        updateDisplay();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9785f516f0928384',t:'MTc1Njc0MjE4My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

