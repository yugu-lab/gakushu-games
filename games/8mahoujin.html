<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é­”æ³•é™£ãƒ‘ã‚ºãƒ«</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            margin: 0;
            padding: 10px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: backgroundShift 10s ease-in-out infinite alternate;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 5px;
                align-items: flex-start;
            }
        }
        
        @media (orientation: landscape) and (max-height: 600px) {
            body {
                padding: 5px;
                align-items: flex-start;
            }
        }
        
        @keyframes backgroundShift {
            0% { background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); }
            100% { background: linear-gradient(135deg, #f093fb 0%, #667eea 50%, #764ba2 100%); }
        }
        
        .game-container {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15), 0 0 0 1px rgba(255,255,255,0.8);
            text-align: center;
            max-width: 900px;
            width: 100%;
            border: 3px solid transparent;
            background-clip: padding-box;
            position: relative;
            max-height: 95vh;
            overflow-y: auto;
        }
        
        @media (max-width: 768px) {
            .game-container {
                padding: 20px;
                border-radius: 20px;
                max-height: 98vh;
            }
        }
        
        @media (orientation: landscape) and (max-height: 600px) {
            .game-container {
                padding: 15px;
                border-radius: 15px;
                max-height: 95vh;
                display: flex;
                flex-direction: column;
            }
        }
        
        .game-container::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, #667eea, #764ba2, #f093fb, #667eea);
            border-radius: 28px;
            z-index: -1;
            animation: borderGlow 3s ease-in-out infinite alternate;
        }
        
        @keyframes borderGlow {
            0% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        h1 {
            background: linear-gradient(45deg, #667eea, #764ba2, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            animation: titleGlow 2s ease-in-out infinite alternate;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
                margin-bottom: 5px;
            }
        }
        
        @media (orientation: landscape) and (max-height: 600px) {
            h1 {
                font-size: 1.8em;
                margin-bottom: 5px;
            }
        }
        
        @keyframes titleGlow {
            0% { filter: brightness(1); }
            100% { filter: brightness(1.2); }
        }
        
        .subtitle {
            color: #718096;
            margin-bottom: 20px;
            font-size: 1.1em;
        }
        

        
        .level-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .level-btn {
            padding: 12px 24px;
            border: 3px solid transparent;
            border-radius: 15px;
            background: linear-gradient(145deg, #ffffff, #f1f5f9);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            white-space: nowrap;
        }
        
        .level-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }
        
        .level-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .level-btn:hover::before {
            left: 100%;
        }
        
        .level-btn.active {
            background: linear-gradient(145deg, #667eea, #5a67d8);
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }
        
        .level-btn:disabled,
        .level-btn[disabled] {
            background: #e2e8f0;
            color: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.6;
        }
        
        .game-layout {
            display: flex;
            gap: 30px;
            justify-content: center;
            align-items: flex-start;
            margin-bottom: 20px;
            flex-wrap: nowrap;
        }
        
        .magic-square {
            display: grid;
            gap: 4px;
            background: #f7fafc;
            padding: 20px;
            border-radius: 15px;
            max-width: 400px;
            width: 100%;
            flex-shrink: 0;
        }
        
        .used-numbers {
            background: linear-gradient(145deg, #f8fafc, #e2e8f0);
            border-radius: 15px;
            padding: 20px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.1);
            min-width: 200px;
            position: relative;
        }
        
        .used-numbers h3 {
            margin: 0 0 15px 0;
            color: #4a5568;
            font-size: 16px;
            text-align: center;
            font-weight: bold;
        }
        
        .used-numbers-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .used-numbers-grid.size-4 {
            grid-template-columns: repeat(4, 1fr);
        }
        
        .used-number {
            width: 40px;
            height: 40px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            background: white;
            color: #a0aec0;
        }
        
        .used-number.filled {
            background: #c6f6d5;
            border-color: #38a169;
            color: #2f855a;
        }
        
        @media (orientation: landscape) and (max-height: 600px) {
            .game-layout {
                gap: 20px;
            }
            .magic-square {
                max-width: 300px;
                padding: 15px;
            }
            .used-numbers {
                padding: 15px;
                min-width: 150px;
            }
        }
        
        @media (max-width: 768px) {
            .game-layout {
                flex-direction: row;
                align-items: flex-start;
                gap: 15px;
                flex-wrap: nowrap;
            }
            .magic-square {
                max-width: 200px;
                padding: 10px;
                flex-shrink: 0;
            }
            .used-numbers {
                min-width: 150px;
                flex-shrink: 0;
            }
        }
        
        .magic-square.size-3 {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .magic-square.size-4 {
            grid-template-columns: repeat(4, 1fr);
        }
        
        .cell {
            border: 3px solid #e2e8f0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            aspect-ratio: 1;
            min-height: 60px;
        }
        
        @media (orientation: landscape) and (max-height: 600px) {
            .cell {
                min-height: 45px;
                font-size: 18px;
                border-width: 2px;
            }
        }
        
        @media (max-width: 480px) {
            .cell {
                min-height: 50px;
                font-size: 18px;
            }
        }
        
        .cell:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }
        
        .cell.given {
            background: #e6fffa;
            border-color: #38b2ac;
            color: #2d3748;
            cursor: not-allowed;
        }
        
        .cell.filled {
            background: #fff5f5;
            border-color: #fc8181;
            color: #2d3748;
        }
        
        .cell.correct {
            background: #c6f6d5;
            border-color: #38a169;
            animation: pulse 0.5s ease-in-out;
        }
        
        .cell.error {
            background: #fed7d7;
            border-color: #e53e3e;
            animation: shake 0.5s ease-in-out;
        }
        
        .cell.selected {
            background: #ebf8ff;
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.3);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .numbers-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(145deg, #f8fafc, #e2e8f0);
            border-radius: 20px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.1);
        }
        
        @media (orientation: landscape) and (max-height: 600px) {
            .numbers-panel {
                padding: 15px;
                margin-bottom: 15px;
                gap: 6px;
            }
        }
        
        @media (max-width: 480px) {
            .numbers-panel {
                padding: 15px;
                gap: 6px;
            }
        }
        
        .numbers-panel::before {
            content: 'ğŸ¯ ã™ã¹ã¦ã®æ•°å­—ã‚’ä½¿ã£ã¦é­”æ³•é™£ã‚’å®Œæˆã•ã›ã‚ˆã†ï¼';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #667eea, #f093fb);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            white-space: nowrap;
        }
        
        .numbers-panel {
            position: relative;
            margin-top: 25px;
        }
        
        .number-btn {
            width: 50px;
            height: 50px;
            border: 3px solid transparent;
            border-radius: 12px;
            background: linear-gradient(145deg, #ffffff, #f1f5f9);
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }
        
        @media (orientation: landscape) and (max-height: 600px) {
            .number-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
                border-width: 2px;
            }
        }
        
        @media (max-width: 480px) {
            .number-btn {
                width: 45px;
                height: 45px;
                font-size: 16px;
            }
        }
        
        .number-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.3), transparent);
            transition: all 0.3s ease;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        
        .number-btn:hover::after {
            width: 100px;
            height: 100px;
        }
        
        .number-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .number-btn.used {
            background: linear-gradient(145deg, #e2e8f0, #cbd5e0);
            color: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .number-btn.used::before {
            content: 'âœ“';
            position: absolute;
            top: -5px;
            right: -5px;
            background: #38a169;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .number-btn.selected {
            background: linear-gradient(145deg, #667eea, #5a67d8);
            color: white;
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
            animation: selectedPulse 1s ease-in-out infinite alternate;
        }
        
        @keyframes selectedPulse {
            0% { box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5); }
            100% { box-shadow: 0 8px 35px rgba(102, 126, 234, 0.7); }
        }
        
        .controls {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        @media (orientation: landscape) and (max-height: 600px) {
            .controls {
                gap: 8px;
                margin-bottom: 10px;
            }
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            white-space: nowrap;
        }
        
        @media (orientation: landscape) and (max-height: 600px) {
            .btn {
                padding: 8px 16px;
                font-size: 14px;
            }
        }
        
        @media (max-width: 480px) {
            .btn {
                padding: 10px 20px;
                font-size: 14px;
            }
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(145deg, #667eea, #5a67d8);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(145deg, #f1f5f9, #e2e8f0);
            color: #4a5568;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        .btn-back {
            background: linear-gradient(145deg, #f093fb, #f093fb);
            color: white;
        }
        
        .btn-back:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(240, 147, 251, 0.4);
        }
        
        .status {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            min-height: 25px;
        }
        
        .status.success {
            color: #38a169;
        }
        
        .status.error {
            color: #e53e3e;
        }
        
        .status.info {
            color: #3182ce;
        }
        

        
        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .score-info {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .score-item {
            background: #f7fafc;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            border: 2px solid #e2e8f0;
        }
        
        .score-item.score {
            color: #2d3748;
        }
        
        .score-item.time {
            color: #3182ce;
        }
        
        .score-item.hints {
            color: #38a169;
        }
        
        .score-item.best {
            color: #805ad5;
            border-color: #d6bcfa;
        }
        
        .btn:disabled {
            background: #e2e8f0;
            color: #a0aec0;
            cursor: not-allowed;
        }
        
        /* é‡è¤‡ã‚»ãƒ«ï¼†æ•°å­—ã®ã‚„ã•ã—ã„æ³¨æ„è‰² */
        .cell.dup {
            background: #fffbea;
            border-color: #ecc94b;
            box-shadow: 0 0 0 3px rgba(236, 201, 75, 0.25);
        }
        
        .used-number.dup {
            background: #fffbea;
            border-color: #ecc94b;
            color: #744210;
            position: relative;
        }
        
        /* ä½•å›é‡ãªã£ã¦ã‚‹ã‹ã‚’å°ãƒãƒƒã‚¸ã§è¡¨ç¤º */
        .used-number.dup::after {
            content: 'Ã—' attr(data-count);
            position: absolute;
            bottom: -6px;
            right: -6px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #ecc94b;
            color: #1a202c;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
        }
        
        /* å³æ ¼ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ä½¿ç”¨æ¸ˆã¿ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ä¸èƒ½ã« */
        .number-btn.used.strict {
            pointer-events: none;
        }
        
        .difficulty-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .difficulty-easy {
            background: #c6f6d5;
            color: #2f855a;
        }
        
        .difficulty-normal {
            background: #fed7a1;
            color: #c05621;
        }
        
        .rules-screen {
            text-align: left;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .rules-content h2 {
            text-align: center;
            color: #4a5568;
            margin-bottom: 30px;
            font-size: 2em;
        }
        
        .rules-content h3 {
            text-align: center;
            color: #4a5568;
            margin: 30px 0 20px 0;
            font-size: 1.3em;
        }
        
        .rules-text {
            background: #f7fafc;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #e2e8f0;
        }
        
        .rules-text p {
            margin-bottom: 15px;
            line-height: 1.6;
            color: #2d3748;
        }
        
        .rules-text ul {
            margin: 10px 0 15px 20px;
            color: #4a5568;
        }
        
        .rules-text li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .level-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .high-score-display {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(145deg, #f8fafc, #e2e8f0);
            border-radius: 15px;
            border: 2px solid #e2e8f0;
            text-align: center;
        }
        
        .high-score-display h4 {
            margin: 0 0 15px 0;
            color: #4a5568;
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .high-score-item {
            background: linear-gradient(145deg, #ffffff, #f1f5f9);
            padding: 15px 25px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 2px solid #d6bcfa;
        }
        
        .score-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #805ad5;
        }
        
        .score-stars {
            font-size: 1.2em;
            color: #f6ad55;
        }
        
        .game-screen .level-selector {
            margin-bottom: 20px;
        }
        
        .penalty-display {
            margin-top: 15px;
            text-align: center;
            animation: penaltyFadeIn 0.5s ease-in-out;
        }
        
        .penalty-text {
            background: linear-gradient(145deg, #fed7d7, #fc8181);
            color: #c53030;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            display: inline-block;
            box-shadow: 0 2px 10px rgba(197, 48, 48, 0.3);
            border: 2px solid #e53e3e;
        }
        
        @keyframes penaltyFadeIn {
            0% { opacity: 0; transform: translateY(-10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        .completion-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: popupFadeIn 0.3s ease-out;
        }
        
        .completion-content {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border-radius: 25px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            border: 3px solid transparent;
            background-clip: padding-box;
            position: relative;
        }
        
        .completion-content::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, #667eea, #764ba2, #f093fb, #667eea);
            border-radius: 28px;
            z-index: -1;
            animation: borderGlow 3s ease-in-out infinite alternate;
        }
        
        .completion-title {
            font-size: 2.5em;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #667eea, #764ba2, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .completion-score {
            font-size: 1.5em;
            margin-bottom: 15px;
            color: #2d3748;
            font-weight: bold;
        }
        
        .completion-stars {
            font-size: 2em;
            margin-bottom: 20px;
        }
        
        .completion-record {
            background: linear-gradient(145deg, #c6f6d5, #9ae6b4);
            color: #2f855a;
            padding: 10px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .completion-best {
            color: #805ad5;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        @keyframes popupFadeIn {
            0% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è»½æ¸›è¨­å®š */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation: none !important;
                transition: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>âœ¨ é­”æ³•é™£ãƒ‘ã‚ºãƒ«</h1>
        <p class="subtitle">ç©ºã„ã¦ã„ã‚‹ãƒã‚¹ç›®ã‚’åŸ‹ã‚ã¦é­”æ³•é™£ã‚’å®Œæˆã•ã›ã‚ˆã†ï¼</p>
        

        
        <div id="rulesScreen" class="rules-screen">
            <div class="rules-content">
                <h2>ğŸ¯ ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ«</h2>
                <div class="rules-text">
                    <p><strong>é­”æ³•é™£ã¨ã¯ï¼Ÿ</strong><br>
                    ç¸¦ãƒ»æ¨ªãƒ»æ–œã‚ã®ã™ã¹ã¦ã®åˆ—ã®æ•°å­—ã®åˆè¨ˆãŒåŒã˜ã«ãªã‚‹æ•°å­—ã®é…ç½®ã§ã™ã€‚</p>
                    
                    <p><strong>éŠã³æ–¹ï¼š</strong></p>
                    <ul>
                        <li>ç©ºã„ã¦ã„ã‚‹ãƒã‚¹ç›®ã«æ•°å­—ã‚’å…¥ã‚Œã¦é­”æ³•é™£ã‚’å®Œæˆã•ã›ã¾ã™</li>
                        <li>å„æ•°å­—ã¯1å›ã ã‘ä½¿ç”¨ã§ãã¾ã™</li>
                        <li>ã™ã¹ã¦ã®è¡Œãƒ»åˆ—ãƒ»å¯¾è§’ç·šã®åˆè¨ˆãŒåŒã˜ã«ãªã‚‹ã‚ˆã†ã«ã—ã¾ã™</li>
                    </ul>
                    
                    <p><strong>æ“ä½œæ–¹æ³•ï¼š</strong></p>
                    <ul>
                        <li><strong>ãƒã‚¦ã‚¹ï¼š</strong> æ•°å­—ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ ãƒã‚¹ç›®ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                        <li><strong>ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ï¼š</strong> åå­—ã‚­ãƒ¼ï¼ˆâ†‘â†“â†â†’ï¼‰ã§ãƒã‚¹é¸æŠã€ãƒ†ãƒ³ã‚­ãƒ¼ï¼ˆ1-9/16ï¼‰ã§æ•°å­—å…¥åŠ›</li>
                        <li><strong>å‰Šé™¤ï¼š</strong> Deleteã‚­ãƒ¼ã¾ãŸã¯0ã‚­ãƒ¼ã§æ•°å­—ã‚’å‰Šé™¤</li>
                    </ul>
                    
                    <p><strong>ã‚¹ã‚³ã‚¢ï¼š</strong></p>
                    <ul>
                        <li>åŸºæœ¬ç‚¹ï¼š1000ç‚¹</li>
                        <li>çµŒéæ™‚é–“ï¼š1ç§’ã«ã¤ã-1ç‚¹</li>
                        <li>ãƒ’ãƒ³ãƒˆä½¿ç”¨ï¼š1å›ã«ã¤ã+100ç§’ã®ãƒšãƒŠãƒ«ãƒ†ã‚£</li>
                        <li>ãƒ’ãƒ³ãƒˆã¯2å›ã¾ã§ã€æ®‹ã‚Šãƒã‚¹2å€‹ä»¥ä¸‹ã§ã¯ä½¿ç”¨ä¸å¯</li>
                    </ul>
                </div>
                
                <div class="level-selector">
                    <h3>é›£æ˜“åº¦ã‚’é¸æŠã—ã¦ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆï¼</h3>
                    <div class="level-buttons">
                        <div class="level-btn" data-level="3x3-easy">3Ã—3 åˆç´š</div>
                        <div class="level-btn" data-level="3x3-normal">3Ã—3 ä¸­ç´š</div>
                        <div class="level-btn" data-level="4x4-easy">4Ã—4 ä¸­ç´š</div>
                        <div class="level-btn" data-level="4x4-normal">4Ã—4 ä¸Šç´š</div>
                    </div>

                </div>
            </div>
        </div>
        
        <div id="gameScreen" class="game-screen" style="display: none;">
            <div class="level-selector">
                <div class="level-btn active" data-level="3x3-easy" disabled>3Ã—3 åˆç´š</div>
                <div class="level-btn" data-level="3x3-normal" disabled>3Ã—3 ä¸­ç´š</div>
                <div class="level-btn" data-level="4x4-easy" disabled>4Ã—4 ä¸­ç´š</div>
                <div class="level-btn" data-level="4x4-normal" disabled>4Ã—4 ä¸Šç´š</div>
            </div>
        

        
        <div class="game-info">
            <div class="difficulty-badge difficulty-easy" id="difficultyBadge">ç°¡å˜</div>
        </div>
        

        
        <div class="score-info">
            <div class="score-item score" id="scoreDisplay">ã‚¹ã‚³ã‚¢: 1000</div>
            <div class="score-item time" id="timeDisplay">æ™‚é–“: 0ç§’</div>
            <div class="score-item hints" id="hintsDisplay">ãƒ’ãƒ³ãƒˆ: 2å›</div>
            <div class="score-item best" id="bestDisplay">ãƒ™ã‚¹ãƒˆ: 0</div>
        </div>
        
        <div class="game-layout">
            <div class="magic-square size-3" id="magicSquare"></div>
            <div class="used-numbers" id="usedNumbers">
                <h3>ä½¿ç”¨æ¸ˆã¿æ•°å­—</h3>
                <div class="used-numbers-grid size-3" id="usedNumbersGrid"></div>
                <div class="controls">
                    <button class="btn btn-back" onclick="backToStart()">ğŸ  æœ€åˆã«æˆ»ã‚‹</button>
                    <button class="btn btn-secondary" onclick="resetPuzzle()">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
                    <button class="btn btn-secondary" id="hintBtn" onclick="showHint()">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</button>
                    <button class="btn btn-primary" id="toggleDupBtn" onclick="toggleDuplicates()">é‡è¤‡è¨±å¯: ON</button>
                </div>
                <div class="penalty-display" id="penaltyDisplay" style="display: none;">
                    <div class="penalty-text">+100ç§’ãƒšãƒŠãƒ«ãƒ†ã‚£</div>
                </div>
            </div>
        </div>
        
        <div class="numbers-panel" id="numbersPanel"></div>
        
        <div class="status" id="status" aria-live="polite">æ•°å­—ã‚’é¸ã‚“ã§ãƒã‚¹ç›®ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</div>
        
        </div>
    </div>

    <script>
        let selectedNumber = null;
        let currentLevel = '3x3-easy';
        let board = [];
        let solution = [];
        let givenCells = [];
        let usedNumbers = new Set();
        let targetSum = 15;
        let size = 3;
        let startTime = null;
        let gameTimer = null;
        let hintsRemaining = 2;
        let gameCompleted = false;
        let selectedCell = { row: 0, col: 0 };
        let gameStarted = false;
        let hintPenalty = 0;
        let keyBuffer = '';
        let keyBufferTimer = null;
        const KEY_COMMIT_DELAY = 150;
        let allowDuplicates = true; // ãƒ‡ãƒ•ã‚©ã¯ãƒ‰ãƒ©ãƒ•ãƒˆï¼ˆé‡è¤‡è¨±å¯ï¼‰
        
        // ã‚¹ã‚³ã‚¢ä¿å­˜
        const STORE = 'mahousquare:v1';
        
        function readStore() {
            try {
                return JSON.parse(localStorage.getItem(STORE) || '{}');
            } catch {
                return {};
            }
        }
        
        function writeStore(obj) {
            localStorage.setItem(STORE, JSON.stringify(obj));
        }
        
        function recordScore(level, score) {
            const s = readStore();
            s.best = s.best || {};
            s.best[level] = Math.max(s.best[level] || 0, score);
            writeStore(s);
        }
        
        function getBestScore(level) {
            const s = readStore();
            return (s.best || {})[level] || 0;
        }
        

        
        // ãƒ‘ã‚ºãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
        const puzzleDatabase = {
            '3x3-easy': [
                {
                    solution: [[2, 7, 6], [9, 5, 1], [4, 3, 8]],
                    given: [[1, 1, 1], [1, 1, 0], [0, 0, 0]]
                },
                {
                    solution: [[8, 1, 6], [3, 5, 7], [4, 9, 2]],
                    given: [[1, 0, 1], [0, 1, 0], [1, 1, 0]]
                },
                {
                    solution: [[6, 1, 8], [7, 5, 3], [2, 9, 4]],
                    given: [[1, 0, 1], [1, 1, 0], [0, 1, 0]]
                },
                {
                    solution: [[4, 9, 2], [3, 5, 7], [8, 1, 6]],
                    given: [[1, 1, 0], [0, 1, 1], [1, 0, 0]]
                }
            ],
            '3x3-normal': [
                {
                    solution: [[8, 1, 6], [3, 5, 7], [4, 9, 2]],
                    given: [[0, 0, 1], [0, 1, 0], [1, 0, 0]]
                },
                {
                    solution: [[2, 7, 6], [9, 5, 1], [4, 3, 8]],
                    given: [[0, 0, 0], [1, 1, 0], [0, 0, 1]]
                },
                {
                    solution: [[6, 1, 8], [7, 5, 3], [2, 9, 4]],
                    given: [[1, 0, 0], [0, 1, 0], [0, 0, 0]]
                },
                {
                    solution: [[4, 3, 8], [9, 5, 1], [2, 7, 6]],
                    given: [[0, 1, 0], [0, 1, 0], [0, 0, 0]]
                }
            ],
            '4x4-easy': [
                {
                    solution: [[1, 15, 14, 4], [12, 6, 7, 9], [8, 10, 11, 5], [13, 3, 2, 16]],
                    given: [[1, 0, 0, 1], [1, 1, 1, 0], [0, 1, 1, 1], [1, 0, 0, 1]]
                },
                {
                    solution: [[16, 3, 2, 13], [5, 10, 11, 8], [9, 6, 7, 12], [4, 15, 14, 1]],
                    given: [[1, 0, 0, 0], [0, 1, 1, 1], [1, 0, 1, 1], [1, 1, 0, 1]]
                },
                {
                    solution: [[4, 14, 15, 1], [9, 7, 6, 12], [5, 11, 10, 8], [16, 2, 3, 13]],
                    given: [[0, 1, 0, 1], [1, 1, 0, 0], [0, 0, 1, 1], [1, 0, 1, 1]]
                },
                {
                    solution: [[13, 2, 3, 16], [8, 10, 11, 5], [12, 7, 6, 9], [1, 15, 14, 4]],
                    given: [[0, 0, 1, 1], [1, 1, 0, 0], [0, 1, 1, 1], [1, 0, 1, 0]]
                }
            ],
            '4x4-normal': [
                {
                    solution: [[16, 3, 2, 13], [5, 10, 11, 8], [9, 6, 7, 12], [4, 15, 14, 1]],
                    given: [[0, 1, 0, 0], [1, 0, 0, 1], [0, 0, 1, 0], [0, 0, 0, 0]]
                },
                {
                    solution: [[1, 15, 14, 4], [12, 6, 7, 9], [8, 10, 11, 5], [13, 3, 2, 16]],
                    given: [[0, 0, 1, 0], [0, 1, 0, 0], [1, 0, 0, 0], [0, 0, 0, 1]]
                },
                {
                    solution: [[4, 14, 15, 1], [9, 7, 6, 12], [5, 11, 10, 8], [16, 2, 3, 13]],
                    given: [[0, 0, 0, 1], [0, 1, 0, 0], [0, 0, 1, 0], [1, 0, 0, 0]]
                },
                {
                    solution: [[13, 2, 3, 16], [8, 10, 11, 5], [12, 7, 6, 9], [1, 15, 14, 4]],
                    given: [[0, 0, 0, 0], [1, 0, 0, 1], [0, 1, 0, 0], [0, 0, 1, 0]]
                }
            ]
        };
        

        
        function generatePuzzle(level) {
            const puzzleList = puzzleDatabase[level];
            const randomIndex = Math.floor(Math.random() * puzzleList.length);
            const selectedPuzzle = puzzleList[randomIndex];
            
            const size = level.includes('3x3') ? 3 : 4;
            const targetSum = size === 3 ? 15 : 34;
            const numbers = Array.from({length: size * size}, (_, i) => i + 1);
            
            // å•é¡Œã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å¤‰åŒ–ã•ã›ã‚‹
            const transformedPuzzle = randomTransformPuzzle(selectedPuzzle, size);
            
            return {
                size: size,
                targetSum: targetSum,
                numbers: numbers,
                solution: transformedPuzzle.solution,
                given: transformedPuzzle.given
            };
        }
        
        function randomTransformPuzzle(puzzle, size) {
            let solution = puzzle.solution.map(row => [...row]);
            let given = puzzle.given.map(row => [...row]);
            
            // ãƒ©ãƒ³ãƒ€ãƒ å¤‰æ›ã‚’é©ç”¨
            const transforms = [
                () => rotateMatrix(solution, given, size),
                () => flipHorizontal(solution, given, size),
                () => flipVertical(solution, given, size),
                () => transposeMatrix(solution, given, size)
            ];
            
            // ãƒ©ãƒ³ãƒ€ãƒ ã«1-3å€‹ã®å¤‰æ›ã‚’é©ç”¨
            const numTransforms = Math.floor(Math.random() * 3) + 1;
            for (let i = 0; i < numTransforms; i++) {
                const transform = transforms[Math.floor(Math.random() * transforms.length)];
                const result = transform();
                solution = result.solution;
                given = result.given;
            }
            
            return { solution, given };
        }
        
        function rotateMatrix(solution, given, size) {
            const newSolution = Array(size).fill().map(() => Array(size).fill(0));
            const newGiven = Array(size).fill().map(() => Array(size).fill(0));
            
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    newSolution[j][size - 1 - i] = solution[i][j];
                    newGiven[j][size - 1 - i] = given[i][j];
                }
            }
            
            return { solution: newSolution, given: newGiven };
        }
        
        function flipHorizontal(solution, given, size) {
            const newSolution = solution.map(row => [...row].reverse());
            const newGiven = given.map(row => [...row].reverse());
            return { solution: newSolution, given: newGiven };
        }
        
        function flipVertical(solution, given, size) {
            const newSolution = [...solution].reverse();
            const newGiven = [...given].reverse();
            return { solution: newSolution, given: newGiven };
        }
        
        function transposeMatrix(solution, given, size) {
            const newSolution = Array(size).fill().map(() => Array(size).fill(0));
            const newGiven = Array(size).fill().map(() => Array(size).fill(0));
            
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    newSolution[j][i] = solution[i][j];
                    newGiven[j][i] = given[i][j];
                }
            }
            
            return { solution: newSolution, given: newGiven };
        }
        
        function initGame() {
            showRulesScreen();
        }
        
        function showRulesScreen() {
            document.getElementById('rulesScreen').style.display = 'block';
            document.getElementById('gameScreen').style.display = 'none';
            gameStarted = false;
        }
        
        function startGame(level) {
            currentLevel = level;
            gameStarted = true;
            document.getElementById('rulesScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            setupLevel(currentLevel);
            updateLevelButtons();
            startTimer();
        }
        
        function setupLevel(level) {
            const puzzle = generatePuzzle(level);
            size = puzzle.size;
            targetSum = puzzle.targetSum;
            solution = puzzle.solution;
            givenCells = puzzle.given;
            
            // ãƒœãƒ¼ãƒ‰ã®åˆæœŸåŒ–
            board = Array(size).fill().map(() => Array(size).fill(0));
            usedNumbers.clear();
            selectedNumber = null;
            hintsRemaining = 2;
            gameCompleted = false;
            selectedCell = { row: 0, col: 0 };
            hintPenalty = 0;
            
            // ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
            if (gameTimer) {
                clearInterval(gameTimer);
            }
            startTime = null;
            
            // ä¸ãˆã‚‰ã‚ŒãŸæ•°å­—ã‚’é…ç½®
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    if (givenCells[i][j] === 1) {
                        board[i][j] = solution[i][j];
                        usedNumbers.add(solution[i][j]);
                    }
                }
            }
            
            createBoard();
            createNumbersPanel(puzzle.numbers);
            updateUI();
            updateCellSelection();
            updateDuplicateHighlights();
            updatePenaltyDisplay();
        }
        
        function createBoard() {
            const magicSquare = document.getElementById('magicSquare');
            magicSquare.innerHTML = '';
            magicSquare.className = `magic-square size-${size}`;
            
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    cell.setAttribute('role', 'gridcell');
                    cell.setAttribute('tabindex', '0');
                    cell.setAttribute('aria-label', `è¡Œ ${i + 1}, åˆ— ${j + 1}`);
                    
                    if (givenCells[i][j] === 1) {
                        cell.textContent = board[i][j];
                        cell.classList.add('given');
                        cell.setAttribute('aria-readonly', 'true');
                    }
                    
                    cell.addEventListener('click', () => {
                        selectedCell = { row: i, col: j };
                        updateCellSelection();
                        if (selectedNumber) {
                            placeNumber(i, j);
                        }
                    });
                    magicSquare.appendChild(cell);
                }
            }
            
            // ä½¿ç”¨æ¸ˆã¿æ•°å­—è¡¨ç¤ºã‚‚æ›´æ–°
            createUsedNumbersGrid();
        }
        
        function createUsedNumbersGrid() {
            const usedNumbersGrid = document.getElementById('usedNumbersGrid');
            usedNumbersGrid.innerHTML = '';
            usedNumbersGrid.className = `used-numbers-grid size-${size}`;
            
            const maxNumber = size * size;
            for (let i = 1; i <= maxNumber; i++) {
                const numberDiv = document.createElement('div');
                numberDiv.className = 'used-number';
                numberDiv.textContent = i;
                numberDiv.dataset.number = i;
                usedNumbersGrid.appendChild(numberDiv);
            }
            
            updateUsedNumbersDisplay();
        }
        
        function updateUsedNumbersDisplay() {
            document.querySelectorAll('.used-number').forEach(numberDiv => {
                const number = parseInt(numberDiv.dataset.number);
                numberDiv.classList.toggle('filled', usedNumbers.has(number));
            });
        }
        
        function createNumbersPanel(numbers) {
            const panel = document.getElementById('numbersPanel');
            panel.innerHTML = '';
            
            numbers.forEach(num => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'number-btn';
                btn.dataset.number = num;
                btn.textContent = num;
                btn.setAttribute('aria-label', `æ•°å­— ${num} ã‚’é¸æŠ`);
                btn.addEventListener('click', () => selectNumber(num));
                panel.appendChild(btn);
            });
        }
        
        function updateUI() {
            let difficultyText, difficultyClass;
            if (currentLevel === '3x3-easy') {
                difficultyText = 'åˆç´š';
                difficultyClass = 'difficulty-easy';
            } else if (currentLevel === '3x3-normal') {
                difficultyText = 'ä¸­ç´š';
                difficultyClass = 'difficulty-normal';
            } else if (currentLevel === '4x4-easy') {
                difficultyText = 'ä¸­ç´š';
                difficultyClass = 'difficulty-normal';
            } else {
                difficultyText = 'ä¸Šç´š';
                difficultyClass = 'difficulty-normal';
            }
            const badge = document.getElementById('difficultyBadge');
            badge.textContent = difficultyText;
            badge.className = `difficulty-badge ${difficultyClass}`;
            
            updateNumbersPanel();
            updateScoreDisplay();
            updateHintButton();
            updateStatus('æ•°å­—ã‚’é¸ã‚“ã§ãƒã‚¹ç›®ã‚’ã‚¯ãƒªãƒƒã‚¯ã€ã¾ãŸã¯ãƒ†ãƒ³ã‚­ãƒ¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
        }
        

        
        function updateCellSelection() {
            document.querySelectorAll('.cell').forEach(cell => {
                cell.classList.remove('selected');
                cell.setAttribute('aria-selected', 'false');
            });
            
            const selectedCellElement = document.querySelector(`[data-row="${selectedCell.row}"][data-col="${selectedCell.col}"]`);
            if (selectedCellElement) {
                selectedCellElement.classList.add('selected');
                selectedCellElement.setAttribute('aria-selected', 'true');
                selectedCellElement.focus();
            }
        }
        
        function startTimer() {
            if (!startTime && gameStarted) {
                startTime = Date.now();
                gameTimer = setInterval(updateScoreDisplay, 1000);
            }
        }
        

        
        function updateScoreDisplay() {
            const currentTime = startTime ? Math.floor((Date.now() - startTime) / 1000) + hintPenalty : 0;
            const currentScore = Math.max(0, 1000 - currentTime);
            const bestScore = getBestScore(currentLevel);
            
            document.getElementById('timeDisplay').textContent = `æ™‚é–“: ${currentTime}ç§’`;
            document.getElementById('scoreDisplay').textContent = `ã‚¹ã‚³ã‚¢: ${currentScore}`;
            document.getElementById('hintsDisplay').textContent = `ãƒ’ãƒ³ãƒˆ: ${hintsRemaining}å›`;
            document.getElementById('bestDisplay').textContent = `ãƒ™ã‚¹ãƒˆ: ${bestScore}`;
        }
        
        function updateHintButton() {
            const hintBtn = document.getElementById('hintBtn');
            const emptyCells = getEmptyCells();
            
            if (hintsRemaining <= 0 || emptyCells.length <= 2 || gameCompleted) {
                hintBtn.disabled = true;
                if (hintsRemaining <= 0) {
                    hintBtn.textContent = 'ğŸ’¡ ãƒ’ãƒ³ãƒˆ (ä½¿ç”¨æ¸ˆ)';
                } else if (emptyCells.length <= 2) {
                    hintBtn.textContent = 'ğŸ’¡ ãƒ’ãƒ³ãƒˆ (åˆ¶é™)';
                } else {
                    hintBtn.textContent = 'ğŸ’¡ ãƒ’ãƒ³ãƒˆ';
                }
            } else {
                hintBtn.disabled = false;
                hintBtn.textContent = 'ğŸ’¡ ãƒ’ãƒ³ãƒˆ';
            }
        }
        
        function getEmptyCells() {
            const emptyCells = [];
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    if (givenCells[i][j] === 0 && board[i][j] === 0) {
                        emptyCells.push([i, j]);
                    }
                }
            }
            return emptyCells;
        }
        
        function updateLevelButtons() {
            document.querySelectorAll('.level-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.level === currentLevel);
            });
        }
        
        function selectNumber(number) {
            document.querySelectorAll('.number-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            selectedNumber = number;
            document.querySelector(`[data-number="${number}"]`).classList.add('selected');
            updateStatus(`æ•°å­— ${number} ã‚’é¸æŠä¸­ - ãƒã‚¹ç›®ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„`);
        }
        
        function placeNumber(row, col, number = selectedNumber) {
            if (givenCells[row][col] === 1) {
                updateStatus('ãã®ãƒã‚¹ç›®ã¯å¤‰æ›´ã§ãã¾ã›ã‚“');
                return;
            }
            
            if (!number) {
                updateStatus('ã¾ãšæ•°å­—ã‚’é¸ã‚“ã§ãã ã•ã„');
                return;
            }
            
            // å³æ ¼ãƒ¢ãƒ¼ãƒ‰ã§é‡è¤‡ãƒã‚§ãƒƒã‚¯
            if (!allowDuplicates && isNumberUsedElsewhere(number, row, col)) {
                updateStatus(`æ•°å­— ${number} ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ï¼ˆå³æ ¼ãƒ¢ãƒ¼ãƒ‰ï¼‰`, 'error');
                return;
            }
            
            // æ—¢å­˜ã®æ•°å­—ã¨åŒã˜å ´åˆã¯ä½•ã‚‚ã—ãªã„
            if (board[row][col] === number) {
                return;
            }
            
            // ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹
            startTimer();
            
            // æ—¢ã«æ•°å­—ãŒå…¥ã£ã¦ã„ã‚‹å ´åˆã¯å‰Šé™¤
            if (board[row][col] !== 0) {
                usedNumbers.delete(board[row][col]);
            }
            
            // æ•°å­—ã‚’é…ç½®
            board[row][col] = number;
            
            // ä½¿ç”¨æ¸ˆã¿æ•°å­—ã‚’æ›´æ–°ï¼ˆç›¤é¢å…¨ä½“ã‚’ã‚¹ã‚­ãƒ£ãƒ³ï¼‰
            usedNumbers.clear();
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    if (board[i][j] !== 0) {
                        usedNumbers.add(board[i][j]);
                    }
                }
            }
            
            // è¡¨ç¤ºã‚’æ›´æ–°
            const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
            cell.textContent = number;
            cell.classList.remove('error');
            cell.classList.add('filled');
            
            // é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒã‚¦ã‚¹æ“ä½œã®å ´åˆã®ã¿ï¼‰
            if (number === selectedNumber) {
                document.querySelectorAll('.number-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                selectedNumber = null;
            }
            
            updateNumbersPanel();
            updateUsedNumbersDisplay();
            updateDuplicateHighlights();
            updateHintButton();
            
            // å®Œæˆãƒã‚§ãƒƒã‚¯
            if (isBoardComplete()) {
                setTimeout(() => {
                    checkSolution();
                }, 500);
            } else {
                updateStatus('æ¬¡ã®æ•°å­—ã‚’é¸ã‚“ã§ãã ã•ã„');
            }
        }
        
        function deleteNumber(row, col) {
            if (givenCells[row][col] === 1) {
                updateStatus('ãã®ãƒã‚¹ç›®ã¯å¤‰æ›´ã§ãã¾ã›ã‚“');
                return;
            }
            
            if (board[row][col] !== 0) {
                board[row][col] = 0;
                
                // ä½¿ç”¨æ¸ˆã¿æ•°å­—ã‚’æ›´æ–°ï¼ˆç›¤é¢å…¨ä½“ã‚’ã‚¹ã‚­ãƒ£ãƒ³ï¼‰
                usedNumbers.clear();
                for (let i = 0; i < size; i++) {
                    for (let j = 0; j < size; j++) {
                        if (board[i][j] !== 0) {
                            usedNumbers.add(board[i][j]);
                        }
                    }
                }
                
                const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                cell.textContent = '';
                cell.classList.remove('filled', 'error');
                
                updateNumbersPanel();
                updateUsedNumbersDisplay();
                updateDuplicateHighlights();
                updateHintButton();
                updateStatus('æ•°å­—ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            }
        }
        
        function isBoardComplete() {
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    if (board[i][j] === 0) return false;
                }
            }
            return true;
        }
        
        function updateNumbersPanel() {
            document.querySelectorAll('.number-btn').forEach(btn => {
                const number = parseInt(btn.dataset.number, 10);
                const used = usedNumbers.has(number);
                
                if (allowDuplicates) {
                    // ãƒ‰ãƒ©ãƒ•ãƒˆï¼šä½•åº¦ã§ã‚‚é¸ã¹ã‚‹
                    btn.classList.remove('used', 'strict');
                    btn.disabled = false;
                } else {
                    // å³æ ¼ï¼šä½¿ã£ãŸæ•°å­—ã¯ä½¿ãˆãªã„
                    btn.classList.toggle('used', used);
                    btn.classList.toggle('strict', used);
                    btn.disabled = used;
                }
            });
        }
        
        function checkSolution() {
            let isCorrect = true;
            const errors = [];
            
            // è¡Œã®åˆè¨ˆã‚’ãƒã‚§ãƒƒã‚¯
            for (let i = 0; i < size; i++) {
                const rowSum = board[i].reduce((sum, val) => sum + val, 0);
                if (rowSum !== targetSum) {
                    isCorrect = false;
                    for (let j = 0; j < size; j++) {
                        errors.push([i, j]);
                    }
                }
            }
            
            // åˆ—ã®åˆè¨ˆã‚’ãƒã‚§ãƒƒã‚¯
            for (let j = 0; j < size; j++) {
                let colSum = 0;
                for (let i = 0; i < size; i++) {
                    colSum += board[i][j];
                }
                if (colSum !== targetSum) {
                    isCorrect = false;
                    for (let i = 0; i < size; i++) {
                        errors.push([i, j]);
                    }
                }
            }
            
            // å¯¾è§’ç·šã®åˆè¨ˆã‚’ãƒã‚§ãƒƒã‚¯
            let diag1Sum = 0, diag2Sum = 0;
            for (let i = 0; i < size; i++) {
                diag1Sum += board[i][i];
                diag2Sum += board[i][size - 1 - i];
            }
            
            if (diag1Sum !== targetSum) {
                isCorrect = false;
                for (let i = 0; i < size; i++) {
                    errors.push([i, i]);
                }
            }
            
            if (diag2Sum !== targetSum) {
                isCorrect = false;
                for (let i = 0; i < size; i++) {
                    errors.push([i, size - 1 - i]);
                }
            }
            
            // ã“ã“ã§é‡è¤‡ã®æœ‰ç„¡ã‚’ç¢ºèª
            const counts = getNumberCounts();
            let hasDup = false;
            counts.forEach(c => { if (c > 1) hasDup = true; });
            
            // è¡¨ç¤ºåˆæœŸåŒ–
            document.querySelectorAll('.cell').forEach(cell => {
                cell.classList.remove('correct', 'error');
            });
            updateDuplicateHighlights(); // å¸¸ã«æœ€æ–°è¡¨ç¤º
            
            if (isBoardComplete()) {
                if (!allowDuplicates && hasDup) {
                    // å³æ ¼ãƒ¢ãƒ¼ãƒ‰ï¼šé‡è¤‡ãŒã‚ã‚Œã°ä¸æ­£è§£
                    isCorrect = false;
                    updateStatus('âŒ é‡è¤‡ã—ã¦ã„ã‚‹æ•°å­—ãŒã‚ã‚Šã¾ã™ï¼ˆé»„è‰²ï¼‰ã‚’è§£æ¶ˆã—ã¦ãã ã•ã„', 'error');
                    return;
                }
                if (isCorrect) {
                    // ã‚¯ãƒªã‚¢
                    gameCompleted = true;
                    if (gameTimer) clearInterval(gameTimer);
                    const finalTime = Math.floor((Date.now() - startTime) / 1000) + hintPenalty;
                    const finalScore = Math.max(0, 1000 - finalTime);
                    
                    // ã‚¹ã‚³ã‚¢è¨˜éŒ²
                    const oldBest = getBestScore(currentLevel);
                    const isNewRecord = finalScore > oldBest;
                    recordScore(currentLevel, finalScore);
                    
                    document.querySelectorAll('.cell').forEach(cell => {
                        cell.classList.add('correct');
                    });
                    updateHintButton();
                    updateScoreDisplay();
                    
                    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
                    showCompletionPopup(finalScore, isNewRecord, oldBest);
                } else {
                    // å’Œã®é–“é•ã„
                    updateStatus('âŒ é–“é•ã„ãŒã‚ã‚Šã¾ã™ã€‚èµ¤ã„ãƒã‚¹ç›®ã‚’ç¢ºèªã—ã¦ãã ã•ã„', 'error');
                    errors.forEach(([r, c]) => {
                        const cell = document.querySelector(`[data-row="${r}"][data-col="${c}"]`);
                        if (cell) cell.classList.add('error');
                    });
                }
            } else {
                updateStatus('ã¾ã ã™ã¹ã¦ã®ãƒã‚¹ç›®ãŒåŸ‹ã¾ã£ã¦ã„ã¾ã›ã‚“', 'info');
            }
        }
        
        function resetPuzzle() {
            setupLevel(currentLevel);
        }
        
        function showHint() {
            if (hintsRemaining <= 0) {
                updateStatus('âŒ ãƒ’ãƒ³ãƒˆã¯ã™ã¹ã¦ä½¿ç”¨æ¸ˆã¿ã§ã™', 'error');
                return;
            }
            
            const emptyCells = getEmptyCells();
            
            if (emptyCells.length <= 2) {
                updateStatus('âŒ æ®‹ã‚Šãƒã‚¹ãŒ2ã¤ä»¥ä¸‹ã®ãŸã‚ãƒ’ãƒ³ãƒˆã¯ä½¿ç”¨ã§ãã¾ã›ã‚“', 'error');
                return;
            }
            
            if (gameCompleted) {
                updateStatus('âŒ ã‚²ãƒ¼ãƒ ã¯æ—¢ã«å®Œäº†ã—ã¦ã„ã¾ã™', 'error');
                return;
            }
            
            // ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹
            startTimer();
            
            if (emptyCells.length > 0) {
                const [row, col] = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                const correctNumber = solution[row][col];
                hintsRemaining--;
                hintPenalty += 100; // 100ç§’ã®ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’è¿½åŠ 
                
                // æ•°å­—ã‚’è‡ªå‹•ã§å…¥åŠ›
                board[row][col] = correctNumber;
                
                // ä½¿ç”¨æ¸ˆã¿æ•°å­—ã‚’æ›´æ–°ï¼ˆç›¤é¢å…¨ä½“ã‚’ã‚¹ã‚­ãƒ£ãƒ³ï¼‰
                usedNumbers.clear();
                for (let i = 0; i < size; i++) {
                    for (let j = 0; j < size; j++) {
                        if (board[i][j] !== 0) {
                            usedNumbers.add(board[i][j]);
                        }
                    }
                }
                
                // è¡¨ç¤ºã‚’æ›´æ–°
                const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                cell.textContent = correctNumber;
                cell.classList.remove('error');
                cell.classList.add('filled');
                
                // ãƒ’ãƒ³ãƒˆåŠ¹æœã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                cell.style.background = '#fef5e7';
                cell.style.borderColor = '#f6ad55';
                setTimeout(() => {
                    cell.style.background = '';
                    cell.style.borderColor = '';
                }, 2000);
                
                updateNumbersPanel();
                updateUsedNumbersDisplay();
                updateDuplicateHighlights();
                updateScoreDisplay();
                updateHintButton();
                updatePenaltyDisplay();
                
                updateStatus(`ğŸ’¡ ãƒ’ãƒ³ãƒˆä½¿ç”¨: (${row + 1}, ${col + 1}) ã« ${correctNumber} ã‚’å…¥åŠ›ã—ã¾ã—ãŸ (+100ç§’ãƒšãƒŠãƒ«ãƒ†ã‚£)`, 'info');
                
                // å®Œæˆãƒã‚§ãƒƒã‚¯
                if (isBoardComplete()) {
                    setTimeout(() => {
                        checkSolution();
                    }, 500);
                }
            } else {
                updateStatus('ğŸ’¡ ã™ã¹ã¦ã®ãƒã‚¹ç›®ãŒåŸ‹ã¾ã£ã¦ã„ã¾ã™ï¼', 'info');
            }
        }
        
        function updateStatus(message, type = '') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        function updatePenaltyDisplay() {
            const penaltyDisplay = document.getElementById('penaltyDisplay');
            if (hintPenalty > 0) {
                penaltyDisplay.style.display = 'block';
                penaltyDisplay.querySelector('.penalty-text').textContent = `+${hintPenalty}ç§’ãƒšãƒŠãƒ«ãƒ†ã‚£`;
            } else {
                penaltyDisplay.style.display = 'none';
            }
        }
        
        function showCompletionPopup(finalScore, isNewRecord, oldBest) {
            const popup = document.createElement('div');
            popup.className = 'completion-popup';
            
            const content = document.createElement('div');
            content.className = 'completion-content';
            
            content.innerHTML = `
                <div class="completion-title">ğŸ‰ ãŠã‚ã§ã¨ã†ï¼</div>
                <div class="completion-score">æœ€çµ‚ã‚¹ã‚³ã‚¢: ${finalScore}ç‚¹</div>
                ${isNewRecord ? '<div class="completion-record">ğŸ†• æ–°è¨˜éŒ²é”æˆï¼</div>' : ''}
                <div class="completion-best">ãƒ™ã‚¹ãƒˆã‚¹ã‚³ã‚¢: ${Math.max(finalScore, oldBest)}ç‚¹</div>
                <button class="btn btn-primary" onclick="closeCompletionPopup(); backToStart();">æœ€åˆã«æˆ»ã‚‹</button>
            `;
            
            popup.appendChild(content);
            document.body.appendChild(popup);
        }
        
        function closeCompletionPopup() {
            const popup = document.querySelector('.completion-popup');
            if (popup) {
                popup.remove();
            }
        }
        
        function toggleDuplicates() {
            allowDuplicates = !allowDuplicates;
            document.getElementById('toggleDupBtn').textContent = 
                `é‡è¤‡è¨±å¯: ${allowDuplicates ? 'ON' : 'OFF'}`;
            updateNumbersPanel();        // å³æ ¼æ™‚ã¯ä½¿ç”¨æ¸ˆã¿ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            updateDuplicateHighlights(); // è¡¨ç¤ºã‚’æœ€æ–°åŒ–
            updateStatus(allowDuplicates
                ? 'é‡è¤‡ã‚’è¨±å¯ã—ã¾ã—ãŸï¼ˆãƒ‰ãƒ©ãƒ•ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼‰'
                : 'é‡è¤‡ã‚’ç¦æ­¢ã—ã¾ã—ãŸï¼ˆå³æ ¼ãƒ¢ãƒ¼ãƒ‰ï¼‰', 'info');
        }
        
        function isNumberUsedElsewhere(num, row, col) {
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    if ((i !== row || j !== col) && board[i][j] === num) return true;
                }
            }
            return false;
        }
        
        function getNumberCounts() {
            const counts = new Map();
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    const v = board[i][j];
                    if (v > 0) counts.set(v, (counts.get(v) || 0) + 1);
                }
            }
            return counts;
        }
        

        
        function updateDuplicateHighlights() {
            const counts = getNumberCounts();
            // ç›¤é¢ã‚»ãƒ«ã®é‡è¤‡ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            document.querySelectorAll('.cell').forEach(c => c.classList.remove('dup'));
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    const v = board[i][j];
                    if (v > 0 && counts.get(v) > 1) {
                        const cell = document.querySelector(`[data-row="${i}"][data-col="${j}"]`);
                        if (cell) cell.classList.add('dup');
                    }
                }
            }
            // ä½¿ç”¨æ¸ˆã¿æ•°å­—ã‚°ãƒªãƒƒãƒ‰ã®é‡è¤‡ãƒãƒƒã‚¸
            document.querySelectorAll('.used-number').forEach(div => {
                const n = parseInt(div.dataset.number, 10);
                const c = counts.get(n) || 0;
                div.classList.toggle('dup', c > 1);
                if (c > 1) { 
                    div.setAttribute('data-count', c); 
                } else { 
                    div.removeAttribute('data-count'); 
                }
            });
        }
        

        
        function backToStart() {
            // ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            if (gameTimer) {
                clearInterval(gameTimer);
            }
            gameStarted = false;
            startTime = null;
            gameCompleted = false;
            

            
            // ãƒ«ãƒ¼ãƒ«ç”»é¢ã«æˆ»ã‚‹
            showRulesScreen();
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        document.addEventListener('DOMContentLoaded', function() {
            // ãƒ«ãƒ¼ãƒ«ç”»é¢ã®ãƒ¬ãƒ™ãƒ«é¸æŠãƒœã‚¿ãƒ³
            document.querySelectorAll('#rulesScreen .level-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    startGame(this.dataset.level);
                });
                

            });
            
            // ã‚²ãƒ¼ãƒ ç”»é¢ã®ãƒ¬ãƒ™ãƒ«é¸æŠãƒœã‚¿ãƒ³ï¼ˆç„¡åŠ¹åŒ–ï¼‰
            document.querySelectorAll('#gameScreen .level-btn').forEach(btn => {
                btn.style.pointerEvents = 'none';
                btn.style.opacity = '0.6';
            });
            

            
            // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆ
            document.addEventListener('keydown', function(e) {
                if (!gameStarted || gameCompleted) return;
                
                // åå­—ã‚­ãƒ¼ã§ã‚»ãƒ«é¸æŠ
                if (e.key === 'ArrowUp' && selectedCell.row > 0) {
                    selectedCell.row--;
                    updateCellSelection();
                    e.preventDefault();
                } else if (e.key === 'ArrowDown' && selectedCell.row < size - 1) {
                    selectedCell.row++;
                    updateCellSelection();
                    e.preventDefault();
                } else if (e.key === 'ArrowLeft' && selectedCell.col > 0) {
                    selectedCell.col--;
                    updateCellSelection();
                    e.preventDefault();
                } else if (e.key === 'ArrowRight' && selectedCell.col < size - 1) {
                    selectedCell.col++;
                    updateCellSelection();
                    e.preventDefault();
                }
                
                // æ•°å­—ã‚­ãƒ¼ï¼ˆ1ã€œ9/16ï¼‰å…¥åŠ›ã‚’ãƒãƒƒãƒ•ã‚¡ã—ã¦ç¢ºå®š
                if (/^\d$/.test(e.key)) {
                    keyBuffer += e.key;
                    clearTimeout(keyBufferTimer);
                    keyBufferTimer = setTimeout(() => {
                        const num = parseInt(keyBuffer, 10);
                        keyBuffer = '';
                        const max = (size === 3) ? 9 : 16;
                        if (!isNaN(num) && num >= 1 && num <= max) {
                            placeNumber(selectedCell.row, selectedCell.col, num);
                        }
                    }, KEY_COMMIT_DELAY);
                    e.preventDefault();
                }
                
                // å‰Šé™¤ã‚­ãƒ¼
                if (e.key === 'Backspace' || e.key === 'Delete' || e.key === '0') {
                    deleteNumber(selectedCell.row, selectedCell.col);
                    e.preventDefault();
                }
            });
            
            initGame();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9731dacc6787d1bd',t:'MTc1NTg2MDMwMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
