<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒãƒˆãƒ« - å­¦ç¿’ã‚²ãƒ¼ãƒ </title>
    <link href="https://fonts.googleapis.com/css2?family=BIZ+UDGothic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* å®‰å…¨é ˜åŸŸï¼ˆiPad/iPhoneãƒãƒƒãƒï¼‰ */
        :root{
            --safe-top: env(safe-area-inset-top);
            --safe-right: env(safe-area-inset-right);
            --safe-bottom: env(safe-area-inset-bottom);
            --safe-left: env(safe-area-inset-left);
        }

        body {
            font-family: 'BIZ UDGothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
        }

        .game-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* ãƒˆãƒƒãƒ—ãƒãƒ¼ï¼šå·¦å³ã«HPã€ä¸­å¤®ã«ã‚¿ãƒ¼ãƒ³/ã‚¿ã‚¤ãƒãƒ¼ */
        .top-bar{
            min-height: 80px;
            padding: calc(8px + var(--safe-top)) clamp(12px, 2vw, 24px) 8px clamp(12px, 2vw, 24px);
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.2);

            /* Grid ã§å·¦å³ç«¯ã«å›ºå®š */
            display: grid;
            grid-template-columns: 1fr auto 1fr; /* å·¦ HP | ä¸­å¤® info | å³ HP */
            align-items: center;
            gap: 12px;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 0;          /* ç«¯ã«å¯„ã›ã‚‹ãŸã‚æœ€å°å¹…åˆ¶ç´„ã‚’å¤–ã™ */
            justify-self: start;   /* å·¦å´ã¯å·¦ç«¯ã¸ */
        }

        .player-info:last-child{
            justify-self: end;     /* å³å´ã¯å³ç«¯ã¸ */
            flex-direction: row-reverse; /* ã‚¢ã‚¤ã‚³ãƒ³ã‚’å³å¯„ã›ã®ã¾ã¾ã«ã™ã‚‹ */
        }

        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .player-stats {
            flex: 1;
        }

        .player-name {
            font-weight: 700;
            color: white;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .hp-bar-container {
            width: 200px;
            height: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .hp-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #feca57);
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .hp-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .center-info {
            text-align: center;
            color: white;
            justify-self: center;
        }

        .turn-display {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .phase-display {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .timer-ring {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: conic-gradient(#feca57 0deg, rgba(255, 255, 255, 0.2) 0deg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            color: white;
            margin: 0 auto;
        }

        /* ã‚«ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ */
        .card-area {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
        }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹æœ­ã‚¨ãƒªã‚¢ï¼ˆå·¦å³ã«é…ç½®ï¼‰ */
        .player-hand {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 100px;
            height: 400px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            z-index: 10;
        }

        .player-hand.left {
            left: 20px;
        }

        .player-hand.right {
            right: 20px;
        }

        .hand-card {
            width: 90px;
            height: 70px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 6px;
            text-align: center;
            font-size: 11px;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transform: translateX(10px);
            opacity: 0.7;
            transition: all 0.3s ease;
        }

        .hand-card:hover {
            transform: translateX(0);
            opacity: 1;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .main-cards-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
        }

        .cards-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            max-width: 800px;
            margin: 0 auto;
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.5s ease;
        }

        .cards-container.active {
            opacity: 1;
            transform: translateY(0);
        }

        .card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(15px);
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* æ”»æ’ƒã‚«ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ */
        .card.attack {
            background: linear-gradient(145deg, rgba(255, 107, 107, 0.3), rgba(255, 159, 243, 0.2));
            border: 3px solid rgba(255, 107, 107, 0.5);
            box-shadow: 0 8px 32px rgba(255, 107, 107, 0.2);
        }

        .card.attack:hover {
            border-color: rgba(255, 107, 107, 0.8);
            box-shadow: 0 20px 40px rgba(255, 107, 107, 0.3);
        }

        /* å›å¾©ã‚«ãƒ¼ãƒ‰ */
        .card.heal {
            background: linear-gradient(145deg, rgba(76, 175, 80, 0.3), rgba(129, 199, 132, 0.2));
            border: 3px solid rgba(76, 175, 80, 0.6);
            box-shadow: 0 8px 32px rgba(76, 175, 80, 0.2);
        }

        .card.heal:hover {
            border-color: rgba(76, 175, 80, 0.9);
            box-shadow: 0 20px 40px rgba(76, 175, 80, 0.4);
        }

        .card.heal .card-text {
            color: #e8f5e8;
        }

        .card.heal .card-difficulty {
            color: #a5d6a7;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .card:hover::before {
            transform: translateX(100%);
        }

        .card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            border-color: rgba(254, 202, 87, 0.6);
        }

        .card.selected {
            border-color: #feca57;
            box-shadow: 0 0 30px rgba(254, 202, 87, 0.8);
            transform: scale(1.1) translateY(-15px);
            background: linear-gradient(145deg, rgba(254, 202, 87, 0.3), rgba(255, 159, 243, 0.2));
            animation: cardSelect 0.6s ease;
        }

        @keyframes cardSelect {
            0% { transform: scale(1) translateY(0); }
            50% { transform: scale(1.15) translateY(-20px) rotateY(10deg); }
            100% { transform: scale(1.1) translateY(-15px); }
        }

        .card-text {
            font-size: 24px;
            font-weight: 700;
            color: white;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.05em;
        }

        .card-difficulty {
            font-size: 14px;
            color: #feca57;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        /* ã‚¿ã‚¤ãƒ”ãƒ³ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .typing-display {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px 20px calc(20px + var(--safe-bottom)) 20px;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            max-width: 600px;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
            margin: 15px auto;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #feca57);
            width: 0%;
            transition: width 0.2s ease;
        }

        .keyboard-hint {
            margin-top: 15px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-family: 'BIZ UDGothic', sans-serif;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #feca57, #ff9ff3);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ */
        .controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            width: 90%;
        }

        .modal h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .modal p {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        /* ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .damage-number {
            position: absolute;
            font-size: 32px;
            font-weight: 900;
            color: #ff6b6b;
            pointer-events: none;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 100;
            animation: damageFloat 1.5s ease-out forwards;
        }

        .damage-number.heal {
            color: #4ecdc4;
        }

        @keyframes damageFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(0.5);
            }
            20% {
                transform: translateY(-10px) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translateY(-80px) scale(0.8);
            }
        }

        /* ã‚¿ãƒ¼ãƒ³åˆ‡ã‚Šæ›¿ãˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
        .turn-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, rgba(254, 202, 87, 0.95), rgba(255, 159, 243, 0.95));
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 30px 50px;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: turnPopup 2s ease-in-out forwards;
        }

        .turn-popup h2 {
            font-size: 28px;
            font-weight: 900;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            margin: 0;
        }

        @keyframes turnPopup {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            20% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1);
            }
            80% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
        }

        /* å±æ€§ã‚«ãƒ©ãƒ¼ */
        .fire { --attr-color: #ff6b6b; }
        .water { --attr-color: #4ecdc4; }
        .thunder { --attr-color: #ffe66d; }
        .wind { --attr-color: #95e1d3; }
        .earth { --attr-color: #a8e6cf; }
        .light { --attr-color: #ffd93d; }

        /* ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        .fx-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 1000;
            overflow: hidden;
        }

        /* æ”»æ’ƒã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .charge-effect {
            position: absolute;
            border-radius: 50%;
            will-change: transform, opacity;
            contain: layout paint;
        }

        .projectile {
            position: absolute;
            will-change: transform, opacity;
            contain: layout paint;
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            will-change: transform, opacity;
            contain: layout paint;
        }

        .impact-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            will-change: opacity;
        }

        /* å¼·ã„ã‚·ã‚§ã‚¤ã‚¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .shake-strong {
            animation: shakeStrong 0.4s ease-in-out;
        }

        @keyframes shakeStrong {
            0%, 100% { transform: translate3d(0, 0, 0); }
            10% { transform: translate3d(-8px, -4px, 0); }
            20% { transform: translate3d(6px, -8px, 0); }
            30% { transform: translate3d(-6px, 4px, 0); }
            40% { transform: translate3d(8px, 6px, 0); }
            50% { transform: translate3d(-4px, -6px, 0); }
            60% { transform: translate3d(6px, 8px, 0); }
            70% { transform: translate3d(-8px, -2px, 0); }
            80% { transform: translate3d(4px, -8px, 0); }
            90% { transform: translate3d(-6px, 6px, 0); }
        }

        /* æºœã‚ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        @keyframes chargeGlow {
            0% { 
                transform: scale(1);
                box-shadow: 0 0 10px var(--glow-color);
            }
            50% { 
                transform: scale(1.15);
                box-shadow: 0 0 30px var(--glow-color), 0 0 60px var(--glow-color);
            }
            100% { 
                transform: scale(1.2);
                box-shadow: 0 0 40px var(--glow-color), 0 0 80px var(--glow-color);
            }
        }

        /* ç«çƒã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes fireball {
            0% { 
                transform: scale(0.5) rotate(0deg);
                opacity: 1;
            }
            100% { 
                transform: scale(1.2) rotate(360deg);
                opacity: 0.8;
            }
        }

        /* æ°´åˆƒã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes waterBlade {
            0% { 
                transform: scaleX(0) rotate(-15deg);
                opacity: 1;
            }
            100% { 
                transform: scaleX(1) rotate(15deg);
                opacity: 0.9;
            }
        }

        /* é›·ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes lightning {
            0%, 100% { opacity: 0; }
            10%, 30%, 50%, 70%, 90% { opacity: 1; }
            20%, 40%, 60%, 80% { opacity: 0.3; }
        }

        /* é¢¨åˆƒã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes windBlade {
            0% { 
                transform: scale(0) rotate(0deg);
                opacity: 0.8;
            }
            100% { 
                transform: scale(1.5) rotate(180deg);
                opacity: 0.3;
            }
        }

        /* å²©æŸ±ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes rockSpike {
            0% { 
                transform: scaleY(0) translateY(50px);
                opacity: 1;
            }
            100% { 
                transform: scaleY(1) translateY(0);
                opacity: 0.9;
            }
        }

        /* å…‰ç·šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes lightBeam {
            0% { 
                transform: scaleX(0);
                opacity: 1;
            }
            50% { 
                transform: scaleX(1);
                opacity: 1;
            }
            100% { 
                transform: scaleX(1.2);
                opacity: 0.7;
            }
        }

        /* ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«çˆ†ç™º */
        @keyframes particleExplode {
            0% { 
                transform: scale(0) translate3d(0, 0, 0);
                opacity: 1;
            }
            100% { 
                transform: scale(1) translate3d(var(--dx), var(--dy), 0);
                opacity: 0;
            }
        }

        /* ãƒªãƒƒãƒ—ãƒ«åŠ¹æœ */
        @keyframes ripple {
            0% { 
                transform: scale(0);
                opacity: 0.8;
            }
            100% { 
                transform: scale(3);
                opacity: 0;
            }
        }

        /* ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæ¼”å‡º */
        .roulette-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2500;
        }

        .roulette-container {
            text-align: center;
            color: white;
            position: relative;
        }

        .roulette-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .roulette-wheel {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(90deg, #ff6b6b 50%, #4ecdc4 50%);
            border: 6px solid #feca57;
            position: relative;
            margin: 0 auto 30px auto;
            box-shadow: 0 0 30px rgba(254, 202, 87, 0.5);
        }

        .roulette-pointer {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-top: 24px solid #feca57;
            z-index: 10;
        }

        .roulette-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: #feca57;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            border: 3px solid white;
            z-index: 5;
        }

        .player-info-simple {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 400px;
            margin: 0 auto 20px auto;
            gap: 40px;
        }

        .player-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px 20px;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.3);
            min-width: 140px;
        }

        .player-card.left {
            border-color: #ff6b6b;
        }

        .player-card.right {
            border-color: #4ecdc4;
        }

        .player-avatar-simple {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .player-name-simple {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .player-side {
            font-size: 12px;
            opacity: 0.8;
        }

        .roulette-spinning {
            animation: rouletteSpin 2s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
        }

        .roulette-result {
            font-size: 20px;
            font-weight: 700;
            margin-top: 15px;
            opacity: 0;
            animation: resultFadeIn 0.5s ease-out 2.2s forwards;
        }

        @keyframes rouletteSpin {
            0% { transform: rotate(0deg); }
            70% { transform: rotate(1080deg); }
            100% { transform: rotate(var(--final-rotation, 1170deg)); }
        }

        @keyframes resultFadeIn {
            from { 
                opacity: 0;
                transform: translateY(20px) scale(0.8);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œ */
        @media (prefers-reduced-motion: reduce) {
            .shake-strong {
                animation: none;
            }
            
            .impact-flash {
                opacity: 0.3 !important;
            }
            
            @keyframes shakeStrong {
                0%, 100% { transform: translate3d(0, 0, 0); }
            }

            .roulette-spinning {
                animation: rouletteSpinReduced 1s ease-out forwards;
            }

            @keyframes rouletteSpinReduced {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(var(--final-rotation, 180deg)); }
            }
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–èª¿æ•´ */
        @media (max-width: 1024px) {
            .cards-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .cards-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .top-bar {
                height: 60px;
                padding: 0 10px;
            }
            
            .player-info {
                min-width: 200px;
            }
            
            .hp-bar-container {
                width: 150px;
            }

            .player-setup-container {
                flex-direction: column;
                gap: 20px;
            }

            .character-selection {
                grid-template-columns: repeat(6, 1fr);
                max-width: 100%;
            }
        }

        .hidden {
            display: none !important;
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* å•é¡Œãƒ†ã‚­ã‚¹ãƒˆã®ä¸Šä¸‹é–“éš”ã‚‚å¾®èª¿æ•´ */
        .typing-guide {
            text-align: center;
            color: white;
            margin-bottom: 10px;
            user-select: none;
        }
        .typing-guide .jp {
            font-size: 32px;
            line-height: 1.1;
            letter-spacing: .06em;
            font-weight: 700;
        }
        @media (min-width: 1024px){ .typing-guide .jp { font-size: 40px; } }

        .typing-guide .sub {
            font-size: 14px;
            opacity: .9;
            margin-top: 6px;
            letter-spacing: .08em;
        }

        /* ä¸Šæ®µï¼šå·¦ã‹ã‚‰è‰²ãŒæº€ã¡ã‚‹ï¼ˆæ–‡å­—å˜ä½ã˜ã‚ƒãªã"é¢"ã§ã‚¹ãƒ¼ãƒƒã¨ï¼‰ */
        .jp-progress {
            display: inline-block;
            background: linear-gradient(
                90deg,
                #feca57 var(--fill, 0%),
                rgba(255,255,255,.95) var(--fill, 0%)
            );
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            transition: background .12s linear;
        }

        /* ä¸‹æ®µï¼š1æ–‡å­—ãšã¤ç‚¹ç¯ */
        .sub .char { padding: 0 .06em; transition: color .08s, transform .04s; }
        .sub .char.matched { color: #feca57; }
        .sub .char.current { border-bottom: 2px solid #feca57; }
        .sub .char.pending { color: rgba(255,255,255,.85); opacity: .75; }

        /* ãƒ­ãƒ¼ãƒå­—ã‚¬ã‚¤ãƒ‰ */
        .romaji-guide {
            text-align: center;
            color: white;
            margin-bottom: 8px;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 0.1em;
            min-height: 40px;
        }

        .romaji-char {
            display: inline-block;
            padding: 0 2px;
            transition: color 0.1s ease;
        }

        .romaji-char.typed {
            color: #feca57;
        }

        .romaji-char.current {
            background: rgba(254, 202, 87, 0.3);
            border-radius: 4px;
        }

        /* ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ */
        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1500;
        }

        .countdown-number {
            font-size: 120px;
            font-weight: 900;
            color: #feca57;
            text-shadow: 0 0 30px rgba(254, 202, 87, 0.5);
            animation: countdownPulse 1s ease-in-out;
        }

        @keyframes countdownPulse {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* ã‚²ãƒ¼ãƒ é–‹å§‹ç”»é¢ */
        .start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .start-content {
            text-align: center;
            color: white;
        }

        .start-content h1 {
            font-size: 36px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .mode-selection {
            display: flex;
            gap: 40px;
            margin-bottom: 25px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 15px 35px;
            background: rgba(255, 255, 255, 0.2);
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
            text-align: center;
            font-size: 16px;
        }

        .mode-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .mode-btn.selected {
            background: rgba(254, 202, 87, 0.3);
            border-color: #feca57;
            box-shadow: 0 0 30px rgba(254, 202, 87, 0.5);
        }

        .mode-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .mode-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .mode-desc {
            font-size: 12px;
            opacity: 0.8;
        }

        .player-setup-container {
            display: flex;
            gap: 50px;
            justify-content: center;
            align-items: flex-start;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .player-setup {
            flex: 1;
            max-width: 350px;
            min-width: 300px;
            text-align: center;
        }

        .character-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
            max-width: 280px;
            margin-left: auto;
            margin-right: auto;
        }

        .character-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .character-btn.selected {
            border-color: #feca57;
            box-shadow: 0 0 20px rgba(254, 202, 87, 0.5);
        }

        .name-input {
            width: 280px;
            height: 45px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 22px;
            padding: 0 20px;
            font-size: 17px;
            font-family: 'BIZ UDGothic', sans-serif;
            background: rgba(255, 255, 255, 0.9);
            outline: none;
            margin-bottom: 20px;
            text-align: center;
        }

        .name-input:focus {
            border-color: #feca57;
            box-shadow: 0 0 10px rgba(254, 202, 87, 0.3);
        }

        .rules-content {
            text-align: left;
            max-width: 500px;
            margin: 0 auto;
        }

        .rule-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .rule-icon {
            font-size: 24px;
            min-width: 40px;
        }

        .rule-text h4 {
            margin: 0 0 5px 0;
            font-size: 16px;
            color: #feca57;
        }

        .rule-text p {
            margin: 0;
            line-height: 1.4;
            font-size: 14px;
        }

        .hp-btn {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.2);
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 18px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 140px;
            text-align: center;
            font-family: 'BIZ UDGothic', sans-serif;
            font-size: 15px;
            font-weight: 600;
        }

        .hp-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .hp-btn.selected {
            background: rgba(254, 202, 87, 0.3);
            border-color: #feca57;
            box-shadow: 0 0 25px rgba(254, 202, 87, 0.4);
        }
    </style>
</head>
<body>
    <!-- ã‚²ãƒ¼ãƒ é–‹å§‹ç”»é¢ -->
    <div class="start-screen" id="startScreen">
        <div class="start-content">
            <h1>âš”ï¸ ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒãƒˆãƒ«</h1>
            <p style="font-size: 16px; margin-bottom: 20px;">å­¦ç¿’ã—ãªãŒã‚‰æ¥½ã—ãã‚¿ã‚¤ãƒ”ãƒ³ã‚°ï¼</p>
            
            <div class="mode-selection">
                <button class="mode-btn" id="cpuModeBtn" onclick="selectMode('cpu')">
                    <div class="mode-icon">ğŸ¤–</div>
                    <div class="mode-title">CPUæˆ¦</div>
                    <div class="mode-desc">ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã¨å¯¾æˆ¦</div>
                </button>
                <button class="mode-btn" id="pvpModeBtn" onclick="selectMode('pvp')">
                    <div class="mode-icon">ğŸ‘¥</div>
                    <div class="mode-title">2äººå¯¾æˆ¦</div>
                    <div class="mode-desc">å‹é”ã¨ä¸€ç·’ã«å¯¾æˆ¦</div>
                </button>
            </div>

            <div id="characterSelection" class="hidden">
                <div class="hp-selection" style="margin-bottom: 25px;">
                    <h3 style="margin-bottom: 15px; font-size: 18px; color: white;">âš¡ åˆæœŸHPè¨­å®š</h3>
                    <div class="hp-options" style="display: flex; gap: 25px; justify-content: center; flex-wrap: wrap;">
                        <button class="hp-btn" data-hp="100" onclick="selectHP(100)">
                            <div style="font-size: 18px; margin-bottom: 4px;">ğŸ’š</div>
                            <div style="font-size: 16px; font-weight: 700;">100HP</div>
                            <div style="font-size: 12px; opacity: 0.8;">çŸ­æœŸæ±ºæˆ¦</div>
                        </button>
                        <button class="hp-btn selected" data-hp="200" onclick="selectHP(200)">
                            <div style="font-size: 18px; margin-bottom: 4px;">ğŸ’›</div>
                            <div style="font-size: 16px; font-weight: 700;">200HP</div>
                            <div style="font-size: 12px; opacity: 0.8;">æ¨™æº–</div>
                        </button>
                        <button class="hp-btn" data-hp="300" onclick="selectHP(300)">
                            <div style="font-size: 18px; margin-bottom: 4px;">â¤ï¸</div>
                            <div style="font-size: 16px; font-weight: 700;">300HP</div>
                            <div style="font-size: 12px; opacity: 0.8;">é•·æœŸæˆ¦</div>
                        </button>
                    </div>
                </div>

                <div class="player-setup-container">
                    <div id="player1Setup" class="player-setup">
                        <h3 style="margin-bottom: 15px; font-size: 18px;">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®è¨­å®š</h3>
                        <input type="text" id="player1NameInput" class="name-input" value="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1" placeholder="åå‰ã‚’å…¥åŠ›">
                        <div class="character-selection">
                            <div class="character-btn fire" data-attr="fire" data-player="1" onclick="selectCharacter('fire', 1)">ğŸ”¥</div>
                            <div class="character-btn water" data-attr="water" data-player="1" onclick="selectCharacter('water', 1)">ğŸ’§</div>
                            <div class="character-btn thunder" data-attr="thunder" data-player="1" onclick="selectCharacter('thunder', 1)">âš¡</div>
                            <div class="character-btn wind" data-attr="wind" data-player="1" onclick="selectCharacter('wind', 1)">ğŸŒªï¸</div>
                            <div class="character-btn earth" data-attr="earth" data-player="1" onclick="selectCharacter('earth', 1)">ğŸŒ±</div>
                            <div class="character-btn light" data-attr="light" data-player="1" onclick="selectCharacter('light', 1)">âœ¨</div>
                        </div>
                    </div>
                    
                    <div id="player2Setup" class="player-setup hidden">
                        <h3 style="margin-bottom: 15px; font-size: 18px;">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã®è¨­å®š</h3>
                        <input type="text" id="player2NameInput" class="name-input" value="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2" placeholder="åå‰ã‚’å…¥åŠ›">
                        <div class="character-selection">
                            <div class="character-btn fire" data-attr="fire" data-player="2" onclick="selectCharacter('fire', 2)">ğŸ”¥</div>
                            <div class="character-btn water" data-attr="water" data-player="2" onclick="selectCharacter('water', 2)">ğŸ’§</div>
                            <div class="character-btn thunder" data-attr="thunder" data-player="2" onclick="selectCharacter('thunder', 2)">âš¡</div>
                            <div class="character-btn wind" data-attr="wind" data-player="2" onclick="selectCharacter('wind', 2)">ğŸŒªï¸</div>
                            <div class="character-btn earth" data-attr="earth" data-player="2" onclick="selectCharacter('earth', 2)">ğŸŒ±</div>
                            <div class="character-btn light" data-attr="light" data-player="2" onclick="selectCharacter('light', 2)">âœ¨</div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="nextBtn" onclick="showGameRules()" style="margin-top: 15px;" disabled>ã‚²ãƒ¼ãƒ ã®éŠã³æ–¹ã‚’è¦‹ã‚‹</button>
            </div>
            
            <div id="gameRules" class="hidden">
                <h2 style="margin-bottom: 20px; font-size: 22px;">ğŸ“– ã‚²ãƒ¼ãƒ ã®éŠã³æ–¹</h2>
                <div class="rules-content">
                    <div class="rule-item">
                        <div class="rule-icon">âš”ï¸</div>
                        <div class="rule-text">
                            <h4>åŸºæœ¬ãƒ«ãƒ¼ãƒ«</h4>
                            <p>è¨­å®šã—ãŸHPã§ã‚¹ã‚¿ãƒ¼ãƒˆã€‚ç›¸æ‰‹ã®HPã‚’0ã«ã—ãŸã‚‰å‹åˆ©ï¼</p>
                        </div>
                    </div>
                    <div class="rule-item">
                        <div class="rule-icon">ğŸ“</div>
                        <div class="rule-text">
                            <h4>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°</h4>
                            <p>æ‰‹æœ­ã‹ã‚‰1æšé¸ã‚“ã§15ç§’ä»¥å†…ã«ãƒ­ãƒ¼ãƒå­—ã§å…¥åŠ›</p>
                        </div>
                    </div>
                    <div class="rule-item">
                        <div class="rule-icon">ğŸ’¥</div>
                        <div class="rule-text">
                            <h4>ãƒ€ãƒ¡ãƒ¼ã‚¸</h4>
                            <p>æˆåŠŸï¼šæ–‡å­—æ•°Ã—æ®‹ã‚Šæ™‚é–“ã§ãƒ€ãƒ¡ãƒ¼ã‚¸<br>å¤±æ•—ï¼šæ–‡å­—æ•°Ã—10ã®è‡ªå‚·ãƒ€ãƒ¡ãƒ¼ã‚¸<br>æ‰“ã¡é–“é•ãˆï¼š3ç§’ãƒšãƒŠãƒ«ãƒ†ã‚£</p>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="startGame()" style="margin-top: 20px; font-size: 16px; padding: 12px 30px;">ğŸ® ã‚²ãƒ¼ãƒ é–‹å§‹ï¼</button>
            </div>

            <div style="margin-top: 20px; font-size: 12px; opacity: 0.8;">
                <p>ğŸ“± iPadæ¨ªå‘ãã§æœ€é©åŒ–ã•ã‚Œã¦ã„ã¾ã™</p>
                <p>âŒ¨ï¸ ãƒ­ãƒ¼ãƒå­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆå…¨è§’ã§ã‚‚OKï¼‰</p>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ç”»é¢ -->
    <div class="game-container hidden" id="gameContainer">
        <!-- ãƒˆãƒƒãƒ—ãƒãƒ¼ -->
        <div class="top-bar">
            <div class="player-info">
                <div class="avatar" id="player1Avatar">ğŸ”¥</div>
                <div class="player-stats">
                    <div class="player-name" id="player1Name">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1</div>
                    <div class="hp-bar-container">
                        <div class="hp-bar" id="player1HpBar" style="width: 100%;"></div>
                        <div class="hp-text" id="player1HpText">300/300</div>
                    </div>
                </div>
            </div>

            <div class="center-info">
                <div class="turn-display" id="turnDisplay">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®ã‚¿ãƒ¼ãƒ³</div>
                <div class="phase-display" id="phaseDisplay">ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                <div class="timer-ring" id="timerRing">15</div>
            </div>

            <div class="player-info">
                <div class="avatar" id="player2Avatar">ğŸ¤–</div>
                <div class="player-stats" style="text-align: right;">
                    <div class="player-name" id="player2Name">CPU</div>
                    <div class="hp-bar-container">
                        <div class="hp-bar" id="player2HpBar" style="width: 100%;"></div>
                        <div class="hp-text" id="player2HpText">300/300</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ã‚«ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ -->
        <div class="card-area">
            <!-- ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰é¸æŠã‚¨ãƒªã‚¢ -->
            <div class="main-cards-area">
                <div class="cards-container" id="cardsContainer">
                    <!-- ã‚«ãƒ¼ãƒ‰ã¯å‹•çš„ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="typing-display">
            <div id="typingGuide" class="typing-guide">
                <div id="typingGuideJP" class="jp jp-progress"></div>
                <div id="typingGuideSub" class="sub"></div>
            </div>
            <div id="romajiGuide" class="romaji-guide"></div>
            <div class="progress-bar" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="keyboard-hint">
                <p>âŒ¨ï¸ ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§ç›´æ¥å…¥åŠ› | ESCã‚­ãƒ¼ã§ã‚®ãƒ–ã‚¢ãƒƒãƒ—</p>
            </div>
        </div>

        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
        <div class="controls">
            <button class="control-btn" onclick="showHelp()" title="ãƒ˜ãƒ«ãƒ—">â“</button>
            <button class="control-btn" onclick="toggleSound()" title="éŸ³é‡" id="soundBtn">ğŸ”Š</button>
            <button class="control-btn" onclick="pauseGame()" title="ä¸€æ™‚åœæ­¢" id="pauseBtn">â¸ï¸</button>
            <button class="control-btn" onclick="backToMenu()" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹">ğŸ </button>
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="modal">
        <div class="modal-content" id="modalContent">
            <!-- å‹•çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        </div>
    </div>

    <script>
        // å¤‰æ›ä¸­ãƒ•ãƒ©ã‚°ï¼ˆIMEï¼‰
        let isComposing = false;

        // æ”¹è‰¯ã•ã‚ŒãŸæ—¥æœ¬èªå‡¦ç†é–¢æ•°
        function toHiragana(s){
            if(!s) return '';
            let t = s.normalize('NFKC');
            // ã‚«ã‚¿ã‚«ãƒŠâ†’ã²ã‚‰ãŒãª
            t = t.replace(/[\u30A1-\u30FA\u30FD-\u30FF]/g, ch =>
                String.fromCharCode(ch.charCodeAt(0) - 0x60)
            );
            // è¨˜å·ãƒ»ç©ºç™½é™¤å»
            t = t.replace(/[ã€ã€‚ï¼Œï¼\s]/g,'');
            return t;
        }

        // ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—ç”¨ï¼šå°æ–‡å­—ã‚’å¤§æ–‡å­—åŒ–ã—ã¦æ¦‚ç®—é•·ã•ã«ï¼ˆã‚ƒã‚…ã‚‡â†’ã‚„ç­‰ï¼ã£â†’ã¤ï¼‰
        function countForDamage(s){
            const h = toHiragana(s)
                .replace(/[ãã‚¡]/g,'ã‚').replace(/[ãƒã‚£]/g,'ã„').replace(/[ã…ã‚¥]/g,'ã†')
                .replace(/[ã‡ã‚§]/g,'ãˆ').replace(/[ã‰ã‚©]/g,'ãŠ')
                .replace(/ã‚ƒ/g,'ã‚„').replace(/ã‚…/g,'ã‚†').replace(/ã‚‡/g,'ã‚ˆ')
                .replace(/ã£/g,'ã¤').replace(/ãƒ¼/g,''); // é•·éŸ³ã¯ç„¡è¦–
            return h.length;
        }

        // æ­£è¦åŒ–å¾Œã®æ–‡å­—æ•°ã‚’ä½¿ã†ï¼ˆãƒ€ãƒ¡ãƒ¼ã‚¸/è‡ªå‚·/çµ±è¨ˆã¯ã“ã‚Œã§çµ±ä¸€ï¼‰
        const countChars = (s) => countForDamage(s);

        /* =========================================================
           ãƒ­ãƒ¼ãƒå­—ï¼šè¤‡æ•°è¡¨è¨˜å¯¾å¿œï¼ˆä¿ƒéŸ³/æ‹—éŸ³/ã‚“/ä»£æ›¿è¡¨è¨˜ï¼‰
        ========================================================= */
        const BASE = {
            'ã‚':['a'],'ã„':['i'],'ã†':['u'],'ãˆ':['e'],'ãŠ':['o'],
            'ã‹':['ka'],'ã':['ki'],'ã':['ku'],'ã‘':['ke'],'ã“':['ko'],
            'ãŒ':['ga'],'ã':['gi'],'ã':['gu'],'ã’':['ge'],'ã”':['go'],
            'ã•':['sa'],'ã—':['shi','si'],'ã™':['su'],'ã›':['se'],'ã':['so'],
            'ã–':['za'],'ã˜':['ji','zi'],'ãš':['zu'],'ãœ':['ze'],'ã':['zo'],
            'ãŸ':['ta'],'ã¡':['chi','ti'],'ã¤':['tsu','tu'],'ã¦':['te'],'ã¨':['to'],
            'ã ':['da'],'ã¢':['ji','di'],'ã¥':['zu','du'],'ã§':['de'],'ã©':['do'],
            'ãª':['na'],'ã«':['ni'],'ã¬':['nu'],'ã­':['ne'],'ã®':['no'],
            'ã¯':['ha'],'ã²':['hi'],'ãµ':['fu','hu'],'ã¸':['he'],'ã»':['ho'],
            'ã°':['ba'],'ã³':['bi'],'ã¶':['bu'],'ã¹':['be'],'ã¼':['bo'],
            'ã±':['pa'],'ã´':['pi'],'ã·':['pu'],'ãº':['pe'],'ã½':['po'],
            'ã¾':['ma'],'ã¿':['mi'],'ã‚€':['mu'],'ã‚':['me'],'ã‚‚':['mo'],
            'ã‚„':['ya'],'ã‚†':['yu'],'ã‚ˆ':['yo'],
            'ã‚‰':['ra'],'ã‚Š':['ri'],'ã‚‹':['ru'],'ã‚Œ':['re'],'ã‚':['ro'],
            'ã‚':['wa'],'ã‚':['wi'],'ã‚‘':['we'],'ã‚’':['wo','o'],
            'ã‚“':['n','nn'],
            'ã':['xa','la','a'],'ãƒ':['xi','li','i'],'ã…':['xu','lu','u'],'ã‡':['xe','le','e'],'ã‰':['xo','lo','o'],
            'ã£':['*sokuon*'], // ç‰¹æ®Š
            'ãƒ¼':['*choon*']   // é•·éŸ³ï¼ˆã“ã“ã§ã¯ç„¡è¦– or ç›´å‰æ¯éŸ³ï¼‰
        };

        // æ‹—éŸ³
        const YOON = {
            'ãã‚ƒ':['kya','kixya','kya'], 'ãã‚…':['kyu','kixyu'], 'ãã‚‡':['kyo','kixyo'],
            'ãã‚ƒ':['gya','gixya'], 'ãã‚…':['gyu','gixyu'], 'ãã‚‡':['gyo','gixyo'],
            'ã—ã‚ƒ':['sha','sya'], 'ã—ã‚…':['shu','syu'], 'ã—ã‚‡':['sho','syo'],
            'ã˜ã‚ƒ':['ja','jya','zya'], 'ã˜ã‚…':['ju','jyu','zyu'], 'ã˜ã‚‡':['jo','jyo','zyo'],
            'ã¡ã‚ƒ':['cha','tya','cya'], 'ã¡ã‚…':['chu','tyu','cyu'], 'ã¡ã‚‡':['cho','tyo','cyo'],
            'ã«ã‚ƒ':['nya'], 'ã«ã‚…':['nyu'], 'ã«ã‚‡':['nyo'],
            'ã²ã‚ƒ':['hya'], 'ã²ã‚…':['hyu'], 'ã²ã‚‡':['hyo'],
            'ã³ã‚ƒ':['bya'], 'ã³ã‚…':['byu'], 'ã³ã‚‡':['byo'],
            'ã´ã‚ƒ':['pya'], 'ã´ã‚…':['pyu'], 'ã´ã‚‡':['pyo'],
            'ã¿ã‚ƒ':['mya'], 'ã¿ã‚…':['myu'], 'ã¿ã‚‡':['myo'],
            'ã‚Šã‚ƒ':['rya'], 'ã‚Šã‚…':['ryu'], 'ã‚Šã‚‡':['ryo'],
            'ã‚”ã':['va'],'ã‚”ãƒ':['vi'],'ã‚”ã‡':['ve'],'ã‚”ã‰':['vo'],'ã‚”ã‚…':['vyu']
        };

        // æ–‡å­—åˆ—â†’ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆæ‹—éŸ³ã‚’1ãƒˆãƒ¼ã‚¯ãƒ³åŒ–ï¼‰
        function tokenize(h){
            const arr=[...h]; const out=[];
            for(let i=0;i<arr.length;i++){
                const ch=arr[i], nx=arr[i+1];
                if(nx && ['ã‚ƒ','ã‚…','ã‚‡'].includes(nx) && YOON[ch+nx]){
                    out.push(ch+nx); i++;
                }else{
                    out.push(ch);
                }
            }
            return out;
        }

        // æ¬¡ãƒˆãƒ¼ã‚¯ãƒ³ã®å…ˆé ­å­éŸ³/æ¯éŸ³ã‚’å¾—ã‚‹ï¼ˆã‚“ã®æ‰±ã„åˆ¤å®šç”¨ï¼‰
        function initialsOfToken(tok){
            let opts = romajiOfToken(tok);
            return new Set(opts.map(o=>o[0]||''));
        }

        // å˜ä¸€ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒ­ãƒ¼ãƒå­—å€™è£œã‚’å–å¾—
        function romajiOfToken(tok){
            if(YOON[tok]) return YOON[tok].slice();
            if(tok==='ãƒ¼') return ['']; // é•·éŸ³ã¯ã“ã“ã§ã¯ç„¡è¦–
            if(BASE[tok]) return BASE[tok].slice();
            return [tok]; // æœªçŸ¥ã¯ãã®ã¾ã¾
        }

        // å…¨å€™è£œåˆ—æŒ™ï¼ˆåˆ†å²ã¯å¤šã„ãŒç¾å®Ÿçš„ãªé•·ã•ãªã‚‰OKï¼‰
        function buildRomajiOptions(h){
            const tokens = tokenize(h);
            const results=[];
            function dfs(i, acc){
                if(i>=tokens.length){ results.push(acc); return; }
                const t=tokens[i];

                if(t==='ã£'){ // ä¿ƒéŸ³
                    if(i+1<tokens.length){
                        const nextOpts = romajiOfToken(tokens[i+1]);
                        // æ¬¡ã®é ­å­éŸ³ã‚’é‡ã­ã‚‹ï¼ˆch ã®ã¨ãã¯ tch / cch ä¸¡æ–¹è¨±å®¹ï¼‰
                        nextOpts.forEach(no=>{
                            if(!no) return;
                            const head = no.startsWith('ch') ? ['t','c'] : [no[0]];
                            head.forEach(hc=>{
                                if(/[a-z]/.test(hc)) dfs(i+1, acc + hc); // ä¿ƒéŸ³ã‚’å‰ç½®
                            });
                        });
                        return; // ä¿ƒéŸ³è‡ªä½“ã¯æ–‡å­—ã‚’æ¶ˆè²»ã—ã€æ¬¡ã¸
                    }else{
                        // èªæœ«ã®ã£ ã¯ç„¡è¦–
                        dfs(i+1, acc);
                        return;
                    }
                }

                if(t==='ã‚“'){
                    // æ¬¡ã®é ­ãŒæ¯éŸ³/ y ãªã‚‰ nn or n'
                    const nextHead = (i+1<tokens.length)? Array.from(initialsOfToken(tokens[i+1])) : [];
                    const risky = nextHead.some(c=>['a','i','u','e','o','y'].includes(c));
                    const cand = risky ? ["nn","n'"] : ["n","nn"];
                    cand.forEach(r=>dfs(i+1, acc+r));
                    return;
                }

                // é€šå¸¸
                const opts = romajiOfToken(t);
                opts.forEach(o=>dfs(i+1, acc+o));
            }
            dfs(0,'');
            // é‡è¤‡é™¤å»
            return Array.from(new Set(results));
        }

        // ã²ã‚‰ãŒãªæ–‡å­—åˆ—ã‚’ãƒ­ãƒ¼ãƒå­—ã«å¤‰æ›ï¼ˆæœ€çŸ­å€™è£œã‚’ä½¿ç”¨ï¼‰
        function hiraganaToRomaji(hiragana) {
            const options = buildRomajiOptions(hiragana);
            // æœ€çŸ­ã®ã‚‚ã®ã‚’é¸æŠï¼ˆé€šå¸¸ã¯æœ€ã‚‚ä¸€èˆ¬çš„ï¼‰
            return options.reduce((shortest, current) => 
                current.length < shortest.length ? current : shortest, options[0] || '');
        }

        // ã‚¬ã‚¤ãƒ‰åˆæœŸåŒ–ï¼šã‚«ãƒ¼ãƒ‰é¸æŠç›´å¾Œã«å‘¼ã¶ï¼ˆè¤‡æ•°å€™è£œå¯¾å¿œï¼‰
        function setupTypingGuide(targetText) {
            const jpEl = document.getElementById('typingGuideJP');
            const subEl = document.getElementById('typingGuideSub');
            const romajiEl = document.getElementById('romajiGuide');
            const norm = toHiragana(targetText);

            // ä¸Šæ®µã¯"åŸæ–‡ãã®ã¾ã¾"ã‚’è¡¨ç¤ºï¼ˆè‰²ã¯é¢ã§é€²æ—ï¼‰
            jpEl.style.setProperty('--fill', '0%');
            jpEl.textContent = targetText;

            // ä¸‹æ®µã¯åˆ¤å®šç”¨ã®"ã²ã‚‰ãŒãª"ã‚’1æ–‡å­—ãšã¤ã‚¹ãƒ‘ãƒ³åŒ–ã—ã¦ç‚¹ç¯
            subEl.innerHTML = '';
            [...norm].forEach((ch, i) => {
                const span = document.createElement('span');
                span.className = 'char pending';
                span.dataset.index = i;
                span.textContent = ch;
                subEl.appendChild(span);
            });

            // è¤‡æ•°ã®ãƒ­ãƒ¼ãƒå­—å€™è£œã‚’å–å¾—
            const romajiOptions = buildRomajiOptions(norm);
            typingState.targetOptions = romajiOptions;
            typingState.currentInputs = romajiOptions.map(() => ({
                position: 0,
                typed: '',
                completed: false
            }));
            typingState.typedKeys = '';

            // æœ€çŸ­å€™è£œã‚’ã‚¬ã‚¤ãƒ‰ã¨ã—ã¦è¡¨ç¤º
            const displayRomaji = romajiOptions.reduce((shortest, current) => 
                current.length < shortest.length ? current : shortest, romajiOptions[0] || '');

            romajiEl.innerHTML = '';
            [...displayRomaji].forEach((char, i) => {
                const span = document.createElement('span');
                span.className = 'romaji-char';
                span.dataset.index = i;
                span.textContent = char;
                romajiEl.appendChild(span);
            });

            // æœ€åˆã®æ–‡å­—ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            if (displayRomaji.length > 0) {
                romajiEl.children[0].classList.add('current');
            }
        }

        // é€²æ—æ›´æ–°ï¼šè¤‡æ•°å€™è£œå¯¾å¿œ
        function updateTypingGuideProgress() {
            if (!gameState.selectedCard) return;
            const jpEl  = document.getElementById('typingGuideJP');
            const subEl = document.getElementById('typingGuideSub');

            const target = gameState.selectedCard.text;
            const normTarget = toHiragana(target);
            
            // æœ€ã‚‚é€²ã‚“ã§ã„ã‚‹å€™è£œã®é€²æ—ã‚’ä½¿ç”¨
            let maxProgress = 0;
            let maxPosition = 0;
            
            typingState.currentInputs.forEach((input, index) => {
                const targetLength = typingState.targetOptions[index].length;
                if (targetLength > 0) {
                    const progress = input.position / targetLength;
                    if (progress > maxProgress) {
                        maxProgress = progress;
                        maxPosition = input.position;
                    }
                }
            });
            
            const hiraganaMatched = Math.floor(maxProgress * normTarget.length);
            const fill = Math.max(0, Math.min(100, maxProgress * 100));
            jpEl.style.setProperty('--fill', `${fill}%`);

            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã¯éè¡¨ç¤º

            // ä¸‹æ®µã‚’1æ–‡å­—ãšã¤ç‚¹ç¯
            const chars = subEl.querySelectorAll('.char');
            chars.forEach((el, i) => {
                el.classList.remove('matched','current','pending');
                if (i < hiraganaMatched) el.classList.add('matched');
                else if (i === hiraganaMatched && maxProgress < 1) el.classList.add('current');
                else el.classList.add('pending');
            });
        }

        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let gameState = {
            mode: null, // 'cpu' or 'pvp'
            maxHP: 200, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆHP
            players: [
                { name: 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1', hp: 200, maxHp: 200, avatar: 'ğŸ”¥', attribute: 'fire' },
                { name: 'CPU', hp: 200, maxHp: 200, avatar: 'ğŸ¤–', attribute: 'water' }
            ],
            currentPlayer: 0,
            selectedCard: null,
            hands: [[], []],
            deck: [],
            discard: [],
            timer: 15,
            timerInterval: null,
            gamePhase: 'cardSelect', // 'cardSelect', 'typing', 'result'
            soundEnabled: true,
            isPaused: false,
            stats: {
                totalChars: 0,
                correctChars: 0,
                totalTime: 0,
                combo: 0,
                maxCombo: 0
            }
        };

        // ã‚«ãƒ¼ãƒ‰ãƒ—ãƒ¼ãƒ«ï¼ˆå®Ÿç”¨çš„ãªã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’ç”¨ï¼‰
        const CARD_POOL = [
            // 2æ–‡å­—ã®å˜èªï¼ˆåˆç´šï¼‰
            { text: 'ã­ã“', difficulty: 1, category: 'ã©ã†ã¶ã¤' },
            { text: 'ã„ã¬', difficulty: 1, category: 'ã©ã†ã¶ã¤' },
            { text: 'ã™ã—', difficulty: 1, category: 'ãŸã¹ã‚‚ã®' },
            { text: 'ãã‚‰', difficulty: 1, category: 'ã—ãœã‚“' },
            { text: 'ã‚„ã¾', difficulty: 1, category: 'ã—ãœã‚“' },
            { text: 'ã‹ã‚', difficulty: 1, category: 'ã—ãœã‚“' },
            { text: 'ã¯ãª', difficulty: 1, category: 'ã—ãœã‚“' },
            { text: 'ã¿ãš', difficulty: 1, category: 'ã—ãœã‚“' },
            { text: 'ã‚†ã', difficulty: 1, category: 'ã—ãœã‚“' },
            { text: 'ã¤ã', difficulty: 1, category: 'ã—ãœã‚“' },
            { text: 'ã‹ã•', difficulty: 1, category: 'ã‚‚ã®' },
            { text: 'ã†ã¿', difficulty: 1, category: 'ã—ãœã‚“' },
            { text: 'ã‚ã‚', difficulty: 1, category: 'ã—ãœã‚“' },
            { text: 'ã»ã—', difficulty: 1, category: 'ã—ãœã‚“' },
            { text: 'ã‹ã«', difficulty: 1, category: 'ã©ã†ã¶ã¤' },
            { text: 'ã•ã‚‹', difficulty: 1, category: 'ã©ã†ã¶ã¤' },
            { text: 'ã‚‚ã‚Š', difficulty: 1, category: 'ã—ãœã‚“' },
            { text: 'ãã‚‚', difficulty: 1, category: 'ã—ãœã‚“' },
            { text: 'ã¿ã¡', difficulty: 1, category: 'ã‚‚ã®' },
            { text: 'ã‹ãœ', difficulty: 1, category: 'ã—ãœã‚“' },
            

  // 3æ–‡å­—ï¼ˆ20å•ï¼‰
  { text: 'ãŸã¾ã”', difficulty: 2, category: 'ãŸã¹ã‚‚ã®' },
  { text: 'ãã‚‹ã¾', difficulty: 2, category: 'ã®ã‚Šã‚‚ã®' },
  { text: 'ãã¤ã­', difficulty: 2, category: 'ã©ã†ã¶ã¤' },
  { text: 'ã†ã•ã', difficulty: 2, category: 'ã©ã†ã¶ã¤' },
  { text: 'ã•ã‹ãª', difficulty: 2, category: 'ã©ã†ã¶ã¤' },
  { text: 'ãã®ã“', difficulty: 2, category: 'ã—ãœã‚“' },
  { text: 'ã¿ã‹ã‚“', difficulty: 2, category: 'ãŸã¹ã‚‚ã®' },
  { text: 'ã‚Šã‚“ã”', difficulty: 2, category: 'ãŸã¹ã‚‚ã®' },
  { text: 'ãˆã»ã‚“', difficulty: 2, category: 'ã‚‚ã®' },
  { text: 'ã¨ã‘ã„', difficulty: 2, category: 'ã‚‚ã®' },
  { text: 'ã‹ã°ã‚“', difficulty: 2, category: 'ã‚‚ã®' },
  { text: 'ãŠãµã‚', difficulty: 2, category: 'ã‚‚ã®' },
  { text: 'ã“ã©ã‚‚', difficulty: 2, category: 'ã²ã¨' },
  { text: 'ã§ã‚“ã', difficulty: 2, category: 'ã‚‚ã®' },
  { text: 'ã™ãšã‚', difficulty: 2, category: 'ã©ã†ã¶ã¤' },
  { text: 'ãŠã¡ã‚ƒ', difficulty: 2, category: 'ãŸã¹ã‚‚ã®' },
  { text: 'ã‚„ã•ã„', difficulty: 2, category: 'ãŸã¹ã‚‚ã®' },
  { text: 'ã‚ã•ã²', difficulty: 2, category: 'ã—ãœã‚“' },
  { text: 'ã™ã„ã‹', difficulty: 2, category: 'ãŸã¹ã‚‚ã®' },
  { text: 'ãŠã‹ã—', difficulty: 2, category: 'ãŸã¹ã‚‚ã®' },

  // 4æ–‡å­—ï¼ˆ20å•ï¼‰
  { text: 'ã²ã“ã†ã', difficulty: 3, category: 'ã®ã‚Šã‚‚ã®' },
  { text: 'ã§ã‚“ã—ã‚ƒ', difficulty: 3, category: 'ã®ã‚Šã‚‚ã®' },
  { text: 'ãŠã«ãã‚Š', difficulty: 3, category: 'ãŸã¹ã‚‚ã®' },
  { text: 'ã«ã‚ã¨ã‚Š', difficulty: 3, category: 'ã©ã†ã¶ã¤' },
  { text: 'ã›ã‚“ã›ã„', difficulty: 3, category: 'ã²ã¨' },
  { text: 'ã‚ã•ãŒãŠ', difficulty: 3, category: 'ã—ãœã‚“' },
  { text: 'ãŸã„ã‚ˆã†', difficulty: 3, category: 'ã—ãœã‚“' },
  { text: 'ã‚„ããã°', difficulty: 3, category: 'ãŸã¹ã‚‚ã®' },
  { text: 'ãˆã‚“ã´ã¤', difficulty: 3, category: 'ã‚‚ã®' },
  { text: 'ã†ã‚ã°ã', difficulty: 3, category: 'ã‚‚ã®' },
  { text: 'ãã¤ã—ãŸ', difficulty: 3, category: 'ã‚‚ã®' },
  { text: 'ã“ãã°ã‚“', difficulty: 3, category: 'ã‚‚ã®' },
  { text: 'ã›ã‚“ãŸã', difficulty: 3, category: 'ã›ã„ã‹ã¤' },
  { text: 'ãŸã„ã„ã', difficulty: 3, category: 'ãŒãã—ã‚…ã†' },
  { text: 'ã“ã†ãˆã‚“', difficulty: 3, category: 'ã°ã—ã‚‡' },
  { text: 'ã©ã‚ˆã†ã³', difficulty: 3, category: 'ã«ã¡ã˜' },
  { text: 'ã‹ã‚ˆã†ã³', difficulty: 3, category: 'ã«ã¡ã˜' },
  { text: 'ã«ã¡ã‚ˆã†', difficulty: 3, category: 'ã«ã¡ã˜' },
  { text: 'ã–ã¶ã¨ã‚“', difficulty: 3, category: 'ã‚‚ã®' },
  { text: 'ãã†ã˜ã', difficulty: 3, category: 'ã‚‚ã®' },

  // 5ã€œ6æ–‡å­—ï¼ˆ30å•ï¼‰
  { text: 'ã—ã‚“ã‹ã‚“ã›ã‚“', difficulty: 4, category: 'ã®ã‚Šã‚‚ã®' }, //6
  { text: 'ãŠã¹ã‚“ã¨ã†', difficulty: 4, category: 'ãŸã¹ã‚‚ã®' },   //5
  { text: 'ãŸã„ã‚ˆã†ã‘ã„', difficulty: 4, category: 'ã—ãœã‚“' },   //6
  { text: 'ãã‚‡ã†ã—ã¤', difficulty: 4, category: 'ã°ã—ã‚‡' },     //5
  { text: 'ã©ã†ã¶ã¤ãˆã‚“', difficulty: 4, category: 'ã°ã—ã‚‡' },   //6
  { text: 'ã™ã„ããã‹ã‚“', difficulty: 4, category: 'ã°ã—ã‚‡' },   //6
  { text: 'ãŠã‚“ãŒãã—ã¤', difficulty: 4, category: 'ã°ã—ã‚‡' },   //6
  { text: 'ã‚ã•ã”ã¯ã‚“', difficulty: 4, category: 'ãŸã¹ã‚‚ã®' },   //5
  { text: 'ãˆã„ãŒã‹ã‚“', difficulty: 4, category: 'ã°ã—ã‚‡' },     //5
  { text: 'ã¾ã»ã†ã¤ã‹ã„', difficulty: 4, category: 'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼' }, //6
  { text: 'ã»ã„ãã—ã¤', difficulty: 4, category: 'ã°ã—ã‚‡' },     //5
  { text: 'ã¦ãŒã¿ã°ã“', difficulty: 4, category: 'ã‚‚ã®' },       //5
  { text: 'ã•ãã‚‰ã¾ã¤ã‚Š', difficulty: 4, category: 'ã‚¤ãƒ™ãƒ³ãƒˆ' }, //6
  { text: 'ã‹ã‚“ã“ã†ãƒã‚¹', difficulty: 4, category: 'ã®ã‚Šã‚‚ã®' }, //6
  { text: 'ã†ã¡ã‚…ã†ã›ã‚“', difficulty: 4, category: 'ã®ã‚Šã‚‚ã®' }, //6
  { text: 'ãƒ›ãƒ¼ãƒ ãƒ©ãƒ³', difficulty: 4, category: 'ã‚¹ãƒãƒ¼ãƒ„' },   //5
  { text: 'ãŠã‹ã—ã¥ãã‚Š', difficulty: 4, category: 'ã›ã„ã‹ã¤' }, //6
  { text: 'ãŸã„ã„ãã‹ã‚“', difficulty: 4, category: 'ã°ã—ã‚‡' },   //6
  { text: 'ã‚†ã†ãˆã‚“ã¡', difficulty: 4, category: 'ã°ã—ã‚‡' },     //5
  { text: 'ã¨ã—ã‚‡ã—ã¤', difficulty: 4, category: 'ã°ã—ã‚‡' },     //5
  { text: 'ãã‚‡ã†ã‹ã—ã‚‡', difficulty: 4, category: 'ãŒãã—ã‚…ã†' }, //6
  { text: 'ã‘ã„ã•ã¤ã—ã‚‡', difficulty: 4, category: 'ã°ã—ã‚‡' },   //6
  { text: 'ã‚ã•ã®ã—ãŸã', difficulty: 4, category: 'ã›ã„ã‹ã¤' }, //6
  { text: 'ãŠã²ã‚‹ã‚„ã™ã¿', difficulty: 4, category: 'ã›ã„ã‹ã¤' }, //6
  { text: 'ã˜ã‚…ãã‚‡ã†', difficulty: 4, category: 'ãŒãã—ã‚…ã†' }, //5
  { text: 'ã‘ã‚“ãŒãã‹ã„', difficulty: 4, category: 'ãŒãã—ã‚…ã†' }, //6
  { text: 'ãŠã‚“ãŒãã‹ã„', difficulty: 4, category: 'ã‚¤ãƒ™ãƒ³ãƒˆ' }, //6
  { text: 'ã†ã‚“ã©ã†ã‹ã„', difficulty: 4, category: 'ã‚¤ãƒ™ãƒ³ãƒˆ' }, //6
  { text: 'ã˜ã¦ã‚“ã°ã“', difficulty: 4, category: 'ã‚‚ã®' },       //5
  { text: 'ã‹ã„ã ã‚“ã—ãŸ', difficulty: 4, category: 'ã°ã—ã‚‡' },   //6

  // 7ã€œ8æ–‡å­—ï¼ˆ20å•ï¼‰
  { text: 'ã‚¢ã‚¤ã‚¹ã‚¯ãƒªãƒ¼ãƒ ', difficulty: 5, category: 'ãŸã¹ã‚‚ã®' },    //7
  { text: 'ã‚µãƒƒã‚«ãƒ¼ãƒœãƒ¼ãƒ«', difficulty: 5, category: 'ã‚¹ãƒãƒ¼ãƒ„' },    //7
  { text: 'ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼', difficulty: 5, category: 'ã‚‚ã®' },        //7
  { text: 'ãƒ©ãƒ³ãƒ‰ã‚»ãƒ«ã‚«ãƒãƒ¼', difficulty: 5, category: 'ã‚‚ã®' },      //8
  { text: 'ã²ã¾ã‚ã‚Šã°ãŸã‘', difficulty: 5, category: 'ã—ãœã‚“' },      //7
  { text: 'ã˜ã‚†ã†ã‘ã‚“ãã‚…ã†', difficulty: 5, category: 'ãŒãã—ã‚…ã†' }, //8
  { text: 'ã—ã‚…ãã ã„ã¡ã‚‡ã†', difficulty: 5, category: 'ãŒãã—ã‚…ã†' }, //8
  { text: 'ãŠã«ã”ã£ã“ã‚ãã³', difficulty: 5, category: 'ã‚ãã³' },    //8
  { text: 'ã¯ãªã‚„ã•ã‚“ã®ã«ã‚', difficulty: 5, category: 'ã°ã—ã‚‡' },    //8
  { text: 'ãƒ‘ã‚½ã‚³ãƒ³ãƒ«ãƒ¼ãƒ ', difficulty: 5, category: 'ã°ã—ã‚‡' },      //7
  { text: 'ã™ã„ãˆã„ãŸã„ã‹ã„', difficulty: 5, category: 'ã‚¤ãƒ™ãƒ³ãƒˆ' },  //8
  { text: 'ã˜ã©ã†ã—ã‚ƒã©ã†', difficulty: 5, category: 'ã®ã‚Šã‚‚ã®' },    //7
  { text: 'ã‚¯ãƒªã‚¹ãƒã‚¹ãƒ„ãƒªãƒ¼', difficulty: 5, category: 'ã‚¤ãƒ™ãƒ³ãƒˆ' },  //8
  { text: 'ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«', difficulty: 5, category: 'ã‚¹ãƒãƒ¼ãƒ„' },  //8
  { text: 'ã¦ãŒã¿ã®ã‹ãã‹ãŸ', difficulty: 5, category: 'ãŒãã—ã‚…ã†' }, //8
  { text: 'ãˆã„ã”ã¹ã‚“ãã‚‡ã†', difficulty: 5, category: 'ãŒãã—ã‚…ã†' }, //8
  { text: 'ãŸã„ã„ããšã‚ã‚Š', difficulty: 5, category: 'ãŒãã—ã‚…ã†' },  //7
  { text: 'ã“ã†ã•ãã‚¯ãƒ©ãƒ–', difficulty: 5, category: 'ã‚¯ãƒ©ãƒ–' },      //7
  { text: 'ãŒã£ãã‚…ã†ã„ã„ã‚“', difficulty: 5, category: 'ãŒãã—ã‚…ã†' }, //8
  { text: 'ã‹ãŒãã¯ã£ã´ã‚‡ã†', difficulty: 5, category: 'ãŒãã—ã‚…ã†' }, //8

  // 9ã€œ12æ–‡å­—ï¼ˆ20å•ï¼‰
  { text: 'ãŠã—ã‚‡ã†ãŒã¤ã‚„ã™ã¿', difficulty: 6, category: 'ã‚¤ãƒ™ãƒ³ãƒˆ' },   //9
  { text: 'ã‹ã‚“ãã‚‡ã†ã‚‚ã‚“ã ã„', difficulty: 6, category: 'ãŒãã—ã‚…ã†' }, //9
  { text: 'ãã‚‡ã†ã‚Šã‚…ã†ã¯ã‹ã°', difficulty: 6, category: 'ã°ã—ã‚‡' },     //9
  { text: 'ã˜ã—ã‚“ã‘ã„ã»ã†ã‚·ã‚¹ãƒ†ãƒ ', difficulty: 6, category: 'ã—ãœã‚“' }, //11
  { text: 'ãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³', difficulty: 6, category: 'ã°ã—ã‚‡' },   //10
  { text: 'ã—ã‚‡ã†ã¦ã‚“ãŒã„ã‚¹ãƒˆãƒªãƒ¼ãƒˆ', difficulty: 6, category: 'ã°ã—ã‚‡' }, //12
  { text: 'ãã‚…ã†ãã‚…ã†ã—ã‚ƒã—ã©ã†', difficulty: 6, category: 'ã®ã‚Šã‚‚ã®' }, //11
  { text: 'ãŒããˆã‚“ã•ã„ã˜ã£ã—', difficulty: 6, category: 'ã‚¤ãƒ™ãƒ³ãƒˆ' },   //9
  { text: 'ã¾ã‚“ãŒãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¼', difficulty: 6, category: 'ã°ã—ã‚‡' },     //9
  { text: 'ã‚µã‚¤ã‚¨ãƒ³ã‚¹ãƒŸãƒ¥ãƒ¼ã‚¸ã‚¢ãƒ ', difficulty: 6, category: 'ã°ã—ã‚‡' }, //11
  { text: 'ã©ã†ã¶ã¤ã‚ã„ã”ã‚»ãƒ³ã‚¿ãƒ¼', difficulty: 6, category: 'ã°ã—ã‚‡' }, //11
  { text: 'ã«ã‚…ã†ãŒãã—ãã‚»ãƒ¬ãƒ¢ãƒ‹ãƒ¼', difficulty: 6, category: 'ã‚¤ãƒ™ãƒ³ãƒˆ' }, //12
  { text: 'ã—ãœã‚“ã‹ã‚“ã•ã¤ãã‚‡ã†ã—ã¤', difficulty: 6, category: 'ãŒãã—ã‚…ã†' }, //12
  { text: 'ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ«', difficulty: 6, category: 'ã°ã—ã‚‡' },     //9
  { text: 'ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ã‚»ãƒƒãƒˆ', difficulty: 6, category: 'ãŸã¹ã‚‚ã®' },   //9
  { text: 'ã»ã†ã‹ã”ã“ã©ã‚‚ã‚¯ãƒ©ãƒ–', difficulty: 6, category: 'ã‚¯ãƒ©ãƒ–' },   //10
  { text: 'ã˜ã‚…ãã”ã‚Œã‚“ã—ã‚…ã†ã¡ã‚‡ã†', difficulty: 6, category: 'ãŒãã—ã‚…ã†' }, //12
  { text: 'ã¨ã†ãã‚‡ã†ã‚¹ã‚«ã‚¤ãƒ„ãƒªãƒ¼', difficulty: 6, category: 'ã°ã—ã‚‡' }, //11
  { text: 'ãˆã„ãŒã•ã„ãƒ‘ãƒ³ãƒ•ãƒ¬ãƒƒãƒˆ', difficulty: 6, category: 'ã‚¤ãƒ™ãƒ³ãƒˆ' }, //11
  { text: 'ã†ã‚“ã©ã†ã‹ã„ãƒ—ãƒ­ã‚°ãƒ©ãƒ ', difficulty: 6, category: 'ã‚¤ãƒ™ãƒ³ãƒˆ' }  //11

            
            // åŒ»ç™‚ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆå›å¾©åŠ¹æœï¼‰
            { text: 'ãã™ã‚Š', difficulty: 2, category: 'ã„ã‚Šã‚‡ã†' },
            { text: 'ã³ã‚‡ã†ã„ã‚“', difficulty: 3, category: 'ã„ã‚Šã‚‡ã†' },
            { text: 'ã„ã—ã‚ƒ', difficulty: 2, category: 'ã„ã‚Šã‚‡ã†' },
            { text: 'ã‹ã‚“ã”ã—', difficulty: 3, category: 'ã„ã‚Šã‚‡ã†' },
            { text: 'ã¡ã‚Šã‚‡ã†', difficulty: 3, category: 'ã„ã‚Šã‚‡ã†' },
            { text: 'ã‘ã‚“ã“ã†', difficulty: 3, category: 'ã„ã‚Šã‚‡ã†' },
            { text: 'ã—ã‚“ã ã‚“', difficulty: 3, category: 'ã„ã‚Šã‚‡ã†' },
            { text: 'ã»ã†ãŸã„', difficulty: 3, category: 'ã„ã‚Šã‚‡ã†' },
            { text: 'ã¡ã‚…ã†ã—ã‚ƒ', difficulty: 3, category: 'ã„ã‚Šã‚‡ã†' },
            { text: 'ãŸã„ãŠã‚“', difficulty: 3, category: 'ã„ã‚Šã‚‡ã†' }
        ];



        // å…¨è§’æ–‡å­—ã‚’åŠè§’ã«å¤‰æ›
        function normalizeInput(text) {
            if (!text) return '';
            
            // å…¨è§’è‹±æ•°å­—ã‚’åŠè§’ã«
            let normalized = text.replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, function(s) {
                return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
            });
            
            return normalized.toLowerCase();
        }

        // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
        function initGame() {
            // é¸æŠã•ã‚ŒãŸHPã‚’é©ç”¨
            gameState.players.forEach(player => {
                player.hp = gameState.maxHP;
                player.maxHp = gameState.maxHP;
            });
            
            // ãƒ‡ãƒƒã‚­ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            gameState.deck = [...CARD_POOL].sort(() => Math.random() - 0.5);
            
            // åˆæœŸæ‰‹æœ­ã‚’é…ã‚‹
            for (let i = 0; i < 2; i++) {
                gameState.hands[i] = [];
                for (let j = 0; j < 5; j++) {
                    if (gameState.deck.length > 0) {
                        gameState.hands[i].push(gameState.deck.pop());
                    }
                }
            }
            
            // UIæ›´æ–°
            updateUI();
            drawCards();
            
            // æœ€åˆã®ã‚¿ãƒ¼ãƒ³é–‹å§‹
            startTurn();
        }

        // ãƒ¢ãƒ¼ãƒ‰é¸æŠ
        function selectMode(mode) {
            // å‰ã®é¸æŠã‚’è§£é™¤
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // æ–°ã—ã„é¸æŠ
            document.getElementById(mode === 'cpu' ? 'cpuModeBtn' : 'pvpModeBtn').classList.add('selected');
            
            gameState.mode = mode;
            document.getElementById('characterSelection').classList.remove('hidden');
            
            if (mode === 'pvp') {
                document.getElementById('player2Setup').classList.remove('hidden');
                gameState.players[1].name = 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2';
                gameState.players[1].avatar = 'ğŸ’§';
            } else {
                document.getElementById('player2Setup').classList.add('hidden');
            }
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®åå‰å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
            setTimeout(() => {
                const nameInput = document.getElementById('player1NameInput');
                nameInput.focus();
                nameInput.select();
            }, 100);
            
            // åå‰å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            document.getElementById('player1NameInput').addEventListener('focus', function() {
                this.select();
            });
            
            if (mode === 'pvp') {
                document.getElementById('player2NameInput').addEventListener('focus', function() {
                    this.select();
                });
            }

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠï¼ˆè¿·ã£ãŸã‚‰ã™ãé€²ã‚ã‚‹ï¼‰
            selectCharacter('fire', 1);
            if (mode === 'pvp') selectCharacter('water', 2);
            checkSetupComplete();
        }

        // HPé¸æŠ
        function selectHP(hp) {
            // å‰ã®é¸æŠã‚’è§£é™¤
            document.querySelectorAll('.hp-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // æ–°ã—ã„é¸æŠ
            document.querySelector(`[data-hp="${hp}"]`).classList.add('selected');
            
            gameState.maxHP = hp;
            gameState.players.forEach(player => {
                player.hp = hp;
                player.maxHp = hp;
            });
            
            checkSetupComplete();
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ
        function selectCharacter(attribute, player) {
            // è©²å½“ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å‰ã®é¸æŠã‚’è§£é™¤
            document.querySelectorAll(`[data-player="${player}"]`).forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // æ–°ã—ã„é¸æŠ
            document.querySelector(`[data-attr="${attribute}"][data-player="${player}"]`).classList.add('selected');
            
            const avatars = {
                fire: 'ğŸ”¥',
                water: 'ğŸ’§',
                thunder: 'âš¡',
                wind: 'ğŸŒªï¸',
                earth: 'ğŸŒ±',
                light: 'âœ¨'
            };
            
            gameState.players[player - 1].attribute = attribute;
            gameState.players[player - 1].avatar = avatars[attribute];
            
            // åå‰ã‚’æ›´æ–°
            const nameInput = document.getElementById(`player${player}NameInput`);
            if (nameInput) {
                gameState.players[player - 1].name = nameInput.value || `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${player}`;
            }
            
            // æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åå‰å…¥åŠ›ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼ˆ2äººå¯¾æˆ¦ã®å ´åˆï¼‰
            if (player === 1 && gameState.mode === 'pvp') {
                setTimeout(() => {
                    const player2Input = document.getElementById('player2NameInput');
                    player2Input.focus();
                    player2Input.select();
                }, 100);
            }
            
            checkSetupComplete();
        }
        
        // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ãƒã‚§ãƒƒã‚¯
        function checkSetupComplete() {
            const player1Selected = document.querySelector('[data-player="1"].selected');
            const player2Selected = gameState.mode === 'cpu' || document.querySelector('[data-player="2"].selected');
            
            document.getElementById('nextBtn').disabled = !(player1Selected && player2Selected);
        }
        
        // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ«è¡¨ç¤º
        function showGameRules() {
            // åå‰ã‚’æœ€çµ‚æ›´æ–°
            gameState.players[0].name = document.getElementById('player1NameInput').value || 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1';
            if (gameState.mode === 'pvp') {
                gameState.players[1].name = document.getElementById('player2NameInput').value || 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2';
            }
            
            document.getElementById('characterSelection').classList.add('hidden');
            document.getElementById('gameRules').classList.remove('hidden');
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        function startGame() {
            document.getElementById('startScreen').classList.add('hidden');
            
            // 2äººå¯¾æˆ¦ã®å ´åˆã¯ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã§ã‚¿ãƒ¼ãƒ³æ±ºå®š
            if (gameState.mode === 'pvp') {
                showRouletteAnimation();
            } else {
                document.getElementById('gameContainer').classList.remove('hidden');
                initGame();
            }
        }

        // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæ¼”å‡ºè¡¨ç¤º
        function showRouletteAnimation() {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.className = 'roulette-overlay';
                
                const container = document.createElement('div');
                container.className = 'roulette-container';
                
                container.innerHTML = `
                    <div class="roulette-title">ğŸ¯ å…ˆæ”»ã‚’æ±ºã‚ã‚ˆã†ï¼</div>
                    <div class="player-info-simple">
                        <div class="player-card left">
                            <div class="player-avatar-simple">${gameState.players[0].avatar}</div>
                            <div class="player-name-simple">${gameState.players[0].name}</div>
                            <div class="player-side">å·¦åŠåˆ†</div>
                        </div>
                        <div class="player-card right">
                            <div class="player-avatar-simple">${gameState.players[1].avatar}</div>
                            <div class="player-name-simple">${gameState.players[1].name}</div>
                            <div class="player-side">å³åŠåˆ†</div>
                        </div>
                    </div>
                    <div class="roulette-wheel" id="rouletteWheel">
                        <div class="roulette-pointer"></div>
                        <div class="roulette-center">ğŸ²</div>
                    </div>
                    <div class="roulette-result" id="rouletteResult"></div>
                `;
                
                overlay.appendChild(container);
                document.body.appendChild(overlay);
                
                // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆé–‹å§‹
                setTimeout(() => {
                    spinRoulette(overlay, resolve);
                }, 500);
            });
        }

        // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆå›è»¢å‡¦ç†
        function spinRoulette(overlay, callback) {
            const wheel = document.getElementById('rouletteWheel');
            const resultEl = document.getElementById('rouletteResult');
            
            // ãƒ©ãƒ³ãƒ€ãƒ ãªæœ€çµ‚è§’åº¦ã‚’æ±ºå®šï¼ˆ5å›è»¢ + ãƒ©ãƒ³ãƒ€ãƒ ï¼‰
            const baseRotation = 1800; // 5å›è»¢
            const randomRotation = Math.random() * 360;
            const finalRotation = baseRotation + randomRotation;
            
            // çµæœã‚’æ±ºå®šï¼ˆå·¦åŠåˆ†ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã€å³åŠåˆ†ï¼šãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ï¼‰
            const normalizedAngle = randomRotation % 360;
            const winner = normalizedAngle < 180 ? 0 : 1;
            gameState.currentPlayer = winner;
            
            // CSSå¤‰æ•°ã«æœ€çµ‚è§’åº¦ã‚’è¨­å®š
            wheel.style.setProperty('--final-rotation', `${finalRotation}deg`);
            
            // å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
            wheel.classList.add('roulette-spinning');
            
            // å›è»¢éŸ³ï¼ˆç°¡æ˜“ï¼‰
            playRouletteSound();
            
            // çµæœè¡¨ç¤º
            setTimeout(() => {
                const winnerName = gameState.players[winner].name;
                const winnerAvatar = gameState.players[winner].avatar;
                resultEl.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                        <div style="font-size: 32px;">${winnerAvatar}</div>
                        <div>
                            <div style="font-size: 20px; color: #feca57;">ğŸ‰ ${winnerName}ã®å…ˆæ”»ï¼</div>
                            <div style="font-size: 14px; opacity: 0.8; margin-top: 5px;">ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã™...</div>
                        </div>
                    </div>
                `;
                
                // å‹åˆ©éŸ³
                playSound('success');
                
                // ã‚²ãƒ¼ãƒ é–‹å§‹
                setTimeout(() => {
                    overlay.remove();
                    document.getElementById('gameContainer').classList.remove('hidden');
                    initGame();
                    callback();
                }, 1500);
            }, 2200);
        }

        // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆéŸ³ï¼ˆå›è»¢éŸ³ï¼‰
        function playRouletteSound() {
            if (!gameState.soundEnabled) return;
            
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // å›è»¢éŸ³ã‚’3ç§’é–“å†ç”Ÿ
            let frequency = 200;
            const duration = 3000;
            const startTime = audioContext.currentTime;
            
            function createTick(time, freq) {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(freq, time);
                gainNode.gain.setValueAtTime(0.05, time);
                gainNode.gain.exponentialRampToValueAtTime(0.001, time + 0.1);
                
                oscillator.start(time);
                oscillator.stop(time + 0.1);
            }
            
            // å¾ã€…ã«é–“éš”ã‚’åºƒã’ãªãŒã‚‰ãƒ†ã‚£ãƒƒã‚¯éŸ³ã‚’ç”Ÿæˆ
            let tickInterval = 50; // åˆæœŸé–“éš”ï¼ˆmsï¼‰
            let currentTime = startTime;
            
            while (currentTime - startTime < duration / 1000) {
                createTick(currentTime, frequency + Math.random() * 100);
                
                // æ™‚é–“ãŒçµŒã¤ã«ã¤ã‚Œã¦é–“éš”ã‚’åºƒã’ã‚‹ï¼ˆæ¸›é€ŸåŠ¹æœï¼‰
                const progress = (currentTime - startTime) / (duration / 1000);
                tickInterval = 50 + (progress * 200); // 50ms ã‹ã‚‰ 250ms ã¸
                
                currentTime += tickInterval / 1000;
            }
        }

        // UIæ›´æ–°
        function updateUI() {
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±æ›´æ–°
            for (let i = 0; i < 2; i++) {
                const player = gameState.players[i];
                document.getElementById(`player${i + 1}Name`).textContent = player.name;
                document.getElementById(`player${i + 1}Avatar`).textContent = player.avatar;
                
                const hpPercent = (player.hp / player.maxHp) * 100;
                document.getElementById(`player${i + 1}HpBar`).style.width = `${hpPercent}%`;
                document.getElementById(`player${i + 1}HpText`).textContent = `${player.hp}/${player.maxHp}`;
            }
            
            // ã‚¿ãƒ¼ãƒ³è¡¨ç¤º
            document.getElementById('turnDisplay').textContent = 
                `${gameState.players[gameState.currentPlayer].name}ã®ã‚¿ãƒ¼ãƒ³`;
                
            // ãƒ•ã‚§ãƒ¼ã‚ºè¡¨ç¤º
            updatePhaseDisplay();
        }
        
        // ãƒ•ã‚§ãƒ¼ã‚ºè¡¨ç¤ºæ›´æ–°
        function updatePhaseDisplay() {
            const phaseDisplay = document.getElementById('phaseDisplay');
            
            switch (gameState.gamePhase) {
                case 'cardSelect':
                    phaseDisplay.textContent = 'ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„';
                    break;
                case 'typing':
                    phaseDisplay.textContent = 'ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ä¸­...';
                    break;
                case 'result':
                    phaseDisplay.textContent = 'çµæœè¡¨ç¤º';
                    break;
                default:
                    phaseDisplay.textContent = '';
            }
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹æœ­è¡¨ç¤ºï¼ˆå·¦å³ã«é…ç½®ï¼‰
        function drawPlayerHand() {
            // æ—¢å­˜ã®æ‰‹æœ­ã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤
            document.querySelectorAll('.player-hand').forEach(el => el.remove());
            
            // å·¦å´ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®æ‰‹æœ­ï¼‰
            const leftHand = document.createElement('div');
            leftHand.className = 'player-hand left';
            leftHand.id = 'leftPlayerHand';
            
            // å³å´ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã®æ‰‹æœ­ï¼‰
            const rightHand = document.createElement('div');
            rightHand.className = 'player-hand right';
            rightHand.id = 'rightPlayerHand';
            
            document.querySelector('.card-area').appendChild(leftHand);
            document.querySelector('.card-area').appendChild(rightHand);
            
            // ä¸¡æ–¹ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹æœ­ã‚’è¡¨ç¤º
            [0, 1].forEach(playerIndex => {
                const hand = gameState.hands[playerIndex];
                const container = playerIndex === 0 ? leftHand : rightHand;
                
                // æ‰‹æœ­ãŒ6æšæœªæº€ãªã‚‰1æšå¼•ã
                if (gameState.deck.length > 0 && hand.length < 6) {
                    hand.push(gameState.deck.pop());
                }
                
                hand.forEach((card, index) => {
                    const handCard = document.createElement('div');
                    handCard.className = 'hand-card';
                    
                    // ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹æœ­ã¯å°‘ã—æ˜ã‚‹ãè¡¨ç¤º
                    if (playerIndex === gameState.currentPlayer) {
                        handCard.style.opacity = '1';
                        handCard.style.border = '2px solid rgba(254, 202, 87, 0.5)';
                    }
                    
                    handCard.innerHTML = `
                        <div style="font-weight: 700; font-size: 12px;">${card.text}</div>
                        <div style="font-size: 9px; opacity: 0.8;">${'â˜…'.repeat(card.difficulty)}</div>
                    `;
                    container.appendChild(handCard);
                });
            });
        }

        // ã‚«ãƒ¼ãƒ‰æç”»ï¼ˆãƒ¡ã‚¤ãƒ³é¸æŠã‚¨ãƒªã‚¢ï¼‰
        function drawCards() {
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';
            
            const currentHand = gameState.hands[gameState.currentPlayer];
            
            // æ‰‹æœ­ãŒ6æšæœªæº€ãªã‚‰1æšå¼•ã
            if (gameState.deck.length > 0 && currentHand.length < 6) {
                currentHand.push(gameState.deck.pop());
            }
            
            // ã‚«ãƒ¼ãƒ‰ã‚’3æšãšã¤è¡¨ç¤ºï¼ˆæœ€å¤§6æšï¼‰
            const displayCards = currentHand.slice(0, 6);
            
            displayCards.forEach((card, index) => {
                const cardElement = document.createElement('div');
                const isHealCard = card.category === 'ã„ã‚Šã‚‡ã†';
                cardElement.className = isHealCard ? 'card heal' : 'card attack';
                cardElement.onclick = () => selectCard(index);
                
                const stars = 'â˜…'.repeat(card.difficulty);
                const categoryDisplay = isHealCard ? 'ğŸ’š ã„ã‚Šã‚‡ã†' : 'âš”ï¸ ' + card.category;
                
                cardElement.innerHTML = `
                    <div class="card-text">${card.text}</div>
                    <div class="card-difficulty">${stars} ${categoryDisplay}</div>
                `;
                
                container.appendChild(cardElement);
            });
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            setTimeout(() => {
                container.classList.add('active');
            }, 100);
        }

        // ã‚«ãƒ¼ãƒ‰é¸æŠ
        function selectCard(index) {
            if (gameState.gamePhase !== 'cardSelect') return;
            
            // å‰ã®é¸æŠã‚’è§£é™¤
            document.querySelectorAll('.card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // æ–°ã—ã„é¸æŠ
            document.querySelectorAll('.card')[index].classList.add('selected');
            gameState.selectedCard = gameState.hands[gameState.currentPlayer][index];
            
            // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰ã‚’è¨­å®š
            setupTypingGuide(gameState.selectedCard.text);
            
            // å…¥åŠ›ãƒ•ã‚§ãƒ¼ã‚ºã«ç§»è¡Œ
            startTypingPhase();
        }

        // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤º
        function showCountdown() {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.className = 'countdown-overlay';
                
                const numberEl = document.createElement('div');
                numberEl.className = 'countdown-number';
                overlay.appendChild(numberEl);
                
                document.body.appendChild(overlay);
                
                // Ready â†’ Go!!! ã®é †ç•ªã§è¡¨ç¤º
                numberEl.textContent = 'Ready';
                
                setTimeout(() => {
                    numberEl.textContent = 'Go!!!';
                    setTimeout(() => {
                        overlay.remove();
                        resolve();
                    }, 800);
                }, 1200);
            });
        }

        // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹
        async function startTypingPhase() {
            gameState.gamePhase = 'typing';
            gameState.timer = 15;
            
            // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤º
            await showCountdown();
            
            // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’æœ‰åŠ¹åŒ–
            document.addEventListener('keydown', handleKeyPress);
            
            // IMEå…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
            document.addEventListener('compositionstart', () => {
                isComposing = true;
            });
            
            document.addEventListener('compositionend', () => {
                isComposing = false;
            });
            
            // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
            startTimer();
        }

        // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
        function startTimer() {
            clearInterval(gameState.timerInterval);
            gameState.timerInterval = setInterval(() => {
                if (gameState.isPaused) return;

                gameState.timer--;
                
                const timerRing = document.getElementById('timerRing');
                timerRing.textContent = gameState.timer;

                const progress = (gameState.timer / 15) * 360;
                timerRing.style.background =
                    `conic-gradient(#feca57 ${progress}deg, rgba(255,255,255,0.2) ${progress}deg)`;

                if (gameState.timer <= 0) {
                    timeUp();
                }
            }, 1000);
        }

        // è¤‡æ•°å€™è£œå¯¾å¿œã®ã‚¿ã‚¤ãƒ”ãƒ³ã‚°çŠ¶æ…‹
        let typingState = {
            targetOptions: [], // è¤‡æ•°ã®ãƒ­ãƒ¼ãƒå­—å€™è£œ
            currentInputs: [], // å„å€™è£œã§ã®ç¾åœ¨ã®å…¥åŠ›çŠ¶æ³
            typedKeys: ''
        };

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›å‡¦ç†ï¼ˆè¤‡æ•°å€™è£œå¯¾å¿œï¼‰
        function handleKeyPress(event) {
            if (gameState.gamePhase !== 'typing' || gameState.isPaused) return;
            
            // IMEå…¥åŠ›ä¸­ã¯å‡¦ç†ã—ãªã„
            if (isComposing) return;
            
            // å…¨è§’æ–‡å­—ã‚’åŠè§’ã«å¤‰æ›
            const key = normalizeInput(event.key);
            
            // ç‰¹æ®Šã‚­ãƒ¼ã®å‡¦ç†
            if (key === 'enter') {
                event.preventDefault();
                // ã„ãšã‚Œã‹ã®å€™è£œãŒå®Œäº†ã—ã¦ã„ã‚Œã°é€ä¿¡
                if (typingState.currentInputs.some(input => input.completed)) {
                    submitAnswer();
                }
                return;
            }
            
            if (key === 'escape') {
                event.preventDefault();
                giveUp();
                return;
            }
            
            // ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã®ã¿å—ã‘ä»˜ã‘ï¼ˆå…¨è§’ã‚‚å¯¾å¿œï¼‰
            if (!/^[a-z]$/.test(key)) return;
            
            event.preventDefault();
            
            // å…¨å€™è£œã«å¯¾ã—ã¦ã‚­ãƒ¼å…¥åŠ›ã‚’ãƒã‚§ãƒƒã‚¯
            let anyMatch = false;
            let completedCount = 0;
            
            typingState.currentInputs.forEach((input, index) => {
                if (input.completed) {
                    completedCount++;
                    return; // æ—¢ã«å®Œäº†ã—ã¦ã„ã‚‹å€™è£œã¯ã‚¹ã‚­ãƒƒãƒ—
                }
                
                const targetRomaji = typingState.targetOptions[index];
                const expectedKey = targetRomaji[input.position];
                
                if (key === expectedKey) {
                    input.position++;
                    input.typed += key;
                    anyMatch = true;
                    
                    // ã“ã®å€™è£œãŒå®Œäº†ã—ãŸã‹ãƒã‚§ãƒƒã‚¯
                    if (input.position >= targetRomaji.length) {
                        input.completed = true;
                        completedCount++;
                        console.log(`å€™è£œ${index}å®Œäº†: ${targetRomaji}`);
                    }
                }
            });
            
            if (anyMatch) {
                // æ­£ã—ã„ã‚­ãƒ¼
                typingState.typedKeys += key;
                
                updateRomajiDisplay();
                updateTypingGuideProgress();
                
                // ã„ãšã‚Œã‹ã®å€™è£œãŒå®Œäº†ã—ãŸã‚‰å³åº§ã«é€ä¿¡
                if (completedCount > 0) {
                    console.log('å…¥åŠ›å®Œäº†æ¤œå‡º - å³åº§ã«é€ä¿¡');
                    // ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢
                    clearInterval(gameState.timerInterval);
                    // å°‘ã—é…å»¶ã‚’å…¥ã‚Œã¦ç¢ºå®Ÿã«å‡¦ç†
                    setTimeout(() => {
                        submitAnswer();
                    }, 50);
                }
            } else {
                // é–“é•ã£ãŸã‚­ãƒ¼ - 3ç§’ãƒšãƒŠãƒ«ãƒ†ã‚£
                gameState.timer = Math.max(0, gameState.timer - 3);
                
                // ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã‚’å³åº§ã«æ›´æ–°
                const timerRing = document.getElementById('timerRing');
                timerRing.textContent = gameState.timer;
                const progress = (gameState.timer / 15) * 360;
                timerRing.style.background =
                    `conic-gradient(#feca57 ${progress}deg, rgba(255,255,255,0.2) ${progress}deg)`;
                
                // ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¡¨ç¤º
                showPenaltyEffect();
                
                playSound('fail');
                
                // æ™‚é–“åˆ‡ã‚Œãƒã‚§ãƒƒã‚¯
                if (gameState.timer <= 0) {
                    timeUp();
                }
            }
        }

        // ãƒ­ãƒ¼ãƒå­—è¡¨ç¤ºæ›´æ–°ï¼ˆè¤‡æ•°å€™è£œå¯¾å¿œï¼‰
        function updateRomajiDisplay() {
            const romajiEl = document.getElementById('romajiGuide');
            const chars = romajiEl.querySelectorAll('.romaji-char');
            
            // æœ€ã‚‚é€²ã‚“ã§ã„ã‚‹å€™è£œã®ä½ç½®ã‚’å–å¾—
            let maxPosition = 0;
            typingState.currentInputs.forEach(input => {
                if (input.position > maxPosition) {
                    maxPosition = input.position;
                }
            });
            
            chars.forEach((char, index) => {
                char.classList.remove('typed', 'current');
                
                if (index < maxPosition) {
                    char.classList.add('typed');
                } else if (index === maxPosition) {
                    char.classList.add('current');
                }
            });
        }

        // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãƒ¬ã‚¤ãƒ¤ãƒ¼å–å¾—/ä½œæˆ
        function getOrCreateFxLayer() {
            let fxLayer = document.querySelector('.fx-layer');
            if (!fxLayer) {
                fxLayer = document.createElement('div');
                fxLayer.className = 'fx-layer';
                fxLayer.setAttribute('aria-hidden', 'true');
                document.body.appendChild(fxLayer);
            }
            return fxLayer;
        }

        // å±æ€§åˆ¥è¨­å®šãƒ†ãƒ¼ãƒ–ãƒ«
        const ATTACK_CONFIGS = {
            fire: {
                colors: ['#ff6b6b', '#feca57', '#ff9f43'],
                particles: 80,
                speed: 1.0,
                flashColor: 'rgba(255, 107, 107, 0.6)',
                glowColor: '#ff6b6b'
            },
            water: {
                colors: ['#4ecdc4', '#76e0ff', '#00d2d3'],
                particles: 100,
                speed: 1.2,
                flashColor: 'rgba(76, 224, 255, 0.5)',
                glowColor: '#4ecdc4'
            },
            thunder: {
                colors: ['#ffe66d', '#fff', '#f1c40f'],
                particles: 60,
                speed: 2.0,
                flashColor: 'rgba(255, 255, 255, 0.8)',
                glowColor: '#ffe66d'
            },
            wind: {
                colors: ['#95e1d3', '#a8e6cf', '#88d8c0'],
                particles: 70,
                speed: 1.5,
                flashColor: 'rgba(149, 225, 211, 0.4)',
                glowColor: '#95e1d3'
            },
            earth: {
                colors: ['#a8e6cf', '#8bc34a', '#689f38'],
                particles: 60,
                speed: 0.8,
                flashColor: 'rgba(168, 230, 207, 0.5)',
                glowColor: '#a8e6cf'
            },
            light: {
                colors: ['#ffd93d', '#ffffff', '#f39c12'],
                particles: 90,
                speed: 1.8,
                flashColor: 'rgba(255, 255, 255, 0.9)',
                glowColor: '#ffd93d'
            }
        };

        // æ”»æ’ƒã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        async function playAttackAnimation({ attr, from, targetEl, impactMs = 600 }) {
            const config = ATTACK_CONFIGS[attr];
            const fxLayer = getOrCreateFxLayer();
            
            // æ”»æ’ƒè€…ã¨å¯¾è±¡ã®ä½ç½®ã‚’å–å¾—
            const attackerEl = document.getElementById(`player${gameState.currentPlayer + 1}Avatar`);
            const attackerRect = attackerEl.getBoundingClientRect();
            const targetRect = targetEl.getBoundingClientRect();
            
            const startX = from === 'left' ? attackerRect.right : attackerRect.left;
            const startY = attackerRect.top + attackerRect.height / 2;
            const endX = targetRect.left + targetRect.width / 2;
            const endY = targetRect.top + targetRect.height / 2;

            // ãƒ•ã‚§ãƒ¼ã‚º1: æºœã‚ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            await playChargeEffect(attackerEl, config);
            
            // ãƒ•ã‚§ãƒ¼ã‚º2: é£›ã³é“å…·ç§»å‹•
            await playProjectileEffect(fxLayer, attr, config, startX, startY, endX, endY, impactMs);
            
            // ãƒ•ã‚§ãƒ¼ã‚º3: ãƒ’ãƒƒãƒˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            await playImpactEffect(fxLayer, attr, config, endX, endY);
            
            return Promise.resolve();
        }

        // ãƒ•ã‚§ãƒ¼ã‚º1: æºœã‚ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        function playChargeEffect(attackerEl, config) {
            return new Promise((resolve) => {
                // æºœã‚éŸ³
                playSound('charge');
                
                // ã‚°ãƒ­ãƒ¼åŠ¹æœ
                attackerEl.style.setProperty('--glow-color', config.glowColor);
                attackerEl.style.animation = 'chargeGlow 300ms ease-out forwards';
                
                setTimeout(() => {
                    attackerEl.style.animation = '';
                    attackerEl.style.transform = '';
                    attackerEl.style.boxShadow = '';
                    resolve();
                }, 300);
            });
        }

        // ãƒ•ã‚§ãƒ¼ã‚º2: é£›ã³é“å…·ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆç”»é¢å…¨ä½“ã‚¹ã‚±ãƒ¼ãƒ«ï¼‰
        function playProjectileEffect(fxLayer, attr, config, startX, startY, endX, endY, duration) {
            return new Promise((resolve) => {
                const projectile = createProjectile(attr, config, startX, startY);
                fxLayer.appendChild(projectile);
                
                // ç§»å‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç”»é¢å…¨ä½“ã‚’ä½¿ã£ãŸå¤§ããªè»Œé“ï¼‰
                const deltaX = endX - startX;
                const deltaY = endY - startY;
                
                // å¼§ã‚’æãè»Œé“ã‚’è¨ˆç®—ï¼ˆã‚ˆã‚Šå¤§ããªã‚¹ã‚±ãƒ¼ãƒ«ï¼‰
                const midX = (startX + endX) / 2;
                const midY = Math.min(startY, endY) - Math.abs(deltaX) * 0.3; // ã‚ˆã‚Šé«˜ã„å¼§
                
                const keyframes = [
                    { 
                        transform: `translate3d(0, 0, 0) scale(1)`,
                        opacity: 1
                    },
                    { 
                        transform: `translate3d(${(midX - startX)}px, ${(midY - startY)}px, 0) scale(1.5)`,
                        opacity: 1,
                        offset: 0.5
                    },
                    { 
                        transform: `translate3d(${deltaX}px, ${deltaY}px, 0) scale(2)`,
                        opacity: 0.8
                    }
                ];
                
                projectile.animate(keyframes, {
                    duration: duration * config.speed,
                    easing: 'cubic-bezier(0.22, 1, 0.36, 1)',
                    fill: 'forwards'
                }).addEventListener('finish', () => {
                    projectile.remove();
                    resolve();
                });
            });
        }

        // å±æ€§åˆ¥é£›ã³é“å…·ä½œæˆï¼ˆå¤§å‹åŒ–ï¼‰
        function createProjectile(attr, config, x, y) {
            const projectile = document.createElement('div');
            projectile.className = 'projectile';
            projectile.style.left = x + 'px';
            projectile.style.top = y + 'px';
            
            switch (attr) {
                case 'fire':
                    projectile.innerHTML = 'ğŸ”¥';
                    projectile.style.fontSize = '80px';
                    projectile.style.filter = `drop-shadow(0 0 40px ${config.colors[0]}) drop-shadow(0 0 80px ${config.colors[1]})`;
                    projectile.style.animation = 'fireball 0.6s linear infinite';
                    // ç«ã®ç²’å­ãƒˆãƒ¬ã‚¤ãƒ«è¿½åŠ 
                    for (let i = 0; i < 5; i++) {
                        const trail = document.createElement('div');
                        trail.innerHTML = 'ğŸ”¥';
                        trail.style.position = 'absolute';
                        trail.style.fontSize = '20px';
                        trail.style.opacity = '0.6';
                        trail.style.left = `-${i * 15}px`;
                        trail.style.top = '0px';
                        trail.style.animation = `fireball ${0.6 + i * 0.1}s linear infinite`;
                        projectile.appendChild(trail);
                    }
                    break;
                    
                case 'water':
                    projectile.style.width = '120px';
                    projectile.style.height = '16px';
                    projectile.style.background = `linear-gradient(90deg, transparent, ${config.colors[0]}, ${config.colors[1]}, transparent)`;
                    projectile.style.borderRadius = '8px';
                    projectile.style.boxShadow = `0 0 30px ${config.colors[0]}, 0 0 60px ${config.colors[1]}`;
                    projectile.style.animation = 'waterBlade 0.5s ease-in-out infinite';
                    // æ°´æ»´ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¿½åŠ 
                    for (let i = 0; i < 3; i++) {
                        const drop = document.createElement('div');
                        drop.innerHTML = 'ğŸ’§';
                        drop.style.position = 'absolute';
                        drop.style.fontSize = '24px';
                        drop.style.left = `${i * 30}px`;
                        drop.style.top = '-10px';
                        drop.style.animation = `waterBlade ${0.5 + i * 0.1}s ease-in-out infinite`;
                        projectile.appendChild(drop);
                    }
                    break;
                    
                case 'thunder':
                    projectile.innerHTML = 'âš¡';
                    projectile.style.fontSize = '100px';
                    projectile.style.filter = `drop-shadow(0 0 50px ${config.colors[1]}) drop-shadow(0 0 100px white)`;
                    projectile.style.animation = 'lightning 0.1s linear infinite';
                    // é›»æ’ƒã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¿½åŠ 
                    for (let i = 0; i < 4; i++) {
                        const bolt = document.createElement('div');
                        bolt.style.position = 'absolute';
                        bolt.style.width = '4px';
                        bolt.style.height = '60px';
                        bolt.style.background = config.colors[1];
                        bolt.style.left = `${Math.random() * 60 - 30}px`;
                        bolt.style.top = `${Math.random() * 60 - 30}px`;
                        bolt.style.transform = `rotate(${Math.random() * 360}deg)`;
                        bolt.style.boxShadow = `0 0 20px ${config.colors[1]}`;
                        bolt.style.animation = 'lightning 0.05s linear infinite';
                        projectile.appendChild(bolt);
                    }
                    break;
                    
                case 'wind':
                    projectile.innerHTML = 'ğŸŒªï¸';
                    projectile.style.fontSize = '90px';
                    projectile.style.filter = `drop-shadow(0 0 30px ${config.colors[0]})`;
                    projectile.style.animation = 'windBlade 0.4s ease-out infinite';
                    // é¢¨ã®æ¸¦ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¿½åŠ 
                    for (let i = 0; i < 6; i++) {
                        const swirl = document.createElement('div');
                        swirl.style.position = 'absolute';
                        swirl.style.width = '20px';
                        swirl.style.height = '20px';
                        swirl.style.border = `2px solid ${config.colors[0]}`;
                        swirl.style.borderRadius = '50%';
                        swirl.style.left = `${Math.cos(i * Math.PI / 3) * 40}px`;
                        swirl.style.top = `${Math.sin(i * Math.PI / 3) * 40}px`;
                        swirl.style.animation = `windBlade ${0.4 + i * 0.05}s ease-out infinite`;
                        projectile.appendChild(swirl);
                    }
                    break;
                    
                case 'earth':
                    projectile.innerHTML = 'ğŸª¨';
                    projectile.style.fontSize = '70px';
                    projectile.style.filter = `drop-shadow(0 0 20px ${config.colors[0]})`;
                    projectile.style.animation = 'rockSpike 0.3s ease-out infinite';
                    // å²©ã®ç ´ç‰‡ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¿½åŠ 
                    for (let i = 0; i < 4; i++) {
                        const rock = document.createElement('div');
                        rock.innerHTML = 'ğŸª¨';
                        rock.style.position = 'absolute';
                        rock.style.fontSize = '16px';
                        rock.style.left = `${(i % 2) * 40 - 20}px`;
                        rock.style.top = `${Math.floor(i / 2) * 40 - 20}px`;
                        rock.style.animation = `rockSpike ${0.3 + i * 0.1}s ease-out infinite`;
                        projectile.appendChild(rock);
                    }
                    break;
                    
                case 'light':
                    projectile.style.width = '160px';
                    projectile.style.height = '8px';
                    projectile.style.background = `linear-gradient(90deg, transparent, ${config.colors[1]}, ${config.colors[0]}, ${config.colors[1]}, transparent)`;
                    projectile.style.boxShadow = `0 0 60px ${config.colors[0]}, 0 0 120px white`;
                    projectile.style.animation = 'lightBeam 0.3s ease-in-out infinite';
                    // å…‰ã®ç²’å­ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¿½åŠ 
                    for (let i = 0; i < 8; i++) {
                        const particle = document.createElement('div');
                        particle.innerHTML = 'âœ¨';
                        particle.style.position = 'absolute';
                        particle.style.fontSize = '20px';
                        particle.style.left = `${i * 20}px`;
                        particle.style.top = `${Math.sin(i) * 20}px`;
                        particle.style.animation = `lightBeam ${0.3 + i * 0.02}s ease-in-out infinite`;
                        projectile.appendChild(particle);
                    }
                    break;
            }
            
            return projectile;
        }

        // ãƒ•ã‚§ãƒ¼ã‚º3: ãƒ’ãƒƒãƒˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        function playImpactEffect(fxLayer, attr, config, x, y) {
            return new Promise((resolve) => {
                // ãƒ’ãƒƒãƒˆéŸ³
                playSound('success');
                
                // ç”»é¢ã‚·ã‚§ã‚¤ã‚¯
                if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                    document.body.classList.add('shake-strong');
                    setTimeout(() => {
                        document.body.classList.remove('shake-strong');
                    }, 400);
                }
                
                // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                const flash = document.createElement('div');
                flash.className = 'impact-flash';
                flash.style.background = config.flashColor;
                flash.style.opacity = '0';
                fxLayer.appendChild(flash);
                
                flash.animate([
                    { opacity: 0 },
                    { opacity: 1 },
                    { opacity: 0 }
                ], {
                    duration: 200,
                    easing: 'ease-out'
                }).addEventListener('finish', () => {
                    flash.remove();
                });
                
                // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«çˆ†ç™º
                createParticleExplosion(fxLayer, attr, config, x, y);
                
                // å±æ€§åˆ¥ç‰¹æ®Šã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                createSpecialImpactEffect(fxLayer, attr, config, x, y);
                
                setTimeout(resolve, 500);
            });
        }

        // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«çˆ†ç™ºç”Ÿæˆï¼ˆç”»é¢å…¨ä½“ã‚¹ã‚±ãƒ¼ãƒ«ï¼‰
        function createParticleExplosion(fxLayer, attr, config, x, y) {
            const particleCount = Math.min(config.particles, 120); // ã‚¹ãƒãƒ›é…æ…®
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                const size = Math.random() * 16 + 8; // ã‚ˆã‚Šå¤§ããªãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
                const angle = (i / particleCount) * Math.PI * 2;
                const distance = Math.random() * 300 + 100; // ã‚ˆã‚Šåºƒç¯„å›²ã«æ•£ã‚‰ã°ã‚‹
                const dx = Math.cos(angle) * distance;
                const dy = Math.sin(angle) * distance;
                
                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                particle.style.left = (x - size/2) + 'px';
                particle.style.top = (y - size/2) + 'px';
                particle.style.background = config.colors[Math.floor(Math.random() * config.colors.length)];
                particle.style.borderRadius = '50%';
                particle.style.boxShadow = `0 0 ${size}px ${config.colors[0]}`;
                particle.style.setProperty('--dx', dx + 'px');
                particle.style.setProperty('--dy', dy + 'px');
                
                fxLayer.appendChild(particle);
                
                particle.animate([
                    { 
                        transform: 'scale(0) translate3d(0, 0, 0) rotate(0deg)',
                        opacity: 1
                    },
                    { 
                        transform: `scale(1.5) translate3d(${dx * 0.7}px, ${dy * 0.7}px, 0) rotate(180deg)`,
                        opacity: 0.8,
                        offset: 0.6
                    },
                    { 
                        transform: `scale(0.5) translate3d(${dx}px, ${dy}px, 0) rotate(360deg)`,
                        opacity: 0
                    }
                ], {
                    duration: 1200 + Math.random() * 600,
                    easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
                }).addEventListener('finish', () => {
                    particle.remove();
                });
            }
        }

        // å±æ€§åˆ¥ç‰¹æ®Šã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆç”»é¢å…¨ä½“ã‚¹ã‚±ãƒ¼ãƒ«ï¼‰
        function createSpecialImpactEffect(fxLayer, attr, config, x, y) {
            switch (attr) {
                case 'fire':
                    // å·¨å¤§ç«èŠ±ãƒªãƒ³ã‚°
                    for (let i = 0; i < 5; i++) {
                        const ring = document.createElement('div');
                        ring.style.position = 'absolute';
                        ring.style.left = (x - 100) + 'px';
                        ring.style.top = (y - 100) + 'px';
                        ring.style.width = '200px';
                        ring.style.height = '200px';
                        ring.style.border = `6px solid ${config.colors[0]}`;
                        ring.style.borderRadius = '50%';
                        ring.style.opacity = '0.8';
                        ring.style.boxShadow = `0 0 40px ${config.colors[0]}, inset 0 0 40px ${config.colors[1]}`;
                        fxLayer.appendChild(ring);
                        
                        ring.animate([
                            { transform: 'scale(0) rotate(0deg)', opacity: 0.8 },
                            { transform: 'scale(6) rotate(360deg)', opacity: 0 }
                        ], {
                            duration: 1000,
                            delay: i * 150,
                            easing: 'ease-out'
                        }).addEventListener('finish', () => ring.remove());
                    }
                    
                    // ç«ã®æŸ±ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                    const firePillar = document.createElement('div');
                    firePillar.style.position = 'absolute';
                    firePillar.style.left = (x - 50) + 'px';
                    firePillar.style.top = '0px';
                    firePillar.style.width = '100px';
                    firePillar.style.height = '100vh';
                    firePillar.style.background = `linear-gradient(0deg, transparent, ${config.colors[0]}, ${config.colors[1]}, transparent)`;
                    firePillar.style.opacity = '0.6';
                    fxLayer.appendChild(firePillar);
                    
                    firePillar.animate([
                        { opacity: 0, transform: 'scaleX(0)' },
                        { opacity: 0.6, transform: 'scaleX(1)' },
                        { opacity: 0, transform: 'scaleX(0)' }
                    ], {
                        duration: 800,
                        easing: 'ease-out'
                    }).addEventListener('finish', () => firePillar.remove());
                    break;
                    
                case 'water':
                    // å·¨å¤§æ°´ã®ãƒªãƒƒãƒ—ãƒ«
                    for (let i = 0; i < 4; i++) {
                        const ripple = document.createElement('div');
                        ripple.style.position = 'absolute';
                        ripple.style.left = (x - 150) + 'px';
                        ripple.style.top = (y - 150) + 'px';
                        ripple.style.width = '300px';
                        ripple.style.height = '300px';
                        ripple.style.border = `8px solid ${config.colors[1]}`;
                        ripple.style.borderRadius = '50%';
                        ripple.style.opacity = '0.7';
                        ripple.style.boxShadow = `0 0 60px ${config.colors[0]}`;
                        fxLayer.appendChild(ripple);
                        
                        ripple.animate([
                            { transform: 'scale(0)', opacity: 0.7 },
                            { transform: 'scale(8)', opacity: 0 }
                        ], {
                            duration: 1200,
                            delay: i * 250,
                            easing: 'ease-out'
                        }).addEventListener('finish', () => ripple.remove());
                    }
                    
                    // æ°´ã®æ³¢ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                    const wave = document.createElement('div');
                    wave.style.position = 'absolute';
                    wave.style.left = '0px';
                    wave.style.top = (y - 25) + 'px';
                    wave.style.width = '100vw';
                    wave.style.height = '50px';
                    wave.style.background = `linear-gradient(90deg, transparent, ${config.colors[0]}, ${config.colors[1]}, transparent)`;
                    wave.style.opacity = '0.5';
                    fxLayer.appendChild(wave);
                    
                    wave.animate([
                        { opacity: 0, transform: 'scaleY(0)' },
                        { opacity: 0.5, transform: 'scaleY(1)' },
                        { opacity: 0, transform: 'scaleY(0)' }
                    ], {
                        duration: 600,
                        easing: 'ease-out'
                    }).addEventListener('finish', () => wave.remove());
                    break;
                    
                case 'thunder':
                    // å·¨å¤§é›»æ’ƒã‚¢ãƒ¼ã‚¯
                    for (let i = 0; i < 8; i++) {
                        const arc = document.createElement('div');
                        arc.style.position = 'absolute';
                        arc.style.left = x + 'px';
                        arc.style.top = y + 'px';
                        arc.style.width = '8px';
                        arc.style.height = (Math.random() * 200 + 100) + 'px';
                        arc.style.background = config.colors[1];
                        arc.style.transformOrigin = 'top';
                        arc.style.transform = `rotate(${Math.random() * 360}deg)`;
                        arc.style.boxShadow = `0 0 40px ${config.colors[1]}, 0 0 80px white`;
                        fxLayer.appendChild(arc);
                        
                        arc.animate([
                            { opacity: 1, transform: `rotate(${Math.random() * 360}deg) scaleY(1)` },
                            { opacity: 0, transform: `rotate(${Math.random() * 360}deg) scaleY(0)` }
                        ], {
                            duration: 400,
                            delay: Math.random() * 300,
                            easing: 'ease-out'
                        }).addEventListener('finish', () => arc.remove());
                    }
                    
                    // ç”»é¢å…¨ä½“ã®é›»æ’ƒãƒ•ãƒ©ãƒƒã‚·ãƒ¥
                    const lightning = document.createElement('div');
                    lightning.style.position = 'absolute';
                    lightning.style.left = '0px';
                    lightning.style.top = '0px';
                    lightning.style.width = '100vw';
                    lightning.style.height = '100vh';
                    lightning.style.background = `radial-gradient(circle at ${x}px ${y}px, ${config.colors[1]} 0%, transparent 50%)`;
                    lightning.style.opacity = '0';
                    fxLayer.appendChild(lightning);
                    
                    lightning.animate([
                        { opacity: 0 },
                        { opacity: 0.8 },
                        { opacity: 0 },
                        { opacity: 0.6 },
                        { opacity: 0 }
                    ], {
                        duration: 500,
                        easing: 'ease-out'
                    }).addEventListener('finish', () => lightning.remove());
                    break;
                    
                case 'wind':
                    // å·¨å¤§ç«œå·»ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                    for (let i = 0; i < 3; i++) {
                        const tornado = document.createElement('div');
                        tornado.style.position = 'absolute';
                        tornado.style.left = (x - 75) + 'px';
                        tornado.style.top = '0px';
                        tornado.style.width = '150px';
                        tornado.style.height = '100vh';
                        tornado.style.background = `conic-gradient(from ${i * 120}deg, transparent, ${config.colors[0]}, transparent)`;
                        tornado.style.opacity = '0.4';
                        tornado.style.borderRadius = '50%';
                        fxLayer.appendChild(tornado);
                        
                        tornado.animate([
                            { transform: 'rotate(0deg) scaleX(0)', opacity: 0 },
                            { transform: 'rotate(720deg) scaleX(1)', opacity: 0.4 },
                            { transform: 'rotate(1440deg) scaleX(0)', opacity: 0 }
                        ], {
                            duration: 1000,
                            delay: i * 200,
                            easing: 'ease-out'
                        }).addEventListener('finish', () => tornado.remove());
                    }
                    break;
                    
                case 'earth':
                    // åœ°é¢å…¨ä½“ã®äº€è£‚ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                    for (let i = 0; i < 6; i++) {
                        const crack = document.createElement('div');
                        crack.style.position = 'absolute';
                        crack.style.left = '0px';
                        crack.style.top = (y + Math.random() * 100 - 50) + 'px';
                        crack.style.width = '100vw';
                        crack.style.height = '4px';
                        crack.style.background = config.colors[2] || config.colors[0];
                        crack.style.opacity = '0.8';
                        crack.style.transform = `rotate(${Math.random() * 10 - 5}deg)`;
                        fxLayer.appendChild(crack);
                        
                        crack.animate([
                            { transform: `scaleX(0) rotate(${Math.random() * 10 - 5}deg)`, opacity: 0 },
                            { transform: `scaleX(1) rotate(${Math.random() * 10 - 5}deg)`, opacity: 0.8 },
                            { transform: `scaleX(1) rotate(${Math.random() * 10 - 5}deg)`, opacity: 0 }
                        ], {
                            duration: 800,
                            delay: i * 100,
                            easing: 'ease-out'
                        }).addEventListener('finish', () => crack.remove());
                    }
                    break;
                    
                case 'light':
                    // å·¨å¤§æ˜Ÿå‹ãƒãƒ¼ã‚¹ãƒˆ
                    const star = document.createElement('div');
                    star.innerHTML = 'âœ¨';
                    star.style.position = 'absolute';
                    star.style.left = (x - 100) + 'px';
                    star.style.top = (y - 100) + 'px';
                    star.style.fontSize = '200px';
                    star.style.filter = `drop-shadow(0 0 100px ${config.colors[0]}) drop-shadow(0 0 200px white)`;
                    fxLayer.appendChild(star);
                    
                    star.animate([
                        { transform: 'scale(0) rotate(0deg)', opacity: 1 },
                        { transform: 'scale(3) rotate(360deg)', opacity: 0 }
                    ], {
                        duration: 800,
                        easing: 'ease-out'
                    }).addEventListener('finish', () => star.remove());
                    
                    // å…‰ã®æŸ±ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                    const lightBeam = document.createElement('div');
                    lightBeam.style.position = 'absolute';
                    lightBeam.style.left = (x - 25) + 'px';
                    lightBeam.style.top = '0px';
                    lightBeam.style.width = '50px';
                    lightBeam.style.height = '100vh';
                    lightBeam.style.background = `linear-gradient(0deg, transparent, ${config.colors[1]}, ${config.colors[0]}, transparent)`;
                    lightBeam.style.opacity = '0.8';
                    lightBeam.style.boxShadow = `0 0 100px ${config.colors[0]}`;
                    fxLayer.appendChild(lightBeam);
                    
                    lightBeam.animate([
                        { opacity: 0, transform: 'scaleX(0)' },
                        { opacity: 0.8, transform: 'scaleX(1)' },
                        { opacity: 0, transform: 'scaleX(0)' }
                    ], {
                        duration: 600,
                        easing: 'ease-out'
                    }).addEventListener('finish', () => lightBeam.remove());
                    break;
            }
        }

        // è¢«å¼¾ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆä¸æ­£è§£æ™‚ï¼‰
        function playHitEffect(playerIndex) {
            const avatarEl = document.getElementById(`player${playerIndex + 1}Avatar`);
            const fxLayer = getOrCreateFxLayer();
            
            // ç…™ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            const smoke = document.createElement('div');
            smoke.innerHTML = 'ğŸ’¨';
            smoke.style.position = 'absolute';
            smoke.style.fontSize = '30px';
            smoke.style.opacity = '0.8';
            
            const rect = avatarEl.getBoundingClientRect();
            smoke.style.left = rect.left + 'px';
            smoke.style.top = rect.top + 'px';
            
            fxLayer.appendChild(smoke);
            
            smoke.animate([
                { transform: 'scale(0.5) translateY(0)', opacity: 0.8 },
                { transform: 'scale(1.5) translateY(-30px)', opacity: 0 }
            ], {
                duration: 600,
                easing: 'ease-out'
            }).addEventListener('finish', () => smoke.remove());
            
            // èµ¤ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
            const flash = document.createElement('div');
            flash.className = 'impact-flash';
            flash.style.background = 'rgba(255, 107, 107, 0.4)';
            fxLayer.appendChild(flash);
            
            flash.animate([
                { opacity: 0 },
                { opacity: 1 },
                { opacity: 0 }
            ], {
                duration: 300,
                easing: 'ease-out'
            }).addEventListener('finish', () => flash.remove());
        }

        // ç­”ãˆé€ä¿¡
        async function submitAnswer() {
            const target = gameState.selectedCard.text;
            const targetLen = countChars(target);
            const remainingTime = gameState.timer;
            const timeUsed = Math.max(0, 15 - remainingTime);

            // çµ±è¨ˆï¼šè©¦è¡Œã”ã¨ã«æ›´æ–°
            gameState.stats.totalChars += targetLen;
            gameState.stats.totalTime += timeUsed;

            // ã„ãšã‚Œã‹ã®å€™è£œãŒå®Œäº†ã—ã¦ã„ã‚Œã°æˆåŠŸ
            const success = typingState.currentInputs.some(input => input.completed);
            console.log('é€ä¿¡æ™‚ã®æˆåŠŸåˆ¤å®š:', success);
            console.log(`æ–‡å­—æ•°: ${targetLen}, æ®‹ã‚Šæ™‚é–“: ${remainingTime}ç§’`);

            if (success) {
                // æ­£è§£å‡¦ç†
                const isHealCard = gameState.selectedCard.category === 'ã„ã‚Šã‚‡ã†';
                
                if (isHealCard) {
                    // åŒ»ç™‚ã‚«ãƒ¼ãƒ‰ - å›å¾©å‡¦ç†
                    const healAmount = Math.floor(targetLen * remainingTime);
                    console.log(`å›å¾©è¨ˆç®—: ${targetLen} Ã— ${remainingTime} = ${healAmount}`);
                    healPlayer(gameState.currentPlayer, healAmount);
                    playSound('heal');
                } else {
                    // é€šå¸¸ã‚«ãƒ¼ãƒ‰ - æ”»æ’ƒå‡¦ç†
                    const damage = Math.floor(targetLen * remainingTime);
                    console.log(`æ”»æ’ƒè¨ˆç®—: ${targetLen} Ã— ${remainingTime} = ${damage}`);
                    
                    // æ”»æ’ƒã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                    await playAttackAnimation({
                        attr: gameState.players[gameState.currentPlayer].attribute,
                        from: gameState.currentPlayer === 0 ? 'left' : 'right',
                        targetEl: document.getElementById(`player${2 - gameState.currentPlayer}Avatar`),
                        impactMs: 600
                    });
                    
                    // ãƒ€ãƒ¡ãƒ¼ã‚¸å‡¦ç†
                    dealDamage(1 - gameState.currentPlayer, damage);
                }
                
                gameState.stats.correctChars += targetLen;
                gameState.stats.combo++;
                gameState.stats.maxCombo = Math.max(gameState.stats.maxCombo, gameState.stats.combo);
            } else {
                // ä¸æ­£è§£ - è¢«å¼¾ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                playHitEffect(gameState.currentPlayer);
                const selfDamage = targetLen * 10;
                console.log(`è‡ªå‚·ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—: ${targetLen} Ã— 10 = ${selfDamage}`);
                dealDamage(gameState.currentPlayer, selfDamage);
                gameState.stats.combo = 0;
                playSound('fail');
            }
            
            endTurn();
        }

        // ã‚®ãƒ–ã‚¢ãƒƒãƒ—
        function giveUp() {
            const targetLen = countChars(gameState.selectedCard.text);
            const timeUsed = Math.max(0, 15 - gameState.timer);
            gameState.stats.totalChars += targetLen;
            gameState.stats.totalTime += timeUsed;

            // è¢«å¼¾ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            playHitEffect(gameState.currentPlayer);
            const selfDamage = targetLen * 10;
            dealDamage(gameState.currentPlayer, selfDamage);
            gameState.stats.combo = 0;
            playSound('fail');
            endTurn();
        }

        // æ™‚é–“åˆ‡ã‚Œ
        function timeUp() {
            const targetLen = countChars(gameState.selectedCard.text);
            gameState.stats.totalChars += targetLen;
            gameState.stats.totalTime += 15;

            // è¢«å¼¾ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            playHitEffect(gameState.currentPlayer);
            const selfDamage = targetLen * 10;
            dealDamage(gameState.currentPlayer, selfDamage);
            gameState.stats.combo = 0;
            playSound('fail');
            endTurn();
        }

        // ãƒ€ãƒ¡ãƒ¼ã‚¸å‡¦ç†
        function dealDamage(playerIndex, damage) {
            gameState.players[playerIndex].hp = Math.max(0, gameState.players[playerIndex].hp - damage);
            
            // ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            showDamageEffect(playerIndex, damage);
            
            // HPæ›´æ–°
            updateUI();
            
            // å‹æ•—åˆ¤å®š
            if (gameState.players[playerIndex].hp <= 0) {
                endGame(1 - playerIndex);
            }
        }

        // å›å¾©å‡¦ç†
        function healPlayer(playerIndex, healAmount) {
            const player = gameState.players[playerIndex];
            const actualHeal = Math.min(healAmount, player.maxHp - player.hp);
            player.hp = Math.min(player.maxHp, player.hp + actualHeal);
            
            // å›å¾©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            showHealEffect(playerIndex, actualHeal);
            
            // HPæ›´æ–°
            updateUI();
        }

        // ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¡¨ç¤º
        function showDamageEffect(playerIndex, damage) {
            const avatar = document.getElementById(`player${playerIndex + 1}Avatar`);
            const damageElement = document.createElement('div');
            damageElement.className = 'damage-number';
            damageElement.textContent = `-${damage}`;
            damageElement.style.left = '50%';
            damageElement.style.top = '50%';
            
            avatar.style.position = 'relative';
            avatar.appendChild(damageElement);
            
            // ã‚·ã‚§ã‚¤ã‚¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            avatar.classList.add('shake');
            setTimeout(() => {
                avatar.classList.remove('shake');
                if (damageElement.parentNode) {
                    damageElement.remove();
                }
            }, 1000);
        }

        // å›å¾©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¡¨ç¤º
        function showHealEffect(playerIndex, healAmount) {
            const avatar = document.getElementById(`player${playerIndex + 1}Avatar`);
            const healElement = document.createElement('div');
            healElement.className = 'damage-number heal';
            healElement.textContent = `+${healAmount}`;
            healElement.style.left = '50%';
            healElement.style.top = '50%';
            healElement.style.color = '#4ecdc4';
            
            avatar.style.position = 'relative';
            avatar.appendChild(healElement);
            
            // å›å¾©ã®å…‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            avatar.style.boxShadow = '0 0 30px rgba(76, 220, 196, 0.8)';
            avatar.style.transform = 'scale(1.1)';
            
            setTimeout(() => {
                avatar.style.boxShadow = '';
                avatar.style.transform = '';
                if (healElement.parentNode) {
                    healElement.remove();
                }
            }, 1000);
            
            // å›å¾©ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
            createHealParticles(avatar);
        }

        // å›å¾©ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ç”Ÿæˆ
        function createHealParticles(avatarEl) {
            const fxLayer = getOrCreateFxLayer();
            const rect = avatarEl.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            for (let i = 0; i < 12; i++) {
                const particle = document.createElement('div');
                particle.innerHTML = 'âœ¨';
                particle.style.position = 'absolute';
                particle.style.left = centerX + 'px';
                particle.style.top = centerY + 'px';
                particle.style.fontSize = '20px';
                particle.style.color = '#4ecdc4';
                particle.style.pointerEvents = 'none';
                particle.style.zIndex = '1000';
                
                const angle = (i / 12) * Math.PI * 2;
                const distance = 60;
                const dx = Math.cos(angle) * distance;
                const dy = Math.sin(angle) * distance;
                
                fxLayer.appendChild(particle);
                
                particle.animate([
                    { 
                        transform: 'translate(-50%, -50%) scale(0)',
                        opacity: 1
                    },
                    { 
                        transform: `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px)) scale(1.5)`,
                        opacity: 0.8,
                        offset: 0.7
                    },
                    { 
                        transform: `translate(calc(-50% + ${dx * 1.5}px), calc(-50% + ${dy * 1.5}px)) scale(0)`,
                        opacity: 0
                    }
                ], {
                    duration: 1000,
                    easing: 'ease-out'
                }).addEventListener('finish', () => {
                    particle.remove();
                });
            }
        }

        // ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¡¨ç¤º
        function showPenaltyEffect() {
            const timerRing = document.getElementById('timerRing');
            const penaltyElement = document.createElement('div');
            penaltyElement.className = 'damage-number';
            penaltyElement.textContent = '-3ç§’';
            penaltyElement.style.left = '50%';
            penaltyElement.style.top = '20%';
            penaltyElement.style.color = '#ff6b6b';
            penaltyElement.style.fontSize = '20px';
            
            timerRing.style.position = 'relative';
            timerRing.appendChild(penaltyElement);
            
            // ã‚¿ã‚¤ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’èµ¤ãç‚¹æ»…
            timerRing.style.boxShadow = '0 0 20px rgba(255, 107, 107, 0.8)';
            setTimeout(() => {
                timerRing.style.boxShadow = '';
                if (penaltyElement.parentNode) {
                    penaltyElement.remove();
                }
            }, 1000);
        }

        // ã‚¿ãƒ¼ãƒ³çµ‚äº†
        function endTurn() {
            clearInterval(gameState.timerInterval);
            
            // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç„¡åŠ¹åŒ–
            document.removeEventListener('keydown', handleKeyPress);
            
            // ä½¿ç”¨ã—ãŸã‚«ãƒ¼ãƒ‰ã‚’æ¨ã¦æœ­ã«
            const handIndex = gameState.hands[gameState.currentPlayer].indexOf(gameState.selectedCard);
            gameState.hands[gameState.currentPlayer].splice(handIndex, 1);
            gameState.discard.push(gameState.selectedCard);
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã¯éè¡¨ç¤ºã®ãŸã‚ãƒªã‚»ãƒƒãƒˆä¸è¦
            
            // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('typingGuideJP').style.setProperty('--fill', '0%');
            document.getElementById('typingGuideSub').innerHTML = '';
            document.getElementById('romajiGuide').innerHTML = '';
            
            // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            typingState = {
                targetOptions: [],
                currentInputs: [],
                typedKeys: ''
            };
            
            // çµæœãƒ•ã‚§ãƒ¼ã‚ºã«ç§»è¡Œ
            gameState.gamePhase = 'result';
            updatePhaseDisplay();
            
            // æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«äº¤ä»£
            gameState.currentPlayer = 1 - gameState.currentPlayer;
            gameState.gamePhase = 'cardSelect';
            gameState.selectedCard = null;
            
            // CPUã‚¿ãƒ¼ãƒ³ã¾ãŸã¯æ¬¡ã®ã‚¿ãƒ¼ãƒ³é–‹å§‹ï¼ˆå°‘ã—é…å»¶ã‚’å…¥ã‚Œã‚‹ï¼‰
            setTimeout(() => {
                if (gameState.mode === 'cpu' && gameState.currentPlayer === 1) {
                    cpuTurn();
                } else {
                    startTurn();
                }
            }, 2000); // ãƒ€ãƒ¡ãƒ¼ã‚¸æ¼”å‡ºã‚’è¦‹ã›ã‚‹ãŸã‚2ç§’ã«å»¶é•·
        }

        // ã‚¿ãƒ¼ãƒ³é–‹å§‹
        function startTurn() {
            showTurnPopup();
            updateUI();
            drawCards();
            drawPlayerHand();
            
            // ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('timerRing').textContent = '15';
            document.getElementById('timerRing').style.background = 
                'conic-gradient(#feca57 360deg, rgba(255, 255, 255, 0.2) 360deg)';
        }

        // ã‚¿ãƒ¼ãƒ³åˆ‡ã‚Šæ›¿ãˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
        function showTurnPopup() {
            const popup = document.createElement('div');
            popup.className = 'turn-popup';
            popup.innerHTML = `<h2>${gameState.players[gameState.currentPlayer].name}ã®ã‚¿ãƒ¼ãƒ³</h2>`;
            document.body.appendChild(popup);
            
            setTimeout(() => {
                if (popup.parentNode) {
                    popup.remove();
                }
            }, 2000);
        }

        // CPUã‚¿ãƒ¼ãƒ³
        async function cpuTurn() {
            updateUI();
            drawCards(); // â˜…è¿½åŠ ï¼šCPUã‚‚ã¡ã‚ƒã‚“ã¨1æšå¼•ã
            drawPlayerHand(); // æ‰‹æœ­è¡¨ç¤ºã‚‚æ›´æ–°
            
            setTimeout(async () => {
                // CPUã‚«ãƒ¼ãƒ‰é¸æŠï¼ˆç°¡æ˜“AIï¼‰
                const hand = gameState.hands[1];
                let bestCard = hand[0];
                let bestScore = -1;
                
                hand.forEach(card => {
                    // æœŸå¾…ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—ï¼ˆç°¡æ˜“ï¼‰
                    const expectedTime = Math.random() * 10 + 5; // 5-15ç§’
                    const expectedDamage = card.text.length * expectedTime;
                    const failRisk = card.difficulty * 20; // é›£æ˜“åº¦ã«ã‚ˆã‚‹å¤±æ•—ãƒªã‚¹ã‚¯
                    const score = expectedDamage - failRisk;
                    
                    if (score > bestScore) {
                        bestScore = score;
                        bestCard = card;
                    }
                });
                
                gameState.selectedCard = bestCard;
                
                // CPUå…¥åŠ›ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                setTimeout(async () => {
                    const success = Math.random() > (bestCard.difficulty * 0.2); // é›£æ˜“åº¦ã«ã‚ˆã‚‹æˆåŠŸç‡
                    
                    if (success) {
                        const cpuRemainingTime = Math.random() * 8 + 2; // 2-10ç§’æ®‹ã‚Šæ™‚é–“
                        const charCount = countChars(bestCard.text);
                        const isHealCard = bestCard.category === 'ã„ã‚Šã‚‡ã†';
                        
                        console.log(`CPU: æ–‡å­—æ•°=${charCount}, æ®‹ã‚Šæ™‚é–“=${cpuRemainingTime.toFixed(1)}ç§’`);
                        
                        if (isHealCard) {
                            // CPUå›å¾©å‡¦ç†
                            const healAmount = Math.floor(charCount * cpuRemainingTime);
                            console.log(`CPUå›å¾©è¨ˆç®—: ${charCount} Ã— ${cpuRemainingTime.toFixed(1)} = ${healAmount}`);
                            healPlayer(1, healAmount);
                            playSound('heal');
                        } else {
                            // CPUæ”»æ’ƒå‡¦ç†
                            const damage = Math.floor(charCount * cpuRemainingTime);
                            console.log(`CPUæ”»æ’ƒè¨ˆç®—: ${charCount} Ã— ${cpuRemainingTime.toFixed(1)} = ${damage}`);
                            
                            // CPUæ”»æ’ƒã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                            await playAttackAnimation({
                                attr: gameState.players[1].attribute,
                                from: 'right',
                                targetEl: document.getElementById('player1Avatar'),
                                impactMs: 600
                            });
                            
                            dealDamage(0, damage);
                        }
                        
                        gameState.stats.correctChars += charCount;
                        gameState.stats.totalChars += charCount;
                        gameState.stats.totalTime += (15 - cpuRemainingTime);
                    } else {
                        const charCount = countChars(bestCard.text);
                        const selfDamage = charCount * 10;
                        
                        console.log(`CPUè‡ªå‚·ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—: ${charCount} Ã— 10 = ${selfDamage}`);
                        
                        // CPUè¢«å¼¾ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                        playHitEffect(1);
                        dealDamage(1, selfDamage);
                        
                        gameState.stats.totalChars += charCount;
                        gameState.stats.totalTime += 15;
                        
                        playSound('fail');
                    }
                    
                    endTurn();
                }, 2000);
            }, 1000);
        }

        // ã‚²ãƒ¼ãƒ çµ‚äº†
        function endGame(winner) {
            gameState.gamePhase = 'result';
            
            const winnerName = gameState.players[winner].name;
            const accuracy = gameState.stats.totalChars > 0 ? 
                Math.round((gameState.stats.correctChars / gameState.stats.totalChars) * 100) : 0;
            const avgTime = gameState.stats.totalChars > 0 ? 
                Math.round((gameState.stats.totalTime / gameState.stats.totalChars) * 10) / 10 : 0;
            
            showModal(`ğŸ‰ ${winnerName}ã®å‹åˆ©ï¼`, `
                <p>ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</p>
                <p><strong>æˆ¦ç¸¾</strong></p>
                <p>æœ€å¤§ã‚³ãƒ³ãƒœ: ${gameState.stats.maxCombo}</p>
                <p>æ­£ç¢ºæ€§: ${accuracy}%</p>
                <p>å¹³å‡å…¥åŠ›æ™‚é–“: ${avgTime}ç§’/æ–‡å­—</p>
                <button class="btn btn-primary" onclick="backToMenu()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
                <button class="btn btn-secondary" onclick="restartGame()">ã‚‚ã†ä¸€åº¦</button>
            `);
        }

        // éŸ³å£°å†ç”Ÿ
        function playSound(type) {
            if (!gameState.soundEnabled) return;
            
            // ç°¡æ˜“éŸ³å£°ï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯é©åˆ‡ãªéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ï¼‰
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            if (type === 'success') {
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
            } else if (type === 'heal') {
                // å›å¾©éŸ³ï¼šç¾ã—ã„å’ŒéŸ³
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
                oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
                oscillator.frequency.setValueAtTime(1046.50, audioContext.currentTime + 0.3); // C6
            } else if (type === 'charge') {
                // æºœã‚éŸ³ï¼šä½éŸ³ã‹ã‚‰é«˜éŸ³ã¸
                oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.3);
            } else {
                oscillator.frequency.setValueAtTime(220, audioContext.currentTime); // A3
            }
            
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + (type === 'heal' ? 0.5 : 0.3));
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + (type === 'heal' ? 0.5 : 0.3));
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
        function showModal(title, content) {
            document.getElementById('modalContent').innerHTML = `
                <h2>${title}</h2>
                ${content}
            `;
            document.getElementById('modal').style.display = 'flex';
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«éè¡¨ç¤º
        function hideModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
        function showHelp() {
            showModal('ğŸ“– ã‚²ãƒ¼ãƒ ã®éŠã³æ–¹', `
                <p><strong>åŸºæœ¬ãƒ«ãƒ¼ãƒ«</strong></p>
                <p>â€¢ è¨­å®šã—ãŸHPã§ã‚¹ã‚¿ãƒ¼ãƒˆ</p>
                <p>â€¢ æ‰‹æœ­ã‹ã‚‰1æšé¸ã‚“ã§ã‚¿ã‚¤ãƒ”ãƒ³ã‚°</p>
                <p>â€¢ 15ç§’ä»¥å†…ã«ãƒ­ãƒ¼ãƒå­—ã§å…¥åŠ›</p>
                <p>â€¢ æˆåŠŸï¼šæ–‡å­—æ•°Ã—æ®‹ã‚Šæ™‚é–“ã§ãƒ€ãƒ¡ãƒ¼ã‚¸</p>
                <p>â€¢ å¤±æ•—ï¼šæ–‡å­—æ•°Ã—10ã®è‡ªå‚·ãƒ€ãƒ¡ãƒ¼ã‚¸</p>
                <p>â€¢ æ‰“ã¡é–“é•ãˆï¼š3ç§’ãƒšãƒŠãƒ«ãƒ†ã‚£</p>
                <p><strong>ğŸ’š åŒ»ç™‚ã‚«ãƒ¼ãƒ‰</strong></p>
                <p>â€¢ ç·‘è‰²ã®ã‚ªãƒ¼ãƒ©ãŒç›®å°</p>
                <p>â€¢ æˆåŠŸã™ã‚‹ã¨è‡ªåˆ†ã®HPãŒå›å¾©</p>
                <p>â€¢ å›å¾©é‡ï¼šæ–‡å­—æ•°Ã—æ®‹ã‚Šæ™‚é–“</p>
                <p><strong>æ“ä½œæ–¹æ³•</strong></p>
                <p>â€¢ ã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ</p>
                <p>â€¢ ãƒ­ãƒ¼ãƒå­—ã§å…¥åŠ›ï¼ˆå…¨è§’ã§ã‚‚OKï¼‰</p>
                <p>â€¢ ESCã‚­ãƒ¼ã§ã‚®ãƒ–ã‚¢ãƒƒãƒ—</p>
                <button class="btn btn-primary" onclick="hideModal()">é–‰ã˜ã‚‹</button>
            `);
        }

        // éŸ³é‡åˆ‡ã‚Šæ›¿ãˆ
        function toggleSound() {
            gameState.soundEnabled = !gameState.soundEnabled;
            document.getElementById('soundBtn').textContent = gameState.soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
        }

        // ã‚²ãƒ¼ãƒ ä¸€æ™‚åœæ­¢
        function pauseGame() {
            if (gameState.gamePhase !== 'typing') return;

            if (!gameState.isPaused) {
                gameState.isPaused = true;
                document.getElementById('pauseBtn').textContent = 'â–¶ï¸';
                showModal('â¸ï¸ ä¸€æ™‚åœæ­¢', `
                    <p>ã‚²ãƒ¼ãƒ ã‚’ä¸€æ™‚åœæ­¢ã—ã¾ã—ãŸ</p>
                    <button class="btn btn-primary" onclick="resumeGame()">å†é–‹</button>
                `);
            } else {
                resumeGame();
            }
        }

        // ã‚²ãƒ¼ãƒ å†é–‹
        function resumeGame() {
            gameState.isPaused = false;
            document.getElementById('pauseBtn').textContent = 'â¸ï¸';
            hideModal();
        }

        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
        function backToMenu() {
            // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
            gameState = {
                mode: null,
                maxHP: 200,
                players: [
                    { name: 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1', hp: 200, maxHp: 200, avatar: 'ğŸ”¥', attribute: 'fire' },
                    { name: 'CPU', hp: 200, maxHp: 200, avatar: 'ğŸ¤–', attribute: 'water' }
                ],
                currentPlayer: 0,
                selectedCard: null,
                hands: [[], []],
                deck: [],
                discard: [],
                timer: 15,
                timerInterval: null,
                gamePhase: 'cardSelect',
                soundEnabled: true,
                isPaused: false,
                stats: {
                    totalChars: 0,
                    correctChars: 0,
                    totalTime: 0,
                    combo: 0,
                    maxCombo: 0
                }
            };
            
            clearInterval(gameState.timerInterval);
            hideModal();
            document.getElementById('gameContainer').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
            document.getElementById('characterSelection').classList.add('hidden');
            document.getElementById('gameRules').classList.add('hidden');
            document.getElementById('player2Setup').classList.add('hidden');
            
            // é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.mode-btn, .character-btn, .hp-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆHPé¸æŠ
            document.querySelector('[data-hp="200"]').classList.add('selected');
            
            // åå‰å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('player1NameInput').value = 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1';
            document.getElementById('player2NameInput').value = 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2';
            document.getElementById('nextBtn').disabled = true;
        }

        // ã‚²ãƒ¼ãƒ å†é–‹å§‹
        function restartGame() {
            hideModal();
            
            // HPå›å¾©
            gameState.players.forEach(player => {
                player.hp = player.maxHp;
            });
            
            // çµ±è¨ˆãƒªã‚»ãƒƒãƒˆ
            gameState.stats = {
                totalChars: 0,
                correctChars: 0,
                totalTime: 0,
                combo: 0,
                maxCombo: 0
            };
            
            gameState.currentPlayer = 0;
            gameState.gamePhase = 'cardSelect';
            
            initGame();
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.addEventListener('DOMContentLoaded', function() {
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            document.getElementById('modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideModal();
                }
            });

            // åå‰å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('player1NameInput').addEventListener('input', function() {
                gameState.players[0].name = this.value || 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1';
                checkSetupComplete();
            });

            document.getElementById('player2NameInput').addEventListener('input', function() {
                gameState.players[1].name = this.value || 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2';
                checkSetupComplete();
            });
        });

        // åˆæœŸåŒ–
        console.log('ğŸ® ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒãƒˆãƒ« - å­¦ç¿’ã‚²ãƒ¼ãƒ ');
        console.log('ğŸ“ ã‚«ãƒ¼ãƒ‰è¿½åŠ æ–¹æ³•: CARD_POOLé…åˆ—ã«æ–°ã—ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ ');
        console.log('ğŸ¨ å±æ€§ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º: CSSå¤‰æ•° --attr-color ã‚’å¤‰æ›´');
        console.log('ğŸ”Š éŸ³å£°ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º: playSoundé–¢æ•°ã‚’ç·¨é›†');
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'977a15fc87b79d04',t:'MTc1NjYxNzcwMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
