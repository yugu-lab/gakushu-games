<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒãƒˆãƒ« - å­¦ç¿’ã‚²ãƒ¼ãƒ </title>
  <link href="https://fonts.googleapis.com/css2?family=BIZ+UDGothic:wght@400;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'BIZ UDGothic',sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;overflow-x:hidden;user-select:none;
    }
    .game-container{width:100vw;height:100vh;display:flex;flex-direction:column;position:relative}
    /* ãƒˆãƒƒãƒ—ãƒãƒ¼ */
    .top-bar{
      height:80px;background:rgba(255,255,255,.1);backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(255,255,255,.2);display:flex;align-items:center;justify-content:space-between;padding:0 20px;
    }
    .player-info{display:flex;align-items:center;gap:15px;min-width:300px}
    .avatar{
      width:50px;height:50px;border-radius:50%;background:linear-gradient(45deg,#ff6b6b,#feca57);
      display:flex;align-items:center;justify-content:center;font-size:24px;border:3px solid rgba(255,255,255,.3)
    }
    .player-stats{flex:1}
    .player-name{font-weight:700;color:#fff;font-size:16px;margin-bottom:5px}
    .hp-bar-container{
      width:200px;height:20px;background:rgba(0,0,0,.3);border-radius:10px;overflow:hidden;position:relative
    }
    .hp-bar{height:100%;background:linear-gradient(90deg,#ff6b6b,#feca57);transition:width .5s ease;border-radius:10px}
    .hp-text{
      position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
      color:#fff;font-size:12px;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,.5)
    }
    .center-info{text-align:center;color:#fff}
    .turn-display{font-size:18px;font-weight:700;margin-bottom:5px}
    .phase-display{font-size:14px;opacity:.8;margin-bottom:10px}
    .timer-ring{
      width:60px;height:60px;border-radius:50%;
      background:conic-gradient(#feca57 0deg,rgba(255,255,255,.2) 0deg);
      display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:#fff;margin:0 auto;
    }
    /* ã‚«ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ */
    .card-area{flex:1;padding:20px;display:flex;flex-direction:column;gap:20px}
    .cards-container{
      display:grid;grid-template-columns:repeat(6,1fr);gap:15px;max-width:1200px;margin:0 auto;
    }

    /* --- Fancy Card (æ˜ ãˆã‚‹) --- */
    .card{
      position:relative;border-radius:16px;min-height:140px;cursor:pointer;
      padding:18px 16px 20px;transform-style:preserve-3d;
      transition:transform .2s ease,box-shadow .2s ease;
      background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.10)) padding-box,
                 linear-gradient(120deg,rgba(255,255,255,.25),rgba(255,255,255,0)) border-box;
      border:2px solid transparent;box-shadow:0 10px 25px rgba(0,0,0,.25);overflow:hidden;
    }
    .card::before{
      content:"";position:absolute;inset:-2px;border-radius:18px;
      background:conic-gradient(from 0deg,var(--attr-color,#feca57),#a78bfa,#22d3ee,var(--attr-color,#feca57));
      z-index:-1;filter:blur(8px);opacity:.35;
    }
    .card::after{
      content:"";position:absolute;inset:0;
      background:linear-gradient(120deg,transparent 0%,rgba(255,255,255,.15) 30%,transparent 60%);
      transform:translateX(-120%);animation:cardShine 3s linear infinite;pointer-events:none;
    }
    @keyframes cardShine{0%{transform:translateX(-120%)}100%{transform:translateX(120%)}}
    .card:hover{transform:translateY(-6px) rotateX(6deg) rotateY(-4deg);box-shadow:0 18px 40px rgba(0,0,0,.35)}
    .card.selected{box-shadow:0 0 0 3px rgba(254,202,87,.7),0 18px 40px rgba(0,0,0,.45)}
    .card-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:8px}
    .pill{font-size:11px;font-weight:700;color:#1b1b1b;background:#ffd54a;padding:4px 8px;border-radius:999px;letter-spacing:.04em}
    .stars{font-size:12px;color:#ffe28a;text-shadow:0 1px 2px rgba(0,0,0,.4)}
    .card-text{font-size:22px;font-weight:800;color:#fff;letter-spacing:.06em;text-shadow:0 2px 8px rgba(0,0,0,.35)}
    .card[data-attr="fire"]{--attr-color:#ff6b6b}
    .card[data-attr="water"]{--attr-color:#4ecdc4}
    .card[data-attr="thunder"]{--attr-color:#ffe66d}
    .card[data-attr="wind"]{--attr-color:#95e1d3}
    .card[data-attr="earth"]{--attr-color:#a8e6cf}
    .card[data-attr="light"]{--attr-color:#ffd93d}

    /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
    .input-area{
      height:150px;background:rgba(255,255,255,.1);backdrop-filter:blur(10px);
      border-top:1px solid rgba(255,255,255,.2);padding:20px;display:flex;align-items:center;gap:20px
    }
    .input-container{flex:1;display:flex;flex-direction:column;gap:10px}
    .input-field{
      width:100%;height:50px;border:2px solid rgba(255,255,255,.3);
      border-radius:25px;padding:0 20px;font-size:18px;font-family:'BIZ UDGothic',sans-serif;background:rgba(255,255,255,.9);outline:none
    }
    .input-field:focus{border-color:#feca57;box-shadow:0 0 10px rgba(254,202,87,.3)}
    .progress-bar{width:100%;height:8px;background:rgba(255,255,255,.3);border-radius:4px;overflow:hidden}
    .progress-fill{height:100%;background:linear-gradient(90deg,#ff6b6b,#feca57);width:0%;transition:width .2s ease}
    .action-buttons{display:flex;flex-direction:column;gap:10px}
    .btn{
      padding:12px 24px;border:none;border-radius:25px;font-family:'BIZ UDGothic',sans-serif;
      font-weight:700;cursor:pointer;transition:all .3s ease;font-size:14px
    }
    .btn-primary{background:linear-gradient(45deg,#feca57,#ff9ff3);color:#fff}
    .btn-secondary{background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.3)}
    .btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,.2)}

    /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
    .controls{position:fixed;bottom:20px;left:20px;display:flex;gap:10px}
    .control-btn{
      width:50px;height:50px;border-radius:50%;background:rgba(255,255,255,.2);
      border:1px solid rgba(255,255,255,.3);color:#fff;font-size:20px;cursor:pointer;
      display:flex;align-items:center;justify-content:center;transition:all .3s ease
    }
    .control-btn:hover{background:rgba(255,255,255,.3)}

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal{
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000
    }
    .modal-content{
      background:rgba(255,255,255,.95);backdrop-filter:blur(20px);border-radius:20px;
      padding:40px;text-align:center;max-width:500px;width:90%
    }
    .modal h2{color:#333;margin-bottom:20px;font-size:24px}
    .modal p{color:#666;margin-bottom:15px;line-height:1.6}

    /* ãƒ€ãƒ¡ãƒ¼ã‚¸ */
    .damage-number{
      position:absolute;font-size:24px;font-weight:700;color:#ff6b6b;pointer-events:none;animation:damageFloat 1s ease-out forwards
    }
    @keyframes damageFloat{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-50px)}}
    .hidden{display:none!important}
    .shake{animation:shake .5s ease-in-out}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}

    /* ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰ */
    .typing-guide{text-align:center;color:#fff;margin-bottom:6px;user-select:none}
    .typing-guide .jp{font-size:32px;line-height:1.1;letter-spacing:.06em;font-weight:700}
    @media (min-width:1024px){.typing-guide .jp{font-size:40px}}
    .typing-guide .sub{font-size:14px;opacity:.9;margin-top:6px;letter-spacing:.08em}
    .jp-progress{
      display:inline-block;background:linear-gradient(90deg,#feca57 var(--fill,0%),rgba(255,255,255,.95) var(--fill,0%));
      -webkit-background-clip:text;background-clip:text;color:transparent;transition:background .12s linear
    }
    .sub .char{padding:0 .06em;transition:color .08s,transform .04s}
    .sub .char.matched{color:#feca57}
    .sub .char.current{border-bottom:2px solid #feca57}
    .sub .char.pending{color:rgba(255,255,255,.85);opacity:.75}
    .romaji-guide{text-align:center;color:#fff;margin-bottom:10px;font-size:24px;font-weight:700;letter-spacing:.1em;min-height:40px}
    .romaji-char{display:inline-block;padding:0 2px;transition:color .1s ease}
    .romaji-char.typed{color:#feca57}
    .romaji-char.current{background:rgba(254,202,87,.3);border-radius:4px}

    /* ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ */
    .countdown-overlay{
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1500
    }
    .countdown-number{
      font-size:120px;font-weight:900;color:#feca57;text-shadow:0 0 30px rgba(254,202,87,.5);
      animation:countdownPulse 1s ease-in-out
    }
    @keyframes countdownPulse{0%{transform:scale(.5);opacity:0}50%{transform:scale(1.2);opacity:1}100%{transform:scale(1);opacity:1}}

    /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ */
    .start-screen{
      position:fixed;inset:0;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      display:flex;align-items:center;justify-content:center;z-index:2000
    }
    .start-content{text-align:center;color:#fff}
    .start-content h1{font-size:48px;margin-bottom:30px;text-shadow:2px 2px 4px rgba(0,0,0,.3)}
    .mode-selection{display:flex;gap:30px;margin-bottom:30px;justify-content:center}
    .mode-btn{
      padding:30px 40px;background:rgba(255,255,255,.2);border:3px solid rgba(255,255,255,.3);
      border-radius:20px;color:#fff;cursor:pointer;transition:all .3s ease;min-width:200px;text-align:center
    }
    .mode-btn:hover{background:rgba(255,255,255,.3);transform:translateY(-5px);box-shadow:0 10px 30px rgba(0,0,0,.3)}
    .mode-btn.selected{background:rgba(254,202,87,.3);border-color:#feca57;box-shadow:0 0 30px rgba(254,202,87,.5)}
    .mode-icon{font-size:48px;margin-bottom:10px}
    .mode-title{font-size:24px;font-weight:700;margin-bottom:8px}
    .mode-desc{font-size:14px;opacity:.8}
    .character-selection{display:grid;grid-template-columns:repeat(6,1fr);gap:15px;margin:20px 0;max-width:600px}
    .character-btn{
      width:80px;height:80px;border-radius:50%;border:3px solid rgba(255,255,255,.3);
      cursor:pointer;transition:all .3s ease;display:flex;align-items:center;justify-content:center;font-size:32px
    }
    .character-btn.selected{border-color:#feca57;box-shadow:0 0 20px rgba(254,202,87,.5)}
    .name-input{
      width:300px;height:50px;border:2px solid rgba(255,255,255,.3);border-radius:25px;padding:0 20px;font-size:18px;
      font-family:'BIZ UDGothic',sans-serif;background:rgba(255,255,255,.9);outline:none;margin-bottom:20px;text-align:center
    }
    .name-input:focus{border-color:#feca57;box-shadow:0 0 10px rgba(254,202,87,.3)}
    .rules-content{text-align:left;max-width:600px;margin:0 auto}
    .rule-item{display:flex;align-items:flex-start;gap:20px;margin-bottom:25px;padding:20px;background:rgba(255,255,255,.1);border-radius:15px;backdrop-filter:blur(10px)}
    .rule-icon{font-size:32px;min-width:50px}
    .rule-text h4{margin:0 0 8px 0;font-size:18px;color:#feca57}
    .rule-text p{margin:0;line-height:1.5}

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width:1024px){.cards-container{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:768px){
      .cards-container{grid-template-columns:repeat(2,1fr)}
      .top-bar{height:60px;padding:0 10px}
      .player-info{min-width:200px}
      .hp-bar-container{width:150px}
    }
  </style>
</head>
<body>
  <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
  <div class="start-screen" id="startScreen">
    <div class="start-content">
      <h1>âš”ï¸ ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒãƒˆãƒ«</h1>
      <p style="font-size:18px;margin-bottom:30px;">å­¦ç¿’ã—ãªãŒã‚‰æ¥½ã—ãã‚¿ã‚¤ãƒ”ãƒ³ã‚°ï¼</p>

      <div class="mode-selection">
        <button class="mode-btn" id="cpuModeBtn" onclick="selectMode('cpu')">
          <div class="mode-icon">ğŸ¤–</div>
          <div class="mode-title">CPUæˆ¦</div>
          <div class="mode-desc">ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã¨å¯¾æˆ¦</div>
        </button>
        <button class="mode-btn" id="pvpModeBtn" onclick="selectMode('pvp')">
          <div class="mode-icon">ğŸ‘¥</div>
          <div class="mode-title">2äººå¯¾æˆ¦</div>
          <div class="mode-desc">å‹é”ã¨ä¸€ç·’ã«å¯¾æˆ¦</div>
        </button>
      </div>

      <div id="characterSelection" class="hidden">
        <div id="player1Setup">
          <h3 style="margin-bottom:20px;">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®è¨­å®š</h3>
          <input type="text" id="player1NameInput" class="name-input" value="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1" placeholder="åå‰ã‚’å…¥åŠ›">
          <div class="character-selection">
            <div class="character-btn fire" data-attr="fire" data-player="1" onclick="selectCharacter('fire',1)">ğŸ”¥</div>
            <div class="character-btn water" data-attr="water" data-player="1" onclick="selectCharacter('water',1)">ğŸ’§</div>
            <div class="character-btn thunder" data-attr="thunder" data-player="1" onclick="selectCharacter('thunder',1)">âš¡</div>
            <div class="character-btn wind" data-attr="wind" data-player="1" onclick="selectCharacter('wind',1)">ğŸŒªï¸</div>
            <div class="character-btn earth" data-attr="earth" data-player="1" onclick="selectCharacter('earth',1)">ğŸŒ±</div>
            <div class="character-btn light" data-attr="light" data-player="1" onclick="selectCharacter('light',1)">âœ¨</div>
          </div>
        </div>

        <div id="player2Setup" class="hidden">
          <h3 style="margin-bottom:20px;">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã®è¨­å®š</h3>
          <input type="text" id="player2NameInput" class="name-input" value="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2" placeholder="åå‰ã‚’å…¥åŠ›">
          <div class="character-selection">
            <div class="character-btn fire" data-attr="fire" data-player="2" onclick="selectCharacter('fire',2)">ğŸ”¥</div>
            <div class="character-btn water" data-attr="water" data-player="2" onclick="selectCharacter('water',2)">ğŸ’§</div>
            <div class="character-btn thunder" data-attr="thunder" data-player="2" onclick="selectCharacter('thunder',2)">âš¡</div>
            <div class="character-btn wind" data-attr="wind" data-player="2" onclick="selectCharacter('wind',2)">ğŸŒªï¸</div>
            <div class="character-btn earth" data-attr="earth" data-player="2" onclick="selectCharacter('earth',2)">ğŸŒ±</div>
            <div class="character-btn light" data-attr="light" data-player="2" onclick="selectCharacter('light',2)">âœ¨</div>
          </div>
        </div>

        <button class="btn btn-primary" id="nextBtn" onclick="showGameRules()" style="margin-top:20px;" disabled>ã‚²ãƒ¼ãƒ ã®éŠã³æ–¹ã‚’è¦‹ã‚‹</button>
      </div>

      <div id="gameRules" class="hidden">
        <h2 style="margin-bottom:30px;">ğŸ“– ã‚²ãƒ¼ãƒ ã®éŠã³æ–¹</h2>
        <div class="rules-content">
          <div class="rule-item">
            <div class="rule-icon">âš”ï¸</div>
            <div class="rule-text">
              <h4>åŸºæœ¬ãƒ«ãƒ¼ãƒ«</h4>
              <p>å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼HP300ã§ã‚¹ã‚¿ãƒ¼ãƒˆã€‚ç›¸æ‰‹ã®HPã‚’0ã«ã—ãŸã‚‰å‹åˆ©ï¼</p>
            </div>
          </div>
          <div class="rule-item">
            <div class="rule-icon">ğŸ“</div>
            <div class="rule-text">
              <h4>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°</h4>
              <p>æ‰‹æœ­ã‹ã‚‰1æšé¸ã‚“ã§15ç§’ä»¥å†…ã«ãƒ­ãƒ¼ãƒå­—ã§å…¥åŠ›</p>
            </div>
          </div>
          <div class="rule-item">
            <div class="rule-icon">ğŸ’¥</div>
            <div class="rule-text">
              <h4>ãƒ€ãƒ¡ãƒ¼ã‚¸</h4>
              <p>æˆåŠŸï¼šæ–‡å­—æ•°Ã—æ®‹ã‚Šæ™‚é–“ã§ãƒ€ãƒ¡ãƒ¼ã‚¸<br>å¤±æ•—ï¼šæ–‡å­—æ•°Ã—10ã®è‡ªå‚·ãƒ€ãƒ¡ãƒ¼ã‚¸</p>
            </div>
          </div>
        </div>
        <button class="btn btn-primary" onclick="startGame()" style="margin-top:30px;font-size:18px;padding:15px 40px;">ã‚²ãƒ¼ãƒ é–‹å§‹ï¼</button>
      </div>

      <div style="margin-top:30px;font-size:14px;opacity:.8;">
        <p>ğŸ“± iPadæ¨ªå‘ãã§æœ€é©åŒ–ã•ã‚Œã¦ã„ã¾ã™</p>
        <p>âŒ¨ï¸ ãƒ­ãƒ¼ãƒå­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆãƒ˜ãƒœãƒ³å¼ï¼‰</p>
      </div>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ  -->
  <div class="game-container hidden" id="gameContainer">
    <div class="top-bar">
      <div class="player-info">
        <div class="avatar" id="player1Avatar">ğŸ”¥</div>
        <div class="player-stats">
          <div class="player-name" id="player1Name">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1</div>
          <div class="hp-bar-container">
            <div class="hp-bar" id="player1HpBar" style="width:100%"></div>
            <div class="hp-text" id="player1HpText">300/300</div>
          </div>
        </div>
      </div>

      <div class="center-info">
        <div class="turn-display" id="turnDisplay">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®ã‚¿ãƒ¼ãƒ³</div>
        <div class="phase-display" id="phaseDisplay">ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
        <div class="timer-ring" id="timerRing">15</div>
      </div>

      <div class="player-info" style="flex-direction:row-reverse;">
        <div class="avatar" id="player2Avatar">ğŸ¤–</div>
        <div class="player-stats" style="text-align:right;">
          <div class="player-name" id="player2Name">CPU</div>
          <div class="hp-bar-container">
            <div class="hp-bar" id="player2HpBar" style="width:100%"></div>
            <div class="hp-text" id="player2HpText">300/300</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card-area">
      <div class="cards-container" id="cardsContainer"></div>
    </div>

    <div class="input-area">
      <div class="input-container">
        <div id="typingGuide" class="typing-guide">
          <div id="typingGuideJP" class="jp jp-progress"></div>
          <div id="typingGuideSub" class="sub"></div>
        </div>
        <div id="romajiGuide" class="romaji-guide"></div>
        <input type="text" id="inputField" class="input-field" placeholder="ï¼ˆè‡ªå‹•ã§é€²æ—ãŒå…¥ã‚Šã¾ã™ï¼‰" disabled>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      </div>
      <div class="action-buttons">
        <button class="btn btn-primary" id="submitBtn" onclick="submitAnswer()" disabled>é€ä¿¡</button>
        <button class="btn btn-secondary" id="giveupBtn" onclick="giveUp()" disabled>ã‚®ãƒ–ã‚¢ãƒƒãƒ—</button>
      </div>
    </div>

    <div class="controls">
      <button class="control-btn" onclick="showHelp()" title="ãƒ˜ãƒ«ãƒ—">â“</button>
      <button class="control-btn" onclick="toggleSound()" title="éŸ³é‡" id="soundBtn">ğŸ”Š</button>
      <button class="control-btn" onclick="pauseGame()" title="ä¸€æ™‚åœæ­¢" id="pauseBtn">â¸ï¸</button>
      <button class="control-btn" onclick="backToMenu()" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹">ğŸ </button>
    </div>
  </div>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="modal"><div class="modal-content" id="modalContent"></div></div>

  <script>
    // ===== ã‹ãªâ†’ãƒ­ãƒ¼ãƒå­—ï¼ˆãƒ˜ãƒœãƒ³å¼ãƒ»ä¸€æ„ï¼‰ =====
    const DIGRAPHS = {
      'ãã‚ƒ':'kya','ãã‚…':'kyu','ãã‚‡':'kyo',
      'ã—ã‚ƒ':'sha','ã—ã‚…':'shu','ã—ã‚‡':'sho',
      'ã¡ã‚ƒ':'cha','ã¡ã‚…':'chu','ã¡ã‚‡':'cho',
      'ã˜ã‚ƒ':'ja','ã˜ã‚…':'ju','ã˜ã‚‡':'jo',
      'ã«ã‚ƒ':'nya','ã«ã‚…':'nyu','ã«ã‚‡':'nyo',
      'ã²ã‚ƒ':'hya','ã²ã‚…':'hyu','ã²ã‚‡':'hyo',
      'ã¿ã‚ƒ':'mya','ã¿ã‚…':'myu','ã¿ã‚‡':'myo',
      'ã‚Šã‚ƒ':'rya','ã‚Šã‚…':'ryu','ã‚Šã‚‡':'ryo',
      'ãã‚ƒ':'gya','ãã‚…':'gyu','ãã‚‡':'gyo',
      'ã³ã‚ƒ':'bya','ã³ã‚…':'byu','ã³ã‚‡':'byo',
      'ã´ã‚ƒ':'pya','ã´ã‚…':'pyu','ã´ã‚‡':'pyo',
      'ã‚”ã':'va','ã‚”ãƒ':'vi','ã‚”':'vu','ã‚”ã‡':'ve','ã‚”ã‰':'vo'
    };
    const MONOGRAPHS = {
      'ã‚':'a','ã„':'i','ã†':'u','ãˆ':'e','ãŠ':'o',
      'ã‹':'ka','ã':'ki','ã':'ku','ã‘':'ke','ã“':'ko',
      'ã•':'sa','ã—':'shi','ã™':'su','ã›':'se','ã':'so',
      'ãŸ':'ta','ã¡':'chi','ã¤':'tsu','ã¦':'te','ã¨':'to',
      'ãª':'na','ã«':'ni','ã¬':'nu','ã­':'ne','ã®':'no',
      'ã¯':'ha','ã²':'hi','ãµ':'fu','ã¸':'he','ã»':'ho',
      'ã¾':'ma','ã¿':'mi','ã‚€':'mu','ã‚':'me','ã‚‚':'mo',
      'ã‚„':'ya','ã‚†':'yu','ã‚ˆ':'yo',
      'ã‚‰':'ra','ã‚Š':'ri','ã‚‹':'ru','ã‚Œ':'re','ã‚':'ro',
      'ã‚':'wa','ã‚’':'wo','ã‚“':'nn',
      'ãŒ':'ga','ã':'gi','ã':'gu','ã’':'ge','ã”':'go',
      'ã–':'za','ã˜':'ji','ãš':'zu','ãœ':'ze','ã':'zo',
      'ã ':'da','ã¢':'ji','ã¥':'zu','ã§':'de','ã©':'do',
      'ã°':'ba','ã³':'bi','ã¶':'bu','ã¹':'be','ã¼':'bo',
      'ã±':'pa','ã´':'pi','ã·':'pu','ãº':'pe','ã½':'po',
      'ã':'a','ãƒ':'i','ã…':'u','ã‡':'e','ã‰':'o',
      'ã‚ƒ':'ya','ã‚…':'yu','ã‚‡':'yo','ã£':'*','ãƒ¼':'-'
    };
    function toHiragana(str){
      let s = (str||'').normalize('NFKC')
        .replace(/[\u30A1-\u30FA]/g,c=>String.fromCharCode(c.charCodeAt(0)-0x60));
      return s.replace(/[ã€ã€‚ï¼Œï¼\s]/g,'');
    }
    function kanaToRomajiStrict(text){
      const hira = toHiragana(text);
      let i=0, out='';
      while(i<hira.length){
        const two = hira.slice(i,i+2);
        if(DIGRAPHS[two]){ out+=DIGRAPHS[two]; i+=2; continue; }
        const ch = hira[i];
        if(ch==='ã£'){
          const nextTwo = hira.slice(i+1,i+3);
          const nextOne = hira[i+1];
          const r = DIGRAPHS[nextTwo] || MONOGRAPHS[nextOne] || '';
          out += (r[0]||''); i++; continue;
        }
        if(ch==='ãƒ¼'){ i++; continue; } // é•·éŸ³ã¯ç„¡è¦–
        out += MONOGRAPHS[ch] || ch;
        i++;
      }
      return out;
    }
    const countEffectiveChars = (s)=> toHiragana(s).replace(/ãƒ¼/g,'').length;

    // ===== ã‚¿ã‚¤ãƒ”ãƒ³ã‚°çŠ¶æ…‹ =====
    let typingState = { targetRomaji:'', currentPosition:0, typedKeys:'', kanaLen:0 };

    // ===== ã‚²ãƒ¼ãƒ çŠ¶æ…‹ =====
    let gameState = {
      mode:null,
      players:[
        {name:'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1',hp:300,maxHp:300,avatar:'ğŸ”¥',attribute:'fire'},
        {name:'CPU',hp:300,maxHp:300,avatar:'ğŸ¤–',attribute:'water'}
      ],
      currentPlayer:0,
      selectedCard:null,
      hands:[[],[]],
      deck:[],
      discard:[],
      timer:15,
      timerInterval:null,
      gamePhase:'cardSelect',
      soundEnabled:true,
      isPaused:false,
      stats:{totalChars:0,correctChars:0,totalTime:0,combo:0,maxCombo:0}
    };

    // ===== ã‚«ãƒ¼ãƒ‰ãƒ—ãƒ¼ãƒ«ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰ =====
    const CARD_POOL = [
      // 2æ–‡å­—
      {text:'ã­ã“',difficulty:1,category:'ã©ã†ã¶ã¤'},{text:'ã„ã¬',difficulty:1,category:'ã©ã†ã¶ã¤'},
      {text:'ã™ã—',difficulty:1,category:'ãŸã¹ã‚‚ã®'},{text:'ãã‚‰',difficulty:1,category:'ã—ãœã‚“'},
      {text:'ã‚„ã¾',difficulty:1,category:'ã—ãœã‚“'},{text:'ã‹ã‚',difficulty:1,category:'ã—ãœã‚“'},
      {text:'ã¯ãª',difficulty:1,category:'ã—ãœã‚“'},{text:'ã¿ãš',difficulty:1,category:'ã—ãœã‚“'},
      {text:'ã‚†ã',difficulty:1,category:'ã—ãœã‚“'},{text:'ã¤ã',difficulty:1,category:'ã—ãœã‚“'},
      // 3æ–‡å­—ï¼ˆå°‘ã—å¢—ã‚„ã™ï¼‰
      {text:'ãŸã¾ã”',difficulty:2,category:'ãŸã¹ã‚‚ã®'},{text:'ãã‚‹ã¾',difficulty:2,category:'ã®ã‚Šã‚‚ã®'},
      {text:'ãã¤ã­',difficulty:2,category:'ã©ã†ã¶ã¤'},{text:'ã†ã•ã',difficulty:2,category:'ã©ã†ã¶ã¤'},
      {text:'ã•ã‹ãª',difficulty:2,category:'ã©ã†ã¶ã¤'},{text:'ã‘ã‚€ã—',difficulty:2,category:'ã©ã†ã¶ã¤'},
      {text:'ãã®ã“',difficulty:2,category:'ã—ãœã‚“'},{text:'ã“ã©ã‚‚',difficulty:2,category:'ã²ã¨'},
      {text:'ã¿ã‹ã‚“',difficulty:2,category:'ãŸã¹ã‚‚ã®'},{text:'ãˆãŒãŠ',difficulty:2,category:'ãã‚‚ã¡'}
    ];

    // ===== UIï¼šã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— =====
    function selectMode(mode){
      document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('selected'));
      document.getElementById(mode==='cpu'?'cpuModeBtn':'pvpModeBtn').classList.add('selected');
      gameState.mode = mode;
      document.getElementById('characterSelection').classList.remove('hidden');
      if(mode==='pvp'){
        document.getElementById('player2Setup').classList.remove('hidden');
        gameState.players[1].name = 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2';
        gameState.players[1].avatar = 'ğŸ’§';
      }else{
        document.getElementById('player2Setup').classList.add('hidden');
        gameState.players[1].name = 'CPU';
        gameState.players[1].avatar = 'ğŸ¤–';
      }
      // ãƒ‡ãƒ•ã‚©å³é¸æŠã§å‰ã«é€²ã‚ã‚‹
      selectCharacter('fire',1);
      if(mode==='pvp') selectCharacter('water',2);
      checkSetupComplete();
      setTimeout(()=>{
        const nameInput=document.getElementById('player1NameInput');
        nameInput.focus(); nameInput.select();
      },100);
    }
    function selectCharacter(attribute, player){
      document.querySelectorAll(`[data-player="${player}"]`).forEach(btn=>btn.classList.remove('selected'));
      document.querySelector(`[data-attr="${attribute}"][data-player="${player}"]`).classList.add('selected');
      const avatars={fire:'ğŸ”¥',water:'ğŸ’§',thunder:'âš¡',wind:'ğŸŒªï¸',earth:'ğŸŒ±',light:'âœ¨'};
      gameState.players[player-1].attribute = attribute;
      gameState.players[player-1].avatar = avatars[attribute];
      const nameInput = document.getElementById(`player${player}NameInput`);
      if(nameInput){ gameState.players[player-1].name = nameInput.value || `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${player}`; }
      if(player===1 && gameState.mode==='pvp'){
        setTimeout(()=>{ const p2=document.getElementById('player2NameInput'); p2.focus(); p2.select(); },100);
      }
      checkSetupComplete();
    }
    function checkSetupComplete(){
      const p1 = document.querySelector('[data-player="1"].selected');
      const p2 = (gameState.mode==='cpu') || document.querySelector('[data-player="2"].selected');
      document.getElementById('nextBtn').disabled = !(p1 && p2);
    }
    function showGameRules(){
      gameState.players[0].name = document.getElementById('player1NameInput').value || 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1';
      if(gameState.mode==='pvp'){
        gameState.players[1].name = document.getElementById('player2NameInput').value || 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2';
      }
      document.getElementById('characterSelection').classList.add('hidden');
      document.getElementById('gameRules').classList.remove('hidden');
    }

    // ===== ã‚²ãƒ¼ãƒ é–‹å§‹/åˆæœŸåŒ– =====
    function startGame(){
      document.getElementById('startScreen').classList.add('hidden');
      document.getElementById('gameContainer').classList.remove('hidden');
      initGame();
    }
    function initGame(){
      gameState.deck = [...CARD_POOL].sort(()=>Math.random()-0.5);
      for(let i=0;i<2;i++){
        gameState.hands[i]=[];
        for(let j=0;j<5;j++){ if(gameState.deck.length>0){ gameState.hands[i].push(gameState.deck.pop()); } }
      }
      updateUI(); drawCards(); startTurn();
    }

    // ===== ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰ =====
    function setupTypingGuide(targetText){
      const jpEl = document.getElementById('typingGuideJP');
      const subEl = document.getElementById('typingGuideSub');
      const romajiEl = document.getElementById('romajiGuide');

      jpEl.style.setProperty('--fill','0%');
      jpEl.textContent = targetText;

      const kanaForSub = toHiragana(targetText).replace(/ãƒ¼/g,'');
      subEl.innerHTML='';
      [...kanaForSub].forEach((ch,i)=>{
        const s=document.createElement('span');
        s.className='char pending'; s.dataset.index=i; s.textContent=ch;
        subEl.appendChild(s);
      });

      const romaji = kanaToRomajiStrict(targetText);
      typingState.targetRomaji = romaji;
      typingState.currentPosition = 0;
      typingState.typedKeys = '';
      typingState.kanaLen = kanaForSub.length;

      romajiEl.innerHTML='';
      [...romaji].forEach((c,i)=>{
        const s=document.createElement('span');
        s.className='romaji-char'; s.dataset.index=i; s.textContent=c;
        romajiEl.appendChild(s);
      });
      if(romaji.length>0) romajiEl.children[0].classList.add('current');
    }
    function updateTypingGuideProgress(){
      if(!gameState.selectedCard) return;
      const jpEl = document.getElementById('typingGuideJP');
      const subEl = document.getElementById('typingGuideSub');
      const romajiProgress = typingState.currentPosition / typingState.targetRomaji.length;
      const hiraganaMatched = Math.floor(romajiProgress * typingState.kanaLen);
      const fill = Math.max(0,Math.min(100,romajiProgress*100));
      jpEl.style.setProperty('--fill',`${fill}%`);
      document.getElementById('progressFill').style.width = `${fill}%`;

      const chars = subEl.querySelectorAll('.char');
      chars.forEach((el,i)=>{
        el.classList.remove('matched','current','pending');
        if(i < hiraganaMatched) el.classList.add('matched');
        else if(i===hiraganaMatched && typingState.currentPosition < typingState.targetRomaji.length) el.classList.add('current');
        else el.classList.add('pending');
      });

      // å…¥åŠ›æ¬„ã¸ãƒŸãƒ©ãƒ¼ï¼ˆè¦‹ãŸç›®ç”¨ï¼‰
      const text = gameState.selectedCard.text;
      const kana = toHiragana(text).replace(/ãƒ¼/g,'');
      document.getElementById('inputField').value = kana.slice(0,hiraganaMatched);
    }
    function updateRomajiDisplay(){
      const romajiEl = document.getElementById('romajiGuide');
      const chars = romajiEl.querySelectorAll('.romaji-char');
      chars.forEach((char,idx)=>{
        char.classList.remove('typed','current');
        if(idx < typingState.currentPosition) char.classList.add('typed');
        else if(idx === typingState.currentPosition) char.classList.add('current');
      });
    }

    // ===== UIæ›´æ–° =====
    function updateUI(){
     
      // åå‰/ã‚¢ãƒã‚¿ãƒ¼/HP
      for(let i=0;i<2;i++){
        const p = gameState.players[i];
        document.getElementById(`player${i+1}Name`).textContent = p.name;
        document.getElementById(`player${i+1}Avatar`).textContent = p.avatar;
        const hpPercent = (p.hp/p.maxHp)*100;
        document.getElementById(`player${i+1}HpBar`).style.width = `${hpPercent}%`;
        document.getElementById(`player${i+1}HpText`).textContent = `${Math.max(0,Math.round(p.hp))}/${p.maxHp}`;
      }
      document.getElementById('turnDisplay').textContent = `${gameState.players[gameState.currentPlayer].name}ã®ã‚¿ãƒ¼ãƒ³`;
      updatePhaseDisplay();
    }
    function updatePhaseDisplay(){
      const el = document.getElementById('phaseDisplay');
      switch(gameState.gamePhase){
        case 'cardSelect': el.textContent='ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„'; break;
        case 'typing': el.textContent='ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ä¸­...'; break;
        case 'result': el.textContent='çµæœè¡¨ç¤º'; break;
        default: el.textContent='';
      }
    }

    // ===== ã‚«ãƒ¼ãƒ‰æç”» =====
    function drawCards(){
      const container = document.getElementById('cardsContainer');
      container.innerHTML = '';
      const currentHand = gameState.hands[gameState.currentPlayer];
      if(gameState.deck.length>0 && currentHand.length<6){
        currentHand.push(gameState.deck.pop());
      }
      currentHand.forEach((card,index)=>{
        const el = document.createElement('div');
        el.className='card';
        el.dataset.attr = gameState.players[gameState.currentPlayer].attribute || 'light';
        const stars='â˜…'.repeat(card.difficulty);
        el.innerHTML=`
          <div class="card-top">
            <span class="pill">${card.category}</span>
            <span class="stars">${stars}</span>
          </div>
          <div class="card-text">${card.text}</div>
        `;
        el.onclick=()=>selectCard(index);
        el.addEventListener('mousemove',(e)=>{
          const r=el.getBoundingClientRect();
          const dx=(e.clientX-(r.left+r.width/2))/r.width;
          const dy=(e.clientY-(r.top+r.height/2))/r.height;
          el.style.transform=`translateY(-4px) rotateX(${dy*-8}deg) rotateY(${dx*8}deg)`;
        });
        el.addEventListener('mouseleave',()=>{el.style.transform='';});
        container.appendChild(el);
      });
    }

    function selectCard(index){
      if(gameState.gamePhase!=='cardSelect') return;
      document.querySelectorAll('.card').forEach(c=>c.classList.remove('selected'));
      const cardEls = document.querySelectorAll('.card');
      cardEls[index].classList.add('selected');
      gameState.selectedCard = gameState.hands[gameState.currentPlayer][index];
      setupTypingGuide(gameState.selectedCard.text);
      startTypingPhase();
    }

    // ===== ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ =====
    function showCountdown(){
      return new Promise(resolve=>{
        const overlay=document.createElement('div');overlay.className='countdown-overlay';
        const numberEl=document.createElement('div');numberEl.className='countdown-number';
        overlay.appendChild(numberEl);document.body.appendChild(overlay);
        let count=2;
        function tick(){
          numberEl.textContent=count;
          if(count>0){count--;setTimeout(tick,1000);}
          else{ numberEl.textContent='START!'; setTimeout(()=>{overlay.remove();resolve();},500); }
        }
        tick();
      });
    }

    // ===== ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒ•ã‚§ãƒ¼ã‚º =====
    async function startTypingPhase(){
      gameState.gamePhase='typing'; gameState.timer=15; updatePhaseDisplay();
      await showCountdown();
      document.getElementById('submitBtn').disabled=false;
      document.getElementById('giveupBtn').disabled=false;
      document.getElementById('inputField').disabled=false;
      document.getElementById('inputField').focus();
      document.addEventListener('keydown',handleKeyPress);
      startTimer();
    }
    function startTimer(){
      clearInterval(gameState.timerInterval);
      document.getElementById('timerRing').textContent='15';
      document.getElementById('timerRing').style.background =
        'conic-gradient(#feca57 360deg, rgba(255,255,255,.2) 360deg)';
      gameState.timerInterval = setInterval(()=>{
        if(gameState.isPaused) return;
        gameState.timer--;
        const ring=document.getElementById('timerRing');
        ring.textContent = gameState.timer;
        const progress = (gameState.timer/15)*360;
        ring.style.background = `conic-gradient(#feca57 ${progress}deg, rgba(255,255,255,.2) ${progress}deg)`;
        if(gameState.timer<=0){ timeUp(); }
      },1000);
    }
    function handleKeyPress(event){
      if(gameState.gamePhase!=='typing' || gameState.isPaused) return;
      const key = event.key.toLowerCase();
      if(key==='enter'){ event.preventDefault();
        if(typingState.currentPosition>=typingState.targetRomaji.length) submitAnswer();
        return;
      }
      if(key==='escape'){ event.preventDefault(); giveUp(); return; }
      if(!/^[a-z]$/.test(key)) return;
      event.preventDefault();

      if(typingState.currentPosition < typingState.targetRomaji.length){
        const expected = typingState.targetRomaji[typingState.currentPosition];
        if(key===expected){
          typingState.typedKeys += key;
          typingState.currentPosition++;
          updateRomajiDisplay(); updateTypingGuideProgress();
          if(typingState.currentPosition >= typingState.targetRomaji.length){
            setTimeout(()=>submitAnswer(),100);
          }
        }else{
          playSound('fail');
        }
      }
    }

    // ===== åˆ¤å®š =====
    function submitAnswer(){
      const input = document.getElementById('inputField').value;
      const target = gameState.selectedCard.text;
      const targetLen = countEffectiveChars(target);
      const timeUsed = Math.max(0,15 - gameState.timer);

      gameState.stats.totalChars += targetLen;
      gameState.stats.totalTime += timeUsed;

      const success = (typingState.currentPosition >= typingState.targetRomaji.length)
                   || (toHiragana(input) === toHiragana(target).replace(/ãƒ¼/g,''));

      if(success){
        const damage = Math.round(targetLen * gameState.timer * 10)/10;
        dealDamage(1 - gameState.currentPlayer, damage);
        gameState.stats.correctChars += targetLen;
        gameState.stats.combo++; gameState.stats.maxCombo = Math.max(gameState.stats.maxCombo, gameState.stats.combo);
        playSound('success');
      }else{
        const selfDamage = targetLen * 10;
        dealDamage(gameState.currentPlayer, selfDamage);
        gameState.stats.combo = 0;
        playSound('fail');
      }
      document.getElementById('inputField').value='';
      endTurn();
    }
    function giveUp(){
      const targetLen = countEffectiveChars(gameState.selectedCard.text);
      const timeUsed = Math.max(0,15 - gameState.timer);
      gameState.stats.totalChars += targetLen;
      gameState.stats.totalTime += timeUsed;
      const selfDamage = targetLen * 10;
      dealDamage(gameState.currentPlayer, selfDamage);
      gameState.stats.combo=0; playSound('fail');
      endTurn();
    }
    function timeUp(){
      const targetLen = countEffectiveChars(gameState.selectedCard.text);
      gameState.stats.totalChars += targetLen;
      gameState.stats.totalTime += 15;
      const selfDamage = targetLen * 10;
      dealDamage(gameState.currentPlayer, selfDamage);
      gameState.stats.combo=0; playSound('fail');
      endTurn();
    }

    // ===== ãƒ€ãƒ¡ãƒ¼ã‚¸/å‹æ•— =====
    function dealDamage(playerIndex, damage){
      gameState.players[playerIndex].hp = Math.max(0, gameState.players[playerIndex].hp - damage);
      showDamageEffect(playerIndex, damage);
      updateUI();
      if(gameState.players[playerIndex].hp <= 0){ endGame(1 - playerIndex); }
    }
    function showDamageEffect(playerIndex, damage){
      const avatar = document.getElementById(`player${playerIndex+1}Avatar`);
      const dmg = document.createElement('div');
      dmg.className='damage-number';
      dmg.textContent = `-${damage}`;
      dmg.style.left='50%';dmg.style.top='50%';
      avatar.style.position='relative';
      avatar.appendChild(dmg);
      avatar.classList.add('shake');
      setTimeout(()=>{ avatar.classList.remove('shake'); if(dmg.parentNode) dmg.remove(); },1000);
    }

    function endTurn(){
      clearInterval(gameState.timerInterval);
      document.removeEventListener('keydown',handleKeyPress);

      // ä½¿ã£ãŸã‚«ãƒ¼ãƒ‰ã‚’æ¨ã¦æœ­ã«
      const idx = gameState.hands[gameState.currentPlayer].indexOf(gameState.selectedCard);
      if(idx>=0){ gameState.hands[gameState.currentPlayer].splice(idx,1); gameState.discard.push(gameState.selectedCard); }

      // å…¥åŠ›UIç„¡åŠ¹åŒ–
      document.getElementById('submitBtn').disabled=true;
      document.getElementById('giveupBtn').disabled=true;
      document.getElementById('inputField').disabled=true;
      document.getElementById('progressFill').style.width='0%';
      document.getElementById('typingGuideJP').style.setProperty('--fill','0%');
      document.getElementById('typingGuideSub').innerHTML='';
      document.getElementById('romajiGuide').innerHTML='';
      typingState = {targetRomaji:'',currentPosition:0,typedKeys:'',kanaLen:0};

      // æ¬¡ã‚¿ãƒ¼ãƒ³
      gameState.gamePhase='result'; updatePhaseDisplay();
      gameState.currentPlayer = 1 - gameState.currentPlayer;
      gameState.gamePhase='cardSelect'; gameState.selectedCard=null;

      setTimeout(()=>{
        if(gameState.mode==='cpu' && gameState.currentPlayer===1){ cpuTurn(); }
        else { startTurn(); }
      }, 2000);
    }
    function startTurn(){
      updateUI(); drawCards();
      document.getElementById('timerRing').textContent='15';
      document.getElementById('timerRing').style.background =
        'conic-gradient(#feca57 360deg, rgba(255,255,255,.2) 360deg)';
    }

    // ===== CPU =====
    function cpuTurn(){
      updateUI(); drawCards();
      setTimeout(()=>{
        const hand = gameState.hands[1];
        let bestCard = hand[0], bestScore = -1;
        hand.forEach(card=>{
          const len = countEffectiveChars(card.text);
          const expectedTime = Math.random()*10 + 5; // 5-15ç§’
          const expectedDamage = len * expectedTime;
          const failRisk = card.difficulty * 20;
          const score = expectedDamage - failRisk;
          if(score>bestScore){ bestScore=score; bestCard=card; }
        });
        gameState.selectedCard = bestCard;

        setTimeout(()=>{
          const success = Math.random() > (bestCard.difficulty * 0.2);
          const len = countEffectiveChars(bestCard.text);
          if(success){
            const cpuTime = Math.random()*8 + 2; // 2-10ç§’
            const damage = Math.round(len * cpuTime * 10)/10;
            dealDamage(0, damage);
            gameState.stats.correctChars += len;
            gameState.stats.totalChars += len;
            gameState.stats.totalTime += (15 - cpuTime);
            playSound('success');
          }else{
            const selfDamage = len * 10;
            dealDamage(1, selfDamage);
            gameState.stats.totalChars += len;
            gameState.stats.totalTime += 15;
            playSound('fail');
          }
          endTurn();
        },2000);
      },1000);
    }

    // ===== çµ‚äº†/ãã®ä»– =====
    function endGame(winner){
      gameState.gamePhase='result';
      const name = gameState.players[winner].name;
      const acc = gameState.stats.totalChars>0 ? Math.round((gameState.stats.correctChars/gameState.stats.totalChars)*100) : 0;
      const avg = gameState.stats.totalChars>0 ? Math.round((gameState.stats.totalTime/gameState.stats.totalChars)*10)/10 : 0;
      showModal(`ğŸ‰ ${name}ã®å‹åˆ©ï¼`,`
        <p>ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</p>
        <p><strong>æˆ¦ç¸¾</strong></p>
        <p>æœ€å¤§ã‚³ãƒ³ãƒœ: ${gameState.stats.maxCombo}</p>
        <p>æ­£ç¢ºæ€§: ${acc}%</p>
        <p>å¹³å‡å…¥åŠ›æ™‚é–“: ${avg}ç§’/æ–‡å­—</p>
        <button class="btn btn-primary" onclick="backToMenu()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
        <button class="btn btn-secondary" onclick="restartGame()">ã‚‚ã†ä¸€åº¦</button>
      `);
    }
    function playSound(type){
      if(!gameState.soundEnabled) return;
      const ctx=new (window.AudioContext||window.webkitAudioContext)();
      const osc=ctx.createOscillator(); const gain=ctx.createGain();
      osc.connect(gain); gain.connect(ctx.destination);
      if(type==='success'){
        osc.frequency.setValueAtTime(523.25,ctx.currentTime);
        osc.frequency.setValueAtTime(659.25,ctx.currentTime+.1);
      }else{ osc.frequency.setValueAtTime(220,ctx.currentTime); }
      gain.gain.setValueAtTime(0.08,ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+.3);
      osc.start(ctx.currentTime); osc.stop(ctx.currentTime+.3);
    }
    function showModal(title,content){
      document.getElementById('modalContent').innerHTML=`<h2>${title}</h2>${content}`;
      document.getElementById('modal').style.display='flex';
    }
    function hideModal(){ document.getElementById('modal').style.display='none'; }
    function showHelp(){
      showModal('ğŸ“– ã‚²ãƒ¼ãƒ ã®éŠã³æ–¹',`
        <p><strong>åŸºæœ¬ãƒ«ãƒ¼ãƒ«</strong></p>
        <p>â€¢ HP300ï¼ç›¸æ‰‹ã®HPã‚’0ã«ã—ãŸã‚‰å‹ã¡</p>
        <p>â€¢ æ‰‹æœ­ã‹ã‚‰1æšé¸ã³ã€15ç§’ä»¥å†…ã«ãƒ­ãƒ¼ãƒå­—å…¥åŠ›ï¼ˆãƒ˜ãƒœãƒ³å¼ï¼‰</p>
        <p>â€¢ æˆåŠŸï¼šæ–‡å­—æ•°Ã—æ®‹ã‚Šæ™‚é–“ã®ãƒ€ãƒ¡ãƒ¼ã‚¸</p>
        <p>â€¢ å¤±æ•—ï¼šæ–‡å­—æ•°Ã—10ã®è‡ªå‚·ãƒ€ãƒ¡ãƒ¼ã‚¸</p>
        <button class="btn btn-primary" onclick="hideModal()">é–‰ã˜ã‚‹</button>
      `);
    }
    function toggleSound(){ gameState.soundEnabled=!gameState.soundEnabled; document.getElementById('soundBtn').textContent = gameState.soundEnabled?'ğŸ”Š':'ğŸ”‡'; }
    function pauseGame(){
      if(gameState.gamePhase!=='typing') return;
      if(!gameState.isPaused){
        gameState.isPaused=true; document.getElementById('pauseBtn').textContent='â–¶ï¸';
        document.getElementById('inputField').disabled=true;
        showModal('â¸ï¸ ä¸€æ™‚åœæ­¢',`<p>ã‚²ãƒ¼ãƒ ã‚’ä¸€æ™‚åœæ­¢ã—ã¾ã—ãŸ</p><button class="btn btn-primary" onclick="resumeGame()">å†é–‹</button>`);
      }else{ resumeGame(); }
    }
    function resumeGame(){ gameState.isPaused=false; document.getElementById('pauseBtn').textContent='â¸ï¸'; document.getElementById('inputField').disabled=false; hideModal(); }
    function backToMenu(){
      gameState = {
        mode:null,
        players:[{name:'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1',hp:300,maxHp:300,avatar:'ğŸ”¥',attribute:'fire'},{name:'CPU',hp:300,maxHp:300,avatar:'ğŸ¤–',attribute:'water'}],
        currentPlayer:0,selectedCard:null,hands:[[],[]],deck:[],discard:[],
        timer:15,timerInterval:null,gamePhase:'cardSelect',soundEnabled:true,isPaused:false,
        stats:{totalChars:0,correctChars:0,totalTime:0,combo:0,maxCombo:0}
      };
      clearInterval(gameState.timerInterval);
      hideModal();
      document.getElementById('gameContainer').classList.add('hidden');
      document.getElementById('startScreen').classList.remove('hidden');
      document.getElementById('characterSelection').classList.add('hidden');
      document.getElementById('gameRules').classList.add('hidden');
      document.getElementById('player2Setup').classList.add('hidden');
      document.querySelectorAll('.mode-btn,.character-btn').forEach(btn=>btn.classList.remove('selected'));
      document.getElementById('player1NameInput').value='ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1';
      const p2=document.getElementById('player2NameInput'); if(p2) p2.value='ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2';
      document.getElementById('nextBtn').disabled=true;
    }
    function restartGame(){
      hideModal();
      gameState.players.forEach(p=>p.hp=p.maxHp);
      gameState.stats={totalChars:0,correctChars:0,totalTime:0,combo:0,maxCombo:0};
      gameState.currentPlayer=0; gameState.gamePhase='cardSelect';
      initGame();
    }

    // ===== init =====
    document.addEventListener('DOMContentLoaded',()=>{
      document.getElementById('modal').addEventListener('click',(e)=>{ if(e.target===e.currentTarget) hideModal(); });
    });
    console.log('ğŸ® ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒãƒˆãƒ«V1 èµ·å‹•');
  </script>
</body>
</html>
