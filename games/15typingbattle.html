<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒãƒˆãƒ« - å­¦ç¿’ã‚²ãƒ¼ãƒ </title>
  <link href="https://fonts.googleapis.com/css2?family=BIZ+UDGothic:wght@400;700&display=swap" rel="stylesheet">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'BIZ UDGothic',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;overflow-x:hidden;user-select:none}
    .game-container{width:100vw;height:100vh;display:flex;flex-direction:column;position:relative}
    .top-bar{height:80px;background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.2);display:flex;align-items:center;justify-content:space-between;padding:0 20px}
    .player-info{display:flex;align-items:center;gap:15px;min-width:300px}
    .avatar{width:50px;height:50px;border-radius:50%;background:linear-gradient(45deg,#ff6b6b,#feca57);display:flex;align-items:center;justify-content:center;font-size:24px;border:3px solid rgba(255,255,255,.3)}
    .player-stats{flex:1}
    .player-name{font-weight:700;color:#fff;font-size:16px;margin-bottom:5px}
    .hp-bar-container{width:200px;height:20px;background:rgba(0,0,0,.3);border-radius:10px;overflow:hidden;position:relative}
    .hp-bar{height:100%;background:linear-gradient(90deg,#ff6b6b,#feca57);transition:width .5s ease;border-radius:10px}
    .hp-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:12px;font-weight:700;text-shadow:1px 1px 2px rgba(0,0,0,.5)}
    .center-info{text-align:center;color:#fff}
    .turn-display{font-size:18px;font-weight:700;margin-bottom:5px}
    .phase-display{font-size:14px;opacity:.8;margin-bottom:10px}
    .timer-ring{width:60px;height:60px;border-radius:50%;background:conic-gradient(#feca57 0deg,rgba(255,255,255,.2) 0deg);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:#fff;margin:0 auto}
    .card-area{flex:1;padding:20px;display:flex;flex-direction:column;gap:20px}
    .cards-container{display:grid;grid-template-columns:repeat(6,1fr);gap:15px;max-width:1200px;margin:0 auto}
    .card{background:rgba(255,255,255,.15);backdrop-filter:blur(10px);border:2px solid rgba(255,255,255,.2);border-radius:15px;padding:20px;text-align:center;cursor:pointer;transition:all .3s ease;min-height:120px;display:flex;flex-direction:column;justify-content:center;position:relative}
    .card:hover{transform:translateY(-5px);box-shadow:0 10px 25px rgba(0,0,0,.2)}
    .card.selected{border-color:#feca57;box-shadow:0 0 20px rgba(254,202,87,.5);transform:scale(1.05)}
    .card-text{font-size:18px;font-weight:700;color:#fff;margin-bottom:10px}
    .card-difficulty{font-size:12px;color:#feca57}

    /* å…¥åŠ›ã‚¨ãƒªã‚¢ï¼ˆã‚¬ã‚¤ãƒ‰ã®ã¿è¡¨ç¤ºã€‚å¯è¦–å…¥åŠ›ã¨é€ä¿¡UIã¯éè¡¨ç¤ºï¼‰ */
    .input-area{height:150px;background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border-top:1px solid rgba(255,255,255,.2);padding:20px;display:flex;align-items:center;gap:20px}
    .input-container,.action-buttons{display:none !important}
    .visually-hidden-input{position:fixed;left:-9999px;top:0;width:1px;height:1px;opacity:0;pointer-events:none}

    .typing-guide{text-align:center;color:#fff;margin-bottom:6px;user-select:none}
    .typing-guide .jp{font-size:32px;line-height:1.1;letter-spacing:.06em;font-weight:700}
    @media (min-width:1024px){.typing-guide .jp{font-size:40px}}
    .typing-guide .sub{font-size:14px;opacity:.9;margin-top:6px;letter-spacing:.08em}

    .jp-progress{display:inline-block;background:linear-gradient(90deg,#feca57 var(--fill,0%),rgba(255,255,255,.95) var(--fill,0%));-webkit-background-clip:text;background-clip:text;color:transparent;transition:background .12s linear}
    .sub .char{padding:0 .06em;transition:color .08s,transform .04s}
    .sub .char.matched{color:#feca57}
    .sub .char.current{border-bottom:2px solid #feca57}
    .sub .char.pending{color:rgba(255,255,255,.85);opacity:.75}

    .romaji-guide{text-align:center;color:#fff;margin-bottom:6px;font-size:24px;font-weight:700;letter-spacing:.1em;min-height:40px}
    .romaji-char{display:inline-block;padding:0 2px;transition:color .1s ease}
    .romaji-char.typed{color:#feca57}
    .romaji-char.current{background:rgba(254,202,87,.3);border-radius:4px}
    .romaji-note{font-size:12px;color:#fff;opacity:.8;text-align:center}

    .controls{position:fixed;bottom:20px;left:20px;display:flex;gap:10px}
    .control-btn{width:50px;height:50px;border-radius:50%;background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.3);color:#fff;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .3s ease}
    .control-btn:hover{background:rgba(255,255,255,.3)}
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal-content{background:rgba(255,255,255,.95);backdrop-filter:blur(20px);border-radius:20px;padding:40px;text-align:center;max-width:500px;width:90%}
    .modal h2{color:#333;margin-bottom:20px;font-size:24px}
    .modal p{color:#666;margin-bottom:15px;line-height:1.6}

    .damage-number{position:absolute;font-size:24px;font-weight:700;color:#ff6b6b;pointer-events:none;animation:damageFloat 1s ease-out forwards}
    @keyframes damageFloat{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-50px)}}
    .fire{--attr-color:#ff6b6b}.water{--attr-color:#4ecdc4}.thunder{--attr-color:#ffe66d}.wind{--attr-color:#95e1d3}.earth{--attr-color:#a8e6cf}.light{--attr-color:#ffd93d}
    @media (max-width:1024px){.cards-container{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:768px){.cards-container{grid-template-columns:repeat(2,1fr)}.top-bar{height:60px;padding:0 10px}.player-info{min-width:200px}.hp-bar-container{width:150px}}
    .hidden{display:none !important}
    .shake{animation:shake .5s ease-in-out}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
    .countdown-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1500}
    .countdown-number{font-size:120px;font-weight:900;color:#feca57;text-shadow:0 0 30px rgba(254,202,87,.5);animation:countdownPulse 1s ease-in-out}
    @keyframes countdownPulse{0%{transform:scale(.5);opacity:0}50%{transform:scale(1.2);opacity:1}100%{transform:scale(1);opacity:1}}
    .start-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;align-items:center;justify-content:center;z-index:2000}
    .start-content{text-align:center;color:#fff}
    .start-content h1{font-size:48px;margin-bottom:30px;text-shadow:2px 2px 4px rgba(0,0,0,.3)}
    .mode-selection{display:flex;gap:30px;margin-bottom:30px;justify-content:center}
    .mode-btn{padding:30px 40px;background:rgba(255,255,255,.2);border:3px solid rgba(255,255,255,.3);border-radius:20px;color:#fff;cursor:pointer;transition:all .3s ease;min-width:200px;text-align:center}
    .mode-btn:hover{background:rgba(255,255,255,.3);transform:translateY(-5px);box-shadow:0 10px 30px rgba(0,0,0,.3)}
    .mode-btn.selected{background:rgba(254,202,87,.3);border-color:#feca57;box-shadow:0 0 30px rgba(254,202,87,.5)}
    .mode-icon{font-size:48px;margin-bottom:10px}
    .mode-title{font-size:24px;font-weight:700;margin-bottom:8px}
    .mode-desc{font-size:14px;opacity:.8}
    .character-selection{display:grid;grid-template-columns:repeat(6,1fr);gap:15px;margin:20px 0;max-width:600px}
    .character-btn{width:80px;height:80px;border-radius:50%;border:3px solid rgba(255,255,255,.3);cursor:pointer;transition:all .3s ease;display:flex;align-items:center;justify-content:center;font-size:32px}
    .character-btn.selected{border-color:#feca57;box-shadow:0 0 20px rgba(254,202,87,.5)}
    .name-input{width:300px;height:50px;border:2px solid rgba(255,255,255,.3);border-radius:25px;padding:0 20px;font-size:18px;font-family:'BIZ UDGothic',sans-serif;background:rgba(255,255,255,.9);outline:none;margin-bottom:20px;text-align:center}
    .name-input:focus{border-color:#feca57;box-shadow:0 0 10px rgba(254,202,87,.3)}
    .rules-content{text-align:left;max-width:600px;margin:0 auto}
    .rule-item{display:flex;align-items:flex-start;gap:20px;margin-bottom:25px;padding:20px;background:rgba(255,255,255,.1);border-radius:15px;backdrop-filter:blur(10px)}
    .rule-icon{font-size:32px;min-width:50px}
    .rule-text h4{margin:0 0 8px 0;font-size:18px;color:#feca57}
    .rule-text p{margin:0;line-height:1.5}
  </style>
</head>
<body>
  <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
  <div class="start-screen" id="startScreen">
    <div class="start-content">
      <h1>âš”ï¸ ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒãƒˆãƒ«</h1>
      <p style="font-size:18px;margin-bottom:30px;">å­¦ç¿’ã—ãªãŒã‚‰æ¥½ã—ãã‚¿ã‚¤ãƒ”ãƒ³ã‚°ï¼</p>

      <div class="mode-selection">
        <button class="mode-btn" id="cpuModeBtn" onclick="selectMode('cpu')">
          <div class="mode-icon">ğŸ¤–</div>
          <div class="mode-title">CPUæˆ¦</div>
          <div class="mode-desc">ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã¨å¯¾æˆ¦</div>
        </button>
        <button class="mode-btn" id="pvpModeBtn" onclick="selectMode('pvp')">
          <div class="mode-icon">ğŸ‘¥</div>
          <div class="mode-title">2äººå¯¾æˆ¦</div>
          <div class="mode-desc">å‹é”ã¨ä¸€ç·’ã«å¯¾æˆ¦</div>
        </button>
      </div>

      <div id="characterSelection" class="hidden">
        <div id="player1Setup">
          <h3 style="margin-bottom:20px;">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®è¨­å®š</h3>
          <input type="text" id="player1NameInput" class="name-input" value="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1" placeholder="åå‰ã‚’å…¥åŠ›">
          <div class="character-selection">
            <div class="character-btn fire" data-attr="fire" data-player="1" onclick="selectCharacter('fire',1)">ğŸ”¥</div>
            <div class="character-btn water" data-attr="water" data-player="1" onclick="selectCharacter('water',1)">ğŸ’§</div>
            <div class="character-btn thunder" data-attr="thunder" data-player="1" onclick="selectCharacter('thunder',1)">âš¡</div>
            <div class="character-btn wind" data-attr="wind" data-player="1" onclick="selectCharacter('wind',1)">ğŸŒªï¸</div>
            <div class="character-btn earth" data-attr="earth" data-player="1" onclick="selectCharacter('earth',1)">ğŸŒ±</div>
            <div class="character-btn light" data-attr="light" data-player="1" onclick="selectCharacter('light',1)">âœ¨</div>
          </div>
        </div>

        <div id="player2Setup" class="hidden">
          <h3 style="margin-bottom:20px;">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã®è¨­å®š</h3>
          <input type="text" id="player2NameInput" class="name-input" value="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2" placeholder="åå‰ã‚’å…¥åŠ›">
          <div class="character-selection">
            <div class="character-btn fire" data-attr="fire" data-player="2" onclick="selectCharacter('fire',2)">ğŸ”¥</div>
            <div class="character-btn water" data-attr="water" data-player="2" onclick="selectCharacter('water',2)">ğŸ’§</div>
            <div class="character-btn thunder" data-attr="thunder" data-player="2" onclick="selectCharacter('thunder',2)">âš¡</div>
            <div class="character-btn wind" data-attr="wind" data-player="2" onclick="selectCharacter('wind',2)">ğŸŒªï¸</div>
            <div class="character-btn earth" data-attr="earth" data-player="2" onclick="selectCharacter('earth',2)">ğŸŒ±</div>
            <div class="character-btn light" data-attr="light" data-player="2" onclick="selectCharacter('light',2)">âœ¨</div>
          </div>
        </div>

        <button class="btn btn-primary" id="nextBtn" onclick="showGameRules()" style="margin-top:20px;" disabled>ã‚²ãƒ¼ãƒ ã®éŠã³æ–¹ã‚’è¦‹ã‚‹</button>
      </div>

      <div id="gameRules" class="hidden">
        <h2 style="margin-bottom:30px;">ğŸ“– ã‚²ãƒ¼ãƒ ã®éŠã³æ–¹</h2>
        <div class="rules-content">
          <div class="rule-item"><div class="rule-icon">âš”ï¸</div><div class="rule-text"><h4>åŸºæœ¬ãƒ«ãƒ¼ãƒ«</h4><p>å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼HP300ã§ã‚¹ã‚¿ãƒ¼ãƒˆã€‚ç›¸æ‰‹ã®HPã‚’0ã«ã—ãŸã‚‰å‹åˆ©ï¼</p></div></div>
          <div class="rule-item"><div class="rule-icon">ğŸ“</div><div class="rule-text"><h4>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°</h4><p>æ‰‹æœ­ã‹ã‚‰1æšé¸ã‚“ã§15ç§’ä»¥å†…ã«å…¥åŠ›ã€‚ã‚¿ã‚¤ãƒ—å®Œäº†ã§è‡ªå‹•åˆ¤å®šã€‚</p></div></div>
          <div class="rule-item"><div class="rule-icon">ğŸ’¥</div><div class="rule-text"><h4>ãƒ€ãƒ¡ãƒ¼ã‚¸</h4><p>æˆåŠŸï¼šæ–‡å­—æ•°Ã—æ®‹ã‚Šæ™‚é–“ / å¤±æ•—ï¼šæ–‡å­—æ•°Ã—10ã®è‡ªå‚·</p></div></div>
          <p style="text-align:center;opacity:.85">â€» Escã§ã‚®ãƒ–ã‚¢ãƒƒãƒ—ã§ãã¾ã™</p>
          <p class="romaji-note">åˆ¥è¡¨è¨˜OKï¼štsu/tu, shi/si, chi/ti, ji/zi, di/ji, du/zu, fu/hu, wo/o, n/nn</p>
        </div>
        <button class="btn btn-primary" onclick="startGame()" style="margin-top:30px;font-size:18px;padding:15px 40px;">ã‚²ãƒ¼ãƒ é–‹å§‹ï¼</button>
      </div>

      <div style="margin-top:30px;font-size:14px;opacity:.8;">
        <p>ğŸ“± iPadæ¨ªå‘ãã§æœ€é©åŒ–</p>
        <p>âŒ¨ï¸ ãƒ­ãƒ¼ãƒå­—ã§ã‚¿ã‚¤ãƒ—ï¼ˆå¯è¦–å…¥åŠ›æ¬„ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰</p>
      </div>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ç”»é¢ -->
  <div class="game-container hidden" id="gameContainer">
    <div class="top-bar">
      <div class="player-info">
        <div class="avatar" id="player1Avatar">ğŸ”¥</div>
        <div class="player-stats">
          <div class="player-name" id="player1Name">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1</div>
          <div class="hp-bar-container"><div class="hp-bar" id="player1HpBar" style="width:100%;"></div><div class="hp-text" id="player1HpText">300/300</div></div>
        </div>
      </div>
      <div class="center-info">
        <div class="turn-display" id="turnDisplay">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®ã‚¿ãƒ¼ãƒ³</div>
        <div class="phase-display" id="phaseDisplay">ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
        <div class="timer-ring" id="timerRing">15</div>
      </div>
      <div class="player-info" style="flex-direction:row-reverse;">
        <div class="avatar" id="player2Avatar">ğŸ¤–</div>
        <div class="player-stats" style="text-align:right;">
          <div class="player-name" id="player2Name">CPU</div>
          <div class="hp-bar-container"><div class="hp-bar" id="player2HpBar" style="width:100%;"></div><div class="hp-text" id="player2HpText">300/300</div></div>
        </div>
      </div>
    </div>

    <div class="card-area">
      <div class="cards-container" id="cardsContainer"></div>
    </div>

    <div class="input-area">
      <div style="flex:1">
        <div id="typingGuide" class="typing-guide">
          <div id="typingGuideJP" class="jp jp-progress"></div>
          <div id="typingGuideSub" class="sub"></div>
        </div>
        <div id="romajiGuide" class="romaji-guide"></div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      </div>
      <input id="softKeyboard" class="visually-hidden-input" type="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" inputmode="latin">
    </div>

    <div class="controls">
      <button class="control-btn" onclick="showHelp()" title="ãƒ˜ãƒ«ãƒ—">â“</button>
      <button class="control-btn" onclick="toggleSound()" title="éŸ³é‡" id="soundBtn">ğŸ”Š</button>
      <button class="control-btn" onclick="pauseGame()" title="ä¸€æ™‚åœæ­¢" id="pauseBtn">â¸ï¸</button>
      <button class="control-btn" onclick="backToMenu()" title="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹">ğŸ </button>
    </div>
  </div>

  <div class="modal" id="modal"><div class="modal-content" id="modalContent"></div></div>

  <script>
    // ====== æ­£è¦åŒ– ======
    const normalizeJP=(text)=>{
      if(!text) return '';
      let n=text.normalize('NFKC');
      n=n.replace(/[\u30A1-\u30F6]/g,m=>String.fromCharCode(m.charCodeAt(0)-0x60)); // ã‚«ã‚¿ã‚«ãƒŠâ†’ã²ã‚‰ãŒãª
      n=n.replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g,s=>String.fromCharCode(s.charCodeAt(0)-0xFEE0)); // å…¨è§’è‹±æ•°â†’åŠè§’
      n=n.replace(/[ã€ã€‚ï¼Œï¼\s]/g,''); // å¥èª­ç‚¹ãƒ»ç©ºç™½é™¤å»
      n=n.replace(/[ã‚ƒãƒ£]/g,'ã‚„').replace(/[ã‚…ãƒ¥]/g,'ã‚†').replace(/[ã‚‡ãƒ§]/g,'ã‚ˆ').replace(/[ã£ãƒƒ]/g,'ã¤'); // å°æ›¸ãâ†’é€šå¸¸
      n=n.replace(/ãƒ¼/g,''); // é•·éŸ³è¨˜å·é™¤å»
      return n.toLowerCase();
    };
    const countChars=(s)=>normalizeJP(s).length;

    // ====== ãƒ­ãƒ¼ãƒå­—ï¼šæ¨™æº–(è¡¨ç¤ºç”¨) + ä»£æ›¿(åˆ¤å®šç”¨) ======
    const BASE_ROMA={ // è¡¨ç¤ºç”¨ã¯ãƒ˜ãƒœãƒ³ç³»
      'ã‚':'a','ã„':'i','ã†':'u','ãˆ':'e','ãŠ':'o',
      'ã‹':'ka','ã':'ki','ã':'ku','ã‘':'ke','ã“':'ko',
      'ãŒ':'ga','ã':'gi','ã':'gu','ã’':'ge','ã”':'go',
      'ã•':'sa','ã—':'shi','ã™':'su','ã›':'se','ã':'so',
      'ã–':'za','ã˜':'ji','ãš':'zu','ãœ':'ze','ã':'zo',
      'ãŸ':'ta','ã¡':'chi','ã¤':'tsu','ã¦':'te','ã¨':'to',
      'ã ':'da','ã¢':'ji','ã¥':'zu','ã§':'de','ã©':'do',
      'ãª':'na','ã«':'ni','ã¬':'nu','ã­':'ne','ã®':'no',
      'ã¯':'ha','ã²':'hi','ãµ':'fu','ã¸':'he','ã»':'ho',
      'ã°':'ba','ã³':'bi','ã¶':'bu','ã¹':'be','ã¼':'bo',
      'ã±':'pa','ã´':'pi','ã·':'pu','ãº':'pe','ã½':'po',
      'ã¾':'ma','ã¿':'mi','ã‚€':'mu','ã‚':'me','ã‚‚':'mo',
      'ã‚„':'ya','ã‚†':'yu','ã‚ˆ':'yo',
      'ã‚‰':'ra','ã‚Š':'ri','ã‚‹':'ru','ã‚Œ':'re','ã‚':'ro',
      'ã‚':'wa','ã‚':'wi','ã‚‘':'we','ã‚’':'wo','ã‚“':'n'
    };
    const ALT_ROMA={ // ä»£æ›¿è¡¨è¨˜ï¼ˆè¿½åŠ åˆ†ï¼‰
      'ã—':['si'],
      'ã¡':['ti'],
      'ã¤':['tu'],
      'ã˜':['zi'],
      'ã¢':['di'],      // IMEã§di=ã¢
      'ã¥':['du'],      // du=ã¥
      'ãµ':['hu'],
      'ã‚’':['o'],
      'ã‚“':['nn']
    };

    function romajiVariantsForChar(ch){
      const base=BASE_ROMA[ch];
      const alts=ALT_ROMA[ch]||[];
      if(!base && alts.length===0) return [ch]; // æœªå®šç¾©ã¯ãã®ã¾ã¾
      const set=new Set();
      if(base) set.add(base);
      alts.forEach(a=>set.add(a));
      return Array.from(set);
    }

    function buildRomajiForText(hira){
      const per=[...hira].map(romajiVariantsForChar);
      const primary = per.map(v=>v[0]).join('');
      // å…¨é€šã‚Šï¼ˆçŸ­ã„èªãªã®ã§ååˆ†è»½ã„ï¼‰ã€‚ä¸Šé™ã§å®‰å…¨è£…ç½®
      const limit=50000;
      const out=[];
      (function dfs(i,acc){
        if(out.length>=limit) return;
        if(i===per.length){ out.push(acc); return; }
        for(const s of per[i]) dfs(i+1,acc+s);
      })(0,'');
      // é‡è¤‡é™¤å»
      return { primary, all:Array.from(new Set(out)) };
    }

    // ====== ã‚¿ã‚¤ãƒ”ãƒ³ã‚°çŠ¶æ…‹ ======
    let typingState={primaryRomaji:'',allowedRomaji:[],typedKeys:''};

    function setupTypingGuide(targetText){
      const jpEl=document.getElementById('typingGuideJP');
      const subEl=document.getElementById('typingGuideSub');
      const romaEl=document.getElementById('romajiGuide');
      const norm=normalizeJP(targetText);

      // é€²æ—ãƒªã‚»ãƒƒãƒˆ
      jpEl.style.setProperty('--fill','0%');
      jpEl.textContent=targetText;

      // ã²ã‚‰ãŒãª1æ–‡å­—ãšã¤
      subEl.innerHTML='';
      [...norm].forEach((ch,i)=>{
        const span=document.createElement('span');
        span.className='char pending'; span.dataset.index=i; span.textContent=ch;
        subEl.appendChild(span);
      });

      // ãƒ­ãƒ¼ãƒå­—ï¼ˆè¡¨ç¤ºç”¨ã¯primaryã€åˆ¤å®šã¯allowedï¼‰
      const {primary,all}=buildRomajiForText(norm);
      typingState={primaryRomaji:primary,allowedRomaji:all,typedKeys:''};

      romaEl.innerHTML='';
      [...primary].forEach((c,i)=>{
        const s=document.createElement('span');
        s.className='romaji-char'; s.dataset.index=i; s.textContent=c;
        romaEl.appendChild(s);
      });
      if(primary.length>0) romaEl.children[0].classList.add('current');
    }

    function updateTypingGuideProgress(){
      if(!gameState.selectedCard) return;
      const jpEl=document.getElementById('typingGuideJP');
      const subEl=document.getElementById('typingGuideSub');

      const target=gameState.selectedCard.text;
      const normTarget=normalizeJP(target);

      const typedLen=typingState.typedKeys.length;
      const baseLen=typingState.primaryRomaji.length||1;

      const progress=Math.max(0,Math.min(1,typedLen/baseLen));
      const hiraMatched=Math.floor(progress*normTarget.length);

      jpEl.style.setProperty('--fill',`${progress*100}%`);
      document.getElementById('progressFill').style.width=`${progress*100}%`;

      const chars=subEl.querySelectorAll('.char');
      chars.forEach((el,i)=>{
        el.classList.remove('matched','current','pending');
        if(i<hiraMatched) el.classList.add('matched');
        else if(i===hiraMatched && typedLen<baseLen) el.classList.add('current');
        else el.classList.add('pending');
      });
    }

    function updateRomajiDisplay(){
      const el=document.getElementById('romajiGuide');
      const chars=el.querySelectorAll('.romaji-char');
      const typedLen=Math.min(typingState.typedKeys.length, typingState.primaryRomaji.length);
      chars.forEach((c,i)=>{
        c.classList.remove('typed','current');
        if(i < typedLen) c.classList.add('typed');
        else if(i===typedLen) c.classList.add('current');
      });
    }

    // ====== ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã¨ã‚«ãƒ¼ãƒ‰ ======
    let gameState={
      mode:null,
      players:[
        {name:'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1',hp:300,maxHp:300,avatar:'ğŸ”¥',attribute:'fire'},
        {name:'CPU',hp:300,maxHp:300,avatar:'ğŸ¤–',attribute:'water'}
      ],
      currentPlayer:0,selectedCard:null,hands:[[],[]],deck:[],discard:[],
      timer:15,timerInterval:null,gamePhase:'cardSelect',soundEnabled:true,isPaused:false,
      stats:{totalChars:0,correctChars:0,totalTime:0,combo:0,maxCombo:0}
    };

    // æ—¢å­˜ã‚«ãƒ¼ãƒ‰
    const BASE_CARDS=[
      {text:'ã­ã“',difficulty:1,category:'ã©ã†ã¶ã¤'},{text:'ã„ã¬',difficulty:1,category:'ã©ã†ã¶ã¤'},{text:'ã™ã—',difficulty:1,category:'ãŸã¹ã‚‚ã®'},
      {text:'ãã‚‰',difficulty:1,category:'ã—ãœã‚“'},{text:'ã‚„ã¾',difficulty:1,category:'ã—ãœã‚“'},{text:'ã‹ã‚',difficulty:1,category:'ã—ãœã‚“'},
      {text:'ã¯ãª',difficulty:1,category:'ã—ãœã‚“'},{text:'ã¿ãš',difficulty:1,category:'ã—ãœã‚“'},{text:'ã‚†ã',difficulty:1,category:'ã—ãœã‚“'},
      {text:'ã¤ã',difficulty:1,category:'ã—ãœã‚“'},{text:'ã‹ã•',difficulty:1,category:'ã‚‚ã®'},{text:'ã†ã¿',difficulty:1,category:'ã—ãœã‚“'},
      {text:'ã‚ã‚',difficulty:1,category:'ã—ãœã‚“'},{text:'ã»ã—',difficulty:1,category:'ã—ãœã‚“'},{text:'ã‹ã«',difficulty:1,category:'ã©ã†ã¶ã¤'},
      {text:'ã•ã‚‹',difficulty:1,category:'ã©ã†ã¶ã¤'},{text:'ã‚‚ã‚Š',difficulty:1,category:'ã—ãœã‚“'},{text:'ãã‚‚',difficulty:1,category:'ã—ãœã‚“'},
      {text:'ã¿ã¡',difficulty:1,category:'ã‚‚ã®'},{text:'ã‹ãœ',difficulty:1,category:'ã—ãœã‚“'},
      {text:'ãŸã¾ã”',difficulty:2,category:'ãŸã¹ã‚‚ã®'},{text:'ãã‚‹ã¾',difficulty:2,category:'ã®ã‚Šã‚‚ã®'},{text:'ãã¤ã­',difficulty:2,category:'ã©ã†ã¶ã¤'},
      {text:'ã†ã•ã',difficulty:2,category:'ã©ã†ã¶ã¤'},{text:'ã•ã‹ãª',difficulty:2,category:'ã©ã†ã¶ã¤'},{text:'ã‘ã‚€ã—',difficulty:2,category:'ã©ã†ã¶ã¤'},
      {text:'ãã®ã“',difficulty:2,category:'ã—ãœã‚“'},{text:'ã“ã©ã‚‚',difficulty:2,category:'ã²ã¨'},{text:'ã¿ã‹ã‚“',difficulty:2,category:'ãŸã¹ã‚‚ã®'},
      {text:'ãˆãŒãŠ',difficulty:2,category:'ãã‚‚ã¡'},{text:'ã™ãšã‚',difficulty:2,category:'ã©ã†ã¶ã¤'},{text:'ã‚Šã‚“ã”',difficulty:2,category:'ãŸã¹ã‚‚ã®'},
      {text:'ã¨ã‘ã„',difficulty:2,category:'ã‚‚ã®'},{text:'ã‹ã°ã‚“',difficulty:2,category:'ã‚‚ã®'},{text:'ãŠãµã‚',difficulty:2,category:'ã‚‚ã®'},
      {text:'ãˆã»ã‚“',difficulty:2,category:'ã‚‚ã®'},{text:'ã®ã¯ã‚‰',difficulty:2,category:'ã—ãœã‚“'},{text:'ã‚„ã•ã„',difficulty:2,category:'ãŸã¹ã‚‚ã®'},
      {text:'ã§ã‚“ã',difficulty:2,category:'ã‚‚ã®'}
    ];

    // è¿½åŠ ã‚«ãƒ¼ãƒ‰ï¼ˆå°æ–‡å­—ãƒ»ä¿ƒéŸ³ãƒ»é•·ã‚ã®èªã‚‚ï¼‰
    const EXTRA_CARDS=[
      {text:'ãŒã£ã“ã†',difficulty:2,category:'ã°ã—ã‚‡'},
      {text:'ã§ã‚“ã—ã‚ƒ',difficulty:2,category:'ã®ã‚Šã‚‚ã®'},
      {text:'ã²ã“ã†ã',difficulty:3,category:'ã®ã‚Šã‚‚ã®'},
      {text:'ã›ã‚“ã›ã„',difficulty:3,category:'ã²ã¨'},
      {text:'ãã‚‡ã†ã–',difficulty:3,category:'ãŸã¹ã‚‚ã®'},
      {text:'ãã‚…ã†ã‚Š',difficulty:2,category:'ãŸã¹ã‚‚ã®'},
      {text:'ã—ã‚ƒã—ã‚“',difficulty:3,category:'ã‚‚ã®'},
      {text:'ãˆã‚“ã´ã¤',difficulty:2,category:'ã‚‚ã®'},
      {text:'ã¦ãŒã¿',difficulty:2,category:'ã‚‚ã®'},
      {text:'ã¯ã£ã±',difficulty:2,category:'ã—ãœã‚“'},
      {text:'ã“ãŠã‚Š',difficulty:2,category:'ã—ãœã‚“'},
      {text:'ãŸã‹ã‚‰ã°ã“',difficulty:3,category:'ã‚‚ã®'},
      {text:'ãŸã„ã‚ˆã†',difficulty:2,category:'ã—ãœã‚“'},
      {text:'ã¤ã°ã•',difficulty:2,category:'ã‚‚ã®'},
      {text:'ã»ã†ã›ã',difficulty:3,category:'ã‚‚ã®'},
      {text:'ã“ã†ãˆã‚“',difficulty:2,category:'ã°ã—ã‚‡'},
      {text:'ã›ã‹ã„ã¡ãš',difficulty:3,category:'ã‚‚ã®'},
      {text:'ã—ã‚‡ã†ãŒã£ã“ã†',difficulty:4,category:'ã°ã—ã‚‡'},
      {text:'ã—ã‚“ã‹ã‚“ã›ã‚“',difficulty:4,category:'ã®ã‚Šã‚‚ã®'},
      {text:'ã©ã†ã¶ã¤ãˆã‚“',difficulty:4,category:'ã°ã—ã‚‡'},
      {text:'ãã˜ã‚‰',difficulty:2,category:'ã©ã†ã¶ã¤'},
      {text:'ã‚ã‚Šãã„',difficulty:3,category:'ã©ã†ã¶ã¤'},
      {text:'ã“ã‚ã‚‰',difficulty:2,category:'ã©ã†ã¶ã¤'},
      {text:'ãã¤ã¤ã',difficulty:3,category:'ã©ã†ã¶ã¤'},
      {text:'ã¾ã»ã†ã¤ã‹ã„',difficulty:4,category:'ã²ã¨'},
      {text:'ãŠã¾ã¤ã‚Š',difficulty:2,category:'ã‚¤ãƒ™ãƒ³ãƒˆ'},
      {text:'ã©ã‚‰ã‚„ã',difficulty:2,category:'ãŸã¹ã‚‚ã®'},
      {text:'ã‹ã‚‰ã‚ã’',difficulty:2,category:'ãŸã¹ã‚‚ã®'},
      {text:'ã™ã„ããã‹ã‚“',difficulty:4,category:'ã°ã—ã‚‡'},
      {text:'ãˆã„ãŒã‹ã‚“',difficulty:3,category:'ã°ã—ã‚‡'},
      {text:'ã‚„ãã„ã‚‚',difficulty:2,category:'ãŸã¹ã‚‚ã®'},
      {text:'ãŠã«ãã‚Š',difficulty:2,category:'ãŸã¹ã‚‚ã®'},
      {text:'ã‹ã¿ãªã‚Š',difficulty:2,category:'ã—ãœã‚“'},
      {text:'ãŸã„ãµã†',difficulty:3,category:'ã—ãœã‚“'},
      {text:'ã›ã¿ã®ã¬ã‘ãŒã‚‰',difficulty:4,category:'ã—ãœã‚“'},
      {text:'ã«ã˜ã„ã‚',difficulty:3,category:'ã—ãœã‚“'},
      {text:'ã¿ã‚‰ã„',difficulty:2,category:'ã“ã¨ã°'}
    ];

    const CARD_POOL=[...BASE_CARDS,...EXTRA_CARDS];

    // ====== ç”»é¢é·ç§»ãªã©ï¼ˆå‰å›ç‰ˆã¨åŒæ§˜ï¼‰ ======
    function initGame(){
      gameState.deck=[...CARD_POOL].sort(()=>Math.random()-.5);
      for(let i=0;i<2;i++){
        gameState.hands[i]=[];
        for(let j=0;j<5;j++) if(gameState.deck.length>0) gameState.hands[i].push(gameState.deck.pop());
      }
      updateUI(); drawCards(); startTurn();
    }

    function selectMode(mode){
      document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('selected'));
      document.getElementById(mode==='cpu'?'cpuModeBtn':'pvpModeBtn').classList.add('selected');
      gameState.mode=mode;
      document.getElementById('characterSelection').classList.remove('hidden');
      if(mode==='pvp'){document.getElementById('player2Setup').classList.remove('hidden');gameState.players[1].name='ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2';gameState.players[1].avatar='ğŸ’§';}
      else{document.getElementById('player2Setup').classList.add('hidden');gameState.players[1].name='CPU';gameState.players[1].avatar='ğŸ¤–';}
      setTimeout(()=>{const ni=document.getElementById('player1NameInput'); ni.focus(); ni.select();},100);
      document.getElementById('player1NameInput').addEventListener('focus',function(){this.select()});
      if(mode==='pvp'){document.getElementById('player2NameInput').addEventListener('focus',function(){this.select()});}
      selectCharacter('fire',1); if(mode==='pvp') selectCharacter('water',2);
      checkSetupComplete();
    }
    function selectCharacter(attr,player){
      document.querySelectorAll(`[data-player="${player}"]`).forEach(btn=>btn.classList.remove('selected'));
      document.querySelector(`[data-attr="${attr}"][data-player="${player}"]`).classList.add('selected');
      const avatars={fire:'ğŸ”¥',water:'ğŸ’§',thunder:'âš¡',wind:'ğŸŒªï¸',earth:'ğŸŒ±',light:'âœ¨'};
      gameState.players[player-1].attribute=attr;
      gameState.players[player-1].avatar=avatars[attr];
      const nameInput=document.getElementById(`player${player}NameInput`);
      if(nameInput) gameState.players[player-1].name=nameInput.value||`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${player}`;
      if(player===1 && gameState.mode==='pvp'){setTimeout(()=>{const i2=document.getElementById('player2NameInput'); i2.focus(); i2.select();},100);}
      checkSetupComplete();
    }
    function checkSetupComplete(){
      const p1=!!document.querySelector('[data-player="1"].selected');
      const p2=(gameState.mode==='cpu') || !!document.querySelector('[data-player="2"].selected');
      document.getElementById('nextBtn').disabled=!(p1&&p2);
    }
    function showGameRules(){
      gameState.players[0].name=document.getElementById('player1NameInput').value||'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1';
      if(gameState.mode==='pvp') gameState.players[1].name=document.getElementById('player2NameInput').value||'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2';
      else gameState.players[1].name='CPU';
      document.getElementById('characterSelection').classList.add('hidden');
      document.getElementById('gameRules').classList.remove('hidden');
    }
    function startGame(){
      document.getElementById('startScreen').classList.add('hidden');
      document.getElementById('gameContainer').classList.remove('hidden');
      initGame();
    }
    function updateUI(){
      for(let i=0;i<2;i++){
        const p=gameState.players[i];
        document.getElementById(`player${i+1}Name`).textContent=p.name;
        document.getElementById(`player${i+1}Avatar`).textContent=p.avatar;
        const per=(p.hp/p.maxHp)*100;
        document.getElementById(`player${i+1}HpBar`).style.width=`${per}%`;
        document.getElementById(`player${i+1}HpText`).textContent=`${Math.max(0,Math.round(p.hp))}/${p.maxHp}`;
      }
      document.getElementById('turnDisplay').textContent=`${gameState.players[gameState.currentPlayer].name}ã®ã‚¿ãƒ¼ãƒ³`;
      updatePhaseDisplay();
    }
    function updatePhaseDisplay(){
      const el=document.getElementById('phaseDisplay');
      el.textContent=({cardSelect:'ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„',typing:'ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ä¸­...',result:'çµæœè¡¨ç¤º'})[gameState.gamePhase]||'';
    }
    function drawCards(){
      const container=document.getElementById('cardsContainer'); container.innerHTML='';
      const hand=gameState.hands[gameState.currentPlayer];
      if(gameState.deck.length>0 && hand.length<6) hand.push(gameState.deck.pop());
      hand.forEach((card,idx)=>{
        const div=document.createElement('div');
        div.className='card'; div.onclick=()=>selectCard(idx);
        const stars='â˜…'.repeat(card.difficulty);
        div.innerHTML=`<div class="card-text">${card.text}</div><div class="card-difficulty">${stars} ${card.category}</div>`;
        container.appendChild(div);
      });
    }
    function selectCard(index){
      if(gameState.gamePhase!=='cardSelect') return;
      document.querySelectorAll('.card').forEach(c=>c.classList.remove('selected'));
      document.querySelectorAll('.card')[index].classList.add('selected');
      gameState.selectedCard=gameState.hands[gameState.currentPlayer][index];
      setupTypingGuide(gameState.selectedCard.text);
      startTypingPhase();
    }
    function showCountdown(){
      return new Promise(resolve=>{
        const overlay=document.createElement('div'); overlay.className='countdown-overlay';
        const num=document.createElement('div'); num.className='countdown-number'; overlay.appendChild(num);
        document.body.appendChild(overlay);
        let count=2;
        (function tick(){ num.textContent=count; if(count>0){count--; setTimeout(tick,1000);}else{num.textContent='START!'; setTimeout(()=>{overlay.remove(); resolve();},500);} })();
      });
    }
    async function startTypingPhase(){
      gameState.gamePhase='typing'; gameState.timer=15;
      await showCountdown();
      const sk=document.getElementById('softKeyboard'); sk.value=''; sk.focus();
      document.addEventListener('keydown',handleKeyPress);
      startTimer();
    }
    function startTimer(){
      clearInterval(gameState.timerInterval);
      gameState.timerInterval=setInterval(()=>{
        if(gameState.isPaused) return;
        gameState.timer--;
        const ring=document.getElementById('timerRing');
        ring.textContent=gameState.timer;
        const progress=(gameState.timer/15)*360;
        ring.style.background=`conic-gradient(#feca57 ${progress}deg, rgba(255,255,255,.2) ${progress}deg)`;
        if(gameState.timer<=0){ timeUp(); }
      },1000);
    }

    // ====== ã“ã“ãŒã€Œè¤‡æ•°ãƒ­ãƒ¼ãƒå­—å¯¾å¿œã€ã®è‚ ======
    function isPrefixOfAny(prefix, list){
      for(const s of list){ if(s.startsWith(prefix)) return true; }
      return false;
    }
    function isExactlyAny(s, list){ return list.includes(s); }

    function handleKeyPress(e){
      if(gameState.gamePhase!=='typing' || gameState.isPaused) return;
      const key=e.key.toLowerCase();

      if(key==='enter'){ e.preventDefault(); if(isExactlyAny(typingState.typedKeys, typingState.allowedRomaji)) submitAnswer(); return; }
      if(key==='escape'){ e.preventDefault(); giveUp(); return; }
      if(!/^[a-z]$/.test(key)) return;

      e.preventDefault();
      const next=typingState.typedKeys + key;

      if(isPrefixOfAny(next, typingState.allowedRomaji)){
        typingState.typedKeys=next;
        updateRomajiDisplay();
        updateTypingGuideProgress();
        if(isExactlyAny(typingState.typedKeys, typingState.allowedRomaji)){
          setTimeout(()=>submitAnswer(),60);
        }
      }else{
        playSound('fail');
      }
    }

    function submitAnswer(){
      const target=gameState.selectedCard.text;
      const len=countChars(target);
      const timeUsed=Math.max(0,15-gameState.timer);

      gameState.stats.totalChars+=len;
      gameState.stats.totalTime+=timeUsed;

      const success=isExactlyAny(typingState.typedKeys, typingState.allowedRomaji);

      if(success){
        const damage=Math.round(len*gameState.timer*10)/10;
        dealDamage(1-gameState.currentPlayer,damage);
        gameState.stats.correctChars+=len;
        gameState.stats.combo++; gameState.stats.maxCombo=Math.max(gameState.stats.maxCombo,gameState.stats.combo);
        playSound('success');
      }else{
        const self=len*10;
        dealDamage(gameState.currentPlayer,self);
        gameState.stats.combo=0; playSound('fail');
      }
      endTurn();
    }

    function giveUp(){
      const len=countChars(gameState.selectedCard.text);
      const timeUsed=Math.max(0,15-gameState.timer);
      gameState.stats.totalChars+=len; gameState.stats.totalTime+=timeUsed;
      dealDamage(gameState.currentPlayer,len*10);
      gameState.stats.combo=0; playSound('fail'); endTurn();
    }
    function timeUp(){
      const len=countChars(gameState.selectedCard.text);
      gameState.stats.totalChars+=len; gameState.stats.totalTime+=15;
      dealDamage(gameState.currentPlayer,len*10);
      gameState.stats.combo=0; playSound('fail'); endTurn();
    }
    function dealDamage(idx,damage){
      gameState.players[idx].hp=Math.max(0,gameState.players[idx].hp - damage);
      showDamageEffect(idx,damage);
      updateUI();
      if(gameState.players[idx].hp<=0) endGame(1-idx);
    }
    function showDamageEffect(idx,damage){
      const avatar=document.getElementById(`player${idx+1}Avatar`);
      const dmg=document.createElement('div'); dmg.className='damage-number'; dmg.textContent=`-${Math.round(damage)}`;
      dmg.style.left='50%'; dmg.style.top='50%';
      avatar.style.position='relative'; avatar.appendChild(dmg);
      avatar.classList.add('shake');
      setTimeout(()=>{avatar.classList.remove('shake'); if(dmg.parentNode) dmg.remove();},1000);
    }
    function endTurn(){
      clearInterval(gameState.timerInterval);
      document.removeEventListener('keydown',handleKeyPress);

      const hand=gameState.hands[gameState.currentPlayer];
      const idx=hand.indexOf(gameState.selectedCard);
      if(idx>-1){ hand.splice(idx,1); gameState.discard.push(gameState.selectedCard); }

      document.getElementById('typingGuideJP').style.setProperty('--fill','0%');
      document.getElementById('typingGuideSub').innerHTML='';
      document.getElementById('romajiGuide').innerHTML='';
      document.getElementById('progressFill').style.width='0%';
      typingState={primaryRomaji:'',allowedRomaji:[],typedKeys:''};

      gameState.gamePhase='result'; updatePhaseDisplay();
      gameState.currentPlayer=1-gameState.currentPlayer;
      gameState.gamePhase='cardSelect'; gameState.selectedCard=null;

      setTimeout(()=>{ if(gameState.mode==='cpu' && gameState.currentPlayer===1) cpuTurn(); else startTurn(); },1200);
    }
    function startTurn(){
      updateUI(); drawCards();
      const ring=document.getElementById('timerRing');
      ring.textContent='15';
      ring.style.background='conic-gradient(#feca57 360deg, rgba(255,255,255,.2) 360deg)';
    }
    function cpuTurn(){
      updateUI(); drawCards();
      setTimeout(()=>{
        const hand=gameState.hands[1];
        let best=hand[0],score=-1;
        hand.forEach(card=>{
          const t=Math.random()*10+5;
          const exp=card.text.length*t;
          const risk=card.difficulty*20;
          const s=exp-risk; if(s>score){score=s; best=card;}
        });
        gameState.selectedCard=best;
        setTimeout(()=>{
          const ok=Math.random()>(best.difficulty*0.2);
          if(ok){
            const t=Math.random()*8+2;
            const dmg=Math.round(countChars(best.text)*t*10)/10;
            dealDamage(0,dmg);
            const len=countChars(best.text);
            gameState.stats.correctChars+=len; gameState.stats.totalChars+=len; gameState.stats.totalTime+=(15-t);
            playSound('success');
          }else{
            const len=countChars(best.text);
            dealDamage(1,len*10);
            gameState.stats.totalChars+=len; gameState.stats.totalTime+=15;
            playSound('fail');
          }
          endTurn();
        },1200);
      },800);
    }
    function endGame(winner){
      gameState.gamePhase='result';
      const name=gameState.players[winner].name;
      const acc=gameState.stats.totalChars>0 ? Math.round((gameState.stats.correctChars/gameState.stats.totalChars)*100) : 0;
      const avg=gameState.stats.totalChars>0 ? Math.round((gameState.stats.totalTime/gameState.stats.totalChars)*10)/10 : 0;
      showModal(`ğŸ‰ ${name}ã®å‹åˆ©ï¼`,`
        <p>ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼</p>
        <p><strong>æˆ¦ç¸¾</strong></p>
        <p>æœ€å¤§ã‚³ãƒ³ãƒœ: ${gameState.stats.maxCombo}</p>
        <p>æ­£ç¢ºæ€§: ${acc}%</p>
        <p>å¹³å‡å…¥åŠ›æ™‚é–“: ${avg}ç§’/æ–‡å­—</p>
        <button class="btn btn-primary" onclick="backToMenu()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
        <button class="btn btn-secondary" onclick="restartGame()">ã‚‚ã†ä¸€åº¦</button>
      `);
    }
    function playSound(type){
      if(!gameState.soundEnabled) return;
      const ctx=new (window.AudioContext||window.webkitAudioContext)();
      const osc=ctx.createOscillator(); const g=ctx.createGain();
      osc.connect(g); g.connect(ctx.destination);
      if(type==='success'){osc.frequency.setValueAtTime(523.25,ctx.currentTime);osc.frequency.setValueAtTime(659.25,ctx.currentTime+.1);}
      else{osc.frequency.setValueAtTime(220,ctx.currentTime);}
      g.gain.setValueAtTime(.1,ctx.currentTime); g.gain.exponentialRampToValueAtTime(.01,ctx.currentTime+.3);
      osc.start(ctx.currentTime); osc.stop(ctx.currentTime+.3);
    }
    function showModal(title,content){ document.getElementById('modalContent').innerHTML=`<h2>${title}</h2>${content}`; document.getElementById('modal').style.display='flex'; }
    function hideModal(){ document.getElementById('modal').style.display='none'; }
    function showHelp(){
      showModal('ğŸ“– ã‚²ãƒ¼ãƒ ã®éŠã³æ–¹',`
        <p><strong>åŸºæœ¬ãƒ«ãƒ¼ãƒ«</strong></p>
        <p>â€¢ HP300ã§ã‚¹ã‚¿ãƒ¼ãƒˆ / ç›¸æ‰‹ã®HPã‚’0ã§å‹åˆ©</p>
        <p>â€¢ ã‚«ãƒ¼ãƒ‰é¸æŠâ†’ã‚«ã‚¦ãƒ³ãƒˆå¾Œã«ãƒ­ãƒ¼ãƒå­—å…¥åŠ›ï¼ˆå®Œäº†ã§è‡ªå‹•åˆ¤å®šï¼‰</p>
        <p>â€¢ æˆåŠŸï¼šæ–‡å­—æ•°Ã—æ®‹ã‚Šæ™‚é–“ / å¤±æ•—ï¼šæ–‡å­—æ•°Ã—10ã®è‡ªå‚·</p>
        <p><strong>æ“ä½œ</strong></p>
        <p>â€¢ Enterï¼šå®Œäº†ç¢ºå®š / Escï¼šã‚®ãƒ–ã‚¢ãƒƒãƒ—</p>
        <p class="romaji-note">åˆ¥è¡¨è¨˜OKï¼štsu/tu, shi/si, chi/ti, ji/zi, di/ji, du/zu, fu/hu, wo/o, n/nn</p>
        <button class="btn btn-primary" onclick="hideModal()">é–‰ã˜ã‚‹</button>
      `);
    }
    function toggleSound(){ gameState.soundEnabled=!gameState.soundEnabled; document.getElementById('soundBtn').textContent=gameState.soundEnabled?'ğŸ”Š':'ğŸ”‡'; }
    function pauseGame(){
      if(gameState.gamePhase!=='typing') return;
      if(!gameState.isPaused){
        gameState.isPaused=true; document.getElementById('pauseBtn').textContent='â–¶ï¸';
        showModal('â¸ï¸ ä¸€æ™‚åœæ­¢',`<p>ã‚²ãƒ¼ãƒ ã‚’ä¸€æ™‚åœæ­¢ã—ã¾ã—ãŸ</p><button class="btn btn-primary" onclick="resumeGame()">å†é–‹</button>`);
      }else{ resumeGame(); }
    }
    function resumeGame(){ gameState.isPaused=false; document.getElementById('pauseBtn').textContent='â¸ï¸'; hideModal(); }
    function backToMenu(){
      gameState={
        mode:null,
        players:[{name:'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1',hp:300,maxHp:300,avatar:'ğŸ”¥',attribute:'fire'},{name:'CPU',hp:300,maxHp:300,avatar:'ğŸ¤–',attribute:'water'}],
        currentPlayer:0,selectedCard:null,hands:[[],[]],deck:[],discard:[],
        timer:15,timerInterval:null,gamePhase:'cardSelect',soundEnabled:true,isPaused:false,
        stats:{totalChars:0,correctChars:0,totalTime:0,combo:0,maxCombo:0}
      };
      clearInterval(gameState.timerInterval); hideModal();
      document.getElementById('gameContainer').classList.add('hidden');
      document.getElementById('startScreen').classList.remove('hidden');
      document.getElementById('characterSelection').classList.add('hidden');
      document.getElementById('gameRules').classList.add('hidden');
      document.getElementById('player2Setup').classList.add('hidden');
      document.querySelectorAll('.mode-btn,.character-btn').forEach(b=>b.classList.remove('selected'));
      document.getElementById('player1NameInput').value='ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1';
      document.getElementById('player2NameInput').value='ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2';
      document.getElementById('nextBtn').disabled=true;
    }
    function restartGame(){
      hideModal();
      gameState.players.forEach(p=>p.hp=p.maxHp);
      gameState.stats={totalChars:0,correctChars:0,totalTime:0,combo:0,maxCombo:0};
      gameState.currentPlayer=0; gameState.gamePhase='cardSelect';
      initGame();
    }
    document.addEventListener('DOMContentLoaded',()=>{ document.getElementById('modal').addEventListener('click',e=>{ if(e.target===e.currentTarget) hideModal(); }); });
  </script>
</body>
</html>
