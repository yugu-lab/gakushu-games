<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>„Çø„Ç§„Éî„É≥„Ç∞„Éê„Éà„É´ - Â≠¶Áøí„Ç≤„Éº„É†</title>
    <link href="https://fonts.googleapis.com/css2?family=BIZ+UDGothic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ÂÆâÂÖ®È†òÂüüÔºàiPad/iPhone„Éé„ÉÉ„ÉÅÔºâ */
        :root{
            --safe-top: env(safe-area-inset-top);
            --safe-right: env(safe-area-inset-right);
            --safe-bottom: env(safe-area-inset-bottom);
            --safe-left: env(safe-area-inset-left);
        }

        body {
            font-family: 'BIZ UDGothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
        }

        .game-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* „Éà„ÉÉ„Éó„Éê„ÉºÔºöÂ∑¶Âè≥„Å´HP„ÄÅ‰∏≠Â§Æ„Å´„Çø„Éº„É≥/„Çø„Ç§„Éû„Éº */
        .top-bar{
            min-height: 80px;
            padding: calc(8px + var(--safe-top)) clamp(12px, 2vw, 24px) 8px clamp(12px, 2vw, 24px);
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.2);

            /* Grid „ÅßÂ∑¶Âè≥Á´Ø„Å´Âõ∫ÂÆö */
            display: grid;
            grid-template-columns: 1fr auto 1fr; /* Â∑¶ HP | ‰∏≠Â§Æ info | Âè≥ HP */
            align-items: center;
            gap: 12px;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 0;          /* Á´Ø„Å´ÂØÑ„Åõ„Çã„Åü„ÇÅÊúÄÂ∞èÂπÖÂà∂Á¥Ñ„ÇíÂ§ñ„Åô */
            justify-self: start;   /* Â∑¶ÂÅ¥„ÅØÂ∑¶Á´Ø„Å∏ */
        }

        .player-info:last-child{
            justify-self: end;     /* Âè≥ÂÅ¥„ÅØÂè≥Á´Ø„Å∏ */
            flex-direction: row-reverse; /* „Ç¢„Ç§„Ç≥„É≥„ÇíÂè≥ÂØÑ„Åõ„ÅÆ„Åæ„Åæ„Å´„Åô„Çã */
        }

        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .player-stats {
            flex: 1;
        }

        .player-name {
            font-weight: 700;
            color: white;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .hp-bar-container {
            width: 200px;
            height: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .hp-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #feca57);
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .hp-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .center-info {
            text-align: center;
            color: white;
            justify-self: center;
        }

        .turn-display {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .phase-display {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .timer-ring {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: conic-gradient(#feca57 0deg, rgba(255, 255, 255, 0.2) 0deg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            color: white;
            margin: 0 auto;
        }

        /* „Ç´„Éº„Éâ„Ç®„É™„Ç¢ */
        .card-area {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
        }

        /* „Éó„É¨„Ç§„É§„Éº„ÅÆÊâãÊú≠„Ç®„É™„Ç¢ÔºàÂ∑¶Âè≥„Å´ÈÖçÁΩÆÔºâ */
        .player-hand {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 100px;
            height: 400px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            z-index: 10;
        }

        .player-hand.left {
            left: 20px;
        }

        .player-hand.right {
            right: 20px;
        }

        .hand-card {
            width: 90px;
            height: 70px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 6px;
            text-align: center;
            font-size: 11px;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transform: translateX(10px);
            opacity: 0.7;
            transition: all 0.3s ease;
        }

        .hand-card:hover {
            transform: translateX(0);
            opacity: 1;
        }

        /* „É°„Ç§„É≥„Ç´„Éº„ÉâË°®Á§∫„Ç®„É™„Ç¢ */
        .main-cards-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
        }

        .cards-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            max-width: 800px;
            margin: 0 auto;
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.5s ease;
        }

        .cards-container.active {
            opacity: 1;
            transform: translateY(0);
        }

        .card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(15px);
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .card:hover::before {
            transform: translateX(100%);
        }

        .card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            border-color: rgba(254, 202, 87, 0.6);
        }

        .card.selected {
            border-color: #feca57;
            box-shadow: 0 0 30px rgba(254, 202, 87, 0.8);
            transform: scale(1.1) translateY(-15px);
            background: linear-gradient(145deg, rgba(254, 202, 87, 0.3), rgba(255, 159, 243, 0.2));
            animation: cardSelect 0.6s ease;
        }

        @keyframes cardSelect {
            0% { transform: scale(1) translateY(0); }
            50% { transform: scale(1.15) translateY(-20px) rotateY(10deg); }
            100% { transform: scale(1.1) translateY(-15px); }
        }

        .card-text {
            font-size: 24px;
            font-weight: 700;
            color: white;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.05em;
        }

        .card-difficulty {
            font-size: 14px;
            color: #feca57;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        /* „Çø„Ç§„Éî„É≥„Ç∞Ë°®Á§∫„Ç®„É™„Ç¢ */
        .typing-display {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px 20px calc(20px + var(--safe-bottom)) 20px;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            max-width: 600px;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
            margin: 15px auto;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #feca57);
            width: 0%;
            transition: width 0.2s ease;
        }

        .keyboard-hint {
            margin-top: 15px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-family: 'BIZ UDGothic', sans-serif;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #feca57, #ff9ff3);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* „Ç≥„É≥„Éà„É≠„Éº„É´„Ç®„É™„Ç¢ */
        .controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* „É¢„Éº„ÉÄ„É´ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            width: 90%;
        }

        .modal h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .modal p {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        /* „ÉÄ„É°„Éº„Ç∏„Ç®„Éï„Çß„ÇØ„Éà */
        .damage-number {
            position: absolute;
            font-size: 32px;
            font-weight: 900;
            color: #ff6b6b;
            pointer-events: none;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 100;
            animation: damageFloat 1.5s ease-out forwards;
        }

        .damage-number.heal {
            color: #4ecdc4;
        }

        @keyframes damageFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(0.5);
            }
            20% {
                transform: translateY(-10px) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translateY(-80px) scale(0.8);
            }
        }

        /* „Çø„Éº„É≥Âàá„ÇäÊõø„Åà„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó */
        .turn-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, rgba(254, 202, 87, 0.95), rgba(255, 159, 243, 0.95));
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 30px 50px;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: turnPopup 2s ease-in-out forwards;
        }

        .turn-popup h2 {
            font-size: 28px;
            font-weight: 900;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            margin: 0;
        }

        @keyframes turnPopup {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            20% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1);
            }
            80% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
        }

        /* Â±ûÊÄß„Ç´„É©„Éº */
        .fire { --attr-color: #ff6b6b; }
        .water { --attr-color: #4ecdc4; }
        .thunder { --attr-color: #ffe66d; }
        .wind { --attr-color: #95e1d3; }
        .earth { --attr-color: #a8e6cf; }
        .light { --attr-color: #ffd93d; }

        /* „Ç®„Éï„Çß„ÇØ„Éà„É¨„Ç§„É§„Éº */
        .fx-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 1000;
            overflow: hidden;
        }

        /* ÊîªÊíÉ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Áî®„Çπ„Çø„Ç§„É´ */
        .charge-effect {
            position: absolute;
            border-radius: 50%;
            will-change: transform, opacity;
            contain: layout paint;
        }

        .projectile {
            position: absolute;
            will-change: transform, opacity;
            contain: layout paint;
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            will-change: transform, opacity;
            contain: layout paint;
        }

        .impact-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            will-change: opacity;
        }

        /* Âº∑„ÅÑ„Ç∑„Çß„Ç§„ÇØ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        .shake-strong {
            animation: shakeStrong 0.4s ease-in-out;
        }

        @keyframes shakeStrong {
            0%, 100% { transform: translate3d(0, 0, 0); }
            10% { transform: translate3d(-8px, -4px, 0); }
            20% { transform: translate3d(6px, -8px, 0); }
            30% { transform: translate3d(-6px, 4px, 0); }
            40% { transform: translate3d(8px, 6px, 0); }
            50% { transform: translate3d(-4px, -6px, 0); }
            60% { transform: translate3d(6px, 8px, 0); }
            70% { transform: translate3d(-8px, -2px, 0); }
            80% { transform: translate3d(4px, -8px, 0); }
            90% { transform: translate3d(-6px, 6px, 0); }
        }

        /* Ê∫ú„ÇÅ„Ç®„Éï„Çß„ÇØ„Éà */
        @keyframes chargeGlow {
            0% { 
                transform: scale(1);
                box-shadow: 0 0 10px var(--glow-color);
            }
            50% { 
                transform: scale(1.15);
                box-shadow: 0 0 30px var(--glow-color), 0 0 60px var(--glow-color);
            }
            100% { 
                transform: scale(1.2);
                box-shadow: 0 0 40px var(--glow-color), 0 0 80px var(--glow-color);
            }
        }

        /* ÁÅ´ÁêÉ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes fireball {
            0% { 
                transform: scale(0.5) rotate(0deg);
                opacity: 1;
            }
            100% { 
                transform: scale(1.2) rotate(360deg);
                opacity: 0.8;
            }
        }

        /* Ê∞¥ÂàÉ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes waterBlade {
            0% { 
                transform: scaleX(0) rotate(-15deg);
                opacity: 1;
            }
            100% { 
                transform: scaleX(1) rotate(15deg);
                opacity: 0.9;
            }
        }

        /* Èõ∑„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes lightning {
            0%, 100% { opacity: 0; }
            10%, 30%, 50%, 70%, 90% { opacity: 1; }
            20%, 40%, 60%, 80% { opacity: 0.3; }
        }

        /* È¢®ÂàÉ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes windBlade {
            0% { 
                transform: scale(0) rotate(0deg);
                opacity: 0.8;
            }
            100% { 
                transform: scale(1.5) rotate(180deg);
                opacity: 0.3;
            }
        }

        /* Â≤©Êü±„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes rockSpike {
            0% { 
                transform: scaleY(0) translateY(50px);
                opacity: 1;
            }
            100% { 
                transform: scaleY(1) translateY(0);
                opacity: 0.9;
            }
        }

        /* ÂÖâÁ∑ö„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes lightBeam {
            0% { 
                transform: scaleX(0);
                opacity: 1;
            }
            50% { 
                transform: scaleX(1);
                opacity: 1;
            }
            100% { 
                transform: scaleX(1.2);
                opacity: 0.7;
            }
        }

        /* „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÁàÜÁô∫ */
        @keyframes particleExplode {
            0% { 
                transform: scale(0) translate3d(0, 0, 0);
                opacity: 1;
            }
            100% { 
                transform: scale(1) translate3d(var(--dx), var(--dy), 0);
                opacity: 0;
            }
        }

        /* „É™„ÉÉ„Éó„É´ÂäπÊûú */
        @keyframes ripple {
            0% { 
                transform: scale(0);
                opacity: 0.8;
            }
            100% { 
                transform: scale(3);
                opacity: 0;
            }
        }

        /* „É´„Éº„É¨„ÉÉ„ÉàÊºîÂá∫ */
        .roulette-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2500;
        }

        .roulette-container {
            text-align: center;
            color: white;
            position: relative;
        }

        .roulette-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 40px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            animation: titlePulse 2s ease-in-out infinite;
        }

        @keyframes titlePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .roulette-wheel {
            width: 350px;
            height: 350px;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg,
                #ff6b6b 0deg 90deg,
                #ff8a80 90deg 180deg,
                #4ecdc4 180deg 270deg,
                #80e5d1 270deg 360deg
            );
            border: 12px solid #feca57;
            position: relative;
            margin: 0 auto 40px auto;
            box-shadow: 
                0 0 60px rgba(254, 202, 87, 0.8),
                inset 0 0 30px rgba(0, 0, 0, 0.3);
        }

        .roulette-pointer {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 40px solid #feca57;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.5));
            z-index: 10;
            animation: pointerGlow 1.5s ease-in-out infinite;
        }

        @keyframes pointerGlow {
            0%, 100% { filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.5)); }
            50% { filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.5)) drop-shadow(0 0 20px #feca57); }
        }

        .roulette-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #feca57, #ff9ff3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            z-index: 5;
            border: 4px solid white;
        }

        .player-section {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 3px solid currentColor;
        }

        .player-section.left {
            left: 30px;
            color: #ff6b6b;
            flex-direction: row;
        }

        .player-section.right {
            right: 30px;
            color: #4ecdc4;
            flex-direction: row-reverse;
        }

        .player-avatar-roulette {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            border: 3px solid currentColor;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .wheel-labels {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .wheel-label {
            position: absolute;
            font-size: 18px;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 30px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            backdrop-filter: blur(5px);
        }

        .wheel-label.top {
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #ff6b6b;
        }

        .wheel-label.bottom {
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #4ecdc4;
        }

        .roulette-spinning {
            animation: rouletteSpin 3s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
        }

        .roulette-result {
            font-size: 24px;
            font-weight: 700;
            margin-top: 20px;
            opacity: 0;
            animation: resultFadeIn 0.5s ease-out 3.2s forwards;
        }

        @keyframes rouletteSpin {
            0% { transform: rotate(0deg); }
            70% { transform: rotate(1800deg); }
            100% { transform: rotate(var(--final-rotation, 1980deg)); }
        }

        @keyframes resultFadeIn {
            from { 
                opacity: 0;
                transform: translateY(20px) scale(0.8);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* „Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£ÂØæÂøú */
        @media (prefers-reduced-motion: reduce) {
            .shake-strong {
                animation: none;
            }
            
            .impact-flash {
                opacity: 0.3 !important;
            }
            
            @keyframes shakeStrong {
                0%, 100% { transform: translate3d(0, 0, 0); }
            }

            .roulette-spinning {
                animation: rouletteSpinReduced 1s ease-out forwards;
            }

            @keyframes rouletteSpinReduced {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(var(--final-rotation, 180deg)); }
            }
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñË™øÊï¥ */
        @media (max-width: 1024px) {
            .cards-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .cards-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .top-bar {
                height: 60px;
                padding: 0 10px;
            }
            
            .player-info {
                min-width: 200px;
            }
            
            .hp-bar-container {
                width: 150px;
            }

            .player-setup-container {
                flex-direction: column;
                gap: 20px;
            }

            .character-selection {
                grid-template-columns: repeat(6, 1fr);
                max-width: 100%;
            }
        }

        .hidden {
            display: none !important;
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* ÂïèÈ°å„ÉÜ„Ç≠„Çπ„Éà„ÅÆ‰∏ä‰∏ãÈñìÈöî„ÇÇÂæÆË™øÊï¥ */
        .typing-guide {
            text-align: center;
            color: white;
            margin-bottom: 10px;
            user-select: none;
        }
        .typing-guide .jp {
            font-size: 32px;
            line-height: 1.1;
            letter-spacing: .06em;
            font-weight: 700;
        }
        @media (min-width: 1024px){ .typing-guide .jp { font-size: 40px; } }

        .typing-guide .sub {
            font-size: 14px;
            opacity: .9;
            margin-top: 6px;
            letter-spacing: .08em;
        }

        /* ‰∏äÊÆµÔºöÂ∑¶„Åã„ÇâËâ≤„ÅåÊ∫Ä„Å°„ÇãÔºàÊñáÂ≠óÂçò‰Ωç„Åò„ÇÉ„Å™„Åè"Èù¢"„Åß„Çπ„Éº„ÉÉ„Å®Ôºâ */
        .jp-progress {
            display: inline-block;
            background: linear-gradient(
                90deg,
                #feca57 var(--fill, 0%),
                rgba(255,255,255,.95) var(--fill, 0%)
            );
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            transition: background .12s linear;
        }

        /* ‰∏ãÊÆµÔºö1ÊñáÂ≠ó„Åö„Å§ÁÇπÁÅØ */
        .sub .char { padding: 0 .06em; transition: color .08s, transform .04s; }
        .sub .char.matched { color: #feca57; }
        .sub .char.current { border-bottom: 2px solid #feca57; }
        .sub .char.pending { color: rgba(255,255,255,.85); opacity: .75; }

        /* „É≠„Éº„ÉûÂ≠ó„Ç¨„Ç§„Éâ */
        .romaji-guide {
            text-align: center;
            color: white;
            margin-bottom: 8px;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 0.1em;
            min-height: 40px;
        }

        .romaji-char {
            display: inline-block;
            padding: 0 2px;
            transition: color 0.1s ease;
        }

        .romaji-char.typed {
            color: #feca57;
        }

        .romaji-char.current {
            background: rgba(254, 202, 87, 0.3);
            border-radius: 4px;
        }

        /* „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ */
        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1500;
        }

        .countdown-number {
            font-size: 120px;
            font-weight: 900;
            color: #feca57;
            text-shadow: 0 0 30px rgba(254, 202, 87, 0.5);
            animation: countdownPulse 1s ease-in-out;
        }

        @keyframes countdownPulse {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* „Ç≤„Éº„É†ÈñãÂßãÁîªÈù¢ */
        .start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .start-content {
            text-align: center;
            color: white;
        }

        .start-content h1 {
            font-size: 36px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .mode-selection {
            display: flex;
            gap: 40px;
            margin-bottom: 25px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 25px 35px;
            background: rgba(255, 255, 255, 0.2);
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
            text-align: center;
            font-size: 16px;
        }

        .mode-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .mode-btn.selected {
            background: rgba(254, 202, 87, 0.3);
            border-color: #feca57;
            box-shadow: 0 0 30px rgba(254, 202, 87, 0.5);
        }

        .mode-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .mode-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .mode-desc {
            font-size: 12px;
            opacity: 0.8;
        }

        .player-setup-container {
            display: flex;
            gap: 50px;
            justify-content: center;
            align-items: flex-start;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .player-setup {
            flex: 1;
            max-width: 350px;
            min-width: 300px;
            text-align: center;
        }

        .character-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
            max-width: 280px;
            margin-left: auto;
            margin-right: auto;
        }

        .character-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .character-btn.selected {
            border-color: #feca57;
            box-shadow: 0 0 20px rgba(254, 202, 87, 0.5);
        }

        .name-input {
            width: 280px;
            height: 45px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 22px;
            padding: 0 20px;
            font-size: 17px;
            font-family: 'BIZ UDGothic', sans-serif;
            background: rgba(255, 255, 255, 0.9);
            outline: none;
            margin-bottom: 20px;
            text-align: center;
        }

        .name-input:focus {
            border-color: #feca57;
            box-shadow: 0 0 10px rgba(254, 202, 87, 0.3);
        }

        .rules-content {
            text-align: left;
            max-width: 500px;
            margin: 0 auto;
        }

        .rule-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .rule-icon {
            font-size: 24px;
            min-width: 40px;
        }

        .rule-text h4 {
            margin: 0 0 5px 0;
            font-size: 16px;
            color: #feca57;
        }

        .rule-text p {
            margin: 0;
            line-height: 1.4;
            font-size: 14px;
        }

        .hp-btn {
            padding: 20px 25px;
            background: rgba(255, 255, 255, 0.2);
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 18px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 140px;
            text-align: center;
            font-family: 'BIZ UDGothic', sans-serif;
            font-size: 15px;
            font-weight: 600;
        }

        .hp-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .hp-btn.selected {
            background: rgba(254, 202, 87, 0.3);
            border-color: #feca57;
            box-shadow: 0 0 25px rgba(254, 202, 87, 0.4);
        }
    </style>
</head>
<body>
    <!-- „Ç≤„Éº„É†ÈñãÂßãÁîªÈù¢ -->
    <div class="start-screen" id="startScreen">
        <div class="start-content">
            <h1>‚öîÔ∏è „Çø„Ç§„Éî„É≥„Ç∞„Éê„Éà„É´</h1>
            <p style="font-size: 16px; margin-bottom: 20px;">Â≠¶Áøí„Åó„Å™„Åå„ÇâÊ•Ω„Åó„Åè„Çø„Ç§„Éî„É≥„Ç∞ÔºÅ</p>
            
            <div class="mode-selection">
                <button class="mode-btn" id="cpuModeBtn" onclick="selectMode('cpu')">
                    <div class="mode-icon">ü§ñ</div>
                    <div class="mode-title">CPUÊà¶</div>
                    <div class="mode-desc">„Ç≥„É≥„Éî„É•„Éº„Çø„Éº„Å®ÂØæÊà¶</div>
                </button>
                <button class="mode-btn" id="pvpModeBtn" onclick="selectMode('pvp')">
                    <div class="mode-icon">üë•</div>
                    <div class="mode-title">2‰∫∫ÂØæÊà¶</div>
                    <div class="mode-desc">ÂèãÈÅî„Å®‰∏ÄÁ∑í„Å´ÂØæÊà¶</div>
                </button>
            </div>

            <div id="characterSelection" class="hidden">
                <div class="hp-selection" style="margin-bottom: 25px;">
                    <h3 style="margin-bottom: 15px; font-size: 18px; color: white;">‚ö° ÂàùÊúüHPË®≠ÂÆö</h3>
                    <div class="hp-options" style="display: flex; gap: 25px; justify-content: center; flex-wrap: wrap;">
                        <button class="hp-btn" data-hp="100" onclick="selectHP(100)">
                            <div style="font-size: 24px; margin-bottom: 8px;">üíö</div>
                            <div style="font-size: 16px; font-weight: 700;">100HP</div>
                            <div style="font-size: 13px; opacity: 0.8;">Áü≠ÊúüÊ±∫Êà¶</div>
                        </button>
                        <button class="hp-btn selected" data-hp="200" onclick="selectHP(200)">
                            <div style="font-size: 24px; margin-bottom: 8px;">üíõ</div>
                            <div style="font-size: 16px; font-weight: 700;">200HP</div>
                            <div style="font-size: 13px; opacity: 0.8;">Ê®ôÊ∫ñ</div>
                        </button>
                        <button class="hp-btn" data-hp="300" onclick="selectHP(300)">
                            <div style="font-size: 24px; margin-bottom: 8px;">‚ù§Ô∏è</div>
                            <div style="font-size: 16px; font-weight: 700;">300HP</div>
                            <div style="font-size: 13px; opacity: 0.8;">Èï∑ÊúüÊà¶</div>
                        </button>
                    </div>
                </div>

                <div class="player-setup-container">
                    <div id="player1Setup" class="player-setup">
                        <h3 style="margin-bottom: 15px; font-size: 18px;">„Éó„É¨„Ç§„É§„Éº1„ÅÆË®≠ÂÆö</h3>
                        <input type="text" id="player1NameInput" class="name-input" value="„Éó„É¨„Ç§„É§„Éº1" placeholder="ÂêçÂâç„ÇíÂÖ•Âäõ">
                        <div class="character-selection">
                            <div class="character-btn fire" data-attr="fire" data-player="1" onclick="selectCharacter('fire', 1)">üî•</div>
                            <div class="character-btn water" data-attr="water" data-player="1" onclick="selectCharacter('water', 1)">üíß</div>
                            <div class="character-btn thunder" data-attr="thunder" data-player="1" onclick="selectCharacter('thunder', 1)">‚ö°</div>
                            <div class="character-btn wind" data-attr="wind" data-player="1" onclick="selectCharacter('wind', 1)">üå™Ô∏è</div>
                            <div class="character-btn earth" data-attr="earth" data-player="1" onclick="selectCharacter('earth', 1)">üå±</div>
                            <div class="character-btn light" data-attr="light" data-player="1" onclick="selectCharacter('light', 1)">‚ú®</div>
                        </div>
                    </div>
                    
                    <div id="player2Setup" class="player-setup hidden">
                        <h3 style="margin-bottom: 15px; font-size: 18px;">„Éó„É¨„Ç§„É§„Éº2„ÅÆË®≠ÂÆö</h3>
                        <input type="text" id="player2NameInput" class="name-input" value="„Éó„É¨„Ç§„É§„Éº2" placeholder="ÂêçÂâç„ÇíÂÖ•Âäõ">
                        <div class="character-selection">
                            <div class="character-btn fire" data-attr="fire" data-player="2" onclick="selectCharacter('fire', 2)">üî•</div>
                            <div class="character-btn water" data-attr="water" data-player="2" onclick="selectCharacter('water', 2)">üíß</div>
                            <div class="character-btn thunder" data-attr="thunder" data-player="2" onclick="selectCharacter('thunder', 2)">‚ö°</div>
                            <div class="character-btn wind" data-attr="wind" data-player="2" onclick="selectCharacter('wind', 2)">üå™Ô∏è</div>
                            <div class="character-btn earth" data-attr="earth" data-player="2" onclick="selectCharacter('earth', 2)">üå±</div>
                            <div class="character-btn light" data-attr="light" data-player="2" onclick="selectCharacter('light', 2)">‚ú®</div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="nextBtn" onclick="showGameRules()" style="margin-top: 15px;" disabled>„Ç≤„Éº„É†„ÅÆÈÅä„Å≥Êñπ„ÇíË¶ã„Çã</button>
            </div>
            
            <div id="gameRules" class="hidden">
                <h2 style="margin-bottom: 20px; font-size: 22px;">üìñ „Ç≤„Éº„É†„ÅÆÈÅä„Å≥Êñπ</h2>
                <div class="rules-content">
                    <div class="rule-item">
                        <div class="rule-icon">‚öîÔ∏è</div>
                        <div class="rule-text">
                            <h4>Âü∫Êú¨„É´„Éº„É´</h4>
                            <p>Ë®≠ÂÆö„Åó„ÅüHP„Åß„Çπ„Çø„Éº„Éà„ÄÇÁõ∏Êâã„ÅÆHP„Çí0„Å´„Åó„Åü„ÇâÂãùÂà©ÔºÅ</p>
                        </div>
                    </div>
                    <div class="rule-item">
                        <div class="rule-icon">üìù</div>
                        <div class="rule-text">
                            <h4>„Çø„Ç§„Éî„É≥„Ç∞</h4>
                            <p>ÊâãÊú≠„Åã„Çâ1ÊûöÈÅ∏„Çì„Åß15Áßí‰ª•ÂÜÖ„Å´„É≠„Éº„ÉûÂ≠ó„ÅßÂÖ•Âäõ</p>
                        </div>
                    </div>
                    <div class="rule-item">
                        <div class="rule-icon">üí•</div>
                        <div class="rule-text">
                            <h4>„ÉÄ„É°„Éº„Ç∏</h4>
                            <p>ÊàêÂäüÔºöÊñáÂ≠óÊï∞√óÊÆã„ÇäÊôÇÈñì„Åß„ÉÄ„É°„Éº„Ç∏<br>Â§±ÊïóÔºöÊñáÂ≠óÊï∞√ó10„ÅÆËá™ÂÇ∑„ÉÄ„É°„Éº„Ç∏<br>Êâì„Å°ÈñìÈÅï„ÅàÔºö3Áßí„Éö„Éä„É´„ÉÜ„Ç£</p>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="startGame()" style="margin-top: 20px; font-size: 16px; padding: 12px 30px;">üéÆ „Ç≤„Éº„É†ÈñãÂßãÔºÅ</button>
            </div>

            <div style="margin-top: 20px; font-size: 12px; opacity: 0.8;">
                <p>üì± iPadÊ®™Âêë„Åç„ÅßÊúÄÈÅ©Âåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô</p>
                <p>‚å®Ô∏è „É≠„Éº„ÉûÂ≠ó„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàÂÖ®Ëßí„Åß„ÇÇOKÔºâ</p>
            </div>
        </div>
    </div>

    <!-- „É°„Ç§„É≥„Ç≤„Éº„É†ÁîªÈù¢ -->
    <div class="game-container hidden" id="gameContainer">
        <!-- „Éà„ÉÉ„Éó„Éê„Éº -->
        <div class="top-bar">
            <div class="player-info">
                <div class="avatar" id="player1Avatar">üî•</div>
                <div class="player-stats">
                    <div class="player-name" id="player1Name">„Éó„É¨„Ç§„É§„Éº1</div>
                    <div class="hp-bar-container">
                        <div class="hp-bar" id="player1HpBar" style="width: 100%;"></div>
                        <div class="hp-text" id="player1HpText">300/300</div>
                    </div>
                </div>
            </div>

            <div class="center-info">
                <div class="turn-display" id="turnDisplay">„Éó„É¨„Ç§„É§„Éº1„ÅÆ„Çø„Éº„É≥</div>
                <div class="phase-display" id="phaseDisplay">„Ç´„Éº„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                <div class="timer-ring" id="timerRing">15</div>
            </div>

            <div class="player-info">
                <div class="avatar" id="player2Avatar">ü§ñ</div>
                <div class="player-stats" style="text-align: right;">
                    <div class="player-name" id="player2Name">CPU</div>
                    <div class="hp-bar-container">
                        <div class="hp-bar" id="player2HpBar" style="width: 100%;"></div>
                        <div class="hp-text" id="player2HpText">300/300</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- „Ç´„Éº„Éâ„Ç®„É™„Ç¢ -->
        <div class="card-area">
            <!-- „É°„Ç§„É≥„Ç´„Éº„ÉâÈÅ∏Êäû„Ç®„É™„Ç¢ -->
            <div class="main-cards-area">
                <div class="cards-container" id="cardsContainer">
                    <!-- „Ç´„Éº„Éâ„ÅØÂãïÁöÑÁîüÊàê -->
                </div>
            </div>
        </div>

        <!-- „Çø„Ç§„Éî„É≥„Ç∞„Ç¨„Ç§„ÉâË°®Á§∫„Ç®„É™„Ç¢ -->
        <div class="typing-display">
            <div id="typingGuide" class="typing-guide">
                <div id="typingGuideJP" class="jp jp-progress"></div>
                <div id="typingGuideSub" class="sub"></div>
            </div>
            <div id="romajiGuide" class="romaji-guide"></div>
            <div class="progress-bar" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="keyboard-hint">
                <p>‚å®Ô∏è „Ç≠„Éº„Éú„Éº„Éâ„ÅßÁõ¥Êé•ÂÖ•Âäõ | ESC„Ç≠„Éº„Åß„ÇÆ„Éñ„Ç¢„ÉÉ„Éó</p>
            </div>
        </div>

        <!-- „Ç≥„É≥„Éà„É≠„Éº„É´ -->
        <div class="controls">
            <button class="control-btn" onclick="showHelp()" title="„Éò„É´„Éó">‚ùì</button>
            <button class="control-btn" onclick="toggleSound()" title="Èü≥Èáè" id="soundBtn">üîä</button>
            <button class="control-btn" onclick="pauseGame()" title="‰∏ÄÊôÇÂÅúÊ≠¢" id="pauseBtn">‚è∏Ô∏è</button>
            <button class="control-btn" onclick="backToMenu()" title="„É°„Éã„É•„Éº„Å´Êàª„Çã">üè†</button>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´ -->
    <div class="modal" id="modal">
        <div class="modal-content" id="modalContent">
            <!-- ÂãïÁöÑ„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
        </div>
    </div>

    <script>
        // Â§âÊèõ‰∏≠„Éï„É©„Ç∞ÔºàIMEÔºâ
        let isComposing = false;

        // ÊîπËâØ„Åï„Çå„ÅüÊó•Êú¨Ë™ûÂá¶ÁêÜÈñ¢Êï∞
        function toHiragana(s){
            if(!s) return '';
            let t = s.normalize('NFKC');
            // „Ç´„Çø„Ç´„Éä‚Üí„Å≤„Çâ„Åå„Å™
            t = t.replace(/[\u30A1-\u30FA\u30FD-\u30FF]/g, ch =>
                String.fromCharCode(ch.charCodeAt(0) - 0x60)
            );
            // Ë®òÂè∑„ÉªÁ©∫ÁôΩÈô§Âéª
            t = t.replace(/[„ÄÅ„ÄÇÔºåÔºé\s]/g,'');
            return t;
        }

        // „ÉÄ„É°„Éº„Ç∏Ë®àÁÆóÁî®ÔºöÂ∞èÊñáÂ≠ó„ÇíÂ§ßÊñáÂ≠óÂåñ„Åó„Å¶Ê¶ÇÁÆóÈï∑„Åï„Å´Ôºà„ÇÉ„ÇÖ„Çá‚Üí„ÇÑÁ≠âÔºè„Å£‚Üí„Å§Ôºâ
        function countForDamage(s){
            const h = toHiragana(s)
                .replace(/[„ÅÅ„Ç°]/g,'„ÅÇ').replace(/[„ÅÉ„Ç£]/g,'„ÅÑ').replace(/[„ÅÖ„Ç•]/g,'„ÅÜ')
                .replace(/[„Åá„Çß]/g,'„Åà').replace(/[„Åâ„Ç©]/g,'„Åä')
                .replace(/„ÇÉ/g,'„ÇÑ').replace(/„ÇÖ/g,'„ÇÜ').replace(/„Çá/g,'„Çà')
                .replace(/„Å£/g,'„Å§').replace(/„Éº/g,''); // Èï∑Èü≥„ÅØÁÑ°Ë¶ñ
            return h.length;
        }

        // Ê≠£Ë¶èÂåñÂæå„ÅÆÊñáÂ≠óÊï∞„Çí‰Ωø„ÅÜÔºà„ÉÄ„É°„Éº„Ç∏/Ëá™ÂÇ∑/Áµ±Ë®à„ÅØ„Åì„Çå„ÅßÁµ±‰∏ÄÔºâ
        const countChars = (s) => countForDamage(s);

        /* =========================================================
           „É≠„Éº„ÉûÂ≠óÔºöË§áÊï∞Ë°®Ë®òÂØæÂøúÔºà‰øÉÈü≥/ÊãóÈü≥/„Çì/‰ª£ÊõøË°®Ë®òÔºâ
        ========================================================= */
        const BASE = {
            '„ÅÇ':['a'],'„ÅÑ':['i'],'„ÅÜ':['u'],'„Åà':['e'],'„Åä':['o'],
            '„Åã':['ka'],'„Åç':['ki'],'„Åè':['ku'],'„Åë':['ke'],'„Åì':['ko'],
            '„Åå':['ga'],'„Åé':['gi'],'„Åê':['gu'],'„Åí':['ge'],'„Åî':['go'],
            '„Åï':['sa'],'„Åó':['shi','si'],'„Åô':['su'],'„Åõ':['se'],'„Åù':['so'],
            '„Åñ':['za'],'„Åò':['ji','zi'],'„Åö':['zu'],'„Åú':['ze'],'„Åû':['zo'],
            '„Åü':['ta'],'„Å°':['chi','ti'],'„Å§':['tsu','tu'],'„Å¶':['te'],'„Å®':['to'],
            '„Å†':['da'],'„Å¢':['ji','di'],'„Å•':['zu','du'],'„Åß':['de'],'„Å©':['do'],
            '„Å™':['na'],'„Å´':['ni'],'„Å¨':['nu'],'„Å≠':['ne'],'„ÅÆ':['no'],
            '„ÅØ':['ha'],'„Å≤':['hi'],'„Åµ':['fu','hu'],'„Å∏':['he'],'„Åª':['ho'],
            '„Å∞':['ba'],'„Å≥':['bi'],'„Å∂':['bu'],'„Åπ':['be'],'„Åº':['bo'],
            '„Å±':['pa'],'„Å¥':['pi'],'„Å∑':['pu'],'„Å∫':['pe'],'„ÅΩ':['po'],
            '„Åæ':['ma'],'„Åø':['mi'],'„ÇÄ':['mu'],'„ÇÅ':['me'],'„ÇÇ':['mo'],
            '„ÇÑ':['ya'],'„ÇÜ':['yu'],'„Çà':['yo'],
            '„Çâ':['ra'],'„Çä':['ri'],'„Çã':['ru'],'„Çå':['re'],'„Çç':['ro'],
            '„Çè':['wa'],'„Çê':['wi'],'„Çë':['we'],'„Çí':['wo','o'],
            '„Çì':['n','nn'],
            '„ÅÅ':['xa','la','a'],'„ÅÉ':['xi','li','i'],'„ÅÖ':['xu','lu','u'],'„Åá':['xe','le','e'],'„Åâ':['xo','lo','o'],
            '„Å£':['*sokuon*'], // ÁâπÊÆä
            '„Éº':['*choon*']   // Èï∑Èü≥Ôºà„Åì„Åì„Åß„ÅØÁÑ°Ë¶ñ or Áõ¥ÂâçÊØçÈü≥Ôºâ
        };

        // ÊãóÈü≥
        const YOON = {
            '„Åç„ÇÉ':['kya','kixya','kya'], '„Åç„ÇÖ':['kyu','kixyu'], '„Åç„Çá':['kyo','kixyo'],
            '„Åé„ÇÉ':['gya','gixya'], '„Åé„ÇÖ':['gyu','gixyu'], '„Åé„Çá':['gyo','gixyo'],
            '„Åó„ÇÉ':['sha','sya'], '„Åó„ÇÖ':['shu','syu'], '„Åó„Çá':['sho','syo'],
            '„Åò„ÇÉ':['ja','jya','zya'], '„Åò„ÇÖ':['ju','jyu','zyu'], '„Åò„Çá':['jo','jyo','zyo'],
            '„Å°„ÇÉ':['cha','tya','cya'], '„Å°„ÇÖ':['chu','tyu','cyu'], '„Å°„Çá':['cho','tyo','cyo'],
            '„Å´„ÇÉ':['nya'], '„Å´„ÇÖ':['nyu'], '„Å´„Çá':['nyo'],
            '„Å≤„ÇÉ':['hya'], '„Å≤„ÇÖ':['hyu'], '„Å≤„Çá':['hyo'],
            '„Å≥„ÇÉ':['bya'], '„Å≥„ÇÖ':['byu'], '„Å≥„Çá':['byo'],
            '„Å¥„ÇÉ':['pya'], '„Å¥„ÇÖ':['pyu'], '„Å¥„Çá':['pyo'],
            '„Åø„ÇÉ':['mya'], '„Åø„ÇÖ':['myu'], '„Åø„Çá':['myo'],
            '„Çä„ÇÉ':['rya'], '„Çä„ÇÖ':['ryu'], '„Çä„Çá':['ryo'],
            '„Çî„ÅÅ':['va'],'„Çî„ÅÉ':['vi'],'„Çî„Åá':['ve'],'„Çî„Åâ':['vo'],'„Çî„ÇÖ':['vyu']
        };

        // ÊñáÂ≠óÂàó‚Üí„Éà„Éº„ÇØ„É≥ÔºàÊãóÈü≥„Çí1„Éà„Éº„ÇØ„É≥ÂåñÔºâ
        function tokenize(h){
            const arr=[...h]; const out=[];
            for(let i=0;i<arr.length;i++){
                const ch=arr[i], nx=arr[i+1];
                if(nx && ['„ÇÉ','„ÇÖ','„Çá'].includes(nx) && YOON[ch+nx]){
                    out.push(ch+nx); i++;
                }else{
                    out.push(ch);
                }
            }
            return out;
        }

        // Ê¨°„Éà„Éº„ÇØ„É≥„ÅÆÂÖàÈ†≠Â≠êÈü≥/ÊØçÈü≥„ÇíÂæó„ÇãÔºà„Çì„ÅÆÊâ±„ÅÑÂà§ÂÆöÁî®Ôºâ
        function initialsOfToken(tok){
            let opts = romajiOfToken(tok);
            return new Set(opts.map(o=>o[0]||''));
        }

        // Âçò‰∏Ä„Éà„Éº„ÇØ„É≥„ÅÆ„É≠„Éº„ÉûÂ≠óÂÄôË£ú„ÇíÂèñÂæó
        function romajiOfToken(tok){
            if(YOON[tok]) return YOON[tok].slice();
            if(tok==='„Éº') return ['']; // Èï∑Èü≥„ÅØ„Åì„Åì„Åß„ÅØÁÑ°Ë¶ñ
            if(BASE[tok]) return BASE[tok].slice();
            return [tok]; // Êú™Áü•„ÅØ„Åù„ÅÆ„Åæ„Åæ
        }

        // ÂÖ®ÂÄôË£úÂàóÊåôÔºàÂàÜÂ≤ê„ÅØÂ§ö„ÅÑ„ÅåÁèæÂÆüÁöÑ„Å™Èï∑„Åï„Å™„ÇâOKÔºâ
        function buildRomajiOptions(h){
            const tokens = tokenize(h);
            const results=[];
            function dfs(i, acc){
                if(i>=tokens.length){ results.push(acc); return; }
                const t=tokens[i];

                if(t==='„Å£'){ // ‰øÉÈü≥
                    if(i+1<tokens.length){
                        const nextOpts = romajiOfToken(tokens[i+1]);
                        // Ê¨°„ÅÆÈ†≠Â≠êÈü≥„ÇíÈáç„Å≠„ÇãÔºàch „ÅÆ„Å®„Åç„ÅØ tch / cch ‰∏°ÊñπË®±ÂÆπÔºâ
                        nextOpts.forEach(no=>{
                            if(!no) return;
                            const head = no.startsWith('ch') ? ['t','c'] : [no[0]];
                            head.forEach(hc=>{
                                if(/[a-z]/.test(hc)) dfs(i+1, acc + hc); // ‰øÉÈü≥„ÇíÂâçÁΩÆ
                            });
                        });
                        return; // ‰øÉÈü≥Ëá™‰Ωì„ÅØÊñáÂ≠ó„ÇíÊ∂àË≤ª„Åó„ÄÅÊ¨°„Å∏
                    }else{
                        // Ë™ûÊú´„ÅÆ„Å£ „ÅØÁÑ°Ë¶ñ
                        dfs(i+1, acc);
                        return;
                    }
                }

                if(t==='„Çì'){
                    // Ê¨°„ÅÆÈ†≠„ÅåÊØçÈü≥/ y „Å™„Çâ nn or n'
                    const nextHead = (i+1<tokens.length)? Array.from(initialsOfToken(tokens[i+1])) : [];
                    const risky = nextHead.some(c=>['a','i','u','e','o','y'].includes(c));
                    const cand = risky ? ["nn","n'"] : ["n","nn"];
                    cand.forEach(r=>dfs(i+1, acc+r));
                    return;
                }

                // ÈÄöÂ∏∏
                const opts = romajiOfToken(t);
                opts.forEach(o=>dfs(i+1, acc+o));
            }
            dfs(0,'');
            // ÈáçË§áÈô§Âéª
            return Array.from(new Set(results));
        }

        // „Å≤„Çâ„Åå„Å™ÊñáÂ≠óÂàó„Çí„É≠„Éº„ÉûÂ≠ó„Å´Â§âÊèõÔºàÊúÄÁü≠ÂÄôË£ú„Çí‰ΩøÁî®Ôºâ
        function hiraganaToRomaji(hiragana) {
            const options = buildRomajiOptions(hiragana);
            // ÊúÄÁü≠„ÅÆ„ÇÇ„ÅÆ„ÇíÈÅ∏ÊäûÔºàÈÄöÂ∏∏„ÅØÊúÄ„ÇÇ‰∏ÄËà¨ÁöÑÔºâ
            return options.reduce((shortest, current) => 
                current.length < shortest.length ? current : shortest, options[0] || '');
        }

        // „Ç¨„Ç§„ÉâÂàùÊúüÂåñÔºö„Ç´„Éº„ÉâÈÅ∏ÊäûÁõ¥Âæå„Å´Âëº„Å∂ÔºàË§áÊï∞ÂÄôË£úÂØæÂøúÔºâ
        function setupTypingGuide(targetText) {
            const jpEl = document.getElementById('typingGuideJP');
            const subEl = document.getElementById('typingGuideSub');
            const romajiEl = document.getElementById('romajiGuide');
            const norm = toHiragana(targetText);

            // ‰∏äÊÆµ„ÅØ"ÂéüÊñá„Åù„ÅÆ„Åæ„Åæ"„ÇíË°®Á§∫ÔºàËâ≤„ÅØÈù¢„ÅßÈÄ≤ÊçóÔºâ
            jpEl.style.setProperty('--fill', '0%');
            jpEl.textContent = targetText;

            // ‰∏ãÊÆµ„ÅØÂà§ÂÆöÁî®„ÅÆ"„Å≤„Çâ„Åå„Å™"„Çí1ÊñáÂ≠ó„Åö„Å§„Çπ„Éë„É≥Âåñ„Åó„Å¶ÁÇπÁÅØ
            subEl.innerHTML = '';
            [...norm].forEach((ch, i) => {
                const span = document.createElement('span');
                span.className = 'char pending';
                span.dataset.index = i;
                span.textContent = ch;
                subEl.appendChild(span);
            });

            // Ë§áÊï∞„ÅÆ„É≠„Éº„ÉûÂ≠óÂÄôË£ú„ÇíÂèñÂæó
            const romajiOptions = buildRomajiOptions(norm);
            typingState.targetOptions = romajiOptions;
            typingState.currentInputs = romajiOptions.map(() => ({
                position: 0,
                typed: '',
                completed: false
            }));
            typingState.typedKeys = '';

            // ÊúÄÁü≠ÂÄôË£ú„Çí„Ç¨„Ç§„Éâ„Å®„Åó„Å¶Ë°®Á§∫
            const displayRomaji = romajiOptions.reduce((shortest, current) => 
                current.length < shortest.length ? current : shortest, romajiOptions[0] || '');

            romajiEl.innerHTML = '';
            [...displayRomaji].forEach((char, i) => {
                const span = document.createElement('span');
                span.className = 'romaji-char';
                span.dataset.index = i;
                span.textContent = char;
                romajiEl.appendChild(span);
            });

            // ÊúÄÂàù„ÅÆÊñáÂ≠ó„Çí„Éè„Ç§„É©„Ç§„Éà
            if (displayRomaji.length > 0) {
                romajiEl.children[0].classList.add('current');
            }
        }

        // ÈÄ≤ÊçóÊõ¥Êñ∞ÔºöË§áÊï∞ÂÄôË£úÂØæÂøú
        function updateTypingGuideProgress() {
            if (!gameState.selectedCard) return;
            const jpEl  = document.getElementById('typingGuideJP');
            const subEl = document.getElementById('typingGuideSub');

            const target = gameState.selectedCard.text;
            const normTarget = toHiragana(target);
            
            // ÊúÄ„ÇÇÈÄ≤„Çì„Åß„ÅÑ„ÇãÂÄôË£ú„ÅÆÈÄ≤Êçó„Çí‰ΩøÁî®
            let maxProgress = 0;
            let maxPosition = 0;
            
            typingState.currentInputs.forEach((input, index) => {
                const targetLength = typingState.targetOptions[index].length;
                if (targetLength > 0) {
                    const progress = input.position / targetLength;
                    if (progress > maxProgress) {
                        maxProgress = progress;
                        maxPosition = input.position;
                    }
                }
            });
            
            const hiraganaMatched = Math.floor(maxProgress * normTarget.length);
            const fill = Math.max(0, Math.min(100, maxProgress * 100));
            jpEl.style.setProperty('--fill', `${fill}%`);

            // „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„ÅØÈùûË°®Á§∫

            // ‰∏ãÊÆµ„Çí1ÊñáÂ≠ó„Åö„Å§ÁÇπÁÅØ
            const chars = subEl.querySelectorAll('.char');
            chars.forEach((el, i) => {
                el.classList.remove('matched','current','pending');
                if (i < hiraganaMatched) el.classList.add('matched');
                else if (i === hiraganaMatched && maxProgress < 1) el.classList.add('current');
                else el.classList.add('pending');
            });
        }

        // „Ç≤„Éº„É†Áä∂ÊÖã
        let gameState = {
            mode: null, // 'cpu' or 'pvp'
            maxHP: 200, // „Éá„Éï„Ç©„É´„ÉàHP
            players: [
                { name: '„Éó„É¨„Ç§„É§„Éº1', hp: 200, maxHp: 200, avatar: 'üî•', attribute: 'fire' },
                { name: 'CPU', hp: 200, maxHp: 200, avatar: 'ü§ñ', attribute: 'water' }
            ],
            currentPlayer: 0,
            selectedCard: null,
            hands: [[], []],
            deck: [],
            discard: [],
            timer: 15,
            timerInterval: null,
            gamePhase: 'cardSelect', // 'cardSelect', 'typing', 'result'
            soundEnabled: true,
            isPaused: false,
            stats: {
                totalChars: 0,
                correctChars: 0,
                totalTime: 0,
                combo: 0,
                maxCombo: 0
            }
        };

        // „Ç´„Éº„Éâ„Éó„Éº„É´ÔºàÂÆüÁî®ÁöÑ„Å™„Çø„Ç§„Éî„É≥„Ç∞Á∑¥ÁøíÁî®Ôºâ
        const CARD_POOL = [
            // 2ÊñáÂ≠ó„ÅÆÂçòË™ûÔºàÂàùÁ¥öÔºâ
            { text: '„Å≠„Åì', difficulty: 1, category: '„Å©„ÅÜ„Å∂„Å§' },
            { text: '„ÅÑ„Å¨', difficulty: 1, category: '„Å©„ÅÜ„Å∂„Å§' },
            { text: '„Åô„Åó', difficulty: 1, category: '„Åü„Åπ„ÇÇ„ÅÆ' },
            { text: '„Åù„Çâ', difficulty: 1, category: '„Åó„Åú„Çì' },
            { text: '„ÇÑ„Åæ', difficulty: 1, category: '„Åó„Åú„Çì' },
            { text: '„Åã„Çè', difficulty: 1, category: '„Åó„Åú„Çì' },
            { text: '„ÅØ„Å™', difficulty: 1, category: '„Åó„Åú„Çì' },
            { text: '„Åø„Åö', difficulty: 1, category: '„Åó„Åú„Çì' },
            { text: '„ÇÜ„Åç', difficulty: 1, category: '„Åó„Åú„Çì' },
            { text: '„Å§„Åç', difficulty: 1, category: '„Åó„Åú„Çì' },
            { text: '„Åã„Åï', difficulty: 1, category: '„ÇÇ„ÅÆ' },
            { text: '„ÅÜ„Åø', difficulty: 1, category: '„Åó„Åú„Çì' },
            { text: '„ÅÇ„ÇÅ', difficulty: 1, category: '„Åó„Åú„Çì' },
            { text: '„Åª„Åó', difficulty: 1, category: '„Åó„Åú„Çì' },
            { text: '„Åã„Å´', difficulty: 1, category: '„Å©„ÅÜ„Å∂„Å§' },
            { text: '„Åï„Çã', difficulty: 1, category: '„Å©„ÅÜ„Å∂„Å§' },
            { text: '„ÇÇ„Çä', difficulty: 1, category: '„Åó„Åú„Çì' },
            { text: '„Åè„ÇÇ', difficulty: 1, category: '„Åó„Åú„Çì' },
            { text: '„Åø„Å°', difficulty: 1, category: '„ÇÇ„ÅÆ' },
            { text: '„Åã„Åú', difficulty: 1, category: '„Åó„Åú„Çì' },
            
            // 3ÊñáÂ≠ó„ÅÆÂçòË™ûÔºà‰∏≠Á¥öÔºâ
            { text: '„Åü„Åæ„Åî', difficulty: 2, category: '„Åü„Åπ„ÇÇ„ÅÆ' },
            { text: '„Åè„Çã„Åæ', difficulty: 2, category: '„ÅÆ„Çä„ÇÇ„ÅÆ' },
            { text: '„Åç„Å§„Å≠', difficulty: 2, category: '„Å©„ÅÜ„Å∂„Å§' },
            { text: '„ÅÜ„Åï„Åé', difficulty: 2, category: '„Å©„ÅÜ„Å∂„Å§' },
            { text: '„Åï„Åã„Å™', difficulty: 2, category: '„Å©„ÅÜ„Å∂„Å§' },
            { text: '„Åë„ÇÄ„Åó', difficulty: 2, category: '„Å©„ÅÜ„Å∂„Å§' },
            { text: '„Åç„ÅÆ„Åì', difficulty: 2, category: '„Åó„Åú„Çì' },
            { text: '„Åì„Å©„ÇÇ', difficulty: 2, category: '„Å≤„Å®' },
            { text: '„Åø„Åã„Çì', difficulty: 2, category: '„Åü„Åπ„ÇÇ„ÅÆ' },
            { text: '„Åà„Åå„Åä', difficulty: 2, category: '„Åç„ÇÇ„Å°' },
            { text: '„Åô„Åö„ÇÅ', difficulty: 2, category: '„Å©„ÅÜ„Å∂„Å§' },
            { text: '„Çä„Çì„Åî', difficulty: 2, category: '„Åü„Åπ„ÇÇ„ÅÆ' },
            { text: '„Å®„Åë„ÅÑ', difficulty: 2, category: '„ÇÇ„ÅÆ' },
            { text: '„Åã„Å∞„Çì', difficulty: 2, category: '„ÇÇ„ÅÆ' },
            { text: '„Åä„Åµ„Çç', difficulty: 2, category: '„ÇÇ„ÅÆ' },
            { text: '„Åà„Åª„Çì', difficulty: 2, category: '„ÇÇ„ÅÆ' },
            { text: '„ÅÆ„ÅØ„Çâ', difficulty: 2, category: '„Åó„Åú„Çì' },
            { text: '„ÇÑ„Åï„ÅÑ', difficulty: 2, category: '„Åü„Åπ„ÇÇ„ÅÆ' },
            { text: '„Åß„Çì„Åç', difficulty: 2, category: '„ÇÇ„ÅÆ' }
        ];



        // ÂÖ®ËßíÊñáÂ≠ó„ÇíÂçäËßí„Å´Â§âÊèõ
        function normalizeInput(text) {
            if (!text) return '';
            
            // ÂÖ®ËßíËã±Êï∞Â≠ó„ÇíÂçäËßí„Å´
            let normalized = text.replace(/[Ôº°-Ôº∫ÔΩÅ-ÔΩöÔºê-Ôºô]/g, function(s) {
                return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
            });
            
            return normalized.toLowerCase();
        }

        // „Ç≤„Éº„É†ÂàùÊúüÂåñ
        function initGame() {
            // ÈÅ∏Êäû„Åï„Çå„ÅüHP„ÇíÈÅ©Áî®
            gameState.players.forEach(player => {
                player.hp = gameState.maxHP;
                player.maxHp = gameState.maxHP;
            });
            
            // „Éá„ÉÉ„Ç≠„Çí„Ç∑„É£„ÉÉ„Éï„É´
            gameState.deck = [...CARD_POOL].sort(() => Math.random() - 0.5);
            
            // ÂàùÊúüÊâãÊú≠„ÇíÈÖç„Çã
            for (let i = 0; i < 2; i++) {
                gameState.hands[i] = [];
                for (let j = 0; j < 5; j++) {
                    if (gameState.deck.length > 0) {
                        gameState.hands[i].push(gameState.deck.pop());
                    }
                }
            }
            
            // UIÊõ¥Êñ∞
            updateUI();
            drawCards();
            
            // ÊúÄÂàù„ÅÆ„Çø„Éº„É≥ÈñãÂßã
            startTurn();
        }

        // „É¢„Éº„ÉâÈÅ∏Êäû
        function selectMode(mode) {
            // Ââç„ÅÆÈÅ∏Êäû„ÇíËß£Èô§
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Êñ∞„Åó„ÅÑÈÅ∏Êäû
            document.getElementById(mode === 'cpu' ? 'cpuModeBtn' : 'pvpModeBtn').classList.add('selected');
            
            gameState.mode = mode;
            document.getElementById('characterSelection').classList.remove('hidden');
            
            if (mode === 'pvp') {
                document.getElementById('player2Setup').classList.remove('hidden');
                gameState.players[1].name = '„Éó„É¨„Ç§„É§„Éº2';
                gameState.players[1].avatar = 'üíß';
            } else {
                document.getElementById('player2Setup').classList.add('hidden');
            }
            
            // „Éó„É¨„Ç§„É§„Éº1„ÅÆÂêçÂâçÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„Çã
            setTimeout(() => {
                const nameInput = document.getElementById('player1NameInput');
                nameInput.focus();
                nameInput.select();
            }, 100);
            
            // ÂêçÂâçÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
            document.getElementById('player1NameInput').addEventListener('focus', function() {
                this.select();
            });
            
            if (mode === 'pvp') {
                document.getElementById('player2NameInput').addEventListener('focus', function() {
                    this.select();
                });
            }

            // „Éá„Éï„Ç©„É´„ÉàÈÅ∏ÊäûÔºàËø∑„Å£„Åü„Çâ„Åô„ÅêÈÄ≤„ÇÅ„ÇãÔºâ
            selectCharacter('fire', 1);
            if (mode === 'pvp') selectCharacter('water', 2);
            checkSetupComplete();
        }

        // HPÈÅ∏Êäû
        function selectHP(hp) {
            // Ââç„ÅÆÈÅ∏Êäû„ÇíËß£Èô§
            document.querySelectorAll('.hp-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Êñ∞„Åó„ÅÑÈÅ∏Êäû
            document.querySelector(`[data-hp="${hp}"]`).classList.add('selected');
            
            gameState.maxHP = hp;
            gameState.players.forEach(player => {
                player.hp = hp;
                player.maxHp = hp;
            });
            
            checkSetupComplete();
        }

        // „Ç≠„É£„É©„ÇØ„Çø„ÉºÈÅ∏Êäû
        function selectCharacter(attribute, player) {
            // Ë©≤ÂΩì„Éó„É¨„Ç§„É§„Éº„ÅÆÂâç„ÅÆÈÅ∏Êäû„ÇíËß£Èô§
            document.querySelectorAll(`[data-player="${player}"]`).forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Êñ∞„Åó„ÅÑÈÅ∏Êäû
            document.querySelector(`[data-attr="${attribute}"][data-player="${player}"]`).classList.add('selected');
            
            const avatars = {
                fire: 'üî•',
                water: 'üíß',
                thunder: '‚ö°',
                wind: 'üå™Ô∏è',
                earth: 'üå±',
                light: '‚ú®'
            };
            
            gameState.players[player - 1].attribute = attribute;
            gameState.players[player - 1].avatar = avatars[attribute];
            
            // ÂêçÂâç„ÇíÊõ¥Êñ∞
            const nameInput = document.getElementById(`player${player}NameInput`);
            if (nameInput) {
                gameState.players[player - 1].name = nameInput.value || `„Éó„É¨„Ç§„É§„Éº${player}`;
            }
            
            // Ê¨°„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÅÆÂêçÂâçÂÖ•Âäõ„Å´„Éï„Ç©„Éº„Ç´„ÇπÔºà2‰∫∫ÂØæÊà¶„ÅÆÂ†¥ÂêàÔºâ
            if (player === 1 && gameState.mode === 'pvp') {
                setTimeout(() => {
                    const player2Input = document.getElementById('player2NameInput');
                    player2Input.focus();
                    player2Input.select();
                }, 100);
            }
            
            checkSetupComplete();
        }
        
        // „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ
        function checkSetupComplete() {
            const player1Selected = document.querySelector('[data-player="1"].selected');
            const player2Selected = gameState.mode === 'cpu' || document.querySelector('[data-player="2"].selected');
            
            document.getElementById('nextBtn').disabled = !(player1Selected && player2Selected);
        }
        
        // „Ç≤„Éº„É†„É´„Éº„É´Ë°®Á§∫
        function showGameRules() {
            // ÂêçÂâç„ÇíÊúÄÁµÇÊõ¥Êñ∞
            gameState.players[0].name = document.getElementById('player1NameInput').value || '„Éó„É¨„Ç§„É§„Éº1';
            if (gameState.mode === 'pvp') {
                gameState.players[1].name = document.getElementById('player2NameInput').value || '„Éó„É¨„Ç§„É§„Éº2';
            }
            
            document.getElementById('characterSelection').classList.add('hidden');
            document.getElementById('gameRules').classList.remove('hidden');
        }

        // „Ç≤„Éº„É†ÈñãÂßã
        function startGame() {
            document.getElementById('startScreen').classList.add('hidden');
            
            // 2‰∫∫ÂØæÊà¶„ÅÆÂ†¥Âêà„ÅØ„É´„Éº„É¨„ÉÉ„Éà„Åß„Çø„Éº„É≥Ê±∫ÂÆö
            if (gameState.mode === 'pvp') {
                showRouletteAnimation();
            } else {
                document.getElementById('gameContainer').classList.remove('hidden');
                initGame();
            }
        }

        // „É´„Éº„É¨„ÉÉ„ÉàÊºîÂá∫Ë°®Á§∫
        function showRouletteAnimation() {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.className = 'roulette-overlay';
                
                const container = document.createElement('div');
                container.className = 'roulette-container';
                
                container.innerHTML = `
                    <div class="roulette-title">üéØ ÂÖàÊîª„ÇíÊ±∫„ÇÅ„Çà„ÅÜÔºÅ</div>
                    <div class="roulette-wheel" id="rouletteWheel">
                        <div class="roulette-pointer"></div>
                        <div class="roulette-center">üé≤</div>
                        <div class="wheel-labels">
                            <div class="wheel-label top">P1</div>
                            <div class="wheel-label bottom">P2</div>
                        </div>
                    </div>
                    <div class="player-section left">
                        <div class="player-avatar-roulette">${gameState.players[0].avatar}</div>
                        <div>
                            <div>${gameState.players[0].name}</div>
                            <div style="font-size: 14px; opacity: 0.8;">‰∏äÂçäÂàÜ</div>
                        </div>
                    </div>
                    <div class="player-section right">
                        <div class="player-avatar-roulette">${gameState.players[1].avatar}</div>
                        <div>
                            <div>${gameState.players[1].name}</div>
                            <div style="font-size: 14px; opacity: 0.8;">‰∏ãÂçäÂàÜ</div>
                        </div>
                    </div>
                    <div class="roulette-result" id="rouletteResult"></div>
                `;
                
                overlay.appendChild(container);
                document.body.appendChild(overlay);
                
                // „É´„Éº„É¨„ÉÉ„ÉàÈñãÂßã
                setTimeout(() => {
                    spinRoulette(overlay, resolve);
                }, 500);
            });
        }

        // „É´„Éº„É¨„ÉÉ„ÉàÂõûËª¢Âá¶ÁêÜ
        function spinRoulette(overlay, callback) {
            const wheel = document.getElementById('rouletteWheel');
            const resultEl = document.getElementById('rouletteResult');
            
            // „É©„É≥„ÉÄ„É†„Å™ÊúÄÁµÇËßíÂ∫¶„ÇíÊ±∫ÂÆöÔºà5ÂõûËª¢ + „É©„É≥„ÉÄ„É†Ôºâ
            const baseRotation = 1800; // 5ÂõûËª¢
            const randomRotation = Math.random() * 360;
            const finalRotation = baseRotation + randomRotation;
            
            // ÁµêÊûú„ÇíÊ±∫ÂÆöÔºà0-180Â∫¶Ôºö„Éó„É¨„Ç§„É§„Éº1„ÄÅ180-360Â∫¶Ôºö„Éó„É¨„Ç§„É§„Éº2Ôºâ
            const normalizedAngle = randomRotation;
            const winner = normalizedAngle < 180 ? 0 : 1;
            gameState.currentPlayer = winner;
            
            // CSSÂ§âÊï∞„Å´ÊúÄÁµÇËßíÂ∫¶„ÇíË®≠ÂÆö
            wheel.style.setProperty('--final-rotation', `${finalRotation}deg`);
            
            // ÂõûËª¢„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈñãÂßã
            wheel.classList.add('roulette-spinning');
            
            // ÂõûËª¢Èü≥ÔºàÁ∞°ÊòìÔºâ
            playRouletteSound();
            
            // ÁµêÊûúË°®Á§∫
            setTimeout(() => {
                const winnerName = gameState.players[winner].name;
                const winnerAvatar = gameState.players[winner].avatar;
                resultEl.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                        <div style="font-size: 32px;">${winnerAvatar}</div>
                        <div>
                            <div style="font-size: 20px; color: #feca57;">üéâ ${winnerName}„ÅÆÂÖàÊîªÔºÅ</div>
                            <div style="font-size: 14px; opacity: 0.8; margin-top: 5px;">„Ç≤„Éº„É†„ÇíÈñãÂßã„Åó„Åæ„Åô...</div>
                        </div>
                    </div>
                `;
                
                // ÂãùÂà©Èü≥
                playSound('success');
                
                // „Ç≤„Éº„É†ÈñãÂßã
                setTimeout(() => {
                    overlay.remove();
                    document.getElementById('gameContainer').classList.remove('hidden');
                    initGame();
                    callback();
                }, 2000);
            }, 3200);
        }

        // „É´„Éº„É¨„ÉÉ„ÉàÈü≥ÔºàÂõûËª¢Èü≥Ôºâ
        function playRouletteSound() {
            if (!gameState.soundEnabled) return;
            
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // ÂõûËª¢Èü≥„Çí3ÁßíÈñìÂÜçÁîü
            let frequency = 200;
            const duration = 3000;
            const startTime = audioContext.currentTime;
            
            function createTick(time, freq) {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(freq, time);
                gainNode.gain.setValueAtTime(0.05, time);
                gainNode.gain.exponentialRampToValueAtTime(0.001, time + 0.1);
                
                oscillator.start(time);
                oscillator.stop(time + 0.1);
            }
            
            // Âæê„ÄÖ„Å´ÈñìÈöî„ÇíÂ∫É„Åí„Å™„Åå„Çâ„ÉÜ„Ç£„ÉÉ„ÇØÈü≥„ÇíÁîüÊàê
            let tickInterval = 50; // ÂàùÊúüÈñìÈöîÔºàmsÔºâ
            let currentTime = startTime;
            
            while (currentTime - startTime < duration / 1000) {
                createTick(currentTime, frequency + Math.random() * 100);
                
                // ÊôÇÈñì„ÅåÁµå„Å§„Å´„Å§„Çå„Å¶ÈñìÈöî„ÇíÂ∫É„Åí„ÇãÔºàÊ∏õÈÄüÂäπÊûúÔºâ
                const progress = (currentTime - startTime) / (duration / 1000);
                tickInterval = 50 + (progress * 200); // 50ms „Åã„Çâ 250ms „Å∏
                
                currentTime += tickInterval / 1000;
            }
        }

        // UIÊõ¥Êñ∞
        function updateUI() {
            // „Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±Êõ¥Êñ∞
            for (let i = 0; i < 2; i++) {
                const player = gameState.players[i];
                document.getElementById(`player${i + 1}Name`).textContent = player.name;
                document.getElementById(`player${i + 1}Avatar`).textContent = player.avatar;
                
                const hpPercent = (player.hp / player.maxHp) * 100;
                document.getElementById(`player${i + 1}HpBar`).style.width = `${hpPercent}%`;
                document.getElementById(`player${i + 1}HpText`).textContent = `${player.hp}/${player.maxHp}`;
            }
            
            // „Çø„Éº„É≥Ë°®Á§∫
            document.getElementById('turnDisplay').textContent = 
                `${gameState.players[gameState.currentPlayer].name}„ÅÆ„Çø„Éº„É≥`;
                
            // „Éï„Çß„Éº„Ç∫Ë°®Á§∫
            updatePhaseDisplay();
        }
        
        // „Éï„Çß„Éº„Ç∫Ë°®Á§∫Êõ¥Êñ∞
        function updatePhaseDisplay() {
            const phaseDisplay = document.getElementById('phaseDisplay');
            
            switch (gameState.gamePhase) {
                case 'cardSelect':
                    phaseDisplay.textContent = '„Ç´„Éº„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                    break;
                case 'typing':
                    phaseDisplay.textContent = '„Çø„Ç§„Éî„É≥„Ç∞‰∏≠...';
                    break;
                case 'result':
                    phaseDisplay.textContent = 'ÁµêÊûúË°®Á§∫';
                    break;
                default:
                    phaseDisplay.textContent = '';
            }
        }

        // „Éó„É¨„Ç§„É§„Éº„ÅÆÊâãÊú≠Ë°®Á§∫ÔºàÂ∑¶Âè≥„Å´ÈÖçÁΩÆÔºâ
        function drawPlayerHand() {
            // Êó¢Â≠ò„ÅÆÊâãÊú≠„Ç≥„É≥„ÉÜ„Éä„ÇíÂâäÈô§
            document.querySelectorAll('.player-hand').forEach(el => el.remove());
            
            // Â∑¶ÂÅ¥Ôºà„Éó„É¨„Ç§„É§„Éº1„ÅÆÊâãÊú≠Ôºâ
            const leftHand = document.createElement('div');
            leftHand.className = 'player-hand left';
            leftHand.id = 'leftPlayerHand';
            
            // Âè≥ÂÅ¥Ôºà„Éó„É¨„Ç§„É§„Éº2„ÅÆÊâãÊú≠Ôºâ
            const rightHand = document.createElement('div');
            rightHand.className = 'player-hand right';
            rightHand.id = 'rightPlayerHand';
            
            document.querySelector('.card-area').appendChild(leftHand);
            document.querySelector('.card-area').appendChild(rightHand);
            
            // ‰∏°Êñπ„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÅÆÊâãÊú≠„ÇíË°®Á§∫
            [0, 1].forEach(playerIndex => {
                const hand = gameState.hands[playerIndex];
                const container = playerIndex === 0 ? leftHand : rightHand;
                
                // ÊâãÊú≠„Åå6ÊûöÊú™Ê∫Ä„Å™„Çâ1ÊûöÂºï„Åè
                if (gameState.deck.length > 0 && hand.length < 6) {
                    hand.push(gameState.deck.pop());
                }
                
                hand.forEach((card, index) => {
                    const handCard = document.createElement('div');
                    handCard.className = 'hand-card';
                    
                    // ÁèæÂú®„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÅÆÊâãÊú≠„ÅØÂ∞ë„ÅóÊòé„Çã„ÅèË°®Á§∫
                    if (playerIndex === gameState.currentPlayer) {
                        handCard.style.opacity = '1';
                        handCard.style.border = '2px solid rgba(254, 202, 87, 0.5)';
                    }
                    
                    handCard.innerHTML = `
                        <div style="font-weight: 700; font-size: 12px;">${card.text}</div>
                        <div style="font-size: 9px; opacity: 0.8;">${'‚òÖ'.repeat(card.difficulty)}</div>
                    `;
                    container.appendChild(handCard);
                });
            });
        }

        // „Ç´„Éº„ÉâÊèèÁîªÔºà„É°„Ç§„É≥ÈÅ∏Êäû„Ç®„É™„Ç¢Ôºâ
        function drawCards() {
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';
            
            const currentHand = gameState.hands[gameState.currentPlayer];
            
            // ÊâãÊú≠„Åå6ÊûöÊú™Ê∫Ä„Å™„Çâ1ÊûöÂºï„Åè
            if (gameState.deck.length > 0 && currentHand.length < 6) {
                currentHand.push(gameState.deck.pop());
            }
            
            // „Ç´„Éº„Éâ„Çí3Êûö„Åö„Å§Ë°®Á§∫ÔºàÊúÄÂ§ß6ÊûöÔºâ
            const displayCards = currentHand.slice(0, 6);
            
            displayCards.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = 'card';
                cardElement.onclick = () => selectCard(index);
                
                const stars = '‚òÖ'.repeat(card.difficulty);
                cardElement.innerHTML = `
                    <div class="card-text">${card.text}</div>
                    <div class="card-difficulty">${stars} ${card.category}</div>
                `;
                
                container.appendChild(cardElement);
            });
            
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            setTimeout(() => {
                container.classList.add('active');
            }, 100);
        }

        // „Ç´„Éº„ÉâÈÅ∏Êäû
        function selectCard(index) {
            if (gameState.gamePhase !== 'cardSelect') return;
            
            // Ââç„ÅÆÈÅ∏Êäû„ÇíËß£Èô§
            document.querySelectorAll('.card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Êñ∞„Åó„ÅÑÈÅ∏Êäû
            document.querySelectorAll('.card')[index].classList.add('selected');
            gameState.selectedCard = gameState.hands[gameState.currentPlayer][index];
            
            // „Çø„Ç§„Éî„É≥„Ç∞„Ç¨„Ç§„Éâ„ÇíË®≠ÂÆö
            setupTypingGuide(gameState.selectedCard.text);
            
            // ÂÖ•Âäõ„Éï„Çß„Éº„Ç∫„Å´ÁßªË°å
            startTypingPhase();
        }

        // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Ë°®Á§∫
        function showCountdown() {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.className = 'countdown-overlay';
                
                const numberEl = document.createElement('div');
                numberEl.className = 'countdown-number';
                overlay.appendChild(numberEl);
                
                document.body.appendChild(overlay);
                
                // Ready ‚Üí Go!!! „ÅÆÈ†ÜÁï™„ÅßË°®Á§∫
                numberEl.textContent = 'Ready';
                
                setTimeout(() => {
                    numberEl.textContent = 'Go!!!';
                    setTimeout(() => {
                        overlay.remove();
                        resolve();
                    }, 800);
                }, 1200);
            });
        }

        // „Çø„Ç§„Éî„É≥„Ç∞„Éï„Çß„Éº„Ç∫ÈñãÂßã
        async function startTypingPhase() {
            gameState.gamePhase = 'typing';
            gameState.timer = 15;
            
            // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Ë°®Á§∫
            await showCountdown();
            
            // „Ç≠„Éº„Éú„Éº„Éâ„Ç§„Éô„É≥„Éà„ÇíÊúâÂäπÂåñ
            document.addEventListener('keydown', handleKeyPress);
            
            // IMEÂÖ•Âäõ„Ç§„Éô„É≥„Éà„ÇíËøΩÂä†
            document.addEventListener('compositionstart', () => {
                isComposing = true;
            });
            
            document.addEventListener('compositionend', () => {
                isComposing = false;
            });
            
            // „Çø„Ç§„Éû„ÉºÈñãÂßã
            startTimer();
        }

        // „Çø„Ç§„Éû„ÉºÈñãÂßã
        function startTimer() {
            clearInterval(gameState.timerInterval);
            gameState.timerInterval = setInterval(() => {
                if (gameState.isPaused) return;

                gameState.timer--;
                
                const timerRing = document.getElementById('timerRing');
                timerRing.textContent = gameState.timer;

                const progress = (gameState.timer / 15) * 360;
                timerRing.style.background =
                    `conic-gradient(#feca57 ${progress}deg, rgba(255,255,255,0.2) ${progress}deg)`;

                if (gameState.timer <= 0) {
                    timeUp();
                }
            }, 1000);
        }

        // Ë§áÊï∞ÂÄôË£úÂØæÂøú„ÅÆ„Çø„Ç§„Éî„É≥„Ç∞Áä∂ÊÖã
        let typingState = {
            targetOptions: [], // Ë§áÊï∞„ÅÆ„É≠„Éº„ÉûÂ≠óÂÄôË£ú
            currentInputs: [], // ÂêÑÂÄôË£ú„Åß„ÅÆÁèæÂú®„ÅÆÂÖ•ÂäõÁä∂Ê≥Å
            typedKeys: ''
        };

        // „Ç≠„Éº„Éú„Éº„ÉâÂÖ•ÂäõÂá¶ÁêÜÔºàË§áÊï∞ÂÄôË£úÂØæÂøúÔºâ
        function handleKeyPress(event) {
            if (gameState.gamePhase !== 'typing' || gameState.isPaused) return;
            
            // IMEÂÖ•Âäõ‰∏≠„ÅØÂá¶ÁêÜ„Åó„Å™„ÅÑ
            if (isComposing) return;
            
            // ÂÖ®ËßíÊñáÂ≠ó„ÇíÂçäËßí„Å´Â§âÊèõ
            const key = normalizeInput(event.key);
            
            // ÁâπÊÆä„Ç≠„Éº„ÅÆÂá¶ÁêÜ
            if (key === 'enter') {
                event.preventDefault();
                // „ÅÑ„Åö„Çå„Åã„ÅÆÂÄôË£ú„ÅåÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Çå„Å∞ÈÄÅ‰ø°
                if (typingState.currentInputs.some(input => input.completed)) {
                    submitAnswer();
                }
                return;
            }
            
            if (key === 'escape') {
                event.preventDefault();
                giveUp();
                return;
            }
            
            // „Ç¢„É´„Éï„Ç°„Éô„ÉÉ„Éà„ÅÆ„ÅøÂèó„Åë‰ªò„ÅëÔºàÂÖ®Ëßí„ÇÇÂØæÂøúÔºâ
            if (!/^[a-z]$/.test(key)) return;
            
            event.preventDefault();
            
            // ÂÖ®ÂÄôË£ú„Å´ÂØæ„Åó„Å¶„Ç≠„ÉºÂÖ•Âäõ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            let anyMatch = false;
            let completedCount = 0;
            
            typingState.currentInputs.forEach((input, index) => {
                if (input.completed) {
                    completedCount++;
                    return; // Êó¢„Å´ÂÆå‰∫Ü„Åó„Å¶„ÅÑ„ÇãÂÄôË£ú„ÅØ„Çπ„Ç≠„ÉÉ„Éó
                }
                
                const targetRomaji = typingState.targetOptions[index];
                const expectedKey = targetRomaji[input.position];
                
                if (key === expectedKey) {
                    input.position++;
                    input.typed += key;
                    anyMatch = true;
                    
                    // „Åì„ÅÆÂÄôË£ú„ÅåÂÆå‰∫Ü„Åó„Åü„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                    if (input.position >= targetRomaji.length) {
                        input.completed = true;
                        completedCount++;
                        console.log(`ÂÄôË£ú${index}ÂÆå‰∫Ü: ${targetRomaji}`);
                    }
                }
            });
            
            if (anyMatch) {
                // Ê≠£„Åó„ÅÑ„Ç≠„Éº
                typingState.typedKeys += key;
                
                updateRomajiDisplay();
                updateTypingGuideProgress();
                
                // „ÅÑ„Åö„Çå„Åã„ÅÆÂÄôË£ú„ÅåÂÆå‰∫Ü„Åó„Åü„ÇâÂç≥Â∫ß„Å´ÈÄÅ‰ø°
                if (completedCount > 0) {
                    console.log('ÂÖ•ÂäõÂÆå‰∫ÜÊ§úÂá∫ - Âç≥Â∫ß„Å´ÈÄÅ‰ø°');
                    // Â∞ë„ÅóÈÅÖÂª∂„ÇíÂÖ•„Çå„Å¶Á¢∫ÂÆü„Å´Âá¶ÁêÜ
                    setTimeout(() => {
                        submitAnswer();
                    }, 50);
                }
            } else {
                // ÈñìÈÅï„Å£„Åü„Ç≠„Éº - 3Áßí„Éö„Éä„É´„ÉÜ„Ç£
                gameState.timer = Math.max(0, gameState.timer - 3);
                
                // „Çø„Ç§„Éû„ÉºË°®Á§∫„ÇíÂç≥Â∫ß„Å´Êõ¥Êñ∞
                const timerRing = document.getElementById('timerRing');
                timerRing.textContent = gameState.timer;
                const progress = (gameState.timer / 15) * 360;
                timerRing.style.background =
                    `conic-gradient(#feca57 ${progress}deg, rgba(255,255,255,0.2) ${progress}deg)`;
                
                // „Éö„Éä„É´„ÉÜ„Ç£„Ç®„Éï„Çß„ÇØ„ÉàË°®Á§∫
                showPenaltyEffect();
                
                playSound('fail');
                
                // ÊôÇÈñìÂàá„Çå„ÉÅ„Çß„ÉÉ„ÇØ
                if (gameState.timer <= 0) {
                    timeUp();
                }
            }
        }

        // „É≠„Éº„ÉûÂ≠óË°®Á§∫Êõ¥Êñ∞ÔºàË§áÊï∞ÂÄôË£úÂØæÂøúÔºâ
        function updateRomajiDisplay() {
            const romajiEl = document.getElementById('romajiGuide');
            const chars = romajiEl.querySelectorAll('.romaji-char');
            
            // ÊúÄ„ÇÇÈÄ≤„Çì„Åß„ÅÑ„ÇãÂÄôË£ú„ÅÆ‰ΩçÁΩÆ„ÇíÂèñÂæó
            let maxPosition = 0;
            typingState.currentInputs.forEach(input => {
                if (input.position > maxPosition) {
                    maxPosition = input.position;
                }
            });
            
            chars.forEach((char, index) => {
                char.classList.remove('typed', 'current');
                
                if (index < maxPosition) {
                    char.classList.add('typed');
                } else if (index === maxPosition) {
                    char.classList.add('current');
                }
            });
        }

        // „Ç®„Éï„Çß„ÇØ„Éà„É¨„Ç§„É§„ÉºÂèñÂæó/‰ΩúÊàê
        function getOrCreateFxLayer() {
            let fxLayer = document.querySelector('.fx-layer');
            if (!fxLayer) {
                fxLayer = document.createElement('div');
                fxLayer.className = 'fx-layer';
                fxLayer.setAttribute('aria-hidden', 'true');
                document.body.appendChild(fxLayer);
            }
            return fxLayer;
        }

        // Â±ûÊÄßÂà•Ë®≠ÂÆö„ÉÜ„Éº„Éñ„É´
        const ATTACK_CONFIGS = {
            fire: {
                colors: ['#ff6b6b', '#feca57', '#ff9f43'],
                particles: 80,
                speed: 1.0,
                flashColor: 'rgba(255, 107, 107, 0.6)',
                glowColor: '#ff6b6b'
            },
            water: {
                colors: ['#4ecdc4', '#76e0ff', '#00d2d3'],
                particles: 100,
                speed: 1.2,
                flashColor: 'rgba(76, 224, 255, 0.5)',
                glowColor: '#4ecdc4'
            },
            thunder: {
                colors: ['#ffe66d', '#fff', '#f1c40f'],
                particles: 60,
                speed: 2.0,
                flashColor: 'rgba(255, 255, 255, 0.8)',
                glowColor: '#ffe66d'
            },
            wind: {
                colors: ['#95e1d3', '#a8e6cf', '#88d8c0'],
                particles: 70,
                speed: 1.5,
                flashColor: 'rgba(149, 225, 211, 0.4)',
                glowColor: '#95e1d3'
            },
            earth: {
                colors: ['#a8e6cf', '#8bc34a', '#689f38'],
                particles: 60,
                speed: 0.8,
                flashColor: 'rgba(168, 230, 207, 0.5)',
                glowColor: '#a8e6cf'
            },
            light: {
                colors: ['#ffd93d', '#ffffff', '#f39c12'],
                particles: 90,
                speed: 1.8,
                flashColor: 'rgba(255, 255, 255, 0.9)',
                glowColor: '#ffd93d'
            }
        };

        // ÊîªÊíÉ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆüË°å
        async function playAttackAnimation({ attr, from, targetEl, impactMs = 600 }) {
            const config = ATTACK_CONFIGS[attr];
            const fxLayer = getOrCreateFxLayer();
            
            // ÊîªÊíÉËÄÖ„Å®ÂØæË±°„ÅÆ‰ΩçÁΩÆ„ÇíÂèñÂæó
            const attackerEl = document.getElementById(`player${gameState.currentPlayer + 1}Avatar`);
            const attackerRect = attackerEl.getBoundingClientRect();
            const targetRect = targetEl.getBoundingClientRect();
            
            const startX = from === 'left' ? attackerRect.right : attackerRect.left;
            const startY = attackerRect.top + attackerRect.height / 2;
            const endX = targetRect.left + targetRect.width / 2;
            const endY = targetRect.top + targetRect.height / 2;

            // „Éï„Çß„Éº„Ç∫1: Ê∫ú„ÇÅ„Ç®„Éï„Çß„ÇØ„Éà
            await playChargeEffect(attackerEl, config);
            
            // „Éï„Çß„Éº„Ç∫2: È£õ„Å≥ÈÅìÂÖ∑ÁßªÂãï
            await playProjectileEffect(fxLayer, attr, config, startX, startY, endX, endY, impactMs);
            
            // „Éï„Çß„Éº„Ç∫3: „Éí„ÉÉ„Éà„Ç®„Éï„Çß„ÇØ„Éà
            await playImpactEffect(fxLayer, attr, config, endX, endY);
            
            return Promise.resolve();
        }

        // „Éï„Çß„Éº„Ç∫1: Ê∫ú„ÇÅ„Ç®„Éï„Çß„ÇØ„Éà
        function playChargeEffect(attackerEl, config) {
            return new Promise((resolve) => {
                // Ê∫ú„ÇÅÈü≥
                playSound('charge');
                
                // „Ç∞„É≠„ÉºÂäπÊûú
                attackerEl.style.setProperty('--glow-color', config.glowColor);
                attackerEl.style.animation = 'chargeGlow 300ms ease-out forwards';
                
                setTimeout(() => {
                    attackerEl.style.animation = '';
                    attackerEl.style.transform = '';
                    attackerEl.style.boxShadow = '';
                    resolve();
                }, 300);
            });
        }

        // „Éï„Çß„Éº„Ç∫2: È£õ„Å≥ÈÅìÂÖ∑„Ç®„Éï„Çß„ÇØ„ÉàÔºàÁîªÈù¢ÂÖ®‰Ωì„Çπ„Ç±„Éº„É´Ôºâ
        function playProjectileEffect(fxLayer, attr, config, startX, startY, endX, endY, duration) {
            return new Promise((resolve) => {
                const projectile = createProjectile(attr, config, startX, startY);
                fxLayer.appendChild(projectile);
                
                // ÁßªÂãï„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÔºàÁîªÈù¢ÂÖ®‰Ωì„Çí‰Ωø„Å£„ÅüÂ§ß„Åç„Å™ËªåÈÅìÔºâ
                const deltaX = endX - startX;
                const deltaY = endY - startY;
                
                // Âºß„ÇíÊèè„ÅèËªåÈÅì„ÇíË®àÁÆóÔºà„Çà„ÇäÂ§ß„Åç„Å™„Çπ„Ç±„Éº„É´Ôºâ
                const midX = (startX + endX) / 2;
                const midY = Math.min(startY, endY) - Math.abs(deltaX) * 0.3; // „Çà„ÇäÈ´ò„ÅÑÂºß
                
                const keyframes = [
                    { 
                        transform: `translate3d(0, 0, 0) scale(1)`,
                        opacity: 1
                    },
                    { 
                        transform: `translate3d(${(midX - startX)}px, ${(midY - startY)}px, 0) scale(1.5)`,
                        opacity: 1,
                        offset: 0.5
                    },
                    { 
                        transform: `translate3d(${deltaX}px, ${deltaY}px, 0) scale(2)`,
                        opacity: 0.8
                    }
                ];
                
                projectile.animate(keyframes, {
                    duration: duration * config.speed,
                    easing: 'cubic-bezier(0.22, 1, 0.36, 1)',
                    fill: 'forwards'
                }).addEventListener('finish', () => {
                    projectile.remove();
                    resolve();
                });
            });
        }

        // Â±ûÊÄßÂà•È£õ„Å≥ÈÅìÂÖ∑‰ΩúÊàêÔºàÂ§ßÂûãÂåñÔºâ
        function createProjectile(attr, config, x, y) {
            const projectile = document.createElement('div');
            projectile.className = 'projectile';
            projectile.style.left = x + 'px';
            projectile.style.top = y + 'px';
            
            switch (attr) {
                case 'fire':
                    projectile.innerHTML = 'üî•';
                    projectile.style.fontSize = '80px';
                    projectile.style.filter = `drop-shadow(0 0 40px ${config.colors[0]}) drop-shadow(0 0 80px ${config.colors[1]})`;
                    projectile.style.animation = 'fireball 0.6s linear infinite';
                    // ÁÅ´„ÅÆÁ≤íÂ≠ê„Éà„É¨„Ç§„É´ËøΩÂä†
                    for (let i = 0; i < 5; i++) {
                        const trail = document.createElement('div');
                        trail.innerHTML = 'üî•';
                        trail.style.position = 'absolute';
                        trail.style.fontSize = '20px';
                        trail.style.opacity = '0.6';
                        trail.style.left = `-${i * 15}px`;
                        trail.style.top = '0px';
                        trail.style.animation = `fireball ${0.6 + i * 0.1}s linear infinite`;
                        projectile.appendChild(trail);
                    }
                    break;
                    
                case 'water':
                    projectile.style.width = '120px';
                    projectile.style.height = '16px';
                    projectile.style.background = `linear-gradient(90deg, transparent, ${config.colors[0]}, ${config.colors[1]}, transparent)`;
                    projectile.style.borderRadius = '8px';
                    projectile.style.boxShadow = `0 0 30px ${config.colors[0]}, 0 0 60px ${config.colors[1]}`;
                    projectile.style.animation = 'waterBlade 0.5s ease-in-out infinite';
                    // Ê∞¥Êª¥„Ç®„Éï„Çß„ÇØ„ÉàËøΩÂä†
                    for (let i = 0; i < 3; i++) {
                        const drop = document.createElement('div');
                        drop.innerHTML = 'üíß';
                        drop.style.position = 'absolute';
                        drop.style.fontSize = '24px';
                        drop.style.left = `${i * 30}px`;
                        drop.style.top = '-10px';
                        drop.style.animation = `waterBlade ${0.5 + i * 0.1}s ease-in-out infinite`;
                        projectile.appendChild(drop);
                    }
                    break;
                    
                case 'thunder':
                    projectile.innerHTML = '‚ö°';
                    projectile.style.fontSize = '100px';
                    projectile.style.filter = `drop-shadow(0 0 50px ${config.colors[1]}) drop-shadow(0 0 100px white)`;
                    projectile.style.animation = 'lightning 0.1s linear infinite';
                    // ÈõªÊíÉ„Ç®„Éï„Çß„ÇØ„ÉàËøΩÂä†
                    for (let i = 0; i < 4; i++) {
                        const bolt = document.createElement('div');
                        bolt.style.position = 'absolute';
                        bolt.style.width = '4px';
                        bolt.style.height = '60px';
                        bolt.style.background = config.colors[1];
                        bolt.style.left = `${Math.random() * 60 - 30}px`;
                        bolt.style.top = `${Math.random() * 60 - 30}px`;
                        bolt.style.transform = `rotate(${Math.random() * 360}deg)`;
                        bolt.style.boxShadow = `0 0 20px ${config.colors[1]}`;
                        bolt.style.animation = 'lightning 0.05s linear infinite';
                        projectile.appendChild(bolt);
                    }
                    break;
                    
                case 'wind':
                    projectile.innerHTML = 'üå™Ô∏è';
                    projectile.style.fontSize = '90px';
                    projectile.style.filter = `drop-shadow(0 0 30px ${config.colors[0]})`;
                    projectile.style.animation = 'windBlade 0.4s ease-out infinite';
                    // È¢®„ÅÆÊ∏¶„Ç®„Éï„Çß„ÇØ„ÉàËøΩÂä†
                    for (let i = 0; i < 6; i++) {
                        const swirl = document.createElement('div');
                        swirl.style.position = 'absolute';
                        swirl.style.width = '20px';
                        swirl.style.height = '20px';
                        swirl.style.border = `2px solid ${config.colors[0]}`;
                        swirl.style.borderRadius = '50%';
                        swirl.style.left = `${Math.cos(i * Math.PI / 3) * 40}px`;
                        swirl.style.top = `${Math.sin(i * Math.PI / 3) * 40}px`;
                        swirl.style.animation = `windBlade ${0.4 + i * 0.05}s ease-out infinite`;
                        projectile.appendChild(swirl);
                    }
                    break;
                    
                case 'earth':
                    projectile.innerHTML = 'ü™®';
                    projectile.style.fontSize = '70px';
                    projectile.style.filter = `drop-shadow(0 0 20px ${config.colors[0]})`;
                    projectile.style.animation = 'rockSpike 0.3s ease-out infinite';
                    // Â≤©„ÅÆÁ†¥Áâá„Ç®„Éï„Çß„ÇØ„ÉàËøΩÂä†
                    for (let i = 0; i < 4; i++) {
                        const rock = document.createElement('div');
                        rock.innerHTML = 'ü™®';
                        rock.style.position = 'absolute';
                        rock.style.fontSize = '16px';
                        rock.style.left = `${(i % 2) * 40 - 20}px`;
                        rock.style.top = `${Math.floor(i / 2) * 40 - 20}px`;
                        rock.style.animation = `rockSpike ${0.3 + i * 0.1}s ease-out infinite`;
                        projectile.appendChild(rock);
                    }
                    break;
                    
                case 'light':
                    projectile.style.width = '160px';
                    projectile.style.height = '8px';
                    projectile.style.background = `linear-gradient(90deg, transparent, ${config.colors[1]}, ${config.colors[0]}, ${config.colors[1]}, transparent)`;
                    projectile.style.boxShadow = `0 0 60px ${config.colors[0]}, 0 0 120px white`;
                    projectile.style.animation = 'lightBeam 0.3s ease-in-out infinite';
                    // ÂÖâ„ÅÆÁ≤íÂ≠ê„Ç®„Éï„Çß„ÇØ„ÉàËøΩÂä†
                    for (let i = 0; i < 8; i++) {
                        const particle = document.createElement('div');
                        particle.innerHTML = '‚ú®';
                        particle.style.position = 'absolute';
                        particle.style.fontSize = '20px';
                        particle.style.left = `${i * 20}px`;
                        particle.style.top = `${Math.sin(i) * 20}px`;
                        particle.style.animation = `lightBeam ${0.3 + i * 0.02}s ease-in-out infinite`;
                        projectile.appendChild(particle);
                    }
                    break;
            }
            
            return projectile;
        }

        // „Éï„Çß„Éº„Ç∫3: „Éí„ÉÉ„Éà„Ç®„Éï„Çß„ÇØ„Éà
        function playImpactEffect(fxLayer, attr, config, x, y) {
            return new Promise((resolve) => {
                // „Éí„ÉÉ„ÉàÈü≥
                playSound('success');
                
                // ÁîªÈù¢„Ç∑„Çß„Ç§„ÇØ
                if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                    document.body.classList.add('shake-strong');
                    setTimeout(() => {
                        document.body.classList.remove('shake-strong');
                    }, 400);
                }
                
                // „Éï„É©„ÉÉ„Ç∑„É•„Ç®„Éï„Çß„ÇØ„Éà
                const flash = document.createElement('div');
                flash.className = 'impact-flash';
                flash.style.background = config.flashColor;
                flash.style.opacity = '0';
                fxLayer.appendChild(flash);
                
                flash.animate([
                    { opacity: 0 },
                    { opacity: 1 },
                    { opacity: 0 }
                ], {
                    duration: 200,
                    easing: 'ease-out'
                }).addEventListener('finish', () => {
                    flash.remove();
                });
                
                // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÁàÜÁô∫
                createParticleExplosion(fxLayer, attr, config, x, y);
                
                // Â±ûÊÄßÂà•ÁâπÊÆä„Ç®„Éï„Çß„ÇØ„Éà
                createSpecialImpactEffect(fxLayer, attr, config, x, y);
                
                setTimeout(resolve, 500);
            });
        }

        // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÁàÜÁô∫ÁîüÊàêÔºàÁîªÈù¢ÂÖ®‰Ωì„Çπ„Ç±„Éº„É´Ôºâ
        function createParticleExplosion(fxLayer, attr, config, x, y) {
            const particleCount = Math.min(config.particles, 120); // „Çπ„Éû„ÉõÈÖçÊÖÆ
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                const size = Math.random() * 16 + 8; // „Çà„ÇäÂ§ß„Åç„Å™„Éë„Éº„ÉÜ„Ç£„ÇØ„É´
                const angle = (i / particleCount) * Math.PI * 2;
                const distance = Math.random() * 300 + 100; // „Çà„ÇäÂ∫ÉÁØÑÂõ≤„Å´Êï£„Çâ„Å∞„Çã
                const dx = Math.cos(angle) * distance;
                const dy = Math.sin(angle) * distance;
                
                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                particle.style.left = (x - size/2) + 'px';
                particle.style.top = (y - size/2) + 'px';
                particle.style.background = config.colors[Math.floor(Math.random() * config.colors.length)];
                particle.style.borderRadius = '50%';
                particle.style.boxShadow = `0 0 ${size}px ${config.colors[0]}`;
                particle.style.setProperty('--dx', dx + 'px');
                particle.style.setProperty('--dy', dy + 'px');
                
                fxLayer.appendChild(particle);
                
                particle.animate([
                    { 
                        transform: 'scale(0) translate3d(0, 0, 0) rotate(0deg)',
                        opacity: 1
                    },
                    { 
                        transform: `scale(1.5) translate3d(${dx * 0.7}px, ${dy * 0.7}px, 0) rotate(180deg)`,
                        opacity: 0.8,
                        offset: 0.6
                    },
                    { 
                        transform: `scale(0.5) translate3d(${dx}px, ${dy}px, 0) rotate(360deg)`,
                        opacity: 0
                    }
                ], {
                    duration: 1200 + Math.random() * 600,
                    easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
                }).addEventListener('finish', () => {
                    particle.remove();
                });
            }
        }

        // Â±ûÊÄßÂà•ÁâπÊÆä„Ç§„É≥„Éë„ÇØ„Éà„Ç®„Éï„Çß„ÇØ„ÉàÔºàÁîªÈù¢ÂÖ®‰Ωì„Çπ„Ç±„Éº„É´Ôºâ
        function createSpecialImpactEffect(fxLayer, attr, config, x, y) {
            switch (attr) {
                case 'fire':
                    // Â∑®Â§ßÁÅ´Ëä±„É™„É≥„Ç∞
                    for (let i = 0; i < 5; i++) {
                        const ring = document.createElement('div');
                        ring.style.position = 'absolute';
                        ring.style.left = (x - 100) + 'px';
                        ring.style.top = (y - 100) + 'px';
                        ring.style.width = '200px';
                        ring.style.height = '200px';
                        ring.style.border = `6px solid ${config.colors[0]}`;
                        ring.style.borderRadius = '50%';
                        ring.style.opacity = '0.8';
                        ring.style.boxShadow = `0 0 40px ${config.colors[0]}, inset 0 0 40px ${config.colors[1]}`;
                        fxLayer.appendChild(ring);
                        
                        ring.animate([
                            { transform: 'scale(0) rotate(0deg)', opacity: 0.8 },
                            { transform: 'scale(6) rotate(360deg)', opacity: 0 }
                        ], {
                            duration: 1000,
                            delay: i * 150,
                            easing: 'ease-out'
                        }).addEventListener('finish', () => ring.remove());
                    }
                    
                    // ÁÅ´„ÅÆÊü±„Ç®„Éï„Çß„ÇØ„Éà
                    const firePillar = document.createElement('div');
                    firePillar.style.position = 'absolute';
                    firePillar.style.left = (x - 50) + 'px';
                    firePillar.style.top = '0px';
                    firePillar.style.width = '100px';
                    firePillar.style.height = '100vh';
                    firePillar.style.background = `linear-gradient(0deg, transparent, ${config.colors[0]}, ${config.colors[1]}, transparent)`;
                    firePillar.style.opacity = '0.6';
                    fxLayer.appendChild(firePillar);
                    
                    firePillar.animate([
                        { opacity: 0, transform: 'scaleX(0)' },
                        { opacity: 0.6, transform: 'scaleX(1)' },
                        { opacity: 0, transform: 'scaleX(0)' }
                    ], {
                        duration: 800,
                        easing: 'ease-out'
                    }).addEventListener('finish', () => firePillar.remove());
                    break;
                    
                case 'water':
                    // Â∑®Â§ßÊ∞¥„ÅÆ„É™„ÉÉ„Éó„É´
                    for (let i = 0; i < 4; i++) {
                        const ripple = document.createElement('div');
                        ripple.style.position = 'absolute';
                        ripple.style.left = (x - 150) + 'px';
                        ripple.style.top = (y - 150) + 'px';
                        ripple.style.width = '300px';
                        ripple.style.height = '300px';
                        ripple.style.border = `8px solid ${config.colors[1]}`;
                        ripple.style.borderRadius = '50%';
                        ripple.style.opacity = '0.7';
                        ripple.style.boxShadow = `0 0 60px ${config.colors[0]}`;
                        fxLayer.appendChild(ripple);
                        
                        ripple.animate([
                            { transform: 'scale(0)', opacity: 0.7 },
                            { transform: 'scale(8)', opacity: 0 }
                        ], {
                            duration: 1200,
                            delay: i * 250,
                            easing: 'ease-out'
                        }).addEventListener('finish', () => ripple.remove());
                    }
                    
                    // Ê∞¥„ÅÆÊ≥¢„Ç®„Éï„Çß„ÇØ„Éà
                    const wave = document.createElement('div');
                    wave.style.position = 'absolute';
                    wave.style.left = '0px';
                    wave.style.top = (y - 25) + 'px';
                    wave.style.width = '100vw';
                    wave.style.height = '50px';
                    wave.style.background = `linear-gradient(90deg, transparent, ${config.colors[0]}, ${config.colors[1]}, transparent)`;
                    wave.style.opacity = '0.5';
                    fxLayer.appendChild(wave);
                    
                    wave.animate([
                        { opacity: 0, transform: 'scaleY(0)' },
                        { opacity: 0.5, transform: 'scaleY(1)' },
                        { opacity: 0, transform: 'scaleY(0)' }
                    ], {
                        duration: 600,
                        easing: 'ease-out'
                    }).addEventListener('finish', () => wave.remove());
                    break;
                    
                case 'thunder':
                    // Â∑®Â§ßÈõªÊíÉ„Ç¢„Éº„ÇØ
                    for (let i = 0; i < 8; i++) {
                        const arc = document.createElement('div');
                        arc.style.position = 'absolute';
                        arc.style.left = x + 'px';
                        arc.style.top = y + 'px';
                        arc.style.width = '8px';
                        arc.style.height = (Math.random() * 200 + 100) + 'px';
                        arc.style.background = config.colors[1];
                        arc.style.transformOrigin = 'top';
                        arc.style.transform = `rotate(${Math.random() * 360}deg)`;
                        arc.style.boxShadow = `0 0 40px ${config.colors[1]}, 0 0 80px white`;
                        fxLayer.appendChild(arc);
                        
                        arc.animate([
                            { opacity: 1, transform: `rotate(${Math.random() * 360}deg) scaleY(1)` },
                            { opacity: 0, transform: `rotate(${Math.random() * 360}deg) scaleY(0)` }
                        ], {
                            duration: 400,
                            delay: Math.random() * 300,
                            easing: 'ease-out'
                        }).addEventListener('finish', () => arc.remove());
                    }
                    
                    // ÁîªÈù¢ÂÖ®‰Ωì„ÅÆÈõªÊíÉ„Éï„É©„ÉÉ„Ç∑„É•
                    const lightning = document.createElement('div');
                    lightning.style.position = 'absolute';
                    lightning.style.left = '0px';
                    lightning.style.top = '0px';
                    lightning.style.width = '100vw';
                    lightning.style.height = '100vh';
                    lightning.style.background = `radial-gradient(circle at ${x}px ${y}px, ${config.colors[1]} 0%, transparent 50%)`;
                    lightning.style.opacity = '0';
                    fxLayer.appendChild(lightning);
                    
                    lightning.animate([
                        { opacity: 0 },
                        { opacity: 0.8 },
                        { opacity: 0 },
                        { opacity: 0.6 },
                        { opacity: 0 }
                    ], {
                        duration: 500,
                        easing: 'ease-out'
                    }).addEventListener('finish', () => lightning.remove());
                    break;
                    
                case 'wind':
                    // Â∑®Â§ßÁ´úÂ∑ª„Ç®„Éï„Çß„ÇØ„Éà
                    for (let i = 0; i < 3; i++) {
                        const tornado = document.createElement('div');
                        tornado.style.position = 'absolute';
                        tornado.style.left = (x - 75) + 'px';
                        tornado.style.top = '0px';
                        tornado.style.width = '150px';
                        tornado.style.height = '100vh';
                        tornado.style.background = `conic-gradient(from ${i * 120}deg, transparent, ${config.colors[0]}, transparent)`;
                        tornado.style.opacity = '0.4';
                        tornado.style.borderRadius = '50%';
                        fxLayer.appendChild(tornado);
                        
                        tornado.animate([
                            { transform: 'rotate(0deg) scaleX(0)', opacity: 0 },
                            { transform: 'rotate(720deg) scaleX(1)', opacity: 0.4 },
                            { transform: 'rotate(1440deg) scaleX(0)', opacity: 0 }
                        ], {
                            duration: 1000,
                            delay: i * 200,
                            easing: 'ease-out'
                        }).addEventListener('finish', () => tornado.remove());
                    }
                    break;
                    
                case 'earth':
                    // Âú∞Èù¢ÂÖ®‰Ωì„ÅÆ‰∫ÄË£Ç„Ç®„Éï„Çß„ÇØ„Éà
                    for (let i = 0; i < 6; i++) {
                        const crack = document.createElement('div');
                        crack.style.position = 'absolute';
                        crack.style.left = '0px';
                        crack.style.top = (y + Math.random() * 100 - 50) + 'px';
                        crack.style.width = '100vw';
                        crack.style.height = '4px';
                        crack.style.background = config.colors[2] || config.colors[0];
                        crack.style.opacity = '0.8';
                        crack.style.transform = `rotate(${Math.random() * 10 - 5}deg)`;
                        fxLayer.appendChild(crack);
                        
                        crack.animate([
                            { transform: `scaleX(0) rotate(${Math.random() * 10 - 5}deg)`, opacity: 0 },
                            { transform: `scaleX(1) rotate(${Math.random() * 10 - 5}deg)`, opacity: 0.8 },
                            { transform: `scaleX(1) rotate(${Math.random() * 10 - 5}deg)`, opacity: 0 }
                        ], {
                            duration: 800,
                            delay: i * 100,
                            easing: 'ease-out'
                        }).addEventListener('finish', () => crack.remove());
                    }
                    break;
                    
                case 'light':
                    // Â∑®Â§ßÊòüÂûã„Éê„Éº„Çπ„Éà
                    const star = document.createElement('div');
                    star.innerHTML = '‚ú®';
                    star.style.position = 'absolute';
                    star.style.left = (x - 100) + 'px';
                    star.style.top = (y - 100) + 'px';
                    star.style.fontSize = '200px';
                    star.style.filter = `drop-shadow(0 0 100px ${config.colors[0]}) drop-shadow(0 0 200px white)`;
                    fxLayer.appendChild(star);
                    
                    star.animate([
                        { transform: 'scale(0) rotate(0deg)', opacity: 1 },
                        { transform: 'scale(3) rotate(360deg)', opacity: 0 }
                    ], {
                        duration: 800,
                        easing: 'ease-out'
                    }).addEventListener('finish', () => star.remove());
                    
                    // ÂÖâ„ÅÆÊü±„Ç®„Éï„Çß„ÇØ„Éà
                    const lightBeam = document.createElement('div');
                    lightBeam.style.position = 'absolute';
                    lightBeam.style.left = (x - 25) + 'px';
                    lightBeam.style.top = '0px';
                    lightBeam.style.width = '50px';
                    lightBeam.style.height = '100vh';
                    lightBeam.style.background = `linear-gradient(0deg, transparent, ${config.colors[1]}, ${config.colors[0]}, transparent)`;
                    lightBeam.style.opacity = '0.8';
                    lightBeam.style.boxShadow = `0 0 100px ${config.colors[0]}`;
                    fxLayer.appendChild(lightBeam);
                    
                    lightBeam.animate([
                        { opacity: 0, transform: 'scaleX(0)' },
                        { opacity: 0.8, transform: 'scaleX(1)' },
                        { opacity: 0, transform: 'scaleX(0)' }
                    ], {
                        duration: 600,
                        easing: 'ease-out'
                    }).addEventListener('finish', () => lightBeam.remove());
                    break;
            }
        }

        // Ë¢´Âºæ„Ç®„Éï„Çß„ÇØ„ÉàÔºà‰∏çÊ≠£Ëß£ÊôÇÔºâ
        function playHitEffect(playerIndex) {
            const avatarEl = document.getElementById(`player${playerIndex + 1}Avatar`);
            const fxLayer = getOrCreateFxLayer();
            
            // ÁÖô„Ç®„Éï„Çß„ÇØ„Éà
            const smoke = document.createElement('div');
            smoke.innerHTML = 'üí®';
            smoke.style.position = 'absolute';
            smoke.style.fontSize = '30px';
            smoke.style.opacity = '0.8';
            
            const rect = avatarEl.getBoundingClientRect();
            smoke.style.left = rect.left + 'px';
            smoke.style.top = rect.top + 'px';
            
            fxLayer.appendChild(smoke);
            
            smoke.animate([
                { transform: 'scale(0.5) translateY(0)', opacity: 0.8 },
                { transform: 'scale(1.5) translateY(-30px)', opacity: 0 }
            ], {
                duration: 600,
                easing: 'ease-out'
            }).addEventListener('finish', () => smoke.remove());
            
            // Ëµ§„Éï„É©„ÉÉ„Ç∑„É•
            const flash = document.createElement('div');
            flash.className = 'impact-flash';
            flash.style.background = 'rgba(255, 107, 107, 0.4)';
            fxLayer.appendChild(flash);
            
            flash.animate([
                { opacity: 0 },
                { opacity: 1 },
                { opacity: 0 }
            ], {
                duration: 300,
                easing: 'ease-out'
            }).addEventListener('finish', () => flash.remove());
        }

        // Á≠î„ÅàÈÄÅ‰ø°
        async function submitAnswer() {
            const target = gameState.selectedCard.text;
            const targetLen = countChars(target);
            const timeUsed = Math.max(0, 15 - gameState.timer);

            // Áµ±Ë®àÔºöË©¶Ë°å„Åî„Å®„Å´Êõ¥Êñ∞
            gameState.stats.totalChars += targetLen;
            gameState.stats.totalTime += timeUsed;

            // „ÅÑ„Åö„Çå„Åã„ÅÆÂÄôË£ú„ÅåÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Çå„Å∞ÊàêÂäü
            const success = typingState.currentInputs.some(input => input.completed);
            console.log('ÈÄÅ‰ø°ÊôÇ„ÅÆÊàêÂäüÂà§ÂÆö:', success);

            if (success) {
                // Ê≠£Ëß£ - ÊîªÊíÉ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆüË°å
                const damage = Math.round(targetLen * gameState.timer * 10) / 10;
                
                // ÊîªÊíÉ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                await playAttackAnimation({
                    attr: gameState.players[gameState.currentPlayer].attribute,
                    from: gameState.currentPlayer === 0 ? 'left' : 'right',
                    targetEl: document.getElementById(`player${2 - gameState.currentPlayer}Avatar`),
                    impactMs: 600
                });
                
                // „ÉÄ„É°„Éº„Ç∏Âá¶ÁêÜ
                dealDamage(1 - gameState.currentPlayer, damage);
                gameState.stats.correctChars += targetLen;
                gameState.stats.combo++;
                gameState.stats.maxCombo = Math.max(gameState.stats.maxCombo, gameState.stats.combo);
            } else {
                // ‰∏çÊ≠£Ëß£ - Ë¢´Âºæ„Ç®„Éï„Çß„ÇØ„Éà
                playHitEffect(gameState.currentPlayer);
                const selfDamage = targetLen * 10;
                dealDamage(gameState.currentPlayer, selfDamage);
                gameState.stats.combo = 0;
                playSound('fail');
            }
            
            endTurn();
        }

        // „ÇÆ„Éñ„Ç¢„ÉÉ„Éó
        function giveUp() {
            const targetLen = countChars(gameState.selectedCard.text);
            const timeUsed = Math.max(0, 15 - gameState.timer);
            gameState.stats.totalChars += targetLen;
            gameState.stats.totalTime += timeUsed;

            // Ë¢´Âºæ„Ç®„Éï„Çß„ÇØ„Éà
            playHitEffect(gameState.currentPlayer);
            const selfDamage = targetLen * 10;
            dealDamage(gameState.currentPlayer, selfDamage);
            gameState.stats.combo = 0;
            playSound('fail');
            endTurn();
        }

        // ÊôÇÈñìÂàá„Çå
        function timeUp() {
            const targetLen = countChars(gameState.selectedCard.text);
            gameState.stats.totalChars += targetLen;
            gameState.stats.totalTime += 15;

            // Ë¢´Âºæ„Ç®„Éï„Çß„ÇØ„Éà
            playHitEffect(gameState.currentPlayer);
            const selfDamage = targetLen * 10;
            dealDamage(gameState.currentPlayer, selfDamage);
            gameState.stats.combo = 0;
            playSound('fail');
            endTurn();
        }

        // „ÉÄ„É°„Éº„Ç∏Âá¶ÁêÜ
        function dealDamage(playerIndex, damage) {
            gameState.players[playerIndex].hp = Math.max(0, gameState.players[playerIndex].hp - damage);
            
            // „ÉÄ„É°„Éº„Ç∏„Ç®„Éï„Çß„ÇØ„Éà
            showDamageEffect(playerIndex, damage);
            
            // HPÊõ¥Êñ∞
            updateUI();
            
            // ÂãùÊïóÂà§ÂÆö
            if (gameState.players[playerIndex].hp <= 0) {
                endGame(1 - playerIndex);
            }
        }

        // „ÉÄ„É°„Éº„Ç∏„Ç®„Éï„Çß„ÇØ„ÉàË°®Á§∫
        function showDamageEffect(playerIndex, damage) {
            const avatar = document.getElementById(`player${playerIndex + 1}Avatar`);
            const damageElement = document.createElement('div');
            damageElement.className = 'damage-number';
            damageElement.textContent = `-${damage}`;
            damageElement.style.left = '50%';
            damageElement.style.top = '50%';
            
            avatar.style.position = 'relative';
            avatar.appendChild(damageElement);
            
            // „Ç∑„Çß„Ç§„ÇØ„Ç®„Éï„Çß„ÇØ„Éà
            avatar.classList.add('shake');
            setTimeout(() => {
                avatar.classList.remove('shake');
                if (damageElement.parentNode) {
                    damageElement.remove();
                }
            }, 1000);
        }

        // „Éö„Éä„É´„ÉÜ„Ç£„Ç®„Éï„Çß„ÇØ„ÉàË°®Á§∫
        function showPenaltyEffect() {
            const timerRing = document.getElementById('timerRing');
            const penaltyElement = document.createElement('div');
            penaltyElement.className = 'damage-number';
            penaltyElement.textContent = '-3Áßí';
            penaltyElement.style.left = '50%';
            penaltyElement.style.top = '20%';
            penaltyElement.style.color = '#ff6b6b';
            penaltyElement.style.fontSize = '20px';
            
            timerRing.style.position = 'relative';
            timerRing.appendChild(penaltyElement);
            
            // „Çø„Ç§„Éû„Éº„É™„É≥„Ç∞„ÇíËµ§„ÅèÁÇπÊªÖ
            timerRing.style.boxShadow = '0 0 20px rgba(255, 107, 107, 0.8)';
            setTimeout(() => {
                timerRing.style.boxShadow = '';
                if (penaltyElement.parentNode) {
                    penaltyElement.remove();
                }
            }, 1000);
        }

        // „Çø„Éº„É≥ÁµÇ‰∫Ü
        function endTurn() {
            clearInterval(gameState.timerInterval);
            
            // „Ç≠„Éº„Éú„Éº„Éâ„Ç§„Éô„É≥„Éà„ÇíÁÑ°ÂäπÂåñ
            document.removeEventListener('keydown', handleKeyPress);
            
            // ‰ΩøÁî®„Åó„Åü„Ç´„Éº„Éâ„ÇíÊç®„Å¶Êú≠„Å´
            const handIndex = gameState.hands[gameState.currentPlayer].indexOf(gameState.selectedCard);
            gameState.hands[gameState.currentPlayer].splice(handIndex, 1);
            gameState.discard.push(gameState.selectedCard);
            
            // „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„ÅØÈùûË°®Á§∫„ÅÆ„Åü„ÇÅ„É™„Çª„ÉÉ„Éà‰∏çË¶Å
            
            // „Çø„Ç§„Éî„É≥„Ç∞„Ç¨„Ç§„Éâ„Çí„ÇØ„É™„Ç¢
            document.getElementById('typingGuideJP').style.setProperty('--fill', '0%');
            document.getElementById('typingGuideSub').innerHTML = '';
            document.getElementById('romajiGuide').innerHTML = '';
            
            // „Çø„Ç§„Éî„É≥„Ç∞Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
            typingState = {
                targetOptions: [],
                currentInputs: [],
                typedKeys: ''
            };
            
            // ÁµêÊûú„Éï„Çß„Éº„Ç∫„Å´ÁßªË°å
            gameState.gamePhase = 'result';
            updatePhaseDisplay();
            
            // Ê¨°„ÅÆ„Éó„É¨„Ç§„É§„Éº„Å´‰∫§‰ª£
            gameState.currentPlayer = 1 - gameState.currentPlayer;
            gameState.gamePhase = 'cardSelect';
            gameState.selectedCard = null;
            
            // CPU„Çø„Éº„É≥„Åæ„Åü„ÅØÊ¨°„ÅÆ„Çø„Éº„É≥ÈñãÂßãÔºàÂ∞ë„ÅóÈÅÖÂª∂„ÇíÂÖ•„Çå„ÇãÔºâ
            setTimeout(() => {
                if (gameState.mode === 'cpu' && gameState.currentPlayer === 1) {
                    cpuTurn();
                } else {
                    startTurn();
                }
            }, 2000); // „ÉÄ„É°„Éº„Ç∏ÊºîÂá∫„ÇíË¶ã„Åõ„Çã„Åü„ÇÅ2Áßí„Å´Âª∂Èï∑
        }

        // „Çø„Éº„É≥ÈñãÂßã
        function startTurn() {
            showTurnPopup();
            updateUI();
            drawCards();
            drawPlayerHand();
            
            // „Çø„Ç§„Éû„Éº„É™„Çª„ÉÉ„Éà
            document.getElementById('timerRing').textContent = '15';
            document.getElementById('timerRing').style.background = 
                'conic-gradient(#feca57 360deg, rgba(255, 255, 255, 0.2) 360deg)';
        }

        // „Çø„Éº„É≥Âàá„ÇäÊõø„Åà„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫
        function showTurnPopup() {
            const popup = document.createElement('div');
            popup.className = 'turn-popup';
            popup.innerHTML = `<h2>${gameState.players[gameState.currentPlayer].name}„ÅÆ„Çø„Éº„É≥</h2>`;
            document.body.appendChild(popup);
            
            setTimeout(() => {
                if (popup.parentNode) {
                    popup.remove();
                }
            }, 2000);
        }

        // CPU„Çø„Éº„É≥
        async function cpuTurn() {
            updateUI();
            drawCards(); // ‚òÖËøΩÂä†ÔºöCPU„ÇÇ„Å°„ÇÉ„Çì„Å®1ÊûöÂºï„Åè
            drawPlayerHand(); // ÊâãÊú≠Ë°®Á§∫„ÇÇÊõ¥Êñ∞
            
            setTimeout(async () => {
                // CPU„Ç´„Éº„ÉâÈÅ∏ÊäûÔºàÁ∞°ÊòìAIÔºâ
                const hand = gameState.hands[1];
                let bestCard = hand[0];
                let bestScore = -1;
                
                hand.forEach(card => {
                    // ÊúüÂæÖ„ÉÄ„É°„Éº„Ç∏Ë®àÁÆóÔºàÁ∞°ÊòìÔºâ
                    const expectedTime = Math.random() * 10 + 5; // 5-15Áßí
                    const expectedDamage = card.text.length * expectedTime;
                    const failRisk = card.difficulty * 20; // Èõ£ÊòìÂ∫¶„Å´„Çà„ÇãÂ§±Êïó„É™„Çπ„ÇØ
                    const score = expectedDamage - failRisk;
                    
                    if (score > bestScore) {
                        bestScore = score;
                        bestCard = card;
                    }
                });
                
                gameState.selectedCard = bestCard;
                
                // CPUÂÖ•Âäõ„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥
                setTimeout(async () => {
                    const success = Math.random() > (bestCard.difficulty * 0.2); // Èõ£ÊòìÂ∫¶„Å´„Çà„ÇãÊàêÂäüÁéá
                    
                    if (success) {
                        const cpuTime = Math.random() * 8 + 2; // 2-10Áßí
                        const charCount = countChars(bestCard.text);
                        const damage = Math.round(charCount * cpuTime * 10) / 10;
                        
                        // CPUÊîªÊíÉ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                        await playAttackAnimation({
                            attr: gameState.players[1].attribute,
                            from: 'right',
                            targetEl: document.getElementById('player1Avatar'),
                            impactMs: 600
                        });
                        
                        dealDamage(0, damage);
                        
                        gameState.stats.correctChars += charCount;
                        gameState.stats.totalChars += charCount;
                        gameState.stats.totalTime += (15 - cpuTime);
                    } else {
                        const charCount = countChars(bestCard.text);
                        const selfDamage = charCount * 10;
                        
                        // CPUË¢´Âºæ„Ç®„Éï„Çß„ÇØ„Éà
                        playHitEffect(1);
                        dealDamage(1, selfDamage);
                        
                        gameState.stats.totalChars += charCount;
                        gameState.stats.totalTime += 15;
                        
                        playSound('fail');
                    }
                    
                    endTurn();
                }, 2000);
            }, 1000);
        }

        // „Ç≤„Éº„É†ÁµÇ‰∫Ü
        function endGame(winner) {
            gameState.gamePhase = 'result';
            
            const winnerName = gameState.players[winner].name;
            const accuracy = gameState.stats.totalChars > 0 ? 
                Math.round((gameState.stats.correctChars / gameState.stats.totalChars) * 100) : 0;
            const avgTime = gameState.stats.totalChars > 0 ? 
                Math.round((gameState.stats.totalTime / gameState.stats.totalChars) * 10) / 10 : 0;
            
            showModal(`üéâ ${winnerName}„ÅÆÂãùÂà©ÔºÅ`, `
                <p>„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ</p>
                <p><strong>Êà¶Á∏æ</strong></p>
                <p>ÊúÄÂ§ß„Ç≥„É≥„Éú: ${gameState.stats.maxCombo}</p>
                <p>Ê≠£Á¢∫ÊÄß: ${accuracy}%</p>
                <p>Âπ≥ÂùáÂÖ•ÂäõÊôÇÈñì: ${avgTime}Áßí/ÊñáÂ≠ó</p>
                <button class="btn btn-primary" onclick="backToMenu()">„É°„Éã„É•„Éº„Å´Êàª„Çã</button>
                <button class="btn btn-secondary" onclick="restartGame()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
            `);
        }

        // Èü≥Â£∞ÂÜçÁîü
        function playSound(type) {
            if (!gameState.soundEnabled) return;
            
            // Á∞°ÊòìÈü≥Â£∞ÔºàÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØÈÅ©Âàá„Å™Èü≥Â£∞„Éï„Ç°„Ç§„É´„Çí‰ΩøÁî®Ôºâ
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            if (type === 'success') {
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
            } else if (type === 'charge') {
                // Ê∫ú„ÇÅÈü≥Ôºö‰ΩéÈü≥„Åã„ÇâÈ´òÈü≥„Å∏
                oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.3);
            } else {
                oscillator.frequency.setValueAtTime(220, audioContext.currentTime); // A3
            }
            
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showModal(title, content) {
            document.getElementById('modalContent').innerHTML = `
                <h2>${title}</h2>
                ${content}
            `;
            document.getElementById('modal').style.display = 'flex';
        }

        // „É¢„Éº„ÉÄ„É´ÈùûË°®Á§∫
        function hideModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // „Éò„É´„ÉóË°®Á§∫
        function showHelp() {
            showModal('üìñ „Ç≤„Éº„É†„ÅÆÈÅä„Å≥Êñπ', `
                <p><strong>Âü∫Êú¨„É´„Éº„É´</strong></p>
                <p>‚Ä¢ Ë®≠ÂÆö„Åó„ÅüHP„Åß„Çπ„Çø„Éº„Éà</p>
                <p>‚Ä¢ ÊâãÊú≠„Åã„Çâ1ÊûöÈÅ∏„Çì„Åß„Çø„Ç§„Éî„É≥„Ç∞</p>
                <p>‚Ä¢ 15Áßí‰ª•ÂÜÖ„Å´„É≠„Éº„ÉûÂ≠ó„ÅßÂÖ•Âäõ</p>
                <p>‚Ä¢ ÊàêÂäüÔºöÊñáÂ≠óÊï∞√óÊÆã„ÇäÊôÇÈñì„Åß„ÉÄ„É°„Éº„Ç∏</p>
                <p>‚Ä¢ Â§±ÊïóÔºöÊñáÂ≠óÊï∞√ó10„ÅÆËá™ÂÇ∑„ÉÄ„É°„Éº„Ç∏</p>
                <p>‚Ä¢ Êâì„Å°ÈñìÈÅï„ÅàÔºö3Áßí„Éö„Éä„É´„ÉÜ„Ç£</p>
                <p><strong>Êìç‰ΩúÊñπÊ≥ï</strong></p>
                <p>‚Ä¢ „Ç´„Éº„Éâ„Çí„Çø„ÉÉ„Éó„Åó„Å¶ÈÅ∏Êäû</p>
                <p>‚Ä¢ „É≠„Éº„ÉûÂ≠ó„ÅßÂÖ•ÂäõÔºàÂÖ®Ëßí„Åß„ÇÇOKÔºâ</p>
                <p>‚Ä¢ ESC„Ç≠„Éº„Åß„ÇÆ„Éñ„Ç¢„ÉÉ„Éó</p>
                <button class="btn btn-primary" onclick="hideModal()">Èñâ„Åò„Çã</button>
            `);
        }

        // Èü≥ÈáèÂàá„ÇäÊõø„Åà
        function toggleSound() {
            gameState.soundEnabled = !gameState.soundEnabled;
            document.getElementById('soundBtn').textContent = gameState.soundEnabled ? 'üîä' : 'üîá';
        }

        // „Ç≤„Éº„É†‰∏ÄÊôÇÂÅúÊ≠¢
        function pauseGame() {
            if (gameState.gamePhase !== 'typing') return;

            if (!gameState.isPaused) {
                gameState.isPaused = true;
                document.getElementById('pauseBtn').textContent = '‚ñ∂Ô∏è';
                showModal('‚è∏Ô∏è ‰∏ÄÊôÇÂÅúÊ≠¢', `
                    <p>„Ç≤„Éº„É†„Çí‰∏ÄÊôÇÂÅúÊ≠¢„Åó„Åæ„Åó„Åü</p>
                    <button class="btn btn-primary" onclick="resumeGame()">ÂÜçÈñã</button>
                `);
            } else {
                resumeGame();
            }
        }

        // „Ç≤„Éº„É†ÂÜçÈñã
        function resumeGame() {
            gameState.isPaused = false;
            document.getElementById('pauseBtn').textContent = '‚è∏Ô∏è';
            hideModal();
        }

        // „É°„Éã„É•„Éº„Å´Êàª„Çã
        function backToMenu() {
            // „Ç≤„Éº„É†Áä∂ÊÖã„É™„Çª„ÉÉ„Éà
            gameState = {
                mode: null,
                maxHP: 200,
                players: [
                    { name: '„Éó„É¨„Ç§„É§„Éº1', hp: 200, maxHp: 200, avatar: 'üî•', attribute: 'fire' },
                    { name: 'CPU', hp: 200, maxHp: 200, avatar: 'ü§ñ', attribute: 'water' }
                ],
                currentPlayer: 0,
                selectedCard: null,
                hands: [[], []],
                deck: [],
                discard: [],
                timer: 15,
                timerInterval: null,
                gamePhase: 'cardSelect',
                soundEnabled: true,
                isPaused: false,
                stats: {
                    totalChars: 0,
                    correctChars: 0,
                    totalTime: 0,
                    combo: 0,
                    maxCombo: 0
                }
            };
            
            clearInterval(gameState.timerInterval);
            hideModal();
            document.getElementById('gameContainer').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
            document.getElementById('characterSelection').classList.add('hidden');
            document.getElementById('gameRules').classList.add('hidden');
            document.getElementById('player2Setup').classList.add('hidden');
            
            // ÈÅ∏ÊäûÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
            document.querySelectorAll('.mode-btn, .character-btn, .hp-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // „Éá„Éï„Ç©„É´„ÉàHPÈÅ∏Êäû
            document.querySelector('[data-hp="200"]').classList.add('selected');
            
            // ÂêçÂâçÂÖ•Âäõ„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('player1NameInput').value = '„Éó„É¨„Ç§„É§„Éº1';
            document.getElementById('player2NameInput').value = '„Éó„É¨„Ç§„É§„Éº2';
            document.getElementById('nextBtn').disabled = true;
        }

        // „Ç≤„Éº„É†ÂÜçÈñãÂßã
        function restartGame() {
            hideModal();
            
            // HPÂõûÂæ©
            gameState.players.forEach(player => {
                player.hp = player.maxHp;
            });
            
            // Áµ±Ë®à„É™„Çª„ÉÉ„Éà
            gameState.stats = {
                totalChars: 0,
                correctChars: 0,
                totalTime: 0,
                combo: 0,
                maxCombo: 0
            };
            
            gameState.currentPlayer = 0;
            gameState.gamePhase = 'cardSelect';
            
            initGame();
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        document.addEventListener('DOMContentLoaded', function() {
            // „É¢„Éº„ÉÄ„É´„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
            document.getElementById('modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideModal();
                }
            });

            // ÂêçÂâçÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
            document.getElementById('player1NameInput').addEventListener('input', function() {
                gameState.players[0].name = this.value || '„Éó„É¨„Ç§„É§„Éº1';
                checkSetupComplete();
            });

            document.getElementById('player2NameInput').addEventListener('input', function() {
                gameState.players[1].name = this.value || '„Éó„É¨„Ç§„É§„Éº2';
                checkSetupComplete();
            });
        });

        // ÂàùÊúüÂåñ
        console.log('üéÆ „Çø„Ç§„Éî„É≥„Ç∞„Éê„Éà„É´ - Â≠¶Áøí„Ç≤„Éº„É†');
        console.log('üìù „Ç´„Éº„ÉâËøΩÂä†ÊñπÊ≥ï: CARD_POOLÈÖçÂàó„Å´Êñ∞„Åó„ÅÑ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíËøΩÂä†');
        console.log('üé® Â±ûÊÄß„Ç´„Çπ„Çø„Éû„Ç§„Ç∫: CSSÂ§âÊï∞ --attr-color „ÇíÂ§âÊõ¥');
        console.log('üîä Èü≥Â£∞„Ç´„Çπ„Çø„Éû„Ç§„Ç∫: playSoundÈñ¢Êï∞„ÇíÁ∑®ÈõÜ');
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9779edf007c0e005',t:'MTc1NjYxNjA2MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
