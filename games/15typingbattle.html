<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>„Çø„Ç§„Éî„É≥„Ç∞„Éê„Éà„É´ - Â≠¶Áøí„Ç≤„Éº„É†</title>
    <link href="https://fonts.googleapis.com/css2?family=BIZ+UDGothic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ÂÆâÂÖ®È†òÂüüÔºàiPad/iPhone„Éé„ÉÉ„ÉÅÔºâ */
        :root{
            --safe-top: env(safe-area-inset-top);
            --safe-right: env(safe-area-inset-right);
            --safe-bottom: env(safe-area-inset-bottom);
            --safe-left: env(safe-area-inset-left);
        }

        body {
            font-family: 'BIZ UDGothic', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
        }

        .game-container {
            width: 100vw;
            height: calc(var(--vh, 1vh) * 100);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* „Éà„ÉÉ„Éó„Éê„ÉºÔºöÂ∑¶Âè≥„Å´HP„ÄÅ‰∏≠Â§Æ„Å´„Çø„Éº„É≥/„Çø„Ç§„Éû„Éº */
        .top-bar{
            min-height: 80px;
            padding: calc(8px + var(--safe-top)) clamp(12px, 2vw, 24px) 8px clamp(12px, 2vw, 24px);
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.2);

            /* Grid „ÅßÂ∑¶Âè≥Á´Ø„Å´Âõ∫ÂÆö */
            display: grid;
            grid-template-columns: 1fr auto 1fr; /* Â∑¶ HP | ‰∏≠Â§Æ info | Âè≥ HP */
            align-items: center;
            gap: 12px;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 0;          /* Á´Ø„Å´ÂØÑ„Åõ„Çã„Åü„ÇÅÊúÄÂ∞èÂπÖÂà∂Á¥Ñ„ÇíÂ§ñ„Åô */
            justify-self: start;   /* Â∑¶ÂÅ¥„ÅØÂ∑¶Á´Ø„Å∏ */
        }

        .player-info:last-child{
            justify-self: end;     /* Âè≥ÂÅ¥„ÅØÂè≥Á´Ø„Å∏ */
            flex-direction: row-reverse; /* „Ç¢„Ç§„Ç≥„É≥„ÇíÂè≥ÂØÑ„Åõ„ÅÆ„Åæ„Åæ„Å´„Åô„Çã */
        }

        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .player-stats {
            flex: 1;
        }

        .player-name {
            font-weight: 700;
            color: white;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .hp-bar-container {
            width: 200px;
            height: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .hp-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #feca57);
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .hp-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .center-info {
            text-align: center;
            color: white;
            justify-self: center;
        }

        .turn-display {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .phase-display {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .timer-ring {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: conic-gradient(#feca57 0deg, rgba(255, 255, 255, 0.2) 0deg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            color: white;
            margin: 0 auto;
        }

        /* „Ç´„Éº„Éâ„Ç®„É™„Ç¢ */
        .card-area {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
        }

        /* „Éó„É¨„Ç§„É§„Éº„ÅÆÊâãÊú≠„Ç®„É™„Ç¢ÔºàÂ∑¶Âè≥„Å´ÈÖçÁΩÆÔºâ */
        .player-hand {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 100px;
            height: 400px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            z-index: 10;
        }

        .player-hand.left {
            left: 5px;
        }

        .player-hand.right {
            right: 5px;
        }

        .hand-card {
            width: 90px;
            height: 70px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 6px;
            text-align: center;
            font-size: 11px;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transform: translateX(10px);
            opacity: 0.7;
            transition: all 0.3s ease;
        }

        .hand-card:hover {
            transform: translateX(0);
            opacity: 1;
        }

        /* „É°„Ç§„É≥„Ç´„Éº„ÉâË°®Á§∫„Ç®„É™„Ç¢ */
        .main-cards-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            padding: 0 130px; /* Â∑¶Âè≥„ÅÆÊâãÊú≠„Ç®„É™„Ç¢„ÇíÈÅø„Åë„Çã„Åü„ÇÅ„ÅÆ‰ΩôÁôΩ */
        }

        .cards-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            max-width: 800px;
            margin: 0 auto;
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.5s ease;
        }

        .cards-container.active {
            opacity: 1;
            transform: translateY(0);
        }

        .card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(15px);
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* ÊîªÊíÉ„Ç´„Éº„ÉâÔºà„Éá„Éï„Ç©„É´„ÉàÔºâ */
        .card.attack {
            background: linear-gradient(145deg, rgba(255, 107, 107, 0.3), rgba(255, 159, 243, 0.2));
            border: 3px solid rgba(255, 107, 107, 0.5);
            box-shadow: 0 8px 32px rgba(255, 107, 107, 0.2);
        }

        .card.attack:hover {
            border-color: rgba(255, 107, 107, 0.8);
            box-shadow: 0 20px 40px rgba(255, 107, 107, 0.3);
        }

        /* ÂõûÂæ©„Ç´„Éº„Éâ */
        .card.heal {
            background: linear-gradient(145deg, rgba(76, 175, 80, 0.3), rgba(129, 199, 132, 0.2));
            border: 3px solid rgba(76, 175, 80, 0.6);
            box-shadow: 0 8px 32px rgba(76, 175, 80, 0.2);
        }

        .card.heal:hover {
            border-color: rgba(76, 175, 80, 0.9);
            box-shadow: 0 20px 40px rgba(76, 175, 80, 0.4);
        }

        .card.heal .card-text {
            color: #e8f5e8;
        }

        .card.heal .card-difficulty {
            color: #a5d6a7;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        .card:hover::before {
            transform: translateX(100%);
        }

        .card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            border-color: rgba(254, 202, 87, 0.6);
        }

        .card.selected {
            border-color: #feca57;
            box-shadow: 0 0 30px rgba(254, 202, 87, 0.8);
            transform: scale(1.1) translateY(-15px);
            background: linear-gradient(145deg, rgba(254, 202, 87, 0.3), rgba(255, 159, 243, 0.2));
            animation: cardSelect 0.6s ease;
        }

        @keyframes cardSelect {
            0% { transform: scale(1) translateY(0); }
            50% { transform: scale(1.15) translateY(-20px) rotateY(10deg); }
            100% { transform: scale(1.1) translateY(-15px); }
        }

        .card-text {
            font-size: 24px;
            font-weight: 700;
            color: white;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.05em;
            line-height: 1.2;
            word-break: keep-all;
            overflow-wrap: break-word;
            white-space: normal;
            min-height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            max-height: 60px;
            overflow: hidden;
        }

        /* ÊñáÂ≠óÊï∞„Å´Âøú„Åò„Åü„ÉÜ„Ç≠„Çπ„Éà„Çµ„Ç§„Ç∫Ë™øÊï¥ÔºàÊîπË°å„Å™„Åó„ÅßÁµ±‰∏Ä„É¨„Ç§„Ç¢„Ç¶„ÉàÔºâ */
        .card-text.short { font-size: 26px; }      /* 1-3ÊñáÂ≠ó */
        .card-text.medium { font-size: 22px; }     /* 4-6ÊñáÂ≠ó */
        .card-text.long { font-size: 18px; }       /* 7-9ÊñáÂ≠ó */
        .card-text.very-long { font-size: 15px; }  /* 10-12ÊñáÂ≠ó */
        .card-text.extra-long { font-size: 12px; } /* 13ÊñáÂ≠ó‰ª•‰∏ä */

        .card-difficulty {
            font-size: 14px;
            color: #feca57;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            margin-bottom: 5px;
        }

        .card-category {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        /* „Çø„Ç§„Éî„É≥„Ç∞Ë°®Á§∫„Ç®„É™„Ç¢ */
        .typing-display {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px 20px calc(20px + var(--safe-bottom)) 20px;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            max-width: 600px;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
            margin: 15px auto;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #feca57);
            width: 0%;
            transition: width 0.2s ease;
        }

        .keyboard-hint {
            margin-top: 15px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-family: 'BIZ UDGothic', sans-serif;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #feca57, #ff9ff3);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* „Ç≥„É≥„Éà„É≠„Éº„É´„Ç®„É™„Ç¢ */
        .controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* „É¢„Éº„ÉÄ„É´ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            width: 90%;
        }

        .modal h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .modal p {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        /* „ÉÄ„É°„Éº„Ç∏„Ç®„Éï„Çß„ÇØ„Éà */
        .damage-number {
            position: absolute;
            font-size: 32px;
            font-weight: 900;
            color: #ff6b6b;
            pointer-events: none;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 100;
            animation: damageFloat 1.5s ease-out forwards;
        }

        .damage-number.heal {
            color: #4ecdc4;
        }

        @keyframes damageFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(0.5);
            }
            20% {
                transform: translateY(-10px) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translateY(-80px) scale(0.8);
            }
        }

        /* „ÉÄ„É°„Éº„Ç∏Ë®àÁÆó„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó */
        .damage-calculation-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            pointer-events: none;
            animation: calculationPopup 5s ease-out forwards;
        }

        .calculation-content {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px 35px;
            text-align: center;
            border: 3px solid;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            min-width: 300px;
        }

        .calculation-content.attack {
            border-color: #ff6b6b;
            box-shadow: 0 10px 40px rgba(255, 107, 107, 0.3), 0 0 30px rgba(255, 107, 107, 0.2);
        }

        .calculation-content.heal {
            border-color: #4ecdc4;
            box-shadow: 0 10px 40px rgba(76, 224, 196, 0.3), 0 0 30px rgba(76, 224, 196, 0.2);
        }

        .calculation-content.self-damage {
            border-color: #ff9f43;
            box-shadow: 0 10px 40px rgba(255, 159, 67, 0.3), 0 0 30px rgba(255, 159, 67, 0.2);
        }

        .calculation-icon {
            font-size: 40px;
            margin-bottom: 15px;
            animation: iconBounce 0.6s ease-out;
        }

        .calculation-formula {
            font-size: 24px;
            font-weight: 900;
            color: white;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            font-family: 'BIZ UDGothic', sans-serif;
        }

        .calculation-description {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 600;
        }

        @keyframes calculationPopup {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.3) rotateY(-90deg);
            }
            7.5% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1) rotateY(0deg);
            }
            12.5% {
                transform: translate(-50%, -50%) scale(0.95) rotateY(0deg);
            }
            87.5% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1) rotateY(0deg);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1.1) rotateY(90deg);
            }
        }

        @keyframes iconBounce {
            0% {
                transform: scale(0.3) translateY(20px);
            }
            50% {
                transform: scale(1.2) translateY(-10px);
            }
            100% {
                transform: scale(1) translateY(0);
            }
        }

        /* „Çø„Éº„É≥Âàá„ÇäÊõø„Åà„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó */
        .turn-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.9));
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: turnPopup 2.5s ease-in-out forwards;
        }

        .turn-popup-content {
            text-align: center;
            color: white;
            transform: scale(0.5);
            animation: turnContentPop 2.5s ease-in-out forwards;
        }

        .turn-popup h2 {
            font-size: clamp(48px, 8vw, 120px);
            font-weight: 900;
            color: white;
            text-shadow: 4px 4px 8px rgba(0, 0, 0, 0.5);
            margin: 0 0 20px 0;
            background: linear-gradient(45deg, #feca57, #ff9ff3, #4ecdc4);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: textGlow 2.5s ease-in-out infinite;
        }

        .turn-popup-subtitle {
            font-size: clamp(24px, 4vw, 48px);
            font-weight: 700;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            margin: 0;
        }

        @keyframes turnPopup {
            0% {
                opacity: 0;
            }
            15% {
                opacity: 1;
            }
            85% {
                opacity: 1;
            }
            100% {
                opacity: 0;
            }
        }

        @keyframes turnContentPop {
            0% {
                transform: scale(0.3) rotateY(-90deg);
                opacity: 0;
            }
            20% {
                transform: scale(1.2) rotateY(0deg);
                opacity: 1;
            }
            30% {
                transform: scale(0.95) rotateY(0deg);
                opacity: 1;
            }
            80% {
                transform: scale(1) rotateY(0deg);
                opacity: 1;
            }
            100% {
                transform: scale(1.1) rotateY(90deg);
                opacity: 0;
            }
        }

        @keyframes textGlow {
            0%, 100% {
                filter: drop-shadow(0 0 20px rgba(254, 202, 87, 0.5));
            }
            50% {
                filter: drop-shadow(0 0 40px rgba(254, 202, 87, 0.8)) drop-shadow(0 0 60px rgba(255, 159, 243, 0.6));
            }
        }

        /* Â±ûÊÄß„Ç´„É©„Éº */
        .fire { --attr-color: #ff6b6b; }
        .water { --attr-color: #4ecdc4; }
        .thunder { --attr-color: #ffe66d; }
        .wind { --attr-color: #95e1d3; }
        .earth { --attr-color: #a8e6cf; }
        .light { --attr-color: #ffd93d; }

        /* „Ç®„Éï„Çß„ÇØ„Éà„É¨„Ç§„É§„Éº */
        .fx-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 1000;
            overflow: hidden;
        }

        /* ÊîªÊíÉ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Áî®„Çπ„Çø„Ç§„É´ */
        .charge-effect {
            position: absolute;
            border-radius: 50%;
            will-change: transform, opacity;
            contain: layout paint;
        }

        .projectile {
            position: absolute;
            will-change: transform, opacity;
            contain: layout paint;
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            will-change: transform, opacity;
            contain: layout paint;
        }

        .impact-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            will-change: opacity;
        }

        /* Âº∑„ÅÑ„Ç∑„Çß„Ç§„ÇØ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        .shake-strong {
            animation: shakeStrong 0.4s ease-in-out;
        }

        @keyframes shakeStrong {
            0%, 100% { transform: translate3d(0, 0, 0); }
            10% { transform: translate3d(-8px, -4px, 0); }
            20% { transform: translate3d(6px, -8px, 0); }
            30% { transform: translate3d(-6px, 4px, 0); }
            40% { transform: translate3d(8px, 6px, 0); }
            50% { transform: translate3d(-4px, -6px, 0); }
            60% { transform: translate3d(6px, 8px, 0); }
            70% { transform: translate3d(-8px, -2px, 0); }
            80% { transform: translate3d(4px, -8px, 0); }
            90% { transform: translate3d(-6px, 6px, 0); }
        }

        /* Ê∫ú„ÇÅ„Ç®„Éï„Çß„ÇØ„Éà */
        @keyframes chargeGlow {
            0% { 
                transform: scale(1);
                box-shadow: 0 0 10px var(--glow-color);
            }
            50% { 
                transform: scale(1.15);
                box-shadow: 0 0 30px var(--glow-color), 0 0 60px var(--glow-color);
            }
            100% { 
                transform: scale(1.2);
                box-shadow: 0 0 40px var(--glow-color), 0 0 80px var(--glow-color);
            }
        }

        /* ÁÅ´ÁêÉ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes fireball {
            0% { 
                transform: scale(0.5) rotate(0deg);
                opacity: 1;
            }
            100% { 
                transform: scale(1.2) rotate(360deg);
                opacity: 0.8;
            }
        }

        /* Ê∞¥ÂàÉ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes waterBlade {
            0% { 
                transform: scaleX(0) rotate(-15deg);
                opacity: 1;
            }
            100% { 
                transform: scaleX(1) rotate(15deg);
                opacity: 0.9;
            }
        }

        /* Èõ∑„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes lightning {
            0%, 100% { opacity: 0; }
            10%, 30%, 50%, 70%, 90% { opacity: 1; }
            20%, 40%, 60%, 80% { opacity: 0.3; }
        }

        /* È¢®ÂàÉ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes windBlade {
            0% { 
                transform: scale(0) rotate(0deg);
                opacity: 0.8;
            }
            100% { 
                transform: scale(1.5) rotate(180deg);
                opacity: 0.3;
            }
        }

        /* Â≤©Êü±„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes rockSpike {
            0% { 
                transform: scaleY(0) translateY(50px);
                opacity: 1;
            }
            100% { 
                transform: scaleY(1) translateY(0);
                opacity: 0.9;
            }
        }

        /* ÂÖâÁ∑ö„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes lightBeam {
            0% { 
                transform: scaleX(0);
                opacity: 1;
            }
            50% { 
                transform: scaleX(1);
                opacity: 1;
            }
            100% { 
                transform: scaleX(1.2);
                opacity: 0.7;
            }
        }

        /* „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÁàÜÁô∫ */
        @keyframes particleExplode {
            0% { 
                transform: scale(0) translate3d(0, 0, 0);
                opacity: 1;
            }
            100% { 
                transform: scale(1) translate3d(var(--dx), var(--dy), 0);
                opacity: 0;
            }
        }

        /* „É™„ÉÉ„Éó„É´ÂäπÊûú */
        @keyframes ripple {
            0% { 
                transform: scale(0);
                opacity: 0.8;
            }
            100% { 
                transform: scale(3);
                opacity: 0;
            }
        }

        /* „É´„Éº„É¨„ÉÉ„ÉàÊºîÂá∫ */
        .roulette-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2500;
        }

        .roulette-container {
            text-align: center;
            color: white;
            position: relative;
        }

        .roulette-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .roulette-wheel {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(90deg, #ff6b6b 50%, #4ecdc4 50%);
            border: 6px solid #feca57;
            position: relative;
            margin: 0 auto 30px auto;
            box-shadow: 0 0 30px rgba(254, 202, 87, 0.5);
        }

        .roulette-pointer {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-top: 24px solid #feca57;
            z-index: 10;
        }

        .roulette-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background: #feca57;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            border: 3px solid white;
            z-index: 5;
        }

        .player-info-simple {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 400px;
            margin: 0 auto 20px auto;
            gap: 40px;
        }

        .player-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px 20px;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.3);
            min-width: 140px;
        }

        .player-card.left {
            border-color: #ff6b6b;
        }

        .player-card.right {
            border-color: #4ecdc4;
        }

        .player-avatar-simple {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .player-name-simple {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .player-side {
            font-size: 12px;
            opacity: 0.8;
        }

        .roulette-spinning {
            animation: rouletteSpin 2s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
        }

        .roulette-result {
            font-size: 20px;
            font-weight: 700;
            margin-top: 15px;
            opacity: 0;
            animation: resultFadeIn 0.5s ease-out 2.2s forwards;
        }

        @keyframes rouletteSpin {
            0% { transform: rotate(0deg); }
            70% { transform: rotate(1080deg); }
            100% { transform: rotate(var(--final-rotation, 1170deg)); }
        }

        @keyframes resultFadeIn {
            from { 
                opacity: 0;
                transform: translateY(20px) scale(0.8);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* „Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£ÂØæÂøú */
        @media (prefers-reduced-motion: reduce) {
            .shake-strong {
                animation: none;
            }
            
            .impact-flash {
                opacity: 0.3 !important;
            }
            
            @keyframes shakeStrong {
                0%, 100% { transform: translate3d(0, 0, 0); }
            }

            .roulette-spinning {
                animation: rouletteSpinReduced 1s ease-out forwards;
            }

            @keyframes rouletteSpinReduced {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(var(--final-rotation, 180deg)); }
            }
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñË™øÊï¥ */
        @media (max-width: 1024px) {
            .cards-container {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .main-cards-area {
                padding: 0 110px; /* „Çø„Éñ„É¨„ÉÉ„ÉàÁî®„Å´‰ΩôÁôΩ„ÇíÂ∞ë„ÅóÁ∏ÆÂ∞è */
            }
        }

        @media (max-width: 768px) {
            .cards-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .main-cards-area {
                padding: 0 80px; /* „Çπ„Éû„ÉõÁî®„Å´‰ΩôÁôΩ„Çí„Åï„Çâ„Å´Á∏ÆÂ∞è */
            }
            
            .top-bar {
                height: 60px;
                padding: 0 10px;
            }
            
            .player-info {
                min-width: 200px;
            }
            
            .hp-bar-container {
                width: 150px;
            }

            .player-setup-container {
                flex-direction: column;
                gap: 20px;
            }

            .character-selection {
                grid-template-columns: repeat(6, 1fr);
                max-width: 100%;
            }
        }

        @media (max-width: 480px) {
            .main-cards-area {
                padding: 0 60px; /* Â∞è„Åï„Å™„Çπ„Éû„ÉõÁî®„Å´„Åï„Çâ„Å´Á∏ÆÂ∞è */
            }
            
            .player-hand {
                width: 80px; /* ÊâãÊú≠„Ç´„Éº„Éâ„ÇÇÂ∞è„Åï„Åè */
            }
            
            .hand-card {
                width: 70px;
                height: 60px;
                font-size: 10px;
            }
        }

        .hidden {
            display: none !important;
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* ÂïèÈ°å„ÉÜ„Ç≠„Çπ„Éà„ÅÆ‰∏ä‰∏ãÈñìÈöî„ÇÇÂæÆË™øÊï¥ */
        .typing-guide {
            text-align: center;
            color: white;
            margin-bottom: 10px;
            user-select: none;
        }
        .typing-guide .jp {
            font-size: 32px;
            line-height: 1.1;
            letter-spacing: .06em;
            font-weight: 700;
        }
        @media (min-width: 1024px){ .typing-guide .jp { font-size: 40px; } }

        .typing-guide .sub {
            font-size: 14px;
            opacity: .9;
            margin-top: 6px;
            letter-spacing: .08em;
        }

        /* ‰∏äÊÆµÔºöÂ∑¶„Åã„ÇâËâ≤„ÅåÊ∫Ä„Å°„ÇãÔºàÊñáÂ≠óÂçò‰Ωç„Åò„ÇÉ„Å™„Åè"Èù¢"„Åß„Çπ„Éº„ÉÉ„Å®Ôºâ */
        .jp-progress {
            display: inline-block;
            background: linear-gradient(
                90deg,
                #feca57 var(--fill, 0%),
                rgba(255,255,255,.95) var(--fill, 0%)
            );
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            transition: background .12s linear;
        }

        /* ‰∏ãÊÆµÔºö1ÊñáÂ≠ó„Åö„Å§ÁÇπÁÅØ */
        .sub .char { padding: 0 .06em; transition: color .08s, transform .04s; }
        .sub .char.matched { color: #feca57; }
        .sub .char.current { border-bottom: 2px solid #feca57; }
        .sub .char.pending { color: rgba(255,255,255,.85); opacity: .75; }

        /* „É≠„Éº„ÉûÂ≠ó„Ç¨„Ç§„Éâ */
        .romaji-guide {
            text-align: center;
            color: white;
            margin-bottom: 8px;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 0.1em;
            min-height: 40px;
        }

        .romaji-char {
            display: inline-block;
            padding: 0 2px;
            transition: color 0.1s ease;
        }

        .romaji-char.typed {
            color: #feca57;
        }

        .romaji-char.current {
            background: rgba(254, 202, 87, 0.3);
            border-radius: 4px;
        }

        /* „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ */
        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1500;
        }

        .countdown-number {
            font-size: 120px;
            font-weight: 900;
            color: #feca57;
            text-shadow: 0 0 30px rgba(254, 202, 87, 0.5);
            animation: countdownPulse 1s ease-in-out;
        }

        @keyframes countdownPulse {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* „Ç≤„Éº„É†ÈñãÂßãÁîªÈù¢ */
        .start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(var(--vh, 1vh) * 100);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .start-content {
            text-align: center;
            color: white;
        }

        .start-content h1 {
            font-size: 36px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .mode-selection {
            display: flex;
            gap: 40px;
            margin-bottom: 25px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 15px 35px;
            background: rgba(255, 255, 255, 0.2);
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
            text-align: center;
            font-size: 16px;
            font-family: 'BIZ UDGothic', sans-serif;
            outline: none;
        }

        .mode-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .mode-btn.selected {
            background: rgba(254, 202, 87, 0.3);
            border-color: #feca57;
            box-shadow: 0 0 30px rgba(254, 202, 87, 0.5);
        }

        .mode-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .mode-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .mode-desc {
            font-size: 12px;
            opacity: 0.8;
        }

        .player-setup-container {
            display: flex;
            gap: 50px;
            justify-content: center;
            align-items: flex-start;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .player-setup {
            flex: 1;
            max-width: 350px;
            min-width: 300px;
            text-align: center;
        }

        .character-selection {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
            max-width: 280px;
            margin-left: auto;
            margin-right: auto;
        }

        .character-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .character-btn.selected {
            border-color: #feca57;
            box-shadow: 0 0 20px rgba(254, 202, 87, 0.5);
        }

        .name-input {
            width: 280px;
            height: 45px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 22px;
            padding: 0 20px;
            font-size: 17px;
            font-family: 'BIZ UDGothic', sans-serif;
            background: rgba(255, 255, 255, 0.9);
            outline: none;
            margin-bottom: 20px;
            text-align: center;
        }

        .name-input:focus {
            border-color: #feca57;
            box-shadow: 0 0 10px rgba(254, 202, 87, 0.3);
        }

        .rules-content {
            text-align: left;
            max-width: 500px;
            margin: 0 auto;
        }

        .rule-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .rule-icon {
            font-size: 24px;
            min-width: 40px;
        }

        .rule-text h4 {
            margin: 0 0 5px 0;
            font-size: 16px;
            color: #feca57;
        }

        .rule-text p {
            margin: 0;
            line-height: 1.4;
            font-size: 14px;
        }

        .hp-btn {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.2);
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 18px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 140px;
            text-align: center;
            font-family: 'BIZ UDGothic', sans-serif;
            font-size: 15px;
            font-weight: 600;
        }

        .hp-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .hp-btn.selected {
            background: rgba(254, 202, 87, 0.3);
            border-color: #feca57;
            box-shadow: 0 0 25px rgba(254, 202, 87, 0.4);
        }
    </style>
</head>
<body>
    <!-- „Ç≤„Éº„É†ÈñãÂßãÁîªÈù¢ -->
    <div class="start-screen" id="startScreen">
        <div class="start-content">
            <h1>‚öîÔ∏è „Çø„Ç§„Éî„É≥„Ç∞„Éê„Éà„É´</h1>
            <p style="font-size: 16px; margin-bottom: 20px;">Â≠¶Áøí„Åó„Å™„Åå„ÇâÊ•Ω„Åó„Åè„Çø„Ç§„Éî„É≥„Ç∞ÔºÅ</p>
            
            <div class="mode-selection">
                <button type="button" class="mode-btn" id="cpuModeBtn" onclick="selectMode('cpu')">
                    <div class="mode-icon">ü§ñ</div>
                    <div class="mode-title">CPUÊà¶</div>
                    <div class="mode-desc">„Ç≥„É≥„Éî„É•„Éº„Çø„Éº„Å®ÂØæÊà¶</div>
                </button>
                <button type="button" class="mode-btn" id="pvpModeBtn" onclick="selectMode('pvp')">
                    <div class="mode-icon">üë•</div>
                    <div class="mode-title">2‰∫∫ÂØæÊà¶</div>
                    <div class="mode-desc">ÂèãÈÅî„Å®‰∏ÄÁ∑í„Å´ÂØæÊà¶</div>
                </button>
            </div>

            <div id="characterSelection" class="hidden">
                <div class="hp-selection" style="margin-bottom: 25px;">
                    <h3 style="margin-bottom: 15px; font-size: 18px; color: white;">‚ö° ÂàùÊúüHPË®≠ÂÆö</h3>
                    <div class="hp-options" style="display: flex; gap: 25px; justify-content: center; flex-wrap: wrap;">
                        <button class="hp-btn" data-hp="100" onclick="selectHP(100)">
                            <div style="font-size: 18px; margin-bottom: 4px;">üíö</div>
                            <div style="font-size: 16px; font-weight: 700;">100HP</div>
                            <div style="font-size: 12px; opacity: 0.8;">Áü≠ÊúüÊ±∫Êà¶</div>
                        </button>
                        <button class="hp-btn selected" data-hp="200" onclick="selectHP(200)">
                            <div style="font-size: 18px; margin-bottom: 4px;">üíõ</div>
                            <div style="font-size: 16px; font-weight: 700;">200HP</div>
                            <div style="font-size: 12px; opacity: 0.8;">Ê®ôÊ∫ñ</div>
                        </button>
                        <button class="hp-btn" data-hp="300" onclick="selectHP(300)">
                            <div style="font-size: 18px; margin-bottom: 4px;">‚ù§Ô∏è</div>
                            <div style="font-size: 16px; font-weight: 700;">300HP</div>
                            <div style="font-size: 12px; opacity: 0.8;">Èï∑ÊúüÊà¶</div>
                        </button>
                    </div>
                </div>

                <div class="player-setup-container">
                    <div id="player1Setup" class="player-setup">
                        <h3 style="margin-bottom: 15px; font-size: 18px;">„Éó„É¨„Ç§„É§„Éº1„ÅÆË®≠ÂÆö</h3>
                        <input type="text" id="player1NameInput" class="name-input" value="„Éó„É¨„Ç§„É§„Éº1" placeholder="ÂêçÂâç„ÇíÂÖ•Âäõ">
                        <div class="character-selection">
                            <div class="character-btn fire" data-attr="fire" data-player="1" onclick="selectCharacter('fire', 1)">üî•</div>
                            <div class="character-btn water" data-attr="water" data-player="1" onclick="selectCharacter('water', 1)">üíß</div>
                            <div class="character-btn thunder" data-attr="thunder" data-player="1" onclick="selectCharacter('thunder', 1)">‚ö°</div>
                            <div class="character-btn wind" data-attr="wind" data-player="1" onclick="selectCharacter('wind', 1)">üå™Ô∏è</div>
                            <div class="character-btn earth" data-attr="earth" data-player="1" onclick="selectCharacter('earth', 1)">üå±</div>
                            <div class="character-btn light" data-attr="light" data-player="1" onclick="selectCharacter('light', 1)">‚ú®</div>
                        </div>
                    </div>
                    
                    <div id="player2Setup" class="player-setup hidden">
                        <h3 style="margin-bottom: 15px; font-size: 18px;">„Éó„É¨„Ç§„É§„Éº2„ÅÆË®≠ÂÆö</h3>
                        <input type="text" id="player2NameInput" class="name-input" value="„Éó„É¨„Ç§„É§„Éº2" placeholder="ÂêçÂâç„ÇíÂÖ•Âäõ">
                        <div class="character-selection">
                            <div class="character-btn fire" data-attr="fire" data-player="2" onclick="selectCharacter('fire', 2)">üî•</div>
                            <div class="character-btn water" data-attr="water" data-player="2" onclick="selectCharacter('water', 2)">üíß</div>
                            <div class="character-btn thunder" data-attr="thunder" data-player="2" onclick="selectCharacter('thunder', 2)">‚ö°</div>
                            <div class="character-btn wind" data-attr="wind" data-player="2" onclick="selectCharacter('wind', 2)">üå™Ô∏è</div>
                            <div class="character-btn earth" data-attr="earth" data-player="2" onclick="selectCharacter('earth', 2)">üå±</div>
                            <div class="character-btn light" data-attr="light" data-player="2" onclick="selectCharacter('light', 2)">‚ú®</div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="nextBtn" onclick="showGameRules()" style="margin-top: 15px;" disabled>„Ç≤„Éº„É†„ÅÆÈÅä„Å≥Êñπ„ÇíË¶ã„Çã</button>
            </div>
            
            <div id="gameRules" class="hidden">
                <h2 style="margin-bottom: 20px; font-size: 22px;">üìñ „Ç≤„Éº„É†„ÅÆÈÅä„Å≥Êñπ</h2>
                <div class="rules-content">
                    <div class="rule-item">
                        <div class="rule-icon">‚öîÔ∏è</div>
                        <div class="rule-text">
                            <h4>Âü∫Êú¨„É´„Éº„É´</h4>
                            <p>Ë®≠ÂÆö„Åó„ÅüHP„Åß„Çπ„Çø„Éº„Éà„ÄÇÁõ∏Êâã„ÅÆHP„Çí0„Å´„Åó„Åü„ÇâÂãùÂà©ÔºÅ</p>
                        </div>
                    </div>
                    <div class="rule-item">
                        <div class="rule-icon">üìù</div>
                        <div class="rule-text">
                            <h4>„Çø„Ç§„Éî„É≥„Ç∞</h4>
                            <p>ÊâãÊú≠„Åã„Çâ1ÊûöÈÅ∏„Çì„Åß12Áßí‰ª•ÂÜÖ„Å´„É≠„Éº„ÉûÂ≠ó„ÅßÂÖ•Âäõ</p>
                        </div>
                    </div>
                    <div class="rule-item">
                        <div class="rule-icon">üí•</div>
                        <div class="rule-text">
                            <h4>„ÉÄ„É°„Éº„Ç∏</h4>
                            <p>ÊàêÂäüÔºöÊñáÂ≠óÊï∞√óÊÆã„ÇäÊôÇÈñì„Åß„ÉÄ„É°„Éº„Ç∏<br>Â§±ÊïóÔºöÊñáÂ≠óÊï∞√ó5„ÅÆËá™ÂÇ∑„ÉÄ„É°„Éº„Ç∏<br>Êâì„Å°ÈñìÈÅï„ÅàÔºö2Áßí„Éö„Éä„É´„ÉÜ„Ç£</p>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="startGame()" style="margin-top: 20px; font-size: 16px; padding: 12px 30px;">üéÆ „Ç≤„Éº„É†ÈñãÂßãÔºÅ</button>
            </div>

            <div style="margin-top: 20px; font-size: 12px; opacity: 0.8;">
                <p>üì± iPadÊ®™Âêë„Åç„ÅßÊúÄÈÅ©Âåñ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô</p>
                <p>‚å®Ô∏è „É≠„Éº„ÉûÂ≠ó„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàÂÖ®Ëßí„Åß„ÇÇOKÔºèÈï∑Èü≥„ÅØ„Éè„Ç§„Éï„É≥„Äå-„ÄçÔºâ</p>
            </div>
        </div>
    </div>

    <!-- „É°„Ç§„É≥„Ç≤„Éº„É†ÁîªÈù¢ -->
    <div class="game-container hidden" id="gameContainer">
        <!-- „Éà„ÉÉ„Éó„Éê„Éº -->
        <div class="top-bar">
            <div class="player-info">
                <div class="avatar" id="player1Avatar">üî•</div>
                <div class="player-stats">
                    <div class="player-name" id="player1Name">„Éó„É¨„Ç§„É§„Éº1</div>
                    <div class="hp-bar-container">
                        <div class="hp-bar" id="player1HpBar" style="width: 100%;"></div>
                        <div class="hp-text" id="player1HpText">300/300</div>
                    </div>
                </div>
            </div>

            <div class="center-info">
                <div class="turn-display" id="turnDisplay" role="status" aria-live="polite">„Éó„É¨„Ç§„É§„Éº1„ÅÆ„Çø„Éº„É≥</div>
                <div class="phase-display" id="phaseDisplay" role="status" aria-live="polite">„Ç´„Éº„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                <div class="timer-ring" id="timerRing" role="progressbar" aria-valuemin="0" aria-valuemax="12" aria-live="polite">12</div>
            </div>

            <div class="player-info">
                <div class="avatar" id="player2Avatar">ü§ñ</div>
                <div class="player-stats" style="text-align: right;">
                    <div class="player-name" id="player2Name">CPU</div>
                    <div class="hp-bar-container">
                        <div class="hp-bar" id="player2HpBar" style="width: 100%;"></div>
                        <div class="hp-text" id="player2HpText">300/300</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- „Ç´„Éº„Éâ„Ç®„É™„Ç¢ -->
        <div class="card-area">
            <!-- „É°„Ç§„É≥„Ç´„Éº„ÉâÈÅ∏Êäû„Ç®„É™„Ç¢ -->
            <div class="main-cards-area">
                <div class="cards-container" id="cardsContainer">
                    <!-- „Ç´„Éº„Éâ„ÅØÂãïÁöÑÁîüÊàê -->
                </div>
            </div>
        </div>

        <!-- „Çø„Ç§„Éî„É≥„Ç∞„Ç¨„Ç§„ÉâË°®Á§∫„Ç®„É™„Ç¢ -->
        <div class="typing-display">
            <div id="typingGuide" class="typing-guide">
                <div id="typingGuideJP" class="jp jp-progress"></div>
                <div id="typingGuideSub" class="sub"></div>
            </div>
            <div id="romajiGuide" class="romaji-guide" aria-live="polite"></div>
            <div class="progress-bar" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="keyboard-hint">
                <p>‚å®Ô∏è „Ç≠„Éº„Éú„Éº„Éâ„ÅßÁõ¥Êé•ÂÖ•Âäõ | Èï∑Èü≥„ÅØ„Äå-„Äç| ESC„Ç≠„Éº„Åß„ÇÆ„Éñ„Ç¢„ÉÉ„Éó</p>
            </div>
        </div>

        <!-- „Ç≥„É≥„Éà„É≠„Éº„É´ -->
        <div class="controls">
            <button class="control-btn" onclick="showHelp()" title="„Éò„É´„Éó" aria-label="„Éò„É´„Éó">‚ùì</button>
            <button class="control-btn" onclick="toggleSound()" title="Èü≥Èáè" aria-label="Èü≥Èáè" id="soundBtn">üîä</button>
            <button class="control-btn" onclick="pauseGame()" title="‰∏ÄÊôÇÂÅúÊ≠¢" aria-label="‰∏ÄÊôÇÂÅúÊ≠¢" id="pauseBtn">‚è∏Ô∏è</button>
            <button class="control-btn" onclick="backToMenu()" title="„É°„Éã„É•„Éº„Å´Êàª„Çã" aria-label="„É°„Éã„É•„Éº„Å´Êàª„Çã">üè†</button>
        </div>
    </div>

    <!-- „É¢„Éº„ÉÄ„É´ -->
    <div class="modal" id="modal">
        <div class="modal-content" id="modalContent">
            <!-- ÂãïÁöÑ„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
        </div>
    </div>

    <script>
        // iPad/Safari 100vhÂïèÈ°åÂØæÂøú
        function setVh() {
            document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px');
        }
        window.addEventListener('resize', setVh);
        setVh();

        // Â§âÊèõ‰∏≠„Éï„É©„Ç∞ÔºàIMEÔºâ
        let isComposing = false;

        // ÂÖ±ÈÄö„Ç™„Éº„Éá„Ç£„Ç™„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà
        let audioCtx = null;
        function ensureAudio() {
            if (!audioCtx) {
                const Ctx = window.AudioContext || window.webkitAudioContext;
                audioCtx = new Ctx();
            }
        }
        document.addEventListener('pointerdown', () => {
            try {
                ensureAudio();
                audioCtx.resume();
            } catch (e) {}
        }, { once: true, passive: true });

        // IME„Éè„É≥„Éâ„É©„ÉºÈñ¢Êï∞ÔºàÂêçÂâç‰ªò„Åç„ÅßÈáçË§áÁôªÈå≤„ÇíÈò≤„ÅêÔºâ
        function handleCompositionStart() {
            isComposing = true;
        }

        function handleCompositionEnd() {
            setTimeout(() => { isComposing = false; }, 0);
        }

        // „Çø„Ç§„Éî„É≥„Ç∞„Éè„É≥„Éâ„É©„Éº„ÅÆ‰ªò„ÅëÂ§ñ„Åó„É©„ÉÉ„Éë„ÉºÈñ¢Êï∞
        function enableTyping() {
            disableTyping(); // ÂÖà„Å´Â§ñ„ÅôÔºà‰∫åÈáçÁôªÈå≤Èò≤Ê≠¢Ôºâ
            document.addEventListener('keydown', handleKeyPress);
            document.addEventListener('compositionstart', handleCompositionStart);
            document.addEventListener('compositionend', handleCompositionEnd);
        }

        function disableTyping() {
            document.removeEventListener('keydown', handleKeyPress);
            document.removeEventListener('compositionstart', handleCompositionStart);
            document.removeEventListener('compositionend', handleCompositionEnd);
        }

        // ÊîπËâØ„Åï„Çå„ÅüÊó•Êú¨Ë™ûÂá¶ÁêÜÈñ¢Êï∞
        function toHiragana(s){
            if(!s) return '';
            let t = s.normalize('NFKC');
            // „Ç´„Çø„Ç´„Éä‚Üí„Å≤„Çâ„Åå„Å™
            t = t.replace(/[\u30A1-\u30FA\u30FD-\u30FF]/g, ch =>
                String.fromCharCode(ch.charCodeAt(0) - 0x60)
            );
            // Ë®òÂè∑„ÉªÁ©∫ÁôΩÈô§Âéª
            t = t.replace(/[„ÄÅ„ÄÇÔºåÔºé„ÉªÔºÅ!Ôºü?\sÔºàÔºâ()ÔºªÔºΩ\[\]„Äå„Äç„Äé„Äè]/g,'');
            return t;
        }

        // „ÉÄ„É°„Éº„Ç∏Ë®àÁÆóÁî®ÔºöÂ∞èÊñáÂ≠ó„ÇíÂ§ßÊñáÂ≠óÂåñ„Åó„Å¶Ê¶ÇÁÆóÈï∑„Åï„Å´Ôºà„ÇÉ„ÇÖ„Çá‚Üí„ÇÑÁ≠âÔºè„Å£‚Üí„Å§Ôºâ
        function countForDamage(s){
            const h = toHiragana(s)
                .replace(/[„ÅÅ„Ç°]/g,'„ÅÇ').replace(/[„ÅÉ„Ç£]/g,'„ÅÑ').replace(/[„ÅÖ„Ç•]/g,'„ÅÜ')
                .replace(/[„Åá„Çß]/g,'„Åà').replace(/[„Åâ„Ç©]/g,'„Åä')
                .replace(/„ÇÉ/g,'„ÇÑ').replace(/„ÇÖ/g,'„ÇÜ').replace(/„Çá/g,'„Çà')
                .replace(/„Å£/g,'„Å§'); // Èï∑Èü≥„ÇÇ1ÊñáÂ≠ó„Å®„Åó„Å¶„Ç´„Ç¶„É≥„Éà
            return h.length;
        }

        // Ê≠£Ë¶èÂåñÂæå„ÅÆÊñáÂ≠óÊï∞„Çí‰Ωø„ÅÜÔºà„ÉÄ„É°„Éº„Ç∏/Ëá™ÂÇ∑/Áµ±Ë®à„ÅØ„Åì„Çå„ÅßÁµ±‰∏ÄÔºâ
        const countChars = (s) => countForDamage(s);

        /* =========================================================
           „É≠„Éº„ÉûÂ≠óÔºöË§áÊï∞Ë°®Ë®òÂØæÂøúÔºà‰øÉÈü≥/ÊãóÈü≥/„Çì/‰ª£ÊõøË°®Ë®òÔºâ
        ========================================================= */


        // Êã°Âºµ„Éô„Éº„ÇπÊñáÂ≠ó
        const BASE = {
            '„ÅÇ':['a'],'„ÅÑ':['i'],'„ÅÜ':['u'],'„Åà':['e'],'„Åä':['o'],
            '„Åã':['ka'],'„Åç':['ki'],'„Åè':['ku'],'„Åë':['ke'],'„Åì':['ko'],
            '„Åå':['ga'],'„Åé':['gi'],'„Åê':['gu'],'„Åí':['ge'],'„Åî':['go'],
            '„Åï':['sa'],'„Åó':['shi','si'],'„Åô':['su'],'„Åõ':['se'],'„Åù':['so'],
            '„Åñ':['za'],'„Åò':['ji','zi'],'„Åö':['zu'],'„Åú':['ze'],'„Åû':['zo'],
            '„Åü':['ta'],'„Å°':['chi','ti'],'„Å§':['tsu','tu'],'„Å¶':['te'],'„Å®':['to'],
            '„Å†':['da'],'„Å¢':['ji','di'],'„Å•':['zu','du'],'„Åß':['de'],'„Å©':['do'],
            '„Å™':['na'],'„Å´':['ni'],'„Å¨':['nu'],'„Å≠':['ne'],'„ÅÆ':['no'],
            '„ÅØ':['ha'],'„Å≤':['hi'],'„Åµ':['fu','hu'],'„Å∏':['he'],'„Åª':['ho'],
            '„Å∞':['ba'],'„Å≥':['bi'],'„Å∂':['bu'],'„Åπ':['be'],'„Åº':['bo'],
            '„Å±':['pa'],'„Å¥':['pi'],'„Å∑':['pu'],'„Å∫':['pe'],'„ÅΩ':['po'],
            '„Åæ':['ma'],'„Åø':['mi'],'„ÇÄ':['mu'],'„ÇÅ':['me'],'„ÇÇ':['mo'],
            '„ÇÑ':['ya'],'„ÇÜ':['yu'],'„Çà':['yo'],
            '„Çâ':['ra'],'„Çä':['ri'],'„Çã':['ru'],'„Çå':['re'],'„Çç':['ro'],
            '„Çè':['wa'],'„Çê':['wi'],'„Çë':['we'],'„Çí':['wo','o'],
            '„Çì':['n','nn'],
            '„ÅÅ':['xa','la','a'],'„ÅÉ':['xi','li','i'],'„ÅÖ':['xu','lu','u'],'„Åá':['xe','le','e'],'„Åâ':['xo','lo','o'],
            '„Å£':['*sokuon*'], // ÁâπÊÆä
            '„Éº':['-'],   // Èï∑Èü≥Ë®òÂè∑„ÅØ„Éè„Ç§„Éï„É≥„ÅßÂÖ•Âäõ
            '„Çî':['vu'] // ËøΩÂä†
        };

        // Êã°ÂºµÊãóÈü≥ÔºàÂ≠¶ÁøíÁî®„Å´Êï¥ÁêÜÔºöHepburn‰∏≠ÂøÉÔºâ
const YOON = {
  '„Åç„ÇÉ':['kya'], '„Åç„ÇÖ':['kyu'], '„Åç„Çá':['kyo'],
  '„Åé„ÇÉ':['gya'], '„Åé„ÇÖ':['gyu'], '„Åé„Çá':['gyo'],
  '„Åó„ÇÉ':['sha','sya'], '„Åó„ÇÖ':['shu','syu'], '„Åó„Çá':['sho','syo'],
  '„Åò„ÇÉ':['ja','jya','zya'], '„Åò„ÇÖ':['ju','jyu','zyu'], '„Åò„Çá':['jo','jyo','zyo'],
  '„Å°„ÇÉ':['cha','cya'], '„Å°„ÇÖ':['chu','cyu'], '„Å°„Çá':['cho','cyo'],
  '„Å´„ÇÉ':['nya'], '„Å´„ÇÖ':['nyu'], '„Å´„Çá':['nyo'],
  '„Å≤„ÇÉ':['hya'], '„Å≤„ÇÖ':['hyu'], '„Å≤„Çá':['hyo'],
  '„Å≥„ÇÉ':['bya'], '„Å≥„ÇÖ':['byu'], '„Å≥„Çá':['byo'],
  '„Å¥„ÇÉ':['pya'], '„Å¥„ÇÖ':['pyu'], '„Å¥„Çá':['pyo'],
  '„Åø„ÇÉ':['mya'], '„Åø„ÇÖ':['myu'], '„Åø„Çá':['myo'],
  '„Çä„ÇÉ':['rya'], '„Çä„ÇÖ':['ryu'], '„Çä„Çá':['ryo'],

  '„Çî„ÅÅ':['va'], '„Çî„ÅÉ':['vi'], '„Çî„Åá':['ve'], '„Çî„Åâ':['vo'], '„Çî„ÇÖ':['vyu'],

  // ‚òÖ„Åì„Åì„Åå„Éù„Ç§„É≥„ÉàÔºö„Åµ„ÅÅÁ≥ª„ÅØ f + a/i/e/o/y „ÇíÂõ∫ÂÆö
  '„Åµ„ÅÅ':['fa'], '„Åµ„ÅÉ':['fi'], '„Åµ„Åá':['fe'], '„Åµ„Åâ':['fo'], '„Åµ„ÇÖ':['fyu'],

  '„Åó„Åá':['she'], '„Åò„Åá':['je'], '„Å°„Åá':['che'],

  '„Å¶„ÅÉ':['ti'], '„Åß„ÅÉ':['di'], '„Å®„ÅÖ':['tu'], '„Å©„ÅÖ':['du'],

  // „ÅÜ„ÅÉ/„ÅÜ„Åá/„ÅÜ„Åâ „ÅØ wi/we/wo „Å´Áµ±‰∏ÄÔºàui/ue/uo „ÅØÂâäÈô§Ôºâ
  '„ÅÜ„ÅÉ':['wi'], '„ÅÜ„Åá':['we'], '„ÅÜ„Åâ':['wo'],

  '„Å§„ÅÅ':['tsa'], '„Å§„ÅÉ':['tsi'], '„Å§„Åá':['tse'], '„Å§„Åâ':['tso']
};


        // ÊñáÂ≠óÂàó‚Üí„Éà„Éº„ÇØ„É≥ÔºàÊãóÈü≥„Çí1„Éà„Éº„ÇØ„É≥ÂåñÔºâ
        function tokenize(h){
            const arr=[...h]; const out=[];
            for(let i=0;i<arr.length;i++){
                const ch=arr[i], nx=arr[i+1];
                if(nx && ['„ÇÉ','„ÇÖ','„Çá'].includes(nx) && YOON[ch+nx]){
                    out.push(ch+nx); i++;
                }else{
                    out.push(ch);
                }
            }
            return out;
        }

        // Ê¨°„Éà„Éº„ÇØ„É≥„ÅÆÂÖàÈ†≠Â≠êÈü≥/ÊØçÈü≥„ÇíÂæó„ÇãÔºà„Çì„ÅÆÊâ±„ÅÑÂà§ÂÆöÁî®Ôºâ
        function initialsOfToken(tok){
            let opts = romajiOfToken(tok);
            return new Set(opts.map(o=>o[0]||''));
        }

        // Âçò‰∏Ä„Éà„Éº„ÇØ„É≥„ÅÆ„É≠„Éº„ÉûÂ≠óÂÄôË£ú„ÇíÂèñÂæó
        function romajiOfToken(tok){
            if(YOON[tok]) return YOON[tok].slice();
            if(tok==='„Éº') return ['-']; // Èï∑Èü≥„ÅØÂøÖÈ†à
            if(BASE[tok]) return BASE[tok].slice();
            return [tok]; // Êú™Áü•„ÅØ„Åù„ÅÆ„Åæ„Åæ
        }

        // ÊúÄÈÅ©Âåñ„Åï„Çå„ÅüÂÄôË£úÂàóÊåôÔºà‰∏äÈôê„Å®ÊûùÂàà„Çä‰ªò„ÅçÔºâ
        function buildRomajiOptions(h){
            const MAX_OPTIONS = 128;
            const tokens = tokenize(h);
            const results = [];
            let bestFound = Infinity; // ÊúÄÁü≠Èï∑„ÇíËøΩË∑°
            
            function dfs(i, acc){
                // Êó©ÊúüÁµÇ‰∫ÜÊù°‰ª∂
                if (results.length >= MAX_OPTIONS) return;
                if (acc.length > bestFound + 3) return; // ÊûùÂàà„Çä
                
                if(i >= tokens.length){ 
                    results.push(acc);
                    bestFound = Math.min(bestFound, acc.length);
                    return;
                }
                
                const t = tokens[i];

                if(t === '„Å£'){ // ‰øÉÈü≥
                    if(i+1 < tokens.length){
                        const nextOpts = romajiOfToken(tokens[i+1]);
                        // Ê¨°„ÅÆÈ†≠Â≠êÈü≥„ÇíÈáç„Å≠„ÇãÔºàch „ÅÆ„Å®„Åç„ÅØ tch / cch ‰∏°ÊñπË®±ÂÆπÔºâ
                        nextOpts.forEach(no=>{
                            if(!no) return;
                            const head = no.startsWith('ch') ? ['t','c'] : [no[0]];
                            head.forEach(hc=>{
                                if(/[a-z]/.test(hc)) dfs(i+1, acc + hc); // ‰øÉÈü≥„ÇíÂâçÁΩÆ
                            });
                        });
                        return; // ‰øÉÈü≥Ëá™‰Ωì„ÅØÊñáÂ≠ó„ÇíÊ∂àË≤ª„Åó„ÄÅÊ¨°„Å∏
                    }else{
                        // Ë™ûÊú´„ÅÆ„Å£ „ÅØÁÑ°Ë¶ñ
                        dfs(i+1, acc);
                        return;
                    }
                }

                if(t === '„Çì'){
                    // Ê¨°„ÅÆÈ†≠„ÅåÊØçÈü≥/ y „Å™„Çâ nn or n'„ÄÅ„Åù„Çå‰ª•Â§ñ„Åß„ÇÇ nn „ÇíË®±ÂèØ
                    const nextHead = (i+1 < tokens.length)? Array.from(initialsOfToken(tokens[i+1])) : [];
                    const vowelOrY = nextHead.some(c=>['a','i','u','e','o','y'].includes(c));
                    const labial = nextHead.some(c=>['b','m','p'].includes(c));
                    const cand = [];
                    if (vowelOrY) {
                        cand.push("nn", "n'");
                    } else {
                        cand.push("n", "nn");
                        if (labial) cand.push("m"); // ‰æã: „Åó„Çì„Å±„ÅÑ ‚Üí shimpai
                    }
                    cand.forEach(r=>dfs(i+1, acc+r));
                    return;
                }

                // ÈÄöÂ∏∏
                const opts = romajiOfToken(t);
                opts.forEach(o=>dfs(i+1, acc+o));
            }
            
            dfs(0,'');
            
            // ÈáçË§áÈô§Âéª„Å®Èï∑„Åï„Éï„Ç£„É´„Çø
            const uniqueResults = Array.from(new Set(results));
            
            // bestFound+2 ÊñáÂ≠ó‰ª•ÂÜÖ„ÅÆÂÄôË£ú„Å†„Åë„ÇíÊÆã„Åô
            if (bestFound !== Infinity) {
                return uniqueResults.filter(result => result.length <= bestFound + 2);
            }
            
            return uniqueResults;
        }

        // „Å≤„Çâ„Åå„Å™ÊñáÂ≠óÂàó„Çí„É≠„Éº„ÉûÂ≠ó„Å´Â§âÊèõÔºàÊúÄÁü≠ÂÄôË£ú„Çí‰ΩøÁî®Ôºâ
        function hiraganaToRomaji(hiragana) {
            const options = buildRomajiOptions(hiragana);
            // ÊúÄÁü≠„ÅÆ„ÇÇ„ÅÆ„ÇíÈÅ∏ÊäûÔºàÈÄöÂ∏∏„ÅØÊúÄ„ÇÇ‰∏ÄËà¨ÁöÑÔºâ
            return options.reduce((shortest, current) => 
                current.length < shortest.length ? current : shortest, options[0] || '');
        }

        // „Ç¨„Ç§„ÉâÂàùÊúüÂåñÔºö„Ç´„Éº„ÉâÈÅ∏ÊäûÁõ¥Âæå„Å´Âëº„Å∂ÔºàË§áÊï∞ÂÄôË£úÂØæÂøúÔºâ
        function setupTypingGuide(targetText) {
            const jpEl = document.getElementById('typingGuideJP');
            const subEl = document.getElementById('typingGuideSub');
            const romajiEl = document.getElementById('romajiGuide');
            const norm = toHiragana(targetText);

            // ‰∏äÊÆµ„ÅØ"ÂéüÊñá„Åù„ÅÆ„Åæ„Åæ"„ÇíË°®Á§∫ÔºàËâ≤„ÅØÈù¢„ÅßÈÄ≤ÊçóÔºâ
            jpEl.style.setProperty('--fill', '0%');
            jpEl.textContent = targetText;

            // ‰∏ãÊÆµ„ÅØÂà§ÂÆöÁî®„ÅÆ"„Å≤„Çâ„Åå„Å™"„Çí1ÊñáÂ≠ó„Åö„Å§„Çπ„Éë„É≥Âåñ„Åó„Å¶ÁÇπÁÅØ
            subEl.innerHTML = '';
            [...norm].forEach((ch, i) => {
                const span = document.createElement('span');
                span.className = 'char pending';
                span.dataset.index = i;
                span.textContent = ch;
                subEl.appendChild(span);
            });

            // Ë§áÊï∞„ÅÆ„É≠„Éº„ÉûÂ≠óÂÄôË£ú„ÇíÂèñÂæó
            const romajiOptions = buildRomajiOptions(norm);
            typingState.targetOptions = romajiOptions;
            typingState.currentInputs = romajiOptions.map(() => ({
                position: 0,
                typed: '',
                completed: false
            }));
            typingState.typedKeys = '';

            // ÊúÄÁü≠ÂÄôË£ú„Çí„Ç¨„Ç§„Éâ„Å®„Åó„Å¶Ë°®Á§∫
            const displayRomaji = romajiOptions.reduce((shortest, current) => 
                current.length < shortest.length ? current : shortest, romajiOptions[0] || '');

            romajiEl.innerHTML = '';
            [...displayRomaji].forEach((char, i) => {
                const span = document.createElement('span');
                span.className = 'romaji-char';
                span.dataset.index = i;
                span.textContent = char;
                romajiEl.appendChild(span);
            });

            // ÊúÄÂàù„ÅÆÊñáÂ≠ó„Çí„Éè„Ç§„É©„Ç§„Éà
            if (displayRomaji.length > 0) {
                romajiEl.children[0].classList.add('current');
            }
            
            // ÊúÄÈÅ©„Å™ÂÄôË£ú„Åß„Ç¨„Ç§„Éâ„ÇíÊõ¥Êñ∞
            refreshRomajiGuideToLeader();
        }

        // ÈÄ≤ÊçóÊõ¥Êñ∞ÔºöË§áÊï∞ÂÄôË£úÂØæÂøú
        function updateTypingGuideProgress() {
            if (!gameState.selectedCard) return;
            const jpEl  = document.getElementById('typingGuideJP');
            const subEl = document.getElementById('typingGuideSub');

            const target = gameState.selectedCard.text;
            const normTarget = toHiragana(target);
            
            // ÊúÄ„ÇÇÈÄ≤„Çì„Åß„ÅÑ„ÇãÂÄôË£ú„ÅÆÈÄ≤Êçó„Çí‰ΩøÁî®
            let maxProgress = 0;
            let maxPosition = 0;
            
            typingState.currentInputs.forEach((input, index) => {
                const targetLength = typingState.targetOptions[index].length;
                if (targetLength > 0) {
                    const progress = input.position / targetLength;
                    if (progress > maxProgress) {
                        maxProgress = progress;
                        maxPosition = input.position;
                    }
                }
            });
            
            const hiraganaMatched = Math.floor(maxProgress * normTarget.length);
            const fill = Math.max(0, Math.min(100, maxProgress * 100));
            jpEl.style.setProperty('--fill', `${fill}%`);

            // „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„ÅØÈùûË°®Á§∫

            // ‰∏ãÊÆµ„Çí1ÊñáÂ≠ó„Åö„Å§ÁÇπÁÅØ
            const chars = subEl.querySelectorAll('.char');
            chars.forEach((el, i) => {
                el.classList.remove('matched','current','pending');
                if (i < hiraganaMatched) el.classList.add('matched');
                else if (i === hiraganaMatched && maxProgress < 1) el.classList.add('current');
                else el.classList.add('pending');
            });
        }

        // „Çø„Ç§„Éî„É≥„Ç∞Ë°®Á§∫„Çí„ÇØ„É™„Ç¢
        function clearTypingDisplay() {
            const jpEl = document.getElementById('typingGuideJP');
            const subEl = document.getElementById('typingGuideSub');
            const romajiEl = document.getElementById('romajiGuide');
            
            // ÂÖ®„Å¶„ÅÆË°®Á§∫„Çí„ÇØ„É™„Ç¢
            jpEl.textContent = '';
            jpEl.style.setProperty('--fill', '0%');
            subEl.innerHTML = '';
            romajiEl.innerHTML = '';
            
            // „Çø„Ç§„Éî„É≥„Ç∞Áä∂ÊÖã„ÇÇ„É™„Çª„ÉÉ„Éà
            typingState.targetOptions = [];
            typingState.currentInputs = [];
            typingState.typedKeys = '';
        }

        // ---- È´òÁ≤æÂ∫¶„Çø„Ç§„Éû„ÉºÔºà„Éâ„É™„Éï„ÉàË£úÊ≠£‰ªò„ÅçÔºâ ----
        let timerRaf = null;
        let timerDeadline = 0;       // performance.now() „ÅÆÁµ∂ÂØæÊôÇÂàª
        let timerTotalMs = 12000;    // Ë°®Á§∫Áî®„ÅÆÂêàË®àÊôÇÈñì

        function updateTimerRingUI(msLeft){
            const ring = document.getElementById('timerRing');
            const clamped = Math.max(0, msLeft);
            const sec = Math.ceil(clamped / 1000);
            const prog = Math.max(0, Math.min(1, clamped / timerTotalMs));
            const deg = prog * 360;
            ring.textContent = sec;
            ring.style.background =
                `conic-gradient(#feca57 ${deg}deg, rgba(255,255,255,0.2) ${deg}deg)`;
            // „Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£ÂØæÂøú
            ring.setAttribute('aria-valuenow', sec);
        }

        function tickTimer(){
            const now = performance.now();
            const msLeft = timerDeadline - now;
            updateTimerRingUI(msLeft);
            if (msLeft <= 0){
                stopTimer();
                timeUp();  // Êó¢Â≠ò„ÅÆÈñ¢Êï∞„Çí„Åù„ÅÆ„Åæ„ÅæÂëº„Å∂
                return;
            }
            timerRaf = requestAnimationFrame(tickTimer);
        }

        function startAccurateTimer(ms = 12000){
            stopTimer();
            timerTotalMs = ms;
            timerDeadline = performance.now() + ms;
            updateTimerRingUI(ms);
            timerRaf = requestAnimationFrame(tickTimer);
        }

        function adjustTimer(deltaMs){
            // „Éö„Éä„É´„ÉÜ„Ç£„Å™„Å©ÔºöÁ∑†Âàá„ÇíÂâçÂæå„Åï„Åõ„Çã
            timerDeadline = Math.max(performance.now(), timerDeadline + deltaMs);
        }

        function stopTimer(){
            if (timerRaf){ cancelAnimationFrame(timerRaf); timerRaf = null; }
        }

        // „Ç≤„Éº„É†Áä∂ÊÖã
        let gameState = {
            mode: null, // 'cpu' or 'pvp'
            maxHP: 200, // „Éá„Éï„Ç©„É´„ÉàHP
            players: [
                { name: '„Éó„É¨„Ç§„É§„Éº1', hp: 200, maxHp: 200, avatar: 'üî•', attribute: 'fire' },
                { name: 'CPU', hp: 200, maxHp: 200, avatar: 'ü§ñ', attribute: 'water' }
            ],
            currentPlayer: 0,
            selectedCard: null,
            hands: [[], []],
            deck: [],
            discard: [],
            timer: 15,
            timerInterval: null,
            gamePhase: 'cardSelect', // 'cardSelect', 'typing', 'result'
            soundEnabled: true,
            isPaused: false,
            playerStats: [
                { totalChars: 0, correctChars: 0, totalTime: 0, combo: 0, maxCombo: 0 },
                { totalChars: 0, correctChars: 0, totalTime: 0, combo: 0, maxCombo: 0 }
            ],
            stats: {
                totalChars: 0,
                correctChars: 0,
                totalTime: 0,
                combo: 0,
                maxCombo: 0
            }
        };

        // „Ç´„Éº„Éâ„Éó„Éº„É´ÔºàÂÆüÁî®ÁöÑ„Å™„Çø„Ç§„Éî„É≥„Ç∞Á∑¥ÁøíÁî®Ôºâ
        const CARD_POOL = [
            // 2ÊñáÂ≠ó„ÅÆÂçòË™ûÔºàÂàùÁ¥ö„Éª20ÂïèÔºâ
            { text: '„Å≠„Åì', difficulty: 1, category: '„Å©„ÅÜ„Å∂„Å§' },
            { text: '„ÅÑ„Å¨', difficulty: 1, category: '„Å©„ÅÜ„Å∂„Å§' },
            { text: '„Åô„Åó', difficulty: 1, category: '„Åü„Åπ„ÇÇ„ÅÆ' },
            { text: '„Åù„Çâ', difficulty: 1, category: '„Åó„Åú„Çì' },
            { text: '„ÇÑ„Åæ', difficulty: 1, category: '„Åó„Åú„Çì' },
            { text: '„Åã„Çè', difficulty: 1, category: '„Åó„Åú„Çì' },
            { text: '„ÅØ„Å™', difficulty: 1, category: '„Åó„Åú„Çì' },
            { text: '„Åø„Åö', difficulty: 1, category: '„Åó„Åú„Çì' },
            { text: '„ÇÜ„Åç', difficulty: 1, category: '„Åó„Åú„Çì' },
            { text: '„Å§„Åç', difficulty: 1, category: '„Åó„Åú„Çì' },
            { text: '„Åã„Åï', difficulty: 1, category: '„ÇÇ„ÅÆ' },
            { text: '„ÅÜ„Åø', difficulty: 1, category: '„Åó„Åú„Çì' },
            { text: '„ÅÇ„ÇÅ', difficulty: 1, category: '„Åó„Åú„Çì' },
            { text: '„Åª„Åó', difficulty: 1, category: '„Åó„Åú„Çì' },
            { text: '„Åã„Å´', difficulty: 1, category: '„Å©„ÅÜ„Å∂„Å§' },
            { text: '„Åï„Çã', difficulty: 1, category: '„Å©„ÅÜ„Å∂„Å§' },
            { text: '„ÇÇ„Çä', difficulty: 1, category: '„Åó„Åú„Çì' },
            { text: '„Åè„ÇÇ', difficulty: 1, category: '„Åó„Åú„Çì' },
            { text: '„Åø„Å°', difficulty: 1, category: '„ÇÇ„ÅÆ' },
            { text: '„Åã„Åú', difficulty: 1, category: '„Åó„Åú„Çì' },
            
            // 3ÊñáÂ≠ó„ÅÆÂçòË™ûÔºà‰∏≠Á¥ö„Éª20ÂïèÔºâ
            { text: '„Åü„Åæ„Åî', difficulty: 2, category: '„Åü„Åπ„ÇÇ„ÅÆ' },
            { text: '„Åè„Çã„Åæ', difficulty: 2, category: '„ÅÆ„Çä„ÇÇ„ÅÆ' },
            { text: '„Åç„Å§„Å≠', difficulty: 2, category: '„Å©„ÅÜ„Å∂„Å§' },
            { text: '„ÅÜ„Åï„Åé', difficulty: 2, category: '„Å©„ÅÜ„Å∂„Å§' },
            { text: '„Åï„Åã„Å™', difficulty: 2, category: '„Å©„ÅÜ„Å∂„Å§' },
            { text: '„Åç„ÅÆ„Åì', difficulty: 2, category: '„Åó„Åú„Çì' },
            { text: '„Åø„Åã„Çì', difficulty: 2, category: '„Åü„Åπ„ÇÇ„ÅÆ' },
            { text: '„Çä„Çì„Åî', difficulty: 2, category: '„Åü„Åπ„ÇÇ„ÅÆ' },
            { text: '„Åà„Åª„Çì', difficulty: 2, category: '„ÇÇ„ÅÆ' },
            { text: '„Å®„Åë„ÅÑ', difficulty: 2, category: '„ÇÇ„ÅÆ' },
            { text: '„Åã„Å∞„Çì', difficulty: 2, category: '„ÇÇ„ÅÆ' },
            { text: '„Åä„Åµ„Çç', difficulty: 2, category: '„ÇÇ„ÅÆ' },
            { text: '„Åì„Å©„ÇÇ', difficulty: 2, category: '„Å≤„Å®' },
            { text: '„Åß„Çì„Åç', difficulty: 2, category: '„ÇÇ„ÅÆ' },
            { text: '„Åô„Åö„ÇÅ', difficulty: 2, category: '„Å©„ÅÜ„Å∂„Å§' },
            { text: '„Åä„Å°„ÇÉ', difficulty: 2, category: '„Åü„Åπ„ÇÇ„ÅÆ' },
            { text: '„ÇÑ„Åï„ÅÑ', difficulty: 2, category: '„Åü„Åπ„ÇÇ„ÅÆ' },
            { text: '„ÅÇ„Åï„Å≤', difficulty: 2, category: '„Åó„Åú„Çì' },
            { text: '„Åô„ÅÑ„Åã', difficulty: 2, category: '„Åü„Åπ„ÇÇ„ÅÆ' },
            { text: '„Åä„Åã„Åó', difficulty: 2, category: '„Åü„Åπ„ÇÇ„ÅÆ' },

            // 4ÊñáÂ≠ó„ÅÆÂçòË™ûÔºà‰∏äÁ¥ö„Éª20ÂïèÔºâ
            { text: '„Å≤„Åì„ÅÜ„Åç', difficulty: 3, category: '„ÅÆ„Çä„ÇÇ„ÅÆ' },
            { text: '„Åß„Çì„Åó„ÇÉ', difficulty: 3, category: '„ÅÆ„Çä„ÇÇ„ÅÆ' },
            { text: '„Åä„Å´„Åé„Çä', difficulty: 3, category: '„Åü„Åπ„ÇÇ„ÅÆ' },
            { text: '„Å´„Çè„Å®„Çä', difficulty: 3, category: '„Å©„ÅÜ„Å∂„Å§' },
            { text: '„Åõ„Çì„Åõ„ÅÑ', difficulty: 3, category: '„Å≤„Å®' },
            { text: '„ÅÇ„Åï„Åå„Åä', difficulty: 3, category: '„Åó„Åú„Çì' },
            { text: '„Åü„ÅÑ„Çà„ÅÜ', difficulty: 3, category: '„Åó„Åú„Çì' },
            { text: '„ÇÑ„Åç„Åù„Å∞', difficulty: 3, category: '„Åü„Åπ„ÇÇ„ÅÆ' },
            { text: '„Åà„Çì„Å¥„Å§', difficulty: 3, category: '„ÇÇ„ÅÆ' },
            { text: '„ÅÜ„Çè„Å∞„Åç', difficulty: 3, category: '„ÇÇ„ÅÆ' },
            { text: '„Åè„Å§„Åó„Åü', difficulty: 3, category: '„ÇÇ„ÅÆ' },
            { text: '„Åì„Åè„Å∞„Çì', difficulty: 3, category: '„ÇÇ„ÅÆ' },
            { text: '„Åõ„Çì„Åü„Åè', difficulty: 3, category: '„Åõ„ÅÑ„Åã„Å§' },
            { text: '„Åü„ÅÑ„ÅÑ„Åè', difficulty: 3, category: '„Åå„Åè„Åó„ÇÖ„ÅÜ' },
            { text: '„Åì„ÅÜ„Åà„Çì', difficulty: 3, category: '„Å∞„Åó„Çá' },
            { text: '„Å©„Çà„ÅÜ„Å≥', difficulty: 3, category: '„Å´„Å°„Åò' },
            { text: '„Åã„Çà„ÅÜ„Å≥', difficulty: 3, category: '„Å´„Å°„Åò' },
            { text: '„Å´„Å°„Çà„ÅÜ', difficulty: 3, category: '„Å´„Å°„Åò' },
            { text: '„Åñ„Å∂„Å®„Çì', difficulty: 3, category: '„ÇÇ„ÅÆ' },
            { text: '„Åù„ÅÜ„Åò„Åç', difficulty: 3, category: '„ÇÇ„ÅÆ' },
            
            // 5„Äú6ÊñáÂ≠ó„ÅÆÂçòË™ûÔºà‰∏äÁ¥ö„Éª30ÂïèÔºâ
            { text: '„Åó„Çì„Åã„Çì„Åõ„Çì', difficulty: 4, category: '„ÅÆ„Çä„ÇÇ„ÅÆ' },
            { text: '„Åä„Åπ„Çì„Å®„ÅÜ', difficulty: 4, category: '„Åü„Åπ„ÇÇ„ÅÆ' },
            { text: '„Åü„ÅÑ„Çà„ÅÜ„Åë„ÅÑ', difficulty: 4, category: '„Åó„Åú„Çì' },
            { text: '„Åç„Çá„ÅÜ„Åó„Å§', difficulty: 4, category: '„Å∞„Åó„Çá' },
            { text: '„Å©„ÅÜ„Å∂„Å§„Åà„Çì', difficulty: 4, category: '„Å∞„Åó„Çá' },
            { text: '„Åô„ÅÑ„Åû„Åè„Åã„Çì', difficulty: 4, category: '„Å∞„Åó„Çá' },
            { text: '„Åä„Çì„Åå„Åè„Åó„Å§', difficulty: 4, category: '„Å∞„Åó„Çá' },
            { text: '„ÅÇ„Åï„Åî„ÅØ„Çì', difficulty: 4, category: '„Åü„Åπ„ÇÇ„ÅÆ' },
            { text: '„Åà„ÅÑ„Åå„Åã„Çì', difficulty: 4, category: '„Å∞„Åó„Çá' },
            { text: '„Åæ„Åª„ÅÜ„Å§„Åã„ÅÑ', difficulty: 4, category: '„Éï„Ç°„É≥„Çø„Ç∏„Éº' },
            { text: '„Åª„ÅÑ„Åè„Åó„Å§', difficulty: 4, category: '„Å∞„Åó„Çá' },
            { text: '„Å¶„Åå„Åø„Å∞„Åì', difficulty: 4, category: '„ÇÇ„ÅÆ' },
            { text: '„Åï„Åè„Çâ„Åæ„Å§„Çä', difficulty: 4, category: '„Ç§„Éô„É≥„Éà' },
            { text: '„Åã„Çì„Åì„ÅÜ„Éê„Çπ', difficulty: 4, category: '„ÅÆ„Çä„ÇÇ„ÅÆ' },
            { text: '„ÅÜ„Å°„ÇÖ„ÅÜ„Åõ„Çì', difficulty: 4, category: '„ÅÆ„Çä„ÇÇ„ÅÆ' },
            { text: '„Éõ„Éº„É†„É©„É≥', difficulty: 4, category: '„Çπ„Éù„Éº„ÉÑ' },
            { text: '„Åä„Åã„Åó„Å•„Åè„Çä', difficulty: 4, category: '„Åõ„ÅÑ„Åã„Å§' },
            { text: '„Åü„ÅÑ„ÅÑ„Åè„Åã„Çì', difficulty: 4, category: '„Å∞„Åó„Çá' },
            { text: '„ÇÜ„ÅÜ„Åà„Çì„Å°', difficulty: 4, category: '„Å∞„Åó„Çá' },
            { text: '„Å®„Åó„Çá„Åó„Å§', difficulty: 4, category: '„Å∞„Åó„Çá' },
            { text: '„Åç„Çá„ÅÜ„Åã„Åó„Çá', difficulty: 4, category: '„Åå„Åè„Åó„ÇÖ„ÅÜ' },
            { text: '„Åë„ÅÑ„Åï„Å§„Åó„Çá', difficulty: 4, category: '„Å∞„Åó„Çá' },
            { text: '„ÅÇ„Åï„ÅÆ„Åó„Åü„Åè', difficulty: 4, category: '„Åõ„ÅÑ„Åã„Å§' },
            { text: '„Åä„Å≤„Çã„ÇÑ„Åô„Åø', difficulty: 4, category: '„Åõ„ÅÑ„Åã„Å§' },
            { text: '„Åò„ÇÖ„Åé„Çá„ÅÜ', difficulty: 4, category: '„Åå„Åè„Åó„ÇÖ„ÅÜ' },
            { text: '„Åë„Çì„Åå„Åè„Åã„ÅÑ', difficulty: 4, category: '„Åå„Åè„Åó„ÇÖ„ÅÜ' },
            { text: '„Åä„Çì„Åå„Åè„Åã„ÅÑ', difficulty: 4, category: '„Ç§„Éô„É≥„Éà' },
            { text: '„ÅÜ„Çì„Å©„ÅÜ„Åã„ÅÑ', difficulty: 4, category: '„Ç§„Éô„É≥„Éà' },
            { text: '„Åò„Å¶„Çì„Åó„ÇÉ', difficulty: 4, category: '„ÅÆ„Çä„ÇÇ„ÅÆ' },
            { text: '„Åã„ÅÑ„Å†„Çì„Åó„Åü', difficulty: 4, category: '„Å∞„Åó„Çá' },

            // 7„Äú8ÊñáÂ≠ó„ÅÆÂçòË™ûÔºàÊúÄ‰∏äÁ¥ö„Éª20ÂïèÔºâ
            { text: '„Ç¢„Ç§„Çπ„ÇØ„É™„Éº„É†', difficulty: 5, category: '„Åü„Åπ„ÇÇ„ÅÆ' },
            { text: '„Çµ„ÉÉ„Ç´„Éº„Éú„Éº„É´', difficulty: 5, category: '„Çπ„Éù„Éº„ÉÑ' },
            { text: '„Ç≥„É≥„Éî„É•„Éº„Çø„Éº', difficulty: 5, category: '„ÇÇ„ÅÆ' },
            { text: '„É©„É≥„Éâ„Çª„É´„Ç´„Éê„Éº', difficulty: 5, category: '„ÇÇ„ÅÆ' },
            { text: '„Å≤„Åæ„Çè„Çä„Å∞„Åü„Åë', difficulty: 5, category: '„Åó„Åú„Çì' },
            { text: '„Åò„ÇÜ„ÅÜ„Åë„Çì„Åç„ÇÖ„ÅÜ', difficulty: 5, category: '„Åå„Åè„Åó„ÇÖ„ÅÜ' },
            { text: '„Åó„ÇÖ„Åè„Å†„ÅÑ„Å°„Çá„ÅÜ', difficulty: 5, category: '„Åå„Åè„Åó„ÇÖ„ÅÜ' },
            { text: '„Åä„Å´„Åî„Å£„Åì„ÅÇ„Åù„Å≥', difficulty: 5, category: '„ÅÇ„Åù„Å≥' },
            { text: '„ÅØ„Å™„ÇÑ„Åï„Çì„ÅÆ„Å´„Çè', difficulty: 5, category: '„Å∞„Åó„Çá' },
            { text: '„Éë„ÇΩ„Ç≥„É≥„É´„Éº„É†', difficulty: 5, category: '„Å∞„Åó„Çá' },
            { text: '„Åô„ÅÑ„Åà„ÅÑ„Åü„ÅÑ„Åã„ÅÑ', difficulty: 5, category: '„Ç§„Éô„É≥„Éà' },
            { text: '„Åò„Å©„ÅÜ„Åó„ÇÉ„Å©„ÅÜ', difficulty: 5, category: '„ÅÆ„Çä„ÇÇ„ÅÆ' },
            { text: '„ÇØ„É™„Çπ„Éû„Çπ„ÉÑ„É™„Éº', difficulty: 5, category: '„Ç§„Éô„É≥„Éà' },
            { text: '„Éê„Çπ„Ç±„ÉÉ„Éà„Éú„Éº„É´', difficulty: 5, category: '„Çπ„Éù„Éº„ÉÑ' },
            { text: '„Å¶„Åå„Åø„ÅÆ„Åã„Åç„Åã„Åü', difficulty: 5, category: '„Åå„Åè„Åó„ÇÖ„ÅÜ' },
            { text: '„Åà„ÅÑ„Åî„Åπ„Çì„Åç„Çá„ÅÜ', difficulty: 5, category: '„Åå„Åè„Åó„ÇÖ„ÅÜ' },
            { text: '„Åü„ÅÑ„ÅÑ„Åè„Åö„Çè„Çä', difficulty: 5, category: '„Åå„Åè„Åó„ÇÖ„ÅÜ' },
            { text: '„Åì„ÅÜ„Åï„Åè„ÇØ„É©„Éñ', difficulty: 5, category: '„ÇØ„É©„Éñ' },
            { text: '„Åå„Å£„Åç„ÇÖ„ÅÜ„ÅÑ„ÅÑ„Çì', difficulty: 5, category: '„Åå„Åè„Åó„ÇÖ„ÅÜ' },
            { text: '„Åã„Åå„Åè„ÅØ„Å£„Å¥„Çá„ÅÜ', difficulty: 5, category: '„Åå„Åè„Åó„ÇÖ„ÅÜ' },

            // 9„Äú12ÊñáÂ≠ó„ÅÆÂçòË™ûÔºàË∂Ö‰∏äÁ¥ö„Éª20ÂïèÔºâ
            { text: '„Åä„Åó„Çá„ÅÜ„Åå„Å§„ÇÑ„Åô„Åø', difficulty: 6, category: '„Ç§„Éô„É≥„Éà' },
            { text: '„Åã„Çì„Åç„Çá„ÅÜ„ÇÇ„Çì„Å†„ÅÑ', difficulty: 6, category: '„Åå„Åè„Åó„ÇÖ„ÅÜ' },
            { text: '„Åç„Çá„ÅÜ„Çä„ÇÖ„ÅÜ„ÅØ„Åã„Å∞', difficulty: 6, category: '„Å∞„Åó„Çá' },
            { text: '„Åò„Åó„Çì„Åë„ÅÑ„Åª„ÅÜ„Ç∑„Çπ„ÉÜ„É†', difficulty: 6, category: '„Åó„Åú„Çì' },
            { text: '„Éï„Ç°„Éü„É™„Éº„É¨„Çπ„Éà„É©„É≥', difficulty: 6, category: '„Å∞„Åó„Çá' },
            { text: '„Åó„Çá„ÅÜ„Å¶„Çì„Åå„ÅÑ„Çπ„Éà„É™„Éº„Éà', difficulty: 6, category: '„Å∞„Åó„Çá' },
            { text: '„Åç„ÇÖ„ÅÜ„Åç„ÇÖ„ÅÜ„Åó„ÇÉ„Åó„Å©„ÅÜ', difficulty: 6, category: '„ÅÆ„Çä„ÇÇ„ÅÆ' },
            { text: '„Åå„Åè„Åà„Çì„Åï„ÅÑ„Åò„Å£„Åó', difficulty: 6, category: '„Ç§„Éô„É≥„Éà' },
            { text: '„Åæ„Çì„Åå„É©„Ç§„Éñ„É©„É™„Éº', difficulty: 6, category: '„Å∞„Åó„Çá' },
            { text: '„Çµ„Ç§„Ç®„É≥„Çπ„Éü„É•„Éº„Ç∏„Ç¢„É†', difficulty: 6, category: '„Å∞„Åó„Çá' },
            { text: '„Å©„ÅÜ„Å∂„Å§„ÅÇ„ÅÑ„Åî„Çª„É≥„Çø„Éº', difficulty: 6, category: '„Å∞„Åó„Çá' },
            { text: '„Å´„ÇÖ„ÅÜ„Åå„Åè„Åó„Åç„Çª„É¨„É¢„Éã„Éº', difficulty: 6, category: '„Ç§„Éô„É≥„Éà' },
            { text: '„Åó„Åú„Çì„Åã„Çì„Åï„Å§„Åç„Çá„ÅÜ„Åó„Å§', difficulty: 6, category: '„Åå„Åè„Åó„ÇÖ„ÅÜ' },
            { text: '„Ç∑„Éß„ÉÉ„Éî„É≥„Ç∞„É¢„Éº„É´', difficulty: 6, category: '„Å∞„Åó„Çá' },
            { text: '„Éè„É≥„Éê„Éº„Ç¨„Éº„Çª„ÉÉ„Éà', difficulty: 6, category: '„Åü„Åπ„ÇÇ„ÅÆ' },
            { text: '„Åª„ÅÜ„Åã„Åî„Åì„Å©„ÇÇ„ÇØ„É©„Éñ', difficulty: 6, category: '„ÇØ„É©„Éñ' },
            { text: '„Åò„ÇÖ„Åè„Åî„Çå„Çì„Åó„ÇÖ„ÅÜ„Å°„Çá„ÅÜ', difficulty: 6, category: '„Åå„Åè„Åó„ÇÖ„ÅÜ' },
            { text: '„Å®„ÅÜ„Åç„Çá„ÅÜ„Çπ„Ç´„Ç§„ÉÑ„É™„Éº', difficulty: 6, category: '„Å∞„Åó„Çá' },
            { text: '„Åà„ÅÑ„Åå„Åï„ÅÑ„Éë„É≥„Éï„É¨„ÉÉ„Éà', difficulty: 6, category: '„Ç§„Éô„É≥„Éà' },
            { text: '„ÅÜ„Çì„Å©„ÅÜ„Åã„ÅÑ„Éó„É≠„Ç∞„É©„É†', difficulty: 6, category: '„Ç§„Éô„É≥„Éà' },
            
            // ÂåªÁôÇ„Ç´„ÉÜ„Ç¥„É™„ÉºÔºàÂõûÂæ©ÂäπÊûú„Éª15ÂïèÔºâ
            { text: '„Åè„Åô„Çä', difficulty: 2, category: '„ÅÑ„Çä„Çá„ÅÜ' },
            { text: '„Å≥„Çá„ÅÜ„ÅÑ„Çì', difficulty: 3, category: '„ÅÑ„Çä„Çá„ÅÜ' },
            { text: '„ÅÑ„Åó„ÇÉ', difficulty: 2, category: '„ÅÑ„Çä„Çá„ÅÜ' },
            { text: '„Åã„Çì„Åî„Åó', difficulty: 3, category: '„ÅÑ„Çä„Çá„ÅÜ' },
            { text: '„Å°„Çä„Çá„ÅÜ', difficulty: 3, category: '„ÅÑ„Çä„Çá„ÅÜ' },
            { text: '„Åë„Çì„Åì„ÅÜ', difficulty: 3, category: '„ÅÑ„Çä„Çá„ÅÜ' },
            { text: '„Åó„Çì„Å†„Çì', difficulty: 3, category: '„ÅÑ„Çä„Çá„ÅÜ' },
            { text: '„Åª„ÅÜ„Åü„ÅÑ', difficulty: 3, category: '„ÅÑ„Çä„Çá„ÅÜ' },
            { text: '„Å°„ÇÖ„ÅÜ„Åó„ÇÉ', difficulty: 3, category: '„ÅÑ„Çä„Çá„ÅÜ' },
            { text: '„Åü„ÅÑ„Åä„Çì', difficulty: 3, category: '„ÅÑ„Çä„Çá„ÅÜ' },
            { text: '„Åç„ÇÖ„ÅÜ„Åç„ÇÖ„ÅÜ', difficulty: 4, category: '„ÅÑ„Çä„Çá„ÅÜ' },
            { text: '„ÇÑ„Åè„Åñ„ÅÑ„Åó', difficulty: 4, category: '„ÅÑ„Çä„Çá„ÅÜ' },
            { text: '„Çä„ÅØ„Å≥„Çä', difficulty: 3, category: '„ÅÑ„Çä„Çá„ÅÜ' },
            { text: '„Åë„Çì„Åó„Çì', difficulty: 3, category: '„ÅÑ„Çä„Çá„ÅÜ' },
            { text: '„Å∞„Çì„Åù„ÅÜ„Åì„ÅÜ', difficulty: 4, category: '„ÅÑ„Çä„Çá„ÅÜ' }
        ];



        // ÂÖ®ËßíÊñáÂ≠ó„ÇíÂçäËßí„Å´Â§âÊèõÔºàÊîπËâØÁâàÔºâ
        function normalizeInput(text) {
            if (!text) return '';
            return text
                // ÂÖ®ËßíËã±Êï∞
                .replace(/[Ôº°-Ôº∫ÔΩÅ-ÔΩöÔºê-Ôºô]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
                // Âè≥/Â∑¶„ÅÆ„Ç´„Éº„É´„Éª„Éó„É©„Ç§„É†È°û„ÇÇÂê∏Âèé
                .replace(/[\u2018\u2019\u2032\uFF07']/g, "'")
                // „ÅÑ„Çç„Çì„Å™„ÉÄ„ÉÉ„Ç∑„É•„ÇíÂçäËßí„Éè„Ç§„Éï„É≥„Å´ÔºàÈï∑Èü≥„Äå„Éº„ÄçÈô§Â§ñÔºâ
                .replace(/[\u2010-\u2015\u2212\uFF0D\uFE63]/g, "-")
                .toLowerCase();
        }

        // Fisher-Yates „Ç∑„É£„ÉÉ„Éï„É´ÔºàÂÖ¨Âπ≥ÊÄßÂêë‰∏äÔºâ
        function shuffle(array) {
            const a = [...array];
            const r = new Uint32Array(1);
            for (let i = a.length - 1; i > 0; i--) {
                crypto.getRandomValues(r);
                const j = r[0] % (i + 1);
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        // „Ç≤„Éº„É†ÂàùÊúüÂåñ
        function initGame() {
            // ÈÅ∏Êäû„Åï„Çå„ÅüHP„ÇíÈÅ©Áî®
            gameState.players.forEach(player => {
                player.hp = gameState.maxHP;
                player.maxHp = gameState.maxHP;
            });
            
            // „Éá„ÉÉ„Ç≠„Çí„Ç∑„É£„ÉÉ„Éï„É´
            gameState.deck = shuffle(CARD_POOL);
            
            // ÂàùÊúüÊâãÊú≠„ÇíÈÖç„Çã
            for (let i = 0; i < 2; i++) {
                gameState.hands[i] = [];
                for (let j = 0; j < 5; j++) {
                    if (gameState.deck.length > 0) {
                        gameState.hands[i].push(gameState.deck.pop());
                    }
                }
            }
            
            // UIÊõ¥Êñ∞
            updateUI();
            drawCards();
            
            // ÊúÄÂàù„ÅÆ„Çø„Éº„É≥ÈñãÂßã
            startTurn();
        }

        // „É¢„Éº„ÉâÈÅ∏Êäû
        function selectMode(mode) {
            // Ââç„ÅÆÈÅ∏Êäû„ÇíËß£Èô§
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Êñ∞„Åó„ÅÑÈÅ∏Êäû
            document.getElementById(mode === 'cpu' ? 'cpuModeBtn' : 'pvpModeBtn').classList.add('selected');
            
            gameState.mode = mode;
            document.getElementById('characterSelection').classList.remove('hidden');
            
            if (mode === 'pvp') {
                document.getElementById('player2Setup').classList.remove('hidden');
                gameState.players[1].name = '„Éó„É¨„Ç§„É§„Éº2';
                gameState.players[1].avatar = 'üíß';
            } else {
                document.getElementById('player2Setup').classList.add('hidden');
            }
            
            // „Éó„É¨„Ç§„É§„Éº1„ÅÆÂêçÂâçÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„Çã
            setTimeout(() => {
                const nameInput = document.getElementById('player1NameInput');
                nameInput.focus();
                nameInput.select();
            }, 100);
            
            // ÂêçÂâçÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
            document.getElementById('player1NameInput').addEventListener('focus', function() {
                this.select();
            });
            
            if (mode === 'pvp') {
                document.getElementById('player2NameInput').addEventListener('focus', function() {
                    this.select();
                });
            }

            // „Éá„Éï„Ç©„É´„ÉàÈÅ∏ÊäûÔºàËø∑„Å£„Åü„Çâ„Åô„ÅêÈÄ≤„ÇÅ„ÇãÔºâ
            selectCharacter('fire', 1);
            if (mode === 'pvp') selectCharacter('water', 2);
            checkSetupComplete();
        }

        // HPÈÅ∏Êäû
        function selectHP(hp) {
            // Ââç„ÅÆÈÅ∏Êäû„ÇíËß£Èô§
            document.querySelectorAll('.hp-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Êñ∞„Åó„ÅÑÈÅ∏Êäû
            document.querySelector(`[data-hp="${hp}"]`).classList.add('selected');
            
            gameState.maxHP = hp;
            gameState.players.forEach(player => {
                player.hp = hp;
                player.maxHp = hp;
            });
            
            checkSetupComplete();
        }

        // „Ç≠„É£„É©„ÇØ„Çø„ÉºÈÅ∏Êäû
        function selectCharacter(attribute, player) {
            // Ë©≤ÂΩì„Éó„É¨„Ç§„É§„Éº„ÅÆÂâç„ÅÆÈÅ∏Êäû„ÇíËß£Èô§
            document.querySelectorAll(`[data-player="${player}"]`).forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Êñ∞„Åó„ÅÑÈÅ∏Êäû
            document.querySelector(`[data-attr="${attribute}"][data-player="${player}"]`).classList.add('selected');
            
            const avatars = {
                fire: 'üî•',
                water: 'üíß',
                thunder: '‚ö°',
                wind: 'üå™Ô∏è',
                earth: 'üå±',
                light: '‚ú®'
            };
            
            gameState.players[player - 1].attribute = attribute;
            gameState.players[player - 1].avatar = avatars[attribute];
            
            // ÂêçÂâç„ÇíÊõ¥Êñ∞
            const nameInput = document.getElementById(`player${player}NameInput`);
            if (nameInput) {
                gameState.players[player - 1].name = nameInput.value || `„Éó„É¨„Ç§„É§„Éº${player}`;
            }
            
            // Ê¨°„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÅÆÂêçÂâçÂÖ•Âäõ„Å´„Éï„Ç©„Éº„Ç´„ÇπÔºà2‰∫∫ÂØæÊà¶„ÅÆÂ†¥ÂêàÔºâ
            if (player === 1 && gameState.mode === 'pvp') {
                setTimeout(() => {
                    const player2Input = document.getElementById('player2NameInput');
                    player2Input.focus();
                    player2Input.select();
                }, 100);
            }
            
            checkSetupComplete();
        }
        
        // „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ
        function checkSetupComplete() {
            const player1Selected = document.querySelector('[data-player="1"].selected');
            const player2Selected = gameState.mode === 'cpu' || document.querySelector('[data-player="2"].selected');
            
            document.getElementById('nextBtn').disabled = !(player1Selected && player2Selected);
        }
        
        // „Ç≤„Éº„É†„É´„Éº„É´Ë°®Á§∫
        function showGameRules() {
            // ÂêçÂâç„ÇíÊúÄÁµÇÊõ¥Êñ∞
            gameState.players[0].name = document.getElementById('player1NameInput').value || '„Éó„É¨„Ç§„É§„Éº1';
            if (gameState.mode === 'pvp') {
                gameState.players[1].name = document.getElementById('player2NameInput').value || '„Éó„É¨„Ç§„É§„Éº2';
            }
            
            document.getElementById('characterSelection').classList.add('hidden');
            document.getElementById('gameRules').classList.remove('hidden');
        }

        // „Ç≤„Éº„É†ÈñãÂßã
        function startGame() {
            document.getElementById('startScreen').classList.add('hidden');
            
            // 2‰∫∫ÂØæÊà¶„ÅÆÂ†¥Âêà„ÅØ„É´„Éº„É¨„ÉÉ„Éà„Åß„Çø„Éº„É≥Ê±∫ÂÆö
            if (gameState.mode === 'pvp') {
                showRouletteAnimation();
            } else {
                document.getElementById('gameContainer').classList.remove('hidden');
                initGame();
            }
        }

        // „É´„Éº„É¨„ÉÉ„ÉàÊºîÂá∫Ë°®Á§∫
        function showRouletteAnimation() {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.className = 'roulette-overlay';
                
                const container = document.createElement('div');
                container.className = 'roulette-container';
                
                // XSSÂØæÁ≠ñÔºö„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰Ωø„Çè„ÅöDOMÊßãÁØâ
                const title = document.createElement('div');
                title.className = 'roulette-title';
                title.textContent = 'üéØ ÂÖàÊîª„ÇíÊ±∫„ÇÅ„Çà„ÅÜÔºÅ';
                
                const playerInfo = document.createElement('div');
                playerInfo.className = 'player-info-simple';
                
                // „Éó„É¨„Ç§„É§„Éº1„Ç´„Éº„Éâ
                const leftCard = document.createElement('div');
                leftCard.className = 'player-card left';
                leftCard.innerHTML = `
                    <div class="player-avatar-simple">${gameState.players[0].avatar}</div>
                    <div class="player-side">Â∑¶ÂçäÂàÜ</div>
                `;
                const leftName = document.createElement('div');
                leftName.className = 'player-name-simple';
                leftName.textContent = gameState.players[0].name;
                leftCard.insertBefore(leftName, leftCard.lastElementChild);
                
                // „Éó„É¨„Ç§„É§„Éº2„Ç´„Éº„Éâ
                const rightCard = document.createElement('div');
                rightCard.className = 'player-card right';
                rightCard.innerHTML = `
                    <div class="player-avatar-simple">${gameState.players[1].avatar}</div>
                    <div class="player-side">Âè≥ÂçäÂàÜ</div>
                `;
                const rightName = document.createElement('div');
                rightName.className = 'player-name-simple';
                rightName.textContent = gameState.players[1].name;
                rightCard.insertBefore(rightName, rightCard.lastElementChild);
                
                playerInfo.appendChild(leftCard);
                playerInfo.appendChild(rightCard);
                
                const wheel = document.createElement('div');
                wheel.className = 'roulette-wheel';
                wheel.id = 'rouletteWheel';
                wheel.innerHTML = `
                    <div class="roulette-pointer"></div>
                    <div class="roulette-center">üé≤</div>
                `;
                
                const result = document.createElement('div');
                result.className = 'roulette-result';
                result.id = 'rouletteResult';
                
                container.appendChild(title);
                container.appendChild(playerInfo);
                container.appendChild(wheel);
                container.appendChild(result);
                
                overlay.appendChild(container);
                document.body.appendChild(overlay);
                
                // „É´„Éº„É¨„ÉÉ„ÉàÈñãÂßã
                setTimeout(() => {
                    spinRoulette(overlay, resolve);
                }, 500);
            });
        }

        // „É´„Éº„É¨„ÉÉ„ÉàÂõûËª¢Âá¶ÁêÜ
        function spinRoulette(overlay, callback) {
            const wheel = document.getElementById('rouletteWheel');
            const resultEl = document.getElementById('rouletteResult');
            
            // „É©„É≥„ÉÄ„É†„Å™ÊúÄÁµÇËßíÂ∫¶„ÇíÊ±∫ÂÆöÔºà5ÂõûËª¢ + „É©„É≥„ÉÄ„É†Ôºâ
            const baseRotation = 1800; // 5ÂõûËª¢
            const randomRotation = Math.random() * 360;
            const finalRotation = baseRotation + randomRotation;
            
            // ÁµêÊûú„ÇíÊ±∫ÂÆöÔºàÂ∑¶ÂçäÂàÜÔºö„Éó„É¨„Ç§„É§„Éº1„ÄÅÂè≥ÂçäÂàÜÔºö„Éó„É¨„Ç§„É§„Éº2Ôºâ
            const normalizedAngle = randomRotation % 360;
            const winner = normalizedAngle < 180 ? 0 : 1;
            gameState.currentPlayer = winner;
            
            // CSSÂ§âÊï∞„Å´ÊúÄÁµÇËßíÂ∫¶„ÇíË®≠ÂÆö
            wheel.style.setProperty('--final-rotation', `${finalRotation}deg`);
            
            // ÂõûËª¢„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈñãÂßã
            wheel.classList.add('roulette-spinning');
            
            // ÂõûËª¢Èü≥ÔºàÁ∞°ÊòìÔºâ
            playRouletteSound();
            
            // ÁµêÊûúË°®Á§∫
            setTimeout(() => {
                const winnerName = gameState.players[winner].name;
                const winnerAvatar = gameState.players[winner].avatar;
                
                // XSSÂØæÁ≠ñÔºöDOMÊßãÁØâ„ÅßÂêçÂâç„ÇíÂÆâÂÖ®„Å´ÊåøÂÖ•
                const resultContainer = document.createElement('div');
                resultContainer.style.cssText = 'display: flex; align-items: center; justify-content: center; gap: 15px;';
                
                const avatarDiv = document.createElement('div');
                avatarDiv.style.fontSize = '32px';
                avatarDiv.textContent = winnerAvatar;
                
                const textDiv = document.createElement('div');
                
                const winText = document.createElement('div');
                winText.style.cssText = 'font-size: 20px; color: #feca57;';
                winText.textContent = `üéâ ${winnerName}„ÅÆÂÖàÊîªÔºÅ`;
                
                const subText = document.createElement('div');
                subText.style.cssText = 'font-size: 14px; opacity: 0.8; margin-top: 5px;';
                subText.textContent = '„Ç≤„Éº„É†„ÇíÈñãÂßã„Åó„Åæ„Åô...';
                
                textDiv.appendChild(winText);
                textDiv.appendChild(subText);
                resultContainer.appendChild(avatarDiv);
                resultContainer.appendChild(textDiv);
                
                resultEl.innerHTML = '';
                resultEl.appendChild(resultContainer);
                
                // ÂãùÂà©Èü≥
                playSound('success');
                
                // „Ç≤„Éº„É†ÈñãÂßã
                setTimeout(() => {
                    overlay.remove();
                    document.getElementById('gameContainer').classList.remove('hidden');
                    initGame();
                    callback();
                }, 1500);
            }, 2200);
        }

        // „É´„Éº„É¨„ÉÉ„ÉàÈü≥ÔºàÂõûËª¢Èü≥Ôºâ
        function playRouletteSound() {
            if (!gameState.soundEnabled) return;
            
            ensureAudio();
            if (!audioCtx) return;
            
            // ÂõûËª¢Èü≥„Çí3ÁßíÈñìÂÜçÁîü
            let frequency = 200;
            const duration = 3000;
            const startTime = audioCtx.currentTime;
            
            function createTick(time, freq) {
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.frequency.setValueAtTime(freq, time);
                gainNode.gain.setValueAtTime(0.05, time);
                gainNode.gain.exponentialRampToValueAtTime(0.001, time + 0.1);
                
                oscillator.start(time);
                oscillator.stop(time + 0.1);
            }
            
            // Âæê„ÄÖ„Å´ÈñìÈöî„ÇíÂ∫É„Åí„Å™„Åå„Çâ„ÉÜ„Ç£„ÉÉ„ÇØÈü≥„ÇíÁîüÊàê
            let tickInterval = 50; // ÂàùÊúüÈñìÈöîÔºàmsÔºâ
            let currentTime = startTime;
            
            while (currentTime - startTime < duration / 1000) {
                createTick(currentTime, frequency + Math.random() * 100);
                
                // ÊôÇÈñì„ÅåÁµå„Å§„Å´„Å§„Çå„Å¶ÈñìÈöî„ÇíÂ∫É„Åí„ÇãÔºàÊ∏õÈÄüÂäπÊûúÔºâ
                const progress = (currentTime - startTime) / (duration / 1000);
                tickInterval = 50 + (progress * 200); // 50ms „Åã„Çâ 250ms „Å∏
                
                currentTime += tickInterval / 1000;
            }
        }

        // UIÊõ¥Êñ∞
        function updateUI() {
            // „Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±Êõ¥Êñ∞
            for (let i = 0; i < 2; i++) {
                const player = gameState.players[i];
                document.getElementById(`player${i + 1}Name`).textContent = player.name;
                document.getElementById(`player${i + 1}Avatar`).textContent = player.avatar;
                
                const hpPercent = Math.max(0, Math.min(100, (player.hp / player.maxHp) * 100));
                document.getElementById(`player${i + 1}HpBar`).style.width = `${hpPercent}%`;
                document.getElementById(`player${i + 1}HpText`).textContent = `${player.hp}/${player.maxHp}`;
            }
            
            // „Çø„Éº„É≥Ë°®Á§∫
            document.getElementById('turnDisplay').textContent = 
                `${gameState.players[gameState.currentPlayer].name}„ÅÆ„Çø„Éº„É≥`;
                
            // „Éï„Çß„Éº„Ç∫Ë°®Á§∫
            updatePhaseDisplay();
        }
        
        // „Éï„Çß„Éº„Ç∫Ë°®Á§∫Êõ¥Êñ∞
        function updatePhaseDisplay() {
            const phaseDisplay = document.getElementById('phaseDisplay');
            
            switch (gameState.gamePhase) {
                case 'cardSelect':
                    phaseDisplay.textContent = '„Ç´„Éº„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                    break;
                case 'typing':
                    phaseDisplay.textContent = '„Çø„Ç§„Éî„É≥„Ç∞‰∏≠...';
                    break;
                case 'result':
                    phaseDisplay.textContent = 'ÁµêÊûúË°®Á§∫';
                    break;
                default:
                    phaseDisplay.textContent = '';
            }
        }

        // „Éó„É¨„Ç§„É§„Éº„ÅÆÊâãÊú≠Ë°®Á§∫ÔºàÂ∑¶Âè≥„Å´ÈÖçÁΩÆÔºâ
        function drawPlayerHand() {
            // Êó¢Â≠ò„ÅÆÊâãÊú≠„Ç≥„É≥„ÉÜ„Éä„ÇíÂâäÈô§
            document.querySelectorAll('.player-hand').forEach(el => el.remove());
            
            // Â∑¶ÂÅ¥Ôºà„Éó„É¨„Ç§„É§„Éº1„ÅÆÊâãÊú≠Ôºâ
            const leftHand = document.createElement('div');
            leftHand.className = 'player-hand left';
            leftHand.id = 'leftPlayerHand';
            
            // Âè≥ÂÅ¥Ôºà„Éó„É¨„Ç§„É§„Éº2„ÅÆÊâãÊú≠Ôºâ
            const rightHand = document.createElement('div');
            rightHand.className = 'player-hand right';
            rightHand.id = 'rightPlayerHand';
            
            document.querySelector('.card-area').appendChild(leftHand);
            document.querySelector('.card-area').appendChild(rightHand);
            
            // ‰∏°Êñπ„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÅÆÊâãÊú≠„ÇíË°®Á§∫
            [0, 1].forEach(playerIndex => {
                const hand = gameState.hands[playerIndex];
                const container = playerIndex === 0 ? leftHand : rightHand;
                
                // ÊâãÊú≠„Åå6ÊûöÊú™Ê∫Ä„Å™„Çâ1ÊûöÂºï„Åè
                if (gameState.deck.length > 0 && hand.length < 6) {
                    hand.push(gameState.deck.pop());
                }
                
                hand.forEach((card, index) => {
                    const handCard = document.createElement('div');
                    handCard.className = 'hand-card';
                    
                    // ÁèæÂú®„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÅÆÊâãÊú≠„ÅØÂ∞ë„ÅóÊòé„Çã„ÅèË°®Á§∫
                    if (playerIndex === gameState.currentPlayer) {
                        handCard.style.opacity = '1';
                        handCard.style.border = '2px solid rgba(254, 202, 87, 0.5)';
                    }
                    
                    handCard.innerHTML = `
                        <div style="font-weight: 700; font-size: 11px;">${card.text}</div>
                        <div style="font-size: 8px; opacity: 0.8;">${'‚òÖ'.repeat(card.difficulty)}</div>
                        <div style="font-size: 7px; opacity: 0.7;">${card.category}</div>
                    `;
                    container.appendChild(handCard);
                });
            });
        }

        // „Ç´„Éº„ÉâÊèèÁîªÔºà„É°„Ç§„É≥ÈÅ∏Êäû„Ç®„É™„Ç¢Ôºâ
        function drawCards() {
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';
            
            const currentHand = gameState.hands[gameState.currentPlayer];
            
            // ÊâãÊú≠„Åå6ÊûöÊú™Ê∫Ä„Å™„Çâ1ÊûöÂºï„Åè
            if (gameState.deck.length > 0 && currentHand.length < 6) {
                currentHand.push(gameState.deck.pop());
            }
            
            // „Ç´„Éº„Éâ„Çí3Êûö„Åö„Å§Ë°®Á§∫ÔºàÊúÄÂ§ß6ÊûöÔºâ
            const displayCards = currentHand.slice(0, 6);
            
            displayCards.forEach((card, index) => {
                const cardElement = document.createElement('div');
                const isHealCard = card.category === '„ÅÑ„Çä„Çá„ÅÜ';
                cardElement.className = isHealCard ? 'card heal' : 'card attack';
                cardElement.onclick = () => selectCard(index);
                
                // „Ç≠„Éº„Éú„Éº„Éâ„Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£ÂØæÂøú
                cardElement.tabIndex = 0;
                cardElement.setAttribute('role', 'button');
                cardElement.setAttribute('aria-label', `${card.text}„ÄÅÈõ£ÊòìÂ∫¶${card.difficulty}`);
                cardElement.addEventListener('keydown', e => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        selectCard(index);
                    }
                });
                
                const stars = '‚òÖ'.repeat(card.difficulty);
                const categoryDisplay = isHealCard ? 'üíö „ÅÑ„Çä„Çá„ÅÜ' : '‚öîÔ∏è ' + card.category;
                
                // ÊñáÂ≠óÊï∞„Å´Âøú„Åò„Å¶„ÉÜ„Ç≠„Çπ„Éà„Çµ„Ç§„Ç∫„ÇØ„É©„Çπ„ÇíÊ±∫ÂÆö
                const textLength = card.text.length;
                let textSizeClass = 'medium';
                if (textLength <= 3) textSizeClass = 'short';
                else if (textLength <= 6) textSizeClass = 'medium';
                else if (textLength <= 9) textSizeClass = 'long';
                else if (textLength <= 12) textSizeClass = 'very-long';
                else textSizeClass = 'extra-long';
                
                cardElement.innerHTML = `
                    <div class="card-text ${textSizeClass}">${card.text}</div>
                    <div class="card-difficulty">${stars}</div>
                    <div class="card-category">${categoryDisplay}</div>
                `;
                
                container.appendChild(cardElement);
            });
            
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            setTimeout(() => {
                container.classList.add('active');
            }, 100);
        }

        // „Ç´„Éº„ÉâÈÅ∏Êäû
        function selectCard(index) {
            if (gameState.gamePhase !== 'cardSelect') return;
            
            // Ââç„ÅÆÈÅ∏Êäû„ÇíËß£Èô§
            document.querySelectorAll('.card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Êñ∞„Åó„ÅÑÈÅ∏Êäû
            document.querySelectorAll('.card')[index].classList.add('selected');
            gameState.selectedCard = gameState.hands[gameState.currentPlayer][index];
            
            // „Çø„Ç§„Éî„É≥„Ç∞„Ç¨„Ç§„Éâ„ÇíË®≠ÂÆö
            setupTypingGuide(gameState.selectedCard.text);
            
            // ÂÖ•Âäõ„Éï„Çß„Éº„Ç∫„Å´ÁßªË°å
            startTypingPhase();
        }

        // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Ë°®Á§∫
        function showCountdown() {
            return new Promise((resolve) => {
                const overlay = document.createElement('div');
                overlay.className = 'countdown-overlay';
                
                const numberEl = document.createElement('div');
                numberEl.className = 'countdown-number';
                overlay.appendChild(numberEl);
                
                document.body.appendChild(overlay);
                
                // Ready ‚Üí Go!!! „ÅÆÈ†ÜÁï™„ÅßË°®Á§∫
                numberEl.textContent = 'Ready';
                
                setTimeout(() => {
                    numberEl.textContent = 'Go!!!';
                    setTimeout(() => {
                        overlay.remove();
                        resolve();
                    }, 800);
                }, 1200); // Ready„Çí1.2ÁßíË°®Á§∫
            });
        }

        // „Çø„Ç§„Éî„É≥„Ç∞„Éï„Çß„Éº„Ç∫ÈñãÂßã
        async function startTypingPhase() {
            gameState.gamePhase = 'typing';
            gameState.timer = 12;
            
            // „Çø„Ç§„Éû„Éº„É™„É≥„Ç∞„ÇíÂç≥Êõ¥Êñ∞
            const timerRing = document.getElementById('timerRing');
            timerRing.textContent = 12;
            timerRing.style.background = 'conic-gradient(#feca57 360deg, rgba(255,255,255,0.2) 360deg)';
            
            // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Ë°®Á§∫
            await showCountdown();
            
            // „Çø„Ç§„Éî„É≥„Ç∞„Éè„É≥„Éâ„É©„Éº„ÇíÊúâÂäπÂåñ
            enableTyping();
            
            // „Çø„Ç§„Éû„ÉºÈñãÂßã
            startTimer();
        }

        // „Çø„Ç§„Éû„ÉºÈñãÂßã
        function startTimer() { 
            startAccurateTimer(12000); 
        }

        // Ë§áÊï∞ÂÄôË£úÂØæÂøú„ÅÆ„Çø„Ç§„Éî„É≥„Ç∞Áä∂ÊÖã
        let typingState = {
            targetOptions: [], // Ë§áÊï∞„ÅÆ„É≠„Éº„ÉûÂ≠óÂÄôË£ú
            currentInputs: [], // ÂêÑÂÄôË£ú„Åß„ÅÆÁèæÂú®„ÅÆÂÖ•ÂäõÁä∂Ê≥Å
            typedKeys: ''
        };

        // „Ç≠„Éº„Éú„Éº„ÉâÂÖ•ÂäõÂá¶ÁêÜÔºàË§áÊï∞ÂÄôË£úÂØæÂøúÔºâ
        function handleKeyPress(event) {
            if (gameState.gamePhase !== 'typing' || gameState.isPaused) return;
            
            // IMEÂÖ•Âäõ‰∏≠„ÅØÂá¶ÁêÜ„Åó„Å™„ÅÑ
            if (isComposing) return;
            
            // „Ç≠„ÉºÈï∑Êäº„Åó„ÅÆÊö¥Áô∫„ÇíÁÑ°ÂäπÂåñ
            if (event.repeat) return;
            
            // ÂÖ®ËßíÊñáÂ≠ó„ÇíÂçäËßí„Å´Â§âÊèõ
            let key = normalizeInput(event.key);
            if (key === 'subtract') key = '-'; // NumpadSubtract ÂØæÂøú
            
            // ÁâπÊÆä„Ç≠„Éº„ÅÆÂá¶ÁêÜ
            if (key === 'enter') {
                event.preventDefault();
                // „ÅÑ„Åö„Çå„Åã„ÅÆÂÄôË£ú„ÅåÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Çå„Å∞ÈÄÅ‰ø°
                if (typingState.currentInputs.some(input => input.completed)) {
                    submitAnswer();
                }
                return;
            }
            
            if (key === 'escape') {
                event.preventDefault();
                giveUp();
                return;
            }
            
            // „Ç¢„É´„Éï„Ç°„Éô„ÉÉ„Éà„Éª„Éè„Ç§„Éï„É≥„Éª„Ç¢„Éù„Çπ„Éà„É≠„Éï„Ç£„ÇíË®±ÂèØÔºàÂÖ®Ëßí„ÇÇÂØæÂøúÔºâ
            if (!/^[a-z\-']$/.test(key)) return;
            
            event.preventDefault();
            
            // ÂÖ®ÂÄôË£ú„Å´ÂØæ„Åó„Å¶„Ç≠„ÉºÂÖ•Âäõ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            let anyMatch = false;
            let completedCount = 0;
            
            typingState.currentInputs.forEach((input, index) => {
                if (input.completed) {
                    completedCount++;
                    return; // Êó¢„Å´ÂÆå‰∫Ü„Åó„Å¶„ÅÑ„ÇãÂÄôË£ú„ÅØ„Çπ„Ç≠„ÉÉ„Éó
                }
                
                const targetRomaji = typingState.targetOptions[index];
                const expectedKey = targetRomaji[input.position];
                
                if (key === expectedKey) {
                    input.position++;
                    input.typed += key;
                    anyMatch = true;
                    
                    // „Åì„ÅÆÂÄôË£ú„ÅåÂÆå‰∫Ü„Åó„Åü„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                    if (input.position >= targetRomaji.length) {
                        input.completed = true;
                        completedCount++;
                        console.log(`ÂÄôË£ú${index}ÂÆå‰∫Ü: ${targetRomaji}`);
                    }
                }
            });
            
            if (anyMatch) {
                // Ê≠£„Åó„ÅÑ„Ç≠„Éº
                typingState.typedKeys += key;
                
                // ÂÄôË£ú„ÇíÈñìÂºï„ÅèÔºöÂÖ•Âäõ„Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„Å´‰∏ÄËá¥„Åô„Çã„ÇÇ„ÅÆ„ÅÆ„ÅøÊÆã„Åô
                const pref = typingState.typedKeys;
                const validIndices = [];
                
                typingState.targetOptions.forEach((opt, i) => {
                    if (opt.startsWith(pref)) {
                        validIndices.push(i);
                    }
                });
                
                // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞ÂÆüË°å
                typingState.targetOptions = validIndices.map(i => typingState.targetOptions[i]);
                typingState.currentInputs = validIndices.map(i => typingState.currentInputs[i]);
                
                updateRomajiDisplay();
                updateTypingGuideProgress();
                refreshRomajiGuideToLeader();
                
                // „ÅÑ„Åö„Çå„Åã„ÅÆÂÄôË£ú„ÅåÂÆå‰∫Ü„Åó„Åü„ÇâÂç≥Â∫ß„Å´ÈÄÅ‰ø°
                if (completedCount > 0) {
                    console.log('ÂÖ•ÂäõÂÆå‰∫ÜÊ§úÂá∫ - Âç≥Â∫ß„Å´ÈÄÅ‰ø°');
                    // „Çø„Ç§„Éû„Éº„ÇíÂÅúÊ≠¢
                    stopTimer();
                    // Â∞ë„ÅóÈÅÖÂª∂„ÇíÂÖ•„Çå„Å¶Á¢∫ÂÆü„Å´Âá¶ÁêÜ
                    setTimeout(() => {
                        submitAnswer();
                    }, 50);
                }
            } else {
                // ÈñìÈÅï„Å£„Åü„Ç≠„Éº - 2Áßí„Éö„Éä„É´„ÉÜ„Ç£
                adjustTimer(-2000);           // ‚Üê „Åì„Çå„Å†„Åë„ÅßOK
                showPenaltyEffect();
                playSound('fail');
            }
        }

        // „É≠„Éº„ÉûÂ≠ó„Ç¨„Ç§„Éâ„ÇíÊúÄ„ÇÇÈÄ≤„Çì„Å†ÂÄôË£ú„Å´Êõ¥Êñ∞
        function refreshRomajiGuideToLeader() {
            const romajiEl = document.getElementById('romajiGuide');
            if (!typingState.currentInputs.length) return;

            let leaderIdx = 0, best = -1;
            typingState.currentInputs.forEach((inp, i) => {
                if (inp.position > best) { best = inp.position; leaderIdx = i; }
            });

            const leader = typingState.targetOptions[leaderIdx] || '';
            const pos = typingState.currentInputs[leaderIdx].position || 0;

            romajiEl.innerHTML = [...leader].map((ch, i) =>
                `<span class="romaji-char ${i < pos ? 'typed' : (i === pos ? 'current' : '')}" data-index="${i}">${ch}</span>`
            ).join('');
        }

        // „É≠„Éº„ÉûÂ≠óË°®Á§∫Êõ¥Êñ∞ÔºàË§áÊï∞ÂÄôË£úÂØæÂøúÔºâ
        function updateRomajiDisplay() {
            refreshRomajiGuideToLeader();
        }

        // „Ç®„Éï„Çß„ÇØ„Éà„É¨„Ç§„É§„ÉºÂèñÂæó/‰ΩúÊàê
        function getOrCreateFxLayer() {
            let fxLayer = document.querySelector('.fx-layer');
            if (!fxLayer) {
                fxLayer = document.createElement('div');
                fxLayer.className = 'fx-layer';
                fxLayer.setAttribute('aria-hidden', 'true');
                document.body.appendChild(fxLayer);
            }
            return fxLayer;
        }

        function getFXScale(){
            if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return 0.4;
            const mem   = navigator.deviceMemory || 4;
            const cores = navigator.hardwareConcurrency || 4;
            const saveData = navigator.connection && navigator.connection.saveData;
            let scale = 1.0;
            if (mem <= 2)   scale *= 0.5;
            if (cores <= 4) scale *= 0.7;
            if (saveData)   scale *= 0.6;
            if (Math.min(window.innerWidth, window.innerHeight) < 700) scale *= 0.8; // Â∞èÁîªÈù¢
            return Math.max(0.3, Math.min(1, scale));
        }

        // Â±ûÊÄßÂà•Ë®≠ÂÆö„ÉÜ„Éº„Éñ„É´
        const ATTACK_CONFIGS = {
            fire: {
                colors: ['#ff6b6b', '#feca57', '#ff9f43'],
                particles: 80,
                speed: 1.0,
                flashColor: 'rgba(255, 107, 107, 0.6)',
                glowColor: '#ff6b6b'
            },
            water: {
                colors: ['#4ecdc4', '#76e0ff', '#00d2d3'],
                particles: 100,
                speed: 1.2,
                flashColor: 'rgba(76, 224, 255, 0.5)',
                glowColor: '#4ecdc4'
            },
            thunder: {
                colors: ['#ffe66d', '#fff', '#f1c40f'],
                particles: 60,
                speed: 2.0,
                flashColor: 'rgba(255, 255, 255, 0.8)',
                glowColor: '#ffe66d'
            },
            wind: {
                colors: ['#95e1d3', '#a8e6cf', '#88d8c0'],
                particles: 70,
                speed: 1.5,
                flashColor: 'rgba(149, 225, 211, 0.4)',
                glowColor: '#95e1d3'
            },
            earth: {
                colors: ['#a8e6cf', '#8bc34a', '#689f38'],
                particles: 60,
                speed: 0.8,
                flashColor: 'rgba(168, 230, 207, 0.5)',
                glowColor: '#a8e6cf'
            },
            light: {
                colors: ['#ffd93d', '#ffffff', '#f39c12'],
                particles: 90,
                speed: 1.8,
                flashColor: 'rgba(255, 255, 255, 0.9)',
                glowColor: '#ffd93d'
            }
        };

        // ÊîªÊíÉ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆüË°å
        async function playAttackAnimation({ attr, from, targetEl, impactMs = 600 }) {
            const config = ATTACK_CONFIGS[attr];
            const fxLayer = getOrCreateFxLayer();
            
            // ÊîªÊíÉËÄÖ„Å®ÂØæË±°„ÅÆ‰ΩçÁΩÆ„ÇíÂèñÂæó
            const attackerEl = document.getElementById(`player${gameState.currentPlayer + 1}Avatar`);
            const attackerRect = attackerEl.getBoundingClientRect();
            const targetRect = targetEl.getBoundingClientRect();
            
            const startX = from === 'left' ? attackerRect.right : attackerRect.left;
            const startY = attackerRect.top + attackerRect.height / 2;
            const endX = targetRect.left + targetRect.width / 2;
            const endY = targetRect.top + targetRect.height / 2;

            // „Éï„Çß„Éº„Ç∫1: Ê∫ú„ÇÅ„Ç®„Éï„Çß„ÇØ„Éà
            await playChargeEffect(attackerEl, config);
            
            // „Éï„Çß„Éº„Ç∫2: È£õ„Å≥ÈÅìÂÖ∑ÁßªÂãï
            await playProjectileEffect(fxLayer, attr, config, startX, startY, endX, endY, impactMs);
            
            // „Éï„Çß„Éº„Ç∫3: „Éí„ÉÉ„Éà„Ç®„Éï„Çß„ÇØ„Éà
            await playImpactEffect(fxLayer, attr, config, endX, endY);
            
            return Promise.resolve();
        }

        // „Éï„Çß„Éº„Ç∫1: Ê∫ú„ÇÅ„Ç®„Éï„Çß„ÇØ„Éà
        function playChargeEffect(attackerEl, config) {
            return new Promise((resolve) => {
                // Ê∫ú„ÇÅÈü≥
                playSound('charge');
                
                // „Ç∞„É≠„ÉºÂäπÊûú
                attackerEl.style.setProperty('--glow-color', config.glowColor);
                attackerEl.style.animation = 'chargeGlow 300ms ease-out forwards';
                
                setTimeout(() => {
                    attackerEl.style.animation = '';
                    attackerEl.style.transform = '';
                    attackerEl.style.boxShadow = '';
                    resolve();
                }, 300);
            });
        }

        // „Éï„Çß„Éº„Ç∫2: È£õ„Å≥ÈÅìÂÖ∑„Ç®„Éï„Çß„ÇØ„ÉàÔºàÁîªÈù¢ÂÖ®‰Ωì„Çπ„Ç±„Éº„É´Ôºâ
        function playProjectileEffect(fxLayer, attr, config, startX, startY, endX, endY, duration) {
            return new Promise((resolve) => {
                const projectile = createProjectile(attr, config, startX, startY);
                fxLayer.appendChild(projectile);
                
                // ÁßªÂãï„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÔºàÁîªÈù¢ÂÖ®‰Ωì„Çí‰Ωø„Å£„ÅüÂ§ß„Åç„Å™ËªåÈÅìÔºâ
                const deltaX = endX - startX;
                const deltaY = endY - startY;
                
                // Âºß„ÇíÊèè„ÅèËªåÈÅì„ÇíË®àÁÆóÔºà„Çà„ÇäÂ§ß„Åç„Å™„Çπ„Ç±„Éº„É´Ôºâ
                const midX = (startX + endX) / 2;
                const midY = Math.min(startY, endY) - Math.abs(deltaX) * 0.3; // „Çà„ÇäÈ´ò„ÅÑÂºß
                
                const keyframes = [
                    { 
                        transform: `translate3d(0, 0, 0) scale(1)`,
                        opacity: 1
                    },
                    { 
                        transform: `translate3d(${(midX - startX)}px, ${(midY - startY)}px, 0) scale(1.5)`,
                        opacity: 1,
                        offset: 0.5
                    },
                    { 
                        transform: `translate3d(${deltaX}px, ${deltaY}px, 0) scale(2)`,
                        opacity: 0.8
                    }
                ];
                
                projectile.animate(keyframes, {
                    duration: duration * config.speed,
                    easing: 'cubic-bezier(0.22, 1, 0.36, 1)',
                    fill: 'forwards'
                }).addEventListener('finish', () => {
                    projectile.remove();
                    resolve();
                });
            });
        }

        // Â±ûÊÄßÂà•È£õ„Å≥ÈÅìÂÖ∑‰ΩúÊàêÔºàÂ§ßÂûãÂåñÔºâ
        function createProjectile(attr, config, x, y) {
            const projectile = document.createElement('div');
            projectile.className = 'projectile';
            projectile.style.left = x + 'px';
            projectile.style.top = y + 'px';
            
            switch (attr) {
                case 'fire':
                    projectile.innerHTML = 'üî•';
                    projectile.style.fontSize = '80px';
                    projectile.style.filter = `drop-shadow(0 0 40px ${config.colors[0]}) drop-shadow(0 0 80px ${config.colors[1]})`;
                    projectile.style.animation = 'fireball 0.6s linear infinite';
                    // ÁÅ´„ÅÆÁ≤íÂ≠ê„Éà„É¨„Ç§„É´ËøΩÂä†
                    for (let i = 0; i < 5; i++) {
                        const trail = document.createElement('div');
                        trail.innerHTML = 'üî•';
                        trail.style.position = 'absolute';
                        trail.style.fontSize = '20px';
                        trail.style.opacity = '0.6';
                        trail.style.left = `-${i * 15}px`;
                        trail.style.top = '0px';
                        trail.style.animation = `fireball ${0.6 + i * 0.1}s linear infinite`;
                        projectile.appendChild(trail);
                    }
                    break;
                    
                case 'water':
                    projectile.style.width = '120px';
                    projectile.style.height = '16px';
                    projectile.style.background = `linear-gradient(90deg, transparent, ${config.colors[0]}, ${config.colors[1]}, transparent)`;
                    projectile.style.borderRadius = '8px';
                    projectile.style.boxShadow = `0 0 30px ${config.colors[0]}, 0 0 60px ${config.colors[1]}`;
                    projectile.style.animation = 'waterBlade 0.5s ease-in-out infinite';
                    // Ê∞¥Êª¥„Ç®„Éï„Çß„ÇØ„ÉàËøΩÂä†
                    for (let i = 0; i < 3; i++) {
                        const drop = document.createElement('div');
                        drop.innerHTML = 'üíß';
                        drop.style.position = 'absolute';
                        drop.style.fontSize = '24px';
                        drop.style.left = `${i * 30}px`;
                        drop.style.top = '-10px';
                        drop.style.animation = `waterBlade ${0.5 + i * 0.1}s ease-in-out infinite`;
                        projectile.appendChild(drop);
                    }
                    break;
                    
                case 'thunder':
                    projectile.innerHTML = '‚ö°';
                    projectile.style.fontSize = '100px';
                    projectile.style.filter = `drop-shadow(0 0 50px ${config.colors[1]}) drop-shadow(0 0 100px white)`;
                    projectile.style.animation = 'lightning 0.1s linear infinite';
                    // ÈõªÊíÉ„Ç®„Éï„Çß„ÇØ„ÉàËøΩÂä†
                    for (let i = 0; i < 4; i++) {
                        const bolt = document.createElement('div');
                        bolt.style.position = 'absolute';
                        bolt.style.width = '4px';
                        bolt.style.height = '60px';
                        bolt.style.background = config.colors[1];
                        bolt.style.left = `${Math.random() * 60 - 30}px`;
                        bolt.style.top = `${Math.random() * 60 - 30}px`;
                        bolt.style.transform = `rotate(${Math.random() * 360}deg)`;
                        bolt.style.boxShadow = `0 0 20px ${config.colors[1]}`;
                        bolt.style.animation = 'lightning 0.05s linear infinite';
                        projectile.appendChild(bolt);
                    }
                    break;
                    
                case 'wind':
                    projectile.innerHTML = 'üå™Ô∏è';
                    projectile.style.fontSize = '90px';
                    projectile.style.filter = `drop-shadow(0 0 30px ${config.colors[0]})`;
                    projectile.style.animation = 'windBlade 0.4s ease-out infinite';
                    // È¢®„ÅÆÊ∏¶„Ç®„Éï„Çß„ÇØ„ÉàËøΩÂä†
                    for (let i = 0; i < 6; i++) {
                        const swirl = document.createElement('div');
                        swirl.style.position = 'absolute';
                        swirl.style.width = '20px';
                        swirl.style.height = '20px';
                        swirl.style.border = `2px solid ${config.colors[0]}`;
                        swirl.style.borderRadius = '50%';
                        swirl.style.left = `${Math.cos(i * Math.PI / 3) * 40}px`;
                        swirl.style.top = `${Math.sin(i * Math.PI / 3) * 40}px`;
                        swirl.style.animation = `windBlade ${0.4 + i * 0.05}s ease-out infinite`;
                        projectile.appendChild(swirl);
                    }
                    break;
                    
                case 'earth':
                    projectile.innerHTML = 'ü™®';
                    projectile.style.fontSize = '70px';
                    projectile.style.filter = `drop-shadow(0 0 20px ${config.colors[0]})`;
                    projectile.style.animation = 'rockSpike 0.3s ease-out infinite';
                    // Â≤©„ÅÆÁ†¥Áâá„Ç®„Éï„Çß„ÇØ„ÉàËøΩÂä†
                    for (let i = 0; i < 4; i++) {
                        const rock = document.createElement('div');
                        rock.innerHTML = 'ü™®';
                        rock.style.position = 'absolute';
                        rock.style.fontSize = '16px';
                        rock.style.left = `${(i % 2) * 40 - 20}px`;
                        rock.style.top = `${Math.floor(i / 2) * 40 - 20}px`;
                        rock.style.animation = `rockSpike ${0.3 + i * 0.1}s ease-out infinite`;
                        projectile.appendChild(rock);
                    }
                    break;
                    
case 'light': {
  const ring = document.createElement('div');
  ring.style.position = 'absolute';
  ring.style.left = (x - 100) + 'px';
  ring.style.top = (y - 100) + 'px';
  ring.style.width = '200px';
  ring.style.height = '200px';
  ring.style.border = `8px solid ${config.colors[0]}`;
  ring.style.borderRadius = '50%';
  ring.style.boxShadow = `0 0 60px ${config.colors[0]}, inset 0 0 60px white`;
  ring.style.opacity = '0.9';
  fxLayer.appendChild(ring);

  ring.animate(
    [{ transform:'scale(0.4)', opacity:0 }, { transform:'scale(4)', opacity:0 }],
    { duration: 900, easing:'ease-out' }
  ).addEventListener('finish', () => ring.remove());

  // ÊòüÁ≤í
  for (let i = 0; i < Math.round(6 * getFXScale()); i++) {
    const star = document.createElement('div');
    star.textContent = '‚ú®';
    star.style.position = 'absolute';
    star.style.left = x + 'px';
    star.style.top = y + 'px';
    star.style.fontSize = (16 + Math.random()*10) + 'px';
    fxLayer.appendChild(star);
    const dx = (Math.random()*2-1) * 240;
    const dy = (Math.random()*2-1) * 240;
    star.animate(
      [{ transform:'translate(0,0)', opacity:1 }, { transform:`translate(${dx}px,${dy}px)`, opacity:0 }],
      { duration: 800 + Math.random()*500, easing:'ease-out' }
    ).addEventListener('finish', () => star.remove());
  }
  break;
}
// ‚Üê switch „ÅÆ default/break „Å®Èñ¢Êï∞„ÅÆÈñâ„Åò„Ç´„ÉÉ„Ç≥„Åæ„ÅßÂøò„Çå„Åö„Å´ÔºÅ


        // „Éï„Çß„Éº„Ç∫3: „Éí„ÉÉ„Éà„Ç®„Éï„Çß„ÇØ„Éà
        function playImpactEffect(fxLayer, attr, config, x, y) {
            return new Promise((resolve) => {
                // „Éí„ÉÉ„ÉàÈü≥
                playSound('success');
                
                // ÁîªÈù¢„Ç∑„Çß„Ç§„ÇØ
                if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                    document.body.classList.add('shake-strong');
                    setTimeout(() => {
                        document.body.classList.remove('shake-strong');
                    }, 400);
                }
                
                // „Éï„É©„ÉÉ„Ç∑„É•„Ç®„Éï„Çß„ÇØ„Éà
                const flash = document.createElement('div');
                flash.className = 'impact-flash';
                flash.style.background = config.flashColor;
                flash.style.opacity = '0';
                fxLayer.appendChild(flash);
                
                flash.animate([
                    { opacity: 0 },
                    { opacity: 1 },
                    { opacity: 0 }
                ], {
                    duration: 200,
                    easing: 'ease-out'
                }).addEventListener('finish', () => {
                    flash.remove();
                });
                
                // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÁàÜÁô∫
                createParticleExplosion(fxLayer, attr, config, x, y);
                
                // Â±ûÊÄßÂà•ÁâπÊÆä„Ç®„Éï„Çß„ÇØ„Éà
                createSpecialImpactEffect(fxLayer, attr, config, x, y);
                
                setTimeout(resolve, 500);
            });
        }

        // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÁàÜÁô∫ÁîüÊàêÔºàÁîªÈù¢ÂÖ®‰Ωì„Çπ„Ç±„Éº„É´Ôºâ
        function createParticleExplosion(fxLayer, attr, config, x, y) {
            const particleCount = Math.round(Math.min(config.particles, 120) * getFXScale());
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                const size = Math.random() * 16 + 8; // „Çà„ÇäÂ§ß„Åç„Å™„Éë„Éº„ÉÜ„Ç£„ÇØ„É´
                const angle = (i / particleCount) * Math.PI * 2;
                const distance = Math.random() * 300 + 100; // „Çà„ÇäÂ∫ÉÁØÑÂõ≤„Å´Êï£„Çâ„Å∞„Çã
                const dx = Math.cos(angle) * distance;
                const dy = Math.sin(angle) * distance;
                
                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                particle.style.left = (x - size/2) + 'px';
                particle.style.top = (y - size/2) + 'px';
                particle.style.background = config.colors[Math.floor(Math.random() * config.colors.length)];
                particle.style.borderRadius = '50%';
                particle.style.boxShadow = `0 0 ${size}px ${config.colors[0]}`;
                particle.style.setProperty('--dx', dx + 'px');
                particle.style.setProperty('--dy', dy + 'px');
                
                fxLayer.appendChild(particle);
                
                particle.animate([
                    { 
                        transform: 'scale(0) translate3d(0, 0, 0) rotate(0deg)',
                        opacity: 1
                    },
                    { 
                        transform: `scale(1.5) translate3d(${dx * 0.7}px, ${dy * 0.7}px, 0) rotate(180deg)`,
                        opacity: 0.8,
                        offset: 0.6
                    },
                    { 
                        transform: `scale(0.5) translate3d(${dx}px, ${dy}px, 0) rotate(360deg)`,
                        opacity: 0
                    }
                ], {
                    duration: 1200 + Math.random() * 600,
                    easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
                }).addEventListener('finish', () => {
                    particle.remove();
                });
            }
        }

        // Â±ûÊÄßÂà•ÁâπÊÆä„Ç§„É≥„Éë„ÇØ„Éà„Ç®„Éï„Çß„ÇØ„ÉàÔºàÁîªÈù¢ÂÖ®‰Ωì„Çπ„Ç±„Éº„É´Ôºâ
        function createSpecialImpactEffect(fxLayer, attr, config, x, y) {
            switch (attr) {
                case 'fire':
                    // Â∑®Â§ßÁÅ´Ëä±„É™„É≥„Ç∞
                    const fxScale = getFXScale();
                    for (let i = 0; i < Math.round(5 * fxScale); i++) {
                        const ring = document.createElement('div');
                        ring.style.position = 'absolute';
                        ring.style.left = (x - 100) + 'px';
                        ring.style.top = (y - 100) + 'px';
                        ring.style.width = '200px';
                        ring.style.height = '200px';
                        ring.style.border = `6px solid ${config.colors[0]}`;
                        ring.style.borderRadius = '50%';
                        ring.style.opacity = '0.8';
                        ring.style.boxShadow = `0 0 40px ${config.colors[0]}, inset 0 0 40px ${config.colors[1]}`;
                        fxLayer.appendChild(ring);
                        
                        ring.animate([
                            { transform: 'scale(0) rotate(0deg)', opacity: 0.8 },
                            { transform: 'scale(6) rotate(360deg)', opacity: 0 }
                        ], {
                            duration: 1000,
                            delay: i * 150,
                            easing: 'ease-out'
                        }).addEventListener('finish', () => ring.remove());
                    }
                    
                    // ÁÅ´„ÅÆÊü±„Ç®„Éï„Çß„ÇØ„Éà
                    const firePillar = document.createElement('div');
                    firePillar.style.position = 'absolute';
                    firePillar.style.left = (x - 50) + 'px';
                    firePillar.style.top = '0px';
                    firePillar.style.width = '100px';
                    firePillar.style.height = '100vh';
                    firePillar.style.background = `linear-gradient(0deg, transparent, ${config.colors[0]}, ${config.colors[1]}, transparent)`;
                    firePillar.style.opacity = '0.6';
                    fxLayer.appendChild(firePillar);
                    
                    firePillar.animate([
                        { opacity: 0, transform: 'scaleX(0)' },
                        { opacity: 0.6, transform: 'scaleX(1)' },
                        { opacity: 0, transform: 'scaleX(0)' }
                    ], {
                        duration: 800,
                        easing: 'ease-out'
                    }).addEventListener('finish', () => firePillar.remove());
                    break;
                    
                case 'water':
                    // Â∑®Â§ßÊ∞¥„ÅÆ„É™„ÉÉ„Éó„É´
                    const waterFxScale = getFXScale();
                    for (let i = 0; i < Math.round(4 * waterFxScale); i++) {
                        const ripple = document.createElement('div');
                        ripple.style.position = 'absolute';
                        ripple.style.left = (x - 150) + 'px';
                        ripple.style.top = (y - 150) + 'px';
                        ripple.style.width = '300px';
                        ripple.style.height = '300px';
                        ripple.style.border = `8px solid ${config.colors[1]}`;
                        ripple.style.borderRadius = '50%';
                        ripple.style.opacity = '0.7';
                        ripple.style.boxShadow = `0 0 60px ${config.colors[0]}`;
                        fxLayer.appendChild(ripple);
                        
                        ripple.animate([
                            { transform: 'scale(0)', opacity: 0.7 },
                            { transform: 'scale(8)', opacity: 0 }
                        ], {
                            duration: 1200,
                            delay: i * 250,
                            easing: 'ease-out'
                        }).addEventListener('finish', () => ripple.remove());
                    }
                    
                    // Ê∞¥„ÅÆÊ≥¢„Ç®„Éï„Çß„ÇØ„Éà
                    const wave = document.createElement('div');
                    wave.style.position = 'absolute';
                    wave.style.left = '0px';
                    wave.style.top = (y - 25) + 'px';
                    wave.style.width = '100vw';
                    wave.style.height = '50px';
                    wave.style.background = `linear-gradient(90deg, transparent, ${config.colors[0]}, ${config.colors[1]}, transparent)`;
                    wave.style.opacity = '0.5';
                    fxLayer.appendChild(wave);
                    
                    wave.animate([
                        { opacity: 0, transform: 'scaleY(0)' },
                        { opacity: 0.5, transform: 'scaleY(1)' },
                        { opacity: 0, transform: 'scaleY(0)' }
                    ], {
                        duration: 600,
                        easing: 'ease-out'
                    }).addEventListener('finish', () => wave.remove());
                    break;
                    
                case 'thunder':
                    // Â∑®Â§ßÈõªÊíÉ„Ç¢„Éº„ÇØ
                    const thunderFxScale = getFXScale();
                    for (let i = 0; i < Math.round(8 * thunderFxScale); i++) {
                        const arc = document.createElement('div');
                        arc.style.position = 'absolute';
                        arc.style.left = x + 'px';
                        arc.style.top = y + 'px';
                        arc.style.width = '8px';
                        arc.style.height = (Math.random() * 200 + 100) + 'px';
                        arc.style.background = config.colors[1];
                        arc.style.transformOrigin = 'top';
                        arc.style.transform = `rotate(${Math.random() * 360}deg)`;
                        arc.style.boxShadow = `0 0 40px ${config.colors[1]}, 0 0 80px white`;
                        fxLayer.appendChild(arc);
                        
                        arc.animate([
                            { opacity: 1, transform: `rotate(${Math.random() * 360}deg) scaleY(1)` },
                            { opacity: 0, transform: `rotate(${Math.random() * 360}deg) scaleY(0)` }
                        ], {
                            duration: 400,
                            delay: Math.random() * 300,
                            easing: 'ease-out'
                        }).addEventListener('finish', () => arc.remove());
                    }
                    
                    // ÁîªÈù¢ÂÖ®‰Ωì„ÅÆÈõªÊíÉ„Éï„É©„ÉÉ„Ç∑„É•
                    const lightning = document.createElement('div');
                    lightning.style.position = 'absolute';
                    lightning.style.left = '0px';
                    lightning.style.top = '0px';
                    lightning.style.width = '100vw';
                    lightning.style.height = '100vh';
                    lightning.style.background = `radial-gradient(circle at ${x}px ${y}px, ${config.colors[1]} 0%, transparent 50%)`;
                    lightning.style.opacity = '0';
                    fxLayer.appendChild(lightning);
                    
                    lightning.animate([
                        { opacity: 0 },
                        { opacity: 0.8 },
                        { opacity: 0 },
                        { opacity: 0.6 },
                        { opacity: 0 }
                    ], {
                        duration: 500,
                        easing: 'ease-out'
                    }).addEventListener('finish', () => lightning.remove());
                    break;
                    
                case 'wind':
                    // Â∑®Â§ßÁ´úÂ∑ª„Ç®„Éï„Çß„ÇØ„Éà
                    const windFxScale = getFXScale();
                    for (let i = 0; i < Math.round(3 * windFxScale); i++) {
                        const tornado = document.createElement('div');
                        tornado.style.position = 'absolute';
                        tornado.style.left = (x - 75) + 'px';
                        tornado.style.top = '0px';
                        tornado.style.width = '150px';
                        tornado.style.height = '100vh';
                        tornado.style.background = `conic-gradient(from ${i * 120}deg, transparent, ${config.colors[0]}, transparent)`;
                        tornado.style.opacity = '0.4';
                        tornado.style.borderRadius = '50%';
                        fxLayer.appendChild(tornado);
                        
                        tornado.animate([
                            { transform: 'rotate(0deg) scaleX(0)', opacity: 0 },
                            { transform: 'rotate(720deg) scaleX(1)', opacity: 0.4 },
                            { transform: 'rotate(1440deg) scaleX(0)', opacity: 0 }
                        ], {
                            duration: 1000,
                            delay: i * 200,
                            easing: 'ease-out'
                        }).addEventListener('finish', () => tornado.remove());
                    }
                    break;
                    
                case 'earth':
                    // Âú∞Èù¢ÂÖ®‰Ωì„ÅÆ‰∫ÄË£Ç„Ç®„Éï„Çß„ÇØ„Éà
                    const earthFxScale = getFXScale();
                    for (let i = 0; i < Math.round(6 * earthFxScale); i++) {
                        const crack = document.createElement('div');
                        crack.style.position = 'absolute';
                        crack.style.left = '0px';
                        crack.style.top = (y + Math.random() * 100 - 50) + 'px';
                        crack.style.width = '100vw';
                        crack.style.height = '4px';
                        crack.style.background = config.colors[2] || config.colors[0];
                        crack.style.opacity = '0.8';
                        crack.style.transform = `rotate(${Math.random() * 10 - 5}deg)`;
                        fxLayer.appendChild(crack);
                        
                        crack.animate([
                            { transform: `scaleX(0) rotate(${Math.random() * 10 - 5}deg)`, opacity: 0 },
                            { transform: `scaleX(1) rotate(${Math.random() * 10 - 5}deg)`, opacity: 0.8 },
                            { transform: `scaleX(1) rotate(${Math.random() * 10 - 5}deg)`, opacity: 0 }
                        ], {
                            duration: 800,
                            delay: i * 100,
                            easing: 'ease-out'
                        }).addEventListener('finish', () => crack.remove());
                    }
                    break;
                    
                                case 'light': {
                    // „Ç∑„É≥„Éó„É´„Å™ÊòüÂûã„Éê„Éº„Çπ„ÉàÔºãÂ§ñÂë®„É™„É≥„Ç∞Ôºà‰ªÆÂÆüË£Ö„Åß„ÇÇÂçÅÂàÜÊò†„Åà„ÇãÔºâ
                    const ring = document.createElement('div');
                    ring.style.position = 'absolute';
                    ring.style.left = (x - 100) + 'px';
                    ring.style.top = (y - 100) + 'px';
                    ring.style.width = '200px';
                    ring.style.height = '200px';
                    ring.style.borderRadius = '50%';
                    ring.style.boxShadow = `0 0 60px ${config.colors[0]}, inset 0 0 40px white`;
                    ring.style.opacity = '0.9';
                    fxLayer.appendChild(ring);

                    ring.animate(
                        [{ transform: 'scale(0)', opacity: 1 },
                         { transform: 'scale(5)', opacity: 0 }],
                        { duration: 700, easing: 'ease-out' }
                    ).addEventListener('finish', () => ring.remove());

                    // ÂÖâ„ÅÆÊòüÁ≤í„ÇíÂõõÊñπ„Å´
                    for (let i = 0; i < 24; i++) {
                        const p = document.createElement('div');
                        p.textContent = '‚ú®';
                        p.style.position = 'absolute';
                        p.style.left = x + 'px';
                        p.style.top = y + 'px';
                        p.style.fontSize = (16 + Math.random() * 10) + 'px';
                        p.style.filter = 'drop-shadow(0 0 8px white)';
                        fxLayer.appendChild(p);

                        const ang = (i / 24) * Math.PI * 2;
                        const dist = 160 + Math.random() * 120;
                        const dx = Math.cos(ang) * dist;
                        const dy = Math.sin(ang) * dist;

                        p.animate(
                            [{ transform: 'translate(0,0) scale(0.8)', opacity: 1 },
                             { transform: `translate(${dx}px, ${dy}px) scale(1.2)`, opacity: 0 }],
                            { duration: 800 + Math.random() * 300, easing: 'ease-out' }
                        ).addEventListener('finish', () => p.remove());
                    }
                    break;
                }
            } // ‚Üê switch(attr) „ÅÆÈñâ„Åò
        } // ‚Üê function createSpecialImpactEffect „ÅÆÈñâ„Åò


        // Ë¢´Âºæ„Ç®„Éï„Çß„ÇØ„ÉàÔºà‰∏çÊ≠£Ëß£ÊôÇÔºâ
        function playHitEffect(playerIndex) {
            const avatarEl = document.getElementById(`player${playerIndex + 1}Avatar`);
            const fxLayer = getOrCreateFxLayer();
            
            // ÁÖô„Ç®„Éï„Çß„ÇØ„Éà
            const smoke = document.createElement('div');
            smoke.innerHTML = 'üí®';
            smoke.style.position = 'absolute';
            smoke.style.fontSize = '30px';
            smoke.style.opacity = '0.8';
            
            const rect = avatarEl.getBoundingClientRect();
            smoke.style.left = rect.left + 'px';
            smoke.style.top = rect.top + 'px';
            
            fxLayer.appendChild(smoke);
            
            smoke.animate([
                { transform: 'scale(0.5) translateY(0)', opacity: 0.8 },
                { transform: 'scale(1.5) translateY(-30px)', opacity: 0 }
            ], {
                duration: 600,
                easing: 'ease-out'
            }).addEventListener('finish', () => smoke.remove());
            
            // Ëµ§„Éï„É©„ÉÉ„Ç∑„É•
            const flash = document.createElement('div');
            flash.className = 'impact-flash';
            flash.style.background = 'rgba(255, 107, 107, 0.4)';
            fxLayer.appendChild(flash);
            
            flash.animate([
                { opacity: 0 },
                { opacity: 1 },
                { opacity: 0 }
            ], {
                duration: 300,
                easing: 'ease-out'
            }).addEventListener('finish', () => flash.remove());
        }

        // HPÁÆ°ÁêÜ„ÅÆÁµ±‰∏ÄÈñ¢Êï∞Ôºà‰∫ãÊïÖÈò≤Ê≠¢Ôºâ
        function setHp(playerIndex, value) {
            const player = gameState.players[playerIndex];
            player.hp = Math.max(0, Math.min(player.maxHp, value));
            updateUI();
        }

        function addHp(playerIndex, delta) {
            setHp(playerIndex, gameState.players[playerIndex].hp + delta);
        }

        // „Éö„Éä„É´„ÉÜ„Ç£„Ç®„Éï„Çß„ÇØ„ÉàË°®Á§∫
        function showPenaltyEffect() {
            const timerRing = document.getElementById('timerRing');
            const penaltyElement = document.createElement('div');
            penaltyElement.className = 'damage-number';
            penaltyElement.textContent = '-2Áßí';
            penaltyElement.style.left = '50%';
            penaltyElement.style.top = '20%';
            penaltyElement.style.color = '#ff6b6b';
            penaltyElement.style.fontSize = '20px';
            
            timerRing.style.position = 'relative';
            timerRing.appendChild(penaltyElement);
            
            // „Çø„Ç§„Éû„Éº„É™„É≥„Ç∞„ÇíËµ§„ÅèÁÇπÊªÖ„Å®„Ç∑„Çß„Ç§„ÇØ
            timerRing.style.boxShadow = '0 0 20px rgba(255, 107, 107, 0.8)';
            timerRing.classList.add('shake');
            setTimeout(() => {
                timerRing.style.boxShadow = '';
                timerRing.classList.remove('shake');
                if (penaltyElement.parentNode) {
                    penaltyElement.remove();
                }
            }, 1000);
        }

        // ÊôÇÈñìÂàá„Çå
        function timeUp() {
            if (!gameState.selectedCard || gameState.gamePhase !== 'typing') return;
            
            // ÂÖ•Âäõ„Éè„É≥„Éâ„É©„Éº„ÇíÂç≥Â∫ß„Å´ÁÑ°ÂäπÂåñ
            disableTyping();
            clearTypingDisplay();
            
            // Áµ±Ë®àÊõ¥Êñ∞
            const targetLen = countChars(gameState.selectedCard.text);
            const currentPlayerIndex = gameState.currentPlayer;
            
            gameState.playerStats[currentPlayerIndex].totalChars += targetLen;
            gameState.playerStats[currentPlayerIndex].totalTime += 12;
            gameState.playerStats[currentPlayerIndex].combo = 0;
            
            // ÂÖ®‰ΩìÁµ±Ë®à„ÇÇÊõ¥Êñ∞
            gameState.stats.totalChars += targetLen;
            gameState.stats.totalTime += 12;
            gameState.stats.combo = 0;
            
            // ÈõÜÁ¥Ñ„É≠„Ç∏„ÉÉ„ÇØ„Å∏ÔºàÂ§±ÊïóÊâ±„ÅÑÔºâ
            applyResult({ success: false });
        }

        // „ÇÆ„Éñ„Ç¢„ÉÉ„Éó
        function giveUp() {
            if (!gameState.selectedCard) return;
            
            // ÂÖ•Âäõ„Éè„É≥„Éâ„É©„Éº„ÇíÂç≥Â∫ß„Å´ÁÑ°ÂäπÂåñ
            disableTyping();
            clearTypingDisplay();
            
            // Áµ±Ë®àÊõ¥Êñ∞
            const targetLen = countChars(gameState.selectedCard.text);
            const timeUsed = Math.max(0, 12 - gameState.timer);
            const currentPlayerIndex = gameState.currentPlayer;
            
            gameState.playerStats[currentPlayerIndex].totalChars += targetLen;
            gameState.playerStats[currentPlayerIndex].totalTime += timeUsed;
            gameState.playerStats[currentPlayerIndex].combo = 0;
            
            // ÂÖ®‰ΩìÁµ±Ë®à„ÇÇÊõ¥Êñ∞
            gameState.stats.totalChars += targetLen;
            gameState.stats.totalTime += timeUsed;
            gameState.stats.combo = 0;
            
            applyResult({ success: false });
        }

        // Èü≥Â£∞ÂÜçÁîü
        function playSound(type) {
            if (!gameState.soundEnabled) return;
            
            ensureAudio();
            if (!audioCtx) return;
            
            // Á¢∫ÂÆü„Å™Ëµ∑Âãï„ÅÆ„Åü„ÇÅÂÜçÁîüÁõ¥Ââç„Åß„ÇÇresume
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            
            // Á∞°ÊòìÈü≥Â£∞ÔºàÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØÈÅ©Âàá„Å™Èü≥Â£∞„Éï„Ç°„Ç§„É´„Çí‰ΩøÁî®Ôºâ
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            if (type === 'success') {
                oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
                oscillator.frequency.setValueAtTime(659.25, audioCtx.currentTime + 0.1); // E5
            } else if (type === 'attack') {
                // ÊîªÊíÉÈü≥ÔºöÂäõÂº∑„ÅÑ‰ΩéÈü≥„Åã„ÇâÈ´òÈü≥„Å∏
                oscillator.frequency.setValueAtTime(150, audioCtx.currentTime); // ‰ΩéÈü≥
                oscillator.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.2);
                oscillator.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.4);
            } else if (type === 'heal') {
                // ÂõûÂæ©Èü≥ÔºöÁæé„Åó„ÅÑÂíåÈü≥
                oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
                oscillator.frequency.setValueAtTime(659.25, audioCtx.currentTime + 0.1); // E5
                oscillator.frequency.setValueAtTime(783.99, audioCtx.currentTime + 0.2); // G5
                oscillator.frequency.setValueAtTime(1046.50, audioCtx.currentTime + 0.3); // C6
            } else if (type === 'charge') {
                // Ê∫ú„ÇÅÈü≥Ôºö‰ΩéÈü≥„Åã„ÇâÈ´òÈü≥„Å∏
                oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.3);
            } else if (type === 'fail') {
                oscillator.frequency.setValueAtTime(220, audioCtx.currentTime); // A3
                oscillator.frequency.exponentialRampToValueAtTime(110, audioCtx.currentTime + 0.3); // ‰∏ãÈôç
            } else {
                oscillator.frequency.setValueAtTime(220, audioCtx.currentTime); // A3
            }
            
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + (type === 'heal' ? 0.5 : type === 'attack' ? 0.4 : 0.3));
            
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + (type === 'heal' ? 0.5 : type === 'attack' ? 0.4 : 0.3));
        }

        // „Ç≤„Éº„É†‰∏ÄÊôÇÂÅúÊ≠¢
        function pauseGame() {
            if (gameState.gamePhase !== 'typing') return;

            if (!gameState.isPaused) {
                gameState.isPaused = true;
                stopTimer(); // rAFÂÅúÊ≠¢„ÅßCPUÊ∂àË≤ª„ÇíÊäëÂà∂
                document.getElementById('pauseBtn').textContent = '‚ñ∂Ô∏è';
                showModal('‚è∏Ô∏è ‰∏ÄÊôÇÂÅúÊ≠¢', `
                    <p>„Ç≤„Éº„É†„Çí‰∏ÄÊôÇÂÅúÊ≠¢„Åó„Åæ„Åó„Åü</p>
                    <button class="btn btn-primary" onclick="resumeGame()">ÂÜçÈñã</button>
                `);
            } else {
                resumeGame();
            }
        }

        // „Ç≤„Éº„É†ÂÜçÈñã
        function resumeGame() {
            gameState.isPaused = false;
            document.getElementById('pauseBtn').textContent = '‚è∏Ô∏è';
            hideModal();
            // ÊúüÈôê„ÅØ‰øùÊåÅ„Åó„Å¶„ÅÇ„Çã„ÅÆ„ÅßÊÆã„ÇäÊôÇÈñì„ÅßÂÜçÈñã
            const remainingMs = Math.max(0, timerDeadline - performance.now());
            if (remainingMs > 0) {
                startAccurateTimer(remainingMs);
            }
        }

        // „É°„Éã„É•„Éº„Å´Êàª„Çã
        function backToMenu() {
            // „Ç≤„Éº„É†Áä∂ÊÖã„É™„Çª„ÉÉ„Éà
            gameState = {
                mode: null,
                maxHP: 200,
                players: [
                    { name: '„Éó„É¨„Ç§„É§„Éº1', hp: 200, maxHp: 200, avatar: 'üî•', attribute: 'fire' },
                    { name: 'CPU', hp: 200, maxHp: 200, avatar: 'ü§ñ', attribute: 'water' }
                ],
                currentPlayer: 0,
                selectedCard: null,
                hands: [[], []],
                deck: [],
                discard: [],
                timer: 15,
                timerInterval: null,
                gamePhase: 'cardSelect',
                soundEnabled: true,
                isPaused: false,
                playerStats: [
                    { totalChars: 0, correctChars: 0, totalTime: 0, combo: 0, maxCombo: 0 },
                    { totalChars: 0, correctChars: 0, totalTime: 0, combo: 0, maxCombo: 0 }
                ],
                stats: {
                    totalChars: 0,
                    correctChars: 0,
                    totalTime: 0,
                    combo: 0,
                    maxCombo: 0
                }
            };
            
            stopTimer();
            disableTyping();
            hideModal();
            document.getElementById('gameContainer').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
            document.getElementById('characterSelection').classList.add('hidden');
            document.getElementById('gameRules').classList.add('hidden');
            document.getElementById('player2Setup').classList.add('hidden');
            
            // ÈÅ∏ÊäûÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
            document.querySelectorAll('.mode-btn, .character-btn, .hp-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // „Éá„Éï„Ç©„É´„ÉàHPÈÅ∏Êäû
            document.querySelector('[data-hp="200"]').classList.add('selected');
            
            // ÂêçÂâçÂÖ•Âäõ„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('player1NameInput').value = '„Éó„É¨„Ç§„É§„Éº1';
            document.getElementById('player2NameInput').value = '„Éó„É¨„Ç§„É§„Éº2';
            document.getElementById('nextBtn').disabled = true;
        }

        // „Çø„Éº„É≥ÈñãÂßã
        function startTurn() {
            showTurnPopup(gameState.players[gameState.currentPlayer].name);
            updateUI();
            
            // „Ç´„Éº„ÉâË°®Á§∫„Ç®„É™„Ç¢„ÇíÂÆåÂÖ®„Å´„ÇØ„É™„Ç¢
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';
            container.classList.remove('active');
            
            // „Çø„Ç§„Éî„É≥„Ç∞„Ç¨„Ç§„Éâ„ÇÇ„ÇØ„É™„Ç¢
            clearTypingDisplay();
            
            // Êñ∞„Åó„ÅÑ„Ç´„Éº„Éâ„ÇíÊèèÁîª
            drawCards();
            drawPlayerHand();
            
            // „Çø„Ç§„Éû„Éº„É™„Çª„ÉÉ„Éà
            document.getElementById('timerRing').textContent = '12';
            document.getElementById('timerRing').style.background = 
                'conic-gradient(#feca57 360deg, rgba(255, 255, 255, 0.2) 360deg)';
            
            // CPUÂà§ÂÆö
            if (gameState.mode === 'cpu' && gameState.currentPlayer === 1) {
                setTimeout(cpuAct, 700);
            }
        }

        // ÁµêÊûúÈÅ©Áî®„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
        async function applyResult({ success }) {
            const card = gameState.selectedCard;
            const isHeal = card?.category === '„ÅÑ„Çä„Çá„ÅÜ';
            const baseLen = countChars(card?.text || '');
            const atk = gameState.currentPlayer;
            const def = 1 - atk;

            // ÂÖ•Âäõ/„Çø„Ç§„Éû„ÉºÂÅúÊ≠¢„ÇíÂÖà„Å´Áâá‰ªò„Åë
            disableTyping();
            stopTimer();

            let amount = 0;
            let effectDuration = 0; // „Ç®„Éï„Çß„ÇØ„Éà„ÅÆÂæÖÊ©üÊôÇÈñì

            if (success) {
                amount = baseLen * Math.max(0, gameState.timer); // ÊàêÂäüÔºöÊñáÂ≠óÊï∞√óÊÆã„ÇäÁßí
                if (isHeal) {
                    // Ë®àÁÆó„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫ÔºàÂõûÂæ©Ôºâ
                    showDamageCalculation(baseLen, gameState.timer, amount, true, false);
                    
                    addHp(atk, amount);
                    playSound('heal');
                    showFloatingNumber(amount, atk, true);
                    effectDuration = 1000; // ÂõûÂæ©„Ç®„Éï„Çß„ÇØ„Éà„ÅÆÊôÇÈñì
                } else {
                    // Ë®àÁÆó„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫ÔºàÊîªÊíÉÔºâ
                    showDamageCalculation(baseLen, gameState.timer, amount, false, false);
                    
                    addHp(def, -amount);
                    playSound('attack');
                    const targetEl = document.getElementById(`player${def+1}Avatar`);
                    // ÊîªÊíÉ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÂæÖ„Å§
                    await playAttackAnimation({ attr: gameState.players[atk].attribute, from: atk===0?'left':'right', targetEl });
                    showFloatingNumber(amount, def, false);
                    effectDuration = 800; // ÊîªÊíÉ„Ç®„Éï„Çß„ÇØ„Éà„ÅÆ‰ΩôÈüªÊôÇÈñì
                }
            } else {
                amount = baseLen * 5; // Â§±ÊïóÔºöËá™ÂÇ∑
                
                // Ë®àÁÆó„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫ÔºàËá™ÂÇ∑Ôºâ
                showDamageCalculation(baseLen, 0, amount, false, true);
                
                addHp(atk, -amount);
                playSound('fail');
                playHitEffect(atk);
                showFloatingNumber(amount, atk, false);
                effectDuration = 600; // Â§±Êïó„Ç®„Éï„Çß„ÇØ„Éà„ÅÆÊôÇÈñì
            }

            // ÈÅ∏„Çì„Å†„Ç´„Éº„Éâ„ÇíÊç®„Å¶ÔºÜË£úÂÖÖ
            const hand = gameState.hands[atk];
            const idx = hand.indexOf(card);
            if (idx > -1) hand.splice(idx, 1);
            if (gameState.deck.length > 0 && hand.length < 6) hand.push(gameState.deck.pop());

            // Áâá‰ªò„Åë
            gameState.selectedCard = null;

            // „Çø„Ç§„Éî„É≥„Ç∞Ë°®Á§∫„Çí„ÇØ„É™„Ç¢
            clearTypingDisplay();

            // HP/UI„ÅÆÂç≥ÊôÇÊõ¥Êñ∞
            updateUI();

            // ÂãùÊïó„ÉÅ„Çß„ÉÉ„ÇØÔºà„Åì„Åì„ÅßÁ¢∫ÂÆöÁµÇ‰∫ÜÔºâ
            const p0Dead = gameState.players[0].hp <= 0;
            const p1Dead = gameState.players[1].hp <= 0;
            if (p0Dead || p1Dead) {
                const winner = p0Dead && p1Dead ? null : (p0Dead ? 1 : 0);
                // „Ç®„Éï„Çß„ÇØ„ÉàÂÆå‰∫Ü„ÇíÂæÖ„Å£„Å¶„Åã„Çâ„Ç≤„Éº„É†ÁµÇ‰∫Ü
                setTimeout(() => {
                    endGame(winner);
                }, effectDuration);
                return;
            }

            // „Ç®„Éï„Çß„ÇØ„ÉàÂÆå‰∫Ü„ÇíÂæÖ„Å£„Å¶„Åã„Çâ„Çø„Éº„É≥‰∫§‰ª£
            setTimeout(() => {
                // ‚òÖ„Åì„Åì„Åß„Çø„Éº„É≥‰∫§‰ª£„Åó„Å¶„Åã„ÇâÊèèÁîª‚òÖ
                gameState.currentPlayer = def;
                gameState.gamePhase = 'cardSelect';

                // Ê¨°ÊâãÁï™„ÅÆÊâãÊú≠/„Ç´„Éº„ÉâÊèèÁîªÔºà‰∫§‰ª£ÂæåÔºÅÔºâ
                drawPlayerHand();
                drawCards();

                // Ë°®Á§∫ÊñáË®ÄÊõ¥Êñ∞ÔºÜ„Çø„Éº„É≥ÂëäÁü•
                updateUI();
                showTurnPopup(gameState.players[gameState.currentPlayer].name);
            }, effectDuration);
        }

        // ÊµÆÈÅä„ÉÄ„É°„Éº„Ç∏Êï∞ÂÄ§Ë°®Á§∫
        function showFloatingNumber(num, playerIndex, isHeal){
            const target = document.getElementById(`player${playerIndex+1}Avatar`);
            const rect = target.getBoundingClientRect();
            const n = document.createElement('div');
            n.className = 'damage-number' + (isHeal?' heal':'');
            n.style.left = rect.left + rect.width/2 + 'px';
            n.style.top  = rect.top  + 'px';
            n.textContent = (isHeal?'+':'-') + num;
            document.body.appendChild(n);
            setTimeout(()=> n.remove(), 1600);
        }

        // „ÉÄ„É°„Éº„Ç∏Ë®àÁÆó„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫
        function showDamageCalculation(charCount, remainingTime, totalDamage, isHeal = false, isSelfDamage = false) {
            const popup = document.createElement('div');
            popup.className = 'damage-calculation-popup';
            
            let formula, description;
            if (isSelfDamage) {
                formula = `${charCount}ÊñáÂ≠ó √ó 5 = ${totalDamage}„ÉÄ„É°„Éº„Ç∏`;
                description = 'Â§±Êïó„Å´„Çà„ÇãËá™ÂÇ∑„ÉÄ„É°„Éº„Ç∏';
            } else if (isHeal) {
                formula = `${charCount}ÊñáÂ≠ó √ó ÊÆã„Çä${remainingTime}Áßí = ${totalDamage}ÂõûÂæ©`;
                description = 'ÂåªÁôÇ„Ç´„Éº„Éâ„Å´„Çà„ÇãÂõûÂæ©';
            } else {
                formula = `${charCount}ÊñáÂ≠ó √ó ÊÆã„Çä${remainingTime}Áßí = ${totalDamage}„ÉÄ„É°„Éº„Ç∏`;
                description = 'ÊîªÊíÉ„Ç´„Éº„Éâ„Å´„Çà„Çã„ÉÄ„É°„Éº„Ç∏';
            }
            
            popup.innerHTML = `
                <div class="calculation-content ${isHeal ? 'heal' : isSelfDamage ? 'self-damage' : 'attack'}">
                    <div class="calculation-icon">${isHeal ? 'üíö' : isSelfDamage ? 'üí•' : '‚öîÔ∏è'}</div>
                    <div class="calculation-formula">${formula}</div>
                    <div class="calculation-description">${description}</div>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Âæå„Å´ÂâäÈô§
            setTimeout(() => {
                popup.remove();
            }, 5000);
        }

        // Á≠î„ÅàÈÄÅ‰ø°
        function submitAnswer() {
            if (!gameState.selectedCard) return;
            
            // ÂÖ•Âäõ„Éè„É≥„Éâ„É©„Éº„ÇíÂç≥Â∫ß„Å´ÁÑ°ÂäπÂåñ
            disableTyping();
            clearTypingDisplay();
            
            // Áµ±Ë®àÊõ¥Êñ∞ÔºàÁèæÂú®„ÅÆ„Éó„É¨„Ç§„É§„ÉºÁî®Ôºâ
            const targetLen = countChars(gameState.selectedCard.text);
            const timeUsed = Math.max(0, 12 - gameState.timer);
            const currentPlayerIndex = gameState.currentPlayer;
            
            gameState.playerStats[currentPlayerIndex].totalChars += targetLen;
            gameState.playerStats[currentPlayerIndex].totalTime += timeUsed;
            
            // ÂÖ®‰ΩìÁµ±Ë®à„ÇÇÊõ¥Êñ∞ÔºàÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÔºâ
            gameState.stats.totalChars += targetLen;
            gameState.stats.totalTime += timeUsed;
            
            // „ÅÑ„Åö„Çå„Åã„ÅÆÂÄôË£ú„ÅåÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Çå„Å∞ÊàêÂäü
            const success = typingState.currentInputs.some(input => input.completed);
            
            if (success) {
                gameState.playerStats[currentPlayerIndex].correctChars += targetLen;
                gameState.playerStats[currentPlayerIndex].combo++;
                gameState.playerStats[currentPlayerIndex].maxCombo = Math.max(
                    gameState.playerStats[currentPlayerIndex].maxCombo, 
                    gameState.playerStats[currentPlayerIndex].combo
                );
                
                // ÂÖ®‰ΩìÁµ±Ë®à„ÇÇÊõ¥Êñ∞
                gameState.stats.correctChars += targetLen;
                gameState.stats.combo++;
                gameState.stats.maxCombo = Math.max(gameState.stats.maxCombo, gameState.stats.combo);
            } else {
                gameState.playerStats[currentPlayerIndex].combo = 0;
                gameState.stats.combo = 0;
            }
            
            applyResult({ success });
        }

        // ÊôÇÈñìÂàá„Çå
        function timeUp() {
            if (!gameState.selectedCard) return;
            
            // Áµ±Ë®àÊõ¥Êñ∞
            const targetLen = countChars(gameState.selectedCard.text);
            gameState.stats.totalChars += targetLen;
            gameState.stats.totalTime += 12;
            gameState.stats.combo = 0;
            
            applyResult({ success: false });
        }

        // „ÇÆ„Éñ„Ç¢„ÉÉ„Éó
        function giveUp() {
            if (!gameState.selectedCard) return;
            
            // ÂÖ•Âäõ„Éè„É≥„Éâ„É©„Éº„ÇíÂç≥Â∫ß„Å´ÁÑ°ÂäπÂåñ
            disableTyping();
            clearTypingDisplay();
            
            // Áµ±Ë®àÊõ¥Êñ∞
            const targetLen = countChars(gameState.selectedCard.text);
            const timeUsed = Math.max(0, 12 - gameState.timer);
            gameState.stats.totalChars += targetLen;
            gameState.stats.totalTime += timeUsed;
            gameState.stats.combo = 0;
            
            applyResult({ success: false });
        }

        // ÊôÇÈñìÂàá„Çå
        function timeUp() {
            if (!gameState.selectedCard || gameState.gamePhase !== 'typing') return;
            
            // ÂÖ•Âäõ„Éè„É≥„Éâ„É©„Éº„ÇíÂç≥Â∫ß„Å´ÁÑ°ÂäπÂåñ
            disableTyping();
            clearTypingDisplay();
            // Áµ±Ë®à
            const targetLen = countChars(gameState.selectedCard.text);
            gameState.stats.totalChars += targetLen;
            gameState.stats.totalTime += 12;
            gameState.stats.combo = 0;
            // ÈõÜÁ¥Ñ„É≠„Ç∏„ÉÉ„ÇØ„Å∏ÔºàÂ§±ÊïóÊâ±„ÅÑÔºâ
            applyResult({ success: false });
        }

        // „ÉÄ„É°„Éº„Ç∏Âá¶ÁêÜ
        function dealDamage(playerIndex, damage) {
            gameState.players[playerIndex].hp = Math.max(0, gameState.players[playerIndex].hp - damage);
            
            // „ÉÄ„É°„Éº„Ç∏„Ç®„Éï„Çß„ÇØ„Éà
            showDamageEffect(playerIndex, damage);
            
            // HPÊõ¥Êñ∞
            updateUI();
            
            // ÂãùÊïóÂà§ÂÆö
            if (gameState.players[playerIndex].hp <= 0) {
                endGame(1 - playerIndex);
            }
        }

        // ÂõûÂæ©Âá¶ÁêÜ
        function healPlayer(playerIndex, healAmount) {
            const player = gameState.players[playerIndex];
            const actualHeal = Math.min(healAmount, player.maxHp - player.hp);
            player.hp = Math.min(player.maxHp, player.hp + actualHeal);
            
            // ÂõûÂæ©„Ç®„Éï„Çß„ÇØ„Éà
            showHealEffect(playerIndex, actualHeal);
            
            // HPÊõ¥Êñ∞
            updateUI();
        }

        // „ÉÄ„É°„Éº„Ç∏„Ç®„Éï„Çß„ÇØ„ÉàË°®Á§∫
        function showDamageEffect(playerIndex, damage) {
            const avatar = document.getElementById(`player${playerIndex + 1}Avatar`);
            const damageElement = document.createElement('div');
            damageElement.className = 'damage-number';
            damageElement.textContent = `-${damage}`;
            damageElement.style.left = '50%';
            damageElement.style.top = '50%';
            
            avatar.style.position = 'relative';
            avatar.appendChild(damageElement);
            
            // „Ç∑„Çß„Ç§„ÇØ„Ç®„Éï„Çß„ÇØ„Éà
            avatar.classList.add('shake');
            setTimeout(() => {
                avatar.classList.remove('shake');
                if (damageElement.parentNode) {
                    damageElement.remove();
                }
            }, 1000);
        }

        // ÂõûÂæ©„Ç®„Éï„Çß„ÇØ„ÉàË°®Á§∫
        function showHealEffect(playerIndex, healAmount) {
            const avatar = document.getElementById(`player${playerIndex + 1}Avatar`);
            const healElement = document.createElement('div');
            healElement.className = 'damage-number heal';
            healElement.textContent = `+${healAmount}`;
            healElement.style.left = '50%';
            healElement.style.top = '50%';
            healElement.style.color = '#4ecdc4';
            
            avatar.style.position = 'relative';
            avatar.appendChild(healElement);
            
            // ÂõûÂæ©„ÅÆÂÖâ„Ç®„Éï„Çß„ÇØ„Éà
            avatar.style.boxShadow = '0 0 30px rgba(76, 220, 196, 0.8)';
            avatar.style.transform = 'scale(1.1)';
            
            setTimeout(() => {
                avatar.style.boxShadow = '';
                avatar.style.transform = '';
                if (healElement.parentNode) {
                    healElement.remove();
                }
            }, 1000);
            
            // ÂõûÂæ©„Éë„Éº„ÉÜ„Ç£„ÇØ„É´
            createHealParticles(avatar);
        }

        // ÂõûÂæ©„Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÁîüÊàê
        function createHealParticles(avatarEl) {
            const fxLayer = getOrCreateFxLayer();
            const rect = avatarEl.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            for (let i = 0; i < 12; i++) {
                const particle = document.createElement('div');
                particle.innerHTML = '‚ú®';
                particle.style.position = 'absolute';
                particle.style.left = centerX + 'px';
                particle.style.top = centerY + 'px';
                particle.style.fontSize = '20px';
                particle.style.color = '#4ecdc4';
                particle.style.pointerEvents = 'none';
                particle.style.zIndex = '1000';
                
                const angle = (i / 12) * Math.PI * 2;
                const distance = 60;
                const dx = Math.cos(angle) * distance;
                const dy = Math.sin(angle) * distance;
                
                fxLayer.appendChild(particle);
                
                particle.animate([
                    { 
                        transform: 'translate(-50%, -50%) scale(0)',
                        opacity: 1
                    },
                    { 
                        transform: `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px)) scale(1.5)`,
                        opacity: 0.8,
                        offset: 0.7
                    },
                    { 
                        transform: `translate(calc(-50% + ${dx * 1.5}px), calc(-50% + ${dy * 1.5}px)) scale(0)`,
                        opacity: 0
                    }
                ], {
                    duration: 1000,
                    easing: 'ease-out'
                }).addEventListener('finish', () => {
                    particle.remove();
                });
            }
        }

        // „Éö„Éä„É´„ÉÜ„Ç£„Ç®„Éï„Çß„ÇØ„ÉàË°®Á§∫
        function showPenaltyEffect() {
            const timerRing = document.getElementById('timerRing');
            const penaltyElement = document.createElement('div');
            penaltyElement.className = 'damage-number';
            penaltyElement.textContent = '-2Áßí';
            penaltyElement.style.left = '50%';
            penaltyElement.style.top = '20%';
            penaltyElement.style.color = '#ff6b6b';
            penaltyElement.style.fontSize = '20px';
            
            timerRing.style.position = 'relative';
            timerRing.appendChild(penaltyElement);
            
            // „Çø„Ç§„Éû„Éº„É™„É≥„Ç∞„ÇíËµ§„ÅèÁÇπÊªÖ„Å®„Ç∑„Çß„Ç§„ÇØ
            timerRing.style.boxShadow = '0 0 20px rgba(255, 107, 107, 0.8)';
            timerRing.classList.add('shake');
            setTimeout(() => {
                timerRing.style.boxShadow = '';
                timerRing.classList.remove('shake');
                if (penaltyElement.parentNode) {
                    penaltyElement.remove();
                }
            }, 1000);
        }



        // „Çø„Éº„É≥ÈñãÂßã
        function startTurn() {
            showTurnPopup(gameState.players[gameState.currentPlayer].name);
            updateUI();
            
            // „Ç´„Éº„ÉâË°®Á§∫„Ç®„É™„Ç¢„ÇíÂÆåÂÖ®„Å´„ÇØ„É™„Ç¢
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';
            container.classList.remove('active');
            
            // „Çø„Ç§„Éî„É≥„Ç∞„Ç¨„Ç§„Éâ„ÇÇ„ÇØ„É™„Ç¢
            document.getElementById('typingGuideJP').textContent = '';
            document.getElementById('typingGuideJP').style.setProperty('--fill', '0%');
            document.getElementById('typingGuideSub').innerHTML = '';
            document.getElementById('romajiGuide').innerHTML = '';
            
            // Êñ∞„Åó„ÅÑ„Ç´„Éº„Éâ„ÇíÊèèÁîª
            drawCards();
            drawPlayerHand();
            
            // „Çø„Ç§„Éû„Éº„É™„Çª„ÉÉ„Éà
            document.getElementById('timerRing').textContent = '12';
            document.getElementById('timerRing').style.background = 
                'conic-gradient(#feca57 360deg, rgba(255, 255, 255, 0.2) 360deg)';
            
            // CPUÂà§ÂÆö
            if (gameState.mode === 'cpu' && gameState.currentPlayer === 1) {
                setTimeout(cpuAct, 700);
            }
        }

        // „Çø„Éº„É≥Âàá„ÇäÊõø„Åà„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫
        function showTurnPopup(name) {
            // Êó¢Â≠ò„ÅÆ„ÉÄ„É°„Éº„Ç∏Ë®àÁÆó„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíÂâäÈô§
            document.querySelectorAll('.damage-calculation-popup').forEach(popup => {
                popup.remove();
            });
            
            const div = document.createElement('div');
            div.className = 'turn-popup';
            
            const content = document.createElement('div');
            content.className = 'turn-popup-content';
            
            const title = document.createElement('h2');
            title.textContent = `${name}„ÅÆ„Çø„Éº„É≥`;
            
            const subtitle = document.createElement('div');
            subtitle.className = 'turn-popup-subtitle';
            subtitle.textContent = '„Ç´„Éº„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
            
            content.appendChild(title);
            content.appendChild(subtitle);
            div.appendChild(content);
            
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 2500);
        }

        // CPUË°åÂãï
        async function cpuAct() {
            const hand = gameState.hands[1];
            const pick = hand.reduce((a, b) => a.difficulty <= b.difficulty ? a : b, hand[0]); // Á∞°ÂçòÁõÆ
            gameState.selectedCard = pick;
            // 90% ÊàêÂäü„Åè„Çâ„ÅÑ„ÅÆÁ¢∫Áéá„Åß
            const success = Math.random() < 0.9;
            gameState.timer = Math.floor(4 + Math.random() * 8); // ÊÆãÁßí„ÇíÈÅ©ÂΩì„Å´
            
            // Áµ±Ë®àÊõ¥Êñ∞ÔºàCPUÁî®Ôºâ
            const targetLen = countChars(pick.text);
            const timeUsed = (TURN_MS / 1000) - gameState.timer;
            
            gameState.playerStats[1].totalChars += targetLen;
            gameState.playerStats[1].totalTime += timeUsed;
            
            // ÂÖ®‰ΩìÁµ±Ë®à„ÇÇÊõ¥Êñ∞
            gameState.stats.totalChars += targetLen;
            gameState.stats.totalTime += timeUsed;
            
            if (success) {
                gameState.playerStats[1].correctChars += targetLen;
                gameState.playerStats[1].combo++;
                gameState.playerStats[1].maxCombo = Math.max(gameState.playerStats[1].maxCombo, gameState.playerStats[1].combo);
                
                // ÂÖ®‰ΩìÁµ±Ë®à„ÇÇÊõ¥Êñ∞
                gameState.stats.correctChars += targetLen;
                gameState.stats.combo++;
                gameState.stats.maxCombo = Math.max(gameState.stats.maxCombo, gameState.stats.combo);
            } else {
                gameState.playerStats[1].combo = 0;
                gameState.stats.combo = 0;
            }
            
            await applyResult({ success });
        }

        // CPU„Çø„Éº„É≥
        async function cpuTurn() {
            updateUI();
            drawCards(); // ‚òÖËøΩÂä†ÔºöCPU„ÇÇ„Å°„ÇÉ„Çì„Å®1ÊûöÂºï„Åè
            drawPlayerHand(); // ÊâãÊú≠Ë°®Á§∫„ÇÇÊõ¥Êñ∞
            
            setTimeout(async () => {
                // CPU„Ç´„Éº„ÉâÈÅ∏ÊäûÔºàÁ∞°ÊòìAIÔºâ
                const hand = gameState.hands[1];
                let bestCard = hand[0];
                let bestScore = -1;
                
                hand.forEach(card => {
                    // ÊúüÂæÖ„ÉÄ„É°„Éº„Ç∏Ë®àÁÆóÔºàÁ∞°ÊòìÔºâ
                    const expectedTime = Math.random() * 10 + 5; // 5-15Áßí
                    const expectedDamage = card.text.length * expectedTime;
                    const failRisk = card.difficulty * 20; // Èõ£ÊòìÂ∫¶„Å´„Çà„ÇãÂ§±Êïó„É™„Çπ„ÇØ
                    const score = expectedDamage - failRisk;
                    
                    if (score > bestScore) {
                        bestScore = score;
                        bestCard = card;
                    }
                });
                
                gameState.selectedCard = bestCard;
                
                // CPUÂÖ•Âäõ„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥
                setTimeout(async () => {
                    const success = Math.random() > (bestCard.difficulty * 0.2); // Èõ£ÊòìÂ∫¶„Å´„Çà„ÇãÊàêÂäüÁéá
                    
                    if (success) {
                        const cpuRemainingTime = Math.random() * 8 + 2; // 2-10ÁßíÊÆã„ÇäÊôÇÈñì
                        const charCount = countChars(bestCard.text);
                        const isHealCard = bestCard.category === '„ÅÑ„Çä„Çá„ÅÜ';
                        
                        console.log(`CPU: ÊñáÂ≠óÊï∞=${charCount}, ÊÆã„ÇäÊôÇÈñì=${cpuRemainingTime.toFixed(1)}Áßí`);
                        
                        if (isHealCard) {
                            // CPUÂõûÂæ©Âá¶ÁêÜ
                            const healAmount = Math.floor(charCount * cpuRemainingTime);
                            console.log(`CPUÂõûÂæ©Ë®àÁÆó: ${charCount} √ó ${cpuRemainingTime.toFixed(1)} = ${healAmount}`);
                            healPlayer(1, healAmount);
                            playSound('heal');
                        } else {
                            // CPUÊîªÊíÉÂá¶ÁêÜ
                            const damage = Math.floor(charCount * cpuRemainingTime);
                            console.log(`CPUÊîªÊíÉË®àÁÆó: ${charCount} √ó ${cpuRemainingTime.toFixed(1)} = ${damage}`);
                            
                            // CPUÊîªÊíÉ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                            await playAttackAnimation({
                                attr: gameState.players[1].attribute,
                                from: 'right',
                                targetEl: document.getElementById('player1Avatar'),
                                impactMs: 600
                            });
                            
                            dealDamage(0, damage);
                        }
                        
                        gameState.stats.correctChars += charCount;
                        gameState.stats.totalChars += charCount;
                        gameState.stats.totalTime += (12 - cpuRemainingTime);
                    } else {
                        const charCount = countChars(bestCard.text);
                        const selfDamage = charCount * 5;
                        
                        console.log(`CPUËá™ÂÇ∑„ÉÄ„É°„Éº„Ç∏Ë®àÁÆó: ${charCount} √ó 10 = ${selfDamage}`);
                        
                        // CPUË¢´Âºæ„Ç®„Éï„Çß„ÇØ„Éà
                        playHitEffect(1);
                        dealDamage(1, selfDamage);
                        
                        gameState.stats.totalChars += charCount;
                        gameState.stats.totalTime += 12;
                        
                        playSound('fail');
                    }
                    
                    endTurn();
                }, 2000);
            }, 1000);
        }

        // „Ç≤„Éº„É†ÁµÇ‰∫Ü
        function endGame(winnerIndex) {
            stopTimer();
            disableTyping();
            gameState.gamePhase = 'ended';
            gameState.selectedCard = null;

            // „Ç´„Éº„Éâ„ÇØ„É™„ÉÉ„ÇØ„ÇíÂÆüË≥™ÁÑ°ÂäπÂåñ
            const container = document.getElementById('cardsContainer');
            if (container) container.innerHTML = '';

            // ‰∏°„Éó„É¨„Ç§„É§„Éº„ÅÆÁµ±Ë®àË®àÁÆó
            const player1Stats = gameState.playerStats[0] || { totalChars: 0, correctChars: 0, totalTime: 0, maxCombo: 0 };
            const player2Stats = gameState.playerStats[1] || { totalChars: 0, correctChars: 0, totalTime: 0, maxCombo: 0 };
            
            const p1Accuracy = player1Stats.totalChars > 0 ? 
                Math.round((player1Stats.correctChars / player1Stats.totalChars) * 100) : 0;
            const p1Speed = player1Stats.totalTime > 0 ? 
                Math.round((player1Stats.correctChars / player1Stats.totalTime) * 60) : 0;
                
            const p2Accuracy = player2Stats.totalChars > 0 ? 
                Math.round((player2Stats.correctChars / player2Stats.totalChars) * 100) : 0;
            const p2Speed = player2Stats.totalTime > 0 ? 
                Math.round((player2Stats.correctChars / player2Stats.totalTime) * 60) : 0;

            // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
            const modal = document.getElementById('modal');
            const content = document.getElementById('modalContent');
            const isDraw = winnerIndex === null;
            const title = isDraw ? 'Âºï„ÅçÂàÜ„ÅëÔºÅ' : `ÂãùËÄÖÔºö${gameState.players[winnerIndex].name}`;
            const msg   = isDraw ? '‰∏°ËÄÖ„ÅÆHP„ÅåÂêåÊôÇ„Å´0„Å´„Å™„Çä„Åæ„Åó„Åü„ÄÇ' : `${gameState.players[winnerIndex].name}„ÅÆÂãùÂà©ÔºÅ`;

            content.innerHTML = `
                <h2>${title}</h2>
                <p>${msg}</p>
                
                <!-- „Éó„É¨„Ç§„É§„Éº1„ÅÆÊàêÁ∏æ -->
                <div style="background: rgba(255,107,107,0.1); border: 2px solid rgba(255,107,107,0.3); border-radius: 15px; padding: 20px; margin: 15px 0; text-align: left;">
                    <h3 style="margin: 0 0 15px 0; color: #ff6b6b; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        ${gameState.players[0].avatar} ${gameState.players[0].name}„ÅÆÊàêÁ∏æ
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; font-size: 14px;">
                        <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                            <div style="font-size: 20px; font-weight: 700; color: #4ecdc4;">${p1Accuracy}%</div>
                            <div style="opacity: 0.8; font-size: 12px;">Ê≠£Á¢∫„Åï</div>
                            <div style="font-size: 11px; opacity: 0.6;">${player1Stats.correctChars}/${player1Stats.totalChars}ÊñáÂ≠ó</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                            <div style="font-size: 20px; font-weight: 700; color: #feca57;">${p1Speed}</div>
                            <div style="opacity: 0.8; font-size: 12px;">ÊñáÂ≠ó/ÂàÜ</div>
                            <div style="font-size: 11px; opacity: 0.6;">Âπ≥ÂùáÈÄüÂ∫¶</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                            <div style="font-size: 20px; font-weight: 700; color: #ff6b6b;">${player1Stats.maxCombo}</div>
                            <div style="opacity: 0.8; font-size: 12px;">ÊúÄÂ§ß„Ç≥„É≥„Éú</div>
                            <div style="font-size: 11px; opacity: 0.6;">ÈÄ£Á∂öÊàêÂäü</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                            <div style="font-size: 20px; font-weight: 700; color: #95e1d3;">${Math.round(player1Stats.totalTime)}Áßí</div>
                            <div style="opacity: 0.8; font-size: 12px;">Á∑èÂÖ•ÂäõÊôÇÈñì</div>
                            <div style="font-size: 11px; opacity: 0.6;">ÂÆüÈöõ„ÅÆÂÖ•Âäõ</div>
                        </div>
                    </div>
                </div>
                
                <!-- „Éó„É¨„Ç§„É§„Éº2„ÅÆÊàêÁ∏æ -->
                <div style="background: rgba(76,224,196,0.1); border: 2px solid rgba(76,224,196,0.3); border-radius: 15px; padding: 20px; margin: 15px 0; text-align: left;">
                    <h3 style="margin: 0 0 15px 0; color: #4ecdc4; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        ${gameState.players[1].avatar} ${gameState.players[1].name}„ÅÆÊàêÁ∏æ
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; font-size: 14px;">
                        <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                            <div style="font-size: 20px; font-weight: 700; color: #4ecdc4;">${p2Accuracy}%</div>
                            <div style="opacity: 0.8; font-size: 12px;">Ê≠£Á¢∫„Åï</div>
                            <div style="font-size: 11px; opacity: 0.6;">${player2Stats.correctChars}/${player2Stats.totalChars}ÊñáÂ≠ó</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                            <div style="font-size: 20px; font-weight: 700; color: #feca57;">${p2Speed}</div>
                            <div style="opacity: 0.8; font-size: 12px;">ÊñáÂ≠ó/ÂàÜ</div>
                            <div style="font-size: 11px; opacity: 0.6;">Âπ≥ÂùáÈÄüÂ∫¶</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                            <div style="font-size: 20px; font-weight: 700; color: #ff6b6b;">${player2Stats.maxCombo}</div>
                            <div style="opacity: 0.8; font-size: 12px;">ÊúÄÂ§ß„Ç≥„É≥„Éú</div>
                            <div style="font-size: 11px; opacity: 0.6;">ÈÄ£Á∂öÊàêÂäü</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                            <div style="font-size: 20px; font-weight: 700; color: #95e1d3;">${Math.round(player2Stats.totalTime)}Áßí</div>
                            <div style="opacity: 0.8; font-size: 12px;">Á∑èÂÖ•ÂäõÊôÇÈñì</div>
                            <div style="font-size: 11px; opacity: 0.6;">ÂÆüÈöõ„ÅÆÂÖ•Âäõ</div>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="restartGame()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
                    <button class="btn btn-primary" onclick="backToMenu()">„É°„Éã„É•„Éº„Å∏Êàª„Çã</button>
                </div>
            `;
            modal.style.display = 'flex';
        }

        // Èü≥Â£∞ÂÜçÁîü
        function playSound(type) {
            if (!gameState.soundEnabled) return;
            
            ensureAudio();
            if (!audioCtx) return;
            
            // Á¢∫ÂÆü„Å™Ëµ∑Âãï„ÅÆ„Åü„ÇÅÂÜçÁîüÁõ¥Ââç„Åß„ÇÇresume
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            
            // Á∞°ÊòìÈü≥Â£∞ÔºàÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØÈÅ©Âàá„Å™Èü≥Â£∞„Éï„Ç°„Ç§„É´„Çí‰ΩøÁî®Ôºâ
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            if (type === 'success') {
                oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
                oscillator.frequency.setValueAtTime(659.25, audioCtx.currentTime + 0.1); // E5
            } else if (type === 'attack') {
                // ÊîªÊíÉÈü≥ÔºöÂäõÂº∑„ÅÑ‰ΩéÈü≥„Åã„ÇâÈ´òÈü≥„Å∏
                oscillator.frequency.setValueAtTime(150, audioCtx.currentTime); // ‰ΩéÈü≥
                oscillator.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.2);
                oscillator.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.4);
            } else if (type === 'heal') {
                // ÂõûÂæ©Èü≥ÔºöÁæé„Åó„ÅÑÂíåÈü≥
                oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
                oscillator.frequency.setValueAtTime(659.25, audioCtx.currentTime + 0.1); // E5
                oscillator.frequency.setValueAtTime(783.99, audioCtx.currentTime + 0.2); // G5
                oscillator.frequency.setValueAtTime(1046.50, audioCtx.currentTime + 0.3); // C6
            } else if (type === 'charge') {
                // Ê∫ú„ÇÅÈü≥Ôºö‰ΩéÈü≥„Åã„ÇâÈ´òÈü≥„Å∏
                oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.3);
            } else {
                oscillator.frequency.setValueAtTime(220, audioCtx.currentTime); // A3
            }
            
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + (type === 'heal' ? 0.5 : type === 'attack' ? 0.4 : 0.3));
            
            oscillator.start(audioCtx.currentTime);
            oscillator.stop(audioCtx.currentTime + (type === 'heal' ? 0.5 : type === 'attack' ? 0.4 : 0.3));
        }

        // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
        function showModal(title, content) {
            document.getElementById('modalContent').innerHTML = `
                <h2>${title}</h2>
                ${content}
            `;
            document.getElementById('modal').style.display = 'flex';
        }

        // „É¢„Éº„ÉÄ„É´ÈùûË°®Á§∫
        function hideModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // „Éò„É´„ÉóË°®Á§∫
        function showHelp() {
            showModal('üìñ „Ç≤„Éº„É†„ÅÆÈÅä„Å≥Êñπ', `
                <p><strong>Âü∫Êú¨„É´„Éº„É´</strong></p>
                <p>‚Ä¢ Ë®≠ÂÆö„Åó„ÅüHP„Åß„Çπ„Çø„Éº„Éà</p>
                <p>‚Ä¢ ÊâãÊú≠„Åã„Çâ1ÊûöÈÅ∏„Çì„Åß„Çø„Ç§„Éî„É≥„Ç∞</p>
                <p>‚Ä¢ 12Áßí‰ª•ÂÜÖ„Å´„É≠„Éº„ÉûÂ≠ó„ÅßÂÖ•Âäõ</p>
                <p>‚Ä¢ ÊàêÂäüÔºöÊñáÂ≠óÊï∞√óÊÆã„ÇäÊôÇÈñì„Åß„ÉÄ„É°„Éº„Ç∏</p>
                <p>‚Ä¢ Â§±ÊïóÔºöÊñáÂ≠óÊï∞√ó5„ÅÆËá™ÂÇ∑„ÉÄ„É°„Éº„Ç∏</p>
                <p>‚Ä¢ Êâì„Å°ÈñìÈÅï„ÅàÔºö2Áßí„Éö„Éä„É´„ÉÜ„Ç£</p>
                <p>‚Ä¢ Èï∑Èü≥„Äå„Éº„Äç„ÅØ„Éè„Ç§„Éï„É≥„Äå-„Äç„ÅßÂÖ•Âäõ</p>
                <p>‚Ä¢ „Äå„Çì„Äç„ÅØ n, nn, n', mÔºàÊ¨°„Åå b/m/p „ÅÆÂ†¥ÂêàÔºâ</p>
                <p><strong>üíö ÂåªÁôÇ„Ç´„Éº„Éâ</strong></p>
                <p>‚Ä¢ Á∑ëËâ≤„ÅÆ„Ç™„Éº„É©„ÅåÁõÆÂç∞</p>
                <p>‚Ä¢ ÊàêÂäü„Åô„Çã„Å®Ëá™ÂàÜ„ÅÆHP„ÅåÂõûÂæ©</p>
                <p>‚Ä¢ ÂõûÂæ©ÈáèÔºöÊñáÂ≠óÊï∞√óÊÆã„ÇäÊôÇÈñì</p>
                <p><strong>Êìç‰ΩúÊñπÊ≥ï</strong></p>
                <p>‚Ä¢ „Ç´„Éº„Éâ„Çí„Çø„ÉÉ„Éó„Åó„Å¶ÈÅ∏Êäû</p>
                <p>‚Ä¢ „É≠„Éº„ÉûÂ≠ó„ÅßÂÖ•ÂäõÔºàÂÖ®Ëßí„Åß„ÇÇOKÔºâ</p>
                <p>‚Ä¢ ESC„Ç≠„Éº„Åß„ÇÆ„Éñ„Ç¢„ÉÉ„Éó</p>
                <button class="btn btn-primary" onclick="hideModal()">Èñâ„Åò„Çã</button>
            `);
        }

        // Èü≥ÈáèÂàá„ÇäÊõø„Åà
        function toggleSound() {
            gameState.soundEnabled = !gameState.soundEnabled;
            document.getElementById('soundBtn').textContent = gameState.soundEnabled ? 'üîä' : 'üîá';
        }

        // „Ç≤„Éº„É†‰∏ÄÊôÇÂÅúÊ≠¢
        function pauseGame() {
            if (gameState.gamePhase !== 'typing') return;

            if (!gameState.isPaused) {
                gameState.isPaused = true;
                stopTimer(); // rAFÂÅúÊ≠¢„ÅßCPUÊ∂àË≤ª„ÇíÊäëÂà∂
                document.getElementById('pauseBtn').textContent = '‚ñ∂Ô∏è';
                showModal('‚è∏Ô∏è ‰∏ÄÊôÇÂÅúÊ≠¢', `
                    <p>„Ç≤„Éº„É†„Çí‰∏ÄÊôÇÂÅúÊ≠¢„Åó„Åæ„Åó„Åü</p>
                    <button class="btn btn-primary" onclick="resumeGame()">ÂÜçÈñã</button>
                `);
            } else {
                resumeGame();
            }
        }

        // „Ç≤„Éº„É†ÂÜçÈñã
        function resumeGame() {
            gameState.isPaused = false;
            document.getElementById('pauseBtn').textContent = '‚è∏Ô∏è';
            hideModal();
            // ÊúüÈôê„ÅØ‰øùÊåÅ„Åó„Å¶„ÅÇ„Çã„ÅÆ„ÅßÊÆã„ÇäÊôÇÈñì„ÅßÂÜçÈñã
            const remainingMs = Math.max(0, timerDeadline - performance.now());
            if (remainingMs > 0) {
                startAccurateTimer(remainingMs);
            }
        }

        // „É°„Éã„É•„Éº„Å´Êàª„Çã
        function backToMenu() {
            // „Ç≤„Éº„É†Áä∂ÊÖã„É™„Çª„ÉÉ„Éà
            gameState = {
                mode: null,
                maxHP: 200,
                players: [
                    { name: '„Éó„É¨„Ç§„É§„Éº1', hp: 200, maxHp: 200, avatar: 'üî•', attribute: 'fire' },
                    { name: 'CPU', hp: 200, maxHp: 200, avatar: 'ü§ñ', attribute: 'water' }
                ],
                currentPlayer: 0,
                selectedCard: null,
                hands: [[], []],
                deck: [],
                discard: [],
                timer: 15,
                timerInterval: null,
                gamePhase: 'cardSelect',
                soundEnabled: true,
                isPaused: false,
                playerStats: [
                    { totalChars: 0, correctChars: 0, totalTime: 0, combo: 0, maxCombo: 0 },
                    { totalChars: 0, correctChars: 0, totalTime: 0, combo: 0, maxCombo: 0 }
                ],
                stats: {
                    totalChars: 0,
                    correctChars: 0,
                    totalTime: 0,
                    combo: 0,
                    maxCombo: 0
                }
            };
            
            stopTimer();
            hideModal();
            document.getElementById('gameContainer').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
            document.getElementById('characterSelection').classList.add('hidden');
            document.getElementById('gameRules').classList.add('hidden');
            document.getElementById('player2Setup').classList.add('hidden');
            
            // ÈÅ∏ÊäûÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
            document.querySelectorAll('.mode-btn, .character-btn, .hp-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // „Éá„Éï„Ç©„É´„ÉàHPÈÅ∏Êäû
            document.querySelector('[data-hp="200"]').classList.add('selected');
            
            // ÂêçÂâçÂÖ•Âäõ„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('player1NameInput').value = '„Éó„É¨„Ç§„É§„Éº1';
            document.getElementById('player2NameInput').value = '„Éó„É¨„Ç§„É§„Éº2';
            document.getElementById('nextBtn').disabled = true;
        }

        // „Ç≤„Éº„É†ÂÜçÈñãÂßã
        function restartGame() {
            hideModal();
            
            // HPÂõûÂæ©
            gameState.players.forEach(player => {
                player.hp = player.maxHp;
            });
            
            // Áµ±Ë®à„É™„Çª„ÉÉ„ÉàÔºà‰∏°„Éó„É¨„Ç§„É§„ÉºÂàÜÔºâ
            gameState.playerStats = [
                { totalChars: 0, correctChars: 0, totalTime: 0, combo: 0, maxCombo: 0 },
                { totalChars: 0, correctChars: 0, totalTime: 0, combo: 0, maxCombo: 0 }
            ];
            gameState.stats = {
                totalChars: 0,
                correctChars: 0,
                totalTime: 0,
                combo: 0,
                maxCombo: 0
            };
            
            // „Ç≤„Éº„É†Áä∂ÊÖã„É™„Çª„ÉÉ„Éà
            gameState.currentPlayer = 0;
            gameState.gamePhase = 'cardSelect';
            gameState.selectedCard = null;
            gameState.hands = [[], []];
            gameState.deck = [];
            gameState.discard = [];
            stopTimer();
            
            // 2‰∫∫ÂØæÊà¶„ÅÆÂ†¥Âêà„ÅØ„É´„Éº„É¨„ÉÉ„Éà„Åß„Çø„Éº„É≥Ê±∫ÂÆö
            if (gameState.mode === 'pvp') {
                showRouletteAnimation().then(() => {
                    initGame();
                });
            } else {
                initGame();
            }
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        document.addEventListener('DOMContentLoaded', function() {
            // „É¢„Éº„ÉÄ„É´„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
            document.getElementById('modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideModal();
                }
            });

            // ÂêçÂâçÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
            document.getElementById('player1NameInput').addEventListener('input', function() {
                gameState.players[0].name = this.value || '„Éó„É¨„Ç§„É§„Éº1';
                checkSetupComplete();
            });

            document.getElementById('player2NameInput').addEventListener('input', function() {
                gameState.players[1].name = this.value || '„Éó„É¨„Ç§„É§„Éº2';
                checkSetupComplete();
            });
        });

        // „É¢„Éê„Ç§„É´ÂÆâÂÖ®Ë£ÖÁΩÆÔºàÁîªÈù¢Èõ¢ËÑ±„Åß„Çø„Ç§„Éû„ÉºÊö¥Ëµ∞„ÇíÈò≤Ê≠¢Ôºâ
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && gameState.gamePhase === 'typing') {
                gameState.isPaused = true;
            }
        });

        // ËøΩÂä†„ÅÆÂøÖË¶Å„Å™Èñ¢Êï∞
        function showPenaltyEffect() {
            document.body.classList.add('shake');
            setTimeout(() => document.body.classList.remove('shake'), 300);
        }

        function showHelp() {
            showModal('üìñ „Ç≤„Éº„É†„ÅÆÈÅä„Å≥Êñπ', `
                <p><strong>Âü∫Êú¨„É´„Éº„É´</strong></p>
                <p>‚Ä¢ Ë®≠ÂÆö„Åó„ÅüHP„Åß„Çπ„Çø„Éº„Éà</p>
                <p>‚Ä¢ ÊâãÊú≠„Åã„Çâ1ÊûöÈÅ∏„Çì„Åß„Çø„Ç§„Éî„É≥„Ç∞</p>
                <p>‚Ä¢ 12Áßí‰ª•ÂÜÖ„Å´„É≠„Éº„ÉûÂ≠ó„ÅßÂÖ•Âäõ</p>
                <p>‚Ä¢ ÊàêÂäüÔºöÊñáÂ≠óÊï∞√óÊÆã„ÇäÊôÇÈñì„Åß„ÉÄ„É°„Éº„Ç∏</p>
                <p>‚Ä¢ Â§±ÊïóÔºöÊñáÂ≠óÊï∞√ó5„ÅÆËá™ÂÇ∑„ÉÄ„É°„Éº„Ç∏</p>
                <p>‚Ä¢ Êâì„Å°ÈñìÈÅï„ÅàÔºö2Áßí„Éö„Éä„É´„ÉÜ„Ç£</p>
                <p>‚Ä¢ Èï∑Èü≥„Äå„Éº„Äç„ÅØ„Éè„Ç§„Éï„É≥„Äå-„Äç„ÅßÂÖ•Âäõ</p>
                <p>‚Ä¢ „Äå„Çì„Äç„ÅØ n, nn, n', mÔºàÊ¨°„Åå b/m/p „ÅÆÂ†¥ÂêàÔºâ</p>
                <p><strong>üíö ÂåªÁôÇ„Ç´„Éº„Éâ</strong></p>
                <p>‚Ä¢ Á∑ëËâ≤„ÅÆ„Ç™„Éº„É©„ÅåÁõÆÂç∞</p>
                <p>‚Ä¢ ÊàêÂäü„Åô„Çã„Å®Ëá™ÂàÜ„ÅÆHP„ÅåÂõûÂæ©</p>
                <p>‚Ä¢ ÂõûÂæ©ÈáèÔºöÊñáÂ≠óÊï∞√óÊÆã„ÇäÊôÇÈñì</p>
                <p><strong>Êìç‰ΩúÊñπÊ≥ï</strong></p>
                <p>‚Ä¢ „Ç´„Éº„Éâ„Çí„Çø„ÉÉ„Éó„Åó„Å¶ÈÅ∏Êäû</p>
                <p>‚Ä¢ „É≠„Éº„ÉûÂ≠ó„ÅßÂÖ•ÂäõÔºàÂÖ®Ëßí„Åß„ÇÇOKÔºâ</p>
                <p>‚Ä¢ ESC„Ç≠„Éº„Åß„ÇÆ„Éñ„Ç¢„ÉÉ„Éó</p>
                <button class="btn btn-primary" onclick="hideModal()">Èñâ„Åò„Çã</button>
            `);
        }

        function toggleSound() {
            gameState.soundEnabled = !gameState.soundEnabled;
            const btn = document.getElementById('soundBtn');
            if (btn) btn.textContent = gameState.soundEnabled ? 'üîä' : 'üîá';
        }

        function pauseGame() {
            if (gameState.gamePhase !== 'typing') return;

            if (!gameState.isPaused) {
                gameState.isPaused = true;
                stopTimer();
                document.getElementById('pauseBtn').textContent = '‚ñ∂Ô∏è';
                showModal('‚è∏Ô∏è ‰∏ÄÊôÇÂÅúÊ≠¢', `
                    <p>„Ç≤„Éº„É†„Çí‰∏ÄÊôÇÂÅúÊ≠¢„Åó„Åæ„Åó„Åü</p>
                    <button class="btn btn-primary" onclick="resumeGame()">ÂÜçÈñã</button>
                `);
            } else {
                resumeGame();
            }
        }

        function resumeGame() {
            gameState.isPaused = false;
            document.getElementById('pauseBtn').textContent = '‚è∏Ô∏è';
            hideModal();
            const remainingMs = Math.max(0, timerDeadline - performance.now());
            if (remainingMs > 0) {
                startAccurateTimer(remainingMs);
            }
        }

        function backToMenu() {
            location.reload();
        }

        function submitAnswer() {
            if (!gameState.selectedCard) return;
            
            disableTyping();
            stopTimer();
            
            const card = gameState.selectedCard;
            const isHeal = card.category === '„ÅÑ„Çä„Çá„ÅÜ';
            const baseLen = countChars(card.text);
            const leftMs = Math.max(0, timerDeadline - performance.now());
            const remainingTime = Math.ceil(leftMs / 1000);
            
            const success = typingState.currentInputs.some(input => input.completed);
            
            if (success) {
                const amount = baseLen * Math.max(1, remainingTime);
                if (isHeal) {
                    addHp(gameState.currentPlayer, amount);
                    showFloatingNumber(amount, gameState.currentPlayer, true);
                    playSound('heal');
                } else {
                    addHp(1 - gameState.currentPlayer, -amount);
                    showFloatingNumber(amount, 1 - gameState.currentPlayer, false);
                    playSound('attack');
                }
            } else {
                const selfDamage = baseLen * 5;
                addHp(gameState.currentPlayer, -selfDamage);
                showFloatingNumber(selfDamage, gameState.currentPlayer, false);
                playSound('fail');
            }
            
            // „Ç´„Éº„Éâ„ÇíÊâãÊú≠„Åã„ÇâÂâäÈô§
            const hand = gameState.hands[gameState.currentPlayer];
            const cardIndex = hand.indexOf(card);
            if (cardIndex > -1) {
                hand.splice(cardIndex, 1);
            }
            
            // Êñ∞„Åó„ÅÑ„Ç´„Éº„Éâ„ÇíÂºï„Åè
            if (gameState.deck.length > 0 && hand.length < 6) {
                hand.push(gameState.deck.pop());
            }
            
            gameState.selectedCard = null;
            clearTypingDisplay();
            
            // ÂãùÊïó„ÉÅ„Çß„ÉÉ„ÇØ
            const p1Dead = gameState.players[0].hp <= 0;
            const p2Dead = gameState.players[1].hp <= 0;
            
            if (p1Dead || p2Dead) {
                const winner = p1Dead && p2Dead ? null : (p1Dead ? 1 : 0);
                setTimeout(() => endGame(winner), 500);
                return;
            }
            
            // „Çø„Éº„É≥‰∫§‰ª£
            setTimeout(() => {
                gameState.currentPlayer = 1 - gameState.currentPlayer;
                gameState.gamePhase = 'cardSelect';
                startTurn();
            }, 800);
        }

        function giveUp() {
            timeUp();
        }

        function timeUp() {
            if (!gameState.selectedCard || gameState.gamePhase !== 'typing') return;
            
            disableTyping();
            clearTypingDisplay();
            
            const card = gameState.selectedCard;
            const selfDamage = countChars(card.text) * 5;
            
            addHp(gameState.currentPlayer, -selfDamage);
            showFloatingNumber(selfDamage, gameState.currentPlayer, false);
            playSound('fail');
            
            // „Ç´„Éº„Éâ„ÇíÊâãÊú≠„Åã„ÇâÂâäÈô§
            const hand = gameState.hands[gameState.currentPlayer];
            const cardIndex = hand.indexOf(card);
            if (cardIndex > -1) {
                hand.splice(cardIndex, 1);
            }
            
            // Êñ∞„Åó„ÅÑ„Ç´„Éº„Éâ„ÇíÂºï„Åè
            if (gameState.deck.length > 0 && hand.length < 6) {
                hand.push(gameState.deck.pop());
            }
            
            gameState.selectedCard = null;
            
            // ÂãùÊïó„ÉÅ„Çß„ÉÉ„ÇØ
            const p1Dead = gameState.players[0].hp <= 0;
            const p2Dead = gameState.players[1].hp <= 0;
            
            if (p1Dead || p2Dead) {
                const winner = p1Dead && p2Dead ? null : (p1Dead ? 1 : 0);
                setTimeout(() => endGame(winner), 500);
                return;
            }
            
            // „Çø„Éº„É≥‰∫§‰ª£
            setTimeout(() => {
                gameState.currentPlayer = 1 - gameState.currentPlayer;
                gameState.gamePhase = 'cardSelect';
                startTurn();
            }, 800);
        }

        // HPÁÆ°ÁêÜ„ÅÆÁµ±‰∏ÄÈñ¢Êï∞
        function setHp(playerIndex, value) {
            const player = gameState.players[playerIndex];
            player.hp = Math.max(0, Math.min(player.maxHp, value));
            updateUI();
        }

        function addHp(playerIndex, delta) {
            setHp(playerIndex, gameState.players[playerIndex].hp + delta);
        }

        // ÊµÆÈÅä„ÉÄ„É°„Éº„Ç∏Êï∞ÂÄ§Ë°®Á§∫
        function showFloatingNumber(num, playerIndex, isHeal) {
            const target = document.getElementById(`player${playerIndex + 1}Avatar`);
            const rect = target.getBoundingClientRect();
            const n = document.createElement('div');
            n.className = 'damage-number' + (isHeal ? ' heal' : '');
            n.style.left = rect.left + rect.width / 2 + 'px';
            n.style.top = rect.top + 'px';
            n.textContent = (isHeal ? '+' : '-') + num;
            document.body.appendChild(n);
            setTimeout(() => n.remove(), 1600);
        }

        // ===== ÊúÄÂ∞è„Çπ„Çø„ÉñÔºÜÈÄ≤Ë°å„É≠„Ç∏„ÉÉ„ÇØ =====
        
        // „Çø„Éº„É≥ÈñãÂßãÔºöÊâãÊú≠ÊèèÁîª‚Üí„Ç´„Éº„ÉâÈÅ∏Êäû„Éï„Çß„Éº„Ç∫„Å∏
        function startTurn(){
            gameState.gamePhase = 'cardSelect';
            clearTypingDisplay();
            disableTyping();
            stopTimer();
            updateUI();
            drawPlayerHand();
            drawCards();
            
            // CPUÂà§ÂÆö
            if (gameState.mode === 'cpu' && gameState.currentPlayer === 1) {
                setTimeout(cpuAct, 700);
            }
        }

        // „Çø„Éº„É≥ÁµÇ‰∫Ü‚ÜíÁõ∏Êâã„Å´‰∫§‰ª£
        function endTurn(){
            gameState.selectedCard = null;
            gameState.currentPlayer = 1 - gameState.currentPlayer;
            startTurn();
        }

        // „Çø„Ç§„É†„Ç¢„ÉÉ„ÉóÔºàÂ§±ÊïóÊâ±„ÅÑÔºâ
        function timeUp(){
            if (!gameState.selectedCard) { endTurn(); return; }
            
            disableTyping();
            clearTypingDisplay();
            
            const len = countChars(gameState.selectedCard.text);
            const self = gameState.currentPlayer;
            gameState.players[self].hp = Math.max(0, gameState.players[self].hp - len * 5);
            
            // ‰Ωø„Å£„Åü„Ç´„Éº„Éâ„ÇíÊâãÊú≠„Åã„ÇâÊç®„Å¶„Çã
            const hand = gameState.hands[self];
            const idx = hand.indexOf(gameState.selectedCard);
            if (idx >= 0) hand.splice(idx, 1);
            
            updateUI();
            
            // ÂãùÊïó„ÉÅ„Çß„ÉÉ„ÇØ
            if (gameState.players[0].hp <= 0 || gameState.players[1].hp <= 0) {
                const winner = gameState.players[0].hp <= 0 ? 1 : 0;
                setTimeout(() => endGame(winner), 500);
                return;
            }
            
            setTimeout(() => endTurn(), 800);
        }

        // Á≠î„ÅàÈÄÅ‰ø°ÔºàÊàêÂäü„ÉÄ„É°„Éº„Ç∏ÔºèÂõûÂæ©Ôºâ
        function submitAnswer(){
            if (!gameState.selectedCard) return;

            disableTyping();
            stopTimer();

            // ÊÆã„ÇäÊôÇÈñì„Åã„Çâ„ÉÄ„É°„Éº„Ç∏/ÂõûÂæ©Èáè„ÇíÊ¶ÇÁÆó
            const msLeft = Math.max(0, timerDeadline - performance.now());
            const remainSec = Math.max(1, Math.ceil(msLeft / 1000));
            const len = countChars(gameState.selectedCard.text);
            const amount = len * remainSec;

            const me = gameState.currentPlayer;
            const opp = 1 - me;

            // ‰Ωø„Å£„Åü„Ç´„Éº„Éâ„ÇíÊâãÊú≠„Åã„ÇâÊç®„Å¶„Çã
            const hand = gameState.hands[me];
            const idx = hand.indexOf(gameState.selectedCard);
            if (idx >= 0) hand.splice(idx, 1);

            // ÂõûÂæ©„Ç´„Éº„ÉâÔºà„Ç´„ÉÜ„Ç¥„É™Ôºö„ÅÑ„Çä„Çá„ÅÜÔºâ„ÅØÂõûÂæ©„ÄÅ„Åù„Çå‰ª•Â§ñ„ÅØÊîªÊíÉ
            if (gameState.selectedCard.category === '„ÅÑ„Çä„Çá„ÅÜ') {
                gameState.players[me].hp = Math.min(gameState.players[me].maxHp, gameState.players[me].hp + amount);
                showFloatingNumber(amount, me, true);
                playSound('heal');
            } else {
                gameState.players[opp].hp = Math.max(0, gameState.players[opp].hp - amount);
                showFloatingNumber(amount, opp, false);
                playSound('attack');
            }

            clearTypingDisplay();
            updateUI();
            
            // ÂãùÊïó„ÉÅ„Çß„ÉÉ„ÇØ
            if (gameState.players[0].hp <= 0 || gameState.players[1].hp <= 0) {
                const winner = gameState.players[0].hp <= 0 ? 1 : 0;
                setTimeout(() => endGame(winner), 500);
                return;
            }
            
            setTimeout(() => endTurn(), 800);
        }

        // „ÇÆ„Éñ„Ç¢„ÉÉ„ÉóÔºùÂç≥Â§±Êïó
        function giveUp(){
            stopTimer();
            timeUp();
        }

        // ÂàùÊúüÂåñ
        console.log('üéÆ „Çø„Ç§„Éî„É≥„Ç∞„Éê„Éà„É´ - Â≠¶Áøí„Ç≤„Éº„É†');
        console.log('üìù „Ç´„Éº„ÉâËøΩÂä†ÊñπÊ≥ï: CARD_POOLÈÖçÂàó„Å´Êñ∞„Åó„ÅÑ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíËøΩÂä†');
        console.log('üé® Â±ûÊÄß„Ç´„Çπ„Çø„Éû„Ç§„Ç∫: CSSÂ§âÊï∞ --attr-color „ÇíÂ§âÊõ¥');
        console.log('üîä Èü≥Â£∞„Ç´„Çπ„Çø„Éû„Ç§„Ç∫: playSoundÈñ¢Êï∞„ÇíÁ∑®ÈõÜ');
        /* ====== ÂøÖÈ†à„É≠„Ç∏„ÉÉ„ÇØ„ÅÆÊúÄÂ∞èÂÆüË£ÖÔºà„Ç≤„Éº„É†„ÅåÈÄ≤„ÇÄÔºâ ====== */

// ÂäπÊûúÈü≥ÔºàÁ∞°ÊòìÔºâ
function playSound(type) {
    if (!gameState.soundEnabled) return;
    ensureAudio();
    if (!audioCtx) return;

    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.connect(g); g.connect(audioCtx.destination);

    const now = audioCtx.currentTime;
    const ENDS = now + 0.12;

    // Á®ÆÈ°ûÂà•„Éî„ÉÉ„ÉÅ
    const freq = ({
        success: 880,
        fail: 220,
        charge: 440
    })[type] || 660;

    osc.frequency.setValueAtTime(freq, now);
    g.gain.setValueAtTime(0.08, now);
    g.gain.exponentialRampToValueAtTime(0.001, ENDS);

    osc.start(now);
    osc.stop(ENDS);
}

// „ÉÄ„É°„Éº„Ç∏/ÂõûÂæ©„ÅÆÂÖ±ÈÄöÂèçÊò†
function applyHp(targetIndex, delta) {
    const p = gameState.players[targetIndex];
    p.hp = Math.max(0, Math.min(p.maxHp, p.hp + delta)); // delta„ÅØÂõûÂæ©„Å™„ÇâÊ≠£„ÄÅ„ÉÄ„É°„Éº„Ç∏„Å™„ÇâË≤†
    updateUI();

    // ÊïóÂåó/ÂãùÂà©Âà§ÂÆö
    if (p.hp <= 0) {
        stopTimer();
        disableTyping();
        showModal(`${gameState.players[1 - targetIndex].name} „ÅÆÂãù„Å°ÔºÅ`, `${gameState.players[targetIndex].name} „ÅØÂÄí„Çå„Åü‚Ä¶`);
    }
}

// „Åñ„Å£„Åè„Çä„É¢„Éº„ÉÄ„É´ÔºàÊó¢Â≠ò #modal „ÇíÂà©Áî®Ôºâ
function showModal(title, text) {
    const modal = document.getElementById('modal');
    const content = document.getElementById('modalContent');
    content.innerHTML = `<h2>${title}</h2><p>${text}</p><button class="btn btn-primary" id="modalOk">OK</button>`;
    modal.style.display = 'flex';
    document.getElementById('modalOk').onclick = () => { modal.style.display = 'none'; };
}

// ÈÄ≤Ë°å„ÅÆËµ∑ÁÇπÔºö„Çø„Éº„É≥ÈñãÂßã
function startTurn() {
    gameState.gamePhase = 'cardSelect';
    clearTypingDisplay();
    updatePhaseDisplay();
    updateUI();
    drawPlayerHand();
    drawCards();

    // „Çø„Ç§„Éû„ÉºË°®Á§∫ÂàùÊúüÂåñ
    const ring = document.getElementById('timerRing');
    ring.textContent = '12';
    ring.style.background = 'conic-gradient(#feca57 360deg, rgba(255,255,255,0.2) 360deg)';

    // CPU Êà¶„Å™„ÇâCPU„ÅÆÁï™„ÅßËá™ÂãïË°åÂãï
    if (gameState.mode === 'cpu' && gameState.currentPlayer === 1) {
        setTimeout(cpuTurn, 700);
    }
}

// CPU„ÅÆÁ∞°ÊòìAIÔºà80%ÊàêÂäüÔºè3„Äú10ÁßíÊÆã„ÅóÔºâ
function cpuTurn() {
    const hand = gameState.hands[1];
    if (!hand.length) return endTurn(); // Âøµ„ÅÆ„Åü„ÇÅ

    const pick = Math.min(5, hand.length - 1); // Ë°®Á§∫6Êûö„ÅÆ„ÅÜ„Å°Êú´Â∞æ
    gameState.selectedCard = hand[pick];

    // ÊàêÂäü/Â§±Êïó
    const succeed = Math.random() < 0.8;
    if (succeed) {
        const msLeft = (3000 + Math.random() * 7000); // 3„Äú10Áßí
        const sec = Math.ceil(msLeft / 1000);
        const base = countChars(gameState.selectedCard.text);
        const amount = Math.max(1, base * sec);

        // ÊîªÊíÉ or ÂõûÂæ©
        if (gameState.selectedCard.category === '„ÅÑ„Çä„Çá„ÅÜ') {
            applyHp(1, +amount);
        } else {
            // ÊºîÂá∫ÔºàÁúÅÁï•ÂèØÔºâ
            const targetEl = document.getElementById('player1Avatar');
            const fromSide = 'right';
            playAttackAnimation({
                attr: gameState.players[1].attribute,
                from: fromSide,
                targetEl
            }).catch(()=>{});
            applyHp(0, -amount);
        }
    } else {
        const selfdmg = countChars(gameState.selectedCard.text) * 5;
        applyHp(1, -selfdmg);
    }
    endTurn();
}

// ÂÖ•ÂäõÂÆå‰∫ÜÔºàEnter‰∏çË¶Å„ÉªËá™Âãï„ÅßÂëº„Å∞„Çå„ÇãÊÉ≥ÂÆöÔºâ
function submitAnswer() {
    if (!gameState.selectedCard) return;

    // ÊÆã„ÇäÊôÇÈñì„Åã„Çâ„ÉÄ„É°„Éº„Ç∏Ë®àÁÆó
    const msLeft = Math.max(0, timerDeadline - performance.now());
    const sec = Math.ceil(msLeft / 1000);
    const base = countChars(gameState.selectedCard.text);
    const amount = Math.max(1, base * sec);

    stopTimer();
    disableTyping();

    const me = gameState.currentPlayer;
    const opp = 1 - me;

    if (gameState.selectedCard.category === '„ÅÑ„Çä„Çá„ÅÜ') {
        applyHp(me, +amount);
    } else {
        // ÊîªÊíÉÊºîÂá∫ÔºàÁõ∏Êâã„Ç¢„Éê„Çø„Éº„Çí„Çø„Éº„Ç≤„ÉÉ„ÉàÔºâ
        const targetEl = document.getElementById(`player${opp + 1}Avatar`);
        const fromSide = (me === 0) ? 'left' : 'right';
        playAttackAnimation({
            attr: gameState.players[me].attribute,
            from: fromSide,
            targetEl
        }).catch(()=>{});
        applyHp(opp, -amount);
    }
    endTurn();
}

// ÊôÇÈñìÂàá„ÇåÔºàÂ§±ÊïóÔºâ
function timeUp() {
    if (!gameState.selectedCard) return;
    disableTyping();

    const selfdmg = countChars(gameState.selectedCard.text) * 5;
    const me = gameState.currentPlayer;
    applyHp(me, -selfdmg);
    endTurn();
}

// „ÇÆ„Éñ„Ç¢„ÉÉ„ÉóÔºàESCÔºâ
function giveUp() {
    if (!gameState.selectedCard) return;
    stopTimer();
    disableTyping();

    const selfdmg = countChars(gameState.selectedCard.text) * 5;
    const me = gameState.currentPlayer;
    applyHp(me, -selfdmg);
    endTurn();
}

// „Éö„Éä„É´„ÉÜ„Ç£„ÅÆË¶ñË¶öÂäπÊûúÔºàÈñìÈÅï„ÅÑ„Ç≠„ÉºÊôÇÔºâ
function showPenaltyEffect() {
    const tg = document.getElementById('typingGuide');
    tg.classList.add('shake');
    setTimeout(() => tg.classList.remove('shake'), 300);
}

// „Çø„Éº„É≥ÁµÇ‰∫Ü ‚Üí ÊâãÊú≠Êï¥ÁêÜ ‚Üí ÊâãÁï™‰∫§‰ª£ ‚Üí Ê¨°„Çø„Éº„É≥„Å∏
function endTurn() {
    // ‰ΩøÁî®„Ç´„Éº„Éâ„ÇíÊç®„Å¶Êú≠„Å∏
    const hand = gameState.hands[gameState.currentPlayer];
    const idx = hand.indexOf(gameState.selectedCard);
    if (idx >= 0) {
        gameState.discard.push(hand.splice(idx, 1)[0]);
    }
    gameState.selectedCard = null;

    // Â±±„Åã„ÇâË£úÂÖÖÔºàÂ∏∏„Å´6Êûö‰ª•‰∏ã„Å´Ôºâ
    if (gameState.deck.length && hand.length < 6) {
        hand.push(gameState.deck.pop());
    }

    // ÂãùÊïó„ÅåÂá∫„Å¶„ÅÑ„Çå„Å∞„Åì„Åì„ÅßÊ≠¢„ÇÅ„Çã
    if (gameState.players[0].hp <= 0 || gameState.players[1].hp <= 0) return;

    // ÊâãÁï™‰∫§‰ª£
    gameState.currentPlayer = 1 - gameState.currentPlayer;
    startTurn();
}

/* ========== ÂêÑÁ®Æ„Éú„Çø„É≥„ÅÆÊúÄÂ∞èÂÆüË£Ö ========== */
function showHelp() {
    showModal('„Éò„É´„Éó', '„Ç´„Éº„Éâ„ÇíÈÅ∏„Å≥„ÄÅË°®Á§∫„Åï„Çå„Åü„Åì„Å®„Å∞„Çí„É≠„Éº„ÉûÂ≠ó„ÅßÂÖ•Âäõ„Åó„Åæ„Åô„ÄÇÊàêÂäü„Åô„Çã„Å®ÊÆã„ÇäÊôÇÈñì„Å´Âøú„Åò„Å¶ÊîªÊíÉÔºà„Åæ„Åü„ÅØÂõûÂæ©Ôºâ„ÄÇÂ§±Êïó„ÇÑ„ÇÆ„Éñ„Ç¢„ÉÉ„Éó„ÅØËá™ÂÇ∑„Å´„Å™„Çä„Åæ„Åô„ÄÇ');
}
function toggleSound() {
    gameState.soundEnabled = !gameState.soundEnabled;
    document.getElementById('soundBtn').textContent = gameState.soundEnabled ? 'üîä' : 'üîá';
}
function pauseGame() {
    gameState.isPaused = !gameState.isPaused;
    if (gameState.isPaused) { stopTimer(); }
    else if (gameState.gamePhase === 'typing') { startTimer(); }
    document.getElementById('pauseBtn').textContent = gameState.isPaused ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è';
}
function backToMenu() {
    stopTimer(); disableTyping();
    location.reload(); // „Ç∑„É≥„Éó„É´„Å´„É™„É≠„Éº„Éâ„ÅßÈñãÂßãÁîªÈù¢„Å∏
}
<script>
// ====== [Fix] „É©„Ç¶„É≥„ÉâËß£Ê±∫„ÅÆ‰∫åÈáçÂÆüË°å„Ç¨„Éº„Éâ ======
let resolving = false;

// ÊÆã„ÇäÁßí„ÇíÊï¥Êï∞„ÅßÂèñÂæóÔºà„É™„É≥„Ç∞Ë°®Á§∫„Å®Âêå„Åò‰∏∏„ÇÅ„Å´Âêà„Çè„Åõ„ÇãÔºâ
function getSecondsLeft() {
  const msLeft = Math.max(0, timerDeadline - performance.now());
  return Math.ceil(msLeft / 1000);
}

// Â§±ÊïóÔºà„Çø„Ç§„É†„Ç¢„ÉÉ„ÉóÔºâÊôÇ„ÅÆÂá¶ÁêÜ
function timeUp() {
  if (gameState.gamePhase !== 'typing' || resolving) return;
  resolving = true;
  disableTyping();
  const target = gameState.selectedCard?.text || '';
  const selfDmg = countChars(target) * 5; // ‰ªïÊßò„Å©„Åä„ÇäÔºöÂ§±Êïó„ÅØÊñáÂ≠óÊï∞√ó5 Ëá™ÂÇ∑
  applyDamage(gameState.currentPlayer, selfDmg, /*self=*/true);
  // Ë¶ã„ÅüÁõÆ„Çí„ÇØ„É™„Ç¢
  clearTypingDisplay();
  // „É©„Ç¶„É≥„ÉâÂæåÂá¶ÁêÜ„Å∏
  afterResolveRound(false);
}

// ÊàêÂäüÔºàEnter „Åæ„Åü„ÅØËá™ÂãïÂÆå‰∫ÜÔºâÊôÇ„ÅÆÂá¶ÁêÜ
function submitAnswer() {
  if (gameState.gamePhase !== 'typing' || resolving) return;
  resolving = true;
  disableTyping();
  stopTimer();

  const text = gameState.selectedCard?.text || '';
  const len = countChars(text);
  const secLeft = getSecondsLeft(); // ‰ªïÊßòÔºöÊñáÂ≠óÊï∞ √ó ÊÆã„ÇäÊôÇÈñìÔºàÁßíÔºâ
  const dmg = Math.max(1, secLeft) * len;

  // ÊîªÊíÉ„ÅØÁõ∏Êâã„Å∏
  applyDamage(1 - gameState.currentPlayer, dmg, /*self=*/false);

  // Ë¶ã„ÅüÁõÆ„Çí„ÇØ„É™„Ç¢
  clearTypingDisplay();

  // „É©„Ç¶„É≥„ÉâÂæåÂá¶ÁêÜ„Å∏
  afterResolveRound(true);
}

// „ÉÄ„É°„Éº„Ç∏ÈÅ©Áî®ÔºÜUIÊõ¥Êñ∞
function applyDamage(targetPlayerIndex, amount, self = false) {
  gameState.players[targetPlayerIndex].hp = Math.max(0, gameState.players[targetPlayerIndex].hp - amount);
  updateUI();
}

// „É©„Ç¶„É≥„ÉâËß£Ê±∫Âæå„ÅÆÂÖ±ÈÄöÂá¶ÁêÜ
function afterResolveRound(success) {
  // ÈÅ∏„Çì„Å†„Ç´„Éº„Éâ„ÇíÊç®„Å¶Êú≠„Å∏ÔºàÊâãÊú≠„Åã„ÇâÈô§Â§ñÔºâ
  if (gameState.selectedCard) {
    const hand = gameState.hands[gameState.currentPlayer];
    const idx = hand.indexOf(gameState.selectedCard);
    if (idx >= 0) hand.splice(idx, 1);
    gameState.discard.push(gameState.selectedCard);
  }
  gameState.selectedCard = null;

  // „Ç≤„Éº„É†ÁµÇ‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ ‚Üí ÁµêÊûú„É¢„Éº„ÉÄ„É´„Çí**„Åì„Åì„ÅßÂøÖ„Åö**Âá∫„Åô
  if (checkGameOver()) {
    resolving = false;
    return;
  }

  // Ê¨°„Çø„Éº„É≥„Å∏
  gameState.currentPlayer = 1 - gameState.currentPlayer;
  gameState.gamePhase = 'cardSelect';
  updatePhaseDisplay();
  drawPlayerHand();
  drawCards();
  updateUI();
  resolving = false;
}

// ÁµÇ‰∫ÜÊù°‰ª∂„Å®ÁµêÊûúË°®Á§∫
function checkGameOver() {
  const p0 = gameState.players[0];
  const p1 = gameState.players[1];

  const hpEnd = (p0.hp <= 0 || p1.hp <= 0);
  const noMoreCards = (gameState.deck.length === 0 &&
                       gameState.hands[0].length === 0 &&
                       gameState.hands[1].length === 0);

  if (!hpEnd && !noMoreCards) return false;

  stopTimer();
  disableTyping();

  showSummaryModal();
  return true;
}

function showSummaryModal() {
  const p0 = gameState.players[0], p1 = gameState.players[1];
  let winnerText = 'Âºï„ÅçÂàÜ„Åë';
  if (p0.hp !== p1.hp) {
    winnerText = (p1.hp <= 0 || p0.hp > p1.hp) ? `${p0.name}` : `${p1.name}`;
  }

  const modal = document.getElementById('modal');
  const content = document.getElementById('modalContent');
  content.innerHTML = `
    <h2>ÁµêÊûú</h2>
    <p><strong>ÂãùËÄÖÔºö</strong>${winnerText}</p>
    <p>${p0.name}Ôºö${p0.hp}/${p0.maxHp}„ÄÄÔΩú„ÄÄ${p1.name}Ôºö${p1.hp}/${p1.maxHp}</p>
    <div style="margin-top:16px; display:flex; gap:10px; justify-content:center;">
      <button class="btn btn-primary" id="retryBtn">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
      <button class="btn btn-secondary" id="backBtn">„É°„Éã„É•„Éº„Å∏</button>
    </div>
  `;
  modal.style.display = 'flex';

  document.getElementById('retryBtn').onclick = () => {
    modal.style.display = 'none';
    resetAndRestart();
  };
  document.getElementById('backBtn').onclick = () => {
    modal.style.display = 'none';
    backToMenu();
  };
}

function resetAndRestart() {
  // ÊúÄ‰ΩéÈôê„ÅÆ„É™„Çª„ÉÉ„Éà„ÅßÂÜçÈñã
  stopTimer();
  disableTyping();
  clearTypingDisplay();

  gameState.deck = [];
  gameState.discard = [];
  gameState.hands = [[], []];
  gameState.selectedCard = null;
  gameState.gamePhase = 'cardSelect';
  resolving = false;

  initGame();
}

// backToMenu„ÅåÊú™ÂÆüË£Ö„Å™„ÇâÊúÄ‰ΩéÈôê„ÅÆÊàª„Åó
if (typeof backToMenu !== 'function') {
  function backToMenu() {
    // „Çπ„Çø„Éº„ÉàÁîªÈù¢„Å´Êàª„Åô
    document.getElementById('gameContainer').classList.add('hidden');
    document.getElementById('startScreen').classList.remove('hidden');
    stopTimer();
    disableTyping();
  }
}
</script>       
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'977b0e14f587d521',t:'MTc1NjYyNzg2NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
