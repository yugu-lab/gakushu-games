<!-- /kanji-quiz.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>漢字穴埋めクイズ</title>
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root{ --bg1:#b8e8ff; --bg2:#e7d5ff; --ink:#0b1324; --muted:#5b6b8a; --accent:#ffd166; --accent-deep:#f3b43a; --pink:#ff9ecd; --pink-deep:#e488b9; --arrow:#3b82f6; --ok:#12b886; --ng:#ef4444; --panel:#ffffff; }
  *{ box-sizing:border-box; }
  body{
    margin:0; color:var(--ink);
    font-family:"M PLUS Rounded 1c","Hiragino Maru Gothic ProN","Yu Gothic UI","Hiragino Sans","Noto Sans JP",system-ui,sans-serif;
    min-height:100svh; display:grid; place-items:center; padding:18px;
    background: radial-gradient(1400px 700px at 0% -10%, var(--bg1), transparent),
               radial-gradient(1200px 600px at 100% 0%, var(--bg2), #f7f9ff);
  }
  .app{ width:min(1180px,100%); }
  h1{ margin:0 0 14px; font-size:clamp(22px,3.8vw,32px); font-weight:900; letter-spacing:.02em; }
  .panel{ background:var(--panel); border:3px solid #edf0f7; border-radius:22px; padding:18px; box-shadow:0 10px 0 #e6e9f5; }
  button,select,input{ border:none; border-radius:14px; padding:10px 14px; font-weight:900; }
  button{ cursor:pointer; }
  .primary{ background:var(--accent); color:#3b2b00; box-shadow:0 8px 0 var(--accent-deep); }
  .ghost{ background:#eef2ff; box-shadow:0 8px 0 #cbd5ff; }
  .pink{ background:linear-gradient(#ffd3e7,#ffb2d8); color:#3b1230; box-shadow:0 10px 0 var(--pink-deep); border:3px solid #ffd5e7; }
  .badge{ background:#fff; border:2px solid #e9ecff; padding:6px 12px; border-radius:999px; font-weight:900; }
  .kbd{ font-family:ui-monospace,monospace; background:#1111; padding:2px 6px; border-radius:8px; border:1px solid #0001;}
  .row{ display:flex; gap:16px; flex-wrap:wrap; }
  .hidden{ display:none !important; }
  .tiny{ font-size:12px; color:var(--muted); }
  :focus-visible{ outline:3px solid #6366f1; outline-offset:3px; }

  /* ===== MENU（ルールを広く） ===== */
  #menu .grid{ display:grid; gap:22px; }
  #menu h2{ margin:6px 0 8px; font-size:18px; }
  #menu .line{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  #twoConfig{ display:none; gap:10px; align-items:flex-end; }
  #twoConfig input[type="text"]{ width:10em; background:#fff; border:2px solid #e8ecf7; }
  #targetPoints{ width:6em; text-align:center; background:#fff; border:2px solid #e8ecf7; }
  .ruleWrap{ border:2px dashed #dbe4ff; border-radius:18px; padding:18px; background:#fbfdff; }
  .ruleGrid{ display:grid; gap:18px; grid-template-columns:minmax(320px,1fr) minmax(360px,1.2fr); align-items:center; }
  .demoBoard{ position:relative; width:min(360px,38vw); aspect-ratio:1/1; border-radius:20px; background:#fff; box-shadow:inset 0 0 0 4px #e3e9ff; margin:auto; }
  .demoCell{ position:absolute; display:grid; place-items:center; font-weight:900; font-size:clamp(24px,2.6vw,34px); }
  .demoCell.t{ inset:auto 0 76% 0; } .demoCell.b{ inset:76% 0 auto 0; } .demoCell.l{ inset:0 auto 0 8%; top:50%; transform:translateY(-50%);} .demoCell.r{ inset:0 8% 0 auto; top:50%; transform:translateY(-50%); }
  .demoCenterWrap{ position:absolute; inset:0; margin:auto; width:36%; aspect-ratio:1/1; }
  .demoCenter{ position:absolute; inset:0; margin:auto; border-radius:16px; background:#f2f6ff; box-shadow:inset 0 0 0 4px #c7d2fe; display:grid; place-items:center; font-size:20px; }
  .demoArrow{ position:absolute; width:38px; height:38px; border-radius:999px; background:var(--arrow); color:#fff; display:grid; place-items:center; font-size:18px; text-shadow:0 2px 0 #0002; box-shadow:0 6px 0 #0001, inset 0 -4px 0 #0002; }
  .demoArrow.t{ left:50%; top:12px; transform:translate(-50%,0); }
  .demoArrow.b{ left:50%; bottom:12px; transform:translate(-50%,0); }
  .demoArrow.l{ left:12px; top:50%; transform:translate(0,-50%); }
  .demoArrow.r{ right:12px; top:50%; transform:translate(0,-50%); }

  .howto h3{ margin:.2em 0 .6em; font-size:18px; }
  .howto p{ margin:.3em 0; }
  .chip{ display:inline-block; background:#fff; border:2px solid #e7ecff; border-radius:999px; padding:6px 10px; margin:2px 6px 2px 0; font-weight:900; }
  .legend{ display:grid; grid-template-columns:110px 1fr; align-items:center; gap:8px; margin:.4em 0; }
  .legend .kbd{ text-align:center; min-width:84px; }
  .legend small{ color:var(--muted); }

  /* ===== GAME ===== */
  #gameHeader{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-bottom:12px; }
  #scoreArea{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .stage{ display:grid; place-items:center; gap:10px; padding:12px; }
  .playArea{ position:relative; width:min(1100px,96vw); min-height:720px; display:flex; justify-content:center; align-items:center; padding-bottom:120px; }
  .board{ position:relative; width:min(560px,64%); aspect-ratio:1/1; border-radius:28px; background:radial-gradient(200px 140px at 30% 20%, #fff8, transparent), #fff; box-shadow:inset 0 0 0 4px #e8ecf7, 0 14px 0 #e6e9f5; }
  .cell{ position:absolute; display:grid; place-items:center; font-weight:900; font-size:clamp(30px,6.2vw,46px); color:#0e1726; user-select:none; text-shadow:0 2px 0 #dfe7ff; }
  .cell.top{ inset:auto 0 79% 0; } .cell.bottom{ inset:79% 0 auto 0; } .cell.left{ inset:0 auto 0 9%; top:50%; transform:translateY(-50%); } .cell.right{ inset:0 9% 0 auto; top:50%; transform:translateY(-50%); }
  .centerWrap{ position:absolute; inset:0; margin:auto; width:34%; aspect-ratio:1/1; display:block; }
  .centerBox{ position:absolute; inset:0; margin:auto; width:100%; height:100%; border-radius:20px; background:#f9fbff; box-shadow:inset 0 0 0 4px #c7d2fe; display:grid; place-items:center; }
  .centerInput{ width:2.2em; text-align:center; font-size:clamp(24px,5vw,34px); padding:6px 8px; border-radius:14px; border:3px solid #94a3b8; background:#fff; position:relative; z-index:3; }
  .arrowBubble{ position:absolute; width:44px; height:44px; border-radius:999px; display:grid; place-items:center; font-size:24px; color:#fff; background:var(--arrow); text-shadow:0 2px 0 #0002; box-shadow:0 6px 0 #0001, inset 0 -4px 0 #0002; z-index:2; pointer-events:none; }
  .arrowBubble.top{ left:50%; top:8px; transform:translate(-50%,0); }
  .arrowBubble.bottom{ left:50%; bottom:8px; transform:translate(-50%,0); }
  .arrowBubble.left{ left:8px; top:50%; transform:translate(0,-50%); }
  .arrowBubble.right{ right:8px; top:50%; transform:translate(0,-50%); }

  .buzzBtn{ position:absolute; top:50%; transform:translateY(-50%); width:200px; height:260px; border-radius:26px; display:flex; align-items:center; justify-content:center; gap:6px; font-weight:900; font-size:24px; color:#0f172a; text-align:center; }
  .buzzBtn.left{ left:10px; } .buzzBtn.right{ right:10px; } .buzzBtn small{ display:block; font-size:14px; color:#3c2a32; }

  .crownBar{ position:absolute; left:0; right:0; bottom:12px; display:flex; justify-content:space-between; align-items:flex-end; padding:0 10px; }
  .crownCard{ width:200px; min-height:86px; text-align:center; font-weight:900; color:#0f172a; background:#ffffffd9; border:2px solid #e8ecff; border-radius:18px; box-shadow:0 8px 0 #dfe5ff; padding:8px 10px; }
  .crownCard .name{ font-size:16px; margin-bottom:4px; }
  .crownCard .crowns{ font-size:22px; line-height:1.1; }
  .crownCard .nums{ font-size:12px; color:var(--muted); }

  .result{ font-weight:900; font-size:18px; min-height:1.6em; }
  .ok{ color:var(--ok); } .ng{ color:var(--ng); }

  /* ===== 早押しモーダル ===== */
  .modal{ position:fixed; inset:0; background:#0006; display:none; align-items:center; justify-content:center; z-index:50; }
  .modal.show{ display:flex; }
  .modalCard{ width:min(700px,95vw); background:linear-gradient(#fff,#f8fbff); border-radius:24px; padding:18px; box-shadow:0 24px 80px #0005; border:3px solid #edf0f7; position:relative; }
  .modalHead{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:6px; }
  .tag{ background:#eef2ff; border:2px solid #cbd5ff; border-radius:999px; padding:6px 12px; font-weight:900; }
  .closeBtn{ border:none; background:#eef2ff; border-radius:12px; padding:8px 12px; font-weight:900; cursor:pointer; }
  .timerWrap{ position:absolute; left:50%; transform:translateX(-50%); top:-16px; display:flex; flex-direction:column; align-items:center; gap:6px; }
  .timerBadge{ background:#111; color:#fff; border-radius:999px; padding:6px 14px; font-weight:900; letter-spacing:.03em; box-shadow:0 6px 0 #0003; }
  .timerBadge.warn{ background:#ef4444; }
  .progressTrack{ width:min(480px,82vw); height:10px; background:#e9eefc; border-radius:999px; overflow:hidden; border:2px solid #dbe3ff; }
  .progressFill{ height:100%; width:0%; background:linear-gradient(90deg,#60a5fa,#93c5fd); }
  .miniWrap{ position:relative; margin:22px auto 8px; width:min(520px,92%); aspect-ratio:1/1; }
  .miniWrap .centerWrap{ width:50%; }
  .miniWrap .arrowBubble{ width:58px; height:58px; font-size:26px; }
  .miniWrap .cell{ font-size:clamp(26px,6vw,48px); }
  .ansRow{ display:flex; gap:10px; align-items:center; justify-content:center; margin-top:10px; }
  .modalHint{ text-align:center; color:var(--muted); }

  /* ===== 正解ポップ ===== */
  .celeModal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:#0005; z-index:70; }
  .celeModal.show{ display:flex; }
  .celeCard{ background:linear-gradient(#fff,#f7fbff); padding:26px 24px; border-radius:26px; border:4px solid #e8edff; box-shadow:0 24px 80px #0005; text-align:center; width:min(560px,92vw); }
  .celeTitle{ font-size:clamp(28px,6vw,40px); font-weight:900; margin:0 0 6px; color:#0e1726; }
  .celeSub{ color:#475569; margin:0 0 10px; }
  .celeEmo{ font-size:42px; }
  .confetti{ position:fixed; pointer-events:none; animation:fall .9s ease-out forwards; font-size:24px; }
  @keyframes fall{ to{ transform:translateY(80vh) rotate(360deg); opacity:0; } }

  /* ===== 終了ダイアログ ===== */
  .endModal{ position:fixed; inset:0; background:#0006; display:none; align-items:center; justify-content:center; z-index:80; }
  .endModal.show{ display:flex; }
  .endCard{ width:min(560px,92vw); background:linear-gradient(#fff,#f7fbff); border-radius:26px; border:4px solid #e8edff; box-shadow:0 24px 80px #0005; text-align:center; padding:22px 20px; }
  .endTitle{ font-weight:900; font-size:clamp(22px,4.8vw,30px); margin:0 0 6px; }
  .endSub{ color:#475569; margin:0 0 14px; }
  .endActions{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }

  /* ===== 戻る確認モーダル（最前面） ===== */
  .confirmBack{ position:fixed; inset:0; background:#0006; display:none; align-items:center; justify-content:center; z-index:120; }
  .confirmBack.show{ display:flex; }
  .confirmCard{ width:min(520px,92vw); background:linear-gradient(#fff,#f7fbff); border-radius:22px; border:3px solid #e8edff; box-shadow:0 24px 80px #0005; padding:18px; text-align:center; }
  .confirmTitle{ font-weight:900; font-size:clamp(18px,4.2vw,22px); margin:0 0 8px; }
  .confirmMsg{ color:#475569; margin:0 0 14px; }
  .confirmActions{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
  @media (max-width:780px){ .ruleGrid{ grid-template-columns:1fr; } .playArea{ min-height:780px; padding-bottom:160px; } .buzzBtn{ width:80%; height:96px; left:50%; transform:translate(-50%,0); } .buzzBtn.left{ top:6%; } .buzzBtn.right{ bottom:6%; top:auto; } .board{ width:86%; } .crownBar{ bottom:10px; } .crownCard{ width:48%; } }
</style>
</head>
<body>
<div class="app">
  <h1>漢字穴埋めクイズ</h1>

  <!-- ===== MENU ===== -->
  <div id="menu" class="panel">
    <div class="grid">
      <section>
        <h2>ルール</h2>
        <div class="ruleWrap">
          <div class="ruleGrid">
            <div class="demoBoard" aria-hidden="true">
              <div class="demoCell t">友</div><div class="demoCell b">発</div><div class="demoCell l">配</div><div class="demoCell r">成</div>
              <div class="demoCenterWrap">
                <div class="demoCenter">□</div>
                <div class="demoArrow t">↓</div><div class="demoArrow b">↑</div><div class="demoArrow l">→</div><div class="demoArrow r">→</div>
              </div>
            </div>
            <div class="howto">
              <h3>あそびかた</h3>
              <p>中央の□に<strong>同じ一文字</strong>を入れて、四方向の<strong>二字熟語</strong>を完成させよう。</p>
              <div class="legend">
                <span class="kbd">→</span><div>左の漢字＋中央</div>
                <span class="kbd">→</span><div>中央＋右の漢字</div>
                <span class="kbd">↑</span><div>下の漢字＋中央</div>
                <span class="kbd">↓</span><div>上の漢字＋中央</div>
              </div>
              <p class="tiny">例：中央が<strong>「達」</strong>だと <span class="chip">友達</span><span class="chip">配達</span><span class="chip">達成</span><span class="chip">発達</span></p>
              <ul>
                <li>1人モード：Enterで判定。</li>
                <li>2人モード：P1=F／P2=J（またはボタン）。勝者先取。</li>
              </ul>
            </div>
          </div>
        </div>
      </section>

      <section>
        <h2>モード・設定</h2>
        <div class="line">
          <strong>モード</strong>
          <label><input type="radio" name="modePick" value="1p" checked> 1人モード</label>
          <label><input type="radio" name="modePick" value="2p"> 2人モード（早押し）</label>
        </div>
        <div id="twoConfig" class="line">
          <div><div class="tiny">P1 のなまえ</div><input id="p1NameInput" type="text" placeholder="P1" /></div>
          <div><div class="tiny">P2 のなまえ</div><input id="p2NameInput" type="text" placeholder="P2" /></div>
          <div><div class="tiny">先取ポイント</div><input id="targetPoints" type="number" min="1" max="10" value="2" /></div>
          <div class="tiny">キー操作：P1=<span class="kbd">F</span>／P2=<span class="kbd">J</span></div>
        </div>
        <div class="line">
          <strong>出題範囲</strong>
          <select id="dataset">
            <option value="g4">四年のみ</option>
            <option value="g45">四年＋五年</option>
            <option value="g456" selected>四年＋五年＋六年</option>
          </select>
        </div>
        <div><button id="startBtn" class="primary" type="button">ゲーム開始</button></div>
      </section>
    </div>
  </div>

  <!-- ===== GAME ===== -->
  <div id="game" class="hidden">
    <div id="gameHeader">
      <div id="scoreArea"></div>
      <div class="tiny">
        <span id="infoMode" class="badge"></span>
        <span id="infoDataset" class="badge"></span>
        <button id="backToMenu" class="ghost" type="button">最初に戻る</button>
      </div>
    </div>

    <div class="panel" id="playPanel">
      <strong>プレイ</strong>
      <div class="stage">
        <div class="playArea">
          <button class="buzzBtn left pink" id="buzzLeft" type="button" aria-label="プレイヤー1 早押し">P1<br><small>早押し！</small></button>
          <div class="board" id="board" aria-live="polite">
            <div class="cell top" id="topK">空</div>
            <div class="cell bottom" id="bottomK">現</div>
            <div class="cell left" id="leftK">正</div>
            <div class="cell right" id="rightK">中</div>
            <div class="centerWrap">
              <div class="centerBox"><input id="answer" class="centerInput" maxlength="1" inputmode="text" autocomplete="off" aria-label="中央の漢字を入力" /></div>
              <div class="arrowBubble top" id="arrTop">↓</div>
              <div class="arrowBubble bottom" id="arrBottom">↑</div>
              <div class="arrowBubble left" id="arrLeft">→</div>
              <div class="arrowBubble right" id="arrRight">←</div>
            </div>
          </div>
          <button class="buzzBtn right pink" id="buzzRight" type="button" aria-label="プレイヤー2 早押し">P2<br><small>早押し！</small></button>
          <div class="crownBar" id="crownBar">
            <div class="crownCard" id="p1Score"><div class="name" id="p1NameView">P1</div><div class="crowns" id="p1Crowns">—</div><div class="nums tiny" id="p1Nums"></div></div>
            <div class="crownCard" id="p2Score"><div class="name" id="p2NameView">P2</div><div class="crowns" id="p2Crowns">—</div><div class="nums tiny" id="p2Nums"></div></div>
          </div>
        </div>

        <div class="row" style="gap:10px; align-items:center; justify-content:center;">
          <button id="checkBtn" class="primary" type="button">判定</button>
          <button id="showBtn" class="ghost" type="button">答えを見る</button>
          <label class="tiny"><input type="checkbox" id="autoNext" checked disabled> 常に次の問題へ（固定）</label>
          <span id="poolInfo" class="tiny"></span>
        </div>

        <div class="result" id="result"></div>
        <div class="tiny" id="hint"></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== 早押しモーダル ===== -->
<div class="modal" id="modal" aria-modal="true" role="dialog">
  <div class="modalCard">
    <div class="modalHead">
      <div class="tag" id="modalTitle">P1 の解答</div>
      <button class="closeBtn" id="modalClose" type="button">閉じる</button>
    </div>
    <div class="timerWrap" aria-live="polite" aria-atomic="true">
      <div class="timerBadge" id="timerBadge">残り 12 秒</div>
      <div class="progressTrack"><div class="progressFill" id="progressFill"></div></div>
    </div>
    <div class="miniWrap">
      <div class="centerWrap">
        <div class="centerBox"><input id="buzzAnswer" class="centerInput" maxlength="1" inputmode="text" autocomplete="off" aria-label="中央の漢字を入力（早押し）" /></div>
        <div class="arrowBubble top" id="mArrTop">↓</div>
        <div class="arrowBubble bottom" id="mArrBottom">↑</div>
        <div class="arrowBubble left" id="mArrLeft">→</div>
        <div class="arrowBubble right" id="mArrRight">←</div>
      </div>
      <div class="cell top" id="mTop" style="inset:auto 0 79% 0;"></div>
      <div class="cell bottom" id="mBottom" style="inset:79% 0 auto 0;"></div>
      <div class="cell left" id="mLeft" style="inset:0 auto 0 9%; top:50%; transform:translateY(-50%);"></div>
      <div class="cell right" id="mRight" style="inset:0 9% 0 auto; top:50%; transform:translateY(-50%);"></div>
    </div>
    <div class="ansRow"><button id="buzzCheckBtn" class="primary" type="button">判定</button></div>
    <div class="modalHint tiny" id="modalHint"></div>
  </div>
</div>

<!-- ===== 正解ポップ ===== -->
<div class="celeModal" id="celeModal" aria-hidden="true">
  <div class="celeCard">
    <div class="celeEmo">🎉✨🌟</div>
    <h3 class="celeTitle" id="celeTitle">せいかい！</h3>
    <p class="celeSub" id="celeSub">とってもいいひらめき！つぎもいっちゃおう！</p>
  </div>
</div>

<!-- ===== 対戦終了モーダル ===== -->
<div class="endModal" id="endModal" aria-modal="true" role="dialog">
  <div class="endCard">
    <div style="font-size:38px">🏁👑</div>
    <h3 class="endTitle"><span id="endWinner">P1</span> の勝ち！</h3>
    <p class="endSub">もう一度勝負する？それとも最初に戻る？</p>
    <div class="endActions">
      <button id="againBtn" class="primary" type="button">もう一度やる</button>
      <button id="toMenuBtn" class="ghost" type="button">最初に戻る</button>
    </div>
  </div>
</div>

<!-- ===== 戻る確認モーダル（カスタム） ===== -->
<div class="confirmBack" id="confirmBack" aria-modal="true" role="dialog">
  <div class="confirmCard">
    <h3 class="confirmTitle">最初に戻る</h3>
    <p class="confirmMsg">本当に最初に戻りますか？プレイ中の進行はクリアされます。</p>
    <div class="confirmActions">
      <button id="confirmBackYes" class="primary" type="button">はい</button>
      <button id="confirmBackNo" class="ghost" type="button">いいえ</button>
    </div>
  </div>
</div>

<script>
/* ===== Utilities & Globals ===== */
const $ = (q)=>document.querySelector(q);
function shuffle(arr){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]];} return a; }
const uniq=(arr)=>[...new Set(arr)];
const twoCharOnly=(tokens)=>tokens.filter(w=>w.length===2 && /^[\u4E00-\u9FFF]{2}$/.test(w));

let pool=[], queue=[], current=null;
let mode='1p', dataset='g456';
let oneP={total:0, correct:0, streak:0};
let twoP={ p1:0, p2:0, p1Name:'P1', p2Name:'P2', target:2, buzzer:null, timeLeft:0, timerId:null,
           lockoutUntil:{1:0,2:0}, lockTimeouts:{1:null,2:null}, lockTicker:null };
const AUTO_DELAY=900, BUZZ_TIME=12;
let modalOpen=false;
let usedKeys=new Set();
const KANJI=/^[\u4E00-\u9FFF]$/;

/* 自動遷移（答え表示→次問題） */
let nextTimer=null;
function clearNext(){ if(nextTimer){ clearTimeout(nextTimer); nextTimer=null; } }
function scheduleNext(ms){ clearNext(); nextTimer=setTimeout(()=>{ nextTimer=null; nextQuestion(); }, ms); }

/* 進行タイマー（早押し） */
function clearTimers(){ if(twoP && twoP.timerId){ clearInterval(twoP.timerId); twoP.timerId=null; } }

/* Audio */
let audioCtx=null;
function ensureAudio(){ const AC=window.AudioContext||window.webkitAudioContext; if(!audioCtx&&AC){ audioCtx=new AC(); } if(audioCtx&&audioCtx.state==='suspended'){ audioCtx.resume(); } return audioCtx; }
function _tone(f=880, dur=0.15, type='sine', gain=0.08, t0){ const ctx=ensureAudio(); if(!ctx) return; const osc=ctx.createOscillator(); const g=ctx.createGain(); const start=t0??ctx.currentTime; osc.type=type; osc.frequency.setValueAtTime(f,start); g.gain.setValueAtTime(0.0001,start); g.gain.linearRampToValueAtTime(gain,start+0.01); g.gain.exponentialRampToValueAtTime(0.0001,start+dur); osc.connect(g).connect(ctx.destination); osc.start(start); osc.stop(start+dur+0.02); }
function playPinpon(){ try{const t=ensureAudio()?.currentTime??0; _tone(880,0.12,'sine',0.09,t); _tone(1174.66,0.16,'sine',0.09,t+0.14);}catch(_){ } }
function playBuzz(){ try{ const ctx=ensureAudio(); if(!ctx) return; const t=ctx.currentTime; const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='square'; o.frequency.setValueAtTime(800,t); o.frequency.exponentialRampToValueAtTime(220,t+0.25); g.gain.setValueAtTime(0.0001,t); g.gain.linearRampToValueAtTime(0.08,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+0.32); o.connect(g).connect(ctx.destination); o.start(t); o.stop(t+0.35);}catch(_){ } }

/* Celebrate */
function celebrate(title, sub){ try{playPinpon();}catch(_){ } const modal=$('#celeModal'); $('#celeTitle').textContent=title||'せいかい！'; $('#celeSub').textContent=sub||'よく気づいたね！'; modal?.classList.add('show'); fireConfetti(); setTimeout(()=>modal?.classList.remove('show'),900); }
function fireConfetti(){ const em=['🎉','✨','🎈','⭐️','🍭','🎊','💫','👏']; for(let i=0;i<22;i++){ const s=document.createElement('div'); s.className='confetti'; s.textContent=em[(Math.random()*em.length)|0]; s.style.left=(8+Math.random()*84)+'vw'; s.style.top='-10vh'; document.body.appendChild(s); setTimeout(()=>s.remove(),900); } }

/* Helpers */
function puzzleKey(p){ const d=p.dir; return `${p.chars.top}|${p.chars.left}|${p.chars.right}|${p.chars.bottom}|${d.top[0]}${d.left[0]}${d.right[0]}${d.bottom[0]}`; }

/* Word lists (省略なし・原文通り) */
const listG4=`光栄 説教 伝言 会費 受付 共通 全治 時差 牧場 赤飯 水害 海軍 加速 果実 山脈 愛用 好物 協力 順番 入隊 関連 残高 英国 良好 熱意 達成 消毒 案内 英語 夫人 新芽 例年 手鏡 大陸 停電 作法 苦戦 心得 梅酒 大型 胃腸 無実 選挙 村民 食堂 清流 試験 建物 殺気 夏季 生徒 最初 愛読 号令 投票 放置 漁港 試合 成長 変色 労働 標高 停車 重要 特色 最大 発達 得点 一兆 健康 産地 底辺 参観 民家 未定 兵隊 要点 残暑 有利 申告 大量 最悪 機械 音量 勝敗 結末 不安 周囲 司会 得意 巣箱 曲芸 貯金 位置 祝福 司令 結束 信念 作戦 倉庫 体験 最後 日課 最近 完成 教官 周辺 改良 苦労 人類 育児 欠席 満員 目印 単位 以内 目標 管理 完治 対象 南極 児童 昨年 北極 浴室 参加 景品 取材 自信 成功 良薬 卒業 包帯 筆順 兵士 手芸 季節 成果 選手 固形 付録 夕飯 軍隊 給油 発芽 名札 単語 配達 勇気 風景 加熱 標語 札束 自然 欠航 側転 広告 郡部 粉末 遠浅 出費 世帯 型紙 粉雪 加工 有料 好感 消費 料理 世紀 飛行 続出 直径 共用 完全 航路 信用 気象 欠点 塩分 栄光 左折 便利 愛犬 希望 新型 順位 陸軍 松林 約束 競争 各自 通信 節電 察知 節約 満点 文脈 辞典 名案 関係 戦争 左側 急変 連休 生産 説明 衣類 競輪 道順 当然 訓練 反省 府立 仲間 関心 成分 競馬 笑顔 分別 給食 連続 記録 面積 未知 停止 要求 年輪 歴代 例題 木材 未来 貨物 達人 議題 利用 挙手 兆候 命令 加入 勇者 半径 野菜 席順 種類 失敗 残念 消印 方法 印象 信号 冷静 公害 衣服 観察 小包 気候 伝説 電灯 子孫 街灯 無事 徒歩 食器 会議 観光 金貨 無料 開票 休養 歴史 国民 灯台 昨夜 伝記 必要 水辺 実験 門松 軍手 散歩 国旗 熱心 工夫 告発 失明 底力 国産 最新 水位 努力 小説 結果 以外 伝票 牧草 塩害 楽器 円周 欠場 大臣 出席 法事 本堂 最高 氏名 印刷 観客 光景 栄養 天然 満開 借金 賞金 年末 景気 録画 競泳 願望 力士 共感 追加 特訓 老人 漁船 友達 祝日 材料 作成 録音 半周 念願 兵器 変化 特選 辞書`;
const listG5=`悪夢 証言 整備 指示 夫婦 決断 製作 合格 対応 件数 習慣 金額 利益 移動 用件 統計 夕刊 音程 技術 文句 政治 炭鉱 祖先 仏教 採用 現在 財布 枝豆 留学 適度 打破 増加 豊作 見解 素材 表示 改修 招集 火災 保管 領土 意志 職人 団体 移住 旧友 正確 表情 液体 個人 提出 義理 逆転 鳥居 銭湯 基準 故意 効能 減速 教師 恩人 犯罪 家財 破損 確保 河口 肥満 標準 語句 絶対 責任 河川 構成 現状 資格 物資 省略 水質 事情 提案 証明 判断 勢力 念仏 酸素 切断 版画 暴力 米俵 貿易 迷子 護衛 武器 事故 道徳 愛情 個体 価格 演説 預金 快勝 税金 往年 構図 情報 続編 知識 確実 性質 減少 保護 実現 復活 謝罪 電圧 的確 設備 小銭 永遠 再会 仏様 興味 複雑 災害 実際 強敵 新居 中断 経験 医師 適当 才能 予防 快適 倍率 逆境 確定 業績 状態 賛成 朝刊 暴風 快復 製品 勝因 戦略 理解 精米 退院 伝統 態度 主婦 検査 非常 清潔 混雑 効果 導入 解禁 独学 原因 酸味 講習 損害 複写 断水 建築 評価 格安 仮設 解決 銅像 支店 復興 住居 職業 余計 夢中 義務 略語 犯行 報告 特許 条件 往復 土俵 序文 画像 競技 人情 主張 述語 設置 調査 内容 雑草 回復 判定 同居 引退 精神 農耕 承知 現場 組織 性格 運勢 絶賛 肥料 予測 眼科 幹事 比率 牛舎 防止 日程 経営 無益 校舎 順序 復習 犯人 仮説 敗因 採点 確率 団結 接近 輸送 常識 所属 油断 採取 法則 気圧 接続 小枝 均等 輸入 授業 準備 容器 規制 現像 複数 点検 要領 増築 講師 豊富 防犯 事件 個別 墓地 急増 血圧 現地 経過 限界 情熱 感謝 新築 提示 妻子 肉眼 金銭 反則 過去 余分 財政 実績 先祖 資料 損得 護送 事態 測定 在庫 編集 評判 弁当 記述 答弁 独特 禁物 容易 経路 解散 天敵 修理 反応 適正 実在 質問 成績 許可 想像 武術 旧式 祖父`;
const listG6=`朝晩 全巻 寸法 忠実 高層 専用 故郷 模様 憲法 演奏 奮発 価値 担当 反論 遺骨 感激 紅葉 裏表 勤務 厳重 収集 寸断 敬語 衣装 主将 補足 破片 皇居 今晩 穀物 値段 点呼 推理 発揮 針金 警備 庁舎 処分 調律 模型 規律 悪党 電源 度胸 分担 灰色 骨折 根源 従来 穴場 若手 翌週 注射 散乱 満潮 諸国 縮小 誠実 賃金 宝物 砂場 心臓 危険 著者 宝石 翌朝 首脳 半熟 必至 延焼 首筋 看板 収入 議論 視点 語源 至急 宗派 階段 私語 圧縮 派手 混乱 困難 昨晩 干潮 無視 異常 難民 熟語 簡潔 推測 吸収 秘蔵 検討 拡大 純白 誕生 石段 就任 聖書 提供 一株 地層 地域 傷口 担任 服装 容姿 樹立 枚数 映画 砂金 非難 返済 権限 仁愛 窓口 誠意 班長 興奮 拝見 音域 片方 宗教 筋肉 時刻 規模 将軍 革命 皇室 鉄棒 朗読 忠告 仁義 温暖 警笛 翌年 純金 雑誌 映像 頭痛 自己 疑問 改装 看病 誤解 帰宅 武将 延期 胸中 訪問 秘密 沿線 五冊 頭脳 宇宙 収納 除去 背中 結論 死亡 姿勢 権力 操作 確認 冊子 政党 将来 沿岸 頂上 警報 尊敬 砂鉄 紅茶 腹痛 牛乳 否定 綿棒 救済 口紅 歌詞 朗報 批判 法律 探検 簡単 故障 呼吸 貴族 専念 縮尺 糖分 精密 諸悪 国宝 善悪 赤潮 背面 回収 宣伝 貴重 通訳 役割 視線 俳句 視力 遺品 翌日 急激 字幕 磁石 砂糖 腹筋 解除 長針 装置 鋼材 山頂 誤字 自宅 裁判 対策 財宝 女優 深刻 否決 三冊 垂直 群衆 鉄鋼 宣告 県庁 障子 優勝 巻物 食欲 絹糸 警告 操縦 短針 推移 遺産 貯蔵 蒸気 開幕 権利 幼虫 降参 区域 資源 発展 俳優 単純 運賃`;

function currentWordSet(){ const raw=dataset==='g4'?listG4:(dataset==='g45'?(listG4+' '+listG5):(listG4+' '+listG5+' '+listG6)); const tokens=raw.split(/\s+/g).map(s=>s.trim()).filter(Boolean); return uniq(twoCharOnly(tokens)); }

/* Puzzle generator */
function buildPuzzlePool(words){
  const pairs=words.map(w=>[w[0],w[1]]);
  const byPrefix=new Map(), bySuffix=new Map(), centersAll=new Set();
  for(const [a,b] of pairs){ if(!byPrefix.has(a)) byPrefix.set(a,new Set()); if(!bySuffix.has(b)) bySuffix.set(b,new Set()); byPrefix.get(a).add(b); bySuffix.get(b).add(a); centersAll.add(a); centersAll.add(b); }
  const prefixOf=new Map(), suffixOf=new Map();
  for(const [p,setC] of byPrefix){ for(const c of setC){ if(!prefixOf.has(c)) prefixOf.set(c,new Set()); prefixOf.get(c).add(p);} }
  for(const [s,setC] of bySuffix){ for(const c of setC){ if(!suffixOf.has(c)) suffixOf.set(c,new Set()); suffixOf.get(c).add(s);} }
  const puzzles=[];
  for(const c of centersAll){
    const P=[...(prefixOf.get(c)||[])], S=[...(suffixOf.get(c)||[])];
    if(P.length<2||S.length<2) continue;
    for(let i=0;i<P.length;i++)for(let j=i+1;j<P.length;j++)for(let k=0;k<S.length;k++)for(let l=k+1;l<S.length;l++){
      const A=P[i],B=P[j],X=S[k],Y=S[l];
      const inter=intersect([byPrefix.get(A),byPrefix.get(B),bySuffix.get(X),bySuffix.get(Y)]);
      if(inter.size===0) continue;
      const sides=['top','left','right','bottom'];
      const prefixSides=shuffle(sides.slice()).slice(0,2);
      const dir={top:'suffix',left:'suffix',right:'suffix',bottom:'suffix'}; for(const s of prefixSides) dir[s]='prefix';
      const chars={}; let pi=0,si=0; for(const s of sides){ if(dir[s]==='prefix'){ chars[s]=[A,B][pi++]; } else { chars[s]=[X,Y][si++]; } }
      puzzles.push({chars,dir,allowedCenters:[...inter]});
    }
  }
  return puzzles;
}
function intersect(sets){ let r=new Set(sets[0]); for(let i=1;i<sets.length;i++){ const n=new Set(); for(const v of r){ if(sets[i].has(v)) n.add(v);} r=n;} return r; }

/* Flow */
let poolBuilt=false;
function buildPool(){
  const words=currentWordSet();
  const raw=buildPuzzlePool(words);
  const uniqMap=new Map();
  for(const p of raw){ p.key=puzzleKey(p); if(!uniqMap.has(p.key)) uniqMap.set(p.key,p); }
  pool=[...uniqMap.values()];
  usedKeys=new Set(); queue=shuffle(pool.slice());
  $('#poolInfo').textContent=`問題数：${pool.length}問`; poolBuilt=true;
  if(pool.length===0){ $('#result').innerHTML=`<span class="ng">問題が作れませんでした。</span>`; }
}

/* ← ここが重要：どこからでも安全にメニューへ戻す */
function navigateToMenu(){
  clearTimers(); clearNext();
  try{ $('#modal').classList.remove('show'); modalOpen=false; }catch(_){}
  try{ $('#celeModal').classList.remove('show'); }catch(_){}
  try{ $('#endModal').classList.remove('show'); }catch(_){}
  $('#result').textContent=''; $('#hint').textContent='';
  $('#game').classList.add('hidden'); $('#menu').classList.remove('hidden');
}

/* 旧 showMenu と互換にしておく */
function showMenu(){ navigateToMenu(); }
function showGame(){ $('#menu').classList.add('hidden'); $('#game').classList.remove('hidden'); }

let queueIx=0;
function nextQuestion(){
  clearTimers(); clearNext();
  $('#result').textContent=''; $('#hint').textContent='';
  $('#answer').value=''; $('#answer').disabled=(mode==='2p');
  resetLockouts();
  if(!poolBuilt) buildPool();

  if(queue.length===0){
    const remaining=pool.filter(p=>!usedKeys.has(p.key));
    const source=remaining.length>0?remaining:pool;
    if(remaining.length===0) usedKeys.clear();
    queue=shuffle(source.slice());
  }
  let picked=null;
  while(queue.length && !picked){ const cand=queue.pop(); if(!usedKeys.has(cand.key)) picked=cand; }
  if(!picked){ usedKeys.clear(); queue=shuffle(pool.slice()); picked=queue.pop(); }
  current=picked; usedKeys.add(current.key);

  $('#topK').textContent=current.chars.top; $('#leftK').textContent=current.chars.left; $('#rightK').textContent=current.chars.right; $('#bottomK').textContent=current.chars.bottom;
  setArrows(current.dir,false);
  $('#mTop').textContent=current.chars.top; $('#mLeft').textContent=current.chars.left; $('#mRight').textContent=current.chars.right; $('#mBottom').textContent=current.chars.bottom;
  setArrows(current.dir,true);

  const two=(mode==='2p');
  $('#buzzLeft').style.display=two?'flex':'none';
  $('#buzzRight').style.display=two?'flex':'none';
  $('#crownBar').style.display=two?'flex':'none';
  if(mode==='1p'){ $('#answer').focus(); }
  if(two){ showHint(`${twoP.p1Name}は[F] ／ ${twoP.p2Name}は[J]`); twoP.buzzer=null; }
  updatePlayerBadges();
}
function setArrows(dir, mini){
  const top = mini?'mArrTop':'arrTop', bottom=mini?'mArrBottom':'arrBottom', left=mini?'mArrLeft':'arrLeft', right=mini?'mArrRight':'arrRight';
  $('#'+top).textContent = dir.top==='prefix'?'↓':'↑';
  $('#'+bottom).textContent = dir.bottom==='prefix'?'↑':'↓';
  $('#'+left).textContent = dir.left==='prefix'?'→':'←';
  $('#'+right).textContent = dir.right==='prefix'?'←':'→';
}

/* Lockout helpers */
function now(){ return Date.now(); }
function isLocked(p){ return now()<(twoP.lockoutUntil[p]||0); }
function setLockout(p){ const until=now()+20000; twoP.lockoutUntil[p]=until; if(twoP.lockTimeouts[p]) clearTimeout(twoP.lockTimeouts[p]); twoP.lockTimeouts[p]=setTimeout(()=>clearLockout(p), until-now()); startLockTicker(); }
function clearLockout(p){ twoP.lockoutUntil[p]=0; if(twoP.lockTimeouts[p]){ clearTimeout(twoP.lockTimeouts[p]); twoP.lockTimeouts[p]=null; } if((twoP.lockoutUntil[1]||0)==0 && (twoP.lockoutUntil[2]||0)==0) stopLockTicker(); showHint(''); }
function resetLockouts(){ clearLockout(1); clearLockout(2); }
function lockStatusText(){ const l1=Math.max(0,Math.ceil((twoP.lockoutUntil[1]-now())/1000)); const l2=Math.max(0,Math.ceil((twoP.lockoutUntil[2]-now())/1000)); const a=isLocked(1)?`P1ロック${l1}秒`:''; const b=isLocked(2)?`P2ロック${l2}秒`:''; return [a,b].filter(Boolean).join(' / '); }
function startLockTicker(){ if(twoP.lockTicker) return; twoP.lockTicker=setInterval(()=>{ if(!isLocked(1)&&!isLocked(2)){ stopLockTicker(); return; } showHint(''); },500); }
function stopLockTicker(){ if(twoP.lockTicker){ clearInterval(twoP.lockTicker); twoP.lockTicker=null; } }

/* 1P */
function check1P(){
  const a=$('#answer').value.trim();
  if(!KANJI.test(a)){ paintResult(`<span class="ng">中央に<strong>漢字1文字</strong>を入れてね。</span>`); return; }
  oneP.total++;
  if(current.allowedCenters.includes(a)){ oneP.correct++; oneP.streak++; celebrate('せいかい！','その調子！'); setTimeout(nextQuestion, AUTO_DELAY+700); }
  else{ oneP.streak=0; paintResult(`<span class="ng">ざんねん…</span> 答え：${current.allowedCenters.join(' / ')}`); setTimeout(nextQuestion, AUTO_DELAY+300); }
  updateScoreView();
}
function paintResult(html){ $('#result').innerHTML=html; }
function showHint(t){ const s=lockStatusText(); $('#hint').textContent=(t||'')+(s?`（${s}）`:``); }

/* 2P */
function openModal(player){
  modalOpen=true; document.body.style.overflow='hidden';
  $('#modalTitle').textContent=`${player===1?twoP.p1Name:twoP.p2Name} の解答`;
  $('#modalHint').textContent=''; $('#modal').classList.add('show');
  $('#buzzAnswer').value=''; $('#buzzAnswer').focus();
  twoP.timeLeft=BUZZ_TIME; updateTimerUI(twoP.timeLeft, BUZZ_TIME);
  clearTimers();
  twoP.timerId=setInterval(()=>{ twoP.timeLeft--; updateTimerUI(twoP.timeLeft, BUZZ_TIME); if(twoP.timeLeft<=0){ clearTimers(); closeModal(); } },1000);
}
function updateTimerUI(left,total){ $('#timerBadge').textContent=`残り ${left} 秒`; $('#timerBadge').classList.toggle('warn', left<=3); $('#progressFill').style.width=`${((total-left)/total)*100}%`; }
function closeModal(silent=false){
  modalOpen=false; $('#modal').classList.remove('show'); document.body.style.overflow='';
  if(!silent && twoP.buzzer){ const wrong=twoP.buzzer; twoP.buzzer=null; setLockout(wrong); const other=wrong===1?2:1; showHint(`${other===1?twoP.p1Name:twoP.p2Name} チャンス！（${other===1?'F':'J'}）`); }
}
function onBuzz(player){ if(mode!=='2p'||twoP.buzzer) return; if(isLocked(player)){ showHint(`${player===1?twoP.p1Name:twoP.p2Name} はロック中`); return; } try{playBuzz();}catch(_){ } twoP.buzzer=player; openModal(player); }
function addPoint(player){
  if(player===1) twoP.p1++; else twoP.p2++;
  updateScoreView(); updatePlayerBadges();
  if(twoP.p1>=twoP.target || twoP.p2>=twoP.target){
    const w=twoP.p1>twoP.p2?1:2; const winnerName=w===1?twoP.p1Name:twoP.p2Name;
    celebrate(`${winnerName} の勝ち！`,`堂々のフィニッシュ！`); setTimeout(()=>openEndDialog(winnerName),950); return;
  }
  celebrate(`${player===1?twoP.p1Name:twoP.p2Name} 正解！`,`ナイス判断！`); setTimeout(nextQuestion, AUTO_DELAY+700);
}
function check2P(){
  if(!twoP.buzzer){ paintResult(`<span class="ng">まず早押し（F/J か ボタン）してね</span>`); return; }
  const a=$('#buzzAnswer').value.trim(); if(!KANJI.test(a)){ $('#modalHint').textContent='中央に漢字1文字を入力してね'; return; }
  const buzzer=twoP.buzzer, other=buzzer===1?2:1;
  clearTimers(); closeModal(true); twoP.buzzer=null;
  if(current.allowedCenters.includes(a)){ addPoint(buzzer); clearLockout(other); }
  else{ paintResult(`<span class="ng">不正解…</span> 答え：${current.allowedCenters.join(' / ')}`); setLockout(buzzer); clearLockout(other); showHint(`${other===1?twoP.p1Name:twoP.p2Name} チャンス！（${other===1?'F':'J'}）`); }
}

/* 表示 */
function updatePlayerBadges(){
  $('#p1NameView').textContent=twoP.p1Name; $('#p2NameView').textContent=twoP.p2Name;
  $('#p1Crowns').textContent= twoP.p1 ? '👑'.repeat(twoP.p1) : '—';
  $('#p2Crowns').textContent= twoP.p2 ? '👑'.repeat(twoP.p2) : '—';
  $('#p1Nums').textContent=`${twoP.p1} / ${twoP.target}`; $('#p2Nums').textContent=`${twoP.p2} / ${twoP.target}`;
  $('#buzzLeft').innerHTML=`P1<br><small>早押し！</small>`; $('#buzzRight').innerHTML=`P2<br><small>早押し！</small>`;
}
function updateScoreView(){
  if(mode==='1p'){
    $('#scoreArea').innerHTML=`<span class="badge">正解 ${oneP.correct}/${oneP.total}</span><span class="badge">連続 ${oneP.streak}</span>`;
  }else{
    $('#scoreArea').innerHTML=`<span class="badge">${twoP.p1Name}: ${twoP.p1} 点</span><span class="badge">${twoP.p2Name}: ${twoP.p2} 点</span><span class="badge">先取 ${twoP.target}</span><span class="badge">キー: ${twoP.p1Name}=<span class="kbd">F</span> / ${twoP.p2Name}=<span class="kbd">J</span></span>`;
  }
  $('#infoMode').textContent=mode==='1p'?'1人モード':'2人モード（早押し）';
  $('#infoDataset').textContent=dataset==='g4'?'四年のみ':(dataset==='g45'?'四＋五':'四＋五＋六');
}

/* 終了ダイアログ */
function openEndDialog(winner){ $('#endWinner').textContent=winner||'P1'; $('#endModal').classList.add('show'); }
function closeEndDialog(){ $('#endModal').classList.remove('show'); }
function restartMatch(){ closeEndDialog(); twoP.p1=0; twoP.p2=0; twoP.buzzer=null; resetLockouts(); updateScoreView(); updatePlayerBadges(); usedKeys.clear(); queue=shuffle(pool.slice()); nextQuestion(); }

/* Start */
function startFromMenu(){
  try{ ensureAudio(); }catch(_){ }
  mode=document.querySelector('input[name="modePick"]:checked').value;
  dataset=$('#dataset').value;
  const n1=($('#p1NameInput').value||'').trim()||'P1';
  const n2=($('#p2NameInput').value||'').trim()||'P2';
  const tgt=Math.max(1,Math.min(10,parseInt($('#targetPoints').value||'2',10)));
  twoP={p1:0,p2:0,p1Name:n1,p2Name:n2,target:tgt,buzzer:null,timeLeft:0,timerId:null,lockoutUntil:{1:0,2:0},lockTimeouts:{1:null,2:null},lockTicker:null};
  oneP={total:0,correct:0,streak:0};
  poolBuilt=false; usedKeys.clear(); queue=[];
  buildPool(); updateScoreView(); showGame(); nextQuestion();
}

/* ===== Confirm Back（共通） ===== */
function openConfirmBack(){ $('#confirmBack').classList.add('show'); }
function closeConfirmBack(){ $('#confirmBack').classList.remove('show'); }

/* ===== Events ===== */
$('#startBtn').addEventListener('click', startFromMenu);

/* 最初に戻る（ヘッダー） -> カスタム確認 */
$('#backToMenu').addEventListener('click', openConfirmBack);
/* 終了モーダルの「最初に戻る」も同じ導線に統一 */
$('#toMenuBtn').addEventListener('click', openConfirmBack);
/* 確認モーダルのボタン */
$('#confirmBackYes').addEventListener('click', ()=>{ closeConfirmBack(); navigateToMenu(); });
$('#confirmBackNo').addEventListener('click', closeConfirmBack);

$('#checkBtn').addEventListener('click', ()=>{ mode==='1p'?check1P():check2P(); });
$('#showBtn').addEventListener('click', ()=>{ paintResult(`<span class="ok">答え：</span>${current?current.allowedCenters.join(' / '):''}`); showHint('5秒後に次の問題へ'); scheduleNext(5000); });
$('#buzzLeft').addEventListener('click', ()=>onBuzz(1));
$('#buzzRight').addEventListener('click', ()=>onBuzz(2));
$('#modalClose').addEventListener('click', ()=>closeModal());
$('#buzzCheckBtn').addEventListener('click', check2P);
$('#againBtn').addEventListener('click', restartMatch);

document.querySelectorAll('input[name="modePick"]').forEach(r=>{
  r.addEventListener('change', ()=>{ const two=document.querySelector('input[name="modePick"][value="2p"]').checked; $('#twoConfig').style.display=two?'flex':'none'; });
});
$('#twoConfig').style.display=document.querySelector('input[name="modePick"][value="2p"]').checked?'flex':'none';

document.addEventListener('keydown', (e)=>{
  if($('#game').classList.contains('hidden')) return;
  if(e.key==='Enter'){ if(mode==='1p') check1P(); else if(modalOpen) check2P(); }
  if(mode==='2p' && !modalOpen){ if(e.key.toLowerCase()==='f') onBuzz(1); if(e.key.toLowerCase()==='j') onBuzz(2); }
});

/* 初期はメニュー */
navigateToMenu();

/* Self Tests: ?test=1 */
(function runSelfTests(){
  const params=new URLSearchParams(location.search); if(!params.has('test')) return;
  console.group('%cSelf Tests','color:#2563eb;font-weight:bold');
  try{
    console.assert(typeof navigateToMenu==='function','navigateToMenu exists');
    const dir={top:'prefix',bottom:'suffix',left:'prefix',right:'suffix'};
    setArrows(dir,false);
    console.assert($('#arrTop').textContent==='↓' && $('#arrBottom').textContent==='↓' && $('#arrLeft').textContent==='→' && $('#arrRight').textContent==='→','arrows ok');
    const smallPool=buildPuzzlePool(['友達','配達','達成','発達']); console.assert(Array.isArray(smallPool)&&smallPool.length>0,'pool ok');
  }catch(e){ console.error(e); }finally{ console.groupEnd(); }
})();
</script>
</body>
</html>
