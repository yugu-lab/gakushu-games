<!-- /kanji-quiz.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æ¼¢å­—ç©´åŸ‹ã‚ã‚¯ã‚¤ã‚º</title>
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root{ --bg1:#b8e8ff; --bg2:#e7d5ff; --ink:#0b1324; --muted:#5b6b8a; --accent:#ffd166; --accent-deep:#f3b43a; --pink:#ff9ecd; --pink-deep:#e488b9; --arrow:#3b82f6; --ok:#12b886; --ng:#ef4444; --panel:#ffffff; }
  *{ box-sizing:border-box; }
  body{
    margin:0; color:var(--ink);
    font-family:"M PLUS Rounded 1c","Hiragino Maru Gothic ProN","Yu Gothic UI","Hiragino Sans","Noto Sans JP",system-ui,sans-serif;
    min-height:100svh; display:grid; place-items:center; padding:18px;
    background: radial-gradient(1400px 700px at 0% -10%, var(--bg1), transparent),
               radial-gradient(1200px 600px at 100% 0%, var(--bg2), #f7f9ff);
  }
  .app{ width:min(1180px,100%); }
  h1{ margin:0 0 14px; font-size:clamp(22px,3.8vw,32px); font-weight:900; letter-spacing:.02em; }
  .panel{ background:var(--panel); border:3px solid #edf0f7; border-radius:22px; padding:18px; box-shadow:0 10px 0 #e6e9f5; }
  button,select,input{ border:none; border-radius:14px; padding:10px 14px; font-weight:900; }
  button{ cursor:pointer; }
  .primary{ background:var(--accent); color:#3b2b00; box-shadow:0 8px 0 var(--accent-deep); }
  .ghost{ background:#eef2ff; box-shadow:0 8px 0 #cbd5ff; }
  .pink{ background:linear-gradient(#ffd3e7,#ffb2d8); color:#3b1230; box-shadow:0 10px 0 var(--pink-deep); border:3px solid #ffd5e7; }
  .badge{ background:#fff; border:2px solid #e9ecff; padding:6px 12px; border-radius:999px; font-weight:900; }
  .kbd{ font-family:ui-monospace,monospace; background:#1111; padding:2px 6px; border-radius:8px; border:1px solid #0001;}
  .row{ display:flex; gap:16px; flex-wrap:wrap; }
  .hidden{ display:none !important; }
  .tiny{ font-size:12px; color:var(--muted); }
  :focus-visible{ outline:3px solid #6366f1; outline-offset:3px; }

  /* ===== MENUï¼ˆãƒ«ãƒ¼ãƒ«ã‚’åºƒãï¼‰ ===== */
  #menu .grid{ display:grid; gap:22px; }
  #menu h2{ margin:6px 0 8px; font-size:18px; }
  #menu .line{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  #twoConfig{ display:none; gap:10px; align-items:flex-end; }
  #twoConfig input[type="text"]{ width:10em; background:#fff; border:2px solid #e8ecf7; }
  #targetPoints{ width:6em; text-align:center; background:#fff; border:2px solid #e8ecf7; }
  .ruleWrap{ border:2px dashed #dbe4ff; border-radius:18px; padding:18px; background:#fbfdff; }
  .ruleGrid{ display:grid; gap:18px; grid-template-columns:minmax(320px,1fr) minmax(360px,1.2fr); align-items:center; }
  .demoBoard{ position:relative; width:min(360px,38vw); aspect-ratio:1/1; border-radius:20px; background:#fff; box-shadow:inset 0 0 0 4px #e3e9ff; margin:auto; }
  .demoCell{ position:absolute; display:grid; place-items:center; font-weight:900; font-size:clamp(24px,2.6vw,34px); }
  .demoCell.t{ inset:auto 0 76% 0; } .demoCell.b{ inset:76% 0 auto 0; } .demoCell.l{ inset:0 auto 0 8%; top:50%; transform:translateY(-50%);} .demoCell.r{ inset:0 8% 0 auto; top:50%; transform:translateY(-50%); }
  .demoCenterWrap{ position:absolute; inset:0; margin:auto; width:36%; aspect-ratio:1/1; }
  .demoCenter{ position:absolute; inset:0; margin:auto; border-radius:16px; background:#f2f6ff; box-shadow:inset 0 0 0 4px #c7d2fe; display:grid; place-items:center; font-size:20px; }
  .demoArrow{ position:absolute; width:38px; height:38px; border-radius:999px; background:var(--arrow); color:#fff; display:grid; place-items:center; font-size:18px; text-shadow:0 2px 0 #0002; box-shadow:0 6px 0 #0001, inset 0 -4px 0 #0002; }
  .demoArrow.t{ left:50%; top:12px; transform:translate(-50%,0); }
  .demoArrow.b{ left:50%; bottom:12px; transform:translate(-50%,0); }
  .demoArrow.l{ left:12px; top:50%; transform:translate(0,-50%); }
  .demoArrow.r{ right:12px; top:50%; transform:translate(0,-50%); }

  .howto h3{ margin:.2em 0 .6em; font-size:18px; }
  .howto p{ margin:.3em 0; }
  .chip{ display:inline-block; background:#fff; border:2px solid #e7ecff; border-radius:999px; padding:6px 10px; margin:2px 6px 2px 0; font-weight:900; }
  .legend{ display:grid; grid-template-columns:110px 1fr; align-items:center; gap:8px; margin:.4em 0; }
  .legend .kbd{ text-align:center; min-width:84px; }
  .legend small{ color:var(--muted); }

  /* ===== GAME ===== */
  #gameHeader{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-bottom:12px; }
  #scoreArea{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .stage{ display:grid; place-items:center; gap:10px; padding:12px; }
  .playArea{ position:relative; width:min(1100px,96vw); min-height:720px; display:flex; justify-content:center; align-items:center; padding-bottom:120px; }
  .board{ position:relative; width:min(560px,64%); aspect-ratio:1/1; border-radius:28px; background:radial-gradient(200px 140px at 30% 20%, #fff8, transparent), #fff; box-shadow:inset 0 0 0 4px #e8ecf7, 0 14px 0 #e6e9f5; }
  .cell{ position:absolute; display:grid; place-items:center; font-weight:900; font-size:clamp(30px,6.2vw,46px); color:#0e1726; user-select:none; text-shadow:0 2px 0 #dfe7ff; }
  .cell.top{ inset:auto 0 79% 0; } .cell.bottom{ inset:79% 0 auto 0; } .cell.left{ inset:0 auto 0 9%; top:50%; transform:translateY(-50%); } .cell.right{ inset:0 9% 0 auto; top:50%; transform:translateY(-50%); }
  .centerWrap{ position:absolute; inset:0; margin:auto; width:34%; aspect-ratio:1/1; display:block; }
  .centerBox{ position:absolute; inset:0; margin:auto; width:100%; height:100%; border-radius:20px; background:#f9fbff; box-shadow:inset 0 0 0 4px #c7d2fe; display:grid; place-items:center; }
  .centerInput{ width:2.2em; text-align:center; font-size:clamp(24px,5vw,34px); padding:6px 8px; border-radius:14px; border:3px solid #94a3b8; background:#fff; position:relative; z-index:3; }
  .arrowBubble{ position:absolute; width:44px; height:44px; border-radius:999px; display:grid; place-items:center; font-size:24px; color:#fff; background:var(--arrow); text-shadow:0 2px 0 #0002; box-shadow:0 6px 0 #0001, inset 0 -4px 0 #0002; z-index:2; pointer-events:none; }
  .arrowBubble.top{ left:50%; top:8px; transform:translate(-50%,0); }
  .arrowBubble.bottom{ left:50%; bottom:8px; transform:translate(-50%,0); }
  .arrowBubble.left{ left:8px; top:50%; transform:translate(0,-50%); }
  .arrowBubble.right{ right:8px; top:50%; transform:translate(0,-50%); }

  .buzzBtn{ position:absolute; top:50%; transform:translateY(-50%); width:200px; height:260px; border-radius:26px; display:flex; align-items:center; justify-content:center; gap:6px; font-weight:900; font-size:24px; color:#0f172a; text-align:center; }
  .buzzBtn.left{ left:10px; } .buzzBtn.right{ right:10px; } .buzzBtn small{ display:block; font-size:14px; color:#3c2a32; }

  .crownBar{ position:absolute; left:0; right:0; bottom:12px; display:flex; justify-content:space-between; align-items:flex-end; padding:0 10px; }
  .crownCard{ width:200px; min-height:86px; text-align:center; font-weight:900; color:#0f172a; background:#ffffffd9; border:2px solid #e8ecff; border-radius:18px; box-shadow:0 8px 0 #dfe5ff; padding:8px 10px; }
  .crownCard .name{ font-size:16px; margin-bottom:4px; }
  .crownCard .crowns{ font-size:22px; line-height:1.1; }
  .crownCard .nums{ font-size:12px; color:var(--muted); }

  .result{ font-weight:900; font-size:18px; min-height:1.6em; }
  .ok{ color:var(--ok); } .ng{ color:var(--ng); }

  /* ===== æ—©æŠ¼ã—ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
  .modal{ position:fixed; inset:0; background:#0006; display:none; align-items:center; justify-content:center; z-index:50; }
  .modal.show{ display:flex; }
  .modalCard{ width:min(700px,95vw); background:linear-gradient(#fff,#f8fbff); border-radius:24px; padding:18px; box-shadow:0 24px 80px #0005; border:3px solid #edf0f7; position:relative; }
  .modalHead{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:6px; }
  .tag{ background:#eef2ff; border:2px solid #cbd5ff; border-radius:999px; padding:6px 12px; font-weight:900; }
  .closeBtn{ border:none; background:#eef2ff; border-radius:12px; padding:8px 12px; font-weight:900; cursor:pointer; }
  .timerWrap{ position:absolute; left:50%; transform:translateX(-50%); top:-16px; display:flex; flex-direction:column; align-items:center; gap:6px; }
  .timerBadge{ background:#111; color:#fff; border-radius:999px; padding:6px 14px; font-weight:900; letter-spacing:.03em; box-shadow:0 6px 0 #0003; }
  .timerBadge.warn{ background:#ef4444; }
  .progressTrack{ width:min(480px,82vw); height:10px; background:#e9eefc; border-radius:999px; overflow:hidden; border:2px solid #dbe3ff; }
  .progressFill{ height:100%; width:0%; background:linear-gradient(90deg,#60a5fa,#93c5fd); }
  .miniWrap{ position:relative; margin:22px auto 8px; width:min(520px,92%); aspect-ratio:1/1; }
  .miniWrap .centerWrap{ width:50%; }
  .miniWrap .arrowBubble{ width:58px; height:58px; font-size:26px; }
  .miniWrap .cell{ font-size:clamp(26px,6vw,48px); }
  .ansRow{ display:flex; gap:10px; align-items:center; justify-content:center; margin-top:10px; }
  .modalHint{ text-align:center; color:var(--muted); }

  /* ===== æ­£è§£ãƒãƒƒãƒ— ===== */
  .celeModal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:#0005; z-index:70; }
  .celeModal.show{ display:flex; }
  .celeCard{ background:linear-gradient(#fff,#f7fbff); padding:26px 24px; border-radius:26px; border:4px solid #e8edff; box-shadow:0 24px 80px #0005; text-align:center; width:min(560px,92vw); }
  .celeTitle{ font-size:clamp(28px,6vw,40px); font-weight:900; margin:0 0 6px; color:#0e1726; }
  .celeSub{ color:#475569; margin:0 0 10px; }
  .celeEmo{ font-size:42px; }
  .confetti{ position:fixed; pointer-events:none; animation:fall .9s ease-out forwards; font-size:24px; }
  @keyframes fall{ to{ transform:translateY(80vh) rotate(360deg); opacity:0; } }

  /* ===== çµ‚äº†ãƒ€ã‚¤ã‚¢ãƒ­ã‚° ===== */
  .endModal{ position:fixed; inset:0; background:#0006; display:none; align-items:center; justify-content:center; z-index:80; }
  .endModal.show{ display:flex; }
  .endCard{ width:min(560px,92vw); background:linear-gradient(#fff,#f7fbff); border-radius:26px; border:4px solid #e8edff; box-shadow:0 24px 80px #0005; text-align:center; padding:22px 20px; }
  .endTitle{ font-weight:900; font-size:clamp(22px,4.8vw,30px); margin:0 0 6px; }
  .endSub{ color:#475569; margin:0 0 14px; }
  .endActions{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }

  /* ===== æˆ»ã‚‹ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæœ€å‰é¢ï¼‰ ===== */
  .confirmBack{ position:fixed; inset:0; background:#0006; display:none; align-items:center; justify-content:center; z-index:120; }
  .confirmBack.show{ display:flex; }
  .confirmCard{ width:min(520px,92vw); background:linear-gradient(#fff,#f7fbff); border-radius:22px; border:3px solid #e8edff; box-shadow:0 24px 80px #0005; padding:18px; text-align:center; }
  .confirmTitle{ font-weight:900; font-size:clamp(18px,4.2vw,22px); margin:0 0 8px; }
  .confirmMsg{ color:#475569; margin:0 0 14px; }
  .confirmActions{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
  @media (max-width:780px){ .ruleGrid{ grid-template-columns:1fr; } .playArea{ min-height:780px; padding-bottom:160px; } .buzzBtn{ width:80%; height:96px; left:50%; transform:translate(-50%,0); } .buzzBtn.left{ top:6%; } .buzzBtn.right{ bottom:6%; top:auto; } .board{ width:86%; } .crownBar{ bottom:10px; } .crownCard{ width:48%; } }
</style>
</head>
<body>
<div class="app">
  <h1>æ¼¢å­—ç©´åŸ‹ã‚ã‚¯ã‚¤ã‚º</h1>

  <!-- ===== MENU ===== -->
  <div id="menu" class="panel">
    <div class="grid">
      <section>
        <h2>ãƒ«ãƒ¼ãƒ«</h2>
        <div class="ruleWrap">
          <div class="ruleGrid">
            <div class="demoBoard" aria-hidden="true">
              <div class="demoCell t">å‹</div><div class="demoCell b">ç™º</div><div class="demoCell l">é…</div><div class="demoCell r">æˆ</div>
              <div class="demoCenterWrap">
                <div class="demoCenter">â–¡</div>
                <div class="demoArrow t">â†“</div><div class="demoArrow b">â†‘</div><div class="demoArrow l">â†’</div><div class="demoArrow r">â†’</div>
              </div>
            </div>
            <div class="howto">
              <h3>ã‚ãã³ã‹ãŸ</h3>
              <p>ä¸­å¤®ã®â–¡ã«<strong>åŒã˜ä¸€æ–‡å­—</strong>ã‚’å…¥ã‚Œã¦ã€å››æ–¹å‘ã®<strong>äºŒå­—ç†Ÿèª</strong>ã‚’å®Œæˆã•ã›ã‚ˆã†ã€‚</p>
              <div class="legend">
                <span class="kbd">â†’</span><div>å·¦ã®æ¼¢å­—ï¼‹ä¸­å¤®</div>
                <span class="kbd">â†’</span><div>ä¸­å¤®ï¼‹å³ã®æ¼¢å­—</div>
                <span class="kbd">â†‘</span><div>ä¸‹ã®æ¼¢å­—ï¼‹ä¸­å¤®</div>
                <span class="kbd">â†“</span><div>ä¸Šã®æ¼¢å­—ï¼‹ä¸­å¤®</div>
              </div>
              <p class="tiny">ä¾‹ï¼šä¸­å¤®ãŒ<strong>ã€Œé”ã€</strong>ã ã¨ <span class="chip">å‹é”</span><span class="chip">é…é”</span><span class="chip">é”æˆ</span><span class="chip">ç™ºé”</span></p>
              <ul>
                <li>1äººãƒ¢ãƒ¼ãƒ‰ï¼šEnterã§åˆ¤å®šã€‚</li>
                <li>2äººãƒ¢ãƒ¼ãƒ‰ï¼šP1=Fï¼P2=Jï¼ˆã¾ãŸã¯ãƒœã‚¿ãƒ³ï¼‰ã€‚å‹è€…å…ˆå–ã€‚</li>
              </ul>
            </div>
          </div>
        </div>
      </section>

      <section>
        <h2>ãƒ¢ãƒ¼ãƒ‰ãƒ»è¨­å®š</h2>
        <div class="line">
          <strong>ãƒ¢ãƒ¼ãƒ‰</strong>
          <label><input type="radio" name="modePick" value="1p" checked> 1äººãƒ¢ãƒ¼ãƒ‰</label>
          <label><input type="radio" name="modePick" value="2p"> 2äººãƒ¢ãƒ¼ãƒ‰ï¼ˆæ—©æŠ¼ã—ï¼‰</label>
        </div>
        <div id="twoConfig" class="line">
          <div><div class="tiny">P1 ã®ãªã¾ãˆ</div><input id="p1NameInput" type="text" placeholder="P1" /></div>
          <div><div class="tiny">P2 ã®ãªã¾ãˆ</div><input id="p2NameInput" type="text" placeholder="P2" /></div>
          <div><div class="tiny">å…ˆå–ãƒã‚¤ãƒ³ãƒˆ</div><input id="targetPoints" type="number" min="1" max="10" value="2" /></div>
          <div class="tiny">ã‚­ãƒ¼æ“ä½œï¼šP1=<span class="kbd">F</span>ï¼P2=<span class="kbd">J</span></div>
        </div>
        <div class="line">
          <strong>å‡ºé¡Œç¯„å›²</strong>
          <select id="dataset">
            <option value="g4">å››å¹´ã®ã¿</option>
            <option value="g45">å››å¹´ï¼‹äº”å¹´</option>
            <option value="g456" selected>å››å¹´ï¼‹äº”å¹´ï¼‹å…­å¹´</option>
          </select>
        </div>
        <div><button id="startBtn" class="primary" type="button">ã‚²ãƒ¼ãƒ é–‹å§‹</button></div>
      </section>
    </div>
  </div>

  <!-- ===== GAME ===== -->
  <div id="game" class="hidden">
    <div id="gameHeader">
      <div id="scoreArea"></div>
      <div class="tiny">
        <span id="infoMode" class="badge"></span>
        <span id="infoDataset" class="badge"></span>
        <button id="backToMenu" class="ghost" type="button">æœ€åˆã«æˆ»ã‚‹</button>
      </div>
    </div>

    <div class="panel" id="playPanel">
      <strong>ãƒ—ãƒ¬ã‚¤</strong>
      <div class="stage">
        <div class="playArea">
          <button class="buzzBtn left pink" id="buzzLeft" type="button" aria-label="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1 æ—©æŠ¼ã—">P1<br><small>æ—©æŠ¼ã—ï¼</small></button>
          <div class="board" id="board" aria-live="polite">
            <div class="cell top" id="topK">ç©º</div>
            <div class="cell bottom" id="bottomK">ç¾</div>
            <div class="cell left" id="leftK">æ­£</div>
            <div class="cell right" id="rightK">ä¸­</div>
            <div class="centerWrap">
              <div class="centerBox"><input id="answer" class="centerInput" maxlength="1" inputmode="text" autocomplete="off" aria-label="ä¸­å¤®ã®æ¼¢å­—ã‚’å…¥åŠ›" /></div>
              <div class="arrowBubble top" id="arrTop">â†“</div>
              <div class="arrowBubble bottom" id="arrBottom">â†‘</div>
              <div class="arrowBubble left" id="arrLeft">â†’</div>
              <div class="arrowBubble right" id="arrRight">â†</div>
            </div>
          </div>
          <button class="buzzBtn right pink" id="buzzRight" type="button" aria-label="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2 æ—©æŠ¼ã—">P2<br><small>æ—©æŠ¼ã—ï¼</small></button>
          <div class="crownBar" id="crownBar">
            <div class="crownCard" id="p1Score"><div class="name" id="p1NameView">P1</div><div class="crowns" id="p1Crowns">â€”</div><div class="nums tiny" id="p1Nums"></div></div>
            <div class="crownCard" id="p2Score"><div class="name" id="p2NameView">P2</div><div class="crowns" id="p2Crowns">â€”</div><div class="nums tiny" id="p2Nums"></div></div>
          </div>
        </div>

        <div class="row" style="gap:10px; align-items:center; justify-content:center;">
          <button id="checkBtn" class="primary" type="button">åˆ¤å®š</button>
          <button id="showBtn" class="ghost" type="button">ç­”ãˆã‚’è¦‹ã‚‹</button>
          <label class="tiny"><input type="checkbox" id="autoNext" checked disabled> å¸¸ã«æ¬¡ã®å•é¡Œã¸ï¼ˆå›ºå®šï¼‰</label>
          <span id="poolInfo" class="tiny"></span>
        </div>

        <div class="result" id="result"></div>
        <div class="tiny" id="hint"></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== æ—©æŠ¼ã—ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
<div class="modal" id="modal" aria-modal="true" role="dialog">
  <div class="modalCard">
    <div class="modalHead">
      <div class="tag" id="modalTitle">P1 ã®è§£ç­”</div>
      <button class="closeBtn" id="modalClose" type="button">é–‰ã˜ã‚‹</button>
    </div>
    <div class="timerWrap" aria-live="polite" aria-atomic="true">
      <div class="timerBadge" id="timerBadge">æ®‹ã‚Š 12 ç§’</div>
      <div class="progressTrack"><div class="progressFill" id="progressFill"></div></div>
    </div>
    <div class="miniWrap">
      <div class="centerWrap">
        <div class="centerBox"><input id="buzzAnswer" class="centerInput" maxlength="1" inputmode="text" autocomplete="off" aria-label="ä¸­å¤®ã®æ¼¢å­—ã‚’å…¥åŠ›ï¼ˆæ—©æŠ¼ã—ï¼‰" /></div>
        <div class="arrowBubble top" id="mArrTop">â†“</div>
        <div class="arrowBubble bottom" id="mArrBottom">â†‘</div>
        <div class="arrowBubble left" id="mArrLeft">â†’</div>
        <div class="arrowBubble right" id="mArrRight">â†</div>
      </div>
      <div class="cell top" id="mTop" style="inset:auto 0 79% 0;"></div>
      <div class="cell bottom" id="mBottom" style="inset:79% 0 auto 0;"></div>
      <div class="cell left" id="mLeft" style="inset:0 auto 0 9%; top:50%; transform:translateY(-50%);"></div>
      <div class="cell right" id="mRight" style="inset:0 9% 0 auto; top:50%; transform:translateY(-50%);"></div>
    </div>
    <div class="ansRow"><button id="buzzCheckBtn" class="primary" type="button">åˆ¤å®š</button></div>
    <div class="modalHint tiny" id="modalHint"></div>
  </div>
</div>

<!-- ===== æ­£è§£ãƒãƒƒãƒ— ===== -->
<div class="celeModal" id="celeModal" aria-hidden="true">
  <div class="celeCard">
    <div class="celeEmo">ğŸ‰âœ¨ğŸŒŸ</div>
    <h3 class="celeTitle" id="celeTitle">ã›ã„ã‹ã„ï¼</h3>
    <p class="celeSub" id="celeSub">ã¨ã£ã¦ã‚‚ã„ã„ã²ã‚‰ã‚ãï¼ã¤ãã‚‚ã„ã£ã¡ã‚ƒãŠã†ï¼</p>
  </div>
</div>

<!-- ===== å¯¾æˆ¦çµ‚äº†ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
<div class="endModal" id="endModal" aria-modal="true" role="dialog">
  <div class="endCard">
    <div style="font-size:38px">ğŸğŸ‘‘</div>
    <h3 class="endTitle"><span id="endWinner">P1</span> ã®å‹ã¡ï¼</h3>
    <p class="endSub">ã‚‚ã†ä¸€åº¦å‹è² ã™ã‚‹ï¼Ÿãã‚Œã¨ã‚‚æœ€åˆã«æˆ»ã‚‹ï¼Ÿ</p>
    <div class="endActions">
      <button id="againBtn" class="primary" type="button">ã‚‚ã†ä¸€åº¦ã‚„ã‚‹</button>
      <button id="toMenuBtn" class="ghost" type="button">æœ€åˆã«æˆ»ã‚‹</button>
    </div>
  </div>
</div>

<!-- ===== æˆ»ã‚‹ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚«ã‚¹ã‚¿ãƒ ï¼‰ ===== -->
<div class="confirmBack" id="confirmBack" aria-modal="true" role="dialog">
  <div class="confirmCard">
    <h3 class="confirmTitle">æœ€åˆã«æˆ»ã‚‹</h3>
    <p class="confirmMsg">æœ¬å½“ã«æœ€åˆã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿãƒ—ãƒ¬ã‚¤ä¸­ã®é€²è¡Œã¯ã‚¯ãƒªã‚¢ã•ã‚Œã¾ã™ã€‚</p>
    <div class="confirmActions">
      <button id="confirmBackYes" class="primary" type="button">ã¯ã„</button>
      <button id="confirmBackNo" class="ghost" type="button">ã„ã„ãˆ</button>
    </div>
  </div>
</div>

<script>
/* ===== Utilities & Globals ===== */
const $ = (q)=>document.querySelector(q);
function shuffle(arr){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]];} return a; }
const uniq=(arr)=>[...new Set(arr)];
const twoCharOnly=(tokens)=>tokens.filter(w=>w.length===2 && /^[\u4E00-\u9FFF]{2}$/.test(w));

let pool=[], queue=[], current=null;
let mode='1p', dataset='g456';
let oneP={total:0, correct:0, streak:0};
let twoP={ p1:0, p2:0, p1Name:'P1', p2Name:'P2', target:2, buzzer:null, timeLeft:0, timerId:null,
           lockoutUntil:{1:0,2:0}, lockTimeouts:{1:null,2:null}, lockTicker:null };
const AUTO_DELAY=900, BUZZ_TIME=12;
let modalOpen=false;
let usedKeys=new Set();
const KANJI=/^[\u4E00-\u9FFF]$/;

/* è‡ªå‹•é·ç§»ï¼ˆç­”ãˆè¡¨ç¤ºâ†’æ¬¡å•é¡Œï¼‰ */
let nextTimer=null;
function clearNext(){ if(nextTimer){ clearTimeout(nextTimer); nextTimer=null; } }
function scheduleNext(ms){ clearNext(); nextTimer=setTimeout(()=>{ nextTimer=null; nextQuestion(); }, ms); }

/* é€²è¡Œã‚¿ã‚¤ãƒãƒ¼ï¼ˆæ—©æŠ¼ã—ï¼‰ */
function clearTimers(){ if(twoP && twoP.timerId){ clearInterval(twoP.timerId); twoP.timerId=null; } }

/* Audio */
let audioCtx=null;
function ensureAudio(){ const AC=window.AudioContext||window.webkitAudioContext; if(!audioCtx&&AC){ audioCtx=new AC(); } if(audioCtx&&audioCtx.state==='suspended'){ audioCtx.resume(); } return audioCtx; }
function _tone(f=880, dur=0.15, type='sine', gain=0.08, t0){ const ctx=ensureAudio(); if(!ctx) return; const osc=ctx.createOscillator(); const g=ctx.createGain(); const start=t0??ctx.currentTime; osc.type=type; osc.frequency.setValueAtTime(f,start); g.gain.setValueAtTime(0.0001,start); g.gain.linearRampToValueAtTime(gain,start+0.01); g.gain.exponentialRampToValueAtTime(0.0001,start+dur); osc.connect(g).connect(ctx.destination); osc.start(start); osc.stop(start+dur+0.02); }
function playPinpon(){ try{const t=ensureAudio()?.currentTime??0; _tone(880,0.12,'sine',0.09,t); _tone(1174.66,0.16,'sine',0.09,t+0.14);}catch(_){ } }
function playBuzz(){ try{ const ctx=ensureAudio(); if(!ctx) return; const t=ctx.currentTime; const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='square'; o.frequency.setValueAtTime(800,t); o.frequency.exponentialRampToValueAtTime(220,t+0.25); g.gain.setValueAtTime(0.0001,t); g.gain.linearRampToValueAtTime(0.08,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+0.32); o.connect(g).connect(ctx.destination); o.start(t); o.stop(t+0.35);}catch(_){ } }

/* Celebrate */
function celebrate(title, sub){ try{playPinpon();}catch(_){ } const modal=$('#celeModal'); $('#celeTitle').textContent=title||'ã›ã„ã‹ã„ï¼'; $('#celeSub').textContent=sub||'ã‚ˆãæ°—ã¥ã„ãŸã­ï¼'; modal?.classList.add('show'); fireConfetti(); setTimeout(()=>modal?.classList.remove('show'),900); }
function fireConfetti(){ const em=['ğŸ‰','âœ¨','ğŸˆ','â­ï¸','ğŸ­','ğŸŠ','ğŸ’«','ğŸ‘']; for(let i=0;i<22;i++){ const s=document.createElement('div'); s.className='confetti'; s.textContent=em[(Math.random()*em.length)|0]; s.style.left=(8+Math.random()*84)+'vw'; s.style.top='-10vh'; document.body.appendChild(s); setTimeout(()=>s.remove(),900); } }

/* Helpers */
function puzzleKey(p){ const d=p.dir; return `${p.chars.top}|${p.chars.left}|${p.chars.right}|${p.chars.bottom}|${d.top[0]}${d.left[0]}${d.right[0]}${d.bottom[0]}`; }

/* Word lists (çœç•¥ãªã—ãƒ»åŸæ–‡é€šã‚Š) */
const listG4=`å…‰æ „ èª¬æ•™ ä¼è¨€ ä¼šè²» å—ä»˜ å…±é€š å…¨æ²» æ™‚å·® ç‰§å ´ èµ¤é£¯ æ°´å®³ æµ·è» åŠ é€Ÿ æœå®Ÿ å±±è„ˆ æ„›ç”¨ å¥½ç‰© å”åŠ› é †ç•ª å…¥éšŠ é–¢é€£ æ®‹é«˜ è‹±å›½ è‰¯å¥½ ç†±æ„ é”æˆ æ¶ˆæ¯’ æ¡ˆå†… è‹±èª å¤«äºº æ–°èŠ½ ä¾‹å¹´ æ‰‹é¡ å¤§é™¸ åœé›» ä½œæ³• è‹¦æˆ¦ å¿ƒå¾— æ¢…é…’ å¤§å‹ èƒƒè…¸ ç„¡å®Ÿ é¸æŒ™ æ‘æ°‘ é£Ÿå ‚ æ¸…æµ è©¦é¨“ å»ºç‰© æ®ºæ°— å¤å­£ ç”Ÿå¾’ æœ€åˆ æ„›èª­ å·ä»¤ æŠ•ç¥¨ æ”¾ç½® æ¼æ¸¯ è©¦åˆ æˆé•· å¤‰è‰² åŠ´åƒ æ¨™é«˜ åœè»Š é‡è¦ ç‰¹è‰² æœ€å¤§ ç™ºé” å¾—ç‚¹ ä¸€å…† å¥åº· ç”£åœ° åº•è¾º å‚è¦³ æ°‘å®¶ æœªå®š å…µéšŠ è¦ç‚¹ æ®‹æš‘ æœ‰åˆ© ç”³å‘Š å¤§é‡ æœ€æ‚ª æ©Ÿæ¢° éŸ³é‡ å‹æ•— çµæœ« ä¸å®‰ å‘¨å›² å¸ä¼š å¾—æ„ å·£ç®± æ›²èŠ¸ è²¯é‡‘ ä½ç½® ç¥ç¦ å¸ä»¤ çµæŸ ä¿¡å¿µ ä½œæˆ¦ å€‰åº« ä½“é¨“ æœ€å¾Œ æ—¥èª² æœ€è¿‘ å®Œæˆ æ•™å®˜ å‘¨è¾º æ”¹è‰¯ è‹¦åŠ´ äººé¡ è‚²å… æ¬ å¸­ æº€å“¡ ç›®å° å˜ä½ ä»¥å†… ç›®æ¨™ ç®¡ç† å®Œæ²» å¯¾è±¡ å—æ¥µ å…ç«¥ æ˜¨å¹´ åŒ—æ¥µ æµ´å®¤ å‚åŠ  æ™¯å“ å–æ è‡ªä¿¡ æˆåŠŸ è‰¯è–¬ å’æ¥­ åŒ…å¸¯ ç­†é † å…µå£« æ‰‹èŠ¸ å­£ç¯€ æˆæœ é¸æ‰‹ å›ºå½¢ ä»˜éŒ² å¤•é£¯ è»éšŠ çµ¦æ²¹ ç™ºèŠ½ åæœ­ å˜èª é…é” å‹‡æ°— é¢¨æ™¯ åŠ ç†± æ¨™èª æœ­æŸ è‡ªç„¶ æ¬ èˆª å´è»¢ åºƒå‘Š éƒ¡éƒ¨ ç²‰æœ« é æµ… å‡ºè²» ä¸–å¸¯ å‹ç´™ ç²‰é›ª åŠ å·¥ æœ‰æ–™ å¥½æ„Ÿ æ¶ˆè²» æ–™ç† ä¸–ç´€ é£›è¡Œ ç¶šå‡º ç›´å¾„ å…±ç”¨ å®Œå…¨ èˆªè·¯ ä¿¡ç”¨ æ°—è±¡ æ¬ ç‚¹ å¡©åˆ† æ „å…‰ å·¦æŠ˜ ä¾¿åˆ© æ„›çŠ¬ å¸Œæœ› æ–°å‹ é †ä½ é™¸è» æ¾æ— ç´„æŸ ç«¶äº‰ å„è‡ª é€šä¿¡ ç¯€é›» å¯ŸçŸ¥ ç¯€ç´„ æº€ç‚¹ æ–‡è„ˆ è¾å…¸ åæ¡ˆ é–¢ä¿‚ æˆ¦äº‰ å·¦å´ æ€¥å¤‰ é€£ä¼‘ ç”Ÿç”£ èª¬æ˜ è¡£é¡ ç«¶è¼ª é“é † å½“ç„¶ è¨“ç·´ åçœ åºœç«‹ ä»²é–“ é–¢å¿ƒ æˆåˆ† ç«¶é¦¬ ç¬‘é¡” åˆ†åˆ¥ çµ¦é£Ÿ é€£ç¶š è¨˜éŒ² é¢ç© æœªçŸ¥ åœæ­¢ è¦æ±‚ å¹´è¼ª æ­´ä»£ ä¾‹é¡Œ æœ¨æ æœªæ¥ è²¨ç‰© é”äºº è­°é¡Œ åˆ©ç”¨ æŒ™æ‰‹ å…†å€™ å‘½ä»¤ åŠ å…¥ å‹‡è€… åŠå¾„ é‡èœ å¸­é † ç¨®é¡ å¤±æ•— æ®‹å¿µ æ¶ˆå° æ–¹æ³• å°è±¡ ä¿¡å· å†·é™ å…¬å®³ è¡£æœ è¦³å¯Ÿ å°åŒ… æ°—å€™ ä¼èª¬ é›»ç¯ å­å­« è¡—ç¯ ç„¡äº‹ å¾’æ­© é£Ÿå™¨ ä¼šè­° è¦³å…‰ é‡‘è²¨ ç„¡æ–™ é–‹ç¥¨ ä¼‘é¤Š æ­´å² å›½æ°‘ ç¯å° æ˜¨å¤œ ä¼è¨˜ å¿…è¦ æ°´è¾º å®Ÿé¨“ é–€æ¾ è»æ‰‹ æ•£æ­© å›½æ—— ç†±å¿ƒ å·¥å¤« å‘Šç™º å¤±æ˜ åº•åŠ› å›½ç”£ æœ€æ–° æ°´ä½ åŠªåŠ› å°èª¬ çµæœ ä»¥å¤– ä¼ç¥¨ ç‰§è‰ å¡©å®³ æ¥½å™¨ å††å‘¨ æ¬ å ´ å¤§è‡£ å‡ºå¸­ æ³•äº‹ æœ¬å ‚ æœ€é«˜ æ°å å°åˆ· è¦³å®¢ å…‰æ™¯ æ „é¤Š å¤©ç„¶ æº€é–‹ å€Ÿé‡‘ è³é‡‘ å¹´æœ« æ™¯æ°— éŒ²ç”» ç«¶æ³³ é¡˜æœ› åŠ›å£« å…±æ„Ÿ è¿½åŠ  ç‰¹è¨“ è€äºº æ¼èˆ¹ å‹é” ç¥æ—¥ ææ–™ ä½œæˆ éŒ²éŸ³ åŠå‘¨ å¿µé¡˜ å…µå™¨ å¤‰åŒ– ç‰¹é¸ è¾æ›¸`;
const listG5=`æ‚ªå¤¢ è¨¼è¨€ æ•´å‚™ æŒ‡ç¤º å¤«å©¦ æ±ºæ–­ è£½ä½œ åˆæ ¼ å¯¾å¿œ ä»¶æ•° ç¿’æ…£ é‡‘é¡ åˆ©ç›Š ç§»å‹• ç”¨ä»¶ çµ±è¨ˆ å¤•åˆŠ éŸ³ç¨‹ æŠ€è¡“ æ–‡å¥ æ”¿æ²» ç‚­é‰± ç¥–å…ˆ ä»æ•™ æ¡ç”¨ ç¾åœ¨ è²¡å¸ƒ æè±† ç•™å­¦ é©åº¦ æ‰“ç ´ å¢—åŠ  è±Šä½œ è¦‹è§£ ç´ æ è¡¨ç¤º æ”¹ä¿® æ‹›é›† ç«ç½ ä¿ç®¡ é ˜åœŸ æ„å¿— è·äºº å›£ä½“ ç§»ä½ æ—§å‹ æ­£ç¢º è¡¨æƒ… æ¶²ä½“ å€‹äºº æå‡º ç¾©ç† é€†è»¢ é³¥å±… éŠ­æ¹¯ åŸºæº– æ•…æ„ åŠ¹èƒ½ æ¸›é€Ÿ æ•™å¸« æ©äºº çŠ¯ç½ª å®¶è²¡ ç ´æ ç¢ºä¿ æ²³å£ è‚¥æº€ æ¨™æº– èªå¥ çµ¶å¯¾ è²¬ä»» æ²³å· æ§‹æˆ ç¾çŠ¶ è³‡æ ¼ ç‰©è³‡ çœç•¥ æ°´è³ª äº‹æƒ… ææ¡ˆ è¨¼æ˜ åˆ¤æ–­ å‹¢åŠ› å¿µä» é…¸ç´  åˆ‡æ–­ ç‰ˆç”» æš´åŠ› ç±³ä¿µ è²¿æ˜“ è¿·å­ è­·è¡› æ­¦å™¨ äº‹æ•… é“å¾³ æ„›æƒ… å€‹ä½“ ä¾¡æ ¼ æ¼”èª¬ é é‡‘ å¿«å‹ ç¨é‡‘ å¾€å¹´ æ§‹å›³ æƒ…å ± ç¶šç·¨ çŸ¥è­˜ ç¢ºå®Ÿ æ€§è³ª æ¸›å°‘ ä¿è­· å®Ÿç¾ å¾©æ´» è¬ç½ª é›»åœ§ çš„ç¢º è¨­å‚™ å°éŠ­ æ°¸é  å†ä¼š ä»æ§˜ èˆˆå‘³ è¤‡é›‘ ç½å®³ å®Ÿéš› å¼·æ•µ æ–°å±… ä¸­æ–­ çµŒé¨“ åŒ»å¸« é©å½“ æ‰èƒ½ äºˆé˜² å¿«é© å€ç‡ é€†å¢ƒ ç¢ºå®š æ¥­ç¸¾ çŠ¶æ…‹ è³›æˆ æœåˆŠ æš´é¢¨ å¿«å¾© è£½å“ å‹å›  æˆ¦ç•¥ ç†è§£ ç²¾ç±³ é€€é™¢ ä¼çµ± æ…‹åº¦ ä¸»å©¦ æ¤œæŸ» éå¸¸ æ¸…æ½” æ··é›‘ åŠ¹æœ å°å…¥ è§£ç¦ ç‹¬å­¦ åŸå›  é…¸å‘³ è¬›ç¿’ æå®³ è¤‡å†™ æ–­æ°´ å»ºç¯‰ è©•ä¾¡ æ ¼å®‰ ä»®è¨­ è§£æ±º éŠ…åƒ æ”¯åº— å¾©èˆˆ ä½å±… è·æ¥­ ä½™è¨ˆ å¤¢ä¸­ ç¾©å‹™ ç•¥èª çŠ¯è¡Œ å ±å‘Š ç‰¹è¨± æ¡ä»¶ å¾€å¾© åœŸä¿µ åºæ–‡ ç”»åƒ ç«¶æŠ€ äººæƒ… ä¸»å¼µ è¿°èª è¨­ç½® èª¿æŸ» å†…å®¹ é›‘è‰ å›å¾© åˆ¤å®š åŒå±… å¼•é€€ ç²¾ç¥ è¾²è€• æ‰¿çŸ¥ ç¾å ´ çµ„ç¹” æ€§æ ¼ é‹å‹¢ çµ¶è³› è‚¥æ–™ äºˆæ¸¬ çœ¼ç§‘ å¹¹äº‹ æ¯”ç‡ ç‰›èˆ é˜²æ­¢ æ—¥ç¨‹ çµŒå–¶ ç„¡ç›Š æ ¡èˆ é †åº å¾©ç¿’ çŠ¯äºº ä»®èª¬ æ•—å›  æ¡ç‚¹ ç¢ºç‡ å›£çµ æ¥è¿‘ è¼¸é€ å¸¸è­˜ æ‰€å± æ²¹æ–­ æ¡å– æ³•å‰‡ æ°—åœ§ æ¥ç¶š å°æ å‡ç­‰ è¼¸å…¥ æˆæ¥­ æº–å‚™ å®¹å™¨ è¦åˆ¶ ç¾åƒ è¤‡æ•° ç‚¹æ¤œ è¦é ˜ å¢—ç¯‰ è¬›å¸« è±Šå¯Œ é˜²çŠ¯ äº‹ä»¶ å€‹åˆ¥ å¢“åœ° æ€¥å¢— è¡€åœ§ ç¾åœ° çµŒé é™ç•Œ æƒ…ç†± æ„Ÿè¬ æ–°ç¯‰ æç¤º å¦»å­ è‚‰çœ¼ é‡‘éŠ­ åå‰‡ éå» ä½™åˆ† è²¡æ”¿ å®Ÿç¸¾ å…ˆç¥– è³‡æ–™ æå¾— è­·é€ äº‹æ…‹ æ¸¬å®š åœ¨åº« ç·¨é›† è©•åˆ¤ å¼å½“ è¨˜è¿° ç­”å¼ ç‹¬ç‰¹ ç¦ç‰© å®¹æ˜“ çµŒè·¯ è§£æ•£ å¤©æ•µ ä¿®ç† åå¿œ é©æ­£ å®Ÿåœ¨ è³ªå• æˆç¸¾ è¨±å¯ æƒ³åƒ æ­¦è¡“ æ—§å¼ ç¥–çˆ¶`;
const listG6=`æœæ™© å…¨å·» å¯¸æ³• å¿ å®Ÿ é«˜å±¤ å°‚ç”¨ æ•…éƒ· æ¨¡æ§˜ æ†²æ³• æ¼”å¥ å¥®ç™º ä¾¡å€¤ æ‹…å½“ åè«– éºéª¨ æ„Ÿæ¿€ ç´…è‘‰ è£è¡¨ å‹¤å‹™ å³é‡ åé›† å¯¸æ–­ æ•¬èª è¡£è£… ä¸»å°† è£œè¶³ ç ´ç‰‡ çš‡å±… ä»Šæ™© ç©€ç‰© å€¤æ®µ ç‚¹å‘¼ æ¨ç† ç™ºæ® é‡é‡‘ è­¦å‚™ åºèˆ å‡¦åˆ† èª¿å¾‹ æ¨¡å‹ è¦å¾‹ æ‚ªå…š é›»æº åº¦èƒ¸ åˆ†æ‹… ç°è‰² éª¨æŠ˜ æ ¹æº å¾“æ¥ ç©´å ´ è‹¥æ‰‹ ç¿Œé€± æ³¨å°„ æ•£ä¹± æº€æ½® è«¸å›½ ç¸®å° èª å®Ÿ è³ƒé‡‘ å®ç‰© ç ‚å ´ å¿ƒè‡“ å±é™º è‘—è€… å®çŸ³ ç¿Œæœ é¦–è„³ åŠç†Ÿ å¿…è‡³ å»¶ç„¼ é¦–ç­‹ çœ‹æ¿ åå…¥ è­°è«– è¦–ç‚¹ èªæº è‡³æ€¥ å®—æ´¾ éšæ®µ ç§èª åœ§ç¸® æ´¾æ‰‹ æ··ä¹± å›°é›£ æ˜¨æ™© å¹²æ½® ç„¡è¦– ç•°å¸¸ é›£æ°‘ ç†Ÿèª ç°¡æ½” æ¨æ¸¬ å¸å ç§˜è”µ æ¤œè¨ æ‹¡å¤§ ç´”ç™½ èª•ç”Ÿ çŸ³æ®µ å°±ä»» è–æ›¸ æä¾› ä¸€æ ª åœ°å±¤ åœ°åŸŸ å‚·å£ æ‹…ä»» æœè£… å®¹å§¿ æ¨¹ç«‹ æšæ•° æ˜ ç”» ç ‚é‡‘ éé›£ è¿”æ¸ˆ æ¨©é™ ä»æ„› çª“å£ èª æ„ ç­é•· èˆˆå¥® æ‹è¦‹ éŸ³åŸŸ ç‰‡æ–¹ å®—æ•™ ç­‹è‚‰ æ™‚åˆ» è¦æ¨¡ å°†è» é©å‘½ çš‡å®¤ é‰„æ£’ æœ—èª­ å¿ å‘Š ä»ç¾© æ¸©æš– è­¦ç¬› ç¿Œå¹´ ç´”é‡‘ é›‘èªŒ æ˜ åƒ é ­ç—› è‡ªå·± ç–‘å• æ”¹è£… çœ‹ç—… èª¤è§£ å¸°å®… æ­¦å°† å»¶æœŸ èƒ¸ä¸­ è¨ªå• ç§˜å¯† æ²¿ç·š äº”å†Š é ­è„³ å®‡å®™ åç´ é™¤å» èƒŒä¸­ çµè«– æ­»äº¡ å§¿å‹¢ æ¨©åŠ› æ“ä½œ ç¢ºèª å†Šå­ æ”¿å…š å°†æ¥ æ²¿å²¸ é ‚ä¸Š è­¦å ± å°Šæ•¬ ç ‚é‰„ ç´…èŒ¶ è…¹ç—› ç‰›ä¹³ å¦å®š ç¶¿æ£’ æ•‘æ¸ˆ å£ç´… æ­Œè© æœ—å ± æ‰¹åˆ¤ æ³•å¾‹ æ¢æ¤œ ç°¡å˜ æ•…éšœ å‘¼å¸ è²´æ— å°‚å¿µ ç¸®å°º ç³–åˆ† ç²¾å¯† è«¸æ‚ª å›½å® å–„æ‚ª èµ¤æ½® èƒŒé¢ å›å å®£ä¼ è²´é‡ é€šè¨³ å½¹å‰² è¦–ç·š ä¿³å¥ è¦–åŠ› éºå“ ç¿Œæ—¥ æ€¥æ¿€ å­—å¹• ç£çŸ³ ç ‚ç³– è…¹ç­‹ è§£é™¤ é•·é‡ è£…ç½® é‹¼æ å±±é ‚ èª¤å­— è‡ªå®… è£åˆ¤ å¯¾ç­– è²¡å® å¥³å„ª æ·±åˆ» å¦æ±º ä¸‰å†Š å‚ç›´ ç¾¤è¡† é‰„é‹¼ å®£å‘Š çœŒåº éšœå­ å„ªå‹ å·»ç‰© é£Ÿæ¬² çµ¹ç³¸ è­¦å‘Š æ“ç¸¦ çŸ­é‡ æ¨ç§» éºç”£ è²¯è”µ è’¸æ°— é–‹å¹• æ¨©åˆ© å¹¼è™« é™å‚ åŒºåŸŸ è³‡æº ç™ºå±• ä¿³å„ª å˜ç´” é‹è³ƒ`;

function currentWordSet(){ const raw=dataset==='g4'?listG4:(dataset==='g45'?(listG4+' '+listG5):(listG4+' '+listG5+' '+listG6)); const tokens=raw.split(/\s+/g).map(s=>s.trim()).filter(Boolean); return uniq(twoCharOnly(tokens)); }

/* Puzzle generator */
function buildPuzzlePool(words){
  const pairs=words.map(w=>[w[0],w[1]]);
  const byPrefix=new Map(), bySuffix=new Map(), centersAll=new Set();
  for(const [a,b] of pairs){ if(!byPrefix.has(a)) byPrefix.set(a,new Set()); if(!bySuffix.has(b)) bySuffix.set(b,new Set()); byPrefix.get(a).add(b); bySuffix.get(b).add(a); centersAll.add(a); centersAll.add(b); }
  const prefixOf=new Map(), suffixOf=new Map();
  for(const [p,setC] of byPrefix){ for(const c of setC){ if(!prefixOf.has(c)) prefixOf.set(c,new Set()); prefixOf.get(c).add(p);} }
  for(const [s,setC] of bySuffix){ for(const c of setC){ if(!suffixOf.has(c)) suffixOf.set(c,new Set()); suffixOf.get(c).add(s);} }
  const puzzles=[];
  for(const c of centersAll){
    const P=[...(prefixOf.get(c)||[])], S=[...(suffixOf.get(c)||[])];
    if(P.length<2||S.length<2) continue;
    for(let i=0;i<P.length;i++)for(let j=i+1;j<P.length;j++)for(let k=0;k<S.length;k++)for(let l=k+1;l<S.length;l++){
      const A=P[i],B=P[j],X=S[k],Y=S[l];
      const inter=intersect([byPrefix.get(A),byPrefix.get(B),bySuffix.get(X),bySuffix.get(Y)]);
      if(inter.size===0) continue;
      const sides=['top','left','right','bottom'];
      const prefixSides=shuffle(sides.slice()).slice(0,2);
      const dir={top:'suffix',left:'suffix',right:'suffix',bottom:'suffix'}; for(const s of prefixSides) dir[s]='prefix';
      const chars={}; let pi=0,si=0; for(const s of sides){ if(dir[s]==='prefix'){ chars[s]=[A,B][pi++]; } else { chars[s]=[X,Y][si++]; } }
      puzzles.push({chars,dir,allowedCenters:[...inter]});
    }
  }
  return puzzles;
}
function intersect(sets){ let r=new Set(sets[0]); for(let i=1;i<sets.length;i++){ const n=new Set(); for(const v of r){ if(sets[i].has(v)) n.add(v);} r=n;} return r; }

/* Flow */
let poolBuilt=false;
function buildPool(){
  const words=currentWordSet();
  const raw=buildPuzzlePool(words);
  const uniqMap=new Map();
  for(const p of raw){ p.key=puzzleKey(p); if(!uniqMap.has(p.key)) uniqMap.set(p.key,p); }
  pool=[...uniqMap.values()];
  usedKeys=new Set(); queue=shuffle(pool.slice());
  $('#poolInfo').textContent=`å•é¡Œæ•°ï¼š${pool.length}å•`; poolBuilt=true;
  if(pool.length===0){ $('#result').innerHTML=`<span class="ng">å•é¡ŒãŒä½œã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚</span>`; }
}

/* â† ã“ã“ãŒé‡è¦ï¼šã©ã“ã‹ã‚‰ã§ã‚‚å®‰å…¨ã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã™ */
function navigateToMenu(){
  clearTimers(); clearNext();
  try{ $('#modal').classList.remove('show'); modalOpen=false; }catch(_){}
  try{ $('#celeModal').classList.remove('show'); }catch(_){}
  try{ $('#endModal').classList.remove('show'); }catch(_){}
  $('#result').textContent=''; $('#hint').textContent='';
  $('#game').classList.add('hidden'); $('#menu').classList.remove('hidden');
}

/* æ—§ showMenu ã¨äº’æ›ã«ã—ã¦ãŠã */
function showMenu(){ navigateToMenu(); }
function showGame(){ $('#menu').classList.add('hidden'); $('#game').classList.remove('hidden'); }

let queueIx=0;
function nextQuestion(){
  clearTimers(); clearNext();
  $('#result').textContent=''; $('#hint').textContent='';
  $('#answer').value=''; $('#answer').disabled=(mode==='2p');
  resetLockouts();
  if(!poolBuilt) buildPool();

  if(queue.length===0){
    const remaining=pool.filter(p=>!usedKeys.has(p.key));
    const source=remaining.length>0?remaining:pool;
    if(remaining.length===0) usedKeys.clear();
    queue=shuffle(source.slice());
  }
  let picked=null;
  while(queue.length && !picked){ const cand=queue.pop(); if(!usedKeys.has(cand.key)) picked=cand; }
  if(!picked){ usedKeys.clear(); queue=shuffle(pool.slice()); picked=queue.pop(); }
  current=picked; usedKeys.add(current.key);

  $('#topK').textContent=current.chars.top; $('#leftK').textContent=current.chars.left; $('#rightK').textContent=current.chars.right; $('#bottomK').textContent=current.chars.bottom;
  setArrows(current.dir,false);
  $('#mTop').textContent=current.chars.top; $('#mLeft').textContent=current.chars.left; $('#mRight').textContent=current.chars.right; $('#mBottom').textContent=current.chars.bottom;
  setArrows(current.dir,true);

  const two=(mode==='2p');
  $('#buzzLeft').style.display=two?'flex':'none';
  $('#buzzRight').style.display=two?'flex':'none';
  $('#crownBar').style.display=two?'flex':'none';
  if(mode==='1p'){ $('#answer').focus(); }
  if(two){ showHint(`${twoP.p1Name}ã¯[F] ï¼ ${twoP.p2Name}ã¯[J]`); twoP.buzzer=null; }
  updatePlayerBadges();
}
function setArrows(dir, mini){
  const top = mini?'mArrTop':'arrTop', bottom=mini?'mArrBottom':'arrBottom', left=mini?'mArrLeft':'arrLeft', right=mini?'mArrRight':'arrRight';
  $('#'+top).textContent = dir.top==='prefix'?'â†“':'â†‘';
  $('#'+bottom).textContent = dir.bottom==='prefix'?'â†‘':'â†“';
  $('#'+left).textContent = dir.left==='prefix'?'â†’':'â†';
  $('#'+right).textContent = dir.right==='prefix'?'â†':'â†’';
}

/* Lockout helpers */
function now(){ return Date.now(); }
function isLocked(p){ return now()<(twoP.lockoutUntil[p]||0); }
function setLockout(p){ const until=now()+20000; twoP.lockoutUntil[p]=until; if(twoP.lockTimeouts[p]) clearTimeout(twoP.lockTimeouts[p]); twoP.lockTimeouts[p]=setTimeout(()=>clearLockout(p), until-now()); startLockTicker(); }
function clearLockout(p){ twoP.lockoutUntil[p]=0; if(twoP.lockTimeouts[p]){ clearTimeout(twoP.lockTimeouts[p]); twoP.lockTimeouts[p]=null; } if((twoP.lockoutUntil[1]||0)==0 && (twoP.lockoutUntil[2]||0)==0) stopLockTicker(); showHint(''); }
function resetLockouts(){ clearLockout(1); clearLockout(2); }
function lockStatusText(){ const l1=Math.max(0,Math.ceil((twoP.lockoutUntil[1]-now())/1000)); const l2=Math.max(0,Math.ceil((twoP.lockoutUntil[2]-now())/1000)); const a=isLocked(1)?`P1ãƒ­ãƒƒã‚¯${l1}ç§’`:''; const b=isLocked(2)?`P2ãƒ­ãƒƒã‚¯${l2}ç§’`:''; return [a,b].filter(Boolean).join(' / '); }
function startLockTicker(){ if(twoP.lockTicker) return; twoP.lockTicker=setInterval(()=>{ if(!isLocked(1)&&!isLocked(2)){ stopLockTicker(); return; } showHint(''); },500); }
function stopLockTicker(){ if(twoP.lockTicker){ clearInterval(twoP.lockTicker); twoP.lockTicker=null; } }

/* 1P */
function check1P(){
  const a=$('#answer').value.trim();
  if(!KANJI.test(a)){ paintResult(`<span class="ng">ä¸­å¤®ã«<strong>æ¼¢å­—1æ–‡å­—</strong>ã‚’å…¥ã‚Œã¦ã­ã€‚</span>`); return; }
  oneP.total++;
  if(current.allowedCenters.includes(a)){ oneP.correct++; oneP.streak++; celebrate('ã›ã„ã‹ã„ï¼','ãã®èª¿å­ï¼'); setTimeout(nextQuestion, AUTO_DELAY+700); }
  else{ oneP.streak=0; paintResult(`<span class="ng">ã–ã‚“ã­ã‚“â€¦</span> ç­”ãˆï¼š${current.allowedCenters.join(' / ')}`); setTimeout(nextQuestion, AUTO_DELAY+300); }
  updateScoreView();
}
function paintResult(html){ $('#result').innerHTML=html; }
function showHint(t){ const s=lockStatusText(); $('#hint').textContent=(t||'')+(s?`ï¼ˆ${s}ï¼‰`:``); }

/* 2P */
function openModal(player){
  modalOpen=true; document.body.style.overflow='hidden';
  $('#modalTitle').textContent=`${player===1?twoP.p1Name:twoP.p2Name} ã®è§£ç­”`;
  $('#modalHint').textContent=''; $('#modal').classList.add('show');
  $('#buzzAnswer').value=''; $('#buzzAnswer').focus();
  twoP.timeLeft=BUZZ_TIME; updateTimerUI(twoP.timeLeft, BUZZ_TIME);
  clearTimers();
  twoP.timerId=setInterval(()=>{ twoP.timeLeft--; updateTimerUI(twoP.timeLeft, BUZZ_TIME); if(twoP.timeLeft<=0){ clearTimers(); closeModal(); } },1000);
}
function updateTimerUI(left,total){ $('#timerBadge').textContent=`æ®‹ã‚Š ${left} ç§’`; $('#timerBadge').classList.toggle('warn', left<=3); $('#progressFill').style.width=`${((total-left)/total)*100}%`; }
function closeModal(silent=false){
  modalOpen=false; $('#modal').classList.remove('show'); document.body.style.overflow='';
  if(!silent && twoP.buzzer){ const wrong=twoP.buzzer; twoP.buzzer=null; setLockout(wrong); const other=wrong===1?2:1; showHint(`${other===1?twoP.p1Name:twoP.p2Name} ãƒãƒ£ãƒ³ã‚¹ï¼ï¼ˆ${other===1?'F':'J'}ï¼‰`); }
}
function onBuzz(player){ if(mode!=='2p'||twoP.buzzer) return; if(isLocked(player)){ showHint(`${player===1?twoP.p1Name:twoP.p2Name} ã¯ãƒ­ãƒƒã‚¯ä¸­`); return; } try{playBuzz();}catch(_){ } twoP.buzzer=player; openModal(player); }
function addPoint(player){
  if(player===1) twoP.p1++; else twoP.p2++;
  updateScoreView(); updatePlayerBadges();
  if(twoP.p1>=twoP.target || twoP.p2>=twoP.target){
    const w=twoP.p1>twoP.p2?1:2; const winnerName=w===1?twoP.p1Name:twoP.p2Name;
    celebrate(`${winnerName} ã®å‹ã¡ï¼`,`å ‚ã€…ã®ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥ï¼`); setTimeout(()=>openEndDialog(winnerName),950); return;
  }
  celebrate(`${player===1?twoP.p1Name:twoP.p2Name} æ­£è§£ï¼`,`ãƒŠã‚¤ã‚¹åˆ¤æ–­ï¼`); setTimeout(nextQuestion, AUTO_DELAY+700);
}
function check2P(){
  if(!twoP.buzzer){ paintResult(`<span class="ng">ã¾ãšæ—©æŠ¼ã—ï¼ˆF/J ã‹ ãƒœã‚¿ãƒ³ï¼‰ã—ã¦ã­</span>`); return; }
  const a=$('#buzzAnswer').value.trim(); if(!KANJI.test(a)){ $('#modalHint').textContent='ä¸­å¤®ã«æ¼¢å­—1æ–‡å­—ã‚’å…¥åŠ›ã—ã¦ã­'; return; }
  const buzzer=twoP.buzzer, other=buzzer===1?2:1;
  clearTimers(); closeModal(true); twoP.buzzer=null;
  if(current.allowedCenters.includes(a)){ addPoint(buzzer); clearLockout(other); }
  else{ paintResult(`<span class="ng">ä¸æ­£è§£â€¦</span> ç­”ãˆï¼š${current.allowedCenters.join(' / ')}`); setLockout(buzzer); clearLockout(other); showHint(`${other===1?twoP.p1Name:twoP.p2Name} ãƒãƒ£ãƒ³ã‚¹ï¼ï¼ˆ${other===1?'F':'J'}ï¼‰`); }
}

/* è¡¨ç¤º */
function updatePlayerBadges(){
  $('#p1NameView').textContent=twoP.p1Name; $('#p2NameView').textContent=twoP.p2Name;
  $('#p1Crowns').textContent= twoP.p1 ? 'ğŸ‘‘'.repeat(twoP.p1) : 'â€”';
  $('#p2Crowns').textContent= twoP.p2 ? 'ğŸ‘‘'.repeat(twoP.p2) : 'â€”';
  $('#p1Nums').textContent=`${twoP.p1} / ${twoP.target}`; $('#p2Nums').textContent=`${twoP.p2} / ${twoP.target}`;
  $('#buzzLeft').innerHTML=`P1<br><small>æ—©æŠ¼ã—ï¼</small>`; $('#buzzRight').innerHTML=`P2<br><small>æ—©æŠ¼ã—ï¼</small>`;
}
function updateScoreView(){
  if(mode==='1p'){
    $('#scoreArea').innerHTML=`<span class="badge">æ­£è§£ ${oneP.correct}/${oneP.total}</span><span class="badge">é€£ç¶š ${oneP.streak}</span>`;
  }else{
    $('#scoreArea').innerHTML=`<span class="badge">${twoP.p1Name}: ${twoP.p1} ç‚¹</span><span class="badge">${twoP.p2Name}: ${twoP.p2} ç‚¹</span><span class="badge">å…ˆå– ${twoP.target}</span><span class="badge">ã‚­ãƒ¼: ${twoP.p1Name}=<span class="kbd">F</span> / ${twoP.p2Name}=<span class="kbd">J</span></span>`;
  }
  $('#infoMode').textContent=mode==='1p'?'1äººãƒ¢ãƒ¼ãƒ‰':'2äººãƒ¢ãƒ¼ãƒ‰ï¼ˆæ—©æŠ¼ã—ï¼‰';
  $('#infoDataset').textContent=dataset==='g4'?'å››å¹´ã®ã¿':(dataset==='g45'?'å››ï¼‹äº”':'å››ï¼‹äº”ï¼‹å…­');
}

/* çµ‚äº†ãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
function openEndDialog(winner){ $('#endWinner').textContent=winner||'P1'; $('#endModal').classList.add('show'); }
function closeEndDialog(){ $('#endModal').classList.remove('show'); }
function restartMatch(){ closeEndDialog(); twoP.p1=0; twoP.p2=0; twoP.buzzer=null; resetLockouts(); updateScoreView(); updatePlayerBadges(); usedKeys.clear(); queue=shuffle(pool.slice()); nextQuestion(); }

/* Start */
function startFromMenu(){
  try{ ensureAudio(); }catch(_){ }
  mode=document.querySelector('input[name="modePick"]:checked').value;
  dataset=$('#dataset').value;
  const n1=($('#p1NameInput').value||'').trim()||'P1';
  const n2=($('#p2NameInput').value||'').trim()||'P2';
  const tgt=Math.max(1,Math.min(10,parseInt($('#targetPoints').value||'2',10)));
  twoP={p1:0,p2:0,p1Name:n1,p2Name:n2,target:tgt,buzzer:null,timeLeft:0,timerId:null,lockoutUntil:{1:0,2:0},lockTimeouts:{1:null,2:null},lockTicker:null};
  oneP={total:0,correct:0,streak:0};
  poolBuilt=false; usedKeys.clear(); queue=[];
  buildPool(); updateScoreView(); showGame(); nextQuestion();
}

/* ===== Confirm Backï¼ˆå…±é€šï¼‰ ===== */
function openConfirmBack(){ $('#confirmBack').classList.add('show'); }
function closeConfirmBack(){ $('#confirmBack').classList.remove('show'); }

/* ===== Events ===== */
$('#startBtn').addEventListener('click', startFromMenu);

/* æœ€åˆã«æˆ»ã‚‹ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰ -> ã‚«ã‚¹ã‚¿ãƒ ç¢ºèª */
$('#backToMenu').addEventListener('click', openConfirmBack);
/* çµ‚äº†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã€Œæœ€åˆã«æˆ»ã‚‹ã€ã‚‚åŒã˜å°ç·šã«çµ±ä¸€ */
$('#toMenuBtn').addEventListener('click', openConfirmBack);
/* ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒœã‚¿ãƒ³ */
$('#confirmBackYes').addEventListener('click', ()=>{ closeConfirmBack(); navigateToMenu(); });
$('#confirmBackNo').addEventListener('click', closeConfirmBack);

$('#checkBtn').addEventListener('click', ()=>{ mode==='1p'?check1P():check2P(); });
$('#showBtn').addEventListener('click', ()=>{ paintResult(`<span class="ok">ç­”ãˆï¼š</span>${current?current.allowedCenters.join(' / '):''}`); showHint('5ç§’å¾Œã«æ¬¡ã®å•é¡Œã¸'); scheduleNext(5000); });
$('#buzzLeft').addEventListener('click', ()=>onBuzz(1));
$('#buzzRight').addEventListener('click', ()=>onBuzz(2));
$('#modalClose').addEventListener('click', ()=>closeModal());
$('#buzzCheckBtn').addEventListener('click', check2P);
$('#againBtn').addEventListener('click', restartMatch);

document.querySelectorAll('input[name="modePick"]').forEach(r=>{
  r.addEventListener('change', ()=>{ const two=document.querySelector('input[name="modePick"][value="2p"]').checked; $('#twoConfig').style.display=two?'flex':'none'; });
});
$('#twoConfig').style.display=document.querySelector('input[name="modePick"][value="2p"]').checked?'flex':'none';

document.addEventListener('keydown', (e)=>{
  if($('#game').classList.contains('hidden')) return;
  if(e.key==='Enter'){ if(mode==='1p') check1P(); else if(modalOpen) check2P(); }
  if(mode==='2p' && !modalOpen){ if(e.key.toLowerCase()==='f') onBuzz(1); if(e.key.toLowerCase()==='j') onBuzz(2); }
});

/* åˆæœŸã¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
navigateToMenu();

/* Self Tests: ?test=1 */
(function runSelfTests(){
  const params=new URLSearchParams(location.search); if(!params.has('test')) return;
  console.group('%cSelf Tests','color:#2563eb;font-weight:bold');
  try{
    console.assert(typeof navigateToMenu==='function','navigateToMenu exists');
    const dir={top:'prefix',bottom:'suffix',left:'prefix',right:'suffix'};
    setArrows(dir,false);
    console.assert($('#arrTop').textContent==='â†“' && $('#arrBottom').textContent==='â†“' && $('#arrLeft').textContent==='â†’' && $('#arrRight').textContent==='â†’','arrows ok');
    const smallPool=buildPuzzlePool(['å‹é”','é…é”','é”æˆ','ç™ºé”']); console.assert(Array.isArray(smallPool)&&smallPool.length>0,'pool ok');
  }catch(e){ console.error(e); }finally{ console.groupEnd(); }
})();
</script>
</body>
</html>
