<!doctype html>
<html lang="ja" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç®—æ•°ã‚«ãƒ¼ãƒˆãƒ¬ãƒ¼ã‚¹</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap');
    * { font-family: 'Zen Maru Gothic', sans-serif; }
    html, body { height: 100%; }
    body { margin: 0; }

    .track-gradient { background: linear-gradient(135deg, #0c1222 0%, #0b1b34 55%, #0d2d55 100%); }

    /* â˜… flexä¾å­˜ã‚’ã‚„ã‚ã¦ã€vhã§ç¢ºå®Ÿã«é«˜ã•ã‚’ä½œã‚‹ï¼ˆã“ã“ãŒä¸€ç•ªå¼·ã„å¯¾ç­–ï¼‰ */
    #game-screen { height: 100vh; }

    #race-view{
      height: calc(100vh - 160px); /* HUD + controls ã®åˆ†ã‚’å¼•ã */
      min-height: 420px;
      position: relative;
      overflow: hidden;
      background: linear-gradient(180deg, #74c0ff 0%, #dff6ff 45%, #84e0a2 45%, #74c08a 100%);
      touch-action: manipulation;
    }

    /* ===== è·¯é¢ï¼ˆçµ¶å¯¾ã«è¦‹ãˆã‚‹ã‚ˆã†ã«ã€å¼·ã‚ã«æãï¼‰ ===== */
    #road-wrap{
      position:absolute;
      inset:0;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      z-index: 20; /* â˜…ç¢ºå®Ÿã«å‰é¢ã¸ */
      pointer-events:none;
    }
    #road{
      width: min(92vw, 820px);
      height: 92%;
      margin-bottom: 12px;
      border-radius: 22px;
      position: relative;
      overflow: hidden;
      background: linear-gradient(to bottom, #666 0%, #555 60%, #6f6f6f 100%);
      box-shadow: 0 25px 90px rgba(0,0,0,0.55);
      outline: 3px solid rgba(255,255,255,0.18); /* â˜…ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šè¦‹ãˆãªã„å•é¡Œã‚’æ½°ã™ */
    }
    /* è·¯è‚© */
    #road::before,#road::after{
      content:"";
      position:absolute; top:0; bottom:0;
      width: 18px;
      background: repeating-linear-gradient(
        to bottom,
        #ffd000 0px, #ffd000 10px,
        #1d1d1d 10px, #1d1d1d 20px
      );
      opacity: 0.98;
    }
    #road::before{ left:0; }
    #road::after{ right:0; }

    /* ã‚»ãƒ³ã‚¿ãƒ¼ãƒ©ã‚¤ãƒ³ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ */
    #centerline{
      position:absolute;
      left: 50%;
      top: -20%;
      width: 10px;
      height: 140%;
      transform: translateX(-50%);
      background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,0.0) 0px,
        rgba(255,255,255,0.0) 16px,
        rgba(255,255,255,0.9) 16px,
        rgba(255,255,255,0.9) 30px,
        rgba(255,255,255,0.0) 30px,
        rgba(255,255,255,0.0) 56px
      );
      filter: drop-shadow(0 0 8px rgba(255,255,255,0.25));
    }
    .lane-guide{
      position:absolute; top:0; bottom:0;
      width: 2px;
      background: rgba(255,255,255,0.22);
    }

    /* ã‚«ãƒ¼ãƒˆ */
    #karts-container{ position:absolute; inset:0; z-index: 30; }
    .kart {
      position:absolute;
      display:flex;
      flex-direction:column;
      align-items:center;
      will-change: transform, left, top;
      user-select:none;
      pointer-events:none;
      filter: drop-shadow(0 12px 12px rgba(0,0,0,0.35));
    }
    .kart-emoji { font-size: 2.4rem; line-height: 1; }
    .kart-label {
      font-size: 0.72rem;
      color: white;
      background: rgba(0,0,0,0.72);
      padding: 2px 6px;
      border-radius: 9999px;
      margin-top: 4px;
      letter-spacing: 0.02em;
    }

    /* é€Ÿåº¦ç·š */
    #speedlines{
      position:absolute; inset:0;
      z-index: 25;
      background: repeating-linear-gradient(115deg, rgba(255,255,255,0.0) 0 22px, rgba(255,255,255,0.12) 22px 24px);
      opacity: 0;
      transition: opacity 120ms linear;
      pointer-events:none;
    }

    /* ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºï¼ˆè¦‹ãˆã‚‹ã“ã¨ãŒæœ€å„ªå…ˆï¼‰ */
    #debug{
      position:absolute; left:10px; bottom:10px;
      z-index: 99;
      background: rgba(0,0,0,0.55);
      color: #fff;
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      line-height: 1.35;
      max-width: min(92vw, 520px);
      pointer-events:none;
      backdrop-filter: blur(4px);
    }

    @keyframes glow {
      0%,100%{ filter: drop-shadow(0 0 10px rgba(255,255,0,0.55)) drop-shadow(0 0 18px rgba(0,255,255,0.35)); }
      50%{ filter: drop-shadow(0 0 16px rgba(255,255,0,0.75)) drop-shadow(0 0 24px rgba(255,0,255,0.35)); }
    }
    .glow { animation: glow 650ms ease-in-out infinite; }

    .press:active{ transform: scale(0.96); }

    /* ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã®èƒŒæ™¯ */
    .glass { background: rgba(255,255,255,0.10); backdrop-filter: blur(10px); }
  </style>
</head>

<body class="h-full overflow-auto">
<div id="app" class="h-full w-full track-gradient text-white">

  <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
  <div id="title-screen" class="h-full flex flex-col items-center justify-center p-4">
    <h1 class="text-4xl md:text-6xl font-black text-yellow-300 mb-3 text-center drop-shadow-lg">
      ğŸï¸ ç®—æ•°ã‚«ãƒ¼ãƒˆãƒ¬ãƒ¼ã‚¹ ğŸï¸
    </h1>
    <p class="text-lg md:text-xl mb-6 text-cyan-200">1å‘¨ã”ã¨ã«ç®—æ•°ï¼ æ­£è§£ã§ãƒ¬ãƒ¼ã‚¹å†é–‹ï¼</p>

    <div class="glass rounded-2xl p-5 mb-5 max-w-md w-full">
      <h2 class="text-xl font-bold mb-3 text-center text-yellow-200">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼</h2>
      <div class="grid grid-cols-4 gap-3 mb-3" id="char-select"></div>
      <p class="text-center text-sm text-gray-200">é¸æŠä¸­: <span id="selected-char" class="text-2xl">ğŸ¥¸</span></p>
    </div>

    <div class="glass rounded-2xl p-5 mb-6 max-w-md w-full">
      <h2 class="text-xl font-bold mb-3 text-center text-pink-200">ã‚«ãƒ¼ãƒˆ</h2>
      <div class="grid grid-cols-4 gap-3 mb-3" id="kart-select"></div>
      <p class="text-center text-sm text-gray-200">é¸æŠä¸­: <span id="selected-kart" class="text-2xl">ğŸ¦</span></p>
    </div>

    <div class="text-center text-sm text-gray-300 mb-4">
      æ“ä½œï¼šâ†‘åŠ é€Ÿ / â†“ãƒ–ãƒ¬ãƒ¼ã‚­ / â†â†’ãƒãƒ³ãƒ‰ãƒ« / Shiftãƒ‰ãƒªãƒ•ãƒˆ / Spaceã‚¢ã‚¤ãƒ†ãƒ 
    </div>

    <button id="start-btn"
      class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white text-2xl font-black py-4 px-12 rounded-full shadow-lg transform hover:scale-105 transition-all press">
      ğŸš€ ãƒ¬ãƒ¼ã‚¹ã‚¹ã‚¿ãƒ¼ãƒˆï¼
    </button>
  </div>

  <!-- ã‚²ãƒ¼ãƒ  -->
  <div id="game-screen" class="hidden flex-col">
    <!-- HUD -->
    <div class="bg-black/80 p-3 flex flex-wrap gap-2 justify-between items-center">
      <div class="text-base md:text-lg font-bold">
        <span class="text-white/60 mr-2">BUILD v3.1</span>
        ğŸ <span id="lap-display">1</span>/<span id="lap-total">10</span>å‘¨
        <span class="mx-2">|</span>
        ğŸ† <span id="position">1</span>ä½/5
      </div>

      <div class="flex flex-wrap gap-3 items-center text-sm md:text-base">
        <div>âš¡ <span id="player-speed">0</span></div>
        <div>ğŸŒ€ ãƒ‰ãƒªãƒ•ãƒˆ: <span id="drift-meter">0</span>%</div>
        <div>ğŸ <span id="item-display">---</span></div>
      </div>
    </div>

    <!-- ãƒ¬ãƒ¼ã‚¹ãƒ“ãƒ¥ãƒ¼ -->
    <div id="race-view">
      <div id="road-wrap">
        <div id="road">
          <div id="centerline"></div>
          <div class="lane-guide" style="left:33.33%;"></div>
          <div class="lane-guide" style="left:66.66%;"></div>
        </div>
      </div>

      <div id="speedlines"></div>
      <div id="karts-container"></div>

      <div id="debug">debugâ€¦</div>
    </div>

    <!-- æ“ä½œ -->
    <div class="bg-black/70 p-3">
      <div class="flex flex-wrap justify-center gap-3 mb-2">
        <button id="btn-left"  class="bg-slate-600 hover:bg-slate-700 px-5 py-2 rounded-lg font-bold press">â¬…ï¸ å·¦</button>
        <button id="btn-accel" class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg font-bold press">â¬†ï¸ ã‚¢ã‚¯ã‚»ãƒ«</button>
        <button id="btn-brake" class="bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg font-bold press">â¬‡ï¸ ãƒ–ãƒ¬ãƒ¼ã‚­</button>
        <button id="btn-right" class="bg-slate-600 hover:bg-slate-700 px-5 py-2 rounded-lg font-bold press">â¡ï¸ å³</button>
        <button id="btn-drift" class="bg-purple-600 hover:bg-purple-700 px-6 py-2 rounded-lg font-bold press">ğŸŒ€ ãƒ‰ãƒªãƒ•ãƒˆ</button>
        <button id="btn-item" class="bg-yellow-500 hover:bg-yellow-600 px-6 py-2 rounded-lg font-bold press">ğŸ¯ ã‚¢ã‚¤ãƒ†ãƒ </button>
      </div>
      <p class="text-center text-xs md:text-sm text-gray-300">
        â€»PCã¯ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ¨å¥¨ï¼šâ†â†’ã§ãƒãƒ³ãƒ‰ãƒ« / Shiftã§ãƒ‰ãƒªãƒ•ãƒˆ / Spaceã§ã‚¢ã‚¤ãƒ†ãƒ 
      </p>
    </div>
  </div>

</div>

<script>
/* ========= åŸºæœ¬ ========= */
const characters = ['ğŸ¥¸','ğŸ¥·ğŸ¿','ğŸ’€','ğŸ’°','ğŸœ','ğŸ°','ğŸ·','ğŸ¦‡'];
const karts      = ['ğŸ¦','ğŸ¦€','ğŸ„','ğŸ–','ğŸ›’','ğŸ“','ğŸœ','ğŸ‡'];
const itemsPool  = ['ğŸŒ','ğŸ„','â­','ğŸ’£','ğŸ¦‘','ğŸª¶','ğŸ¢','ğŸ‘»'];

const titleScreen  = document.getElementById('title-screen');
const gameScreen   = document.getElementById('game-screen');

const kartsContainer = document.getElementById('karts-container');
const centerlineEl   = document.getElementById('centerline');
const roadEl         = document.getElementById('road');
const speedLinesEl   = document.getElementById('speedlines');
const debugEl        = document.getElementById('debug');

const lapDisplay   = document.getElementById('lap-display');
const lapTotalEl   = document.getElementById('lap-total');
const posEl        = document.getElementById('position');
const speedEl      = document.getElementById('player-speed');
const driftMeterEl = document.getElementById('drift-meter');
const itemDisplay  = document.getElementById('item-display');

const gameState = {
  selectedChar: characters[0],
  selectedKart: karts[0],
  totalLaps: 10,
  players: [],
  player: null,
  keys: { up:false, down:false, left:false, right:false, drift:false },
  gameActive: false,
  scrollY: 0
};

const LANES = 3;
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function lerp(a,b,t){ return a + (b-a)*t; }

/* ========= é¸æŠUI ========= */
function initCharacterSelect(){
  const wrap = document.getElementById('char-select');
  wrap.innerHTML = '';
  characters.forEach((ch)=>{
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'text-3xl p-2 rounded-lg bg-white/20 hover:bg-white/40 transition-all hover:scale-110 cursor-pointer';
    btn.textContent = ch;
    if(ch === gameState.selectedChar) btn.classList.add('ring-4','ring-yellow-300');
    btn.addEventListener('click', ()=>{
      gameState.selectedChar = ch;
      document.getElementById('selected-char').textContent = ch;
      document.querySelectorAll('#char-select button').forEach(b=>b.classList.remove('ring-4','ring-yellow-300'));
      btn.classList.add('ring-4','ring-yellow-300');
    });
    wrap.appendChild(btn);
  });
}
function initKartSelect(){
  const wrap = document.getElementById('kart-select');
  wrap.innerHTML = '';
  karts.forEach((k)=>{
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'text-3xl p-2 rounded-lg bg-white/20 hover:bg-white/40 transition-all hover:scale-110 cursor-pointer';
    btn.textContent = k;
    if(k === gameState.selectedKart) btn.classList.add('ring-4','ring-pink-300');
    btn.addEventListener('click', ()=>{
      gameState.selectedKart = k;
      document.getElementById('selected-kart').textContent = k;
      document.querySelectorAll('#kart-select button').forEach(b=>b.classList.remove('ring-4','ring-pink-300'));
      btn.classList.add('ring-4','ring-pink-300');
    });
    wrap.appendChild(btn);
  });
}

/* ========= ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ========= */
class Player {
  constructor(char, kart, isAI=false){
    this.char = char;
    this.kart = kart;
    this.isAI = isAI;
    this.progress = 0;
    this.laps = 0;
    this.speed = isAI ? 4 : 0;
    this.baseMaxSpeed = isAI ? 10.5 : 12.5;
    this.maxSpeed = this.baseMaxSpeed;
    this.accel = isAI ? 7.0 : 8.5;
    this.brakePower = 12.0;
    this.friction = 2.8;
    this.lane = isAI ? (Math.floor(Math.random()*LANES)) : 1;
    this.lanePos = this.lane;
    this.steerSpeed = isAI ? 2.2 : 4.2;
    this.drifting = false;
    this.driftCharge = 0;
    this.currentItem = null;
    this.element = null;
  }

  update(dt){
    if(this.isAI){
      const target = this.baseMaxSpeed * 0.78;
      if(this.speed < target) this.speed += this.accel*dt;
      else this.speed -= this.friction*dt*0.9;
      if(Math.random() < 0.01) this.lane = clamp(this.lane + (Math.random()<0.5?-1:1), 0, LANES-1);
    }else{
      if(gameState.keys.up) this.speed += this.accel*dt;
      if(gameState.keys.down) this.speed -= this.brakePower*dt;
      if(!gameState.keys.up && !gameState.keys.down) this.speed -= this.friction*dt;

      const steering = (gameState.keys.right?1:0) - (gameState.keys.left?1:0);
      if(steering !== 0) this.lane = clamp(this.lane + steering, 0, LANES-1);

      this.driftCharge = gameState.keys.drift ? clamp(this.driftCharge + dt*0.55, 0, 1) : 0;
    }

    this.lanePos = lerp(this.lanePos, this.lane, clamp(dt*this.steerSpeed, 0, 1));
    this.speed = clamp(this.speed, 0, this.maxSpeed);

    this.progress += this.speed * dt;
    if(this.progress >= 100){
      this.progress -= 100;
      this.laps++;
    }
  }

  render(orderIndex){
    if(!this.element){
      this.element = document.createElement('div');
      this.element.className = 'kart';
      if(!this.isAI) this.element.classList.add('glow');
      kartsContainer.appendChild(this.element);
    }

    const view = document.getElementById('race-view').getBoundingClientRect();
    const road = roadEl.getBoundingClientRect();

    // â˜… roadå†…åº§æ¨™ã§å›ºå®šï¼ˆè¦‹ãˆãªã„äº‹æ•…ã‚’é˜²ãï¼‰
    const laneX = lerp(0.25, 0.75, this.lanePos/(LANES-1));
    const x = (road.left - view.left) + road.width * laneX;

    const baseY = this.isAI ? (0.25 + orderIndex*0.10) : 0.84;
    const y = (road.top - view.top) + road.height * clamp(baseY, 0.18, 0.86);

    const scale = this.isAI ? (0.88 - orderIndex*0.05) : 1.12;

    this.element.style.left = x + 'px';
    this.element.style.top  = y + 'px';
    this.element.style.transform = `translate(-50%, -50%) scale(${scale})`;

    this.element.innerHTML = `
      <div class="kart-emoji">${this.kart}</div>
      <div class="kart-label">${this.char} L${this.laps+1}</div>
    `;
  }
}

/* ========= HUD ========= */
function getRanking(){
  return [...gameState.players].sort((a,b)=>{
    if(a.laps !== b.laps) return b.laps - a.laps;
    return b.progress - a.progress;
  });
}
function updateHUD(){
  const ranking = getRanking();
  const myPos = ranking.findIndex(p=>p===gameState.player)+1;
  posEl.textContent = myPos;
  lapTotalEl.textContent = gameState.totalLaps;
  lapDisplay.textContent = clamp(gameState.player.laps+1, 1, gameState.totalLaps);

  const pct = Math.round((gameState.player.speed / gameState.player.maxSpeed) * 100);
  speedEl.textContent = `${pct}%`;
  driftMeterEl.textContent = Math.round(gameState.player.driftCharge*100);

  speedLinesEl.style.opacity = (pct >= 78) ? 0.35 : 0;
  itemDisplay.textContent = gameState.player.currentItem ? gameState.player.currentItem : '---';
}

/* ========= é“ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« ========= */
function updateRoadScroll(dt){
  gameState.scrollY += gameState.player.speed * dt * 260;
  centerlineEl.style.transform = `translateX(-50%) translateY(${gameState.scrollY}px)`;
}

/* ========= ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º ========= */
function updateDebug(){
  const rv = document.getElementById('race-view').getBoundingClientRect();
  const rd = roadEl.getBoundingClientRect();
  debugEl.innerHTML =
    `race-view: ${Math.round(rv.width)}Ã—${Math.round(rv.height)}<br>`+
    `road: ${Math.round(rd.width)}Ã—${Math.round(rd.height)} / top:${Math.round(rd.top)}<br>`+
    `karts: ${kartsContainer.children.length}`;
}

/* ========= ãƒ«ãƒ¼ãƒ— ========= */
let lastT = performance.now();
function loop(now){
  if(!gameState.gameActive) return;
  const dt = clamp((now-lastT)/1000, 0, 0.033);
  lastT = now;

  gameState.players.forEach(p=>p.update(dt));
  updateRoadScroll(dt);

  const ranking = getRanking();
  ranking.forEach((p,idx)=>p.render(idx));
  updateHUD();
  updateDebug();

  requestAnimationFrame(loop);
}

/* ========= é–‹å§‹ ========= */
function startGame(){
  titleScreen.classList.add('hidden');
  gameScreen.classList.remove('hidden');

  kartsContainer.innerHTML = '';
  gameState.players = [];
  gameState.scrollY = 0;

  const human = new Player(gameState.selectedChar, gameState.selectedKart, false);
  gameState.player = human;
  gameState.players.push(human);

  const availC = characters.filter(c=>c!==gameState.selectedChar);
  const availK = karts.filter(k=>k!==gameState.selectedKart);

  for(let i=0;i<4;i++){
    gameState.players.push(new Player(availC[i%availC.length], availK[i%availK.length], true));
  }

  // â˜…ã€Œæœ€åˆã®1å›ã¯å¼·åˆ¶æç”»ã€ã—ã¦ã€è¦‹ãˆãªã„çŠ¶æ…‹ã‚’æ’é™¤
  getRanking().forEach((p,idx)=>p.render(idx));
  updateHUD();
  updateDebug();

  gameState.gameActive = true;
  lastT = performance.now();
  requestAnimationFrame(loop);
}

/* ========= æ“ä½œ ========= */
document.getElementById('start-btn').addEventListener('click', startGame);

document.addEventListener('keydown', (e)=>{
  if(e.key==='ArrowUp')    { e.preventDefault(); gameState.keys.up=true; }
  if(e.key==='ArrowDown')  { e.preventDefault(); gameState.keys.down=true; }
  if(e.key==='ArrowLeft')  { e.preventDefault(); gameState.keys.left=true; }
  if(e.key==='ArrowRight') { e.preventDefault(); gameState.keys.right=true; }
  if(e.key==='Shift')      { e.preventDefault(); gameState.keys.drift=true; }
});
document.addEventListener('keyup', (e)=>{
  if(e.key==='ArrowUp') gameState.keys.up=false;
  if(e.key==='ArrowDown') gameState.keys.down=false;
  if(e.key==='ArrowLeft') gameState.keys.left=false;
  if(e.key==='ArrowRight') gameState.keys.right=false;
  if(e.key==='Shift') gameState.keys.drift=false;
});

function bindHoldPointer(btnId, onDown, onUp){
  const el = document.getElementById(btnId);
  el.addEventListener('pointerdown', (e)=>{ e.preventDefault(); el.setPointerCapture(e.pointerId); onDown(); });
  el.addEventListener('pointerup',   (e)=>{ e.preventDefault(); onUp(); });
  el.addEventListener('pointercancel',(e)=>{ e.preventDefault(); onUp(); });
  el.addEventListener('pointerleave', ()=>{ onUp(); });
}
bindHoldPointer('btn-accel', ()=>gameState.keys.up=true, ()=>gameState.keys.up=false);
bindHoldPointer('btn-brake', ()=>gameState.keys.down=true, ()=>gameState.keys.down=false);
bindHoldPointer('btn-left',  ()=>gameState.keys.left=true, ()=>gameState.keys.left=false);
bindHoldPointer('btn-right', ()=>gameState.keys.right=true, ()=>gameState.keys.right=false);
bindHoldPointer('btn-drift', ()=>gameState.keys.drift=true, ()=>gameState.keys.drift=false);
document.getElementById('btn-item').addEventListener('click', (e)=>{ e.preventDefault(); });

/* åˆæœŸåŒ– */
initCharacterSelect();
initKartSelect();
document.getElementById('selected-char').textContent = gameState.selectedChar;
document.getElementById('selected-kart').textContent = gameState.selectedKart;
</script>

</body>
</html>
