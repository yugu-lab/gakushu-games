<!doctype html>
<html lang="ja" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç®—æ•°ã‚«ãƒ¼ãƒˆãƒ¬ãƒ¼ã‚¹</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap');
    * { font-family: 'Zen Maru Gothic', sans-serif; }
    body { box-sizing: border-box; }

    .track-gradient { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 55%, #0f3460 100%); }

    #race-view{
      background: linear-gradient(180deg, #74c0ff 0%, #dff6ff 45%, #84e0a2 45%, #74c08a 100%);
      position: relative;
      overflow: hidden;
      touch-action: manipulation;
    }

    /* é›²ï¼ˆé›°å›²æ°—ï¼‰ */
    .cloud {
      position:absolute;
      top: 8%;
      width: 150px;
      height: 52px;
      border-radius: 9999px;
      background: rgba(255,255,255,0.65);
      filter: blur(0.5px);
      animation: cloud-move linear infinite;
      pointer-events:none;
    }
    .cloud::before,.cloud::after{
      content:"";
      position:absolute;
      background: rgba(255,255,255,0.65);
      width: 72px; height: 72px;
      border-radius: 9999px;
      top: -22px; left: 22px;
    }
    .cloud::after{ width: 58px; height:58px; top: -12px; left: 76px; }
    @keyframes cloud-move{
      from{ transform: translateX(-240px);}
      to{ transform: translateX(calc(100vw + 240px)); }
    }

    /* ===== è·¯é¢ï¼ˆå®‰å…¨ãª2Dæç”»ï¼‰ ===== */
    #road-wrap{
      position:absolute;
      inset:0;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      pointer-events:none;
      z-index: 2;
    }
    #road{
      width: min(92vw, 760px);
      height: 92%;
      margin-bottom: 12px;
      border-radius: 22px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 25px 80px rgba(0,0,0,0.45);
      background:
        linear-gradient(to bottom, rgba(255,255,255,0.08), rgba(255,255,255,0.00)),
        linear-gradient(to bottom, #5f5f5f 0%, #505050 55%, #6b6b6b 100%);
    }
    /* è·¯è‚© */
    #road::before,#road::after{
      content:"";
      position:absolute; top:0; bottom:0;
      width: 16px;
      background: repeating-linear-gradient(
        to bottom,
        #ffd000 0px, #ffd000 10px,
        #1d1d1d 10px, #1d1d1d 20px
      );
      opacity: 0.95;
    }
    #road::before{ left:0; }
    #road::after{ right:0; }

    /* ã‚»ãƒ³ã‚¿ãƒ¼ãƒ©ã‚¤ãƒ³ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ */
    #centerline{
      position:absolute;
      left: 50%;
      top: -20%;
      width: 10px;
      height: 140%;
      transform: translateX(-50%);
      background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,0.0) 0px,
        rgba(255,255,255,0.0) 16px,
        rgba(255,255,255,0.85) 16px,
        rgba(255,255,255,0.85) 30px,
        rgba(255,255,255,0.0) 30px,
        rgba(255,255,255,0.0) 56px
      );
      filter: drop-shadow(0 0 6px rgba(255,255,255,0.18));
    }

    /* ãƒ¬ãƒ¼ãƒ³ã®è–„ã„ã‚¬ã‚¤ãƒ‰ */
    .lane-guide{
      position:absolute;
      top:0; bottom:0;
      width: 2px;
      background: rgba(255,255,255,0.18);
    }

    /* é€Ÿåº¦ç·š */
    #speedlines{
      position:absolute; inset:0;
      background: repeating-linear-gradient(115deg, rgba(255,255,255,0.0) 0 22px, rgba(255,255,255,0.12) 22px 24px);
      opacity: 0;
      transition: opacity 120ms linear;
      pointer-events:none;
      z-index: 6;
    }

    /* ===== ã‚«ãƒ¼ãƒˆ ===== */
    #karts-container{ position:absolute; inset:0; z-index: 5; }
    .kart {
      position:absolute;
      display:flex;
      flex-direction:column;
      align-items:center;
      will-change: transform, left, top;
      user-select:none;
      pointer-events:none;
      filter: drop-shadow(0 10px 10px rgba(0,0,0,0.35));
    }
    .kart-emoji { font-size: 2.3rem; line-height: 1; }
    .kart-label {
      font-size: 0.72rem;
      color: white;
      background: rgba(0,0,0,0.72);
      padding: 2px 6px;
      border-radius: 9999px;
      margin-top: 4px;
      letter-spacing: 0.02em;
    }

    /* ãƒ‰ãƒªãƒ•ãƒˆç«èŠ± */
    #sparks-layer{ position:absolute; inset:0; z-index: 7; pointer-events:none; }
    .spark {
      position:absolute;
      font-size: 1.0rem;
      opacity: 0.95;
      animation: spark-pop 350ms ease-out forwards;
    }
    @keyframes spark-pop{
      from{ transform: translateY(0) scale(0.8); opacity: 0.9; }
      to{ transform: translateY(18px) scale(1.3); opacity: 0; }
    }

    @keyframes shake { 0%,100%{ transform: translateX(0);} 25%{ transform: translateX(-6px);} 75%{ transform: translateX(6px);} }
    .shake { animation: shake 220ms ease-in-out; }

    @keyframes glow {
      0%,100%{ filter: drop-shadow(0 0 10px rgba(255,255,0,0.55)) drop-shadow(0 0 18px rgba(0,255,255,0.35)); }
      50%{ filter: drop-shadow(0 0 16px rgba(255,255,0,0.75)) drop-shadow(0 0 24px rgba(255,0,255,0.35)); }
    }
    .glow { animation: glow 650ms ease-in-out infinite; }

    .press:active{ transform: scale(0.96); }
    .modal-card{
      box-shadow: 0 20px 80px rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.18);
    }
  </style>
</head>

<body class="h-full overflow-auto">
<div id="app" class="h-full w-full track-gradient text-white">

  <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
  <div id="title-screen" class="h-full flex flex-col items-center justify-center p-4">
    <h1 id="game-title" class="text-4xl md:text-6xl font-black text-yellow-300 mb-3 text-center drop-shadow-lg">
      ğŸï¸ ç®—æ•°ã‚«ãƒ¼ãƒˆãƒ¬ãƒ¼ã‚¹ ğŸï¸
    </h1>
    <p class="text-lg md:text-xl mb-6 text-cyan-200">1å‘¨ã”ã¨ã«ç®—æ•°ï¼ æ­£è§£ã§ãƒ¬ãƒ¼ã‚¹å†é–‹ï¼</p>

    <div class="bg-white/10 backdrop-blur rounded-2xl p-5 mb-5 max-w-md w-full">
      <h2 class="text-xl font-bold mb-3 text-center text-yellow-200">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼</h2>
      <div class="grid grid-cols-4 gap-3 mb-3" id="char-select"></div>
      <p class="text-center text-sm text-gray-200">é¸æŠä¸­: <span id="selected-char" class="text-2xl">ğŸ¥¸</span></p>
    </div>

    <div class="bg-white/10 backdrop-blur rounded-2xl p-5 mb-6 max-w-md w-full">
      <h2 class="text-xl font-bold mb-3 text-center text-pink-200">ã‚«ãƒ¼ãƒˆ</h2>
      <div class="grid grid-cols-4 gap-3 mb-3" id="kart-select"></div>
      <p class="text-center text-sm text-gray-200">é¸æŠä¸­: <span id="selected-kart" class="text-2xl">ğŸ›’</span></p>
    </div>

    <div class="text-center text-sm text-gray-300 mb-4">
      æ“ä½œï¼šâ†‘åŠ é€Ÿ / â†“ãƒ–ãƒ¬ãƒ¼ã‚­ / â†â†’ãƒãƒ³ãƒ‰ãƒ« / Shiftãƒ‰ãƒªãƒ•ãƒˆ / Spaceã‚¢ã‚¤ãƒ†ãƒ 
    </div>

    <button id="start-btn"
      class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white text-2xl font-black py-4 px-12 rounded-full shadow-lg transform hover:scale-105 transition-all press">
      ğŸš€ ãƒ¬ãƒ¼ã‚¹ã‚¹ã‚¿ãƒ¼ãƒˆï¼
    </button>
  </div>

  <!-- ã‚²ãƒ¼ãƒ  -->
  <div id="game-screen" class="h-full hidden flex-col">

    <!-- HUD -->
    <div class="bg-black/80 p-3 flex flex-wrap gap-2 justify-between items-center">
      <div class="text-base md:text-lg font-bold">
        ğŸ <span id="lap-display">1</span>/<span id="lap-total">10</span>å‘¨
        <span class="mx-2">|</span>
        ğŸ† <span id="position">1</span>ä½/5
      </div>

      <div class="flex flex-wrap gap-3 items-center text-sm md:text-base">
        <div>âš¡ <span id="player-speed">0</span></div>
        <div>ğŸŒ€ ãƒ‰ãƒªãƒ•ãƒˆ: <span id="drift-meter">0</span>%</div>
        <div>ğŸ <span id="item-display">---</span></div>
      </div>
    </div>

    <!-- ãƒ¬ãƒ¼ã‚¹ãƒ“ãƒ¥ãƒ¼ -->
    <div id="race-view" class="flex-1 relative">
      <div class="cloud" style="left: 10%; animation-duration: 22s; top: 10%; opacity: .7;"></div>
      <div class="cloud" style="left: 45%; animation-duration: 26s; top: 6%; opacity: .6;"></div>
      <div class="cloud" style="left: 75%; animation-duration: 30s; top: 12%; opacity: .55;"></div>

      <div id="road-wrap">
        <div id="road">
          <div id="centerline"></div>
          <div class="lane-guide" style="left:33.33%;"></div>
          <div class="lane-guide" style="left:66.66%;"></div>
        </div>
      </div>

      <div id="speedlines"></div>

      <div id="karts-container"></div>
      <div id="sparks-layer"></div>
    </div>

    <!-- æ“ä½œ -->
    <div class="bg-black/70 p-3">
      <div class="flex flex-wrap justify-center gap-3 mb-2">
        <button id="btn-left"  class="bg-slate-600 hover:bg-slate-700 px-5 py-2 rounded-lg font-bold press">â¬…ï¸ å·¦</button>
        <button id="btn-accel" class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg font-bold press">â¬†ï¸ ã‚¢ã‚¯ã‚»ãƒ«</button>
        <button id="btn-brake" class="bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg font-bold press">â¬‡ï¸ ãƒ–ãƒ¬ãƒ¼ã‚­</button>
        <button id="btn-right" class="bg-slate-600 hover:bg-slate-700 px-5 py-2 rounded-lg font-bold press">â¡ï¸ å³</button>
        <button id="btn-drift" class="bg-purple-600 hover:bg-purple-700 px-6 py-2 rounded-lg font-bold press">ğŸŒ€ ãƒ‰ãƒªãƒ•ãƒˆ</button>
        <button id="btn-item" class="bg-yellow-500 hover:bg-yellow-600 px-6 py-2 rounded-lg font-bold press">ğŸ¯ ã‚¢ã‚¤ãƒ†ãƒ </button>
      </div>
      <p class="text-center text-xs md:text-sm text-gray-300">
        â€»PCã¯ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ¨å¥¨ï¼šâ†â†’ã§ãƒãƒ³ãƒ‰ãƒ« / Shiftã§ãƒ‰ãƒªãƒ•ãƒˆ / Spaceã§ã‚¢ã‚¤ãƒ†ãƒ 
      </p>
    </div>
  </div>

  <!-- ç®—æ•°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="math-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
    <div class="modal-card bg-gradient-to-br from-purple-600 to-indigo-700 rounded-3xl p-7 max-w-md w-full text-center">
      <h2 class="text-3xl font-black mb-3 text-yellow-200">ğŸ“š 1å‘¨ã‚¯ãƒªã‚¢ï¼ç®—æ•°ã‚¿ã‚¤ãƒ ï¼</h2>
      <p class="text-sm text-white/90 mb-2">æ­£è§£ã—ãªã„ã¨ãƒ¬ãƒ¼ã‚¹å†é–‹ã§ãã¾ã›ã‚“ã€‚</p>

      <div class="bg-white/15 rounded-2xl p-4 mb-4">
        <div class="text-sm text-white/80 mb-1">å•é¡Œ</div>
        <p id="math-question" class="text-4xl font-black">15 + 35 = ?</p>
      </div>

      <input type="number" id="math-answer"
        class="w-full text-3xl text-center p-4 rounded-xl bg-white text-gray-800 mb-3"
        placeholder="ç­”ãˆã‚’å…¥åŠ›" />

      <button id="submit-answer"
        class="bg-gradient-to-r from-green-500 to-emerald-600 text-white text-xl font-black py-3 px-8 rounded-full hover:scale-105 transition-transform w-full press">
        å›ç­”ã™ã‚‹ï¼
      </button>

      <div class="mt-4 text-sm text-gray-100">
        â° åˆ¶é™æ™‚é–“: <span id="time-left" class="font-black">10</span>ç§’
      </div>
      <p id="math-feedback" class="mt-3 text-sm font-bold text-yellow-200"></p>
    </div>
  </div>

  <!-- çµæœ -->
  <div id="result-screen" class="hidden h-full flex-col items-center justify-center p-4 bg-gradient-to-b from-purple-900 to-blue-900">
    <h1 class="text-5xl font-black mb-4">ğŸ ãƒ¬ãƒ¼ã‚¹çµ‚äº†ï¼ ğŸ</h1>
    <div id="result-position" class="text-8xl mb-4">ğŸ¥‡</div>
    <p id="result-text" class="text-3xl font-black text-yellow-300 mb-8">1ä½ã§ã‚´ãƒ¼ãƒ«ï¼</p>

    <div class="bg-white/10 backdrop-blur rounded-2xl p-6 mb-8 max-w-md w-full">
      <h3 class="text-xl font-black mb-4">ğŸ“Š ã‚¹ã‚¿ãƒƒãƒ„</h3>
      <p class="mb-2">æ­£è§£ã—ãŸå•é¡Œ: <span id="correct-answers" class="font-black">0</span>å•</p>
      <p class="mb-2">ä½¿ç”¨ã‚¢ã‚¤ãƒ†ãƒ : <span id="items-used" class="font-black">0</span>å€‹</p>
      <p>ãƒ¬ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ : <span id="race-time" class="font-black">0:00</span></p>
    </div>

    <button id="retry-btn"
      class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white text-2xl font-black py-4 px-12 rounded-full shadow-lg transform hover:scale-105 transition-all press">
      ğŸ”„ ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤
    </button>
  </div>

</div>

<script>
/* ========= åŸºæœ¬ ========= */
const characters = ['ğŸ¥¸','ğŸ¥·ğŸ¿','ğŸ’€','ğŸ’°','ğŸœ','ğŸ°','ğŸ·','ğŸ¦‡'];
const karts      = ['ğŸ¦','ğŸ¦€','ğŸ„','ğŸ–','ğŸ›’','ğŸ“','ğŸœ','ğŸ‡'];
const itemsPool  = ['ğŸŒ','ğŸ„','â­','ğŸ’£','ğŸ¦‘','ğŸª¶','ğŸ¢','ğŸ‘»'];

const titleScreen  = document.getElementById('title-screen');
const gameScreen   = document.getElementById('game-screen');
const resultScreen = document.getElementById('result-screen');
const mathModal    = document.getElementById('math-modal');

const kartsContainer = document.getElementById('karts-container');
const sparksLayer    = document.getElementById('sparks-layer');
const centerlineEl   = document.getElementById('centerline');
const roadEl         = document.getElementById('road');
const speedLinesEl   = document.getElementById('speedlines');

const lapDisplay   = document.getElementById('lap-display');
const lapTotalEl   = document.getElementById('lap-total');
const posEl        = document.getElementById('position');
const speedEl      = document.getElementById('player-speed');
const driftMeterEl = document.getElementById('drift-meter');
const itemDisplay  = document.getElementById('item-display');

const gameState = {
  screen: 'title',
  selectedChar: characters[0],
  selectedKart: karts[4],
  totalLaps: 10,
  players: [],
  player: null, // å›ºå®šå‚ç…§
  pausedByQuiz: false,
  quizLapTriggered: -1,
  keys: { up:false, down:false, left:false, right:false, drift:false },
  correctAnswers: 0,
  itemsUsed: 0,
  startTime: 0,
  gameActive: false,
  scrollY: 0
};

const LANES = 3; // 3ãƒ¬ãƒ¼ãƒ³
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function lerp(a,b,t){ return a + (b-a)*t; }

/* ========= é¸æŠUI ========= */
function initCharacterSelect(){
  const wrap = document.getElementById('char-select');
  wrap.innerHTML = '';
  characters.forEach((ch, idx)=>{
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'text-3xl p-2 rounded-lg bg-white/20 hover:bg-white/40 transition-all hover:scale-110 cursor-pointer';
    btn.textContent = ch;
    if(idx===0) btn.classList.add('ring-4','ring-yellow-300');
    btn.addEventListener('click', ()=>{
      gameState.selectedChar = ch;
      document.getElementById('selected-char').textContent = ch;
      document.querySelectorAll('#char-select button').forEach(b=>b.classList.remove('ring-4','ring-yellow-300'));
      btn.classList.add('ring-4','ring-yellow-300');
    });
    wrap.appendChild(btn);
  });
}
function initKartSelect(){
  const wrap = document.getElementById('kart-select');
  wrap.innerHTML = '';
  karts.forEach((k, idx)=>{
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'text-3xl p-2 rounded-lg bg-white/20 hover:bg-white/40 transition-all hover:scale-110 cursor-pointer';
    btn.textContent = k;
    if(k===gameState.selectedKart || idx===0) btn.classList.add('ring-4','ring-pink-300');
    btn.addEventListener('click', ()=>{
      gameState.selectedKart = k;
      document.getElementById('selected-kart').textContent = k;
      document.querySelectorAll('#kart-select button').forEach(b=>b.classList.remove('ring-4','ring-pink-300'));
      btn.classList.add('ring-4','ring-pink-300');
    });
    wrap.appendChild(btn);
  });
}

/* ========= ç«èŠ± ========= */
function spawnSpark(player, charge){
  const sp = document.createElement('div');
  sp.className = 'spark';
  sp.textContent = charge > 0.75 ? 'âœ¨' : (charge > 0.5 ? 'âš¡' : 'ğŸ’¥');

  const view = document.getElementById('race-view').getBoundingClientRect();
  const road = roadEl.getBoundingClientRect();

  // roadå†…ã®ä½ç½®ã«åˆã‚ã›ã‚‹ï¼ˆè¦‹ãˆã‚‹ä¿è¨¼ï¼‰
  const laneX = lerp(0.25, 0.75, player.lanePos/(LANES-1));
  const x = (road.left - view.left) + road.width * laneX + (Math.random()*12-6);
  const y = (road.top  - view.top)  + road.height * 0.82 + 30 + (Math.random()*8);

  sp.style.left = x + 'px';
  sp.style.top  = y + 'px';
  sparksLayer.appendChild(sp);
  setTimeout(()=> sp.remove(), 380);
}

/* ========= ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ========= */
class Player {
  constructor(char, kart, isAI=false){
    this.char = char;
    this.kart = kart;
    this.isAI = isAI;

    this.progress = 0; // 0..100
    this.laps = 0;
    this.finished = false;

    this.speed = 0;
    this.baseMaxSpeed = isAI ? 10.5 : 12.5;
    this.maxSpeed = this.baseMaxSpeed;
    this.accel = isAI ? 7.0 : 8.5;
    this.brakePower = 12.0;
    this.friction = 2.8;

    this.lane = 1;
    this.lanePos = 1;
    this.steerSpeed = isAI ? 2.2 : 4.0;

    this.drifting = false;
    this.driftDir = 0;
    this.driftCharge = 0;
    this.boostTime = 0;

    this.stunTime = 0;

    this.currentItem = null;
    this.element = null;
  }

  giveItem(){ this.currentItem = itemsPool[Math.floor(Math.random()*itemsPool.length)]; }
  useItem(){
    if(!this.currentItem) return { used:false };
    const it = this.currentItem;
    this.currentItem = null;
    return { used:true, item:it };
  }
  applyBoost(sec, extraMax){
    this.boostTime = Math.max(this.boostTime, sec);
    this.maxSpeed = Math.max(this.maxSpeed, this.baseMaxSpeed + extraMax);
  }
  spin(sec){
    this.stunTime = Math.max(this.stunTime, sec);
    this.speed *= 0.3;
  }

  update(dt){
    if(this.finished) return;

    if(this.stunTime > 0){
      this.stunTime -= dt;
      this.speed = Math.max(0, this.speed - this.brakePower*dt*0.6);
    }

    if(this.boostTime > 0){
      this.boostTime -= dt;
      if(this.boostTime <= 0) this.maxSpeed = this.baseMaxSpeed;
    }else{
      this.maxSpeed = this.baseMaxSpeed;
    }

    if(this.isAI){
      if(Math.random() < 0.007) this.lane = clamp(this.lane + (Math.random()<0.5?-1:1), 0, LANES-1);

      const target = this.baseMaxSpeed * (0.72 + Math.random()*0.18);
      if(this.speed < target) this.speed += this.accel*dt;
      else this.speed -= this.friction*dt*0.9;

      if(!this.currentItem && Math.random()<0.01) this.giveItem();
      if(this.currentItem && Math.random()<0.003) this.useItem();
    }else{
      if(gameState.keys.up)   this.speed += this.accel*dt;
      if(gameState.keys.down) this.speed -= this.brakePower*dt;

      if(!gameState.keys.up && !gameState.keys.down) this.speed -= this.friction*dt;

      const steering = (gameState.keys.right?1:0) - (gameState.keys.left?1:0);

      if(gameState.keys.drift && steering !== 0 && this.speed > 3.5 && this.stunTime<=0){
        if(!this.drifting){
          this.drifting = true;
          this.driftDir = steering;
          this.driftCharge = 0;
        }
        this.speed = Math.max(0, this.speed - 0.6*dt);
        this.driftCharge = clamp(this.driftCharge + dt*0.55, 0, 1);
        if(Math.random() < 0.25) spawnSpark(this, this.driftCharge);
      }else{
        if(this.drifting){
          const c = this.driftCharge;
          if(c > 0.25){
            const boostSec = c > 0.75 ? 1.1 : (c > 0.5 ? 0.8 : 0.55);
            const extraMax = c > 0.75 ? 4.0 : (c > 0.5 ? 2.8 : 1.8);
            this.applyBoost(boostSec, extraMax);
          }
        }
        this.drifting = false;
        this.driftDir = 0;
        this.driftCharge = 0;
      }

      if(steering !== 0 && this.stunTime<=0){
        this.lane = clamp(this.lane + steering, 0, LANES-1);
      }
    }

    this.lanePos = lerp(this.lanePos, this.lane, clamp(dt*this.steerSpeed, 0, 1));
    this.speed = clamp(this.speed, 0, this.maxSpeed);

    this.progress += this.speed * dt;
    if(this.progress >= 100){
      this.progress -= 100;
      this.laps++;
      if(this.laps >= gameState.totalLaps) this.finished = true;
    }
  }

  render(orderIndex){
    if(!this.element){
      this.element = document.createElement('div');
      this.element.className = 'kart';
      if(!this.isAI) this.element.classList.add('glow');
      kartsContainer.appendChild(this.element);
    }

    const view = document.getElementById('race-view').getBoundingClientRect();
    const road = roadEl.getBoundingClientRect();

    // roadå†…ã«ã€Œå¿…ãšå‡ºã‚‹ã€åº§æ¨™ç³»ã«ã™ã‚‹
    const laneX = lerp(0.25, 0.75, this.lanePos/(LANES-1));
    const x = (road.left - view.left) + road.width * laneX;

    // å¥¥(ä¸Š)ã¸ï¼šCPUã¯é †ä½ã«å¿œã˜ã¦ä¸Šã¸ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ä¸‹å›ºå®š
    const baseY = this.isAI
      ? (0.22 + orderIndex*0.10)  // ã ã‚“ã ã‚“ä¸‹ã¸
      : 0.84;                     // è‡ªåˆ†ã¯å¸¸ã«ä¸‹

    const y = (road.top - view.top) + road.height * clamp(baseY, 0.18, 0.86);

    // ã‚µã‚¤ã‚ºï¼šå¥¥ã¯å°ã•ã‚
    const scale = this.isAI ? (0.85 - orderIndex*0.05) : 1.10;

    // å‚¾ã
    const steer = (!this.isAI) ? ((gameState.keys.right?1:0) - (gameState.keys.left?1:0)) : 0;
    const tilt = (this.drifting ? this.driftDir : steer) * 10;

    this.element.style.left = x + 'px';
    this.element.style.top  = y + 'px';
    this.element.style.transform = `translate(-50%, -50%) rotate(${tilt}deg) scale(${scale})`;

    const lapText = this.finished ? 'ğŸ' : `L${clamp(this.laps+1,1,gameState.totalLaps)}`;
    this.element.innerHTML = `
      <div class="kart-emoji">${this.kart}</div>
      <div class="kart-label">${this.char} ${lapText}</div>
    `;
  }
}

/* ========= ç®—æ•° ========= */
let quizTimer = null;
let timeLeft = 10;
let currentQuiz = { q:'', a:0 };

function makeMathProblem(lapIndex){
  const level = clamp(lapIndex, 1, 10);
  const types = level <= 3 ? ['add','sub'] : (level <= 6 ? ['add','sub','mul'] : ['add','sub','mul','mix']);
  const type = types[Math.floor(Math.random()*types.length)];
  const rand = (min,max)=> Math.floor(Math.random()*(max-min+1))+min;

  if(type==='add'){
    const a = rand(10*level, 20*level);
    const b = rand(5*level, 15*level);
    return { q: `${a} + ${b}`, a: a+b };
  }
  if(type==='sub'){
    let a = rand(15*level, 25*level);
    let b = rand(5*level, 18*level);
    if(b>a) [a,b] = [b,a];
    return { q: `${a} - ${b}`, a: a-b };
  }
  if(type==='mul'){
    const a = rand(2, Math.min(9, 2+Math.floor(level/2)));
    const b = rand(2, 9);
    return { q: `${a} Ã— ${b}`, a: a*b };
  }
  const a = rand(2, 9), b = rand(2, 9), c = rand(5, 20);
  return { q: `${a} Ã— ${b} + ${c}`, a: a*b + c };
}

function openQuiz(lapCompleted){
  gameState.pausedByQuiz = true;
  mathModal.classList.remove('hidden');

  currentQuiz = makeMathProblem(lapCompleted);
  document.getElementById('math-question').textContent = `${currentQuiz.q} = ?`;
  document.getElementById('math-answer').value = '';
  document.getElementById('math-feedback').textContent = '';

  clearInterval(quizTimer);
  timeLeft = 10;
  document.getElementById('time-left').textContent = timeLeft;

  quizTimer = setInterval(()=>{
    timeLeft--;
    document.getElementById('time-left').textContent = timeLeft;

    if(timeLeft <= 0){
      clearInterval(quizTimer);
      document.getElementById('math-feedback').textContent = 'â° ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ã‚¹ãƒ”ãƒ³ï¼æ¬¡ã®å•é¡Œï¼';
      gameState.player.spin(1.0);
      setTimeout(()=> openQuiz(lapCompleted), 650);
    }
  }, 1000);

  setTimeout(()=> document.getElementById('math-answer').focus(), 50);
}

function closeQuizWithSuccess(){
  clearInterval(quizTimer);
  mathModal.classList.add('hidden');
  gameState.pausedByQuiz = false;
  gameState.player.applyBoost(0.9, 3.2);
}

/* ========= ã‚¢ã‚¤ãƒ†ãƒ  ========= */
function getRanking(){
  return [...gameState.players].sort((a,b)=>{
    if(a.laps !== b.laps) return b.laps - a.laps;
    return b.progress - a.progress;
  });
}
function applyItemEffect(item){
  const me = gameState.player;
  if(item === 'ğŸ„'){ me.applyBoost(0.9, 3.4); return 'ğŸ„ ãƒ–ãƒ¼ã‚¹ãƒˆï¼'; }
  if(item === 'â­'){ me.applyBoost(1.3, 4.2); return 'â­ ç„¡æ•µã£ã½ã„åŠ é€Ÿï¼'; }
  if(item === 'ğŸŒ'){
    const ai = getRanking().filter(p=>p.isAI && !p.finished)[0];
    if(ai) ai.spin(0.8);
    return 'ğŸŒ å‰ã®CPUãŒã‚¹ãƒ”ãƒ³ï¼';
  }
  if(item === 'ğŸ’£'){
    gameState.players.filter(p=>p.isAI).forEach(p=>{ if(Math.random()<0.6) p.spin(0.6); });
    return 'ğŸ’£ ãƒ‰ã‚«ãƒ¼ãƒ³ï¼';
  }
  if(item === 'ğŸ¦‘'){ me.spin(0.35); return 'ğŸ¦‘ ãã‚‰ãã‚‰â€¦'; }
  if(item === 'ğŸª¶'){ me.applyBoost(0.55, 2.2); return 'ğŸª¶ ãµã‚ã£ã¨åŠ é€Ÿï¼'; }
  if(item === 'ğŸ¢'){
    const lastAI = getRanking().filter(p=>p.isAI).slice(-1)[0];
    if(lastAI) lastAI.spin(1.0);
    return 'ğŸ¢ ã“ã†ã‚‰å‘½ä¸­ï¼';
  }
  if(item === 'ğŸ‘»'){ me.applyBoost(0.6, 2.6); return 'ğŸ‘» ã™ã‚ŠæŠœã‘æ°—åˆ†ï¼'; }
  return 'ğŸ¯ ç™ºå‹•ï¼';
}

function handleItemUse(){
  if(!gameState.player || gameState.pausedByQuiz) return;

  if(!gameState.player.currentItem){
    gameState.player.giveItem();
    return;
  }
  const res = gameState.player.useItem();
  if(res.used){
    gameState.itemsUsed++;
    const msg = applyItemEffect(res.item);
    itemDisplay.textContent = msg;
    itemDisplay.classList.remove('shake'); void itemDisplay.offsetWidth; itemDisplay.classList.add('shake');
    setTimeout(()=> { itemDisplay.textContent = gameState.player.currentItem ? gameState.player.currentItem : '---'; }, 700);
  }
}

/* ========= HUD & ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« ========= */
function updateHUD(){
  const ranking = getRanking();
  const myPos = ranking.findIndex(p => p === gameState.player) + 1;
  posEl.textContent = myPos;

  lapTotalEl.textContent = gameState.totalLaps;
  lapDisplay.textContent = clamp(gameState.player.laps + 1, 1, gameState.totalLaps);

  const pct = Math.round((gameState.player.speed / gameState.player.maxSpeed) * 100);
  speedEl.textContent = `${pct}%`;
  driftMeterEl.textContent = Math.round(gameState.player.driftCharge*100);

  speedLinesEl.style.opacity = (pct >= 78 || gameState.player.boostTime > 0.1) ? 0.35 : 0;

  itemDisplay.textContent = gameState.player.currentItem ? gameState.player.currentItem : '---';
}

function updateRoadScroll(dt){
  const s = gameState.player ? gameState.player.speed : 0;
  gameState.scrollY += s * dt * 260; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦ï¼ˆè¦‹ãŸç›®ç”¨ï¼‰

  // ã‚»ãƒ³ã‚¿ãƒ¼ãƒ©ã‚¤ãƒ³ã‚’æµã™
  centerlineEl.style.transform = `translateX(-50%) translateY(${gameState.scrollY}px)`;
}

/* ========= ãƒ«ãƒ¼ãƒ— ========= */
let lastT = performance.now();
function gameLoop(now){
  if(!gameState.gameActive) return;

  const dt = clamp((now - lastT)/1000, 0, 0.033);
  lastT = now;

  if(!gameState.pausedByQuiz){
    gameState.players.forEach(p => p.update(dt));
    updateRoadScroll(dt);

    const lapsDone = gameState.player.laps;
    if(lapsDone > gameState.quizLapTriggered && lapsDone > 0 && lapsDone < gameState.totalLaps){
      gameState.quizLapTriggered = lapsDone;
      openQuiz(lapsDone);
    }

    const allFinished = gameState.players.every(p => p.finished);
    if(allFinished){
      endGame();
      return;
    }
  }

  const ranking = getRanking();
  ranking.forEach((p, idx)=> p.render(idx));
  updateHUD();

  requestAnimationFrame(gameLoop);
}

/* ========= é–‹å§‹/çµ‚äº† ========= */
function startGame(){
  gameState.screen = 'game';
  titleScreen.classList.add('hidden');
  resultScreen.classList.add('hidden');
  gameScreen.classList.remove('hidden');

  kartsContainer.innerHTML = '';
  sparksLayer.innerHTML = '';

  gameState.players = [];
  gameState.scrollY = 0;

  const human = new Player(gameState.selectedChar, gameState.selectedKart, false);
  gameState.player = human;
  gameState.players.push(human);

  const availableChars = characters.filter(c=>c!==gameState.selectedChar);
  const availableKarts = karts.filter(k=>k!==gameState.selectedKart);

  for(let i=0;i<4;i++){
    const cpu = new Player(availableChars[i%availableChars.length], availableKarts[i%availableKarts.length], true);
    cpu.lane = i%LANES;
    cpu.lanePos = cpu.lane;
    cpu.speed = 3 + Math.random()*1.5;
    gameState.players.push(cpu);
  }

  gameState.correctAnswers = 0;
  gameState.itemsUsed = 0;
  gameState.startTime = Date.now();
  gameState.gameActive = true;
  gameState.pausedByQuiz = false;
  gameState.quizLapTriggered = -1;

  // ã¾ãš1å›æç”»ã—ã¦ã€Œè¦‹ãˆã‚‹ã€ã‚’ä¿è¨¼
  const ranking = getRanking();
  ranking.forEach((p, idx)=> p.render(idx));
  updateHUD();

  lastT = performance.now();
  requestAnimationFrame(gameLoop);
}

function endGame(){
  gameState.gameActive = false;
  gameScreen.classList.add('hidden');
  resultScreen.classList.remove('hidden');

  const ranking = getRanking();
  const myPos = ranking.findIndex(p => p === gameState.player) + 1;
  const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','4ï¸âƒ£','5ï¸âƒ£'];

  document.getElementById('result-position').textContent = medals[myPos-1] || 'ğŸ';
  document.getElementById('result-text').textContent = `${myPos}ä½ã§ã‚´ãƒ¼ãƒ«ï¼`;
  document.getElementById('correct-answers').textContent = gameState.correctAnswers;
  document.getElementById('items-used').textContent = gameState.itemsUsed;

  const timeSeconds = Math.round((Date.now() - gameState.startTime)/1000);
  const minutes = Math.floor(timeSeconds/60);
  const seconds = timeSeconds%60;
  document.getElementById('race-time').textContent = `${minutes}:${String(seconds).padStart(2,'0')}`;
}

/* ========= ã‚¤ãƒ™ãƒ³ãƒˆ ========= */
document.getElementById('start-btn').addEventListener('click', startGame);

document.getElementById('retry-btn').addEventListener('click', ()=>{
  gameState.screen = 'title';
  resultScreen.classList.add('hidden');
  titleScreen.classList.remove('hidden');
  gameState.gameActive = false;
  clearInterval(quizTimer);
  mathModal.classList.add('hidden');
});

document.getElementById('submit-answer').addEventListener('click', ()=>{
  const input = document.getElementById('math-answer');
  const v = Number(input.value);
  const fb = document.getElementById('math-feedback');

  if(Number.isNaN(v)){
    fb.textContent = 'æ•°å­—ã‚’å…¥ã‚Œã¦ã­ï¼';
    input.classList.remove('shake'); void input.offsetWidth; input.classList.add('shake');
    return;
  }
  if(v === currentQuiz.a){
    gameState.correctAnswers++;
    fb.textContent = 'âœ… æ­£è§£ï¼ãƒ–ãƒ¼ã‚¹ãƒˆï¼';
    closeQuizWithSuccess();
  }else{
    fb.textContent = 'âŒ ã¡ãŒã†ï¼ã‚‚ã†ä¸€å›ï¼';
    input.classList.remove('shake'); void input.offsetWidth; input.classList.add('shake');
    timeLeft = Math.max(1, timeLeft - 2);
    document.getElementById('time-left').textContent = timeLeft;
  }
});

/* ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ */
document.addEventListener('keydown', (e)=>{
  if(gameState.screen !== 'game') return;

  if(!mathModal.classList.contains('hidden')){
    if(e.key === 'Enter'){ e.preventDefault(); document.getElementById('submit-answer').click(); }
    return;
  }

  if(e.key === 'ArrowUp')    { e.preventDefault(); gameState.keys.up = true; }
  if(e.key === 'ArrowDown')  { e.preventDefault(); gameState.keys.down = true; }
  if(e.key === 'ArrowLeft')  { e.preventDefault(); gameState.keys.left = true; }
  if(e.key === 'ArrowRight') { e.preventDefault(); gameState.keys.right = true; }
  if(e.key === 'Shift')      { e.preventDefault(); gameState.keys.drift = true; }
  if(e.key === ' ')          { e.preventDefault(); handleItemUse(); }
});
document.addEventListener('keyup', (e)=>{
  if(e.key === 'ArrowUp')    gameState.keys.up = false;
  if(e.key === 'ArrowDown')  gameState.keys.down = false;
  if(e.key === 'ArrowLeft')  gameState.keys.left = false;
  if(e.key === 'ArrowRight') gameState.keys.right = false;
  if(e.key === 'Shift')      gameState.keys.drift = false;
});

/* ã‚¹ãƒãƒ›/ãƒã‚¦ã‚¹å…±é€šï¼špointerã§é•·æŠ¼ã— */
function bindHoldPointer(btnId, onDown, onUp){
  const el = document.getElementById(btnId);
  el.addEventListener('pointerdown', (e)=>{ e.preventDefault(); el.setPointerCapture(e.pointerId); onDown(); });
  el.addEventListener('pointerup',   (e)=>{ e.preventDefault(); onUp(); });
  el.addEventListener('pointercancel',(e)=>{ e.preventDefault(); onUp(); });
  el.addEventListener('pointerleave', ()=>{ onUp(); });
}
bindHoldPointer('btn-accel', ()=> gameState.keys.up = true,   ()=> gameState.keys.up = false);
bindHoldPointer('btn-brake', ()=> gameState.keys.down = true, ()=> gameState.keys.down = false);
bindHoldPointer('btn-left',  ()=> gameState.keys.left = true, ()=> gameState.keys.left = false);
bindHoldPointer('btn-right', ()=> gameState.keys.right = true,()=> gameState.keys.right = false);
bindHoldPointer('btn-drift', ()=> gameState.keys.drift = true,()=> gameState.keys.drift = false);
document.getElementById('btn-item').addEventListener('click', (e)=>{ e.preventDefault(); handleItemUse(); });

/* åˆæœŸåŒ– */
initCharacterSelect();
initKartSelect();
document.getElementById('selected-char').textContent = gameState.selectedChar;
document.getElementById('selected-kart').textContent = gameState.selectedKart;
</script>

</body>
</html>
