<!doctype html>
<html lang="ja" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ¼¢å­—å‹‡è€… - èª­ã¿ã®è©¦ç·´</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&family=Yuji+Syuku&display=swap" rel="stylesheet">
  <style>
    html, body { height: 100%; }
    body { box-sizing: border-box; margin: 0; }
    * { font-family: 'Zen Maru Gothic', sans-serif; }
    .title-font { font-family: 'Yuji Syuku', serif; }

    @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
    @keyframes pulse-glow { 0%,100%{box-shadow:0 0 20px rgba(255,215,0,0.3)} 50%{box-shadow:0 0 40px rgba(255,215,0,0.6)} }
    @keyframes damage-flash { 0%,100%{filter:brightness(1)} 50%{filter:brightness(2) saturate(0)} }
    @keyframes victory-glow { 0%{transform:scale(1);opacity:1} 50%{transform:scale(1.1);opacity:.8} 100%{transform:scale(1);opacity:1} }
    @keyframes time-warning { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }

    .float-anim { animation: float 3s ease-in-out infinite; }
    .pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
    .damage-flash { animation: damage-flash 0.2s ease-out; }
    .victory-glow { animation: victory-glow 1s ease-in-out infinite; }
    .time-warning { animation: time-warning 0.4s ease-in-out infinite; }

    .flick-key{
      width:56px;height:56px;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(145deg,#2a2a3e,#1a1a2e);
      border:2px solid #4a4a6e;border-radius:12px;font-size:1.15rem;color:#fff;
      cursor:pointer;user-select:none;transition:transform .15s, background .15s, box-shadow .15s, border-color .15s;
      -webkit-tap-highlight-color:transparent;touch-action:none;
    }
    .flick-key:active{transform:scale(.95);background:linear-gradient(145deg,#3a3a5e,#2a2a4e)}
    .flick-key.active{border-color:#ffd700;box-shadow:0 0 15px rgba(255,215,0,.5)}
    .flick-key.disabled{pointer-events:none;opacity:0}

    .hp-bar{height:24px;background:#1a1a2e;border-radius:12px;overflow:hidden;border:2px solid #4a4a6e}
    .hp-fill{height:100%;background:linear-gradient(90deg,#22c55e,#4ade80);transition:width .3s ease}
    .hp-fill.low{background:linear-gradient(90deg,#ef4444,#f87171)}
    .hp-fill.enemy{background:linear-gradient(90deg,#dc2626,#ef4444)}

    .weapon-card{background:linear-gradient(145deg,#2a2a3e,#1a1a2e);border:2px solid;border-radius:16px;padding:16px;text-align:center}
    .weapon-card.common{border-color:#9ca3af}
    .weapon-card.uncommon{border-color:#22c55e}
    .weapon-card.rare{border-color:#3b82f6}
    .weapon-card.epic{border-color:#a855f7}
    .weapon-card.legendary{border-color:#ffd700;box-shadow:0 0 30px rgba(255,215,0,0.3)}

    .battle-screen{background:radial-gradient(ellipse at center,#1e1e3f 0%,#0a0a1a 100%)}
    .enemy-sprite{font-size:4rem;filter:drop-shadow(0 0 20px rgba(255,0,0,0.3))}

    .input-display{min-height:48px;background:rgba(0,0,0,0.5);border:2px solid #4a4a6e;border-radius:12px;padding:8px 16px;font-size:1.5rem;color:#fff}
    .time-bar{height:8px;background:#1a1a2e;border-radius:4px;overflow:hidden;border:1px solid #4a4a6e}
    .time-bar-fill{height:100%;background:linear-gradient(90deg,#22c55e,#4ade80);transition:width .1s linear, background .1s linear}
    .time-bar-fill.warning{background:linear-gradient(90deg,#ef4444,#f87171)}
  </style>
</head>

<body class="h-full bg-gray-900 text-white overflow-hidden">
  <div id="app" class="h-full w-full"></div>

  <script>
    // =========================
    // Game State
    // =========================
    const gameState = {
      screen: 'title',
      playerName: '',
      battleInputMode: 'flick', // 'keyboard' | 'flick'
      difficulty: null,

      playerHP: 100,
      maxHP: 100,
      playerATK: 10,
      playerDEF: 5,

      weapons: [],
      equippedWeapon: null,

      currentEnemy: null,
      enemyHP: 0,
      enemyMaxHP: 0,

      currentQuestion: null,
      inputText: '',

      defeatedCount: 0,
      totalDefeated: 0,
      clearedLevels: [], // difficulty keys

      combo: 0,
      message: '',

      droppedWeapon: null,
      isBossBattle: false,

      timeLimit: 10,
      timeRemaining: 10,
      timerInterval: null
    };

    // =========================
    // 5å¹´ç”Ÿ å•é¡Œï¼ˆ200 + 200ï¼‰/ 5å¹´ç”Ÿãƒ¬ãƒ™ãƒ«ä¿ºï¼ˆ50ï¼‰
    // =========================
    const g5_level1_200 = [
      {kanji:'å®‰å…¨',reading:'ã‚ã‚“ãœã‚“'},{kanji:'æ¡ˆå†…',reading:'ã‚ã‚“ãªã„'},{kanji:'ä»¥å¤–',reading:'ã„ãŒã„'},{kanji:'æ„è¦‹',reading:'ã„ã‘ã‚“'},
      {kanji:'ç§»å‹•',reading:'ã„ã©ã†'},{kanji:'ä¸€éƒ¨',reading:'ã„ã¡ã¶'},{kanji:'å°è±¡',reading:'ã„ã‚“ã—ã‚‡ã†'},{kanji:'é‹å‹•',reading:'ã†ã‚“ã©ã†'},
      {kanji:'è¡›ç”Ÿ',reading:'ãˆã„ã›ã„'},{kanji:'æ „é¤Š',reading:'ãˆã„ã‚ˆã†'},{kanji:'å¿œæ´',reading:'ãŠã†ãˆã‚“'},{kanji:'å¾€å¾©',reading:'ãŠã†ãµã'},
      {kanji:'æ¸©åº¦',reading:'ãŠã‚“ã©'},{kanji:'ä¼šè­°',reading:'ã‹ã„ã'},{kanji:'é–‹å§‹',reading:'ã‹ã„ã—'},{kanji:'è§£æ±º',reading:'ã‹ã„ã‘ã¤'},
      {kanji:'æ”¹å–„',reading:'ã‹ã„ãœã‚“'},{kanji:'æµ·å¤–',reading:'ã‹ã„ãŒã„'},{kanji:'å­¦ç´š',reading:'ãŒã£ãã‚…ã†'},{kanji:'å­¦ç¿’',reading:'ãŒãã—ã‚…ã†'},
      {kanji:'ç¢ºèª',reading:'ã‹ãã«ã‚“'},{kanji:'æ´»å‹•',reading:'ã‹ã¤ã©ã†'},{kanji:'è¦³å¯Ÿ',reading:'ã‹ã‚“ã•ã¤'},{kanji:'é–¢ä¿‚',reading:'ã‹ã‚“ã‘ã„'},
      {kanji:'æ„Ÿæƒ³',reading:'ã‹ã‚“ãã†'},{kanji:'å®Œæˆ',reading:'ã‹ã‚“ã›ã„'},{kanji:'ç°¡å˜',reading:'ã‹ã‚“ãŸã‚“'},{kanji:'è¨˜éŒ²',reading:'ãã‚ã'},
      {kanji:'å¸Œæœ›',reading:'ãã¼ã†'},{kanji:'æ©Ÿæ¢°',reading:'ãã‹ã„'},{kanji:'åŸºæœ¬',reading:'ãã»ã‚“'},{kanji:'æ±ºå®š',reading:'ã‘ã£ã¦ã„'},
      {kanji:'çµæœ',reading:'ã‘ã£ã‹'},{kanji:'å¥åº·',reading:'ã‘ã‚“ã“ã†'},{kanji:'ç ”ç©¶',reading:'ã‘ã‚“ãã‚…ã†'},{kanji:'è¦‹å­¦',reading:'ã‘ã‚“ãŒã'},
      {kanji:'ç¾é‡‘',reading:'ã’ã‚“ãã‚“'},{kanji:'ç¾å ´',reading:'ã’ã‚“ã°'},{kanji:'å·¥å¤«',reading:'ããµã†'},{kanji:'åŒºåˆ¥',reading:'ãã¹ã¤'},
      {kanji:'è¨ˆç”»',reading:'ã‘ã„ã‹ã'},{kanji:'çµŒé¨“',reading:'ã‘ã„ã‘ã‚“'},{kanji:'æ™¯è‰²',reading:'ã‘ã—ã'},{kanji:'çµè«–',reading:'ã‘ã¤ã‚ã‚“'},
      {kanji:'åŸå› ',reading:'ã’ã‚“ã„ã‚“'},{kanji:'å·¥å ´',reading:'ã“ã†ã˜ã‚‡ã†'},{kanji:'äº¤é€š',reading:'ã“ã†ã¤ã†'},{kanji:'å…¬åœ’',reading:'ã“ã†ãˆã‚“'},
      {kanji:'å…¬å¹³',reading:'ã“ã†ã¸ã„'},{kanji:'åŠ¹ç‡',reading:'ã“ã†ã‚Šã¤'},{kanji:'è¡Œäº‹',reading:'ãã‚‡ã†ã˜'},{kanji:'æœ€åˆ',reading:'ã•ã„ã—ã‚‡'},
      {kanji:'æœ€å¾Œ',reading:'ã•ã„ã”'},{kanji:'æœ€è¿‘',reading:'ã•ã„ãã‚“'},{kanji:'ä½œæ¥­',reading:'ã•ãã‚‡ã†'},{kanji:'ä½œå“',reading:'ã•ãã²ã‚“'},
      {kanji:'ä½œæˆ',reading:'ã•ãã›ã„'},{kanji:'å‚åŠ ',reading:'ã•ã‚“ã‹'},{kanji:'å‚è€ƒ',reading:'ã•ã‚“ã“ã†'},{kanji:'è³›æˆ',reading:'ã•ã‚“ã›ã„'},
      {kanji:'æ®‹å¿µ',reading:'ã–ã‚“ã­ã‚“'},{kanji:'è³‡æ–™',reading:'ã—ã‚Šã‚‡ã†'},{kanji:'æŒ‡å°',reading:'ã—ã©ã†'},{kanji:'æ”¯åº¦',reading:'ã—ãŸã'},
      {kanji:'å¤±æ•—',reading:'ã—ã£ã±ã„'},{kanji:'å®Ÿé¨“',reading:'ã˜ã£ã‘ã‚“'},{kanji:'å®Ÿè¡Œ',reading:'ã˜ã£ã“ã†'},{kanji:'å®Ÿéš›',reading:'ã˜ã£ã•ã„'},
      {kanji:'ååˆ†',reading:'ã˜ã‚…ã†ã¶ã‚“'},{kanji:'å‡ºå¸­',reading:'ã—ã‚…ã£ã›ã'},{kanji:'å‡ºç™º',reading:'ã—ã‚…ã£ã±ã¤'},{kanji:'æº–å‚™',reading:'ã˜ã‚…ã‚“ã³'},
      {kanji:'é †ç•ª',reading:'ã˜ã‚…ã‚“ã°ã‚“'},{kanji:'å°†æ¥',reading:'ã—ã‚‡ã†ã‚‰ã„'},{kanji:'æ‹›å¾…',reading:'ã—ã‚‡ã†ãŸã„'},{kanji:'æ¶ˆè²»',reading:'ã—ã‚‡ã†ã²'},
      {kanji:'å•†å“',reading:'ã—ã‚‡ã†ã²ã‚“'},{kanji:'ç´¹ä»‹',reading:'ã—ã‚‡ã†ã‹ã„'},{kanji:'æƒ…å ±',reading:'ã˜ã‚‡ã†ã»ã†'},{kanji:'æ¡ä»¶',reading:'ã˜ã‚‡ã†ã‘ã‚“'},
      {kanji:'æ•´ç†',reading:'ã›ã„ã‚Š'},{kanji:'åˆ¶åº¦',reading:'ã›ã„ã©'},{kanji:'æˆé•·',reading:'ã›ã„ã¡ã‚‡ã†'},{kanji:'æˆåŠŸ',reading:'ã›ã„ã“ã†'},
      {kanji:'æ­£ç¢º',reading:'ã›ã„ã‹ã'},{kanji:'èª¬æ˜',reading:'ã›ã¤ã‚ã„'},{kanji:'è¨­å‚™',reading:'ã›ã¤ã³'},{kanji:'é¸æŠ',reading:'ã›ã‚“ãŸã'},
      {kanji:'é¸æ‰‹',reading:'ã›ã‚“ã—ã‚…'},{kanji:'å…¨ä½“',reading:'ãœã‚“ãŸã„'},{kanji:'ç›¸è«‡',reading:'ãã†ã ã‚“'},{kanji:'æƒ³åƒ',reading:'ãã†ãã†'},
      {kanji:'é€Ÿåº¦',reading:'ããã©'},{kanji:'æ¸¬å®š',reading:'ããã¦ã„'},{kanji:'é€”ä¸­',reading:'ã¨ã¡ã‚…ã†'},{kanji:'åˆ°ç€',reading:'ã¨ã†ã¡ã‚ƒã'},
      {kanji:'å½“ç„¶',reading:'ã¨ã†ãœã‚“'},{kanji:'ç‰¹åˆ¥',reading:'ã¨ãã¹ã¤'},{kanji:'ç‰¹å¾´',reading:'ã¨ãã¡ã‚‡ã†'},{kanji:'åŠªåŠ›',reading:'ã©ã‚Šã‚‡ã'},
      {kanji:'å†…å®¹',reading:'ãªã„ã‚ˆã†'},{kanji:'æ—¥ç¨‹',reading:'ã«ã£ã¦ã„'},{kanji:'å…¥å ´',reading:'ã«ã‚…ã†ã˜ã‚‡ã†'},{kanji:'å…¥å­¦',reading:'ã«ã‚…ã†ãŒã'},
      {kanji:'ç™ºè¡¨',reading:'ã¯ã£ã´ã‚‡ã†'},{kanji:'ç™ºè¦‹',reading:'ã¯ã£ã‘ã‚“'},{kanji:'åå¯¾',reading:'ã¯ã‚“ãŸã„'},{kanji:'åˆ¤æ–­',reading:'ã¯ã‚“ã ã‚“'},
      {kanji:'å¿…è¦',reading:'ã²ã¤ã‚ˆã†'},{kanji:'è¡¨ç¾',reading:'ã²ã‚‡ã†ã’ã‚“'},{kanji:'è©•ä¾¡',reading:'ã²ã‚‡ã†ã‹'},{kanji:'è²»ç”¨',reading:'ã²ã‚ˆã†'},
      {kanji:'ä¸è¶³',reading:'ãµãã'},{kanji:'éƒ¨åˆ†',reading:'ã¶ã¶ã‚“'},{kanji:'åˆ†é¡',reading:'ã¶ã‚“ã‚‹ã„'},{kanji:'å¤‰åŒ–',reading:'ã¸ã‚“ã‹'},
      {kanji:'å¤‰æ›´',reading:'ã¸ã‚“ã“ã†'},{kanji:'å ±å‘Š',reading:'ã»ã†ã“ã'},{kanji:'æ–¹æ³•',reading:'ã»ã†ã»ã†'},{kanji:'é˜²ç½',reading:'ã¼ã†ã•ã„'},
      {kanji:'é˜²æ­¢',reading:'ã¼ã†ã—'},{kanji:'æ”¾é€',reading:'ã»ã†ãã†'},{kanji:'æº€è¶³',reading:'ã¾ã‚“ãã'},{kanji:'ç›®çš„',reading:'ã‚‚ãã¦ã'},
      {kanji:'ç›®æ¨™',reading:'ã‚‚ãã²ã‚‡ã†'},{kanji:'å½¹å‰²',reading:'ã‚„ãã‚ã‚Š'},{kanji:'äºˆå®š',reading:'ã‚ˆã¦ã„'},{kanji:'ç†ç”±',reading:'ã‚Šã‚†ã†'},
      {kanji:'åˆ©ç”¨',reading:'ã‚Šã‚ˆã†'},{kanji:'ç†è§£',reading:'ã‚Šã‹ã„'},{kanji:'ç·´ç¿’',reading:'ã‚Œã‚“ã—ã‚…ã†'},{kanji:'é€£çµ¡',reading:'ã‚Œã‚“ã‚‰ã'},
      {kanji:'å‰²åˆ',reading:'ã‚ã‚Šã‚ã„'},{kanji:'å¹³å‡',reading:'ã¸ã„ãã‚“'},{kanji:'æ¯”è¼ƒ',reading:'ã²ã‹ã'},{kanji:'å“è³ª',reading:'ã²ã‚“ã—ã¤'},
      {kanji:'é…é”',reading:'ã¯ã„ãŸã¤'},{kanji:'è²©å£²',reading:'ã¯ã‚“ã°ã„'},{kanji:'æå‡º',reading:'ã¦ã„ã—ã‚…ã¤'},{kanji:'ç‚¹æ¤œ',reading:'ã¦ã‚“ã‘ã‚“'},
      {kanji:'é€šçŸ¥',reading:'ã¤ã†ã¡'},{kanji:'è»¢é€',reading:'ã¦ã‚“ãã†'},{kanji:'å…¥åŠ›',reading:'ã«ã‚…ã†ã‚Šã‚‡ã'},{kanji:'ä¿å­˜',reading:'ã»ãã‚“'},
      {kanji:'è£œåŠ©',reading:'ã»ã˜ã‚‡'},{kanji:'ç„¡æ–™',reading:'ã‚€ã‚Šã‚‡ã†'},{kanji:'æ˜ç¢º',reading:'ã‚ã„ã‹ã'},{kanji:'å•é¡Œ',reading:'ã‚‚ã‚“ã ã„'},
      {kanji:'å„ªå…ˆ',reading:'ã‚†ã†ã›ã‚“'},{kanji:'äºˆç®—',reading:'ã‚ˆã•ã‚“'},{kanji:'äºˆæ¸¬',reading:'ã‚ˆãã'},{kanji:'è¦ç‚¹',reading:'ã‚ˆã†ã¦ã‚“'},
      {kanji:'è¦æœ›',reading:'ã‚ˆã†ã¼ã†'},{kanji:'åˆ©ç›Š',reading:'ã‚Šãˆã'},{kanji:'æ—…è¡Œ',reading:'ã‚Šã‚‡ã“ã†'},{kanji:'é€£ç¶š',reading:'ã‚Œã‚“ãã'},
      {kanji:'å¢—åŠ ',reading:'ãã†ã‹'},{kanji:'å¯¾ç­–',reading:'ãŸã„ã•ã'},{kanji:'å¯¾å¿œ',reading:'ãŸã„ãŠã†'},{kanji:'ä»£è¡¨',reading:'ã ã„ã²ã‚‡ã†'},
      {kanji:'èª¿æŸ»',reading:'ã¡ã‚‡ã†ã•'},{kanji:'èª¿æ•´',reading:'ã¡ã‚‡ã†ã›ã„'},{kanji:'é©åˆ‡',reading:'ã¦ãã›ã¤'},{kanji:'ç‹¬ç«‹',reading:'ã©ãã‚Šã¤'},
      {kanji:'ç´å¾—',reading:'ãªã£ã¨ã'},{kanji:'ä¸å®‰',reading:'ãµã‚ã‚“'},{kanji:'ä¸ä¾¿',reading:'ãµã¹ã‚“'},{kanji:'è² æ‹…',reading:'ãµãŸã‚“'},
      {kanji:'éƒ¨å“',reading:'ã¶ã²ã‚“'},{kanji:'åˆ†æ',reading:'ã¶ã‚“ã›ã'},{kanji:'é¢ç©',reading:'ã‚ã‚“ã›ã'},{kanji:'æ¯å›',reading:'ã¾ã„ã‹ã„'},
      {kanji:'æœªæ¥',reading:'ã¿ã‚‰ã„'},{kanji:'æœ¬ç•ª',reading:'ã»ã‚“ã°ã‚“'},{kanji:'å†…å´',reading:'ã†ã¡ãŒã‚'},{kanji:'ç›¸æ‰‹',reading:'ã‚ã„ã¦'},
      {kanji:'æ¬¡ç¬¬',reading:'ã—ã ã„'},{kanji:'ç¨‹åº¦',reading:'ã¦ã„ã©'},{kanji:'é€šè·¯',reading:'ã¤ã†ã‚'},{kanji:'é¢¨æ™¯',reading:'ãµã†ã‘ã„'},
      {kanji:'ä¿®ç†',reading:'ã—ã‚…ã†ã‚Š'},{kanji:'æ•´ç†åˆ¸',reading:'ã›ã„ã‚Šã‘ã‚“'},{kanji:'å¤§åˆ‡',reading:'ãŸã„ã›ã¤'},{kanji:'è¨˜å¿µ',reading:'ãã­ã‚“'},
      {kanji:'å”åŠ›',reading:'ãã‚‡ã†ã‚Šã‚‡ã'},{kanji:'å…±åŒ',reading:'ãã‚‡ã†ã©ã†'},{kanji:'è¡¨é¢',reading:'ã²ã‚‡ã†ã‚ã‚“'},{kanji:'ç›®çš„åœ°',reading:'ã‚‚ãã¦ãã¡'},
      {kanji:'æ±ºå¿ƒ',reading:'ã‘ã£ã—ã‚“'},{kanji:'æ³¨æ„',reading:'ã¡ã‚…ã†ã„'},{kanji:'ç¢ºèªæ›¸',reading:'ã‹ãã«ã‚“ã—ã‚‡'},{kanji:'é€£ä¼‘',reading:'ã‚Œã‚“ãã‚…ã†'},
      {kanji:'ä¼‘æ—¥',reading:'ãã‚…ã†ã˜ã¤'},{kanji:'è¿”äº‹',reading:'ã¸ã‚“ã˜'},{kanji:'é›†åˆ',reading:'ã—ã‚…ã†ã”ã†'},{kanji:'å‡ºæ¬ ',reading:'ã—ã‚…ã£ã‘ã¤'}
    ];
    // â†‘200å€‹ï¼ˆé‡è¤‡ãªã—æƒ³å®šï¼‰ã€‚è¶³ã‚Šãªã„å ´åˆã¯æœ«å°¾ã«å¢—ã‚„ã›ã¾ã™ã€‚

    const g5_level2_200 = [
      {kanji:'è³‡æº',reading:'ã—ã’ã‚“'},{kanji:'æ”¯æ´',reading:'ã—ãˆã‚“'},{kanji:'è‡ªç„¶',reading:'ã—ãœã‚“'},{kanji:'ç½å®³',reading:'ã•ã„ãŒã„'},
      {kanji:'ç½å®³å¯¾ç­–',reading:'ã•ã„ãŒã„ãŸã„ã•ã'},{kanji:'é˜²ç½è¨“ç·´',reading:'ã¼ã†ã•ã„ãã‚“ã‚Œã‚“'},{kanji:'å·¥æ¥­',reading:'ã“ã†ãã‚‡ã†'},{kanji:'ç”£æ¥­',reading:'ã•ã‚“ãã‚‡ã†'},
      {kanji:'è¼¸å…¥',reading:'ã‚†ã«ã‚…ã†'},{kanji:'è¼¸å‡º',reading:'ã‚†ã—ã‚…ã¤'},{kanji:'åŸæ–™',reading:'ã’ã‚“ã‚Šã‚‡ã†'},{kanji:'åŠ å·¥',reading:'ã‹ã“ã†'},
      {kanji:'è£½é€ ',reading:'ã›ã„ãã†'},{kanji:'ç”Ÿç”£',reading:'ã›ã„ã•ã‚“'},{kanji:'è£½å“',reading:'ã›ã„ã²ã‚“'},{kanji:'éƒ¨å“',reading:'ã¶ã²ã‚“'},
      {kanji:'å“è³ªç®¡ç†',reading:'ã²ã‚“ã—ã¤ã‹ã‚“ã‚Š'},{kanji:'åŠ¹ç‡åŒ–',reading:'ã“ã†ã‚Šã¤ã‹'},{kanji:'æ©Ÿæ¢°åŒ–',reading:'ãã‹ã„ã‹'},{kanji:'æƒ…å ±åŒ–',reading:'ã˜ã‚‡ã†ã»ã†ã‹'},
      {kanji:'æµé€š',reading:'ã‚Šã‚…ã†ã¤ã†'},{kanji:'æ¶ˆè²»è€…',reading:'ã—ã‚‡ã†ã²ã—ã‚ƒ'},{kanji:'ç”Ÿç”£è€…',reading:'ã›ã„ã•ã‚“ã—ã‚ƒ'},{kanji:'ä¾¡æ ¼',reading:'ã‹ã‹ã'},
      {kanji:'è²»ç”¨',reading:'ã²ã‚ˆã†'},{kanji:'åˆ©ç›Š',reading:'ã‚Šãˆã'},{kanji:'èµ¤å­—',reading:'ã‚ã‹ã˜'},{kanji:'é»’å­—',reading:'ãã‚ã˜'},
      {kanji:'äºˆç®—',reading:'ã‚ˆã•ã‚“'},{kanji:'æ±ºç®—',reading:'ã‘ã£ã•ã‚“'},{kanji:'å¥‘ç´„',reading:'ã‘ã„ã‚„ã'},{kanji:'ä¿è¨¼',reading:'ã»ã—ã‚‡ã†'},
      {kanji:'åˆ¶åº¦',reading:'ã›ã„ã©'},{kanji:'è¦å‰‡',reading:'ããã'},{kanji:'è¦åˆ¶',reading:'ãã›ã„'},{kanji:'è¨±å¯',reading:'ãã‚‡ã‹'},
      {kanji:'æ‰¿èª',reading:'ã—ã‚‡ã†ã«ã‚“'},{kanji:'ç”³è«‹',reading:'ã—ã‚“ã›ã„'},{kanji:'æ‰‹ç¶š',reading:'ã¦ã¤ã¥ã'},
      {kanji:'èª¿æŸ»',reading:'ã¡ã‚‡ã†ã•'},{kanji:'çµ±è¨ˆ',reading:'ã¨ã†ã‘ã„'},{kanji:'åˆ†æ',reading:'ã¶ã‚“ã›ã'},{kanji:'çµæœ',reading:'ã‘ã£ã‹'},
      {kanji:'æ ¹æ‹ ',reading:'ã“ã‚“ãã‚‡'},{kanji:'ç†ç”±',reading:'ã‚Šã‚†ã†'},{kanji:'çµè«–',reading:'ã‘ã¤ã‚ã‚“'},{kanji:'ä»®èª¬',reading:'ã‹ã›ã¤'},
      {kanji:'æ¤œè¨¼',reading:'ã‘ã‚“ã—ã‚‡ã†'},{kanji:'è¦³å¯Ÿ',reading:'ã‹ã‚“ã•ã¤'},{kanji:'å®Ÿé¨“',reading:'ã˜ã£ã‘ã‚“'},{kanji:'æ¸¬å®š',reading:'ããã¦ã„'},
      {kanji:'è¨˜éŒ²',reading:'ãã‚ã'},{kanji:'æ¯”è¼ƒ',reading:'ã²ã‹ã'},{kanji:'å¤‰åŒ–',reading:'ã¸ã‚“ã‹'},{kanji:'å¤‰å‹•',reading:'ã¸ã‚“ã©ã†'},
      {kanji:'æ¸©æš–',reading:'ãŠã‚“ã ã‚“'},{kanji:'å†·å´',reading:'ã‚Œã„ãã‚ƒã'},{kanji:'è’¸ç™º',reading:'ã˜ã‚‡ã†ã¯ã¤'},{kanji:'çµéœ²',reading:'ã‘ã¤ã‚'},
      {kanji:'ç‡ƒç„¼',reading:'ã­ã‚“ã—ã‚‡ã†'},{kanji:'é…¸ç´ ',reading:'ã•ã‚“ã'},{kanji:'æ°—ä½“',reading:'ããŸã„'},{kanji:'æ¶²ä½“',reading:'ãˆããŸã„'},
      {kanji:'å›ºä½“',reading:'ã“ãŸã„'},{kanji:'é›»æµ',reading:'ã§ã‚“ã‚Šã‚…ã†'},{kanji:'é›»æ± ',reading:'ã§ã‚“ã¡'},{kanji:'å›è·¯',reading:'ã‹ã„ã‚'},
      {kanji:'ç™ºé›»',reading:'ã¯ã¤ã§ã‚“'},{kanji:'ç£çŸ³',reading:'ã˜ã—ã‚ƒã'},{kanji:'é›»ç£çŸ³',reading:'ã§ã‚“ã˜ã—ã‚ƒã'},{kanji:'å°ä½“',reading:'ã©ã†ãŸã„'},
      {kanji:'çµ¶ç¸ä½“',reading:'ãœã¤ãˆã‚“ãŸã„'},{kanji:'æ‘©æ“¦',reading:'ã¾ã•ã¤'},{kanji:'åå°„',reading:'ã¯ã‚“ã—ã‚ƒ'},{kanji:'å±ˆæŠ˜',reading:'ãã£ã›ã¤'},
      {kanji:'éŸ³é€Ÿ',reading:'ãŠã‚“ãã'},{kanji:'æŒ¯å‹•',reading:'ã—ã‚“ã©ã†'},{kanji:'æ³¢é•·',reading:'ã¯ã¡ã‚‡ã†'},{kanji:'æ˜Ÿåº§',reading:'ã›ã„ã–'},
      {kanji:'è¦³æ¸¬',reading:'ã‹ã‚“ãã'},{kanji:'æ—¥é£Ÿ',reading:'ã«ã£ã—ã‚‡ã'},{kanji:'æœˆé£Ÿ',reading:'ã’ã£ã—ã‚‡ã'},{kanji:'å¤ªé™½',reading:'ãŸã„ã‚ˆã†'},
      {kanji:'åœ°å±¤',reading:'ã¡ãã†'},{kanji:'ä¾µé£Ÿ',reading:'ã—ã‚“ã—ã‚‡ã'},{kanji:'é‹æ¬',reading:'ã†ã‚“ã±ã‚“'},{kanji:'å †ç©',reading:'ãŸã„ã›ã'},
      {kanji:'æ²³å·',reading:'ã‹ã›ã‚“'},{kanji:'æµåŸŸ',reading:'ã‚Šã‚…ã†ã„ã'},{kanji:'æ°´è³‡æº',reading:'ã¿ãšã—ã’ã‚“'},{kanji:'æ£®æ—è³‡æº',reading:'ã—ã‚“ã‚Šã‚“ã—ã’ã‚“'},
      {kanji:'äº¤é€šç¶²',reading:'ã“ã†ã¤ã†ã‚‚ã†'},{kanji:'é‰„é“',reading:'ã¦ã¤ã©ã†'},{kanji:'æ¸¯',reading:'ã¿ãªã¨'},{kanji:'ç©ºæ¸¯',reading:'ãã†ã“ã†'},
      {kanji:'å€‰åº«',reading:'ãã†ã“'},{kanji:'é€šä¿¡',reading:'ã¤ã†ã—ã‚“'},{kanji:'æ”¾é€å±€',reading:'ã»ã†ãã†ãã‚‡ã'},{kanji:'æƒ…å ±é€šä¿¡',reading:'ã˜ã‚‡ã†ã»ã†ã¤ã†ã—ã‚“'},
      {kanji:'åœ°éœ‡',reading:'ã˜ã—ã‚“'},{kanji:'ç«å±±',reading:'ã‹ã–ã‚“'},{kanji:'å™´ç«',reading:'ãµã‚“ã‹'},{kanji:'æ´¥æ³¢',reading:'ã¤ãªã¿'},
      {kanji:'é¿é›£',reading:'ã²ãªã‚“'},{kanji:'é¿é›£æ‰€',reading:'ã²ãªã‚“ã˜ã‚‡'},{kanji:'å¾©æ—§',reading:'ãµã£ãã‚…ã†'},{kanji:'å¾©èˆˆ',reading:'ãµã£ã“ã†'},
      {kanji:'ç¯€é›»',reading:'ã›ã¤ã§ã‚“'},{kanji:'å†åˆ©ç”¨',reading:'ã•ã„ã‚Šã‚ˆã†'},{kanji:'å†ç”Ÿ',reading:'ã•ã„ã›ã„'},{kanji:'è³‡æºå›å',reading:'ã—ã’ã‚“ã‹ã„ã—ã‚…ã†'},
      {kanji:'ç’°å¢ƒ',reading:'ã‹ã‚“ãã‚‡ã†'},{kanji:'ä¿è­·',reading:'ã»ã”'},{kanji:'æ±šæŸ“',reading:'ãŠã›ã‚“'},{kanji:'å¯¾ç­–',reading:'ãŸã„ã•ã'},
      {kanji:'å–çµ„',reading:'ã¨ã‚Šãã¿'},{kanji:'æ”¹å–„',reading:'ã‹ã„ãœã‚“'},{kanji:'èª²é¡Œ',reading:'ã‹ã ã„'},{kanji:'è§£æ±º',reading:'ã‹ã„ã‘ã¤'},
      {kanji:'ææ¡ˆ',reading:'ã¦ã„ã‚ã‚“'},{kanji:'å®Ÿæ–½',reading:'ã˜ã£ã—'},{kanji:'å®Ÿç¾',reading:'ã˜ã¤ã’ã‚“'},{kanji:'é”æˆ',reading:'ãŸã£ã›ã„'},
      {kanji:'ç›®æ¨™',reading:'ã‚‚ãã²ã‚‡ã†'},{kanji:'è¨ˆç”»',reading:'ã‘ã„ã‹ã'},{kanji:'å·¥ç¨‹',reading:'ã“ã†ã¦ã„'},{kanji:'æ‰‹é †',reading:'ã¦ã˜ã‚…ã‚“'},
      {kanji:'é †åº',reading:'ã˜ã‚…ã‚“ã˜ã‚‡'},{kanji:'æ¡ä»¶',reading:'ã˜ã‚‡ã†ã‘ã‚“'},{kanji:'åˆ¶é™',reading:'ã›ã„ã’ã‚“'},{kanji:'çœç•¥',reading:'ã—ã‚‡ã†ã‚Šã‚ƒã'},
      {kanji:'è¦‹ç›´ã—',reading:'ã¿ãªãŠã—'},{kanji:'ç‚¹æ¤œ',reading:'ã¦ã‚“ã‘ã‚“'},{kanji:'æ¤œæŸ»',reading:'ã‘ã‚“ã•'},{kanji:'ç¢ºèª',reading:'ã‹ãã«ã‚“'},
      {kanji:'è²¬ä»»',reading:'ã›ãã«ã‚“'},{kanji:'å½¹å‰²',reading:'ã‚„ãã‚ã‚Š'},{kanji:'åˆ†æ‹…',reading:'ã¶ã‚“ãŸã‚“'},{kanji:'å”åŠ›',reading:'ãã‚‡ã†ã‚Šã‚‡ã'},
      {kanji:'é€£æº',reading:'ã‚Œã‚“ã‘ã„'},{kanji:'å…±æœ‰',reading:'ãã‚‡ã†ã‚†ã†'},{kanji:'é€£çµ¡',reading:'ã‚Œã‚“ã‚‰ã'},{kanji:'ç›¸è«‡',reading:'ãã†ã ã‚“'},
      {kanji:'èª¿æ•´',reading:'ã¡ã‚‡ã†ã›ã„'},{kanji:'å¯¾å¿œ',reading:'ãŸã„ãŠã†'},{kanji:'èª¬æ˜',reading:'ã›ã¤ã‚ã„'},{kanji:'å ±å‘Š',reading:'ã»ã†ã“ã'},
      {kanji:'æ„è¦‹',reading:'ã„ã‘ã‚“'},{kanji:'è¨è«–',reading:'ã¨ã†ã‚ã‚“'},{kanji:'çµè«–',reading:'ã‘ã¤ã‚ã‚“'},{kanji:'ã¾ã¨ã‚',reading:'ã¾ã¨ã‚'},
      {kanji:'è¡¨ç¾',reading:'ã²ã‚‡ã†ã’ã‚“'},{kanji:'è©•ä¾¡',reading:'ã²ã‚‡ã†ã‹'},{kanji:'åçœ',reading:'ã¯ã‚“ã›ã„'},{kanji:'æ”¹å–„ç­–',reading:'ã‹ã„ãœã‚“ã•ã'},
      {kanji:'å„ªå…ˆ',reading:'ã‚†ã†ã›ã‚“'},{kanji:'å¿…è¦',reading:'ã²ã¤ã‚ˆã†'},{kanji:'é‡è¦',reading:'ã˜ã‚…ã†ã‚ˆã†'},{kanji:'é©åˆ‡',reading:'ã¦ãã›ã¤'},
      {kanji:'å…¬å¹³',reading:'ã“ã†ã¸ã„'},{kanji:'å…¬æ­£',reading:'ã“ã†ã›ã„'},{kanji:'å¤šæ§˜',reading:'ãŸã‚ˆã†'},{kanji:'å°Šé‡',reading:'ãã‚“ã¡ã‚‡ã†'},
      {kanji:'ç†è§£',reading:'ã‚Šã‹ã„'},{kanji:'é…æ…®',reading:'ã¯ã„ã‚Šã‚‡'},{kanji:'å®‰å…¨å¯¾ç­–',reading:'ã‚ã‚“ãœã‚“ãŸã„ã•ã'},{kanji:'å¥åº·ç®¡ç†',reading:'ã‘ã‚“ã“ã†ã‹ã‚“ã‚Š'},
      {kanji:'è¡›ç”Ÿç®¡ç†',reading:'ãˆã„ã›ã„ã‹ã‚“ã‚Š'},{kanji:'æ„ŸæŸ“äºˆé˜²',reading:'ã‹ã‚“ã›ã‚“ã‚ˆã¼ã†'},{kanji:'æ¶ˆæ¯’',reading:'ã—ã‚‡ã†ã©ã'},{kanji:'æ¤œæ¸©',reading:'ã‘ã‚“ãŠã‚“'},
      {kanji:'æ „é¤Š',reading:'ãˆã„ã‚ˆã†'},{kanji:'æ¶ˆåŒ–',reading:'ã—ã‚‡ã†ã‹'},{kanji:'å‘¼å¸',reading:'ã“ãã‚…ã†'},{kanji:'å¾ªç’°',reading:'ã˜ã‚…ã‚“ã‹ã‚“'},
      {kanji:'ç­‹è‚‰',reading:'ãã‚“ã«ã'},{kanji:'éª¨æ ¼',reading:'ã“ã£ã‹ã'},{kanji:'å§¿å‹¢',reading:'ã—ã›ã„'},{kanji:'æŒä¹…åŠ›',reading:'ã˜ãã‚…ã†ã‚Šã‚‡ã'},
      {kanji:'ç¬ç™ºåŠ›',reading:'ã—ã‚…ã‚“ã±ã¤ã‚Šã‚‡ã'},{kanji:'æŸ”è»Ÿæ€§',reading:'ã˜ã‚…ã†ãªã‚“ã›ã„'},{kanji:'ç·´ç¿’',reading:'ã‚Œã‚“ã—ã‚…ã†'},{kanji:'åå¾©',reading:'ã¯ã‚“ã·ã'},
      {kanji:'è¨˜éŒ²æ›´æ–°',reading:'ãã‚ãã“ã†ã—ã‚“'},{kanji:'é”æˆæ„Ÿ',reading:'ãŸã£ã›ã„ã‹ã‚“'},{kanji:'æˆé•·',reading:'ã›ã„ã¡ã‚‡ã†'},{kanji:'ç¶™ç¶š',reading:'ã‘ã„ãã'},
      {kanji:'ç¿’æ…£',reading:'ã—ã‚…ã†ã‹ã‚“'},{kanji:'æ”¹å–„ç‚¹',reading:'ã‹ã„ãœã‚“ã¦ã‚“'},{kanji:'ã¾ã¨ã‚æ–¹',reading:'ã¾ã¨ã‚ã‹ãŸ'},{kanji:'è³‡æ–™ä½œæˆ',reading:'ã—ã‚Šã‚‡ã†ã•ãã›ã„'},
      {kanji:'ç™ºè¡¨è³‡æ–™',reading:'ã¯ã£ã´ã‚‡ã†ã—ã‚Šã‚‡ã†'},{kanji:'å›³è¡¨',reading:'ãšã²ã‚‡ã†'},{kanji:'ã‚°ãƒ©ãƒ•',reading:'ãã‚‰ãµ'},{kanji:'è¡¨',reading:'ã²ã‚‡ã†'}
    ];
    // â†‘200å€‹æƒ³å®šã€‚å¿…è¦ãªã‚‰ã“ã®é…åˆ—ã«è¿½åŠ ã—ã¦ã‚‚OKã€‚

    const g5_ore_50 = [
      {kanji:'æª¸æª¬',reading:'ã‚Œã‚‚ã‚“'},{kanji:'è‘¡è„',reading:'ã¶ã©ã†'},{kanji:'çˆç²',reading:'ã“ãƒ¼ã²ãƒ¼'},{kanji:'èƒ¡æ¤’',reading:'ã“ã—ã‚‡ã†'},
      {kanji:'èœœæŸ‘',reading:'ã¿ã‹ã‚“'},{kanji:'æ—æª',reading:'ã‚Šã‚“ã”'},{kanji:'å›£æ‰‡',reading:'ã†ã¡ã‚'},{kanji:'æç¯',reading:'ã¡ã‚‡ã†ã¡ã‚“'},
      {kanji:'è•éº¦',reading:'ãã°'},{kanji:'é¥‚é£©',reading:'ã†ã©ã‚“'},{kanji:'æ¤…å­',reading:'ã„ã™'},{kanji:'çœ¼é¡',reading:'ã‚ãŒã­'},
      {kanji:'ç…™è‰',reading:'ãŸã°ã“'},{kanji:'å†™çœŸ',reading:'ã—ã‚ƒã—ã‚“'},{kanji:'ç ‚ç³–',reading:'ã•ã¨ã†'},{kanji:'å‡ºç´',reading:'ã™ã„ã¨ã†'},
      {kanji:'åœŸç”£',reading:'ã¿ã‚„ã’'},{kanji:'äº”æœˆé›¨',reading:'ã•ã¿ã ã‚Œ'},{kanji:'æ™‚é›¨',reading:'ã—ãã‚Œ'},{kanji:'æœ¨æ¯',reading:'ã“ãŒã‚‰ã—'},
      {kanji:'ç§‹åˆ€é­š',reading:'ã•ã‚“ã¾'},{kanji:'é¯–',reading:'ã•ã°'},{kanji:'é°¯',reading:'ã„ã‚ã—'},{kanji:'é¯µ',reading:'ã‚ã˜'},
      {kanji:'é®­',reading:'ã•ã‘'},{kanji:'é±ˆ',reading:'ãŸã‚‰'},{kanji:'æµ·è±š',reading:'ã„ã‚‹ã‹'},{kanji:'è™è ',reading:'ã“ã†ã‚‚ã‚Š'},
      {kanji:'èœ¥èœ´',reading:'ã¨ã‹ã’'},{kanji:'è›è“',reading:'ãªã‚ãã˜'},{kanji:'èœ»è›‰',reading:'ã¨ã‚“ã¼'},{kanji:'èœ˜è››',reading:'ãã‚‚'},
      {kanji:'è–”è–‡',reading:'ã°ã‚‰'},{kanji:'å‘æ—¥è‘µ',reading:'ã²ã¾ã‚ã‚Š'},{kanji:'ç´«é™½èŠ±',reading:'ã‚ã˜ã•ã„'},{kanji:'è’²å…¬è‹±',reading:'ãŸã‚“ã½ã½'},
      {kanji:'èº‘èº…',reading:'ã¤ã¤ã˜'},{kanji:'èƒ¡æ¡ƒ',reading:'ãã‚‹ã¿'},{kanji:'éŠ€æ',reading:'ã„ã¡ã‚‡ã†'},{kanji:'ç„¡èŠ±æœ',reading:'ã„ã¡ã˜ã'},
      {kanji:'è¥¿ç“œ',reading:'ã™ã„ã‹'},{kanji:'å—ç“œ',reading:'ã‹ã¼ã¡ã‚ƒ'},{kanji:'èƒ¡ç“œ',reading:'ãã‚…ã†ã‚Š'},{kanji:'èŒ„å­',reading:'ãªã™'},
      {kanji:'å”è¾›å­',reading:'ã¨ã†ãŒã‚‰ã—'},{kanji:'è’Ÿè’»',reading:'ã“ã‚“ã«ã‚ƒã'},{kanji:'æµ·è‹”',reading:'ã®ã‚Š'},{kanji:'æ˜å¤ªå­',reading:'ã‚ã‚“ãŸã„ã“'},
      {kanji:'ç¾½ç¹”',reading:'ã¯ãŠã‚Š'},{kanji:'è‰å±¥',reading:'ãã†ã‚Š'}
    ];

    // =========================
    // Questions Database
    // =========================
    const questions = {
      1: [
        {kanji:'å‰£',reading:'ã¤ã‚‹ã'},{kanji:'é‰„',reading:'ã¦ã¤'},{kanji:'æœˆæ›œæ—¥',reading:'ã’ã¤ã‚ˆã†ã³'},{kanji:'å¤ä»£',reading:'ã“ã ã„'},
        {kanji:'æ–‡å­—',reading:'ã‚‚ã˜'},{kanji:'åŠ›',reading:'ã¡ã‹ã‚‰'},{kanji:'æµ·',reading:'ã†ã¿'},{kanji:'å‹‡ã¾ã—ã„',reading:'ã„ã•ã¾ã—ã„'},
        {kanji:'å§«',reading:'ã²ã‚'},{kanji:'ç›¾',reading:'ãŸã¦'},{kanji:'ç¥',reading:'ã‹ã¿'},{kanji:'èµ¤ã‚“åŠ',reading:'ã‚ã‹ã‚“ã¼ã†'},
        {kanji:'åŒå­',reading:'ãµãŸã”'}
      ],
      2: [
        {kanji:'å¹³å’Œ',reading:'ã¸ã„ã‚'},{kanji:'å‹‡è€…',reading:'ã‚†ã†ã—ã‚ƒ'},{kanji:'å³¶',reading:'ã—ã¾'},{kanji:'é‡‘è',reading:'ãã‚“ã‚†ã†'},
        {kanji:'é­”ç‹',reading:'ã¾ãŠã†'},{kanji:'åŸ',reading:'ã—ã‚'},{kanji:'é¾',reading:'ã‚Šã‚…ã†'},{kanji:'ç‹¼',reading:'ãŠãŠã‹ã¿'}
      ],
      3: [
        {kanji:'è‹±å‰åˆ©',reading:'ã„ãã‚Šã™'},{kanji:'äºœç±³åˆ©åŠ ',reading:'ã‚ã‚ã‚Šã‹'},{kanji:'å°åº¦',reading:'ã„ã‚“ã©'},{kanji:'è‘¡è„ç‰™',reading:'ã½ã‚‹ã¨ãŒã‚‹'},
        {kanji:'æª¸æª¬',reading:'ã‚Œã‚‚ã‚“'},{kanji:'è¶',reading:'ã¡ã‚‡ã†'},{kanji:'éŒå€‰å¹•åºœ',reading:'ã‹ã¾ãã‚‰ã°ããµ'},{kanji:'æºé ¼æœ',reading:'ã¿ãªã‚‚ã¨ã®ã‚ˆã‚Šã¨ã‚‚'}
      ],
      ore: [
        {kanji:'èœƒ',reading:'ã¯ã¾ãã‚Š'},{kanji:'æ‰æ¡ƒ',reading:'ã‚ãƒ¼ã‚‚ã‚“ã©'},{kanji:'å…œè¦',reading:'ã‹ã¶ã¨ãˆã³'},{kanji:'é¯£çƒè³Š',reading:'ã™ã‚‹ã‚ã„ã‹'},
        {kanji:'éŸ®',reading:'ã«ã‚‰'},{kanji:'ç',reading:'ã°ã'},{kanji:'æ´‹ç´',reading:'ã´ã‚ã®'},{kanji:'èˆ¹è™«',reading:'ãµãªã‚€ã—'}
      ],

      // â˜…è¿½åŠ ï¼š5å¹´ç”Ÿ
      g5_1: g5_level1_200,
      g5_2: g5_level2_200,
      g5_ore: g5_ore_50
    };

    // =========================
    // Weapons Database
    // =========================
    const weapons = [
      {id:1,name:'é»’é‰„ã®ç­†',desc:'åŸºæœ¬ã®æ­¦å™¨ã€‚å¢¨ã®è·¡ã§æ•µã‚’åˆ‡ã‚Šè£‚ãã€‚',rank:'common',atk:5,emoji:'ğŸ–Œï¸'},
      {id:2,name:'ä¸€ç”»ã®çŸ­å‰£',desc:'é‹­ã„ä¸€æŒ¯ã‚Šã®æ–¬æ’ƒã‚’ç¹°ã‚Šå‡ºã™ã€‚',rank:'common',atk:7,emoji:'ğŸ—¡ï¸'},
      {id:3,name:'é€£ç¶¿ã®é–',desc:'æ–‡å­—ã‚’ç¹‹ã’ã‚‹ã‚ˆã†ã«æ•µã‚’æ‹˜æŸã™ã‚‹ã€‚',rank:'common',atk:4,def:3,emoji:'â›“ï¸'},
      {id:4,name:'é›£èª­ã®ç›¾',desc:'è¤‡é›‘ãªç”»æ•°ã§æ§‹æˆã•ã‚ŒãŸå¼·å›ºãªç›¾ã€‚',rank:'uncommon',def:15,emoji:'ğŸ›¡ï¸'},
      {id:5,name:'æ°¸å­—å…«æ³•ã®å‰£',desc:'åŸºæœ¬ã®8å‹•ä½œã‚’æ¥µã‚ãŸå‰£ã€‚',rank:'rare',atk:15,def:10,emoji:'ğŸ—¡ï¸'},
      {id:6,name:'ç©¶æ¥µã®ç­†ï¼šå¤©å•“',desc:'ã™ã¹ã¦ã®æ¼¢å­—ã‚’çµ±ã¹ã‚‹ä¼èª¬ã®ç­†ã€‚',rank:'legendary',atk:50,def:20,emoji:'âœ¨'}
    ];

    // =========================
    // Enemies & Bosses
    // =========================
    const enemies = {
      1: [{name:'å¢¨æ±ã‚¹ãƒ©ã‚¤ãƒ ',emoji:'ğŸ’§',hp:30,atk:5},{name:'æ¼¢å­—ã‚´ãƒ–ãƒªãƒ³',emoji:'ğŸ‘º',hp:40,atk:8},{name:'æ–‡å­—ã‚³ã‚¦ãƒ¢ãƒª',emoji:'ğŸ¦‡',hp:25,atk:10}],
      2: [{name:'æ›¸é“ã‚ªãƒ¼ã‚¬',emoji:'ğŸ‘¹',hp:60,atk:12},{name:'ç­†ãƒ‰ãƒ©ã‚´ãƒ³',emoji:'ğŸ²',hp:80,atk:15},{name:'ç¡¯ã‚´ãƒ¼ãƒ¬ãƒ ',emoji:'ğŸ—¿',hp:100,atk:10}],
      3: [{name:'é›£èª­ã®é­”è¡“å¸«',emoji:'ğŸ§™',hp:100,atk:18},{name:'å¤æ–‡æ›¸ã®äº¡éœŠ',emoji:'ğŸ‘»',hp:80,atk:22},{name:'æ¼¢ç±ã®å®ˆè­·è€…',emoji:'ğŸ¦¾',hp:120,atk:16}],
      ore:[{name:'ç©¶æ¥µèª­å¸«',emoji:'ğŸ‘ï¸',hp:150,atk:25},{name:'è¨€éœŠã®åŒ–èº«',emoji:'ğŸ”®',hp:130,atk:30},{name:'æ–‡å­—ç¥ã®ä½¿å¾’',emoji:'âš¡',hp:180,atk:20}],

      // â˜…è¿½åŠ ï¼š5å¹´ç”Ÿç”¨ï¼ˆå°‘ã—å¼·ã•èª¿æ•´ï¼‰
      g5_1: [{name:'å­¦ç´šã‚¹ãƒ©ã‚¤ãƒ ',emoji:'ğŸŸ©',hp:45,atk:9},{name:'ç†Ÿèªã‚´ãƒ–ãƒªãƒ³',emoji:'ğŸŸ¨',hp:55,atk:11},{name:'æ¼¢å­—ã‚³ã‚¦ãƒ¢ãƒª',emoji:'ğŸŸ¦',hp:40,atk:12}],
      g5_2: [{name:'ç†ç§‘ã‚ªãƒ¼ã‚¬',emoji:'ğŸ§ª',hp:75,atk:14},{name:'ç¤¾ä¼šãƒ‰ãƒ©ã‚´ãƒ³',emoji:'ğŸ­',hp:95,atk:16},{name:'çµ±è¨ˆã‚´ãƒ¼ãƒ¬ãƒ ',emoji:'ğŸ“Š',hp:110,atk:13}],
      g5_ore:[{name:'é›£èª­ã®äº¡éœŠ',emoji:'ğŸ‘»',hp:120,atk:19},{name:'å½“ã¦å­—ã®é­”è¡“å¸«',emoji:'ğŸ§™',hp:140,atk:20},{name:'æ¼¢å­—ç¥ã®ä½¿å¾’',emoji:'âš¡',hp:160,atk:18}]
    };

    const bosses = {
      1:{name:'å¢¨æŸ“ã‚ã®å¤§è›‡',emoji:'ğŸ',hp:100,atk:15},
      2:{name:'æ›¸é“ç‹ã‚ªãƒ­ãƒ',emoji:'ğŸ‰',hp:180,atk:22},
      3:{name:'æ¼¢å­—å¸ãƒ¤ãƒã‚¿',emoji:'ğŸ‘‘',hp:280,atk:30},
      ore:{name:'ã€ç©¶æ¥µã€‘æ–‡å­—ç¥ã‚«ãƒ³ã‚¸',emoji:'ğŸŒŸ',hp:500,atk:40},

      // â˜…è¿½åŠ ï¼š5å¹´ç”Ÿãƒœã‚¹
      g5_1:{name:'ã€5å¹´ç”ŸLv1ã€‘ç†Ÿèªãƒœã‚¹',emoji:'ğŸ¦',hp:160,atk:18},
      g5_2:{name:'ã€5å¹´ç”ŸLv2ã€‘ç†ç¤¾ãƒœã‚¹',emoji:'ğŸ²',hp:220,atk:22},
      g5_ore:{name:'ã€5å¹´ç”ŸLvä¿ºã€‘é›£èª­ç‹',emoji:'ğŸ‘‘',hp:320,atk:28}
    };

    // =========================
    // Flick Input Layout (3åˆ—åŒºåˆ‡ã‚Š)
    // =========================
    const flickLayout = [
      ['ã‚','ã‹','ã•'],
      ['ãŸ','ãª','ã¯'],
      ['ã¾','ã‚„','ã‚‰'],
      ['','ã‚','âŒ«'],
      ['ã‚›','ã‚œ','å°'],
      ['ãƒ¼','','']
    ];

    const flickMap = {
      'ã‚': {center:'ã‚',up:'ã†',down:'ãŠ',left:'ã„',right:'ãˆ'},
      'ã‹': {center:'ã‹',up:'ã',down:'ã“',left:'ã',right:'ã‘'},
      'ã•': {center:'ã•',up:'ã™',down:'ã',left:'ã—',right:'ã›'},
      'ãŸ': {center:'ãŸ',up:'ã¤',down:'ã¨',left:'ã¡',right:'ã¦'},
      'ãª': {center:'ãª',up:'ã¬',down:'ã®',left:'ã«',right:'ã­'},
      'ã¯': {center:'ã¯',up:'ãµ',down:'ã»',left:'ã²',right:'ã¸'},
      'ã¾': {center:'ã¾',up:'ã‚€',down:'ã‚‚',left:'ã¿',right:'ã‚'},
      'ã‚„': {center:'ã‚„',up:'ã‚†',down:'ã‚ˆ',left:'ï¼ˆ',right:'ï¼‰'},
      'ã‚‰': {center:'ã‚‰',up:'ã‚‹',down:'ã‚',left:'ã‚Š',right:'ã‚Œ'},
      'ã‚': {center:'ã‚',up:'ã‚“',down:'ãƒ¼',left:'ã‚’',right:'ã€œ'}
    };

    const dakutenMap = {'ã‹':'ãŒ','ã':'ã','ã':'ã','ã‘':'ã’','ã“':'ã”','ã•':'ã–','ã—':'ã˜','ã™':'ãš','ã›':'ãœ','ã':'ã','ãŸ':'ã ','ã¡':'ã¢','ã¤':'ã¥','ã¦':'ã§','ã¨':'ã©','ã¯':'ã°','ã²':'ã³','ãµ':'ã¶','ã¸':'ã¹','ã»':'ã¼','ã†':'ã‚”'};
    const handakutenMap = {'ã¯':'ã±','ã²':'ã´','ãµ':'ã·','ã¸':'ãº','ã»':'ã½'};
    const smallMap = {'ã‚':'ã','ã„':'ãƒ','ã†':'ã…','ãˆ':'ã‡','ãŠ':'ã‰','ã‚„':'ã‚ƒ','ã‚†':'ã‚…','ã‚ˆ':'ã‚‡','ã¤':'ã£'};

    // =========================
    // Helpers
    // =========================
    function getRandomItem(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    function getRandomWeapon(){
      const roll=Math.random()*100;
      let rank;
      if(roll<40) rank='common';
      else if(roll<70) rank='uncommon';
      else if(roll<88) rank='rare';
      else if(roll<98) rank='epic';
      else rank='legendary';

      const pool = weapons.filter(w=>w.rank===rank);
      return getRandomItem(pool.length?pool:weapons);
    }

    function getRankColor(rank){
      const colors={common:'#9ca3af',uncommon:'#22c55e',rare:'#3b82f6',epic:'#a855f7',legendary:'#ffd700'};
      return colors[rank]||'#9ca3af';
    }
    function getRankName(rank){
      const names={common:'ã‚³ãƒ¢ãƒ³',uncommon:'ã‚¢ãƒ³ã‚³ãƒ¢ãƒ³',rare:'ãƒ¬ã‚¢',epic:'ã‚¨ãƒ”ãƒƒã‚¯',legendary:'ä¼èª¬'};
      return names[rank]||'ã‚³ãƒ¢ãƒ³';
    }

    function calculateDamage(){
      let base=gameState.playerATK;
      if(gameState.equippedWeapon) base += gameState.equippedWeapon.atk||0;
      base += gameState.combo*2;
      return base;
    }

    function getTimeLimitByDifficulty(d){
      const timeLimits = {
        1:10, 2:9, 3:8, ore:7,
        g5_1:10, g5_2:9, g5_ore:7
      };
      return timeLimits[d] ?? 10;
    }

    function spawnEnemy(){
      const diffKey = gameState.difficulty;
      const enemy = { ...getRandomItem(enemies[diffKey]) };
      gameState.currentEnemy=enemy;
      gameState.enemyHP=enemy.hp;
      gameState.enemyMaxHP=enemy.hp;
      gameState.isBossBattle=false;
    }

    function spawnBoss(){
      const diffKey = gameState.difficulty;
      const boss = { ...bosses[diffKey] };
      gameState.currentEnemy=boss;
      gameState.enemyHP=boss.hp;
      gameState.enemyMaxHP=boss.hp;
      gameState.isBossBattle=true;
    }

    // å‡ºé¡Œé‡è¤‡ã®åã‚Šã‚’å°‘ã—æ¸›ã‚‰ã™ï¼ˆç›´è¿‘ã‚’é¿ã‘ã‚‹ï¼‰
    const recentQ = [];
    function pickQuestion(list){
      if(!list || list.length===0) return null;
      for(let i=0;i<15;i++){
        const q = getRandomItem(list);
        const key = q.kanji + '|' + q.reading;
        if(!recentQ.includes(key)) return q;
      }
      return getRandomItem(list);
    }

    function getNewQuestion(){
      const diffKey = gameState.difficulty;
      const list = questions[diffKey];
      const q = pickQuestion(list);
      if(!q) return;
      const key = q.kanji + '|' + q.reading;
      recentQ.push(key);
      while(recentQ.length>30) recentQ.shift();

      gameState.currentQuestion=q;
      gameState.inputText='';
      startTimer();
    }

    function syncInputDisplay(){
      const el=document.getElementById('inputText');
      if(el) el.textContent = gameState.inputText || 'ã€€';
    }

    // =========================
    // Timer UIï¼ˆrenderã—ãªã„ï¼‰
    // =========================
    function updateTimerUI(){
      const timeEl=document.getElementById('timeText');
      const barEl=document.getElementById('timeBarFill');
      const isWarn = gameState.timeRemaining<=3;

      if(timeEl){
        timeEl.textContent=`â±ï¸ ${gameState.timeRemaining}ç§’`;
        timeEl.className=`text-sm font-bold ${isWarn?'text-red-500 time-warning':'text-yellow-400'}`;
      }
      if(barEl){
        const pct=(gameState.timeRemaining/gameState.timeLimit)*100;
        barEl.style.width=pct+'%';
        barEl.classList.toggle('warning', isWarn);
      }
    }

    function startTimer(){
      if(gameState.timerInterval) clearInterval(gameState.timerInterval);
      gameState.timeLimit=getTimeLimitByDifficulty(gameState.difficulty);
      gameState.timeRemaining=gameState.timeLimit;
      updateTimerUI();

      gameState.timerInterval=setInterval(()=>{
        gameState.timeRemaining--;
        updateTimerUI();
        if(gameState.timeRemaining<=0){
          clearInterval(gameState.timerInterval);
          gameState.timerInterval=null;
          handleTimeOut();
        }
      },1000);
    }

    function stopTimer(){
      if(gameState.timerInterval){
        clearInterval(gameState.timerInterval);
        gameState.timerInterval=null;
      }
    }

    // =========================
    // Render
    // =========================
    function render(){
      if(gameState.screen!=='battle') stopTimer();
      const app=document.getElementById('app');
      if(!app) return;

      switch(gameState.screen){
        case 'title': renderTitleScreen(app); break;
        case 'difficulty': renderDifficultyScreen(app); break;
        case 'battle': renderBattleScreen(app); break;
        case 'victory': renderVictoryScreen(app); break;
        case 'gameOver': renderGameOverScreen(app); break;
        case 'weaponDrop': renderWeaponDropScreen(app); break;
        case 'inventory': renderInventoryScreen(app); break;
        case 'levelClear': renderLevelClearScreen(app); break;
        default: renderTitleScreen(app);
      }
    }

    // =========================
    // Screens
    // =========================
    function renderTitleScreen(container){
      container.innerHTML=`
        <div class="h-full w-full flex flex-col items-center justify-center p-4" style="background: radial-gradient(ellipse at center, #1e1e3f 0%, #0a0a1a 100%);">
          <div class="text-center mb-8">
            <h1 class="title-font text-6xl font-bold mb-4 float-anim" style="color:#ffd700;text-shadow:0 0 30px rgba(255,215,0,0.5);">æ¼¢å­—å‹‡è€…</h1>
            <p class="text-2xl text-gray-300">ã€œ èª­ã¿ã®è©¦ç·´ ã€œ</p>
          </div>

          <div class="mb-8"><div class="text-8xl float-anim" style="animation-delay:.5s;">âš”ï¸ğŸ“–</div></div>

          <div class="w-full max-w-md mb-6">
            <label class="block text-lg mb-2 text-gray-300">å‹‡è€…ã®åå‰ã‚’å…¥åŠ›ï¼ˆã“ã“ã¯ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ï¼‰</label>
            <input type="text" id="playerNameInput"
              class="w-full px-4 py-3 text-xl rounded-xl bg-gray-800 border-2 border-gray-600 focus:border-yellow-500 focus:outline-none text-white"
              placeholder="åå‰ã‚’å…¥åŠ›..."
              value="${gameState.playerName}">
          </div>

          <button onclick="startGame()"
            class="px-12 py-4 text-2xl font-bold rounded-xl pulse-glow transition-transform hover:scale-105"
            style="background:linear-gradient(145deg,#ffd700,#ffaa00);color:#1a1a2e;">
            å†’é™ºã‚’å§‹ã‚ã‚‹
          </button>

          <p class="mt-8 text-gray-500 text-sm">ãƒãƒˆãƒ«ä¸­ã®å…¥åŠ›ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰/ãƒ•ãƒªãƒƒã‚¯ï¼‰ã¯é›£æ˜“åº¦ç”»é¢ã§åˆ‡ã‚Šæ›¿ãˆ</p>
        </div>
      `;
      setTimeout(()=>{
        const el=document.getElementById('playerNameInput');
        if(el) el.focus();
      },0);
    }

    function renderDifficultyScreen(container){
      // â˜…5å¹´ç”Ÿãƒ¬ãƒ™ãƒ«ä¿ºã¯ã€Œ5å¹´ç”ŸLv1 & Lv2ã‚¯ãƒªã‚¢ã€ã§è§£æ”¾
      const canPlayG5Ore = gameState.clearedLevels.includes('g5_1') && gameState.clearedLevels.includes('g5_2');

      // æ—¢å­˜ã®ã€Œãƒ¬ãƒ™ãƒ«ä¿ºï¼ˆæ—§ï¼‰ã€ã¯1-3ã§è§£æ”¾ã®ã¾ã¾
      const canPlayOldOre = [1,2,3].every(lv=>gameState.clearedLevels.includes(lv));

      container.innerHTML=`
        <div class="h-full w-full flex flex-col items-center justify-center p-4" style="background: radial-gradient(ellipse at center, #1e1e3f 0%, #0a0a1a 100%);">
          <h2 class="title-font text-4xl font-bold mb-2" style="color:#ffd700;">é›£æ˜“åº¦ã‚’é¸æŠ</h2>
          <p class="text-xl text-gray-400 mb-4">å‹‡è€… ${gameState.playerName||'å‹‡è€…'} ã‚ˆã€æŒ‘æˆ¦ã™ã‚‹è©¦ç·´ã‚’é¸ã¹</p>

          <!-- ãƒãƒˆãƒ«å…¥åŠ› -->
          <div class="mb-4 flex items-center gap-3 bg-black/30 border border-gray-700 rounded-2xl px-4 py-3">
            <div class="text-sm text-gray-300 font-bold">ãƒãƒˆãƒ«å…¥åŠ›</div>
            <button onclick="setBattleInputMode('keyboard')"
              class="px-3 py-2 rounded-xl border-2 ${gameState.battleInputMode==='keyboard'?'border-yellow-400 bg-yellow-900/30':'border-gray-600 bg-gray-800/40 hover:bg-gray-700/40'} text-sm font-bold">
              âŒ¨ï¸ ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰
            </button>
            <button onclick="setBattleInputMode('flick')"
              class="px-3 py-2 rounded-xl border-2 ${gameState.battleInputMode==='flick'?'border-yellow-400 bg-yellow-900/30':'border-gray-600 bg-gray-800/40 hover:bg-gray-700/40'} text-sm font-bold">
              ğŸ“± ãƒ•ãƒªãƒƒã‚¯
            </button>
          </div>

          <!-- 5å¹´ç”Ÿ -->
          <div class="w-full max-w-5xl mb-5">
            <div class="text-lg font-bold text-cyan-300 mb-2">ğŸ« 5å¹´ç”Ÿãƒ¢ãƒ¼ãƒ‰</div>
            <div class="grid grid-cols-3 gap-4">
              <button onclick="selectDifficulty('g5_1')"
                class="p-6 rounded-2xl border-2 border-cyan-500 bg-cyan-900/20 hover:bg-cyan-800/35 transition-all hover:scale-105 ${gameState.clearedLevels.includes('g5_1')?'ring-2 ring-yellow-400':''}">
                <div class="text-4xl mb-2">ğŸ“—</div>
                <div class="text-2xl font-bold text-cyan-300">5å¹´ç”Ÿ ãƒ¬ãƒ™ãƒ«1</div>
                <div class="text-sm text-gray-400 mt-2">åŸºæœ¬ç†Ÿèªï¼ˆ200å•ï¼‰</div>
                <div class="text-xs text-gray-500 mt-1">10ç§’</div>
                ${gameState.clearedLevels.includes('g5_1')?'<div class="text-yellow-400 mt-2">âœ“ ã‚¯ãƒªã‚¢æ¸ˆ</div>':''}
              </button>

              <button onclick="selectDifficulty('g5_2')"
                class="p-6 rounded-2xl border-2 border-blue-500 bg-blue-900/20 hover:bg-blue-800/35 transition-all hover:scale-105 ${gameState.clearedLevels.includes('g5_2')?'ring-2 ring-yellow-400':''}">
                <div class="text-4xl mb-2">ğŸ“˜</div>
                <div class="text-2xl font-bold text-blue-300">5å¹´ç”Ÿ ãƒ¬ãƒ™ãƒ«2</div>
                <div class="text-sm text-gray-400 mt-2">ç†ç¤¾èªå½™ï¼ˆ200å•ï¼‰</div>
                <div class="text-xs text-gray-500 mt-1">9ç§’</div>
                ${gameState.clearedLevels.includes('g5_2')?'<div class="text-yellow-400 mt-2">âœ“ ã‚¯ãƒªã‚¢æ¸ˆ</div>':''}
              </button>

              <button onclick="${canPlayG5Ore ? "selectDifficulty('g5_ore')" : ''}"
                class="p-6 rounded-2xl border-2 ${canPlayG5Ore?'border-yellow-500 bg-yellow-900/25 hover:bg-yellow-800/35 hover:scale-105':'border-gray-600 bg-gray-900/30 opacity-50 cursor-not-allowed'} transition-all">
                <div class="text-4xl mb-2">${canPlayG5Ore?'ğŸ‘‘':'ğŸ”’'}</div>
                <div class="text-2xl font-bold ${canPlayG5Ore?'text-yellow-300':'text-gray-500'}">5å¹´ç”Ÿ ãƒ¬ãƒ™ãƒ«ä¿º</div>
                <div class="text-sm text-gray-400 mt-2">${canPlayG5Ore?'é›£èª­æ¼¢å­—ï¼ˆ50å•ï¼‰':'Lv1 & Lv2ã‚¯ãƒªã‚¢ã§è§£æ”¾'}</div>
                <div class="text-xs text-gray-500 mt-1">${canPlayG5Ore?'7ç§’':''}</div>
                ${gameState.clearedLevels.includes('g5_ore')?'<div class="text-yellow-400 mt-2">âœ“ ã‚¯ãƒªã‚¢æ¸ˆ</div>':''}
              </button>
            </div>
          </div>

          <!-- æ—§ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ®‹ã—ã¦ãŠãï¼‰ -->
          <div class="w-full max-w-5xl">
            <div class="text-lg font-bold text-yellow-200 mb-2">âš”ï¸ æ¼¢å­—å‹‡è€…ï¼ˆæ—§ï¼‰</div>
            <div class="grid grid-cols-4 gap-4">
              <button onclick="selectDifficulty(1)"
                class="p-6 rounded-2xl border-2 border-green-500 bg-green-900/30 hover:bg-green-800/50 transition-all hover:scale-105 ${gameState.clearedLevels.includes(1)?'ring-2 ring-yellow-400':''}">
                <div class="text-4xl mb-2">ğŸŒ±</div>
                <div class="text-2xl font-bold text-green-400">ãƒ¬ãƒ™ãƒ«1</div>
                <div class="text-sm text-gray-400 mt-2">åŸºæœ¬ã®æ¼¢å­—</div>
                <div class="text-xs text-gray-500 mt-1">10ç§’</div>
                ${gameState.clearedLevels.includes(1)?'<div class="text-yellow-400 mt-2">âœ“ ã‚¯ãƒªã‚¢æ¸ˆ</div>':''}
              </button>

              <button onclick="selectDifficulty(2)"
                class="p-6 rounded-2xl border-2 border-blue-500 bg-blue-900/30 hover:bg-blue-800/50 transition-all hover:scale-105 ${gameState.clearedLevels.includes(2)?'ring-2 ring-yellow-400':''}">
                <div class="text-4xl mb-2">âš”ï¸</div>
                <div class="text-2xl font-bold text-blue-400">ãƒ¬ãƒ™ãƒ«2</div>
                <div class="text-sm text-gray-400 mt-2">ä¸­ç´šã®æ¼¢å­—</div>
                <div class="text-xs text-gray-500 mt-1">9ç§’</div>
                ${gameState.clearedLevels.includes(2)?'<div class="text-yellow-400 mt-2">âœ“ ã‚¯ãƒªã‚¢æ¸ˆ</div>':''}
              </button>

              <button onclick="selectDifficulty(3)"
                class="p-6 rounded-2xl border-2 border-purple-500 bg-purple-900/30 hover:bg-purple-800/50 transition-all hover:scale-105 ${gameState.clearedLevels.includes(3)?'ring-2 ring-yellow-400':''}">
                <div class="text-4xl mb-2">ğŸ”¥</div>
                <div class="text-2xl font-bold text-purple-400">ãƒ¬ãƒ™ãƒ«3</div>
                <div class="text-sm text-gray-400 mt-2">é›£èª­æ¼¢å­—</div>
                <div class="text-xs text-gray-500 mt-1">8ç§’</div>
                ${gameState.clearedLevels.includes(3)?'<div class="text-yellow-400 mt-2">âœ“ ã‚¯ãƒªã‚¢æ¸ˆ</div>':''}
              </button>

              <button onclick="${canPlayOldOre ? "selectDifficulty('ore')" : ''}"
                class="p-6 rounded-2xl border-2 ${canPlayOldOre?'border-yellow-500 bg-yellow-900/30 hover:bg-yellow-800/50 hover:scale-105':'border-gray-600 bg-gray-900/30 opacity-50 cursor-not-allowed'} transition-all">
                <div class="text-4xl mb-2">${canPlayOldOre?'ğŸ‘‘':'ğŸ”’'}</div>
                <div class="text-2xl font-bold ${canPlayOldOre?'text-yellow-400':'text-gray-500'}">ãƒ¬ãƒ™ãƒ«ä¿º</div>
                <div class="text-sm text-gray-400 mt-2">${canPlayOldOre?'ç©¶æ¥µã®è©¦ç·´':'Lv1-3ã‚¯ãƒªã‚¢ã§è§£æ”¾'}</div>
                <div class="text-xs text-gray-500 mt-1">${canPlayOldOre?'7ç§’':''}</div>
              </button>
            </div>
          </div>

          <button onclick="goToInventory()"
            class="mt-5 px-8 py-3 text-lg rounded-xl bg-gray-700 hover:bg-gray-600 transition-all">
            ğŸ’ æ­¦å™¨ä¸€è¦§ (${gameState.weapons.length})
          </button>
        </div>
      `;
    }

    function renderBattleScreen(container){
      const hpPercent=(gameState.playerHP/gameState.maxHP)*100;
      const enemyHpPercent=(gameState.enemyHP/gameState.enemyMaxHP)*100;
      const isLowHP=hpPercent<30;
      const isTimeWarning=gameState.timeRemaining<=3;

      container.innerHTML=`
        <div class="h-full w-full flex flex-row battle-screen">
          <!-- Left -->
          <div class="w-1/2 flex flex-col p-4">
            <div class="bg-black/40 rounded-xl p-3 mb-3">
              <div class="flex justify-between items-center mb-2">
                <span class="text-lg font-bold">${gameState.playerName}</span>
                <span class="text-sm text-gray-400">ã‚³ãƒ³ãƒœ: ${gameState.combo}x</span>
              </div>
              <div class="hp-bar"><div class="hp-fill ${isLowHP?'low':''}" style="width:${hpPercent}%"></div></div>
              <div class="flex justify-between text-sm mt-1">
                <span>HP: ${gameState.playerHP}/${gameState.maxHP}</span>
                <span>ATK: ${calculateDamage()}</span>
              </div>
              ${gameState.equippedWeapon?`
                <div class="mt-2 text-sm text-yellow-400">${gameState.equippedWeapon.emoji} ${gameState.equippedWeapon.name}</div>
              `:''}
            </div>

            <div class="flex-1 flex flex-col items-center justify-center">
              <div class="text-center mb-4">
                <div class="enemy-sprite ${gameState.isBossBattle?'victory-glow':'float-anim'}" id="enemySprite">${gameState.currentEnemy.emoji}</div>
                <div class="text-2xl font-bold mt-2 ${gameState.isBossBattle?'text-red-400':''}">${gameState.currentEnemy.name}</div>
                ${gameState.isBossBattle?'<div class="text-red-500 text-sm">ã€BOSSã€‘</div>':''}
              </div>

              <div class="w-full max-w-xs">
                <div class="hp-bar"><div class="hp-fill enemy" style="width:${enemyHpPercent}%"></div></div>
                <div class="text-center text-sm mt-1">HP: ${gameState.enemyHP}/${gameState.enemyMaxHP}</div>
              </div>

              <div class="mt-4 text-gray-400 text-sm">
                ${gameState.isBossBattle?'ãƒœã‚¹æˆ¦ï¼':`æ’ƒç ´æ•°: ${gameState.defeatedCount}/3`}
              </div>
            </div>

            <div class="bg-black/40 rounded-xl p-3 text-center min-h-[60px]" id="messageBox">
              ${gameState.message||'æ¼¢å­—ã®èª­ã¿æ–¹ã‚’å…¥åŠ›ã›ã‚ˆï¼'}
            </div>
          </div>

          <!-- Right -->
          <div class="w-1/2 flex flex-col p-4 bg-black/20">
            <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-6 mb-3 text-center border-2 border-gray-700">
              <div class="flex justify-between items-center mb-2">
                <div class="text-sm text-gray-400">ã“ã®æ¼¢å­—ã®èª­ã¿æ–¹ã¯ï¼Ÿ</div>
                <div class="flex items-center gap-3">
                  <button onclick="pauseToDifficulty()"
                    class="px-3 py-1 rounded-lg bg-gray-700 hover:bg-gray-600 text-xs font-bold">â¸ ä¸­æ–­</button>
                  <div id="timeText" class="text-sm font-bold ${isTimeWarning?'text-red-500 time-warning':'text-yellow-400'}">â±ï¸ ${gameState.timeRemaining}ç§’</div>
                </div>
              </div>
              <div class="title-font text-5xl font-bold" style="color:#ffd700;">${gameState.currentQuestion.kanji}</div>
              <div class="time-bar mt-4"><div id="timeBarFill" class="time-bar-fill ${isTimeWarning?'warning':''}" style="width:${(gameState.timeRemaining/gameState.timeLimit)*100}%"></div></div>
            </div>

            <div class="input-display flex items-center justify-between mb-3">
              <span id="inputText">${gameState.inputText||'ã€€'}</span>
              <button onclick="submitAnswer()" class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg text-sm font-bold transition-all">æ±ºå®š</button>
            </div>

            ${gameState.battleInputMode==='keyboard'?`
              <div class="bg-black/30 border border-gray-700 rounded-2xl p-4">
                <div class="text-sm text-gray-400 mb-2">ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§å…¥åŠ›ï¼ˆEnterã§æ±ºå®šï¼‰</div>
                <input id="battleKeyboardInput"
                  class="w-full px-4 py-3 text-xl rounded-xl bg-gray-800 border-2 border-gray-600 focus:border-yellow-500 focus:outline-none text-white"
                  placeholder="ã‚ˆã¿ã‚’å…¥åŠ›..."
                  value="${gameState.inputText}"
                  oninput="onBattleKeyboardInput(this.value)"
                  onkeydown="onBattleKeyboardKeydown(event)">
              </div>
            `:`
              <div class="flex-1 flex flex-col justify-center items-center">
                ${renderFlickGridHTML("battle")}
              </div>
            `}
          </div>
        </div>
      `;

      syncInputDisplay();
      if(gameState.battleInputMode==='keyboard'){
        const el=document.getElementById('battleKeyboardInput');
        if(el) setTimeout(()=>el.focus(),0);
      }
      updateTimerUI();
    }

    function renderWeaponDropScreen(container){
      const weapon=gameState.droppedWeapon;
      container.innerHTML=`
        <div class="h-full w-full flex flex-col items-center justify-center p-4" style="background: radial-gradient(ellipse at center, #1e1e3f 0%, #0a0a1a 100%);">
          <h2 class="text-3xl font-bold mb-6 text-yellow-400">ğŸ‰ æ­¦å™¨ã‚’ç²å¾—ï¼</h2>

          <div class="weapon-card ${weapon.rank} w-80 mb-6">
            <div class="text-6xl mb-4">${weapon.emoji}</div>
            <div class="text-sm mb-2" style="color:${getRankColor(weapon.rank)}">${getRankName(weapon.rank)}</div>
            <div class="text-2xl font-bold mb-2">${weapon.name}</div>
            <div class="text-gray-400 text-sm mb-4">${weapon.desc}</div>
            <div class="flex justify-center gap-4 text-sm">
              ${weapon.atk?`<span class="text-red-400">ATK +${weapon.atk}</span>`:''}
              ${weapon.def?`<span class="text-blue-400">DEF +${weapon.def}</span>`:''}
            </div>
          </div>

          <div class="flex gap-4 flex-wrap justify-center">
            <button onclick="equipNewWeapon()"
              class="px-8 py-3 text-lg font-bold rounded-xl bg-yellow-600 hover:bg-yellow-500 transition-all">è£…å‚™ã™ã‚‹</button>

            <button onclick="continueAfterDrop()"
              class="px-8 py-3 text-lg font-bold rounded-xl bg-gray-700 hover:bg-gray-600 transition-all">ç¶šã‘ã‚‹ï¼ˆæŒã¡ç‰©ã«å…¥ã‚Œã‚‹ï¼‰</button>

            <button onclick="returnToDifficultyFromDrop()"
              class="px-8 py-3 text-lg font-bold rounded-xl bg-blue-700 hover:bg-blue-600 transition-all">é›£æ˜“åº¦é¸æŠã¸æˆ»ã‚‹</button>
          </div>
        </div>
      `;
    }

    function renderVictoryScreen(container){
      container.innerHTML=`
        <div class="h-full w-full flex flex-col items-center justify-center p-4" style="background: radial-gradient(ellipse at center, #1e3f1e 0%, #0a1a0a 100%);">
          <div class="text-8xl mb-6 victory-glow">ğŸ†</div>
          <h2 class="title-font text-5xl font-bold mb-4 text-yellow-400">å‹åˆ©ï¼</h2>
          <p class="text-2xl text-gray-300 mb-2">${gameState.playerName} ã¯ãƒœã‚¹ã‚’å€’ã—ãŸï¼</p>
          <p class="text-xl text-gray-400 mb-8">ã‚¯ãƒªã‚¢ï¼</p>
          <button onclick="goToDifficulty()" class="px-8 py-4 text-xl font-bold rounded-xl bg-yellow-600 hover:bg-yellow-500 transition-all">é›£æ˜“åº¦é¸æŠã¸</button>
        </div>
      `;
    }

    function renderGameOverScreen(container){
      container.innerHTML=`
        <div class="h-full w-full flex flex-col items-center justify-center p-4" style="background: radial-gradient(ellipse at center, #3f1e1e 0%, #1a0a0a 100%);">
          <div class="text-8xl mb-6">ğŸ’€</div>
          <h2 class="title-font text-5xl font-bold mb-4 text-red-400">æ•—åŒ—...</h2>
          <p class="text-2xl text-gray-300 mb-8">${gameState.playerName} ã¯åŠ›å°½ããŸ...</p>
          <div class="flex gap-4">
            <button onclick="retryBattle()" class="px-8 py-4 text-xl font-bold rounded-xl bg-red-600 hover:bg-red-500 transition-all">å†æŒ‘æˆ¦</button>
            <button onclick="goToDifficulty()" class="px-8 py-4 text-xl font-bold rounded-xl bg-gray-700 hover:bg-gray-600 transition-all">é›£æ˜“åº¦é¸æŠã¸</button>
          </div>
        </div>
      `;
    }

    function renderInventoryScreen(container){
      container.innerHTML=`
        <div class="h-full w-full flex flex-col p-4" style="background: radial-gradient(ellipse at center, #1e1e3f 0%, #0a0a1a 100%);">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-3xl font-bold text-yellow-400">ğŸ’ æ­¦å™¨ä¸€è¦§</h2>
            <button onclick="goToDifficulty()" class="px-6 py-2 rounded-xl bg-gray-700 hover:bg-gray-600 transition-all">æˆ»ã‚‹</button>
          </div>

          ${gameState.equippedWeapon?`
            <div class="mb-4 p-4 rounded-xl bg-yellow-900/30 border-2 border-yellow-500">
              <div class="text-sm text-yellow-400 mb-2">è£…å‚™ä¸­</div>
              <div class="flex items-center gap-4">
                <span class="text-4xl">${gameState.equippedWeapon.emoji}</span>
                <div>
                  <div class="font-bold">${gameState.equippedWeapon.name}</div>
                  <div class="text-sm text-gray-400">
                    ${gameState.equippedWeapon.atk?`ATK +${gameState.equippedWeapon.atk}`:''}
                    ${gameState.equippedWeapon.def?`DEF +${gameState.equippedWeapon.def}`:''}
                  </div>
                </div>
              </div>
            </div>
          `:'<div class="mb-4 p-4 rounded-xl bg-gray-800 text-gray-400">æ­¦å™¨æœªè£…å‚™</div>'}

          <div class="flex-1 overflow-auto">
            ${gameState.weapons.length===0?`
              <div class="text-center text-gray-500 py-8">ã¾ã æ­¦å™¨ã‚’æŒã£ã¦ã„ã¾ã›ã‚“ã€‚<br>æ•µã‚’å€’ã—ã¦æ­¦å™¨ã‚’é›†ã‚ã‚ˆã†ï¼</div>
            `:`
              <div class="grid grid-cols-5 gap-3">
                ${gameState.weapons.map((w,i)=>`
                  <div class="weapon-card ${w.rank} cursor-pointer hover:scale-105 transition-all ${gameState.equippedWeapon?.id===w.id?'ring-2 ring-yellow-400':''}"
                    onclick="equipWeapon(${i})">
                    <div class="text-3xl mb-2">${w.emoji}</div>
                    <div class="text-xs mb-1" style="color:${getRankColor(w.rank)}">${getRankName(w.rank)}</div>
                    <div class="text-sm font-bold truncate">${w.name}</div>
                    <div class="text-xs text-gray-400 mt-1">
                      ${w.atk?`ATK+${w.atk}`:''} ${w.def?`DEF+${w.def}`:''}
                    </div>
                  </div>
                `).join('')}
              </div>
            `}
          </div>
        </div>
      `;
    }

    function renderLevelClearScreen(container){
      container.innerHTML=`
        <div class="h-full w-full flex flex-col items-center justify-center p-4" style="background: radial-gradient(ellipse at center, #1e3f3f 0%, #0a1a1a 100%);">
          <div class="text-6xl mb-4">â­</div>
          <h2 class="text-3xl font-bold mb-4 text-cyan-400">ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ï¼</h2>
          <p class="text-xl text-gray-300 mb-6">3ä½“ã®æ•µã‚’æ’ƒç ´ï¼ãƒœã‚¹ãŒç¾ã‚Œã‚‹...</p>
          <button onclick="startBossBattle()" class="px-8 py-4 text-xl font-bold rounded-xl bg-red-600 hover:bg-red-500 transition-all pulse-glow">ãƒœã‚¹ã«æŒ‘ã‚€ï¼</button>
        </div>
      `;
    }

    // =========================
    // Difficulty: battle input mode
    // =========================
    function setBattleInputMode(mode){ gameState.battleInputMode=mode; render(); }
    function onBattleKeyboardInput(val){ gameState.inputText=(val||'').toLowerCase(); syncInputDisplay(); }
    function onBattleKeyboardKeydown(e){ if(e.key==='Enter'){ e.preventDefault(); submitAnswer(); } }

    // =========================
    // Game Logic
    // =========================
    function startGame(){
      const nameInput=document.getElementById('playerNameInput');
      gameState.playerName=(nameInput?.value||'å‹‡è€…').trim();
      if(!gameState.playerName) gameState.playerName='å‹‡è€…';
      gameState.screen='difficulty';
      render();
    }

    function selectDifficulty(level){
      gameState.difficulty=level;

      gameState.playerHP=100;
      gameState.maxHP=100;
      gameState.defeatedCount=0;
      gameState.combo=0;
      gameState.message='';
      gameState.droppedWeapon=null;

      recentQ.length = 0; // é›£æ˜“åº¦åˆ‡æ›¿æ™‚ã¯ç›´è¿‘å±¥æ­´ãƒªã‚»ãƒƒãƒˆ

      spawnEnemy();
      getNewQuestion();
      gameState.screen='battle';
      render();
    }

    function goToDifficulty(){ stopTimer(); gameState.screen='difficulty'; render(); }
    function goToInventory(){ stopTimer(); gameState.screen='inventory'; render(); }
    function equipWeapon(index){ gameState.equippedWeapon=gameState.weapons[index]; render(); }

    function equipNewWeapon(){
      if(gameState.droppedWeapon && !gameState.weapons.find(w=>w.id===gameState.droppedWeapon.id)){
        gameState.weapons.push(gameState.droppedWeapon);
      }
      gameState.equippedWeapon=gameState.droppedWeapon;
      continueAfterDrop();
    }

    function continueAfterDrop(){
      if(gameState.droppedWeapon && !gameState.weapons.find(w=>w.id===gameState.droppedWeapon.id)){
        gameState.weapons.push(gameState.droppedWeapon);
      }
      gameState.droppedWeapon=null;

      if(!gameState.isBossBattle && gameState.defeatedCount>=3){
        gameState.screen='levelClear';
      }else{
        if(!gameState.isBossBattle) spawnEnemy();
        getNewQuestion();
        gameState.screen='battle';
      }
      render();
    }

    function returnToDifficultyFromDrop(){
      if(gameState.droppedWeapon && !gameState.weapons.find(w=>w.id===gameState.droppedWeapon.id)){
        gameState.weapons.push(gameState.droppedWeapon);
      }
      gameState.droppedWeapon=null;
      stopTimer();
      gameState.screen='difficulty';
      render();
    }

    function startBossBattle(){
      spawnBoss();
      getNewQuestion();
      gameState.screen='battle';
      render();
    }

    function retryBattle(){
      stopTimer();
      gameState.playerHP=100;
      gameState.defeatedCount=0;
      gameState.combo=0;
      gameState.isBossBattle=false;
      gameState.message='';
      gameState.droppedWeapon=null;

      spawnEnemy();
      getNewQuestion();
      gameState.screen='battle';
      render();
    }

    function pauseToDifficulty(){
      stopTimer();
      gameState.screen='difficulty';
      render();
    }

    // =========================
    // Flick Input
    // =========================
    let flickStartPos=null;
    let currentFlickKey=null;

    function startFlick(event,key){
      if(!key) return;
      event.preventDefault();
      flickStartPos={x:event.clientX,y:event.clientY};
      currentFlickKey=key;
      const keyEl=event.target.closest('.flick-key');
      if(keyEl) keyEl.classList.add('active');
    }
    function moveFlick(event){
      if(!flickStartPos) return;
      event.preventDefault();
    }
    function endFlick(event,target){
      if(!flickStartPos||!currentFlickKey){ flickStartPos=null; currentFlickKey=null; return; }
      event.preventDefault();

      const endPos={x:event.clientX,y:event.clientY};
      const dx=endPos.x-flickStartPos.x;
      const dy=endPos.y-flickStartPos.y;
      const threshold=26;

      let direction='center';
      if(Math.abs(dx)>threshold||Math.abs(dy)>threshold){
        if(Math.abs(dx)>Math.abs(dy)) direction=dx>0?'right':'left';
        else direction=dy>0?'down':'up';
      }

      processFlickInput(currentFlickKey,direction,target);

      document.querySelectorAll('.flick-key').forEach(el=>el.classList.remove('active'));
      flickStartPos=null; currentFlickKey=null;
    }

    function processFlickInput(key,direction,target){
      if(target!=='battle') return;

      if(key==='âŒ«'){
        gameState.inputText=gameState.inputText.slice(0,-1);
      }else if(key==='ã‚›'){
        applyDakuten();
      }else if(key==='ã‚œ'){
        applyHandakuten();
      }else if(key==='å°'){
        applySmall();
      }else if(key==='ãƒ¼'){
        gameState.inputText+='ãƒ¼';
      }else if(flickMap[key]){
        const char=flickMap[key][direction]||flickMap[key].center;
        if(char && char!=='ï¼ˆ' && char!=='ï¼‰' && char!=='ã€œ') gameState.inputText+=char;
      }
      syncInputDisplay();
    }

    function applyDakuten(){
      if(!gameState.inputText) return;
      const last=gameState.inputText.slice(-1);
      if(dakutenMap[last]) gameState.inputText=gameState.inputText.slice(0,-1)+dakutenMap[last];
    }
    function applyHandakuten(){
      if(!gameState.inputText) return;
      const last=gameState.inputText.slice(-1);
      if(handakutenMap[last]) gameState.inputText=gameState.inputText.slice(0,-1)+handakutenMap[last];
    }
    function applySmall(){
      if(!gameState.inputText) return;
      const last=gameState.inputText.slice(-1);
      if(smallMap[last]) gameState.inputText=gameState.inputText.slice(0,-1)+smallMap[last];
    }

    function renderFlickGridHTML(target){
      return `
        <div class="grid grid-cols-3 gap-2">
          ${flickLayout.flat().map(key=>{
            const isEmpty=!key;
            const cls=isEmpty?'flick-key disabled':'flick-key';
            const safeKey=key||'';
            return `
              <div class="${cls}"
                ${isEmpty?'':`
                  onpointerdown="startFlick(event, '${safeKey}')"
                  onpointerup="endFlick(event, '${target}')"
                  onpointerleave="endFlick(event, '${target}')"
                  onpointermove="moveFlick(event)"
                `}>
                ${safeKey}
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    // =========================
    // Answer / Battle
    // =========================
    function submitAnswer(){
      stopTimer();
      const answer=(gameState.inputText||'').toLowerCase();
      const correct=(gameState.currentQuestion.reading||'').toLowerCase();

      if(answer===correct) handleCorrectAnswer();
      else handleWrongAnswer();
    }

    function handleTimeOut(){
      gameState.combo=0;
      const dmg=gameState.currentEnemy.atk;
      gameState.playerHP-=dmg;
      gameState.message=`â° æ™‚é–“åˆ‡ã‚Œ... æ­£è§£ã¯ã€Œ${gameState.currentQuestion.reading}ã€ ${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸï¼`;

      if(gameState.playerHP<=0){
        gameState.playerHP=0;
        gameState.screen='gameOver';
      }else{
        getNewQuestion();
      }
      render();
    }

    function handleCorrectAnswer(){
      gameState.combo++;
      const dmg=calculateDamage();
      gameState.enemyHP-=dmg;
      gameState.message=`âœ¨ æ­£è§£ï¼ ${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼ ã‚³ãƒ³ãƒœ${gameState.combo}x`;

      const enemySprite=document.getElementById('enemySprite');
      if(enemySprite){
        enemySprite.classList.add('damage-flash');
        setTimeout(()=>enemySprite.classList.remove('damage-flash'),200);
      }

      if(gameState.enemyHP<=0) handleEnemyDefeat();
      else { getNewQuestion(); render(); }
    }

    function handleWrongAnswer(){
      gameState.combo=0;
      const dmg=gameState.currentEnemy.atk;
      gameState.playerHP-=dmg;
      gameState.message=`âŒ ä¸æ­£è§£... æ­£è§£ã¯ã€Œ${gameState.currentQuestion.reading}ã€ ${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸï¼`;

      if(gameState.playerHP<=0){
        gameState.playerHP=0;
        gameState.screen='gameOver';
      }else{
        getNewQuestion();
      }
      render();
    }

    function handleEnemyDefeat(){
      gameState.totalDefeated++;

      // ãƒœã‚¹æ’ƒç ´
      if(gameState.isBossBattle){
        const diffKey = gameState.difficulty;
        if(!gameState.clearedLevels.includes(diffKey)) gameState.clearedLevels.push(diffKey);

        gameState.droppedWeapon=getRandomWeapon();
        gameState.screen='weaponDrop';
        render();
        return;
      }

      // é€šå¸¸æ•µæ’ƒç ´
      gameState.defeatedCount++;

      if(Math.random()<0.7){
        gameState.droppedWeapon=getRandomWeapon();
        gameState.screen='weaponDrop';
      }else if(gameState.defeatedCount>=3){
        gameState.screen='levelClear';
      }else{
        spawnEnemy();
        getNewQuestion();
        gameState.message='æ•µã‚’å€’ã—ãŸï¼æ¬¡ã®æ•µãŒç¾ã‚ŒãŸ...';
        gameState.screen='battle';
      }
      render();
    }

    // =========================
    // Init
    // =========================
    render();
  </script>
</body>
</html>
