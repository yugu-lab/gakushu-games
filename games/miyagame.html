<!doctype html>
<html lang="ja" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ¼¢å­—å‹‡è€… - èª­ã¿ã®è©¦ç·´</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&family=Yuji+Syuku&display=swap" rel="stylesheet">

  <style>
    html, body { height: 100%; }
    body { box-sizing: border-box; margin: 0; }
    * { font-family: 'Zen Maru Gothic', sans-serif; }
    .title-font { font-family: 'Yuji Syuku', serif; }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(255,215,0,0.3); }
      50% { box-shadow: 0 0 40px rgba(255,215,0,0.6); }
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    @keyframes damage-flash {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(2) saturate(0); }
    }
    @keyframes victory-glow {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
      100% { transform: scale(1); opacity: 1; }
    }
    @keyframes time-warning {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    .float-anim { animation: float 3s ease-in-out infinite; }
    .pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
    .shake { animation: shake 0.3s ease-in-out; }
    .damage-flash { animation: damage-flash 0.2s ease-out; }
    .victory-glow { animation: victory-glow 1s ease-in-out infinite; }
    .time-warning { animation: time-warning 0.4s ease-in-out infinite; }

    .flick-key {
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(145deg, #2a2a3e, #1a1a2e);
      border: 2px solid #4a4a6e;
      border-radius: 12px;
      font-size: 1.2rem;
      color: #fff;
      cursor: pointer;
      user-select: none;
      transition: transform 0.15s, background 0.15s, box-shadow 0.15s, border-color 0.15s;
      position: relative;
      -webkit-tap-highlight-color: transparent;
      touch-action: none; /* iPadã§ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¹²æ¸‰ã‚’æ¸›ã‚‰ã™ */
    }
    .flick-key:active {
      transform: scale(0.95);
      background: linear-gradient(145deg, #3a3a5e, #2a2a4e);
    }
    .flick-key.active {
      border-color: #ffd700;
      box-shadow: 0 0 15px rgba(255,215,0,0.5);
    }

    .hp-bar {
      height: 24px;
      background: #1a1a2e;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid #4a4a6e;
    }
    .hp-fill {
      height: 100%;
      background: linear-gradient(90deg, #22c55e, #4ade80);
      transition: width 0.3s ease;
    }
    .hp-fill.low { background: linear-gradient(90deg, #ef4444, #f87171); }
    .hp-fill.enemy { background: linear-gradient(90deg, #dc2626, #ef4444); }

    .weapon-card {
      background: linear-gradient(145deg, #2a2a3e, #1a1a2e);
      border: 2px solid;
      border-radius: 16px;
      padding: 16px;
      text-align: center;
    }
    .weapon-card.common { border-color: #9ca3af; }
    .weapon-card.uncommon { border-color: #22c55e; }
    .weapon-card.rare { border-color: #3b82f6; }
    .weapon-card.epic { border-color: #a855f7; }
    .weapon-card.legendary { border-color: #ffd700; box-shadow: 0 0 30px rgba(255,215,0,0.3); }

    .battle-screen {
      background: radial-gradient(ellipse at center, #1e1e3f 0%, #0a0a1a 100%);
    }
    .enemy-sprite {
      font-size: 4rem;
      filter: drop-shadow(0 0 20px rgba(255,0,0,0.3));
    }

    .input-display {
      min-height: 48px;
      background: rgba(0,0,0,0.5);
      border: 2px solid #4a4a6e;
      border-radius: 12px;
      padding: 8px 16px;
      font-size: 1.5rem;
      color: #fff;
    }

    .time-bar {
      height: 8px;
      background: #1a1a2e;
      border-radius: 4px;
      overflow: hidden;
      border: 1px solid #4a4a6e;
    }
    .time-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #22c55e, #4ade80);
      transition: width 0.1s linear, background 0.1s linear;
    }
    .time-bar-fill.warning {
      background: linear-gradient(90deg, #ef4444, #f87171);
    }
  </style>
</head>

<body class="h-full bg-gray-900 text-white overflow-hidden">
  <div id="app" class="h-full w-full"></div>

  <script>
    // =========================
    // Game State
    // =========================
    const gameState = {
      screen: 'title',
      playerName: '',
      difficulty: null,
      playerHP: 100,
      maxHP: 100,
      playerATK: 10,
      playerDEF: 5,
      weapons: [],
      equippedWeapon: null,
      currentEnemy: null,
      enemyHP: 0,
      enemyMaxHP: 0,
      currentQuestion: null,
      inputText: '',
      defeatedCount: 0,
      totalDefeated: 0,
      clearedLevels: [],
      combo: 0,
      message: '',
      droppedWeapon: null,
      isBossBattle: false,
      timeLimit: 10,
      timeRemaining: 10,
      timerInterval: null
    };

    // =========================
    // Questions Database
    // =========================
    const questions = {
      1: [
        {kanji: 'å‰£', reading: 'ã¤ã‚‹ã'}, {kanji: 'é‰„', reading: 'ã¦ã¤'},
        {kanji: 'æœˆæ›œæ—¥', reading: 'ã’ã¤ã‚ˆã†ã³'}, {kanji: 'å¤ä»£', reading: 'ã“ã ã„'},
        {kanji: 'æ–‡å­—', reading: 'ã‚‚ã˜'}, {kanji: 'åŠ›', reading: 'ã¡ã‹ã‚‰'},
        {kanji: 'æµ·', reading: 'ã†ã¿'}, {kanji: 'å‹‡ã¾ã—ã„', reading: 'ã„ã•ã¾ã—ã„'},
        {kanji: 'å§«', reading: 'ã²ã‚'}, {kanji: 'ç›¾', reading: 'ãŸã¦'},
        {kanji: 'ç¥', reading: 'ã‹ã¿'}, {kanji: 'èµ¤ã‚“åŠ', reading: 'ã‚ã‹ã‚“ã¼ã†'},
        {kanji: 'åŒå­', reading: 'ãµãŸã”'}, {kanji: 'å®®ç”°', reading: 'ã¿ã‚„ãŸ'}
      ],
      2: [
        {kanji: 'å¹³å’Œ', reading: 'ã¸ã„ã‚'}, {kanji: 'å‹‡è€…', reading: 'ã‚†ã†ã—ã‚ƒ'},
        {kanji: 'å³¶', reading: 'ã—ã¾'}, {kanji: 'é‡‘è', reading: 'ãã‚“ã‚†ã†'},
        {kanji: 'çµ‚ç„‰', reading: 'ã—ã‚…ã†ãˆã‚“'}, {kanji: 'éå¤§è©•ä¾¡', reading: 'ã‹ã ã„ã²ã‚‡ã†ã‹'},
        {kanji: 'é­”ç‹', reading: 'ã¾ãŠã†'}, {kanji: 'åŸ', reading: 'ã—ã‚'},
        {kanji: 'é¾', reading: 'ã‚Šã‚…ã†'}, {kanji: 'å‰›', reading: 'ã”ã†'},
        {kanji: 'æ‘©å¤©æ¥¼', reading: 'ã¾ã¦ã‚“ã‚ã†'}, {kanji: 'ç‹¼', reading: 'ãŠãŠã‹ã¿'},
        {kanji: 'å¤§ç ²', reading: 'ãŸã„ã»ã†'}, {kanji: 'å…', reading: 'ã†ã•ã'}
      ],
      3: [
        {kanji: 'è‹±å‰åˆ©', reading: 'ã„ãã‚Šã™'}, {kanji: 'äºœç±³åˆ©åŠ ', reading: 'ã‚ã‚ã‚Šã‹'},
        {kanji: 'å°åº¦', reading: 'ã„ã‚“ã©'}, {kanji: 'è‘¡è„ç‰™', reading: 'ã½ã‚‹ã¨ãŒã‚‹'},
        {kanji: 'çŸ¥åºŠ', reading: 'ã—ã‚Œã¨ã“'}, {kanji: 'å¥„ç¾', reading: 'ã‚ã¾ã¿'},
        {kanji: 'æª¸æª¬', reading: 'ã‚Œã‚‚ã‚“'}, {kanji: 'è¶', reading: 'ã¡ã‚‡ã†'},
        {kanji: 'å¼”', reading: 'ã¨ã‚€ã‚‰ã„'}, {kanji: 'ç‹é¨', reading: 'ãŠã†ã'},
        {kanji: 'éŒå€‰å¹•åºœ', reading: 'ã‹ã¾ãã‚‰ã°ããµ'}, {kanji: 'æºé ¼æœ', reading: 'ã¿ãªã‚‚ã¨ã®ã‚ˆã‚Šã¨ã‚‚'},
        {kanji: 'æŸ´ç”°å‹å®¶', reading: 'ã—ã°ãŸã‹ã¤ã„ãˆ'}
      ],
      ore: [
        {kanji: 'èœƒ', reading: 'ã¯ã¾ãã‚Š'}, {kanji: 'èµ¤ä¿ç•™å¤', reading: 'ã‚ã‹ã·ã‚‹ã“'},
        {kanji: 'æ‰æ¡ƒ', reading: 'ã‚ãƒ¼ã‚‚ã‚“ã©'}, {kanji: 'æ”¹ç¾…', reading: 'ã‹ã„ã‚'},
        {kanji: 'ç‰‡å£é°¯', reading: 'ã‹ãŸãã¡ã„ã‚ã—'}, {kanji: 'åŠ ç‰¹åŠ›', reading: 'ã‹ã¨ã‚Šã£ã'},
        {kanji: 'å…œè¦', reading: 'ã‹ã¶ã¨ãˆã³'}, {kanji: 'é¯£çƒè³Š', reading: 'ã™ã‚‹ã‚ã„ã‹'},
        {kanji: 'é›ªéš é‡‘äº€å­', reading: 'ã›ã‚“ã¡ã“ãŒã­'}, {kanji: 'æ›¹é”', reading: 'ããƒ¼ã '},
        {kanji: 'å•„æœ¨', reading: 'ãŸãã¼ã'}, {kanji: 'å¤ªåˆ€é­š', reading: 'ãŸã¡ã†ãŠ'},
        {kanji: 'é­šè¨', reading: 'ã¡ã‚‡ã†'}, {kanji: 'ä»²äºº', reading: 'ãªã“ã†ã©'},
        {kanji: 'éŸ®', reading: 'ã«ã‚‰'}, {kanji: 'èš¤', reading: 'ã®ã¿'},
        {kanji: 'ç', reading: 'ã°ã'}, {kanji: 'æ´‹ç´', reading: 'ã´ã‚ã®'},
        {kanji: 'èˆ¹è™«', reading: 'ãµãªã‚€ã—'}
      ]
    };

    // =========================
    // Weapons Database
    // =========================
    const weapons = [
      // Common (40%)
      {id: 1, name: 'é»’é‰„ã®ç­†', desc: 'åŸºæœ¬ã®æ­¦å™¨ã€‚å¢¨ã®è·¡ã§æ•µã‚’åˆ‡ã‚Šè£‚ãã€‚', rank: 'common', atk: 5, emoji: 'ğŸ–Œï¸'},
      {id: 2, name: 'ä¸€ç”»ã®çŸ­å‰£', desc: 'é‹­ã„ä¸€æŒ¯ã‚Šã®æ–¬æ’ƒã‚’ç¹°ã‚Šå‡ºã™ã€‚', rank: 'common', atk: 7, emoji: 'ğŸ—¡ï¸'},
      {id: 3, name: 'é€£ç¶¿ã®é–', desc: 'æ–‡å­—ã‚’ç¹‹ã’ã‚‹ã‚ˆã†ã«æ•µã‚’æ‹˜æŸã™ã‚‹ã€‚', rank: 'common', atk: 4, def: 3, emoji: 'â›“ï¸'},
      {id: 4, name: 'è·³ã­è¿”ã—ã®ç¡¯', desc: 'æ•µã®ç‰©ç†æ”»æ’ƒã‚’ä¸€å®šç¢ºç‡ã§å¼¾ãè¿”ã™ã€‚', rank: 'common', def: 8, emoji: 'ğŸ“¦'},
      {id: 5, name: 'åƒå­—æ–‡ã®é•·æ§', desc: 'ãƒªãƒ¼ãƒãŒé•·ãã€é ãã®æ•µã‚’çªãã€‚', rank: 'common', atk: 8, emoji: 'ğŸ”±'},
      // Uncommon (30%)
      {id: 6, name: 'è¨€éœŠã®å¼“', desc: 'æ­£è§£ã—ãŸæ¼¢å­—ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’çŸ¢ã«ã—ã¦æ”¾ã¤ã€‚', rank: 'uncommon', atk: 12, emoji: 'ğŸ¹'},
      {id: 7, name: 'ç ´é‚ªã®æœ±å°', desc: 'æ•µã«ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æŠ¼ã—ã€å‘ªã„ã‚’è§£é™¤ã™ã‚‹ã€‚', rank: 'uncommon', atk: 10, special: 'cleanse', emoji: 'ğŸ”´'},
      {id: 8, name: 'é›£èª­ã®ç›¾', desc: 'è¤‡é›‘ãªç”»æ•°ã§æ§‹æˆã•ã‚ŒãŸå¼·å›ºãªç›¾ã€‚', rank: 'uncommon', def: 15, emoji: 'ğŸ›¡ï¸'},
      {id: 9, name: 'éŸ³èª­ã¿ã®åŒå‰£', desc: 'ç´ æ—©ã„äºŒé€£æ’ƒãŒå¯èƒ½ã€‚', rank: 'uncommon', atk: 14, emoji: 'âš”ï¸'},
      {id: 10, name: 'è¨“èª­ã¿ã®å¤§æ§Œ', desc: 'é‡ã„ä¸€æ’ƒã§æ•µã‚’æ°—çµ¶ã•ã›ã‚‹ã€‚', rank: 'uncommon', atk: 18, emoji: 'ğŸ”¨'},
      {id: 11, name: 'å¢¨é¢¨ã®æ‰‡', desc: 'å¢¨ã®éœ§ã‚’å·»ãèµ·ã“ã—ã€æ•µã®å‘½ä¸­ç‡ã‚’ä¸‹ã’ã‚‹ã€‚', rank: 'uncommon', atk: 8, special: 'blind', emoji: 'ğŸª­'},
      // Rare (18%)
      {id: 12, name: 'æ°¸å­—å…«æ³•ã®å‰£', desc: 'åŸºæœ¬ã®8å‹•ä½œã‚’æ¥µã‚ãŸãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„å‰£ã€‚', rank: 'rare', atk: 15, def: 10, emoji: 'ğŸ—¡ï¸'},
      {id: 13, name: 'éƒ¨é¦–ã®ç± æ‰‹', desc: 'å±æ€§æ”»æ’ƒã‚’å¼·åŒ–ã€‚', rank: 'rare', atk: 20, emoji: 'ğŸ¥Š'},
      {id: 14, name: 'è‰æ›¸ã®æµåˆ€', desc: 'å—ã‘æµã—ã«ç‰¹åŒ–ã—ãŸã€ã—ãªã‚„ã‹ãªåˆ€ã€‚', rank: 'rare', atk: 16, def: 12, emoji: 'ğŸ”ª'},
      {id: 15, name: 'ä¸‡è‘‰ã®æ–', desc: 'å¤ä»£ã®è¨€è‘‰ã‚’æ“ã‚Šã€é­”æ³•æ”»æ’ƒã‚’è¡Œã†ã€‚', rank: 'rare', atk: 22, emoji: 'ğŸª„'},
      {id: 16, name: 'ç”»æ•°ãƒ–ãƒ¼ã‚¹ãƒˆã®æŒ‡è¼ª', desc: 'æ¼¢å­—ã®ç”»æ•°ãŒå¤šã„ã»ã©æ”»æ’ƒåŠ›ãŒä¸ŠãŒã‚‹ã€‚', rank: 'rare', atk: 12, special: 'strokeBoost', emoji: 'ğŸ’'},
      {id: 17, name: 'è±¡å½¢æ–‡å­—ã®ãƒ¡ãƒ€ãƒ«', desc: 'è‡ªç„¶ã®åŠ›ã‚’å€Ÿã‚Šã‚‹ã€‚', rank: 'rare', atk: 14, def: 8, emoji: 'ğŸ…'},
      {id: 18, name: 'æ›¸ãé †ã®ã‚¿ãƒªã‚¹ãƒãƒ³', desc: 'ã‚³ãƒ³ãƒœãŒç¹‹ãŒã‚Šã‚„ã™ããªã‚‹ã€‚', rank: 'rare', atk: 10, special: 'combo', emoji: 'ğŸ“¿'},
      // Epic (10%)
      {id: 19, name: 'çœŸè´‹ã®çœ¼é¡', desc: 'æ•µã®å¼±ç‚¹æ¼¢å­—ã‚’è¦‹æŠœãã€‚', rank: 'epic', atk: 18, special: 'hint', emoji: 'ğŸ‘“'},
      {id: 20, name: 'é»„é‡‘ã®æ–‡é®', desc: 'æ•µã®å‹•ãã‚’å®Œå…¨ã«å°ã˜ã‚‹é‡çŸ³ã€‚', rank: 'epic', atk: 25, special: 'stun', emoji: 'ğŸª™'},
      {id: 21, name: 'é¾æ–‡å­—ã®ç¯­æ‰‹', desc: 'é¾ã®å¦‚ãåŠ›å¼·ã„ä¸€æ’ƒã‚’ç¹°ã‚Šå‡ºã™ã€‚', rank: 'epic', atk: 30, emoji: 'ğŸ‰'},
      {id: 22, name: 'å››å­—ç†Ÿèªã®é™£ç¾½ç¹”', desc: 'å››é€£æ’ƒã‚’å‡ºã™ã¨é˜²å¾¡åŠ›ãŒå¤§å¹…ã‚¢ãƒƒãƒ—ã€‚', rank: 'epic', def: 20, special: 'comboDefense', emoji: 'ğŸ¥‹'},
      {id: 23, name: 'å…­æ›¸ã®ã‚¯ãƒ­ã‚¹ãƒœã‚¦', desc: 'æ¼¢å­—ã®æ§‹æˆåŸç†ã‚’åˆ©ç”¨ã—ãŸå¤šè§’æ”»æ’ƒã€‚', rank: 'epic', atk: 28, emoji: 'ğŸ¯'},
      {id: 24, name: 'æ¼¢ç±ã®é­”å°æ›¸', desc: 'é›£ã—ã„èª­ã¿ã»ã©é«˜ç«åŠ›ã®é­”æ³•ãŒå‡ºã‚‹ã€‚', rank: 'epic', atk: 24, special: 'difficultyBoost', emoji: 'ğŸ“•'},
      // Legendary (2%)
      {id: 25, name: 'ç‚¹ç”»ã®ãƒ¬ã‚¤ãƒ”ã‚¢', desc: 'æ•µã®éš™ã‚’ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒˆã§çªãã€‚', rank: 'legendary', atk: 35, emoji: 'ğŸ¤º'},
      {id: 26, name: 'è’¼å¤©ã®åŠç´™', desc: 'è‡ªèº«ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç•°å¸¸ã‚’æµ„åŒ–ã™ã‚‹ã€‚', rank: 'legendary', def: 25, special: 'purify', emoji: 'ğŸ“œ'},
      {id: 27, name: 'è¡Œæ›¸ã®è–™åˆ€', desc: 'æµã‚Œã«æ²¿ã£ãŸåºƒç¯„å›²æ”»æ’ƒã€‚', rank: 'legendary', atk: 38, emoji: 'ğŸŒ€'},
      {id: 28, name: 'æ¥·æ›¸ã®é‡é§', desc: 'éš™ãŒãªã„å®Œç’§ãªé˜²å¾¡ã‚’èª‡ã‚‹ã€‚', rank: 'legendary', def: 40, emoji: 'ğŸ›¡ï¸'},
      {id: 29, name: 'ç•°ä½“å­—ã®ãƒ–ãƒ¼ãƒ¡ãƒ©ãƒ³', desc: 'äºˆæ¸¬ä¸èƒ½ãªå‹•ãã§æ•µã‚’ç¿»å¼„ã™ã‚‹ã€‚', rank: 'legendary', atk: 32, special: 'doubleHit', emoji: 'ğŸªƒ'},
      {id: 30, name: 'ç©¶æ¥µã®ç­†ï¼šå¤©å•“', desc: 'ã™ã¹ã¦ã®æ¼¢å­—ã‚’çµ±ã¹ã‚‹ä¼èª¬ã®ç­†ã€‚', rank: 'legendary', atk: 50, def: 20, emoji: 'âœ¨'}
    ];

    // =========================
    // Enemies & Bosses
    // =========================
    const enemies = {
      1: [
        {name: 'å¢¨æ±ã‚¹ãƒ©ã‚¤ãƒ ', emoji: 'ğŸ’§', hp: 30, atk: 5},
        {name: 'æ¼¢å­—ã‚´ãƒ–ãƒªãƒ³', emoji: 'ğŸ‘º', hp: 40, atk: 8},
        {name: 'æ–‡å­—ã‚³ã‚¦ãƒ¢ãƒª', emoji: 'ğŸ¦‡', hp: 25, atk: 10}
      ],
      2: [
        {name: 'æ›¸é“ã‚ªãƒ¼ã‚¬', emoji: 'ğŸ‘¹', hp: 60, atk: 12},
        {name: 'ç­†ãƒ‰ãƒ©ã‚´ãƒ³', emoji: 'ğŸ²', hp: 80, atk: 15},
        {name: 'ç¡¯ã‚´ãƒ¼ãƒ¬ãƒ ', emoji: 'ğŸ—¿', hp: 100, atk: 10}
      ],
      3: [
        {name: 'é›£èª­ã®é­”è¡“å¸«', emoji: 'ğŸ§™', hp: 100, atk: 18},
        {name: 'å¤æ–‡æ›¸ã®äº¡éœŠ', emoji: 'ğŸ‘»', hp: 80, atk: 22},
        {name: 'æ¼¢ç±ã®å®ˆè­·è€…', emoji: 'ğŸ¦¾', hp: 120, atk: 16}
      ],
      ore: [
        {name: 'ç©¶æ¥µèª­å¸«', emoji: 'ğŸ‘ï¸', hp: 150, atk: 25},
        {name: 'è¨€éœŠã®åŒ–èº«', emoji: 'ğŸ”®', hp: 130, atk: 30},
        {name: 'æ–‡å­—ç¥ã®ä½¿å¾’', emoji: 'âš¡', hp: 180, atk: 20}
      ]
    };

    const bosses = {
      1: {name: 'å¢¨æŸ“ã‚ã®å¤§è›‡', emoji: 'ğŸ', hp: 100, atk: 15},
      2: {name: 'æ›¸é“ç‹ã‚ªãƒ­ãƒ', emoji: 'ğŸ‰', hp: 180, atk: 22},
      3: {name: 'æ¼¢å­—å¸ãƒ¤ãƒã‚¿', emoji: 'ğŸ‘‘', hp: 280, atk: 30},
      ore: {name: 'ã€ç©¶æ¥µã€‘æ–‡å­—ç¥ã‚«ãƒ³ã‚¸', emoji: 'ğŸŒŸ', hp: 500, atk: 40}
    };

    // =========================
    // Flick Input Layout
    // =========================
    const flickLayout = [
      ['ã‚', 'ã‹', 'ã•', 'ãŸ', 'ãª'],
      ['ã¯', 'ã¾', 'ã‚„', 'ã‚‰', 'ã‚'],
      ['ã‚›', 'ã‚œ', 'å°', 'ãƒ¼', 'âŒ«']
    ];

    const flickMap = {
      'ã‚': {center: 'ã‚', up: 'ã†', down: 'ãŠ', left: 'ã„', right: 'ãˆ'},
      'ã‹': {center: 'ã‹', up: 'ã', down: 'ã“', left: 'ã', right: 'ã‘'},
      'ã•': {center: 'ã•', up: 'ã™', down: 'ã', left: 'ã—', right: 'ã›'},
      'ãŸ': {center: 'ãŸ', up: 'ã¤', down: 'ã¨', left: 'ã¡', right: 'ã¦'},
      'ãª': {center: 'ãª', up: 'ã¬', down: 'ã®', left: 'ã«', right: 'ã­'},
      'ã¯': {center: 'ã¯', up: 'ãµ', down: 'ã»', left: 'ã²', right: 'ã¸'},
      'ã¾': {center: 'ã¾', up: 'ã‚€', down: 'ã‚‚', left: 'ã¿', right: 'ã‚'},
      'ã‚„': {center: 'ã‚„', up: 'ã‚†', down: 'ã‚ˆ', left: 'ï¼ˆ', right: 'ï¼‰'},
      'ã‚‰': {center: 'ã‚‰', up: 'ã‚‹', down: 'ã‚', left: 'ã‚Š', right: 'ã‚Œ'},
      'ã‚': {center: 'ã‚', up: 'ã‚“', down: 'ãƒ¼', left: 'ã‚’', right: 'ã€œ'}
    };

    const dakutenMap = {
      'ã‹': 'ãŒ', 'ã': 'ã', 'ã': 'ã', 'ã‘': 'ã’', 'ã“': 'ã”',
      'ã•': 'ã–', 'ã—': 'ã˜', 'ã™': 'ãš', 'ã›': 'ãœ', 'ã': 'ã',
      'ãŸ': 'ã ', 'ã¡': 'ã¢', 'ã¤': 'ã¥', 'ã¦': 'ã§', 'ã¨': 'ã©',
      'ã¯': 'ã°', 'ã²': 'ã³', 'ãµ': 'ã¶', 'ã¸': 'ã¹', 'ã»': 'ã¼',
      'ã†': 'ã‚”'
    };

    const handakutenMap = {
      'ã¯': 'ã±', 'ã²': 'ã´', 'ãµ': 'ã·', 'ã¸': 'ãº', 'ã»': 'ã½'
    };

    const smallMap = {
      'ã‚': 'ã', 'ã„': 'ãƒ', 'ã†': 'ã…', 'ãˆ': 'ã‡', 'ãŠ': 'ã‰',
      'ã‚„': 'ã‚ƒ', 'ã‚†': 'ã‚…', 'ã‚ˆ': 'ã‚‡', 'ã¤': 'ã£'
    };

    // =========================
    // Helpers
    // =========================
    function getRandomItem(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function getRandomWeapon() {
      const roll = Math.random() * 100;
      let rank;
      if (roll < 40) rank = 'common';
      else if (roll < 70) rank = 'uncommon';
      else if (roll < 88) rank = 'rare';
      else if (roll < 98) rank = 'epic';
      else rank = 'legendary';
      const rankWeapons = weapons.filter(w => w.rank === rank);
      return getRandomItem(rankWeapons);
    }

    function getRankColor(rank) {
      const colors = {
        common: '#9ca3af',
        uncommon: '#22c55e',
        rare: '#3b82f6',
        epic: '#a855f7',
        legendary: '#ffd700'
      };
      return colors[rank] || '#9ca3af';
    }

    function getRankName(rank) {
      const names = {
        common: 'ã‚³ãƒ¢ãƒ³',
        uncommon: 'ã‚¢ãƒ³ã‚³ãƒ¢ãƒ³',
        rare: 'ãƒ¬ã‚¢',
        epic: 'ã‚¨ãƒ”ãƒƒã‚¯',
        legendary: 'ä¼èª¬'
      };
      return names[rank] || 'ã‚³ãƒ¢ãƒ³';
    }

    function calculateDamage() {
      let baseDamage = gameState.playerATK;
      if (gameState.equippedWeapon) baseDamage += gameState.equippedWeapon.atk || 0;
      baseDamage += gameState.combo * 2;
      return baseDamage;
    }

    function getTimeLimitByDifficulty(difficulty) {
      const timeLimits = { 1: 10, 2: 9, 3: 8, ore: 7 };
      return timeLimits[difficulty] || 10;
    }

    function spawnEnemy() {
      const diffKey = gameState.difficulty === 'ore' ? 'ore' : gameState.difficulty;
      const enemyList = enemies[diffKey];
      const enemy = { ...getRandomItem(enemyList) };
      gameState.currentEnemy = enemy;
      gameState.enemyHP = enemy.hp;
      gameState.enemyMaxHP = enemy.hp;
      gameState.isBossBattle = false;
    }

    function spawnBoss() {
      const diffKey = gameState.difficulty === 'ore' ? 'ore' : gameState.difficulty;
      const boss = { ...bosses[diffKey] };
      gameState.currentEnemy = boss;
      gameState.enemyHP = boss.hp;
      gameState.enemyMaxHP = boss.hp;
      gameState.isBossBattle = true;
    }

    function getNewQuestion() {
      const diffKey = gameState.difficulty === 'ore' ? 'ore' : gameState.difficulty;
      const questionList = questions[diffKey];
      gameState.currentQuestion = getRandomItem(questionList);
      gameState.inputText = '';
      startTimer();
    }

    function startTimer() {
      if (gameState.timerInterval) clearInterval(gameState.timerInterval);
      gameState.timeLimit = getTimeLimitByDifficulty(gameState.difficulty);
      gameState.timeRemaining = gameState.timeLimit;

      gameState.timerInterval = setInterval(() => {
        gameState.timeRemaining--;
        render();

        if (gameState.timeRemaining <= 0) {
          clearInterval(gameState.timerInterval);
          gameState.timerInterval = null;
          handleTimeOut();
        }
      }, 1000);
    }

    function stopTimer() {
      if (gameState.timerInterval) {
        clearInterval(gameState.timerInterval);
        gameState.timerInterval = null;
      }
    }

    function syncInputDisplay() {
      const inputDisplay = document.getElementById('inputText');
      if (inputDisplay) inputDisplay.textContent = gameState.inputText || 'ã€€';
    }

    // =========================
    // Render
    // =========================
    function render() {
      // battleä»¥å¤–ã§ã¯ã‚¿ã‚¤ãƒãƒ¼æ­¢ã‚ã‚‹ï¼ˆäº‹æ•…é˜²æ­¢ï¼‰
      if (gameState.screen !== 'battle') stopTimer();

      const app = document.getElementById('app');
      if (!app) return;

      switch (gameState.screen) {
        case 'title': renderTitleScreen(app); break;
        case 'difficulty': renderDifficultyScreen(app); break;
        case 'battle': renderBattleScreen(app); break;
        case 'victory': renderVictoryScreen(app); break;
        case 'gameOver': renderGameOverScreen(app); break;
        case 'weaponDrop': renderWeaponDropScreen(app); break;
        case 'inventory': renderInventoryScreen(app); break;
        case 'levelClear': renderLevelClearScreen(app); break;
        default: renderTitleScreen(app);
      }
    }

    function renderTitleScreen(container) {
      container.innerHTML = `
        <div class="h-full w-full flex flex-col items-center justify-center p-4" style="background: radial-gradient(ellipse at center, #1e1e3f 0%, #0a0a1a 100%);">
          <div class="text-center mb-8">
            <h1 class="title-font text-6xl font-bold mb-4 float-anim" style="color: #ffd700; text-shadow: 0 0 30px rgba(255,215,0,0.5);">
              æ¼¢å­—å‹‡è€…
            </h1>
            <p class="text-2xl text-gray-300">ã€œ èª­ã¿ã®è©¦ç·´ ã€œ</p>
          </div>

          <div class="mb-8">
            <div class="text-8xl float-anim" style="animation-delay: 0.5s;">âš”ï¸ğŸ“–</div>
          </div>

          <div class="w-full max-w-md mb-6">
            <label class="block text-lg mb-2 text-gray-300">å‹‡è€…ã®åå‰ã‚’å…¥åŠ›</label>
            <input type="text" id="playerNameInput"
              class="w-full px-4 py-3 text-xl rounded-xl bg-gray-800 border-2 border-gray-600 focus:border-yellow-500 focus:outline-none text-white"
              placeholder="åå‰ã‚’å…¥åŠ›..."
              value="${gameState.playerName}">
          </div>

          <button onclick="startGame()"
            class="px-12 py-4 text-2xl font-bold rounded-xl pulse-glow transition-transform hover:scale-105"
            style="background: linear-gradient(145deg, #ffd700, #ffaa00); color: #1a1a2e;">
            å†’é™ºã‚’å§‹ã‚ã‚‹
          </button>

          <p class="mt-8 text-gray-500 text-sm">æ¼¢å­—ã®èª­ã¿æ–¹ã‚’ç­”ãˆã¦æ•µã‚’å€’ãã†ï¼</p>
        </div>
      `;
    }

    function renderDifficultyScreen(container) {
      const canPlayOre = [1,2,3].every(lv => gameState.clearedLevels.includes(lv));

      container.innerHTML = `
        <div class="h-full w-full flex flex-col items-center justify-center p-4" style="background: radial-gradient(ellipse at center, #1e1e3f 0%, #0a0a1a 100%);">
          <h2 class="title-font text-4xl font-bold mb-2" style="color: #ffd700;">é›£æ˜“åº¦ã‚’é¸æŠ</h2>
          <p class="text-xl text-gray-400 mb-6">å‹‡è€… ${gameState.playerName || 'å‹‡è€…'} ã‚ˆã€æŒ‘æˆ¦ã™ã‚‹è©¦ç·´ã‚’é¸ã¹</p>

          <div class="grid grid-cols-4 gap-4 w-full max-w-4xl">
            <button onclick="selectDifficulty(1)"
              class="p-6 rounded-2xl border-2 border-green-500 bg-green-900/30 hover:bg-green-800/50 transition-all hover:scale-105 ${gameState.clearedLevels.includes(1) ? 'ring-2 ring-yellow-400' : ''}">
              <div class="text-4xl mb-2">ğŸŒ±</div>
              <div class="text-2xl font-bold text-green-400">ãƒ¬ãƒ™ãƒ«1</div>
              <div class="text-sm text-gray-400 mt-2">åŸºæœ¬ã®æ¼¢å­—</div>
              <div class="text-xs text-gray-500 mt-1">10ç§’</div>
              ${gameState.clearedLevels.includes(1) ? '<div class="text-yellow-400 mt-2">âœ“ ã‚¯ãƒªã‚¢æ¸ˆ</div>' : ''}
            </button>

            <button onclick="selectDifficulty(2)"
              class="p-6 rounded-2xl border-2 border-blue-500 bg-blue-900/30 hover:bg-blue-800/50 transition-all hover:scale-105 ${gameState.clearedLevels.includes(2) ? 'ring-2 ring-yellow-400' : ''}">
              <div class="text-4xl mb-2">âš”ï¸</div>
              <div class="text-2xl font-bold text-blue-400">ãƒ¬ãƒ™ãƒ«2</div>
              <div class="text-sm text-gray-400 mt-2">ä¸­ç´šã®æ¼¢å­—</div>
              <div class="text-xs text-gray-500 mt-1">9ç§’</div>
              ${gameState.clearedLevels.includes(2) ? '<div class="text-yellow-400 mt-2">âœ“ ã‚¯ãƒªã‚¢æ¸ˆ</div>' : ''}
            </button>

            <button onclick="selectDifficulty(3)"
              class="p-6 rounded-2xl border-2 border-purple-500 bg-purple-900/30 hover:bg-purple-800/50 transition-all hover:scale-105 ${gameState.clearedLevels.includes(3) ? 'ring-2 ring-yellow-400' : ''}">
              <div class="text-4xl mb-2">ğŸ”¥</div>
              <div class="text-2xl font-bold text-purple-400">ãƒ¬ãƒ™ãƒ«3</div>
              <div class="text-sm text-gray-400 mt-2">é›£èª­æ¼¢å­—</div>
              <div class="text-xs text-gray-500 mt-1">8ç§’</div>
              ${gameState.clearedLevels.includes(3) ? '<div class="text-yellow-400 mt-2">âœ“ ã‚¯ãƒªã‚¢æ¸ˆ</div>' : ''}
            </button>

            <button onclick="${canPlayOre ? "selectDifficulty('ore')" : ''}"
              class="p-6 rounded-2xl border-2 ${canPlayOre ? 'border-yellow-500 bg-yellow-900/30 hover:bg-yellow-800/50 hover:scale-105' : 'border-gray-600 bg-gray-900/30 opacity-50 cursor-not-allowed'} transition-all">
              <div class="text-4xl mb-2">${canPlayOre ? 'ğŸ‘‘' : 'ğŸ”’'}</div>
              <div class="text-2xl font-bold ${canPlayOre ? 'text-yellow-400' : 'text-gray-500'}">ãƒ¬ãƒ™ãƒ«ä¿º</div>
              <div class="text-sm text-gray-400 mt-2">${canPlayOre ? 'ç©¶æ¥µã®è©¦ç·´' : 'Lv1-3ã‚¯ãƒªã‚¢ã§è§£æ”¾'}</div>
              <div class="text-xs text-gray-500 mt-1">${canPlayOre ? '7ç§’' : ''}</div>
            </button>
          </div>

          <button onclick="goToInventory()"
            class="mt-6 px-8 py-3 text-lg rounded-xl bg-gray-700 hover:bg-gray-600 transition-all">
            ğŸ’ æ­¦å™¨ä¸€è¦§ (${gameState.weapons.length})
          </button>
        </div>
      `;
    }

    function renderBattleScreen(container) {
      const hpPercent = (gameState.playerHP / gameState.maxHP) * 100;
      const enemyHpPercent = (gameState.enemyHP / gameState.enemyMaxHP) * 100;
      const isLowHP = hpPercent < 30;
      const isTimeWarning = gameState.timeRemaining <= 3;

      container.innerHTML = `
        <div class="h-full w-full flex flex-row battle-screen">
          <!-- Left Panel -->
          <div class="w-1/2 flex flex-col p-4">
            <div class="bg-black/40 rounded-xl p-3 mb-3">
              <div class="flex justify-between items-center mb-2">
                <span class="text-lg font-bold">${gameState.playerName}</span>
                <span class="text-sm text-gray-400">ã‚³ãƒ³ãƒœ: ${gameState.combo}x</span>
              </div>
              <div class="hp-bar">
                <div class="hp-fill ${isLowHP ? 'low' : ''}" style="width: ${hpPercent}%"></div>
              </div>
              <div class="flex justify-between text-sm mt-1">
                <span>HP: ${gameState.playerHP}/${gameState.maxHP}</span>
                <span>ATK: ${calculateDamage()}</span>
              </div>
              ${gameState.equippedWeapon ? `
                <div class="mt-2 text-sm text-yellow-400">
                  ${gameState.equippedWeapon.emoji} ${gameState.equippedWeapon.name}
                </div>` : ''}
            </div>

            <div class="flex-1 flex flex-col items-center justify-center">
              <div class="text-center mb-4">
                <div class="enemy-sprite ${gameState.isBossBattle ? 'victory-glow' : 'float-anim'}" id="enemySprite">
                  ${gameState.currentEnemy.emoji}
                </div>
                <div class="text-2xl font-bold mt-2 ${gameState.isBossBattle ? 'text-red-400' : ''}">
                  ${gameState.currentEnemy.name}
                </div>
                ${gameState.isBossBattle ? '<div class="text-red-500 text-sm">ã€BOSSã€‘</div>' : ''}
              </div>

              <div class="w-full max-w-xs">
                <div class="hp-bar">
                  <div class="hp-fill enemy" style="width: ${enemyHpPercent}%"></div>
                </div>
                <div class="text-center text-sm mt-1">HP: ${gameState.enemyHP}/${gameState.enemyMaxHP}</div>
              </div>

              <div class="mt-4 text-gray-400 text-sm">
                ${gameState.isBossBattle ? 'ãƒœã‚¹æˆ¦ï¼' : `æ’ƒç ´æ•°: ${gameState.defeatedCount}/3`}
              </div>
            </div>

            <div class="bg-black/40 rounded-xl p-3 text-center min-h-[60px]" id="messageBox">
              ${gameState.message || 'æ¼¢å­—ã®èª­ã¿æ–¹ã‚’å…¥åŠ›ã›ã‚ˆï¼'}
            </div>
          </div>

          <!-- Right Panel -->
          <div class="w-1/2 flex flex-col p-4 bg-black/20">
            <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-6 mb-3 text-center border-2 border-gray-700">
              <div class="flex justify-between items-center mb-2">
                <div class="text-sm text-gray-400">ã“ã®æ¼¢å­—ã®èª­ã¿æ–¹ã¯ï¼Ÿ</div>
                <div class="text-sm font-bold ${isTimeWarning ? 'text-red-500 time-warning' : 'text-yellow-400'}">
                  â±ï¸ ${gameState.timeRemaining}ç§’
                </div>
              </div>
              <div class="title-font text-5xl font-bold" style="color: #ffd700;">
                ${gameState.currentQuestion.kanji}
              </div>
              <div class="time-bar mt-4">
                <div class="time-bar-fill ${isTimeWarning ? 'warning' : ''}" style="width: ${(gameState.timeRemaining / gameState.timeLimit) * 100}%"></div>
              </div>
            </div>

            <div class="input-display flex items-center justify-between mb-3">
              <span id="inputText">${gameState.inputText || 'ã€€'}</span>
              <button onclick="submitAnswer()"
                class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg text-sm font-bold transition-all">
                æ±ºå®š
              </button>
            </div>

            <div class="flex-1 flex flex-col justify-center">
              ${flickLayout.map(row => `
                <div class="flex justify-center gap-2 mb-2">
                  ${row.map(key => `
                    <div class="flick-key"
                      data-key="${key}"
                      onpointerdown="startFlick(event, '${key}')"
                      onpointerup="endFlick(event)"
                      onpointerleave="endFlick(event)"
                      onpointermove="moveFlick(event)">
                      ${key}
                    </div>
                  `).join('')}
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;

      // æç”»ç›´å¾Œã«å…¥åŠ›æ¬„åŒæœŸï¼ˆã¾ã‚Œã«ç©ºã«ãªã‚‹äº‹æ•…é˜²æ­¢ï¼‰
      syncInputDisplay();
    }

    function renderWeaponDropScreen(container) {
      const weapon = gameState.droppedWeapon;
      container.innerHTML = `
        <div class="h-full w-full flex flex-col items-center justify-center p-4" style="background: radial-gradient(ellipse at center, #1e1e3f 0%, #0a0a1a 100%);">
          <h2 class="text-3xl font-bold mb-6 text-yellow-400">ğŸ‰ æ­¦å™¨ã‚’ç²å¾—ï¼</h2>

          <div class="weapon-card ${weapon.rank} w-80 mb-6">
            <div class="text-6xl mb-4">${weapon.emoji}</div>
            <div class="text-sm mb-2" style="color: ${getRankColor(weapon.rank)}">${getRankName(weapon.rank)}</div>
            <div class="text-2xl font-bold mb-2">${weapon.name}</div>
            <div class="text-gray-400 text-sm mb-4">${weapon.desc}</div>
            <div class="flex justify-center gap-4 text-sm">
              ${weapon.atk ? `<span class="text-red-400">ATK +${weapon.atk}</span>` : ''}
              ${weapon.def ? `<span class="text-blue-400">DEF +${weapon.def}</span>` : ''}
            </div>
          </div>

          <div class="flex gap-4">
            <button onclick="equipNewWeapon()"
              class="px-8 py-3 text-lg font-bold rounded-xl bg-yellow-600 hover:bg-yellow-500 transition-all">
              è£…å‚™ã™ã‚‹
            </button>
            <button onclick="continueAfterDrop()"
              class="px-8 py-3 text-lg font-bold rounded-xl bg-gray-700 hover:bg-gray-600 transition-all">
              æŒã¡ç‰©ã«å…¥ã‚Œã‚‹
            </button>
          </div>
        </div>
      `;
    }

    function renderVictoryScreen(container) {
      container.innerHTML = `
        <div class="h-full w-full flex flex-col items-center justify-center p-4" style="background: radial-gradient(ellipse at center, #1e3f1e 0%, #0a1a0a 100%);">
          <div class="text-8xl mb-6 victory-glow">ğŸ†</div>
          <h2 class="title-font text-5xl font-bold mb-4 text-yellow-400">å‹åˆ©ï¼</h2>
          <p class="text-2xl text-gray-300 mb-2">${gameState.playerName} ã¯ãƒœã‚¹ã‚’å€’ã—ãŸï¼</p>
          <p class="text-xl text-gray-400 mb-8">ãƒ¬ãƒ™ãƒ«${gameState.difficulty === 'ore' ? 'ä¿º' : gameState.difficulty} ã‚¯ãƒªã‚¢ï¼</p>
          <div class="flex gap-4">
            <button onclick="goToDifficulty()"
              class="px-8 py-4 text-xl font-bold rounded-xl bg-yellow-600 hover:bg-yellow-500 transition-all">
              é›£æ˜“åº¦é¸æŠã¸
            </button>
          </div>
        </div>
      `;
    }

    function renderGameOverScreen(container) {
      container.innerHTML = `
        <div class="h-full w-full flex flex-col items-center justify-center p-4" style="background: radial-gradient(ellipse at center, #3f1e1e 0%, #1a0a0a 100%);">
          <div class="text-8xl mb-6">ğŸ’€</div>
          <h2 class="title-font text-5xl font-bold mb-4 text-red-400">æ•—åŒ—...</h2>
          <p class="text-2xl text-gray-300 mb-8">${gameState.playerName} ã¯åŠ›å°½ããŸ...</p>
          <div class="flex gap-4">
            <button onclick="retryBattle()"
              class="px-8 py-4 text-xl font-bold rounded-xl bg-red-600 hover:bg-red-500 transition-all">
              å†æŒ‘æˆ¦
            </button>
            <button onclick="goToDifficulty()"
              class="px-8 py-4 text-xl font-bold rounded-xl bg-gray-700 hover:bg-gray-600 transition-all">
              é›£æ˜“åº¦é¸æŠã¸
            </button>
          </div>
        </div>
      `;
    }

    function renderInventoryScreen(container) {
      container.innerHTML = `
        <div class="h-full w-full flex flex-col p-4" style="background: radial-gradient(ellipse at center, #1e1e3f 0%, #0a0a1a 100%);">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-3xl font-bold text-yellow-400">ğŸ’ æ­¦å™¨ä¸€è¦§</h2>
            <button onclick="goToDifficulty()"
              class="px-6 py-2 rounded-xl bg-gray-700 hover:bg-gray-600 transition-all">
              æˆ»ã‚‹
            </button>
          </div>

          ${gameState.equippedWeapon ? `
            <div class="mb-4 p-4 rounded-xl bg-yellow-900/30 border-2 border-yellow-500">
              <div class="text-sm text-yellow-400 mb-2">è£…å‚™ä¸­</div>
              <div class="flex items-center gap-4">
                <span class="text-4xl">${gameState.equippedWeapon.emoji}</span>
                <div>
                  <div class="font-bold">${gameState.equippedWeapon.name}</div>
                  <div class="text-sm text-gray-400">
                    ${gameState.equippedWeapon.atk ? `ATK +${gameState.equippedWeapon.atk}` : ''}
                    ${gameState.equippedWeapon.def ? `DEF +${gameState.equippedWeapon.def}` : ''}
                  </div>
                </div>
              </div>
            </div>
          ` : '<div class="mb-4 p-4 rounded-xl bg-gray-800 text-gray-400">æ­¦å™¨æœªè£…å‚™</div>'}

          <div class="flex-1 overflow-auto">
            ${gameState.weapons.length === 0 ? `
              <div class="text-center text-gray-500 py-8">
                ã¾ã æ­¦å™¨ã‚’æŒã£ã¦ã„ã¾ã›ã‚“ã€‚<br>æ•µã‚’å€’ã—ã¦æ­¦å™¨ã‚’é›†ã‚ã‚ˆã†ï¼
              </div>
            ` : `
              <div class="grid grid-cols-5 gap-3">
                ${gameState.weapons.map((w, i) => `
                  <div class="weapon-card ${w.rank} cursor-pointer hover:scale-105 transition-all ${gameState.equippedWeapon?.id === w.id ? 'ring-2 ring-yellow-400' : ''}"
                    onclick="equipWeapon(${i})">
                    <div class="text-3xl mb-2">${w.emoji}</div>
                    <div class="text-xs mb-1" style="color: ${getRankColor(w.rank)}">${getRankName(w.rank)}</div>
                    <div class="text-sm font-bold truncate">${w.name}</div>
                    <div class="text-xs text-gray-400 mt-1">
                      ${w.atk ? `ATK+${w.atk}` : ''} ${w.def ? `DEF+${w.def}` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
            `}
          </div>
        </div>
      `;
    }

    function renderLevelClearScreen(container) {
      container.innerHTML = `
        <div class="h-full w-full flex flex-col items-center justify-center p-4" style="background: radial-gradient(ellipse at center, #1e3f3f 0%, #0a1a1a 100%);">
          <div class="text-6xl mb-4">â­</div>
          <h2 class="text-3xl font-bold mb-4 text-cyan-400">ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ï¼</h2>
          <p class="text-xl text-gray-300 mb-6">3ä½“ã®æ•µã‚’æ’ƒç ´ï¼ãƒœã‚¹ãŒç¾ã‚Œã‚‹...</p>
          <button onclick="startBossBattle()"
            class="px-8 py-4 text-xl font-bold rounded-xl bg-red-600 hover:bg-red-500 transition-all pulse-glow">
            ãƒœã‚¹ã«æŒ‘ã‚€ï¼
          </button>
        </div>
      `;
    }

    // =========================
    // Game Logic
    // =========================
    function startGame() {
      const nameInput = document.getElementById('playerNameInput');
      gameState.playerName = (nameInput?.value || 'å‹‡è€…').trim();
      if (!gameState.playerName) gameState.playerName = 'å‹‡è€…';
      gameState.screen = 'difficulty';
      render();
    }

    function selectDifficulty(level) {
      gameState.difficulty = level;
      gameState.playerHP = 100;
      gameState.maxHP = 100;
      gameState.defeatedCount = 0;
      gameState.combo = 0;
      gameState.message = '';
      gameState.droppedWeapon = null;

      spawnEnemy();
      getNewQuestion();
      gameState.screen = 'battle';
      render();
    }

    function goToDifficulty() {
      stopTimer();
      gameState.screen = 'difficulty';
      render();
    }

    function goToInventory() {
      stopTimer();
      gameState.screen = 'inventory';
      render();
    }

    function equipWeapon(index) {
      gameState.equippedWeapon = gameState.weapons[index];
      render();
    }

    function equipNewWeapon() {
      if (gameState.droppedWeapon && !gameState.weapons.find(w => w.id === gameState.droppedWeapon.id)) {
        gameState.weapons.push(gameState.droppedWeapon);
      }
      gameState.equippedWeapon = gameState.droppedWeapon;
      continueAfterDrop();
    }

    function continueAfterDrop() {
      if (gameState.droppedWeapon && !gameState.weapons.find(w => w.id === gameState.droppedWeapon.id)) {
        gameState.weapons.push(gameState.droppedWeapon);
      }
      gameState.droppedWeapon = null;

      // æ¬¡ã¸
      if (!gameState.isBossBattle && gameState.defeatedCount >= 3) {
        gameState.screen = 'levelClear';
      } else {
        if (!gameState.isBossBattle) spawnEnemy();
        getNewQuestion();
        gameState.screen = 'battle';
      }
      render();
    }

    function startBossBattle() {
      spawnBoss();
      getNewQuestion();
      gameState.screen = 'battle';
      render();
    }

    function retryBattle() {
      stopTimer();
      gameState.playerHP = 100;
      gameState.defeatedCount = 0;
      gameState.combo = 0;
      gameState.isBossBattle = false;
      gameState.message = '';
      gameState.droppedWeapon = null;

      spawnEnemy();
      getNewQuestion();
      gameState.screen = 'battle';
      render();
    }

    // =========================
    // Flick Input (Pointer Events)
    // =========================
    let flickStartPos = null;
    let currentFlickKey = null;

    function startFlick(event, key) {
      event.preventDefault();
      const p = event;
      flickStartPos = { x: p.clientX, y: p.clientY };
      currentFlickKey = key;

      const keyEl = event.target.closest('.flick-key');
      if (keyEl) keyEl.classList.add('active');
    }

    function moveFlick(event) {
      if (!flickStartPos) return;
      event.preventDefault();
    }

    function endFlick(event) {
      if (!flickStartPos || !currentFlickKey) {
        flickStartPos = null;
        currentFlickKey = null;
        return;
      }

      event.preventDefault();
      const endPos = { x: event.clientX, y: event.clientY };

      const dx = endPos.x - flickStartPos.x;
      const dy = endPos.y - flickStartPos.y;
      const threshold = 30;

      let direction = 'center';
      if (Math.abs(dx) > threshold || Math.abs(dy) > threshold) {
        if (Math.abs(dx) > Math.abs(dy)) direction = dx > 0 ? 'right' : 'left';
        else direction = dy > 0 ? 'down' : 'up';
      }

      processFlickInput(currentFlickKey, direction);

      document.querySelectorAll('.flick-key').forEach(el => el.classList.remove('active'));
      flickStartPos = null;
      currentFlickKey = null;
    }

    function processFlickInput(key, direction) {
      if (key === 'âŒ«') {
        gameState.inputText = gameState.inputText.slice(0, -1);
      } else if (key === 'ã‚›') {
        applyDakuten();
      } else if (key === 'ã‚œ') {
        applyHandakuten();
      } else if (key === 'å°') {
        applySmall();
      } else if (key === 'ãƒ¼') {
        gameState.inputText += 'ãƒ¼';
      } else if (flickMap[key]) {
        const char = flickMap[key][direction] || flickMap[key].center;
        if (char && char !== 'ï¼ˆ' && char !== 'ï¼‰' && char !== 'ã€œ') {
          gameState.inputText += char;
        }
      }
      syncInputDisplay();
    }

    function applyDakuten() {
      if (!gameState.inputText) return;
      const lastChar = gameState.inputText.slice(-1);
      if (dakutenMap[lastChar]) gameState.inputText = gameState.inputText.slice(0, -1) + dakutenMap[lastChar];
    }

    function applyHandakuten() {
      if (!gameState.inputText) return;
      const lastChar = gameState.inputText.slice(-1);
      if (handakutenMap[lastChar]) gameState.inputText = gameState.inputText.slice(0, -1) + handakutenMap[lastChar];
    }

    function applySmall() {
      if (!gameState.inputText) return;
      const lastChar = gameState.inputText.slice(-1);
      if (smallMap[lastChar]) gameState.inputText = gameState.inputText.slice(0, -1) + smallMap[lastChar];
    }

    // =========================
    // Answer / Battle
    // =========================
    function submitAnswer() {
      stopTimer();
      const answer = (gameState.inputText || '').toLowerCase();
      const correct = (gameState.currentQuestion.reading || '').toLowerCase();

      if (answer === correct) handleCorrectAnswer();
      else handleWrongAnswer();
    }

    function handleTimeOut() {
      gameState.combo = 0;
      const enemyDamage = gameState.currentEnemy.atk;
      gameState.playerHP -= enemyDamage;
      gameState.message = `â° æ™‚é–“åˆ‡ã‚Œ... æ­£è§£ã¯ã€Œ${gameState.currentQuestion.reading}ã€ ${enemyDamage}ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸï¼`;

      if (gameState.playerHP <= 0) {
        gameState.playerHP = 0;
        gameState.screen = 'gameOver';
      } else {
        getNewQuestion();
      }
      render();
    }

    function handleCorrectAnswer() {
      gameState.combo++;
      const damage = calculateDamage();
      gameState.enemyHP -= damage;
      gameState.message = `âœ¨ æ­£è§£ï¼ ${damage}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼ ã‚³ãƒ³ãƒœ${gameState.combo}x`;

      const enemySprite = document.getElementById('enemySprite');
      if (enemySprite) {
        enemySprite.classList.add('damage-flash');
        setTimeout(() => enemySprite.classList.remove('damage-flash'), 200);
      }

      if (gameState.enemyHP <= 0) handleEnemyDefeat();
      else { getNewQuestion(); render(); }
    }

    function handleWrongAnswer() {
      gameState.combo = 0;
      const enemyDamage = gameState.currentEnemy.atk;
      gameState.playerHP -= enemyDamage;
      gameState.message = `âŒ ä¸æ­£è§£... æ­£è§£ã¯ã€Œ${gameState.currentQuestion.reading}ã€ ${enemyDamage}ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸï¼`;

      if (gameState.playerHP <= 0) {
        gameState.playerHP = 0;
        gameState.screen = 'gameOver';
      } else {
        getNewQuestion();
      }
      render();
    }

    function handleEnemyDefeat() {
      gameState.totalDefeated++;

      // ãƒœã‚¹æ’ƒç ´
      if (gameState.isBossBattle) {
        const diffKey = gameState.difficulty === 'ore' ? 'ore' : gameState.difficulty;
        if (!gameState.clearedLevels.includes(diffKey)) gameState.clearedLevels.push(diffKey);

        gameState.droppedWeapon = getRandomWeapon();
        gameState.screen = 'weaponDrop';
        render();

        // â€»å‹æ‰‹ã«victoryã¸é£›ã°ã•ãªã„ï¼ˆãƒœã‚¿ãƒ³æ“ä½œã§é€²ã‚€ï¼‰
        // weaponç²å¾— â†’ æ¬¡ã¸ãƒœã‚¿ãƒ³ã§difficultyã¸æˆ»ã‚‹æƒ³å®š
        // ãŸã ã—ã€Œå‹åˆ©ç”»é¢ã¯è¦‹ã›ãŸã„ã€ã®ã§ã€æ­¦å™¨å–å¾—å¾Œã«é›£æ˜“åº¦ã¸æˆ»ã™å‰ã«è¡¨ç¤ºã—ãŸã„å ´åˆã¯èª¿æ•´å¯
        setTimeout(() => {
          // æ­¦å™¨ç”»é¢ã®ã¾ã¾ã§ã‚‚è‰¯ã„ãŒã€è¡¨ç¤ºæ¼”å‡ºã ã‘è»½ãå…¥ã‚Œã‚‹ãªã‚‰ã“ã“ã§messageãªã©å¤‰ãˆã‚‹
        }, 10);

        return;
      }

      // é€šå¸¸æ•µæ’ƒç ´
      gameState.defeatedCount++;

      if (Math.random() < 0.7) {
        gameState.droppedWeapon = getRandomWeapon();
        gameState.screen = 'weaponDrop';
      } else if (gameState.defeatedCount >= 3) {
        gameState.screen = 'levelClear';
      } else {
        spawnEnemy();
        getNewQuestion();
        gameState.message = 'æ•µã‚’å€’ã—ãŸï¼æ¬¡ã®æ•µãŒç¾ã‚ŒãŸ...';
        gameState.screen = 'battle';
      }

      render();
    }

    // =========================
    // åˆæœŸåŒ–
    // =========================
    // ã“ã“ã§å¿…ãšæœ€åˆã®ç”»é¢ã‚’æç”»
    render();
  </script>
</body>
</html>
