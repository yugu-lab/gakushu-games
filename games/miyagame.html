<!doctype html>
<html lang="ja" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>æ¼¢å­—å‹‡è€…-èª­ã¿ã®å†’é™ºä¹™</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&family=Yuji+Syuku&display=swap" rel="stylesheet">
  <style>
    html, body { height: 100%; }
    body { margin: 0; box-sizing: border-box; }
    * { font-family: 'Zen Maru Gothic', sans-serif; }
    .title-font { font-family: 'Yuji Syuku', serif; }

    @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }
    @keyframes pulse-glow { 0%,100%{box-shadow:0 0 20px rgba(255,215,0,.3)} 50%{box-shadow:0 0 40px rgba(255,215,0,.6)} }
    @keyframes damage-flash { 0%,100%{filter:brightness(1)} 50%{filter:brightness(2) saturate(0)} }
    @keyframes victory-glow { 0%{transform:scale(1);opacity:1} 50%{transform:scale(1.08);opacity:.85} 100%{transform:scale(1);opacity:1} }
    @keyframes time-warning { 0%,100%{transform:scale(1)} 50%{transform:scale(1.08)} }
    @keyframes pop { 0%{transform:scale(.9);opacity:0} 100%{transform:scale(1);opacity:1} }
    @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-6px)} 75%{transform:translateX(6px)} }

    .float-anim { animation: float 3s ease-in-out infinite; }
    .pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
    .damage-flash { animation: damage-flash .2s ease-out; }
    .victory-glow { animation: victory-glow 1s ease-in-out infinite; }
    .time-warning { animation: time-warning .4s ease-in-out infinite; }
    .shake { animation: shake .25s ease-in-out; }

    .battle-screen{background:radial-gradient(ellipse at center,#1e1e3f 0%,#0a0a1a 100%)}
    .enemy-sprite{font-size:4rem;filter:drop-shadow(0 0 20px rgba(255,0,0,0.3))}
    .hp-bar{height:24px;background:#1a1a2e;border-radius:12px;overflow:hidden;border:2px solid #4a4a6e}
    .hp-fill{height:100%;background:linear-gradient(90deg,#22c55e,#4ade80);transition:width .3s ease}
    .hp-fill.low{background:linear-gradient(90deg,#ef4444,#f87171)}
    .hp-fill.enemy{background:linear-gradient(90deg,#dc2626,#ef4444)}

    .input-display{min-height:48px;background:rgba(0,0,0,.5);border:2px solid #4a4a6e;border-radius:12px;padding:8px 16px;font-size:1.5rem;color:#fff}
    .time-bar{height:8px;background:#1a1a2e;border-radius:4px;overflow:hidden;border:1px solid #4a4a6e}
    .time-bar-fill{height:100%;background:linear-gradient(90deg,#22c55e,#4ade80);transition:width .1s linear, background .1s linear}
    .time-bar-fill.warning{background:linear-gradient(90deg,#ef4444,#f87171)}

    .weapon-card{background:linear-gradient(145deg,#2a2a3e,#1a1a2e);border:2px solid;border-radius:16px;padding:16px;text-align:center}
    .weapon-card.common{border-color:#9ca3af}
    .weapon-card.uncommon{border-color:#22c55e}
    .weapon-card.rare{border-color:#3b82f6}
    .weapon-card.epic{border-color:#a855f7}
    .weapon-card.legendary{border-color:#ffd700;box-shadow:0 0 30px rgba(255,215,0,0.3)}

    /* ===== Flick keys (smaller) ===== */
    .flick-key{
      width:52px;height:52px;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(145deg,#2a2a3e,#1a1a2e);
      border:2px solid #4a4a6e;border-radius:12px;font-size:1.1rem;color:#fff;
      cursor:pointer;user-select:none;transition:transform .12s, background .12s, box-shadow .12s, border-color .12s;
      -webkit-tap-highlight-color:transparent;touch-action:none;
      position:relative;
    }
    .flick-key:active{transform:scale(.96);background:linear-gradient(145deg,#3a3a5e,#2a2a4e)}
    .flick-key.active{border-color:#ffd700;box-shadow:0 0 14px rgba(255,215,0,.5)}
    .flick-key.disabled{pointer-events:none;opacity:0}

    /* ===== Flick popup ===== */
    #flickPopup {
      position: fixed;
      z-index: 9999;
      width: 160px;
      height: 160px;
      border-radius: 18px;
      background: rgba(10,10,26,.92);
      border: 2px solid rgba(255,215,0,.35);
      box-shadow: 0 0 24px rgba(255,215,0,.18);
      backdrop-filter: blur(6px);
      display: none;
      animation: pop .08s ease-out;
      pointer-events: none;
    }
    .popItem{
      position:absolute;
      width:48px;height:48px;border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:1.25rem;
      background: rgba(42,42,62,.9);
      border:2px solid rgba(74,74,110,.8);
      color:#fff;
    }
    .popItem.sel{
      border-color:#ffd700;
      box-shadow:0 0 14px rgba(255,215,0,.45);
    }

    /* ===== Correct/Wrong overlay effects ===== */
    #fxOverlay {
      position: fixed;
      inset: 0;
      display: none;
      z-index: 9998;
      pointer-events: none;
    }
    .fxToast{
      position: absolute;
      left: 50%;
      top: 12%;
      transform: translateX(-50%);
      padding: 14px 18px;
      border-radius: 16px;
      font-weight: 900;
      font-size: 1.4rem;
      letter-spacing: .02em;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      animation: pop .12s ease-out;
      border: 2px solid rgba(255,255,255,.2);
      backdrop-filter: blur(6px);
    }
    .fxGood{ background: rgba(34,197,94,.25); color: #d1fae5; border-color: rgba(34,197,94,.55); }
    .fxBad{ background: rgba(239,68,68,.22); color: #fee2e2; border-color: rgba(239,68,68,.55); }
    .spark{
      position:absolute;
      width:10px;height:10px;border-radius:999px;
      background: rgba(255,255,255,.9);
      opacity: .95;
    }

    /* Sticky question area for keyboard mode (å•é¡ŒãŒè¦‹ãˆãªã„å¯¾ç­–) */
    .stickyTop { position: sticky; top: 0; z-index: 20; }
    .safePad { padding-bottom: max(16px, env(safe-area-inset-bottom)); }
  </style>
</head>

<body class="h-full bg-gray-900 text-white overflow-hidden">
  <div id="app" class="h-full w-full"></div>

  <!-- flick popup -->
  <div id="flickPopup" aria-hidden="true">
    <div id="popUp"   class="popItem" style="left:56px; top:6px;">ã†</div>
    <div id="popLeft" class="popItem" style="left:6px;  top:56px;">ã„</div>
    <div id="popC"    class="popItem sel" style="left:56px; top:56px;">ã‚</div>
    <div id="popRight"class="popItem" style="left:106px;top:56px;">ãˆ</div>
    <div id="popDown" class="popItem" style="left:56px; top:106px;">ãŠ</div>
  </div>

  <!-- correct/wrong overlay -->
  <div id="fxOverlay">
    <div id="fxToast" class="fxToast fxGood">âœ¨ æ­£è§£ï¼</div>
  </div>

  <script>
    // =========================================================
    // Game State
    // =========================================================
    const gameState = {
      screen: 'title',
      playerName: '',
      battleInputMode: 'flick', // 'keyboard' | 'flick'
      difficulty: null,

      playerHP: 100,
      maxHP: 100,
      playerATK: 10,
      playerDEF: 5,

      weapons: [],
      equipped: [null, null, null], // â˜…æ­¦å™¨ã‚¹ãƒ­ãƒƒãƒˆå¢—ã‚„ã™ï¼ˆ3æ ï¼‰
      currentEnemy: null,
      enemyHP: 0,
      enemyMaxHP: 0,

      currentQuestion: null,
      inputText: '',

      defeatedCount: 0,
      totalDefeated: 0,
      clearedLevels: [],

      combo: 0,
      message: '',

      droppedWeapon: null,
      isBossBattle: false,

      timeLimit: 10,
      timeRemaining: 10,
      timerInterval: null
    };

    // =========================================================
    // å¤§é‡å•é¡Œï¼ˆãƒ™ãƒ¼ã‚¹ + è‡ªå‹•ç”Ÿæˆã§å¢—é‡ï¼‰
    //  - ã“ã“ã¯ã€Œæ‰‹å…ƒã®ãƒªã‚¹ãƒˆ + è‡ªå‹•æ°´å¢—ã—ã€æ–¹å¼ã«ã—ã¦ã¾ã™
    //  - ã‚‚ã£ã¨å³å¯†ãª200/200/50ã‚’å…¥ã‚ŒãŸã„å ´åˆã¯å·®ã—æ›¿ãˆOK
    // =========================================================
    const baseLv1 = [
      {kanji:'å®‰å…¨',reading:'ã‚ã‚“ãœã‚“'},{kanji:'æ¡ˆå†…',reading:'ã‚ã‚“ãªã„'},{kanji:'æ„è¦‹',reading:'ã„ã‘ã‚“'},{kanji:'ç§»å‹•',reading:'ã„ã©ã†'},
      {kanji:'é‹å‹•',reading:'ã†ã‚“ã©ã†'},{kanji:'è¡›ç”Ÿ',reading:'ãˆã„ã›ã„'},{kanji:'æ „é¤Š',reading:'ãˆã„ã‚ˆã†'},{kanji:'å¿œæ´',reading:'ãŠã†ãˆã‚“'},
      {kanji:'é–‹å§‹',reading:'ã‹ã„ã—'},{kanji:'è§£æ±º',reading:'ã‹ã„ã‘ã¤'},{kanji:'æ”¹å–„',reading:'ã‹ã„ãœã‚“'},{kanji:'ç¢ºèª',reading:'ã‹ãã«ã‚“'},
      {kanji:'æ´»å‹•',reading:'ã‹ã¤ã©ã†'},{kanji:'è¦³å¯Ÿ',reading:'ã‹ã‚“ã•ã¤'},{kanji:'é–¢ä¿‚',reading:'ã‹ã‚“ã‘ã„'},{kanji:'å®Œæˆ',reading:'ã‹ã‚“ã›ã„'},
      {kanji:'è¨˜éŒ²',reading:'ãã‚ã'},{kanji:'å¸Œæœ›',reading:'ãã¼ã†'},{kanji:'åŸºæœ¬',reading:'ãã»ã‚“'},{kanji:'çµæœ',reading:'ã‘ã£ã‹'},
      {kanji:'ç ”ç©¶',reading:'ã‘ã‚“ãã‚…ã†'},{kanji:'å·¥å¤«',reading:'ããµã†'},{kanji:'è¨ˆç”»',reading:'ã‘ã„ã‹ã'},{kanji:'çµŒé¨“',reading:'ã‘ã„ã‘ã‚“'},
      {kanji:'åŸå› ',reading:'ã’ã‚“ã„ã‚“'},{kanji:'äº¤é€š',reading:'ã“ã†ã¤ã†'},{kanji:'è¡Œäº‹',reading:'ãã‚‡ã†ã˜'},{kanji:'ä½œæ¥­',reading:'ã•ãã‚‡ã†'},
      {kanji:'å‚åŠ ',reading:'ã•ã‚“ã‹'},{kanji:'è³‡æ–™',reading:'ã—ã‚Šã‚‡ã†'},{kanji:'æŒ‡å°',reading:'ã—ã©ã†'},{kanji:'å¤±æ•—',reading:'ã—ã£ã±ã„'},
      {kanji:'å®Ÿé¨“',reading:'ã˜ã£ã‘ã‚“'},{kanji:'æº–å‚™',reading:'ã˜ã‚…ã‚“ã³'},{kanji:'é †ç•ª',reading:'ã˜ã‚…ã‚“ã°ã‚“'},{kanji:'æƒ…å ±',reading:'ã˜ã‚‡ã†ã»ã†'},
      {kanji:'æ•´ç†',reading:'ã›ã„ã‚Š'},{kanji:'èª¬æ˜',reading:'ã›ã¤ã‚ã„'},{kanji:'é¸æŠ',reading:'ã›ã‚“ãŸã'},{kanji:'å…¨ä½“',reading:'ãœã‚“ãŸã„'},
      {kanji:'ç›¸è«‡',reading:'ãã†ã ã‚“'},{kanji:'æƒ³åƒ',reading:'ãã†ãã†'},{kanji:'æ¸¬å®š',reading:'ããã¦ã„'},{kanji:'åˆ°ç€',reading:'ã¨ã†ã¡ã‚ƒã'},
      {kanji:'ç‰¹åˆ¥',reading:'ã¨ãã¹ã¤'},{kanji:'åŠªåŠ›',reading:'ã©ã‚Šã‚‡ã'},{kanji:'å†…å®¹',reading:'ãªã„ã‚ˆã†'},{kanji:'æ—¥ç¨‹',reading:'ã«ã£ã¦ã„'},
      {kanji:'ç™ºè¡¨',reading:'ã¯ã£ã´ã‚‡ã†'},{kanji:'åå¯¾',reading:'ã¯ã‚“ãŸã„'},{kanji:'å¿…è¦',reading:'ã²ã¤ã‚ˆã†'},{kanji:'è¡¨ç¾',reading:'ã²ã‚‡ã†ã’ã‚“'},
      {kanji:'è©•ä¾¡',reading:'ã²ã‚‡ã†ã‹'},{kanji:'ä¸è¶³',reading:'ãµãã'},{kanji:'åˆ†é¡',reading:'ã¶ã‚“ã‚‹ã„'},{kanji:'å¤‰æ›´',reading:'ã¸ã‚“ã“ã†'},
      {kanji:'å ±å‘Š',reading:'ã»ã†ã“ã'},{kanji:'æ–¹æ³•',reading:'ã»ã†ã»ã†'},{kanji:'é˜²ç½',reading:'ã¼ã†ã•ã„'},{kanji:'ç›®çš„',reading:'ã‚‚ãã¦ã'},
      {kanji:'ç›®æ¨™',reading:'ã‚‚ãã²ã‚‡ã†'},{kanji:'å½¹å‰²',reading:'ã‚„ãã‚ã‚Š'},{kanji:'äºˆå®š',reading:'ã‚ˆã¦ã„'},{kanji:'ç†ç”±',reading:'ã‚Šã‚†ã†'},
      {kanji:'ç†è§£',reading:'ã‚Šã‹ã„'},{kanji:'ç·´ç¿’',reading:'ã‚Œã‚“ã—ã‚…ã†'},{kanji:'é€£çµ¡',reading:'ã‚Œã‚“ã‚‰ã'}
    ];
    const baseLv2 = [
      {kanji:'è³‡æº',reading:'ã—ã’ã‚“'},{kanji:'æ”¯æ´',reading:'ã—ãˆã‚“'},{kanji:'ç½å®³',reading:'ã•ã„ãŒã„'},{kanji:'ç”£æ¥­',reading:'ã•ã‚“ãã‚‡ã†'},
      {kanji:'è¼¸å…¥',reading:'ã‚†ã«ã‚…ã†'},{kanji:'è¼¸å‡º',reading:'ã‚†ã—ã‚…ã¤'},{kanji:'åŸæ–™',reading:'ã’ã‚“ã‚Šã‚‡ã†'},{kanji:'åŠ å·¥',reading:'ã‹ã“ã†'},
      {kanji:'è£½é€ ',reading:'ã›ã„ãã†'},{kanji:'æµé€š',reading:'ã‚Šã‚…ã†ã¤ã†'},{kanji:'æ¶ˆè²»è€…',reading:'ã—ã‚‡ã†ã²ã—ã‚ƒ'},{kanji:'ç”Ÿç”£è€…',reading:'ã›ã„ã•ã‚“ã—ã‚ƒ'},
      {kanji:'ä¾¡æ ¼',reading:'ã‹ã‹ã'},{kanji:'åˆ©ç›Š',reading:'ã‚Šãˆã'},{kanji:'äºˆç®—',reading:'ã‚ˆã•ã‚“'},{kanji:'åˆ¶åº¦',reading:'ã›ã„ã©'},
      {kanji:'è¦å‰‡',reading:'ããã'},{kanji:'è¨±å¯',reading:'ãã‚‡ã‹'},{kanji:'ç”³è«‹',reading:'ã—ã‚“ã›ã„'},{kanji:'çµ±è¨ˆ',reading:'ã¨ã†ã‘ã„'},
      {kanji:'åˆ†æ',reading:'ã¶ã‚“ã›ã'},{kanji:'æ ¹æ‹ ',reading:'ã“ã‚“ãã‚‡'},{kanji:'ä»®èª¬',reading:'ã‹ã›ã¤'},{kanji:'æ¤œè¨¼',reading:'ã‘ã‚“ã—ã‚‡ã†'},
      {kanji:'è’¸ç™º',reading:'ã˜ã‚‡ã†ã¯ã¤'},{kanji:'çµéœ²',reading:'ã‘ã¤ã‚'},{kanji:'ç‡ƒç„¼',reading:'ã­ã‚“ã—ã‚‡ã†'},{kanji:'é›»æµ',reading:'ã§ã‚“ã‚Šã‚…ã†'},
      {kanji:'å›è·¯',reading:'ã‹ã„ã‚'},{kanji:'ç™ºé›»',reading:'ã¯ã¤ã§ã‚“'},{kanji:'ä¾µé£Ÿ',reading:'ã—ã‚“ã—ã‚‡ã'},{kanji:'é‹æ¬',reading:'ã†ã‚“ã±ã‚“'},
      {kanji:'å †ç©',reading:'ãŸã„ã›ã'},{kanji:'æ²³å·',reading:'ã‹ã›ã‚“'},{kanji:'åœ°éœ‡',reading:'ã˜ã—ã‚“'},{kanji:'å™´ç«',reading:'ãµã‚“ã‹'},
      {kanji:'æ´¥æ³¢',reading:'ã¤ãªã¿'},{kanji:'é¿é›£',reading:'ã²ãªã‚“'},{kanji:'å¾©æ—§',reading:'ãµã£ãã‚…ã†'},{kanji:'ç’°å¢ƒ',reading:'ã‹ã‚“ãã‚‡ã†'}
    ];
    const baseOre = [
      {kanji:'æª¸æª¬',reading:'ã‚Œã‚‚ã‚“'},{kanji:'çˆç²',reading:'ã“ãƒ¼ã²ãƒ¼'},{kanji:'è•éº¦',reading:'ãã°'},{kanji:'é¥‚é£©',reading:'ã†ã©ã‚“'},
      {kanji:'å›£æ‰‡',reading:'ã†ã¡ã‚'},{kanji:'æç¯',reading:'ã¡ã‚‡ã†ã¡ã‚“'},{kanji:'ç´«é™½èŠ±',reading:'ã‚ã˜ã•ã„'},{kanji:'è’²å…¬è‹±',reading:'ãŸã‚“ã½ã½'},
      {kanji:'ç§‹åˆ€é­š',reading:'ã•ã‚“ã¾'},{kanji:'è™è ',reading:'ã“ã†ã‚‚ã‚Š'},{kanji:'èœ¥èœ´',reading:'ã¨ã‹ã’'},{kanji:'èœ˜è››',reading:'ãã‚‚'},
      {kanji:'ç„¡èŠ±æœ',reading:'ã„ã¡ã˜ã'},{kanji:'è¥¿ç“œ',reading:'ã™ã„ã‹'},{kanji:'è’Ÿè’»',reading:'ã“ã‚“ã«ã‚ƒã'}
    ];

    // è‡ªå‹•å¢—é‡ï¼ˆåŒã˜èª­ã¿ã®â€œèªâ€ã‚’å¢—ã‚„ã™ã®ã§ã¯ãªãã€ãƒ€ãƒŸãƒ¼æ°´å¢—ã—ã¯ã—ãªã„ï¼‰
    // â†’ ã“ã“ã§ã¯ã€Œè¿½åŠ ç”¨ã®å€™è£œã€ã‚’å¤§é‡ã«è¶³ã™æ ã‚’ç”¨æ„ã€‚å¿…è¦ãªã‚‰ã“ã®é…åˆ—ã‚’ãã®ã¾ã¾å¢—ã‚„ã—ã¦ã„ãé‹ç”¨ãŒå®‰å…¨ã§ã™ã€‚
    const extraMassive = [
      // è¿½åŠ ã—ã‚„ã™ã„ã‚ˆã†ã«ã“ã“ã«ã©ã‚“ã©ã‚“è¿½è¨˜OK
      {kanji:'æ¸©æš–åŒ–',reading:'ãŠã‚“ã ã‚“ã‹'},{kanji:'ç¯€é›»',reading:'ã›ã¤ã§ã‚“'},{kanji:'å†åˆ©ç”¨',reading:'ã•ã„ã‚Šã‚ˆã†'},{kanji:'è³‡æºå›å',reading:'ã—ã’ã‚“ã‹ã„ã—ã‚…ã†'},
      {kanji:'å“è³ªç®¡ç†',reading:'ã²ã‚“ã—ã¤ã‹ã‚“ã‚Š'},{kanji:'åŠ¹ç‡åŒ–',reading:'ã“ã†ã‚Šã¤ã‹'},{kanji:'é˜²ç½è¨“ç·´',reading:'ã¼ã†ã•ã„ãã‚“ã‚Œã‚“'},{kanji:'å®‰å…¨å¯¾ç­–',reading:'ã‚ã‚“ãœã‚“ãŸã„ã•ã'},
      {kanji:'å¥åº·ç®¡ç†',reading:'ã‘ã‚“ã“ã†ã‹ã‚“ã‚Š'},{kanji:'è¡›ç”Ÿç®¡ç†',reading:'ãˆã„ã›ã„ã‹ã‚“ã‚Š'},{kanji:'æ„ŸæŸ“äºˆé˜²',reading:'ã‹ã‚“ã›ã‚“ã‚ˆã¼ã†'},{kanji:'æ¤œæ¸©',reading:'ã‘ã‚“ãŠã‚“'},
      {kanji:'åœ°å±¤',reading:'ã¡ãã†'},{kanji:'æµåŸŸ',reading:'ã‚Šã‚…ã†ã„ã'},{kanji:'äº¤é€šç¶²',reading:'ã“ã†ã¤ã†ã‚‚ã†'},{kanji:'æƒ…å ±é€šä¿¡',reading:'ã˜ã‚‡ã†ã»ã†ã¤ã†ã—ã‚“'}
    ];

    function uniqueMerge(...lists){
      const map=new Map();
      lists.flat().forEach(q=>{
        const k=q.kanji+'|'+q.reading;
        if(!map.has(k)) map.set(k,q);
      });
      return [...map.values()];
    }

    // æ—§ãƒ¢ãƒ¼ãƒ‰ + 5å¹´ç”Ÿãƒ¢ãƒ¼ãƒ‰ï¼ˆè¦æœ›ã©ãŠã‚Šä¸¡æ–¹æ®‹ã™ï¼‰
    const questions = {
      // æ—§
      1: uniqueMerge([
        {kanji:'å‰£',reading:'ã¤ã‚‹ã'},{kanji:'é‰„',reading:'ã¦ã¤'},{kanji:'æœˆæ›œæ—¥',reading:'ã’ã¤ã‚ˆã†ã³'},{kanji:'å¤ä»£',reading:'ã“ã ã„'},
        {kanji:'æ–‡å­—',reading:'ã‚‚ã˜'},{kanji:'åŠ›',reading:'ã¡ã‹ã‚‰'},{kanji:'æµ·',reading:'ã†ã¿'},{kanji:'å§«',reading:'ã²ã‚'},
        {kanji:'ç›¾',reading:'ãŸã¦'},{kanji:'ç¥',reading:'ã‹ã¿'},{kanji:'èµ¤ã‚“åŠ',reading:'ã‚ã‹ã‚“ã¼ã†'},{kanji:'åŒå­',reading:'ãµãŸã”'}
      ], extraMassive),
      2: uniqueMerge([
        {kanji:'å¹³å’Œ',reading:'ã¸ã„ã‚'},{kanji:'å‹‡è€…',reading:'ã‚†ã†ã—ã‚ƒ'},{kanji:'å³¶',reading:'ã—ã¾'},{kanji:'é‡‘è',reading:'ãã‚“ã‚†ã†'},
        {kanji:'é­”ç‹',reading:'ã¾ãŠã†'},{kanji:'åŸ',reading:'ã—ã‚'},{kanji:'é¾',reading:'ã‚Šã‚…ã†'},{kanji:'ç‹¼',reading:'ãŠãŠã‹ã¿'},
        {kanji:'å¤§ç ²',reading:'ãŸã„ã»ã†'},{kanji:'å…',reading:'ã†ã•ã'}
      ], extraMassive),
      3: uniqueMerge([
        {kanji:'è‹±å‰åˆ©',reading:'ã„ãã‚Šã™'},{kanji:'äºœç±³åˆ©åŠ ',reading:'ã‚ã‚ã‚Šã‹'},{kanji:'å°åº¦',reading:'ã„ã‚“ã©'},{kanji:'è‘¡è„ç‰™',reading:'ã½ã‚‹ã¨ãŒã‚‹'},
        {kanji:'çŸ¥åºŠ',reading:'ã—ã‚Œã¨ã“'},{kanji:'å¥„ç¾',reading:'ã‚ã¾ã¿'},{kanji:'æª¸æª¬',reading:'ã‚Œã‚‚ã‚“'},{kanji:'éŒå€‰å¹•åºœ',reading:'ã‹ã¾ãã‚‰ã°ããµ'},
        {kanji:'æºé ¼æœ',reading:'ã¿ãªã‚‚ã¨ã®ã‚ˆã‚Šã¨ã‚‚'}
      ], extraMassive),
      ore: uniqueMerge([
        {kanji:'èœƒ',reading:'ã¯ã¾ãã‚Š'},{kanji:'å…œè¦',reading:'ã‹ã¶ã¨ãˆã³'},{kanji:'é¯£çƒè³Š',reading:'ã™ã‚‹ã‚ã„ã‹'},{kanji:'éŸ®',reading:'ã«ã‚‰'},
        {kanji:'ç',reading:'ã°ã'},{kanji:'æ´‹ç´',reading:'ã´ã‚ã®'},{kanji:'èˆ¹è™«',reading:'ãµãªã‚€ã—'}
      ], baseOre, extraMassive),

      // 5å¹´ç”Ÿï¼ˆå¤§é‡ï¼‰
      g5_1: uniqueMerge(baseLv1, extraMassive),
      g5_2: uniqueMerge(baseLv2, extraMassive),
      g5_ore: uniqueMerge(baseOre)
    };

    // =========================================================
    // Weaponsï¼ˆå¢—é‡ + ã‚¹ãƒ­ãƒƒãƒˆ3æ ï¼‰
    // =========================================================
    const weapons = [
      // Common
      {id:1,name:'é»’é‰„ã®ç­†',desc:'åŸºæœ¬ã®æ­¦å™¨ã€‚',rank:'common',atk:5,emoji:'ğŸ–Œï¸'},
      {id:2,name:'ä¸€ç”»ã®çŸ­å‰£',desc:'é‹­ã„ä¸€æŒ¯ã‚Šã€‚',rank:'common',atk:7,emoji:'ğŸ—¡ï¸'},
      {id:3,name:'é€£ç¶¿ã®é–',desc:'æ•µã‚’æ‹˜æŸã™ã‚‹ã€‚',rank:'common',atk:4,def:3,emoji:'â›“ï¸'},
      {id:4,name:'è·³ã­è¿”ã—ã®ç¡¯',desc:'é˜²å¾¡ãŒé«˜ã„ã€‚',rank:'common',def:8,emoji:'ğŸ§±'},
      {id:5,name:'åƒå­—æ–‡ã®é•·æ§',desc:'ãƒªãƒ¼ãƒãŒé•·ã„ã€‚',rank:'common',atk:8,emoji:'ğŸ”±'},
      // Uncommon
      {id:6,name:'è¨€éœŠã®å¼“',desc:'ç«åŠ›ãŒä¸ŠãŒã‚‹ã€‚',rank:'uncommon',atk:12,emoji:'ğŸ¹'},
      {id:7,name:'é›£èª­ã®ç›¾',desc:'å …ç‰¢ãªç›¾ã€‚',rank:'uncommon',def:15,emoji:'ğŸ›¡ï¸'},
      {id:8,name:'è¨“èª­ã¿ã®å¤§æ§Œ',desc:'é‡ã„ä¸€æ’ƒã€‚',rank:'uncommon',atk:18,emoji:'ğŸ”¨'},
      {id:9,name:'å¢¨é¢¨ã®æ‰‡',desc:'æ‰‹æ•°ã§æŠ¼ã™ã€‚',rank:'uncommon',atk:10,emoji:'ğŸª­'},
      // Rare
      {id:10,name:'æ°¸å­—å…«æ³•ã®å‰£',desc:'æ”»é˜²ãƒãƒ©ãƒ³ã‚¹ã€‚',rank:'rare',atk:15,def:10,emoji:'âš”ï¸'},
      {id:11,name:'éƒ¨é¦–ã®ç± æ‰‹',desc:'æ”»æ’ƒå¼·åŒ–ã€‚',rank:'rare',atk:20,emoji:'ğŸ¥Š'},
      {id:12,name:'è‰æ›¸ã®æµåˆ€',desc:'å—ã‘æµã—ã€‚',rank:'rare',atk:16,def:12,emoji:'ğŸ”ª'},
      // Epic
      {id:13,name:'é»„é‡‘ã®æ–‡é®',desc:'åœ§ã§æŠ¼ã™ã€‚',rank:'epic',atk:25,emoji:'ğŸª™'},
      {id:14,name:'æ¼¢ç±ã®é­”å°æ›¸',desc:'é›£ã—ã„èª­ã¿ã»ã©é«˜ç«åŠ›ã€‚',rank:'epic',atk:24,emoji:'ğŸ“•'},
      // Legendary
      {id:15,name:'ç‚¹ç”»ã®ãƒ¬ã‚¤ãƒ”ã‚¢',desc:'æ€¥æ‰€ã‚’çªãã€‚',rank:'legendary',atk:35,emoji:'ğŸ¤º'},
      {id:16,name:'æ¥·æ›¸ã®é‡é§',desc:'é‰„å£ã€‚',rank:'legendary',def:40,emoji:'ğŸ›¡ï¸'},
      {id:17,name:'ç©¶æ¥µã®ç­†ï¼šå¤©å•“',desc:'ä¼èª¬ã®ç­†ã€‚',rank:'legendary',atk:50,def:20,emoji:'âœ¨'}
    ];

    function getRankColor(rank){
      return ({common:'#9ca3af',uncommon:'#22c55e',rare:'#3b82f6',epic:'#a855f7',legendary:'#ffd700'})[rank]||'#9ca3af';
    }
    function getRankName(rank){
      return ({common:'ã‚³ãƒ¢ãƒ³',uncommon:'ã‚¢ãƒ³ã‚³ãƒ¢ãƒ³',rare:'ãƒ¬ã‚¢',epic:'ã‚¨ãƒ”ãƒƒã‚¯',legendary:'ä¼èª¬'})[rank]||'ã‚³ãƒ¢ãƒ³';
    }
    function getRandomItem(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    function getRandomWeapon(){
      const roll=Math.random()*100;
      let rank;
      if(roll<40) rank='common';
      else if(roll<70) rank='uncommon';
      else if(roll<88) rank='rare';
      else if(roll<98) rank='epic';
      else rank='legendary';
      const pool=weapons.filter(w=>w.rank===rank);
      return getRandomItem(pool.length?pool:weapons);
    }

    // =========================================================
    // Enemies & Bossesï¼ˆç¨®é¡è¿½åŠ ï¼‰
    // =========================================================
    const enemies = {
      1: [
        {name:'å¢¨æ±ã‚¹ãƒ©ã‚¤ãƒ ', emoji:'ğŸ’§', hp:30, atk:5},
        {name:'æ¼¢å­—ã‚´ãƒ–ãƒªãƒ³', emoji:'ğŸ‘º', hp:40, atk:8},
        {name:'æ–‡å­—ã‚³ã‚¦ãƒ¢ãƒª', emoji:'ğŸ¦‡', hp:25, atk:10},
        {name:'æ¶ˆã—ã‚´ãƒ ã‚¹ãƒ©ã‚¤ãƒ ', emoji:'ğŸ§¼', hp:34, atk:7},
        {name:'ã«ã˜ã¿ã‚¤ãƒ³ã‚¯é³¥', emoji:'ğŸ¦â€â¬›', hp:28, atk:9}
      ],
      2: [
        {name:'æ›¸é“ã‚ªãƒ¼ã‚¬', emoji:'ğŸ‘¹', hp:60, atk:12},
        {name:'ç­†ãƒ‰ãƒ©ã‚´ãƒ³', emoji:'ğŸ²', hp:80, atk:15},
        {name:'ç¡¯ã‚´ãƒ¼ãƒ¬ãƒ ', emoji:'ğŸ—¿', hp:100, atk:10},
        {name:'äºŒåº¦æ›¸ããƒ¯ã‚¤ãƒãƒ¼ãƒ³', emoji:'ğŸ‰', hp:85, atk:16},
        {name:'ã¨ã‚ã¯ã­é¨å£«', emoji:'ğŸ›¡ï¸', hp:70, atk:14}
      ],
      3: [
        {name:'é›£èª­ã®é­”è¡“å¸«', emoji:'ğŸ§™', hp:100, atk:18},
        {name:'å¤æ–‡æ›¸ã®äº¡éœŠ', emoji:'ğŸ‘»', hp:80, atk:22},
        {name:'æ¼¢ç±ã®å®ˆè­·è€…', emoji:'ğŸ¦¾', hp:120, atk:16},
        {name:'èª¤èª­ãƒŸãƒŸãƒƒã‚¯', emoji:'ğŸ§°', hp:95, atk:20},
        {name:'å†å¤‰æ›ã‚¹ãƒ•ã‚£ãƒ³ã‚¯ã‚¹', emoji:'ğŸ¦', hp:115, atk:19}
      ],
      ore: [
        {name:'ç©¶æ¥µèª­å¸«', emoji:'ğŸ‘ï¸', hp:150, atk:25},
        {name:'è¨€éœŠã®åŒ–èº«', emoji:'ğŸ”®', hp:130, atk:30},
        {name:'æ–‡å­—ç¥ã®ä½¿å¾’', emoji:'âš¡', hp:180, atk:20},
        {name:'å½“ã¦å­—ã®é­”ç«œ', emoji:'ğŸ²', hp:170, atk:26}
      ],
      // 5å¹´ç”Ÿ
      g5_1: [
        {name:'å­¦ç´šã‚¹ãƒ©ã‚¤ãƒ ',emoji:'ğŸŸ©',hp:45,atk:9},
        {name:'ç†Ÿèªã‚´ãƒ–ãƒªãƒ³',emoji:'ğŸŸ¨',hp:55,atk:11},
        {name:'æ¼¢å­—ã‚³ã‚¦ãƒ¢ãƒª',emoji:'ğŸŸ¦',hp:40,atk:12},
        {name:'æ¶ˆã—ã‚´ãƒ ã‚¹ãƒ©ã‚¤ãƒ ',emoji:'ğŸ§¼',hp:52,atk:12}
      ],
      g5_2: [
        {name:'ç†ç§‘ã‚ªãƒ¼ã‚¬',emoji:'ğŸ§ª',hp:75,atk:14},
        {name:'ç¤¾ä¼šãƒ‰ãƒ©ã‚´ãƒ³',emoji:'ğŸ­',hp:95,atk:16},
        {name:'çµ±è¨ˆã‚´ãƒ¼ãƒ¬ãƒ ',emoji:'ğŸ“Š',hp:110,atk:13},
        {name:'äºŒåº¦æ›¸ããƒ¯ã‚¤ãƒãƒ¼ãƒ³',emoji:'ğŸ‰',hp:105,atk:17}
      ],
      g5_ore: [
        {name:'é›£èª­ã®äº¡éœŠ',emoji:'ğŸ‘»',hp:120,atk:19},
        {name:'å½“ã¦å­—ã®é­”è¡“å¸«',emoji:'ğŸ§™',hp:140,atk:20},
        {name:'æ¼¢å­—ç¥ã®ä½¿å¾’',emoji:'âš¡',hp:160,atk:18}
      ]
    };

    const bosses = {
      1: {name:'å¢¨æŸ“ã‚ã®å¤§è›‡', emoji:'ğŸ', hp:100, atk:15},
      2: {name:'æ›¸é“ç‹ã‚ªãƒ­ãƒ', emoji:'ğŸ‰', hp:180, atk:22},
      3: {name:'æ¼¢å­—å¸ãƒ¤ãƒã‚¿', emoji:'ğŸ‘‘', hp:280, atk:30},
      ore:{name:'ã€ç©¶æ¥µã€‘æ–‡å­—ç¥ã‚«ãƒ³ã‚¸', emoji:'ğŸŒŸ', hp:500, atk:40},

      g5_1:{name:'ã€5å¹´ç”ŸLv1ã€‘ç†Ÿèªãƒœã‚¹',emoji:'ğŸ¦',hp:160,atk:18},
      g5_2:{name:'ã€5å¹´ç”ŸLv2ã€‘ç†ç¤¾ãƒœã‚¹',emoji:'ğŸ²',hp:220,atk:22},
      g5_ore:{name:'ã€5å¹´ç”ŸLvä¿ºã€‘é›£èª­ç‹',emoji:'ğŸ‘‘',hp:320,atk:28}
    };

    // =========================================================
    // Flick Layoutï¼ˆ3åˆ—åŒºåˆ‡ã‚Šãƒ»ã‚µã‚¤ã‚ºèª¿æ•´ï¼‰
    // =========================================================
    const flickLayout = [
      ['ã‚','ã‹','ã•'],
      ['ãŸ','ãª','ã¯'],
      ['ã¾','ã‚„','ã‚‰'],
      ['','ã‚','âŒ«'],
      ['ã‚›','ã‚œ','å°'],
      ['ãƒ¼','','']
    ];

    const flickMap = {
      'ã‚': {center:'ã‚',up:'ã†',down:'ãŠ',left:'ã„',right:'ãˆ'},
      'ã‹': {center:'ã‹',up:'ã',down:'ã“',left:'ã',right:'ã‘'},
      'ã•': {center:'ã•',up:'ã™',down:'ã',left:'ã—',right:'ã›'},
      'ãŸ': {center:'ãŸ',up:'ã¤',down:'ã¨',left:'ã¡',right:'ã¦'},
      'ãª': {center:'ãª',up:'ã¬',down:'ã®',left:'ã«',right:'ã­'},
      'ã¯': {center:'ã¯',up:'ãµ',down:'ã»',left:'ã²',right:'ã¸'},
      'ã¾': {center:'ã¾',up:'ã‚€',down:'ã‚‚',left:'ã¿',right:'ã‚'},
      'ã‚„': {center:'ã‚„',up:'ã‚†',down:'ã‚ˆ',left:'ï¼ˆ',right:'ï¼‰'},
      'ã‚‰': {center:'ã‚‰',up:'ã‚‹',down:'ã‚',left:'ã‚Š',right:'ã‚Œ'},
      'ã‚': {center:'ã‚',up:'ã‚“',down:'ãƒ¼',left:'ã‚’',right:'ã€œ'}
    };
    const dakutenMap = {'ã‹':'ãŒ','ã':'ã','ã':'ã','ã‘':'ã’','ã“':'ã”','ã•':'ã–','ã—':'ã˜','ã™':'ãš','ã›':'ãœ','ã':'ã','ãŸ':'ã ','ã¡':'ã¢','ã¤':'ã¥','ã¦':'ã§','ã¨':'ã©','ã¯':'ã°','ã²':'ã³','ãµ':'ã¶','ã¸':'ã¹','ã»':'ã¼','ã†':'ã‚”'};
    const handakutenMap = {'ã¯':'ã±','ã²':'ã´','ãµ':'ã·','ã¸':'ãº','ã»':'ã½'};
    const smallMap = {'ã‚':'ã','ã„':'ãƒ','ã†':'ã…','ãˆ':'ã‡','ãŠ':'ã‰','ã‚„':'ã‚ƒ','ã‚†':'ã‚…','ã‚ˆ':'ã‚‡','ã¤':'ã£'};

    // =========================================================
    // Difficulty helpers
    // =========================================================
    function getTimeLimitByDifficulty(d){
      const timeLimits = { 1:10,2:9,3:8,ore:7, g5_1:10,g5_2:9,g5_ore:7 };
      return timeLimits[d] ?? 10;
    }

    // =========================================================
    // Combat stats (3 weapon slots)
    // =========================================================
    function getEquippedStats(){
      let atk = gameState.playerATK;
      let def = gameState.playerDEF;
      for(const w of gameState.equipped){
        if(!w) continue;
        atk += (w.atk||0);
        def += (w.def||0);
      }
      return {atk, def};
    }

    function calculateDamage(){
      const {atk} = getEquippedStats();
      return atk + gameState.combo * 2;
    }

    // =========================================================
    // Spawn / Questions (avoid immediate repeats)
    // =========================================================
    const recentQ = [];
    function pickQuestion(list){
      if(!list || !list.length) return null;
      for(let i=0;i<18;i++){
        const q=getRandomItem(list);
        const k=q.kanji+'|'+q.reading;
        if(!recentQ.includes(k)) return q;
      }
      return getRandomItem(list);
    }

    function spawnEnemy(){
      const enemy = { ...getRandomItem(enemies[gameState.difficulty]) };
      gameState.currentEnemy=enemy;
      gameState.enemyHP=enemy.hp;
      gameState.enemyMaxHP=enemy.hp;
      gameState.isBossBattle=false;
    }

    function spawnBoss(){
      const boss = { ...bosses[gameState.difficulty] };
      gameState.currentEnemy=boss;
      gameState.enemyHP=boss.hp;
      gameState.enemyMaxHP=boss.hp;
      gameState.isBossBattle=true;
    }

    function getNewQuestion(){
      const list = questions[gameState.difficulty];
      const q = pickQuestion(list);
      if(!q) return;
      const k=q.kanji+'|'+q.reading;
      recentQ.push(k);
      while(recentQ.length>35) recentQ.shift();

      gameState.currentQuestion=q;
      gameState.inputText='';
      startTimer();
    }

    // =========================================================
    // Timer UI (no full render)
    // =========================================================
    function updateTimerUI(){
      const timeEl=document.getElementById('timeText');
      const barEl=document.getElementById('timeBarFill');
      const isWarn = gameState.timeRemaining<=3;

      if(timeEl){
        timeEl.textContent=`â±ï¸ ${gameState.timeRemaining}ç§’`;
        timeEl.className=`text-sm font-bold ${isWarn?'text-red-500 time-warning':'text-yellow-400'}`;
      }
      if(barEl){
        const pct=(gameState.timeRemaining/gameState.timeLimit)*100;
        barEl.style.width=pct+'%';
        barEl.classList.toggle('warning', isWarn);
      }
    }

    function startTimer(){
      if(gameState.timerInterval) clearInterval(gameState.timerInterval);
      gameState.timeLimit=getTimeLimitByDifficulty(gameState.difficulty);
      gameState.timeRemaining=gameState.timeLimit;
      updateTimerUI();

      gameState.timerInterval=setInterval(()=>{
        gameState.timeRemaining--;
        updateTimerUI();
        if(gameState.timeRemaining<=0){
          clearInterval(gameState.timerInterval);
          gameState.timerInterval=null;
          handleTimeOut();
        }
      },1000);
    }

    function stopTimer(){
      if(gameState.timerInterval){
        clearInterval(gameState.timerInterval);
        gameState.timerInterval=null;
      }
    }

    // =========================================================
    // Effects (correct / wrong)
    // =========================================================
    function showFX(type, text){
      const overlay=document.getElementById('fxOverlay');
      const toast=document.getElementById('fxToast');
      if(!overlay || !toast) return;

      toast.className = `fxToast ${type==='good'?'fxGood':'fxBad'}`;
      toast.textContent = text;

      // clear sparks
      overlay.innerHTML = '';
      overlay.appendChild(toast);

      overlay.style.display = 'block';

      // sparks
      const count = type==='good' ? 22 : 12;
      for(let i=0;i<count;i++){
        const s=document.createElement('div');
        s.className='spark';
        const x = 20 + Math.random()*60; // % width
        const y = 18 + Math.random()*30; // % height
        s.style.left = x + '%';
        s.style.top  = y + '%';
        s.style.transform = `translate(${(Math.random()*120-60)}px, ${(Math.random()*120-60)}px)`;
        s.style.opacity = (type==='good' ? .95 : .75);
        overlay.appendChild(s);
      }

      setTimeout(()=>{ overlay.style.display='none'; }, 520);
    }

    function shakeMessageBox(){
      const box=document.getElementById('messageBox');
      if(!box) return;
      box.classList.remove('shake');
      void box.offsetWidth;
      box.classList.add('shake');
    }

    // =========================================================
    // Render helpers
    // =========================================================
    function syncInputDisplay(){
      const el=document.getElementById('inputText');
      if(el) el.textContent = gameState.inputText || 'ã€€';
    }

    function setBattleInputMode(mode){
      gameState.battleInputMode=mode;
      render();
    }
    function onBattleKeyboardInput(val){
      gameState.inputText=(val||'').toLowerCase();
      syncInputDisplay();
    }
    function onBattleKeyboardKeydown(e){
      if(e.key==='Enter'){
        e.preventDefault();
        submitAnswer();
      }
    }

    // =========================================================
    // Screens
    // =========================================================
    function render(){
      if(gameState.screen!=='battle') stopTimer();
      const app=document.getElementById('app');
      if(!app) return;

      switch(gameState.screen){
        case 'title': renderTitle(app); break;
        case 'difficulty': renderDifficulty(app); break;
        case 'battle': renderBattle(app); break;
        case 'weaponDrop': renderWeaponDrop(app); break;
        case 'inventory': renderInventory(app); break;
        case 'levelClear': renderLevelClear(app); break;
        case 'gameOver': renderGameOver(app); break;
        default: renderTitle(app);
      }
    }

    function renderTitle(container){
      container.innerHTML = `
        <div class="h-full w-full flex flex-col items-center justify-center p-4 safePad" style="background: radial-gradient(ellipse at center, #1e1e3f 0%, #0a0a1a 100%);">
          <div class="text-center mb-7">
            <h1 class="title-font text-5xl sm:text-6xl font-bold mb-3 float-anim" style="color:#ffd700;text-shadow:0 0 30px rgba(255,215,0,.5);">
              æ¼¢å­—å‹‡è€…-èª­ã¿ã®å†’é™ºä¹™
            </h1>
            <p class="text-xl text-gray-300">ã€œ èª­ã¿ã§æˆ¦ãˆï¼ãƒ•ãƒªãƒƒã‚¯ã‚‚ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚‚OK ã€œ</p>
          </div>

          <div class="mb-7"><div class="text-7xl float-anim" style="animation-delay:.45s;">âš”ï¸ğŸ“–âœ¨</div></div>

          <div class="w-full max-w-md mb-5">
            <label class="block text-lg mb-2 text-gray-300">å‹‡è€…ã®åå‰ï¼ˆã“ã“ã¯ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ï¼‰</label>
            <input type="text" id="playerNameInput"
              class="w-full px-4 py-3 text-xl rounded-xl bg-gray-800 border-2 border-gray-600 focus:border-yellow-500 focus:outline-none text-white"
              placeholder="åå‰ã‚’å…¥åŠ›..."
              value="${gameState.playerName}">
          </div>

          <button onclick="startGame()"
            class="px-10 py-4 text-2xl font-black rounded-xl pulse-glow transition-transform hover:scale-105"
            style="background:linear-gradient(145deg,#ffd700,#ffaa00);color:#1a1a2e;">
            å†’é™ºã‚’å§‹ã‚ã‚‹
          </button>

          <p class="mt-6 text-gray-500 text-sm">â€» ãƒãƒˆãƒ«å…¥åŠ›ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰/ãƒ•ãƒªãƒƒã‚¯ï¼‰ã¯æ¬¡ã®ç”»é¢ã§åˆ‡æ›¿</p>
        </div>
      `;
      setTimeout(()=>document.getElementById('playerNameInput')?.focus(),0);
    }

    function renderDifficulty(container){
      const canPlayG5Ore = gameState.clearedLevels.includes('g5_1') && gameState.clearedLevels.includes('g5_2');
      const canPlayOldOre = [1,2,3].every(lv=>gameState.clearedLevels.includes(lv));

      container.innerHTML = `
        <div class="h-full w-full flex flex-col items-center justify-center p-4 safePad" style="background: radial-gradient(ellipse at center, #1e1e3f 0%, #0a0a1a 100%);">
          <h2 class="title-font text-4xl font-black mb-2" style="color:#ffd700;">é›£æ˜“åº¦ã‚’é¸æŠ</h2>
          <p class="text-lg text-gray-400 mb-4">å‹‡è€… ${escapeHtml(gameState.playerName||'å‹‡è€…')} ã‚ˆã€è©¦ç·´ã‚’é¸ã¹</p>

          <div class="mb-4 flex items-center gap-3 bg-black/30 border border-gray-700 rounded-2xl px-4 py-3">
            <div class="text-sm text-gray-300 font-black">ãƒãƒˆãƒ«å…¥åŠ›</div>
            <button onclick="setBattleInputMode('keyboard')"
              class="px-3 py-2 rounded-xl border-2 ${gameState.battleInputMode==='keyboard'?'border-yellow-400 bg-yellow-900/30':'border-gray-600 bg-gray-800/40 hover:bg-gray-700/40'} text-sm font-black">
              âŒ¨ï¸ ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰
            </button>
            <button onclick="setBattleInputMode('flick')"
              class="px-3 py-2 rounded-xl border-2 ${gameState.battleInputMode==='flick'?'border-yellow-400 bg-yellow-900/30':'border-gray-600 bg-gray-800/40 hover:bg-gray-700/40'} text-sm font-black">
              ğŸ“± ãƒ•ãƒªãƒƒã‚¯
            </button>
            <button onclick="goToInventory()" class="ml-2 px-3 py-2 rounded-xl bg-gray-700 hover:bg-gray-600 text-sm font-black">
              ğŸ’ æ­¦å™¨ (${gameState.weapons.length})
            </button>
          </div>

          <div class="w-full max-w-5xl mb-5">
            <div class="text-lg font-black text-cyan-300 mb-2">ğŸ« 5å¹´ç”Ÿãƒ¢ãƒ¼ãƒ‰</div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
              ${diffBtn('g5_1','ğŸ“—','5å¹´ç”Ÿ ãƒ¬ãƒ™ãƒ«1','åŸºæœ¬ç†Ÿèªï¼ˆå¤§å¢—é‡ï¼‰','10ç§’')}
              ${diffBtn('g5_2','ğŸ“˜','5å¹´ç”Ÿ ãƒ¬ãƒ™ãƒ«2','ç†ç¤¾èªå½™ï¼ˆå¤§å¢—é‡ï¼‰','9ç§’')}
              ${diffLockBtn('g5_ore', canPlayG5Ore, 'ğŸ‘‘','ğŸ”’','5å¹´ç”Ÿ ãƒ¬ãƒ™ãƒ«ä¿º','é›£èª­æ¼¢å­—ï¼ˆå¢—é‡ï¼‰','Lv1&Lv2ã‚¯ãƒªã‚¢ã§è§£æ”¾','7ç§’')}
            </div>
          </div>

          <div class="w-full max-w-5xl">
            <div class="text-lg font-black text-yellow-200 mb-2">âš”ï¸ æ¼¢å­—å‹‡è€…ï¼ˆæ—§ï¼‰</div>
            <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
              ${diffBtn(1,'ğŸŒ±','ãƒ¬ãƒ™ãƒ«1','åŸºæœ¬ã®æ¼¢å­—','10ç§’')}
              ${diffBtn(2,'âš”ï¸','ãƒ¬ãƒ™ãƒ«2','ä¸­ç´šã®æ¼¢å­—','9ç§’')}
              ${diffBtn(3,'ğŸ”¥','ãƒ¬ãƒ™ãƒ«3','é›£èª­æ¼¢å­—','8ç§’')}
              ${diffLockBtn('ore', canPlayOldOre, 'ğŸ‘‘','ğŸ”’','ãƒ¬ãƒ™ãƒ«ä¿º','ç©¶æ¥µã®è©¦ç·´','Lv1-3ã‚¯ãƒªã‚¢ã§è§£æ”¾','7ç§’')}
            </div>
          </div>
        </div>
      `;
    }

    function diffBtn(key, icon, title, desc, t){
      const cleared = gameState.clearedLevels.includes(key);
      const ring = cleared ? 'ring-2 ring-yellow-400' : '';
      const onclick = `selectDifficulty(${typeof key==='number' ? key : `'${key}'`})`;
      return `
        <button onclick="${onclick}"
          class="p-6 rounded-2xl border-2 border-gray-600 bg-gray-900/25 hover:bg-gray-800/35 transition-all hover:scale-[1.02] ${ring}">
          <div class="text-4xl mb-2">${icon}</div>
          <div class="text-2xl font-black text-white">${title}</div>
          <div class="text-sm text-gray-400 mt-2">${desc}</div>
          <div class="text-xs text-gray-500 mt-1">${t}</div>
          ${cleared ? '<div class="text-yellow-400 mt-2 font-black">âœ“ ã‚¯ãƒªã‚¢æ¸ˆ</div>' : ''}
        </button>
      `;
    }
    function diffLockBtn(key, can, iconOpen, iconLock, title, desc, lockText, t){
      const cleared = gameState.clearedLevels.includes(key);
      const ring = cleared ? 'ring-2 ring-yellow-400' : '';
      const onclick = can ? `selectDifficulty('${key}')` : '';
      return `
        <button onclick="${onclick}"
          class="p-6 rounded-2xl border-2 ${can?'border-yellow-500 bg-yellow-900/20 hover:bg-yellow-800/30 hover:scale-[1.02]':'border-gray-600 bg-gray-900/25 opacity-50 cursor-not-allowed'} transition-all ${ring}">
          <div class="text-4xl mb-2">${can?iconOpen:iconLock}</div>
          <div class="text-2xl font-black ${can?'text-yellow-200':'text-gray-500'}">${title}</div>
          <div class="text-sm text-gray-400 mt-2">${can?desc:lockText}</div>
          <div class="text-xs text-gray-500 mt-1">${can?t:''}</div>
          ${cleared ? '<div class="text-yellow-400 mt-2 font-black">âœ“ ã‚¯ãƒªã‚¢æ¸ˆ</div>' : ''}
        </button>
      `;
    }

    function renderBattle(container){
      const hpPercent=(gameState.playerHP/gameState.maxHP)*100;
      const enemyHpPercent=(gameState.enemyHP/gameState.enemyMaxHP)*100;
      const isLowHP=hpPercent<30;
      const isTimeWarning=gameState.timeRemaining<=3;

      const eq = gameState.equipped.filter(Boolean);
      const eqLine = eq.length ? eq.map(w=>`${w.emoji}${w.name}`).join(' / ') : '';

      container.innerHTML = `
        <div class="h-full w-full flex flex-col md:flex-row battle-screen">
          <!-- Left -->
          <div class="md:w-1/2 w-full flex flex-col p-3 md:p-4">
            <div class="bg-black/40 rounded-xl p-3 mb-3">
              <div class="flex justify-between items-center mb-2">
                <span class="text-lg font-black">${escapeHtml(gameState.playerName)}</span>
                <span class="text-sm text-gray-400">ã‚³ãƒ³ãƒœ: ${gameState.combo}x</span>
              </div>
              <div class="hp-bar"><div class="hp-fill ${isLowHP?'low':''}" style="width:${hpPercent}%"></div></div>
              <div class="flex justify-between text-sm mt-1">
                <span>HP: ${gameState.playerHP}/${gameState.maxHP}</span>
                <span>ATK: ${calculateDamage()} / DEF: ${getEquippedStats().def}</span>
              </div>
              ${eqLine ? `<div class="mt-2 text-xs text-yellow-300 font-black">ğŸ§° è£…å‚™: ${escapeHtml(eqLine)}</div>` : ''}
            </div>

            <div class="flex-1 flex flex-col items-center justify-center">
              <div class="text-center mb-4">
                <div class="enemy-sprite ${gameState.isBossBattle?'victory-glow':'float-anim'}" id="enemySprite">${gameState.currentEnemy.emoji}</div>
                <div class="text-2xl font-black mt-2 ${gameState.isBossBattle?'text-red-400':''}">${gameState.currentEnemy.name}</div>
                ${gameState.isBossBattle?'<div class="text-red-500 text-sm font-black">ã€BOSSã€‘</div>':''}
              </div>

              <div class="w-full max-w-xs">
                <div class="hp-bar"><div class="hp-fill enemy" style="width:${enemyHpPercent}%"></div></div>
                <div class="text-center text-sm mt-1">HP: ${gameState.enemyHP}/${gameState.enemyMaxHP}</div>
              </div>

              <div class="mt-4 text-gray-400 text-sm">
                ${gameState.isBossBattle?'ãƒœã‚¹æˆ¦ï¼':`æ’ƒç ´æ•°: ${gameState.defeatedCount}/3`}
              </div>
            </div>

            <div class="bg-black/40 rounded-xl p-3 text-center min-h-[60px]" id="messageBox">
              ${gameState.message || 'æ¼¢å­—ã®èª­ã¿æ–¹ã‚’å…¥åŠ›ã›ã‚ˆï¼'}
            </div>
          </div>

          <!-- Right -->
          <div class="md:w-1/2 w-full flex flex-col p-3 md:p-4 bg-black/20 overflow-y-auto safePad">
            <!-- â˜…ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§ã‚‚å•é¡ŒãŒè¦‹ãˆã‚‹ï¼šsticky -->
            <div class="stickyTop bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl p-5 mb-3 text-center border-2 border-gray-700">
              <div class="flex justify-between items-center mb-2">
                <div class="text-sm text-gray-400">ã“ã®æ¼¢å­—ã®èª­ã¿æ–¹ã¯ï¼Ÿ</div>
                <div class="flex items-center gap-2">
                  <button onclick="pauseToDifficulty()"
                    class="px-3 py-1 rounded-lg bg-gray-700 hover:bg-gray-600 text-xs font-black">â¸ ä¸­æ–­</button>
                  <div id="timeText" class="text-sm font-black ${isTimeWarning?'text-red-500 time-warning':'text-yellow-400'}">â±ï¸ ${gameState.timeRemaining}ç§’</div>
                </div>
              </div>
              <div class="title-font text-5xl font-black" style="color:#ffd700;">${gameState.currentQuestion.kanji}</div>
              <div class="time-bar mt-4"><div id="timeBarFill" class="time-bar-fill ${isTimeWarning?'warning':''}" style="width:${(gameState.timeRemaining/gameState.timeLimit)*100}%"></div></div>
            </div>

            <div class="input-display flex items-center justify-between mb-3">
              <span id="inputText">${gameState.inputText||'ã€€'}</span>
              <button onclick="submitAnswer()" class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded-lg text-sm font-black transition-all">æ±ºå®š</button>
            </div>

            ${gameState.battleInputMode==='keyboard' ? `
              <div class="bg-black/30 border border-gray-700 rounded-2xl p-4 mb-3">
                <div class="text-sm text-gray-400 mb-2">ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›ï¼ˆEnterã§æ±ºå®šï¼‰</div>
                <input id="battleKeyboardInput"
                  class="w-full px-4 py-3 text-xl rounded-xl bg-gray-800 border-2 border-gray-600 focus:border-yellow-500 focus:outline-none text-white"
                  placeholder="ã‚ˆã¿ã‚’å…¥åŠ›..."
                  value="${escapeHtml(gameState.inputText)}"
                  oninput="onBattleKeyboardInput(this.value)"
                  onkeydown="onBattleKeyboardKeydown(event)">
              </div>
              <div class="text-xs text-gray-500">â€»å•é¡Œã‚«ãƒ¼ãƒ‰ã¯ä¸Šã«å›ºå®šï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã‚‚è¦‹ãˆã‚‹ï¼‰</div>
            ` : `
              <div class="flex-1 flex flex-col justify-center items-center">
                ${renderFlickGridHTML()}
              </div>
            `}
          </div>
        </div>
      `;

      syncInputDisplay();
      updateTimerUI();

      if(gameState.battleInputMode==='keyboard'){
        const el=document.getElementById('battleKeyboardInput');
        if(el) setTimeout(()=>el.focus({preventScroll:true}),0);
      }
    }

    function renderWeaponDrop(container){
      const w=gameState.droppedWeapon;
      container.innerHTML = `
        <div class="h-full w-full flex flex-col items-center justify-center p-4 safePad" style="background: radial-gradient(ellipse at center, #1e1e3f 0%, #0a0a1a 100%);">
          <h2 class="text-3xl font-black mb-6 text-yellow-400">ğŸ‰ æ­¦å™¨ã‚’ç²å¾—ï¼</h2>

          <div class="weapon-card ${w.rank} w-80 mb-6">
            <div class="text-6xl mb-4">${w.emoji}</div>
            <div class="text-sm mb-2 font-black" style="color:${getRankColor(w.rank)}">${getRankName(w.rank)}</div>
            <div class="text-2xl font-black mb-2">${w.name}</div>
            <div class="text-gray-400 text-sm mb-4">${w.desc}</div>
            <div class="flex justify-center gap-4 text-sm font-black">
              ${w.atk?`<span class="text-red-300">ATK +${w.atk}</span>`:''}
              ${w.def?`<span class="text-blue-300">DEF +${w.def}</span>`:''}
            </div>
          </div>

          <div class="w-full max-w-xl bg-black/30 border border-gray-700 rounded-2xl p-4 mb-4">
            <div class="text-sm text-gray-300 font-black mb-2">è£…å‚™ã‚¹ãƒ­ãƒƒãƒˆï¼ˆ3æ ï¼‰</div>
            <div class="grid grid-cols-3 gap-3">
              ${[0,1,2].map(i=>{
                const cur=gameState.equipped[i];
                return `
                  <button onclick="equipDroppedToSlot(${i})"
                    class="p-3 rounded-xl border-2 ${cur?'border-yellow-500 bg-yellow-900/15':'border-gray-600 bg-gray-800/30 hover:bg-gray-700/30'} transition-all">
                    <div class="text-xs text-gray-400 font-black mb-1">ã‚¹ãƒ­ãƒƒãƒˆ${i+1}</div>
                    <div class="text-sm font-black truncate">${cur?`${cur.emoji} ${cur.name}`:'ï¼ˆç©ºï¼‰'}</div>
                  </button>
                `;
              }).join('')}
            </div>
            <div class="text-xs text-gray-500 mt-2">â€»ã€Œè£…å‚™ã™ã‚‹ã€ã¯ã€æŠ¼ã—ãŸã‚¹ãƒ­ãƒƒãƒˆã«å…¥ã‚Šã¾ã™ï¼ˆä¸Šã§é¸ã‚“ã§ã­ï¼‰</div>
          </div>

          <div class="flex gap-3 flex-wrap justify-center">
            <button onclick="equipNewWeaponDefault()"
              class="px-7 py-3 text-lg font-black rounded-xl bg-yellow-600 hover:bg-yellow-500 transition-all">
              è£…å‚™ã™ã‚‹ï¼ˆç©ºãå„ªå…ˆï¼‰
            </button>
            <button onclick="continueAfterDrop()"
              class="px-7 py-3 text-lg font-black rounded-xl bg-gray-700 hover:bg-gray-600 transition-all">
              ç¶šã‘ã‚‹ï¼ˆæŒã¡ç‰©ã«å…¥ã‚Œã‚‹ï¼‰
            </button>
            <button onclick="returnToDifficultyFromDrop()"
              class="px-7 py-3 text-lg font-black rounded-xl bg-blue-700 hover:bg-blue-600 transition-all">
              é›£æ˜“åº¦é¸æŠã¸æˆ»ã‚‹
            </button>
          </div>
        </div>
      `;
    }

    function renderInventory(container){
      const eq = gameState.equipped;
      container.innerHTML = `
        <div class="h-full w-full flex flex-col p-4 safePad" style="background: radial-gradient(ellipse at center, #1e1e3f 0%, #0a0a1a 100%);">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-3xl font-black text-yellow-400">ğŸ’ æ­¦å™¨ä¸€è¦§</h2>
            <button onclick="goToDifficulty()" class="px-6 py-2 rounded-xl bg-gray-700 hover:bg-gray-600 transition-all font-black">æˆ»ã‚‹</button>
          </div>

          <div class="mb-4 p-4 rounded-2xl bg-black/30 border border-gray-700">
            <div class="text-sm text-gray-300 font-black mb-3">è£…å‚™ã‚¹ãƒ­ãƒƒãƒˆï¼ˆ3æ ï¼‰</div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
              ${[0,1,2].map(i=>{
                const cur=eq[i];
                return `
                  <div class="p-3 rounded-xl border-2 ${cur?'border-yellow-500 bg-yellow-900/15':'border-gray-600 bg-gray-800/30'}">
                    <div class="text-xs text-gray-400 font-black mb-1">ã‚¹ãƒ­ãƒƒãƒˆ${i+1}</div>
                    <div class="text-sm font-black truncate mb-2">${cur?`${cur.emoji} ${cur.name}`:'ï¼ˆç©ºï¼‰'}</div>
                    <button onclick="unequipSlot(${i})" class="px-3 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 text-xs font-black ${cur?'':'opacity-40 pointer-events-none'}">
                      å¤–ã™
                    </button>
                  </div>
                `;
              }).join('')}
            </div>
            <div class="text-xs text-gray-500 mt-3">â€» ä¸‹ã®æ­¦å™¨ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€Œç©ºãã‚¹ãƒ­ãƒƒãƒˆã«è£…å‚™ã€ã—ã¾ã™</div>
          </div>

          <div class="flex-1 overflow-auto">
            ${gameState.weapons.length===0 ? `
              <div class="text-center text-gray-500 py-8">ã¾ã æ­¦å™¨ã‚’æŒã£ã¦ã„ã¾ã›ã‚“ã€‚<br>æ•µã‚’å€’ã—ã¦æ­¦å™¨ã‚’é›†ã‚ã‚ˆã†ï¼</div>
            ` : `
              <div class="grid grid-cols-2 sm:grid-cols-5 gap-3">
                ${gameState.weapons.map((w,i)=>`
                  <div class="weapon-card ${w.rank} cursor-pointer hover:scale-[1.02] transition-all"
                    onclick="equipFromInventory(${i})">
                    <div class="text-3xl mb-2">${w.emoji}</div>
                    <div class="text-xs mb-1 font-black" style="color:${getRankColor(w.rank)}">${getRankName(w.rank)}</div>
                    <div class="text-sm font-black truncate">${w.name}</div>
                    <div class="text-xs text-gray-400 mt-1">
                      ${w.atk?`ATK+${w.atk}`:''} ${w.def?`DEF+${w.def}`:''}
                    </div>
                  </div>
                `).join('')}
              </div>
            `}
          </div>
        </div>
      `;
    }

    function renderLevelClear(container){
      container.innerHTML = `
        <div class="h-full w-full flex flex-col items-center justify-center p-4 safePad" style="background: radial-gradient(ellipse at center, #1e3f3f 0%, #0a1a1a 100%);">
          <div class="text-6xl mb-4">â­</div>
          <h2 class="text-3xl font-black mb-4 text-cyan-300">ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ï¼</h2>
          <p class="text-xl text-gray-300 mb-6">3ä½“ã®æ•µã‚’æ’ƒç ´ï¼ãƒœã‚¹ãŒç¾ã‚Œã‚‹...</p>
          <button onclick="startBossBattle()" class="px-8 py-4 text-xl font-black rounded-xl bg-red-600 hover:bg-red-500 transition-all pulse-glow">
            ãƒœã‚¹ã«æŒ‘ã‚€ï¼
          </button>
        </div>
      `;
    }

    function renderGameOver(container){
      container.innerHTML = `
        <div class="h-full w-full flex flex-col items-center justify-center p-4 safePad" style="background: radial-gradient(ellipse at center, #3f1e1e 0%, #1a0a0a 100%);">
          <div class="text-8xl mb-6">ğŸ’€</div>
          <h2 class="title-font text-5xl font-black mb-4 text-red-300">æ•—åŒ—...</h2>
          <p class="text-2xl text-gray-300 mb-8">${escapeHtml(gameState.playerName)} ã¯åŠ›å°½ããŸ...</p>
          <div class="flex gap-4 flex-wrap justify-center">
            <button onclick="retryBattle()" class="px-8 py-4 text-xl font-black rounded-xl bg-red-600 hover:bg-red-500 transition-all">å†æŒ‘æˆ¦</button>
            <button onclick="goToDifficulty()" class="px-8 py-4 text-xl font-black rounded-xl bg-gray-700 hover:bg-gray-600 transition-all">é›£æ˜“åº¦é¸æŠã¸</button>
          </div>
        </div>
      `;
    }

    // =========================================================
    // Navigation / Logic
    // =========================================================
    function startGame(){
      const nameInput=document.getElementById('playerNameInput');
      gameState.playerName=(nameInput?.value||'å‹‡è€…').trim() || 'å‹‡è€…';
      gameState.screen='difficulty';
      render();
    }

    function selectDifficulty(level){
      gameState.difficulty=level;

      gameState.playerHP=100;
      gameState.maxHP=100;
      gameState.defeatedCount=0;
      gameState.combo=0;
      gameState.message='';
      gameState.droppedWeapon=null;
      gameState.isBossBattle=false;

      recentQ.length=0;

      spawnEnemy();
      getNewQuestion();
      gameState.screen='battle';
      render();
    }

    function goToDifficulty(){ stopTimer(); gameState.screen='difficulty'; render(); }
    function goToInventory(){ stopTimer(); gameState.screen='inventory'; render(); }

    function pauseToDifficulty(){
      stopTimer();
      gameState.screen='difficulty';
      render();
    }

    function startBossBattle(){
      spawnBoss();
      getNewQuestion();
      gameState.screen='battle';
      render();
    }

    function retryBattle(){
      stopTimer();
      gameState.playerHP=100;
      gameState.defeatedCount=0;
      gameState.combo=0;
      gameState.isBossBattle=false;
      gameState.message='';
      gameState.droppedWeapon=null;

      spawnEnemy();
      getNewQuestion();
      gameState.screen='battle';
      render();
    }

    // =========================================================
    // Weapon slot actions
    // =========================================================
    function ensureInInventory(w){
      if(!w) return;
      if(!gameState.weapons.find(x=>x.id===w.id)) gameState.weapons.push(w);
    }

    function equipDroppedToSlot(slot){
      const w=gameState.droppedWeapon;
      if(!w) return;
      ensureInInventory(w);
      gameState.equipped[slot]=w;
      renderWeaponDrop(document.getElementById('app')); // stay
    }

    function equipNewWeaponDefault(){
      const w=gameState.droppedWeapon;
      if(!w) return;
      ensureInInventory(w);

      const empty = gameState.equipped.findIndex(x=>!x);
      if(empty>=0) gameState.equipped[empty]=w;
      else gameState.equipped[0]=w; // å…¨éƒ¨åŸ‹ã¾ã£ã¦ãŸã‚‰1æ ç›®ã‚’ä¸Šæ›¸ã

      continueAfterDrop();
    }

    function equipFromInventory(index){
      const w=gameState.weapons[index];
      if(!w) return;
      const empty = gameState.equipped.findIndex(x=>!x);
      if(empty>=0) gameState.equipped[empty]=w;
      else gameState.equipped[0]=w;
      render();
    }

    function unequipSlot(slot){
      gameState.equipped[slot]=null;
      render();
    }

    // =========================================================
    // Drop / Continue
    // =========================================================
    function continueAfterDrop(){
      if(gameState.droppedWeapon) ensureInInventory(gameState.droppedWeapon);
      gameState.droppedWeapon=null;

      if(!gameState.isBossBattle && gameState.defeatedCount>=3){
        gameState.screen='levelClear';
      }else{
        if(!gameState.isBossBattle) spawnEnemy();
        getNewQuestion();
        gameState.screen='battle';
      }
      render();
    }

    function returnToDifficultyFromDrop(){
      if(gameState.droppedWeapon) ensureInInventory(gameState.droppedWeapon);
      gameState.droppedWeapon=null;
      stopTimer();
      gameState.screen='difficulty';
      render();
    }

    // =========================================================
    // Answer / Battle
    // =========================================================
    function submitAnswer(){
      stopTimer();
      const answer=(gameState.inputText||'').toLowerCase();
      const correct=(gameState.currentQuestion.reading||'').toLowerCase();

      if(answer===correct) handleCorrectAnswer();
      else handleWrongAnswer();
    }

    function handleTimeOut(){
      gameState.combo=0;
      const dmg=gameState.currentEnemy.atk;
      // é˜²å¾¡ã§è»½æ¸›
      const def = getEquippedStats().def;
      const final = Math.max(1, Math.round(dmg - def*0.15));
      gameState.playerHP-=final;
      gameState.message=`â° æ™‚é–“åˆ‡ã‚Œ... æ­£è§£ã¯ã€Œ${gameState.currentQuestion.reading}ã€ ${final}ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸï¼`;
      shakeMessageBox();

      if(gameState.playerHP<=0){
        gameState.playerHP=0;
        gameState.screen='gameOver';
        render();
        return;
      }
      getNewQuestion();
      render();
    }

    function handleCorrectAnswer(){
      gameState.combo++;
      const dmg=calculateDamage();
      gameState.enemyHP-=dmg;

      gameState.message=`âœ¨ æ­£è§£ï¼ ${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼ ã‚³ãƒ³ãƒœ${gameState.combo}x`;
      showFX('good', `âœ¨ æ­£è§£ï¼ +${dmg}`);

      const enemySprite=document.getElementById('enemySprite');
      if(enemySprite){
        enemySprite.classList.add('damage-flash');
        setTimeout(()=>enemySprite.classList.remove('damage-flash'),200);
      }

      if(gameState.enemyHP<=0){
        handleEnemyDefeat();
        return;
      }
      getNewQuestion();
      render();
    }

    function handleWrongAnswer(){
      gameState.combo=0;
      const dmg=gameState.currentEnemy.atk;
      const def = getEquippedStats().def;
      const final = Math.max(1, Math.round(dmg - def*0.15));
      gameState.playerHP-=final;

      gameState.message=`âŒ ä¸æ­£è§£... æ­£è§£ã¯ã€Œ${gameState.currentQuestion.reading}ã€ ${final}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`;
      showFX('bad', `âŒ ä¸æ­£è§£â€¦`);
      shakeMessageBox();

      if(gameState.playerHP<=0){
        gameState.playerHP=0;
        gameState.screen='gameOver';
        render();
        return;
      }
      getNewQuestion();
      render();
    }

    function handleEnemyDefeat(){
      gameState.totalDefeated++;

      // ãƒœã‚¹æ’ƒç ´ â†’ ã‚¯ãƒªã‚¢åˆ¤å®š
      if(gameState.isBossBattle){
        const diffKey=gameState.difficulty;
        if(!gameState.clearedLevels.includes(diffKey)) gameState.clearedLevels.push(diffKey);

        // ãƒœã‚¹ã¯å¿…ãšãƒ‰ãƒ­ãƒƒãƒ—
        gameState.droppedWeapon=getRandomWeapon();
        gameState.screen='weaponDrop';
        render();
        return;
      }

      // é€šå¸¸æ’ƒç ´
      gameState.defeatedCount++;

      if(Math.random()<0.72){
        gameState.droppedWeapon=getRandomWeapon();
        gameState.screen='weaponDrop';
        render();
        return;
      }

      if(gameState.defeatedCount>=3){
        gameState.screen='levelClear';
        render();
        return;
      }

      spawnEnemy();
      getNewQuestion();
      gameState.message='æ•µã‚’å€’ã—ãŸï¼æ¬¡ã®æ•µãŒç¾ã‚ŒãŸ...';
      gameState.screen='battle';
      render();
    }

    // =========================================================
    // Flick input with popup preview
    // =========================================================
    let flickStartPos=null;
    let currentFlickKey=null;
    let currentDir='center';
    let activePointerId=null;

    function showFlickPopup(anchorEl, key){
      const pop=document.getElementById('flickPopup');
      if(!pop) return;

      const rect=anchorEl.getBoundingClientRect();
      // place above key (or near)
      const cx=rect.left + rect.width/2;
      const cy=rect.top  + rect.height/2;
      const left = Math.max(8, Math.min(window.innerWidth-168, cx-80));
      const top  = Math.max(8, Math.min(window.innerHeight-168, cy-170));

      pop.style.left = left + 'px';
      pop.style.top  = top  + 'px';
      pop.style.display='block';

      // fill chars
      if(flickMap[key]){
        setPopupChars(flickMap[key]);
      }else{
        setPopupChars({center:key, up:'', left:'', right:'', down:''});
      }
      setPopupSelection('center');
    }

    function hideFlickPopup(){
      const pop=document.getElementById('flickPopup');
      if(pop) pop.style.display='none';
    }

    function setPopupChars(map){
      const c = document.getElementById('popC');
      const u = document.getElementById('popUp');
      const l = document.getElementById('popLeft');
      const r = document.getElementById('popRight');
      const d = document.getElementById('popDown');
      if(c) c.textContent = map.center || '';
      if(u) u.textContent = map.up || '';
      if(l) l.textContent = map.left || '';
      if(r) r.textContent = map.right || '';
      if(d) d.textContent = map.down || '';
    }

    function setPopupSelection(dir){
      const ids = {center:'popC', up:'popUp', left:'popLeft', right:'popRight', down:'popDown'};
      Object.values(ids).forEach(id=>{
        const el=document.getElementById(id);
        if(el) el.classList.remove('sel');
      });
      const target=document.getElementById(ids[dir]||'popC');
      if(target) target.classList.add('sel');
    }

    function startFlick(event, key){
      if(!key) return;
      if(gameState.battleInputMode!=='flick') return;
      event.preventDefault();

      activePointerId = event.pointerId;
      const el = event.target.closest('.flick-key');
      if(el) el.setPointerCapture?.(event.pointerId);

      flickStartPos={x:event.clientX,y:event.clientY};
      currentFlickKey=key;
      currentDir='center';

      // highlight key
      if(el) el.classList.add('active');

      // show popup preview for kana keys only
      if(flickMap[key]){
        showFlickPopup(el, key);
      }else{
        hideFlickPopup();
      }
      setPopupSelection('center');
    }

    function moveFlick(event){
      if(activePointerId!==event.pointerId) return;
      if(!flickStartPos || !currentFlickKey) return;
      event.preventDefault();

      const dx=event.clientX - flickStartPos.x;
      const dy=event.clientY - flickStartPos.y;
      const threshold=22;

      let dir='center';
      if(Math.abs(dx)>threshold || Math.abs(dy)>threshold){
        if(Math.abs(dx)>Math.abs(dy)) dir = dx>0?'right':'left';
        else dir = dy>0?'down':'up';
      }
      if(dir!==currentDir){
        currentDir=dir;
        setPopupSelection(dir);
      }
    }

    function endFlick(event){
      if(activePointerId!==event.pointerId) return;
      if(!flickStartPos || !currentFlickKey){
        cleanupFlick();
        return;
      }
      event.preventDefault();

      processFlickInput(currentFlickKey, currentDir);

      cleanupFlick();
    }

    function cleanupFlick(){
      document.querySelectorAll('.flick-key').forEach(el=>el.classList.remove('active'));
      hideFlickPopup();
      flickStartPos=null;
      currentFlickKey=null;
      currentDir='center';
      activePointerId=null;
    }

    function processFlickInput(key, direction){
      if(key==='âŒ«'){
        gameState.inputText = gameState.inputText.slice(0,-1);
      }else if(key==='ã‚›'){
        applyDakuten();
      }else if(key==='ã‚œ'){
        applyHandakuten();
      }else if(key==='å°'){
        applySmall();
      }else if(key==='ãƒ¼'){
        gameState.inputText += 'ãƒ¼';
      }else if(flickMap[key]){
        const char = flickMap[key][direction] || flickMap[key].center;
        if(char && char!=='ï¼ˆ' && char!=='ï¼‰' && char!=='ã€œ') gameState.inputText += char;
      }
      syncInputDisplay();
    }

    function applyDakuten(){
      if(!gameState.inputText) return;
      const last=gameState.inputText.slice(-1);
      if(dakutenMap[last]) gameState.inputText=gameState.inputText.slice(0,-1)+dakutenMap[last];
    }
    function applyHandakuten(){
      if(!gameState.inputText) return;
      const last=gameState.inputText.slice(-1);
      if(handakutenMap[last]) gameState.inputText=gameState.inputText.slice(0,-1)+handakutenMap[last];
    }
    function applySmall(){
      if(!gameState.inputText) return;
      const last=gameState.inputText.slice(-1);
      if(smallMap[last]) gameState.inputText=gameState.inputText.slice(0,-1)+smallMap[last];
    }

    function renderFlickGridHTML(){
      const cells = flickLayout.flat();
      return `
        <div class="grid grid-cols-3 gap-2">
          ${cells.map(key=>{
            const isEmpty = !key;
            const cls = isEmpty ? 'flick-key disabled' : 'flick-key';
            const safeKey = key || '';
            return `
              <div class="${cls}"
                ${isEmpty?'':`
                  data-key="${safeKey}"
                  onpointerdown="startFlick(event, '${safeKey}')"
                  onpointermove="moveFlick(event)"
                  onpointerup="endFlick(event)"
                  onpointerleave="endFlick(event)"
                `}>
                ${safeKey}
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    // =========================================================
    // Utils
    // =========================================================
    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    // =========================================================
    // Init
    // =========================================================
    render();
  </script>
</body>
</html>
