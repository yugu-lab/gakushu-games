<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>漢字すごろくゲーム</title>
  <style>
    body {
      font-family: 'Hiragino Sans', 'Yu Gothic', sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #1e3c72 100%);
      margin: 0;
      padding: 10px;
      min-height: 100vh;
      overflow-x: hidden;
      animation: backgroundShift 15s ease-in-out infinite;
    }
    @keyframes backgroundShift {
      0%, 100% { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #1e3c72 100%); }
      33% { background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%); }
      66% { background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%); }
    }

    .game-container {
      max-width: 100%;
      margin: 0 auto;
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      height: calc(100vh - 20px);
      display: flex;
      flex-direction: column;
      border: 2px solid #3498db;
    }

    .title {
      text-align: center;
      color: #3498db;
      font-size: 2rem;
      margin-bottom: 15px;
      text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
      font-weight: bold;
      animation: titleGlow 2s ease-in-out infinite alternate;
    }
    @keyframes titleGlow {
      0% { text-shadow: 3px 3px 6px rgba(0,0,0,0.5), 0 0 20px rgba(52, 152, 219, 0.3); }
      100% { text-shadow: 3px 3px 6px rgba(0,0,0,0.5), 0 0 30px rgba(52, 152, 219, 0.6); }
    }

    .game-board {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 8px;
      margin: 10px 0;
      padding: 15px;
      background: linear-gradient(45deg, #34495e, #2c3e50);
      border-radius: 15px;
      border: 3px solid #3498db;
      box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
      height: 220px;
      overflow: visible;
      position: relative;
    }

    .cell {
      aspect-ratio: 1;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      height: auto;
      align-self: start; /* 全角スペースを除去して正常化 */
      font-weight: bold;
      position: relative;
      transition: all 0.3s ease;
      font-size: 0.8rem;
      min-height: 30px;
    }
    .cell:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

    .start { background: #4CAF50; color: white; }
    .goal { background: #FF6B6B; color: white; }

    .color1 { background: #FF9999; color: white; }
    .color2 { background: #99CCFF; color: white; }
    .color3 { background: #99FF99; color: white; }
    .color4 { background: #FFCC99; color: white; }
    .color5 { background: #FF99FF; color: white; }
    .color6 { background: #99FFFF; color: white; }
    .color7 { background: #FFFF99; color: #333; }
    .color8 { background: #CC99FF; color: white; }
    .color9 { background: #FFB366; color: white; }
    .color10 { background: #66FFB3; color: white; }

    .player {
      position: absolute;
      font-size: 2rem;
      z-index: 10;
      animation: bounce 0.5s ease;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      filter: drop-shadow(0 0 8px rgba(255,255,255,0.8));
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-8px) scale(1.1); }
    }
    .player1 { top: -8px; left: 2px; }
    .player2 { bottom: -8px; right: 2px; }

    .game-info {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 15px;
      margin: 10px 0;
      flex-shrink: 0;
      align-items: center;
    }

    .player-info {
      background: linear-gradient(135deg, #34495e, #2c3e50);
      color: #ecf0f1;
      padding: 10px;
      border-radius: 15px;
      text-align: center;
      font-size: 0.75rem;
      border: 2px solid #7f8c8d;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
    }
    .player-info.active {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      transform: scale(1.05);
      box-shadow: 0 10px 30px rgba(52, 152, 219, 0.6);
      border-color: #3498db;
      animation: activeGlow 2s ease-in-out infinite alternate;
    }
    @keyframes activeGlow {
      0% { box-shadow: 0 10px 30px rgba(52, 152, 219, 0.6); }
      100% { box-shadow: 0 15px 40px rgba(52, 152, 219, 0.8); }
    }

    .controls { text-align: center; margin: 10px 0; flex-shrink: 0; }
    .dice-container { display: inline-block; margin: 10px; }

    .dice {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, #ffd93d, #ffb347);
      border: 3px solid #ff6b6b;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      font-weight: bold;
      margin: 0 auto 8px;
      transition: transform 0.5s ease;
      box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
      color: #333;
    }
    .dice.rolling { animation: roll 1s ease-in-out; }
    @keyframes roll {
      0% { transform: rotate(0deg); }
      25% { transform: rotate(90deg); }
      50% { transform: rotate(180deg); }
      75% { transform: rotate(270deg); }
      100% { transform: rotate(360deg); }
    }

    .btn {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 5px;
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      border: 1px solid #2980b9;
    }
    .btn:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 15px 25px rgba(52, 152, 219, 0.5); background: linear-gradient(135deg, #2980b9, #1f4e79); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .question-modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      display: none; align-items: center; justify-content: center;
      z-index: 1000;
    }
    .question-content { background: white; padding: 40px; border-radius: 20px; text-align: center; max-width: 500px; width: 90%; }
    .question-text { font-size: 1.5rem; margin-bottom: 30px; color: #333; }
    .answer-input {
      width: 100%; padding: 15px; font-size: 1.2rem;
      border: 2px solid #3498db; border-radius: 10px; margin: 20px 0; text-align: center;
      background: #ecf0f1; color: #2c3e50;
    }
    .answer-input:focus { outline: none; border-color: #2980b9; box-shadow: 0 0 10px rgba(52, 152, 219, 0.3); }
    .submit-answer {
      background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; border: none; padding: 12px 30px;
      border-radius: 25px; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; margin: 10px;
      box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
    }
    .submit-answer:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(39, 174, 96, 0.4); }

    .cards-section { margin-top: 10px; text-align: center; flex-shrink: 0; }
    .cards-display {
      display: flex; justify-content: center; gap: 8px; margin: 10px 0; flex-wrap: wrap;
      max-height: 80px; overflow-y: auto;
    }
    .card {
      background: linear-gradient(135deg, #ffd93d, #ff6b6b); color: white; padding: 15px; border-radius: 10px;
      font-weight: bold; min-width: 120px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .player-cards { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; }
    .mini-card {
      background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 5px 8px; border-radius: 5px;
      font-size: 0.8rem; cursor: pointer; transition: transform 0.2s ease;
    }
    .mini-card:hover { transform: scale(1.1); }

    .card-modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1500;
    }
    .card-menu { background: white; padding: 30px; border-radius: 20px; text-align: center; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
    .card-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
    .card-item {
      background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 10px;
      cursor: pointer; transition: all 0.3s ease;
    }
    .card-item:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
    .card-description { font-size: 0.9rem; margin-top: 5px; opacity: 0.9; }

    .winner-modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 2000;
    }
    .winner-content { background: white; padding: 50px; border-radius: 20px; text-align: center; animation: celebration 1s ease-in-out; }
    @keyframes celebration {
      0% { transform: scale(0.5) rotate(-180deg); opacity: 0; }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }

    .card-popup {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 3000;
    }
    .card-popup-content {
      background: linear-gradient(135deg, #ffd93d, #ff6b6b); color: white; padding: 40px; border-radius: 20px; text-align: center;
      max-width: 400px; width: 90%; animation: cardAppear 0.8s ease-out; box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }
    @keyframes cardAppear {
      0% { transform: scale(0) rotate(180deg); opacity: 0; }
      50% { transform: scale(1.2) rotate(0deg); opacity: 0.8; }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    .card-popup h2 { margin: 0 0 20px 0; font-size: 2rem; }
    .card-popup .card-name { font-size: 1.5rem; margin: 15px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
    .card-popup .card-desc { font-size: 1.1rem; margin: 15px 0; opacity: 0.9; }

    /* モーション弱め設定対応 */
    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; }
    }

    .setup-screen, .instructions-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
      display: flex; align-items: center; justify-content: center; z-index: 1000;
    }
    .setup-container, .instructions-container {
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      border-radius: 20px; padding: 40px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      border: 2px solid #3498db; max-width: 500px; width: 90%; text-align: center;
    }
    .setup-form { display: flex; flex-direction: column; gap: 20px; }
    .input-group { text-align: left; }
    .input-group label { display: block; color: #ecf0f1; margin-bottom: 8px; font-weight: bold; }
    .name-input, .grade-select {
      width: 100%; padding: 12px; border: 2px solid #3498db; border-radius: 10px; font-size: 1rem;
      background: #ecf0f1; color: #2c3e50;
    }
    .name-input:focus, .grade-select:focus { outline: none; border-color: #2980b9; box-shadow: 0 0 10px rgba(52, 152, 219, 0.3); }

    .instructions-content { color: #ecf0f1; text-align: left; line-height: 1.6; }
    .instructions-content h3 { color: #3498db; margin-top: 25px; margin-bottom: 10px; }
    .instructions-content ol, .instructions-content ul { padding-left: 20px; }
    .instructions-content li { margin-bottom: 8px; }

    .roulette-chip{
      background: linear-gradient(135deg,#f1c40f,#f39c12);
      color:#2c3e50; padding:12px 16px; border-radius:12px;
      min-width:180px; text-align:center; border:2px solid #e67e22;
      box-shadow:0 8px 20px rgba(0,0,0,0.2); font-weight:bold;
      transition:transform .15s ease, box-shadow .15s ease;
    }
    .roulette-chip.active{ transform: scale(1.08); box-shadow:0 12px 26px rgba(230,126,34,.45); border-color:#e74c3c; }
  </style>
</head>
<body>
  <!-- 初期設定画面 -->
  <div class="setup-screen" id="setupScreen">
    <div class="setup-container">
      <h1 class="title">🎯 漢字すごろくゲーム 🎯</h1>
      <div class="setup-form">
        <div class="input-group">
          <label>プレイ人数を選択してください</label>
          <select id="playerCountSelect" class="grade-select" onchange="togglePlayer2Input()">
            <option value="1">1人プレイ（vs コンピューター）</option>
            <option value="2">2人プレイ</option>
          </select>
        </div>
        <div class="input-group">
          <label>プレイヤー1の名前</label>
          <input type="text" id="player1Name" value="プレイヤー1" class="name-input" onfocus="this.select()">
        </div>
        <div class="input-group" id="player2Group">
          <label>プレイヤー2の名前</label>
          <input type="text" id="player2Name" value="プレイヤー2" class="name-input" onfocus="this.select()">
        </div>
        <div class="input-group">
          <label>難易度を選択してください</label>
          <select id="gradeSelect" class="grade-select">
            <option value="4">小学校4年生</option>
            <option value="5">小学校5年生</option>
            <option value="6">小学校6年生</option>
          </select>
        </div>
        <button class="btn setup-btn" onclick="showInstructions()">次へ</button>
      </div>
    </div>
  </div>

  <!-- ゲーム説明画面 -->
  <div class="instructions-screen" id="instructionsScreen" style="display: none;">
    <div class="instructions-container">
      <h1 class="title">🎮 ゲームの説明 🎮</h1>
      <div class="instructions-content">
        <h3>🎯 ゲームの目標</h3>
        <p>30マスのS字型コースを進んで、最初にゴールに到達したプレイヤーの勝利です！</p>
        <h3>🎲 ゲームの流れ</h3>
        <ol>
          <li>サイコロを振って出た目の数だけ進めます</li>
          <li>漢字の問題が出題されます</li>
          <li>正解すると進むことができ、カードがもらえることがあります</li>
          <li>不正解の場合は進めません</li>
        </ol>
        <h3>🃏 カードについて</h3>
        <p>カードには様々な効果があります：</p>
        <ul>
          <li>🎲 サイコロ系：より多く進める</li>
          <li>💥 攻撃系：相手を妨害する</li>
          <li>🛡️ 防御系：攻撃から身を守る</li>
          <li>🚀 移動系：特別な移動ができる</li>
        </ul>
        <button class="btn start-btn" onclick="startGame()">ゲーム開始！</button>
      </div>
    </div>
  </div>

  <div class="game-container" id="gameContainer" style="display: none;">
    <h1 class="title">🎯 漢字すごろくゲーム 🎯</h1>

    <div class="game-board" id="gameBoard"></div>

    <div class="game-info">
      <div class="player-info active" id="player1Info">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div style="flex: 1;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <h4 style="margin: 0; font-size: 0.9rem;" id="player1NameDisplay">👦 プレイヤー1</h4>
              <button class="btn" id="useCardBtn1" onclick="showCardMenu(1)" style="display: none; font-size: 0.6rem; padding: 4px 8px;">カード使用</button>
            </div>
            <div class="player-cards" id="player1CardsList"></div>
          </div>
        </div>
      </div>

      <div class="dice-container" style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
        <div id="diceArea" style="display: flex; gap: 5px; flex-wrap: wrap; justify-content: center;">
          <div class="dice" id="dice">?</div>
        </div>
        <button class="btn" id="rollBtn" onclick="rollDice()" style="font-size: 1rem; padding: 12px 24px; margin: 8px;">サイコロ</button>
        <button class="btn" onclick="showQuitConfirm()" style="font-size: 0.7rem; padding: 6px 12px; background: linear-gradient(135deg, #e74c3c, #c0392b); margin-top: 15px;">ゲーム終了</button>
      </div>

      <div class="player-info" id="player2Info">
        <div style="flex: 1;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <h4 style="margin: 0; font-size: 0.9rem;" id="player2NameDisplay">👧 プレイヤー2</h4>
            <button class="btn" id="useCardBtn2" onclick="showCardMenu(2)" style="display: none; font-size: 0.6rem; padding: 4px 8px;">カード使用</button>
          </div>
          <div class="player-cards" id="player2CardsList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 問題モーダル -->
  <div class="question-modal" id="questionModal">
    <div class="question-content">
      <h3>漢字問題</h3>
      <div class="question-text" id="questionText"></div>
      <input type="text" class="answer-input" id="answerInput" placeholder="ひらがなで答えを入力してください" onkeypress="if(event.key==='Enter') submitAnswer()">
      <button class="submit-answer" onclick="submitAnswer()">回答する</button>
    </div>
  </div>

  <!-- カードメニューモーダル -->
  <div class="card-modal" id="cardModal">
    <div class="card-menu">
      <h3>カードを選択してください</h3>
      <div class="card-list" id="cardList"></div>
      <button class="btn" onclick="closeCardMenu()">キャンセル</button>
    </div>
  </div>

  <!-- カード獲得ポップアップ -->
  <div class="card-popup" id="cardPopup">
    <div class="card-popup-content">
      <h2>🎉 カード獲得！ 🎉</h2>
      <div class="card-name" id="popupCardName"></div>
      <div class="card-desc" id="popupCardDesc"></div>
      <button class="btn" onclick="closeCardPopup()">OK</button>
    </div>
  </div>

  <!-- シールド発動ポップアップ -->
  <div class="card-popup" id="shieldPopup">
    <div class="card-popup-content" style="background: linear-gradient(135deg, #3498db, #2980b9);">
      <h2>🛡️ シールド発動！ 🛡️</h2>
      <div class="card-name">攻撃を防ぎました！</div>
      <button class="btn" onclick="closeShieldPopup()">OK</button>
    </div>
  </div>

  <!-- 正解・不正解ポップアップ -->
  <div class="card-popup" id="answerPopup">
    <div class="card-popup-content" id="answerPopupContent">
      <h2 id="answerResultTitle">🎉 正解！ 🎉</h2>
      <div class="card-name" id="answerResultMessage"></div>
      <button class="btn" onclick="closeAnswerPopup()">OK</button>
    </div>
  </div>

  <!-- カード使用ポップアップ -->
  <div class="card-popup" id="cardUsePopup">
    <div class="card-popup-content" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
      <h2>🃏 カード使用！ 🃏</h2>
      <div class="card-name" id="usedCardName"></div>
      <div class="card-desc" id="usedCardDesc"></div>
      <button class="btn" onclick="closeCardUsePopup()">OK</button>
    </div>
  </div>

  <!-- 勝利モーダル -->
  <div class="winner-modal" id="winnerModal">
    <div class="winner-content">
      <h2 id="winnerText"></h2>
      <p>🎉 おめでとうございます！ 🎉</p>
      <button class="btn" onclick="resetGame()">もう一度遊ぶ</button>
    </div>
  </div>

  <!-- ゲーム終了確認モーダル -->
  <div class="winner-modal" id="quitModal">
    <div class="winner-content">
      <h2>🚪 ゲーム終了</h2>
      <p>本当にゲームをやめますか？</p>
      <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
        <button class="btn" onclick="quitGame()" style="background: linear-gradient(135deg, #e74c3c, #c0392b);">はい</button>
        <button class="btn" onclick="closeQuitConfirm()">いいえ</button>
      </div>
    </div>
  </div>

  <!-- 先行ルーレット -->
  <div class="winner-modal" id="firstPlayerModal" style="display:none;">
    <div class="winner-content" style="max-width:520px;">
      <h2>🎰 先行プレイヤーを決めます</h2>
      <div id="rouletteArea" style="display:flex; gap:16px; justify-content:center; margin:20px 0;">
        <div id="rouletteP1" class="roulette-chip">👦 <span id="rouletteP1Name">プレイヤー1</span></div>
        <div id="rouletteP2" class="roulette-chip">👧 <span id="rouletteP2Name">プレイヤー2</span></div>
      </div>
      <div id="rouletteMsg" style="margin:10px 0 20px; font-weight:bold;"></div>
      <button class="btn" id="rouletteStartBtn" onclick="startFirstPlayerRoulette()">スタート</button>
      <button class="btn" id="rouletteProceedBtn" style="display:none;" onclick="proceedAfterRoulette()">この順で開始</button>
    </div>
  </div>

  <script>
    // 入力正規化関数（子どもの入力ゆらぎ対応）
    function toHiragana(input){
      // 全角化・小書き統一・カタカナ→ひらがな・長音処理・空白除去
      let s = input.normalize('NFKC').toLowerCase().trim();
      // カタカナ→ひらがな
      s = s.replace(/[\u30A1-\u30F6]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0x60));
      // 長音「ー」を直前母音に展開（おおざっぱだが実用的）
      s = s.replace(/([あいうえお])ー/g, '$1$1');
      // 小書き統一
      const map = {'ぁ':'あ','ぃ':'い','ぅ':'う','ぇ':'え','ぉ':'お','ゃ':'や','ゅ':'ゆ','ょ':'よ','っ':'つ','ゎ':'わ'};
      s = s.replace(/[ぁぃぅぇぉゃゅょっゎ]/g, m => map[m] || m);
      // 空白・句読点の除去
      s = s.replace(/[\s、。．・･]/g,'');
      return s;
    }
    const normalize = toHiragana;

    // ゲーム状態
    let currentPlayer = 1;
    let players = {
      1: { position: 0, cards: [], shields: 0, skipTurn: false, name: "" },
      2: { position: 0, cards: [], shields: 0, skipTurn: false, name: "" }
    };
    let diceValue = 0;
    let gameEnded = false;
    let selectedGrade = 4;
    let currentQuestion = null;
    let isAIGame = false;
    let playerCount = 2;
    let turnLocked = false; // 入力ロック
    let pendingAnswerFor = null; // 回答の所有者
    let lucky6Active = false; // ラッキー6
    let aiBusy = false; // AI再入防止
    const timers = []; // タイマー管理
    let isClosingCardPopup = false;
    let isSwitchingTurn = false;
    let lastAnswerCorrect = null;
    let turnId = 0;

    // ルーレット関連
    let rouletteInterval = null;
    let rouletteSpins = 0;
    let rouletteDecided = null;

    // 学年別漢字問題データ
    const questionsByGrade = {
      4: [ /* 省略なし：元データそのまま */ 
        { question: "この漢字の読み方は？「協力」", answer: "きょうりょく" },
        { question: "この漢字の読み方は？「対象」", answer: "たいしょう" },
        { question: "この漢字の読み方は？「結果」", answer: "けっか" },
        { question: "この漢字の読み方は？「説教」", answer: "せっきょう" },
        { question: "この漢字の読み方は？「無実」", answer: "むじつ" },
        { question: "この漢字の読み方は？「順位」", answer: "じゅんい" },
        { question: "この漢字の読み方は？「衣類」", answer: "いるい" },
        { question: "この漢字の読み方は？「要求」", answer: "ようきゅう" },
        { question: "この漢字の読み方は？「加熱」", answer: "かねつ" },
        { question: "この漢字の読み方は？「関連」", answer: "かんれん" },
        { question: "この漢字の読み方は？「実験」", answer: "じっけん" },
        { question: "この漢字の読み方は？「時差」", answer: "じさ" },
        { question: "この漢字の読み方は？「景品」", answer: "けいひん" },
        { question: "この漢字の読み方は？「念願」", answer: "ねんがん" },
        { question: "この漢字の読み方は？「兵士」", answer: "へいし" },
        { question: "この漢字の読み方は？「北極」", answer: "ほっきょく" },
        { question: "この漢字の読み方は？「録音」", answer: "ろくおん" },
        { question: "この漢字の読み方は？「最近」", answer: "さいきん" },
        { question: "この漢字の読み方は？「達人」", answer: "たつじん" },
        { question: "この漢字の読み方は？「円周」", answer: "えんしゅう" },
        { question: "この漢字の読み方は？「欠場」", answer: "けつじょう" },
        { question: "この漢字の読み方は？「村民」", answer: "そんみん" },
        { question: "この漢字の読み方は？「出席」", answer: "しゅっせき" },
        { question: "この漢字の読み方は？「遠浅」", answer: "とおあさ" },
        { question: "この漢字の読み方は？「察知」", answer: "さっち" },
        { question: "この漢字の読み方は？「通信」", answer: "つうしん" },
        { question: "この漢字の読み方は？「入隊」", answer: "にゅうたい" },
        { question: "この漢字の読み方は？「種類」", answer: "しゅるい" },
        { question: "この漢字の読み方は？「粉末」", answer: "ふんまつ" },
        { question: "この漢字の読み方は？「年輪」", answer: "ねんりん" },
        { question: "この漢字の読み方は？「水位」", answer: "すいい" },
        { question: "この漢字の読み方は？「未定」", answer: "みてい" },
        { question: "この漢字の読み方は？「加入」", answer: "かにゅう" },
        { question: "この漢字の読み方は？「残暑」", answer: "ざんしょ" },
        { question: "この漢字の読み方は？「小包」", answer: "こづつみ" },
        { question: "この漢字の読み方は？「満点」", answer: "まんてん" },
        { question: "この漢字の読み方は？「当然」", answer: "とうぜん" },
        { question: "この漢字の読み方は？「関係」", answer: "かんけい" },
        { question: "この漢字の読み方は？「案内」", answer: "あんない" },
        { question: "この漢字の読み方は？「型紙」", answer: "かたがみ" },
        { question: "この漢字の読み方は？「面積」", answer: "めんせき" },
        { question: "この漢字の読み方は？「追加」", answer: "ついか" },
        { question: "この漢字の読み方は？「年末」", answer: "ねんまつ" },
        { question: "この漢字の読み方は？「木材」", answer: "もくざい" },
        { question: "この漢字の読み方は？「国民」", answer: "こくみん" },
        { question: "この漢字の読み方は？「法事」", answer: "ほうじ" },
        { question: "この漢字の読み方は？「兵器」", answer: "へいき" },
        { question: "この漢字の読み方は？「信号」", answer: "しんごう" },
        { question: "この漢字の読み方は？「倉庫」", answer: "そうこ" },
        { question: "この漢字の読み方は？「兵隊」", answer: "へいたい" },
        { question: "この漢字の読み方は？「気候」", answer: "きこう" },
        { question: "この漢字の読み方は？「札束」", answer: "さつたば" },
        { question: "この漢字の読み方は？「徒歩」", answer: "とほ" },
        { question: "この漢字の読み方は？「録画」", answer: "ろくが" },
        { question: "この漢字の読み方は？「大臣」", answer: "だいじん" },
        { question: "この漢字の読み方は？「会費」", answer: "かいひ" },
        { question: "この漢字の読み方は？「方法」", answer: "ほうほう" },
        { question: "この漢字の読み方は？「共用」", answer: "きょうよう" },
        { question: "この漢字の読み方は？「機械」", answer: "きかい" },
        { question: "この漢字の読み方は？「観客」", answer: "かんきゃく" },
        { question: "この漢字の読み方は？「愛犬」", answer: "あいけん" },
        { question: "この漢字の読み方は？「命令」", answer: "めいれい" },
        { question: "この漢字の読み方は？「祝福」", answer: "しゅくふく" },
        { question: "この漢字の読み方は？「楽器」", answer: "がっき" },
        { question: "この漢字の読み方は？「良薬」", answer: "りょうやく" },
        { question: "この漢字の読み方は？「軍手」", answer: "ぐんて" },
        { question: "この漢字の読み方は？「結束」", answer: "けっそく" },
        { question: "この漢字の読み方は？「連続」", answer: "れんぞく" },
        { question: "この漢字の読み方は？「名札」", answer: "なふだ" },
        { question: "この漢字の読み方は？「放置」", answer: "ほうち" },
        { question: "この漢字の読み方は？「文脈」", answer: "ぶんみゃく" },
        { question: "この漢字の読み方は？「夫人」", answer: "ふじん" },
        { question: "この漢字の読み方は？「冷静」", answer: "れいせい" },
        { question: "この漢字の読み方は？「達成」", answer: "たっせい" },
        { question: "この漢字の読み方は？「会議」", answer: "かいぎ" },
        { question: "この漢字の読み方は？「要点」", answer: "ようてん" },
        { question: "この漢字の読み方は？「国産」", answer: "こくさん" },
        { question: "この漢字の読み方は？「投票」", answer: "とうひょう" },
        { question: "この漢字の読み方は？「消印」", answer: "けしいん" },
        { question: "この漢字の読み方は？「発達」", answer: "はったつ" },
        { question: "この漢字の読み方は？「重要」", answer: "じゅうよう" },
        { question: "この漢字の読み方は？「目印」", answer: "めじるし" },
        { question: "この漢字の読み方は？「得点」", answer: "とくてん" },
        { question: "この漢字の読み方は？「軍隊」", answer: "ぐんたい" },
        { question: "この漢字の読み方は？「清流」", answer: "せいりゅう" },
        { question: "この漢字の読み方は？「得意」", answer: "とくい" },
        { question: "この漢字の読み方は？「浴室」", answer: "よくしつ" },
        { question: "この漢字の読み方は？「山脈」", answer: "さんみゃく" },
        { question: "この漢字の読み方は？「願望」", answer: "がんぼう" },
        { question: "この漢字の読み方は？「周辺」", answer: "しゅうへん" },
        { question: "この漢字の読み方は？「出費」", answer: "しゅっぴ" },
        { question: "この漢字の読み方は？「目標」", answer: "もくひょう" },
        { question: "この漢字の読み方は？「信用」", answer: "しんよう" },
        { question: "この漢字の読み方は？「観察」", answer: "かんさつ" },
        { question: "この漢字の読み方は？「辞書」", answer: "じしょ" },
        { question: "この漢字の読み方は？「席順」", answer: "せきじゅん" },
        { question: "この漢字の読み方は？「生産」", answer: "せいさん" },
        { question: "この漢字の読み方は？「塩害」", answer: "えんがい" },
        { question: "この漢字の読み方は？「飛行」", answer: "ひこう" },
        { question: "この漢字の読み方は？「大陸」", answer: "たいりく" }
      ],
      5: [
        { question: "この漢字の読み方は？「輸送」", answer: "ゆそう" },
        { question: "この漢字の読み方は？「情熱」", answer: "じょうねつ" },
        { question: "この漢字の読み方は？「回復」", answer: "かいふく" },
        { question: "この漢字の読み方は？「液体」", answer: "えきたい" },
        { question: "この漢字の読み方は？「習慣」", answer: "しゅうかん" },
        { question: "この漢字の読み方は？「格安」", answer: "かくやす" },
        { question: "この漢字の読み方は？「禁物」", answer: "きんもつ" },
        { question: "この漢字の読み方は？「独特」", answer: "どくとく" },
        { question: "この漢字の読み方は？「賛成」", answer: "さんせい" },
        { question: "この漢字の読み方は？「家財」", answer: "かざい" },
        { question: "この漢字の読み方は？「反則」", answer: "はんそく" },
        { question: "この漢字の読み方は？「確定」", answer: "かくてい" },
        { question: "この漢字の読み方は？「犯行」", answer: "はんこう" },
        { question: "この漢字の読み方は？「河口」", answer: "かこう" },
        { question: "この漢字の読み方は？「正確」", answer: "せいかく" },
        { question: "この漢字の読み方は？「酸味」", answer: "さんみ" },
        { question: "この漢字の読み方は？「情報」", answer: "じょうほう" },
        { question: "この漢字の読み方は？「原因」", answer: "げんいん" },
        { question: "この漢字の読み方は？「版画」", answer: "はんが" },
        { question: "この漢字の読み方は？「効能」", answer: "こうのう" },
        { question: "この漢字の読み方は？「内容」", answer: "ないよう" },
        { question: "この漢字の読み方は？「証明」", answer: "しょうめい" },
        { question: "この漢字の読み方は？「経路」", answer: "けいろ" },
        { question: "この漢字の読み方は？「講習」", answer: "こうしゅう" },
        { question: "この漢字の読み方は？「接続」", answer: "せつぞく" },
        { question: "この漢字の読み方は？「引退」", answer: "いんたい" },
        { question: "この漢字の読み方は？「成績」", answer: "せいせき" },
        { question: "この漢字の読み方は？「対応」", answer: "たいおう" },
        { question: "この漢字の読み方は？「経験」", answer: "けいけん" },
        { question: "この漢字の読み方は？「先祖」", answer: "せんぞ" },
        { question: "この漢字の読み方は？「表情」", answer: "ひょうじょう" },
        { question: "この漢字の読み方は？「複数」", answer: "ふくすう" },
        { question: "この漢字の読み方は？「念仏」", answer: "ねんぶつ" },
        { question: "この漢字の読み方は？「預金」", answer: "よきん" },
        { question: "この漢字の読み方は？「適度」", answer: "てきど" },
        { question: "この漢字の読み方は？「快復」", answer: "かいふく" },
        { question: "この漢字の読み方は？「価格」", answer: "かかく" },
        { question: "この漢字の読み方は？「米俵」", answer: "こめだわら" },
        { question: "この漢字の読み方は？「暴力」", answer: "ぼうりょく" },
        { question: "この漢字の読み方は？「往復」", answer: "おうふく" },
        { question: "この漢字の読み方は？「提示」", answer: "ていじ" },
        { question: "この漢字の読み方は？「独学」", answer: "どくがく" },
        { question: "この漢字の読み方は？「適当」", answer: "てきとう" },
        { question: "この漢字の読み方は？「人情」", answer: "にんじょう" },
        { question: "この漢字の読み方は？「強敵」", answer: "きょうてき" },
        { question: "この漢字の読み方は？「主婦」", answer: "しゅふ" },
        { question: "この漢字の読み方は？「規制」", answer: "きせい" },
        { question: "この漢字の読み方は？「住居」", answer: "じゅうきょ" },
        { question: "この漢字の読み方は？「倍率」", answer: "ばいりつ" },
        { question: "この漢字の読み方は？「祖父」", answer: "そふ" },
        { question: "この漢字の読み方は？「表示」", answer: "ひょうじ" },
        { question: "この漢字の読み方は？「旧友」", answer: "きゅうゆう" },
        { question: "この漢字の読み方は？「業績」", answer: "ぎょうせき" },
        { question: "この漢字の読み方は？「減速」", answer: "げんそく" },
        { question: "この漢字の読み方は？「清潔」", answer: "せいけつ" },
        { question: "この漢字の読み方は？「採点」", answer: "さいてん" },
        { question: "この漢字の読み方は？「同居」", answer: "どうきょ" },
        { question: "この漢字の読み方は？「増築」", answer: "ぞうちく" },
        { question: "この漢字の読み方は？「勢力」", answer: "せいりょく" },
        { question: "この漢字の読み方は？「現場」", answer: "げんば" },
        { question: "この漢字の読み方は？「採取」", answer: "さいしゅ" },
        { question: "この漢字の読み方は？「絶賛」", answer: "ぜっさん" },
        { question: "この漢字の読み方は？「校舎」", answer: "こうしゃ" },
        { question: "この漢字の読み方は？「絶対」", answer: "ぜったい" },
        { question: "この漢字の読み方は？「精米」", answer: "せいまい" },
        { question: "この漢字の読み方は？「画像」", answer: "がぞう" },
        { question: "この漢字の読み方は？「義理」", answer: "ぎり" },
        { question: "この漢字の読み方は？「枝豆」", answer: "えだまめ" },
        { question: "この漢字の読み方は？「均等」", answer: "きんとう" },
        { question: "この漢字の読み方は？「記述」", answer: "きじゅつ" },
        { question: "この漢字の読み方は？「水質」", answer: "すいしつ" },
        { question: "この漢字の読み方は？「常識」", answer: "じょうしき" },
        { question: "この漢字の読み方は？「文句」", answer: "もんく" },
        { question: "この漢字の読み方は？「個体」", answer: "こたい" },
        { question: "この漢字の読み方は？「税金」", answer: "ぜいきん" },
        { question: "この漢字の読み方は？「防犯」", answer: "ぼうはん" },
        { question: "この漢字の読み方は？「天敵」", answer: "てんてき" },
        { question: "この漢字の読み方は？「雑草」", answer: "ざっそう" },
        { question: "この漢字の読み方は？「所属」", answer: "しょぞく" },
        { question: "この漢字の読み方は？「眼科」", answer: "がんか" },
        { question: "この漢字の読み方は？「退院」", answer: "たいいん" },
        { question: "この漢字の読み方は？「豊富」", answer: "ほうふ" },
        { question: "この漢字の読み方は？「災害」", answer: "さいがい" },
        { question: "この漢字の読み方は？「評価」", answer: "ひょうか" },
        { question: "この漢字の読み方は？「支店」", answer: "してん" },
        { question: "この漢字の読み方は？「提案」", answer: "ていあん" },
        { question: "この漢字の読み方は？「逆境」", answer: "ぎゃっきょう" },
        { question: "この漢字の読み方は？「混雑」", answer: "こんざつ" },
        { question: "この漢字の読み方は？「性質」", answer: "せいしつ" },
        { question: "この漢字の読み方は？「述語」", answer: "じゅつご" },
        { question: "この漢字の読み方は？「資格」", answer: "しかく" },
        { question: "この漢字の読み方は？「理解」", answer: "りかい" },
        { question: "この漢字の読み方は？「構成」", answer: "こうせい" },
        { question: "この漢字の読み方は？「事情」", answer: "じじょう" },
        { question: "この漢字の読み方は？「炭鉱」", answer: "たんこう" },
        { question: "この漢字の読み方は？「音程」", answer: "おんてい" },
        { question: "この漢字の読み方は？「留学」", answer: "りゅうがく" },
        { question: "この漢字の読み方は？「気圧」", answer: "きあつ" },
        { question: "この漢字の読み方は？「移動」", answer: "いどう" },
        { question: "この漢字の読み方は？「事故」", answer: "じこ" }
      ],
      6: [
        { question: "この漢字の読み方は？「砂鉄」", answer: "さてつ" },
        { question: "この漢字の読み方は？「裁判」", answer: "さいばん" },
        { question: "この漢字の読み方は？「秘蔵」", answer: "ひぞう" },
        { question: "この漢字の読み方は？「破片」", answer: "はへん" },
        { question: "この漢字の読み方は？「除去」", answer: "じょきょ" },
        { question: "この漢字の読み方は？「忠実」", answer: "ちゅうじつ" },
        { question: "この漢字の読み方は？「模型」", answer: "もけい" },
        { question: "この漢字の読み方は？「尊敬」", answer: "そんけい" },
        { question: "この漢字の読み方は？「深刻」", answer: "しんこく" },
        { question: "この漢字の読み方は？「骨折」", answer: "こっせつ" },
        { question: "この漢字の読み方は？「三冊」", answer: "さんさつ" },
        { question: "この漢字の読み方は？「翌日」", answer: "よくじつ" },
        { question: "この漢字の読み方は？「収集」", answer: "しゅうしゅう" },
        { question: "この漢字の読み方は？「心臓」", answer: "しんぞう" },
        { question: "この漢字の読み方は？「訪問」", answer: "ほうもん" },
        { question: "この漢字の読み方は？「将軍」", answer: "しょうぐん" },
        { question: "この漢字の読み方は？「腹痛」", answer: "ふくつう" },
        { question: "この漢字の読み方は？「推理」", answer: "すいり" },
        { question: "この漢字の読み方は？「縮尺」", answer: "しゅくしゃく" },
        { question: "この漢字の読み方は？「縮小」", answer: "しゅくしょう" },
        { question: "この漢字の読み方は？「首脳」", answer: "しゅのう" },
        { question: "この漢字の読み方は？「死亡」", answer: "しぼう" },
        { question: "この漢字の読み方は？「灰色」", answer: "はいいろ" },
        { question: "この漢字の読み方は？「装置」", answer: "そうち" },
        { question: "この漢字の読み方は？「鋼材」", answer: "こうざい" },
        { question: "この漢字の読み方は？「俳句」", answer: "はいく" },
        { question: "この漢字の読み方は？「提供」", answer: "ていきょう" },
        { question: "この漢字の読み方は？「朗読」", answer: "ろうどく" },
        { question: "この漢字の読み方は？「担任」", answer: "たんにん" },
        { question: "この漢字の読み方は？「警備」", answer: "けいび" },
        { question: "この漢字の読み方は？「単純」", answer: "たんじゅん" },
        { question: "この漢字の読み方は？「貴重」", answer: "きちょう" },
        { question: "この漢字の読み方は？「視点」", answer: "してん" },
        { question: "この漢字の読み方は？「担当」", answer: "たんとう" },
        { question: "この漢字の読み方は？「就任」", answer: "しゅうにん" },
        { question: "この漢字の読み方は？「自己」", answer: "じこ" },
        { question: "この漢字の読み方は？「今晩」", answer: "こんばん" },
        { question: "この漢字の読み方は？「忠告」", answer: "ちゅうこく" },
        { question: "この漢字の読み方は？「厳重」", answer: "げんじゅう" },
        { question: "この漢字の読み方は？「散乱」", answer: "さんらん" },
        { question: "この漢字の読み方は？「値段」", answer: "ねだん" },
        { question: "この漢字の読み方は？「首筋」", answer: "くびすじ" },
        { question: "この漢字の読み方は？「批判」", answer: "ひはん" },
        { question: "この漢字の読み方は？「宣告」", answer: "せんこく" },
        { question: "この漢字の読み方は？「精密」", answer: "せいみつ" },
        { question: "この漢字の読み方は？「感激」", answer: "かんげき" },
        { question: "この漢字の読み方は？「解除」", answer: "かいじょ" },
        { question: "この漢字の読み方は？「推移」", answer: "すいい" },
        { question: "この漢字の読み方は？「悪党」", answer: "あくとう" },
        { question: "この漢字の読み方は？「俳優」", answer: "はいゆう" },
        { question: "この漢字の読み方は？「革命」", answer: "かくめい" },
        { question: "この漢字の読み方は？「頂上」", answer: "ちょうじょう" },
        { question: "この漢字の読み方は？「賃金」", answer: "ちんぎん" },
        { question: "この漢字の読み方は？「操縦」", answer: "そうじゅう" },
        { question: "この漢字の読み方は？「蒸気」", answer: "じょうき" },
        { question: "この漢字の読み方は？「沿岸」", answer: "えんがん" },
        { question: "この漢字の読み方は？「収納」", answer: "しゅうのう" },
        { question: "この漢字の読み方は？「皇居」", answer: "こうきょ" },
        { question: "この漢字の読み方は？「窓口」", answer: "まどぐち" },
        { question: "この漢字の読み方は？「規律」", answer: "きりつ" },
        { question: "この漢字の読み方は？「班長」", answer: "はんちょう" },
        { question: "この漢字の読み方は？「宝物」", answer: "たからもの" },
        { question: "この漢字の読み方は？「傷口」", answer: "きずぐち" },
        { question: "この漢字の読み方は？「著者」", answer: "ちょしゃ" },
        { question: "この漢字の読み方は？「食欲」", answer: "しょくよく" },
        { question: "この漢字の読み方は？「干潮」", answer: "かんちょう" },
        { question: "この漢字の読み方は？「誤解」", answer: "ごかい" },
        { question: "この漢字の読み方は？「字幕」", answer: "じまく" },
        { question: "この漢字の読み方は？「降参」", answer: "こうさん" },
        { question: "この漢字の読み方は？「財宝」", answer: "ざいほう" },
        { question: "この漢字の読み方は？「山頂」", answer: "さんちょう" },
        { question: "この漢字の読み方は？「度胸」", answer: "どきょう" },
        { question: "この漢字の読み方は？「巻物」", answer: "まきもの" },
        { question: "この漢字の読み方は？「権限」", answer: "けんげん" },
        { question: "この漢字の読み方は？「私語」", answer: "しご" },
        { question: "この漢字の読み方は？「砂金」", answer: "さきん" },
        { question: "この漢字の読み方は？「時刻」", answer: "じこく" },
        { question: "この漢字の読み方は？「寸法」", answer: "すんぽう" },
        { question: "この漢字の読み方は？「憲法」", answer: "けんぽう" },
        { question: "この漢字の読み方は？「返済」", answer: "へんさい" },
        { question: "この漢字の読み方は？「映像」", answer: "えいぞう" },
        { question: "この漢字の読み方は？「善悪」", answer: "ぜんあく" },
        { question: "この漢字の読み方は？「確認」", answer: "かくにん" },
        { question: "この漢字の読み方は？「否決」", answer: "ひけつ" },
        { question: "この漢字の読み方は？「視線」", answer: "しせん" },
        { question: "この漢字の読み方は？「勤務」", answer: "きんむ" },
        { question: "この漢字の読み方は？「背面」", answer: "はいめん" },
        { question: "この漢字の読み方は？「砂場」", answer: "すなば" },
        { question: "この漢字の読み方は？「対策」", answer: "たいさく" },
        { question: "この漢字の読み方は？「主将」", answer: "しゅしょう" },
        { question: "この漢字の読み方は？「疑問」", answer: "ぎもん" },
        { question: "この漢字の読み方は？「敬語」", answer: "けいご" },
        { question: "この漢字の読み方は？「翌年」", answer: "よくねん" },
        { question: "この漢字の読み方は？「危険」", answer: "きけん" },
        { question: "この漢字の読み方は？「仁愛」", answer: "じんあい" },
        { question: "この漢字の読み方は？「将来」", answer: "しょうらい" },
        { question: "この漢字の読み方は？「石段」", answer: "いしだん" },
        { question: "この漢字の読み方は？「役割」", answer: "やくわり" },
        { question: "この漢字の読み方は？「牛乳」", answer: "ぎゅうにゅう" },
        { question: "この漢字の読み方は？「綿棒」", answer: "めんぼう" }
      ]
    };

    // カード定義
    const cardTypes = [
      { name: "🎲🎲 サイコロ2個", description: "2つのサイコロの合計で進める", type: "dice2", weight: 15 },
      { name: "🎲🎲🎲 サイコロ3個", description: "3つのサイコロの合計で進める", type: "dice3", weight: 5 },
      { name: "🍀 ラッキー6", description: "必ず6が出るサイコロ", type: "lucky6", weight: 10 },
      { name: "💥 妨害カード", description: "相手を3マス戻す", type: "attack", weight: 10 },
      { name: "🚀 ジャンプ", description: "3マス進む", type: "jump", weight: 10 },
      { name: "🛡️ シールド", description: "攻撃を1回防ぐ", type: "shield", weight: 15 },
      { name: "💣 爆発", description: "2人ともスタートに戻る", type: "bomb", weight: 5 },
      { name: "🚧 ストップ", description: "相手を1回休みにする", type: "stop", weight: 10 },
      { name: "🪂 ランダム", description: "どこか別の場所にテレポートする", type: "random", weight: 10 },
      { name: "🥷 泥棒", description: "相手のカードをランダムで1枚奪える", type: "steal", weight: 10 }
    ];
    function getRandomCard() {
      const totalWeight = cardTypes.reduce((sum, card) => sum + card.weight, 0);
      let random = Math.random() * totalWeight;
      for (const card of cardTypes) {
        random -= card.weight;
        if (random <= 0) return { ...card };
      }
      return { ...cardTypes[0] };
    }

    // 入力ロック
    function lockInputs() {
      turnLocked = true;
      document.getElementById('rollBtn').disabled = true;
      document.getElementById('useCardBtn1').disabled = true;
      document.getElementById('useCardBtn2').disabled = true;
    }
    function unlockInputsForCurrentPlayer() {
      turnLocked = false;
      if (isAIGame && currentPlayer === 2) {
        document.getElementById('rollBtn').disabled = true;
        document.getElementById('useCardBtn1').disabled = true;
        document.getElementById('useCardBtn2').disabled = true;
      } else {
        document.getElementById('rollBtn').disabled = false;
        document.getElementById('useCardBtn1').disabled = (currentPlayer !== 1 || players[1].cards.length === 0);
        document.getElementById('useCardBtn2').disabled = (currentPlayer !== 2 || players[2].cards.length === 0);
      }
    }

    // プレイヤー2入力欄切り替え
    function togglePlayer2Input() {
      const playerCount = document.getElementById('playerCountSelect').value;
      const player2Group = document.getElementById('player2Group');
      player2Group.style.display = (playerCount === '1') ? 'none' : 'block';
    }

    // 初期設定→説明
    function showInstructions() {
      const player1Name = document.getElementById('player1Name').value.trim();
      playerCount = parseInt(document.getElementById('playerCountSelect').value);
      if (!player1Name) { alert('プレイヤー名を入力してください'); return; }
      players[1].name = player1Name;

      if (playerCount === 1) {
        isAIGame = true;
        players[2].name = 'コンピューター';
      } else {
        const player2Name = document.getElementById('player2Name').value.trim();
        if (!player2Name) { alert('プレイヤー2の名前を入力してください'); return; }
        isAIGame = false;
        players[2].name = player2Name;
      }
      selectedGrade = parseInt(document.getElementById('gradeSelect').value);
      saveSettings();

      document.getElementById('setupScreen').style.display = 'none';
      document.getElementById('instructionsScreen').style.display = 'flex';
    }

    function startGame() {
      // 説明画面を閉じる
      document.getElementById('instructionsScreen').style.display = 'none';

      // 学年表示（タイトル末尾）—既にある場合は追加しない
      const titleElement = document.querySelector('.title');
      if (!titleElement.querySelector('.grade-display')) {
        titleElement.insertAdjacentHTML('beforeend', `<span class="grade-display" style="font-size:1rem;opacity:.8">（${selectedGrade}年生）</span>`);
      }

      prepareFirstPlayerRoulette();
      document.getElementById('firstPlayerModal').style.display = 'flex';
    }

    function prepareFirstPlayerRoulette(){
      const p1 = players[1].name || 'プレイヤー1';
      const p2 = isAIGame ? 'コンピューター' : (players[2].name || 'プレイヤー2');
      document.getElementById('rouletteP1Name').textContent = p1;
      document.getElementById('rouletteP2Name').textContent = p2;
      document.getElementById('rouletteMsg').textContent = 'スタートを押すと抽選します！';
      document.getElementById('rouletteProceedBtn').style.display = 'none';
      document.getElementById('rouletteStartBtn').style.display = 'inline-block';
      document.getElementById('rouletteP1').classList.remove('active');
      document.getElementById('rouletteP2').classList.remove('active');
      rouletteDecided = null;
    }

    function startFirstPlayerRoulette(){
      const chip1 = document.getElementById('rouletteP1');
      const chip2 = document.getElementById('rouletteP2');
      const msg = document.getElementById('rouletteMsg');
      document.getElementById('rouletteStartBtn').style.display = 'none';
      msg.textContent = 'ぐるぐる〜…';
      rouletteSpins = 0;
      let highlight = 1;

      rouletteInterval = setInterval(() => {
        highlight = (highlight === 1 ? 2 : 1);
        chip1.classList.toggle('active', highlight === 1);
        chip2.classList.toggle('active', highlight === 2);
        rouletteSpins++;

        if (rouletteSpins > 20) {
          clearInterval(rouletteInterval);
          const winner = Math.random() < 0.5 ? 1 : 2;
          rouletteDecided = winner;
          chip1.classList.toggle('active', winner === 1);
          chip2.classList.toggle('active', winner === 2);
          const winnerIcon = (winner === 1) ? '👦' : (isAIGame ? '🤖' : '👧');
          const winnerName = (winner === 1) ? (players[1].name || 'プレイヤー1') : (isAIGame ? 'コンピューター' : (players[2].name || 'プレイヤー2'));
          msg.textContent = `🎉 先行は ${winnerIcon} ${winnerName}！`;
          document.getElementById('rouletteProceedBtn').style.display = 'inline-block';
        }
      }, 120);
    }

    function proceedAfterRoulette(){
      document.getElementById('firstPlayerModal').style.display = 'none';
      document.getElementById('gameContainer').style.display = 'flex';
      initializeBoard();
      currentPlayer = rouletteDecided || 1;
      turnLocked = false;
      updateTurnDisplay();
      startPlayerTurn();
    }

    // 盤面初期化（S字）
    function initializeBoard() {
      const board = document.getElementById('gameBoard');
      board.innerHTML = '';
      for (let i = 0; i < 30; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.id = `cell-${i}`;

        // S字配置
        let row, col;
        if (i <= 9) { row = 0; col = i; }
        else if (i <= 19) { row = 1; col = 19 - i; }
        else { row = 2; col = i - 20; }
        cell.style.gridRow = row + 1;
        cell.style.gridColumn = col + 1;

        if (i === 0) {
          cell.classList.add('start');
          cell.textContent = 'START';
        } else if (i === 29) {
          cell.classList.add('goal');
          cell.textContent = 'GOAL';
        } else {
          const colorClass = `color${Math.floor(Math.random() * 10) + 1}`;
          cell.classList.add(colorClass);
        }

        // 進行方向矢印
        if (i < 29) {
          const arrow = document.createElement('div');
          arrow.style.position = 'absolute';
          arrow.style.fontSize = '0.6rem';
          arrow.style.color = '#fff';
          arrow.style.fontWeight = 'bold';
          arrow.style.textShadow = '1px 1px 2px rgba(0,0,0,0.8)';

          if (i < 9) {
            arrow.textContent = '→';
            arrow.style.right = '-8px';
            arrow.style.top = '50%';
            arrow.style.transform = 'translateY(-50%)';
          } else if (i === 9) {
            arrow.textContent = '↓';
            arrow.style.bottom = '-8px';
            arrow.style.left = '50%';
            arrow.style.transform = 'translateX(-50%)';
          } else if (i >= 10 && i < 19) {
            arrow.textContent = '←';
            arrow.style.left = '-8px';
            arrow.style.top = '50%';
            arrow.style.transform = 'translateY(-50%)';
          } else if (i === 19) {
            arrow.textContent = '↓';
            arrow.style.bottom = '-8px';
            arrow.style.left = '50%';
            arrow.style.transform = 'translateX(-50%)';
          } else if (i >= 20 && i < 28) {
            arrow.textContent = '→';
            arrow.style.right = '-8px';
            arrow.style.top = '50%';
            arrow.style.transform = 'translateY(-50%)';
          }
          if (arrow.textContent) cell.appendChild(arrow);
        }

        board.appendChild(cell);
      }
      updatePlayerPositions();
    }

    // 駒の配置更新
    function updatePlayerPositions() {
      document.querySelectorAll('.player').forEach(p => p.remove());

      const cell1 = document.getElementById(`cell-${players[1].position}`);
      if (cell1) {
        const player1 = document.createElement('div');
        player1.className = 'player player1';
        player1.textContent = '👦';
        cell1.appendChild(player1);
      }

      const cell2 = document.getElementById(`cell-${players[2].position}`);
      if (cell2) {
        const player2 = document.createElement('div');
        player2.className = 'player player2';
        player2.textContent = isAIGame ? '🤖' : '👧';
        cell2.appendChild(player2);
      }

      document.getElementById('player1NameDisplay').textContent = `👦 ${players[1].name} (${players[1].position}マス目)`;
      const player2Icon = isAIGame ? '🤖' : '👧';
      document.getElementById('player2NameDisplay').textContent = `${player2Icon} ${players[2].name} (${players[2].position}マス目)`;

      updatePlayerCards(1);
      updatePlayerCards(2);

      document.getElementById('useCardBtn1').style.display = players[1].cards.length > 0 ? 'block' : 'none';
      document.getElementById('useCardBtn2').style.display = players[2].cards.length > 0 ? 'block' : 'none';
    }

    function updatePlayerCards(playerNum) {
      const cardsList = document.getElementById(`player${playerNum}CardsList`);
      cardsList.innerHTML = '';
      players[playerNum].cards.forEach((card) => {
        const cardElement = document.createElement('div');
        cardElement.className = 'mini-card';
        cardElement.textContent = card.name.split(' ')[0];
        cardElement.title = card.name + ': ' + card.description;
        cardsList.appendChild(cardElement);
      });
    }

    // サイコロ
    function rollDice() {
      if (gameEnded || turnLocked) return;
      lockInputs();
      pendingAnswerFor = currentPlayer;

      if (players[currentPlayer].skipTurn) {
        players[currentPlayer].skipTurn = false;
        alert(`プレイヤー${currentPlayer}は1回休みです！`);
        const t = setTimeout(() => switchToNextPlayer(), 1000);
        timers.push(t);
        return;
      }
      rollMultipleDice(1);
    }

    function rollMultipleDice(diceCount) {
      const diceArea = document.getElementById('diceArea');
      const rollBtn = document.getElementById('rollBtn');

      diceArea.innerHTML = '';
      const diceElements = [];
      for (let i = 0; i < diceCount; i++) {
        const dice = document.createElement('div');
        dice.className = 'dice';
        dice.id = `dice-${i}`;
        dice.textContent = '?';
        diceArea.appendChild(dice);
        diceElements.push(dice);
      }
      rollBtn.disabled = true;

      diceElements.forEach(dice => dice.classList.add('rolling'));

      let rollCount = 0;
      const diceValues = [];
      const rollInterval = setInterval(() => {
        diceElements.forEach(dice => { dice.textContent = Math.floor(Math.random() * 6) + 1; });
        rollCount++;
        if (rollCount > 10) {
          clearInterval(rollInterval);
          let total = 0;
          diceElements.forEach((dice) => {
            let value = lucky6Active ? 6 : (Math.floor(Math.random() * 6) + 1);
            dice.textContent = value;
            dice.classList.remove('rolling');
            diceValues.push(value);
            total += value;
          });
          diceValue = total;
          if (lucky6Active) { lucky6Active = false; }

          if (diceCount > 1) {
            setTimeout(() => { alert(`🎲 サイコロの合計: ${diceValues.join(' + ')} = ${total}`); }, 500);
          }

          const myTurn = turnId;
          const isAITurn = isAIGame && currentPlayer === 2 && pendingAnswerFor === 2;
          const nextStep = isAITurn ? aiAnswerQuestion : showQuestion;
          const t = setTimeout(() => {
            if (gameEnded || myTurn !== turnId) return;
            nextStep();
          }, diceCount > 1 ? 1500 : 500);
          timers.push(t);
        }
      }, 100);
    }

    // 問題表示
    function showQuestion() {
      if (isAIGame && currentPlayer === 2) {
        const modal = document.getElementById('questionModal');
        if (modal) modal.style.display = 'none';
        aiAnswerQuestion();
        return;
      }
      const questions = questionsByGrade[selectedGrade];
      currentQuestion = questions[Math.floor(Math.random() * questions.length)];
      document.getElementById('questionText').textContent = currentQuestion.question;
      const answerInput = document.getElementById('answerInput');
      answerInput.value = '';
      openModal('questionModal', '#answerInput');

      turnLocked = false;
      document.getElementById('rollBtn').disabled = true;
      document.getElementById('useCardBtn1').disabled = true;
      document.getElementById('useCardBtn2').disabled = true;
    }

    function submitAnswer() {
      if (turnLocked) { console.warn('submit blocked by turnLocked'); return; }
      const answerInput = document.getElementById('answerInput');
      const userAnswer = normalize(answerInput.value);
      if (!userAnswer) { alert('答えを入力してください'); return; }
      lockInputs();
      checkAnswer(userAnswer, pendingAnswerFor);
    }

    function checkAnswer(userAnswer, playerNum = null) {
      closeModal('questionModal');
      const actualPlayer = playerNum ?? pendingAnswerFor;
      console.log(`プレイヤー${actualPlayer}の回答: ${userAnswer}`);
      const correct = normalize(currentQuestion.answer);
      if (userAnswer === correct) {
        console.log(`プレイヤー${actualPlayer}正解`);
        showAnswerPopup(true, diceValue);
      } else {
        console.log(`プレイヤー${actualPlayer}不正解`);
        showAnswerPopup(false, 0, currentQuestion.answer);
      }
    }

    function switchToNextPlayer() {
      if (gameEnded || isSwitchingTurn) return;
      isSwitchingTurn = true;

      timers.forEach(id => { clearTimeout(id); clearInterval(id); });
      timers.length = 0;
      closeAllPopups();
      aiBusy = false;
      pendingAnswerFor = null;

      console.log(`=== ターン交代開始: プレイヤー${currentPlayer} ===`);
      lockInputs();
      const previousPlayer = currentPlayer;
      currentPlayer = currentPlayer === 1 ? 2 : 1;
      turnId++;
      console.log(`プレイヤー${previousPlayer} → プレイヤー${currentPlayer}に交代 (turnId=${turnId})`);

      updateTurnDisplay();
      const t = setTimeout(() => {
        if (!gameEnded) startPlayerTurn();
        setTimeout(() => { isSwitchingTurn = false; }, 100);
      }, 300);
      timers.push(t);
    }

    function updateTurnDisplay() {
      document.getElementById('player1Info').classList.remove('active');
      document.getElementById('player2Info').classList.remove('active');
      document.getElementById(`player${currentPlayer}Info`).classList.add('active');

      document.getElementById('rollBtn').disabled = true;
      document.getElementById('useCardBtn1').disabled = true;
      document.getElementById('useCardBtn2').disabled = true;

      const rollBtn = document.getElementById('rollBtn');
      rollBtn.textContent = `プレイヤー${currentPlayer}の番`;
    }

    function startPlayerTurn() {
      const rollBtn = document.getElementById('rollBtn');
      const diceArea = document.getElementById('diceArea');
      diceArea.innerHTML = '<div class="dice" id="dice">?</div>';

      if (isAIGame && currentPlayer === 2) {
        if (aiBusy) return;
        rollBtn.textContent = 'コンピューターの番';
        rollBtn.style.cursor = 'not-allowed';
        rollBtn.title = 'コンピューターが考え中です';
        console.log('AIターン開始');
        const myTurn = turnId;
        const t = setTimeout(() => {
          if (!gameEnded && currentPlayer === 2 && myTurn === turnId) aiTurn();
        }, 1500);
        timers.push(t);
      } else {
        rollBtn.textContent = 'サイコロ';
        rollBtn.style.cursor = 'pointer';
        rollBtn.title = 'クリックしてサイコロを振る';
        console.log(`プレイヤー${currentPlayer}のターン開始`);
        unlockInputsForCurrentPlayer();
      }
    }

    function endCurrentPlayerTurn() { switchToNextPlayer(); }

    function showAnswerPopup(isCorrect, steps, info = '') {
      const popup = document.getElementById('answerPopup');
      const content = document.getElementById('answerPopupContent');
      const title = document.getElementById('answerResultTitle');
      const message = document.getElementById('answerResultMessage');

      lastAnswerCorrect = !!isCorrect;
      if (isCorrect) {
        content.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
        title.textContent = '🎉 正解！ 🎉';
        message.textContent = `${steps}マス進みます！`;
      } else {
        content.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
        title.textContent = '❌ 不正解... ❌';
        if (info && info !== (currentQuestion?.answer ?? '')) {
          message.textContent = info;
        } else if (info) {
          message.textContent = `正解は「${info}」でした`;
        } else {
          message.textContent = '残念！';
        }
      }
      popup.style.display = 'flex';
    }

    function closeAnswerPopup() {
      document.getElementById('answerPopup').style.display = 'none';
      const isCorrect = !!lastAnswerCorrect;
      lastAnswerCorrect = null;
      if (isCorrect) {
        const actualPlayer = pendingAnswerFor || currentPlayer;
        movePlayer(diceValue, actualPlayer);
        if (gameEnded) return;
        const t = setTimeout(() => {
          if (gameEnded) return;
          if (Math.random() < 0.7) {
            const cardCount = Math.random() < 0.2 ? 2 : 1;
            giveCards(actualPlayer, cardCount);
          } else {
            console.log('正解→カード獲得なし→ターン終了');
            switchToNextPlayer();
          }
        }, 1000);
        timers.push(t);
      } else {
        console.log('不正解→ターン終了');
        switchToNextPlayer();
      }
    }

    function movePlayer(steps, playerNum = null) {
      if (gameEnded) return;
      const targetPlayer = playerNum || currentPlayer;
      const oldPosition = players[targetPlayer].position;
      const newPosition = Math.min(oldPosition + steps, 29);
      console.log(`プレイヤー${targetPlayer}: ${oldPosition} → ${newPosition} (${steps}マス進む)`);

      animateMovement(oldPosition, newPosition, targetPlayer, () => {
        players[targetPlayer].position = newPosition;
        updatePlayerPositions();
        if (newPosition >= 29) {
          if (!gameEnded) endGame(targetPlayer);
          return;
        }
      });
    }

    function animateMovement(from, to, playerNum, callback) {
      if (from === to) { callback(); return; }
      let current = from;
      let lastTime = 0;
      const stepDelay = 300;
      const step = (currentTime) => {
        if (gameEnded) return;
        if (currentTime - lastTime >= stepDelay) {
          if (current < to) {
            current++;
            players[playerNum].position = current;
            updatePlayerPositions();
            lastTime = currentTime;
          } else {
            callback(); return;
          }
        }
        requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    }

    function giveCards(playerNum = null, count = 1) {
      const targetPlayer = playerNum || currentPlayer;
      const obtainedCards = [];
      for (let i = 0; i < count; i++) {
        const randomCard = getRandomCard();
        players[targetPlayer].cards.push(randomCard);
        obtainedCards.push(randomCard);
      }
      const t = setTimeout(() => {
        if (count === 1) {
          showCardPopup(obtainedCards[0]);
        } else {
          showMultipleCardPopup(obtainedCards);
        }
        updatePlayerPositions();
        if (isAIGame && targetPlayer === 2) {
          const t2 = setTimeout(() => { closeCardPopup(); }, 2000);
          timers.push(t2);
        }
      }, 500);
      timers.push(t);
    }

    function showMultipleCardPopup(cards) {
      const cardNames = cards.map(card => card.name).join('、');
      document.getElementById('popupCardName').textContent = `${cards.length}枚獲得！`;
      document.getElementById('popupCardDesc').textContent = cardNames;
      document.getElementById('cardPopup').style.display = 'flex';
    }
    function showCardPopup(card) {
      document.getElementById('popupCardName').textContent = card.name;
      document.getElementById('popupCardDesc').textContent = card.description;
      document.getElementById('cardPopup').style.display = 'flex';
    }
    function closeCardPopup() {
      if (isClosingCardPopup) return;
      isClosingCardPopup = true;
      document.getElementById('cardPopup').style.display = 'none';
      if (!gameEnded) {
        console.log('カード獲得→ターン終了');
        switchToNextPlayer();
      }
      setTimeout(() => { isClosingCardPopup = false; }, 100);
    }

    function showShieldPopup() { document.getElementById('shieldPopup').style.display = 'flex'; }
    function closeShieldPopup() { document.getElementById('shieldPopup').style.display = 'none'; }

    function showCardUsePopup(card) {
      document.getElementById('usedCardName').textContent = card.name;
      document.getElementById('usedCardDesc').textContent = card.description;
      document.getElementById('cardUsePopup').style.display = 'flex';
    }
    function closeCardUsePopup() {
      document.getElementById('cardUsePopup').style.display = 'none';
      if (window.pendingCardEffect) {
        const { card, playerNum, cardIndex, opponent } = window.pendingCardEffect;
        executeCardEffect(card, playerNum, cardIndex, opponent);
        window.pendingCardEffect = null;
      }
    }

    // AI
    function aiTurn() {
      if (gameEnded || currentPlayer !== 2) return;
      if (aiBusy) return;
      aiBusy = true;
      const myTurn = turnId;
      console.log('AIのターン開始');

      if (players[2].skipTurn) {
        players[2].skipTurn = false;
        showAnswerPopup(false, 0, 'コンピューターは1回休みです');
        const t = setTimeout(() => { closeAnswerPopup(); switchToNextPlayer(); }, 2000);
        timers.push(t);
        return;
      }

      const usableIdx = players[2].cards
        .map((c, i) => ({ c, i }))
        .filter(x => x.c.type !== 'shield')
        .map(x => x.i);

      if (usableIdx.length > 0 && Math.random() < 0.9) {
        const cardIndex = usableIdx[Math.floor(Math.random() * usableIdx.length)];
        console.log('AIがカードを使用');
        useCard(2, cardIndex);
        return;
      }
      console.log('AIがサイコロを振る');
      aiRollDice();
    }

    function aiRollDice() {
      const diceArea = document.getElementById('diceArea');
      diceArea.innerHTML = '<div class="dice" id="dice">?</div>';
      const dice = document.getElementById('dice');
      const myTurn = turnId;
      dice.classList.add('rolling');
      let rollCount = 0;
      const rollInterval = setInterval(() => {
        dice.textContent = Math.floor(Math.random() * 6) + 1;
        rollCount++;
        if (rollCount > 10) {
          clearInterval(rollInterval);
          if (lucky6Active) { diceValue = 6; lucky6Active = false; }
          else { diceValue = Math.floor(Math.random() * 6) + 1; }
          dice.textContent = diceValue;
          dice.classList.remove('rolling');
          const t = setTimeout(() => {
            if (gameEnded || currentPlayer !== 2 || myTurn !== turnId) return;
            aiAnswerQuestion();
          }, 500);
          timers.push(t);
        }
      }, 100);
      timers.push(rollInterval);
    }

    function aiAnswerQuestion() {
      if (gameEnded || currentPlayer !== 2) return;
      const myTurn = turnId;
      console.log(`AI問題回答処理開始 - サイコロの目: ${diceValue}`);
      pendingAnswerFor = 2;

      const questions = questionsByGrade[selectedGrade];
      currentQuestion = questions[Math.floor(Math.random() * questions.length)];

      const isCorrect = Math.random() < 0.95;
      if (isCorrect) {
        console.log(`AI正解 - ${diceValue}マス進む予定`);
        showAnswerPopup(true, diceValue);
        const t1 = setTimeout(() => {
          if (gameEnded || currentPlayer !== 2 || myTurn !== turnId) return;
          closeAnswerPopup();
        }, 1500);
        timers.push(t1);
      } else {
        console.log('AI不正解 - 進まない');
        showAnswerPopup(false, 0, '問題に間違えました');
        const t = setTimeout(() => {
          if (gameEnded || currentPlayer !== 2 || myTurn !== turnId) return;
          closeAnswerPopup();
        }, 2000);
        timers.push(t);
      }
    }

    // カードメニュー
    function showCardMenu(playerNum) {
      if (playerNum !== currentPlayer || turnLocked) return;
      const modal = document.getElementById('cardModal');
      const cardList = document.getElementById('cardList');
      cardList.innerHTML = '';

      players[playerNum].cards.forEach((card, index) => {
        if (card.type === 'shield') {
          const cardItem = document.createElement('div');
          cardItem.className = 'card-item';
          cardItem.style.opacity = '0.5';
          cardItem.style.cursor = 'not-allowed';
          cardItem.innerHTML = `<div style="font-size: 1.2rem; margin-bottom: 5px;">${card.name}</div><div class="card-description">自動発動（使用不可）</div>`;
          cardList.appendChild(cardItem);
        } else {
          const cardItem = document.createElement('div');
          cardItem.className = 'card-item';
          cardItem.innerHTML = `<div style="font-size: 1.2rem; margin-bottom: 5px;">${card.name}</div><div class="card-description">${card.description}</div>`;
          cardItem.onclick = () => useCard(playerNum, index);
          cardList.appendChild(cardItem);
        }
      });
      modal.style.display = 'flex';
    }
    function closeCardMenu() { document.getElementById('cardModal').style.display = 'none'; }

    function useCard(playerNum, cardIndex) {
      if (turnLocked && !(isAIGame && playerNum === 2)) return;
      lockInputs();
      const card = players[playerNum].cards[cardIndex];
      const opponent = playerNum === 1 ? 2 : 1;
      closeCardMenu();

      showCardUsePopup(card);

      if (isAIGame && playerNum === 2) {
        const t = setTimeout(() => {
          closeCardUsePopup();
          executeCardEffect(card, playerNum, cardIndex, opponent);
        }, 1500);
        timers.push(t);
      } else {
        window.pendingCardEffect = { card, playerNum, cardIndex, opponent };
      }
    }

    function executeCardEffect(card, playerNum, cardIndex, opponent) {
      switch(card.type) {
        case 'shield':
          console.log('🛡️ シールドは自動発動のため手動使用不可');
          if (isAIGame && playerNum === 2) {
            setTimeout(() => { if (!gameEnded && currentPlayer === 2) aiRollDice(); }, 400);
          } else { unlockInputsForCurrentPlayer(); }
          return;

        case 'dice2':
          pendingAnswerFor = playerNum;
          rollMultipleDice(2);
          players[playerNum].cards.splice(cardIndex, 1);
          updatePlayerPositions();
          return;

        case 'dice3':
          pendingAnswerFor = playerNum;
          rollMultipleDice(3);
          players[playerNum].cards.splice(cardIndex, 1);
          updatePlayerPositions();
          return;

        case 'lucky6':
          lucky6Active = true;
          console.log('ラッキー6効果を有効化');
          alert('🍀 ラッキー6効果が有効になりました！次のサイコロで必ず6が出ます！');
          break;

        case 'attack':
          if (hasShield(opponent)) { useShield(opponent); showShieldPopup(); }
          else {
            players[opponent].position = Math.max(0, players[opponent].position - 3);
            alert('💥 相手を3マス戻しました！');
            updatePlayerPositions();
          }
          break;

        case 'jump':
          alert('🚀 ジャンプ: 3マス進みます！');
          movePlayer(3, playerNum);
          break;

        case 'bomb':
          if (hasShield(opponent)) { useShield(opponent); showShieldPopup(); }
          else {
            players[1].position = 0; players[2].position = 0;
            alert('💣 爆発！両プレイヤーがスタートに戻りました！');
            updatePlayerPositions();
          }
          break;

        case 'stop':
          if (hasShield(opponent)) { useShield(opponent); showShieldPopup(); }
          else { players[opponent].skipTurn = true; alert('🚧 相手を1回休みにしました！'); }
          break;

        case 'random':
          const randomPos = Math.floor(Math.random() * 28) + 1; // 1..28
          players[playerNum].position = randomPos;
          alert(`🪂 ランダムテレポート: ${randomPos}番目のマスに移動しました！`);
          updatePlayerPositions();
          break;

        case 'steal':
          if (hasShield(opponent)) { useShield(opponent); showShieldPopup(); }
          else if (players[opponent].cards.length > 0) {
            const stolenIndex = Math.floor(Math.random() * players[opponent].cards.length);
            const stolenCard = players[opponent].cards.splice(stolenIndex, 1)[0];
            players[playerNum].cards.push(stolenCard);
            alert(`🥷 相手から「${stolenCard.name}」を奪いました！`);
            updatePlayerPositions();
          } else { alert('🥷 相手はカードを持っていません...'); }
          break;
      }

      // カードを消費（dice2/3は上で済み）
      if (!['dice2','dice3'].includes(card.type)) {
        players[playerNum].cards.splice(cardIndex, 1);
        updatePlayerPositions();
      }

      if (players[playerNum].position >= 29) { endGame(playerNum); return; }

      console.log(`プレイヤー${playerNum}がカード「${card.name}」を使用完了`);
      if (['dice2','dice3'].includes(card.type)) {
        console.log(`${card.name}カード使用、問題回答後にターン終了予定`);
        return;
      }

      if (!gameEnded) {
        if (isAIGame && playerNum === 2) {
          console.log(`AIが「${card.name}」使用 → 自動でサイコロへ`);
          const t = setTimeout(() => { if (!gameEnded && currentPlayer === 2) aiRollDice(); }, 800);
          timers.push(t);
        } else {
          console.log(`カード「${card.name}」使用、ターン継続（人間）`);
          const t = setTimeout(() => { if (!gameEnded) unlockInputsForCurrentPlayer(); }, 300);
          timers.push(t);
        }
      }
    }

    function hasShield(playerNum) {
      return players[playerNum].cards.some(card => card.type === 'shield');
    }
    function useShield(playerNum) {
      const shieldIndex = players[playerNum].cards.findIndex(card => card.type === 'shield');
      if (shieldIndex !== -1) {
        players[playerNum].cards.splice(shieldIndex, 1);
        updatePlayerPositions();
      }
    }

    // キー操作
    document.addEventListener('DOMContentLoaded', function() {
      loadSettings();
      togglePlayer2Input();
    });
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        if (document.getElementById('questionModal').style.display === 'flex') { submitAnswer(); return; }
        if (document.getElementById('cardPopup').style.display === 'flex') { closeCardPopup(); return; }
        if (document.getElementById('cardUsePopup').style.display === 'flex') { closeCardUsePopup(); return; }
        if (document.getElementById('shieldPopup').style.display === 'flex') { closeShieldPopup(); return; }
        if (document.getElementById('answerPopup').style.display === 'flex') { closeAnswerPopup(); return; }
        if (document.getElementById('winnerModal').style.display === 'flex') { resetGame(); return; }

        const rollBtn = document.getElementById('rollBtn');
        if (rollBtn && !rollBtn.disabled && rollBtn.style.display !== 'none') { rollDice(); return; }
      }
    });

    // 終了モーダル
    function showQuitConfirm() { document.getElementById('quitModal').style.display = 'flex'; }
    function closeQuitConfirm() { document.getElementById('quitModal').style.display = 'none'; }

    function quitGame() {
      currentPlayer = 1;
      players = {
        1: { position: 0, cards: [], shields: 0, skipTurn: false, name: "" },
        2: { position: 0, cards: [], shields: 0, skipTurn: false, name: "" }
      };
      gameEnded = false;
      diceValue = 0;
      isAIGame = false;
      playerCount = 2;
      turnLocked = false;
      pendingAnswerFor = null;
      lucky6Active = false;
      isClosingCardPopup = false;
      isSwitchingTurn = false;
      turnId = 0;

      document.getElementById('quitModal').style.display = 'none';
      document.getElementById('questionModal').style.display = 'none';
      document.getElementById('cardModal').style.display = 'none';
      document.getElementById('cardPopup').style.display = 'none';
      document.getElementById('cardUsePopup').style.display = 'none';
      document.getElementById('shieldPopup').style.display = 'none';
      document.getElementById('answerPopup').style.display = 'none';
      document.getElementById('winnerModal').style.display = 'none';

      document.getElementById('gameContainer').style.display = 'none';
      document.getElementById('instructionsScreen').style.display = 'none';
      document.getElementById('setupScreen').style.display = 'flex';

      document.getElementById('player1Name').value = 'プレイヤー1';
      document.getElementById('player2Name').value = 'プレイヤー2';
      document.getElementById('playerCountSelect').value = '2';
      document.getElementById('gradeSelect').value = '4';
      togglePlayer2Input();
    }

    function closeAllPopups() {
      ['questionModal','cardModal','cardPopup','shieldPopup','answerPopup','winnerModal','quitModal','cardUsePopup','firstPlayerModal']
        .forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; });
    }

    // 設定保存/読み込み
    function saveSettings(){
      try {
        localStorage.setItem('kanjiSugorokuSettings', JSON.stringify({
          p1: players[1].name, p2: players[2].name, grade: selectedGrade, isAIGame: isAIGame
        }));
      } catch(e) { console.warn('設定保存に失敗:', e); }
    }
    function loadSettings(){
      try{
        const s = JSON.parse(localStorage.getItem('kanjiSugorokuSettings'));
        if(!s) return;
        document.getElementById('player1Name').value = s.p1 || 'プレイヤー1';
        document.getElementById('player2Name').value = s.p2 || 'プレイヤー2';
        document.getElementById('gradeSelect').value = String(s.grade || 4);
        document.getElementById('playerCountSelect').value = s.isAIGame ? '1' : '2';
        togglePlayer2Input();
      }catch(e){ console.warn('設定読み込みに失敗:', e); }
    }

    // モーダルユーティリティ
    function openModal(id, focusSelector) {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = 'flex';
      if (focusSelector) {
        requestAnimationFrame(() => {
          const f = document.querySelector(focusSelector);
          if (f && typeof f.focus === 'function') f.focus();
        });
      }
    }
    function closeModal(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = 'none';
    }

    // 最初に盤面だけ用意（背面）
    initializeBoard();
  </script>

  <!-- （そのまま残し）Cloudflare のスニペット -->
  <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'970a8fe3f3c219c9',t:'MTc1NTQ0ODI5MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>
